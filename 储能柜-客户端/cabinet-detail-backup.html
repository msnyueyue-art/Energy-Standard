<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>储能柜详情 - 储能柜管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .detail-container {
            display: flex;
            height: calc(100vh - 60px);
            background: #f5f5f5;
        }
        
        .cabinet-3d-container {
            flex: 1;
            position: relative;
            background: #e5e5e5;
        }
        
        .component-annotations {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .annotation {
            position: absolute;
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: auto;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .annotation:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }
        
        .annotation-line {
            position: absolute;
            background: #ffffff;
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }
        
        .data-panel {
            width: 600px;
            background: white;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0,0,0,0.08);
        }
        
        [data-theme="dark"] .data-panel {
            background: #1e293b;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .back-button:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        
        
        .cabinet-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .cabinet-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #10b981;
        }
        
        .status-dot.offline {
            background: #f59e0b;
        }
        
        .status-dot.fault {
            background: #ef4444;
        }
        
        .data-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        
        .component-tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: thin;
        }
        
        .component-tab {
            padding: 12px 20px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
        }
        
        .component-tab:hover {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.05);
        }
        
        .component-tab.active {
            color: #2196F3;
            background: white;
            border-bottom-color: #2196F3;
        }
        
        [data-theme="dark"] .component-tabs {
            background: #0f172a;
        }
        
        [data-theme="dark"] .component-tab.active {
            background: #1e293b;
        }
        
        .data-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .data-tab:hover {
            color: var(--text-primary);
        }
        
        .data-tab.active {
            color: var(--primary-color);
        }
        
        .data-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
        }
        
        .data-content {
            padding: 24px;
        }
        
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
        }
        
        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .metric-unit {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 4px;
        }
        
        .metric-status {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .metric-status.good {
            color: #10b981;
        }
        
        .metric-status.warning {
            color: #f59e0b;
        }
        
        .metric-status.critical {
            color: #ef4444;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        
        .chart-wrapper {
            height: 200px;
        }
        
        .alert-section {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .alert-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-item {
            font-size: 13px;
            color: #78350f;
            margin-bottom: 4px;
        }
        
        .time-range-btn {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-range-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .time-range-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="header-left">
            <button class="menu-trigger" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <img src="logo.png" alt="AlwaysControl Technology" />
            </div>
        </div>
        
        <div class="header-right">
            <button class="theme-btn" onclick="toggleTheme()" title="切换主题">
                <i class="fas fa-moon" id="headerThemeIcon"></i>
            </button>
            <button class="lang-btn" onclick="toggleLanguage()" title="切换语言">
                <i class="fas fa-globe"></i>
            </button>
            <div class="notification-badge">
                <i class="fas fa-bell" style="font-size: 20px; color: var(--text-secondary);"></i>
            </div>
            <div class="user-menu" onclick="logout()">
                <div class="avatar">A</div>
                <span class="user-name" id="userName">管理员</span>
            </div>
        </div>
    </header>

    <!-- 侧边栏 -->
    <nav class="sidebar" id="sidebar">
        <div class="menu">
            <a href="dashboard.html" class="menu-item" data-menu="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span id="menuDashboard">仪表盘</span>
            </a>
            <a href="site1.html" class="menu-item" data-menu="site1">
                <i class="fas fa-building"></i>
                <span>站点管理</span>
            </a>
            <a href="devices.html" class="menu-item" data-menu="devices">
                <i class="fas fa-database"></i>
                <span id="menuDevices">设备管理</span>
            </a>
            <a href="monitoring.html" class="menu-item" data-menu="monitoring">
                <i class="fas fa-chart-line"></i>
                <span id="menuMonitoring">数据监控</span>
            </a>
            <a href="cabinet-detail.html" class="menu-item active" data-menu="cabinet-detail">
                <i class="fas fa-server"></i>
                <span id="menuCabinetDetail">电站详情</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-cogs"></i>
                <span id="menuControl">设备控制</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="menuAlarms">告警管理</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-chart-bar"></i>
                <span id="menuReports">报告中心</span>
            </a>
            <a href="#" class="menu-item">
                <i class="fas fa-users"></i>
                <span id="menuSystem">系统管理</span>
            </a>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <main class="main-content" id="mainContent" style="padding: 0;">
        <div class="detail-container">
            <!-- 3D模型容器 -->
            <div class="cabinet-3d-container">
                <div style="position: absolute; top: 20px; left: 20px; z-index: 100; display: flex; align-items: center; gap: 16px;">
                    <button class="back-button" onclick="goBack()" style="position: static; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <i class="fas fa-arrow-left"></i>
                        返回电站
                    </button>
                    <div style="display: flex; align-items: center; gap: 16px; background: rgba(255, 255, 255, 0.95); padding: 10px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h2 id="cabinetNameTop" style="margin: 0; font-size: 18px; font-weight: 600; color: #333;">储能柜 001</h2>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span class="status-dot online" id="statusDotTop"></span>
                            <span id="statusTextTop" style="font-size: 14px; color: #666;">在线</span>
                        </div>
                        <div id="operationStatusTop" style="display: flex; align-items: center; gap: 6px; font-size: 14px; color: #666; font-weight: 500;">
                            <i class="fas fa-bolt" style="color: #10b981;"></i>
                            充电中
                        </div>
                    </div>
                </div>
                
                <div id="canvas-container" style="width: 100%; height: 100%;"></div>
                
                <!-- 当前告警 -->
                <div style="position: absolute; bottom: 20px; left: 20px; right: 20px; z-index: 100;">
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="font-size: 14px; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; margin: 0 0 12px 0;">
                            <i class="fas fa-exclamation-triangle"></i>
                            当前告警
                        </h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f;">
                            <li style="margin-bottom: 6px;">电池模组3温度偏高 (32.5°C)</li>
                            <li>BMS通信延迟 (150ms)</li>
                        </ul>
                    </div>
                </div>
                
                <!-- 组件标注层 -->
                <div class="component-annotations" id="annotations">
                    <!-- 标注将通过JavaScript动态添加 -->
                </div>
            </div>
            
            <!-- 数据面板 -->
            <div class="data-panel">
                
                <!-- 组件选择标签页 -->
                <div class="component-tabs" style="border-top: 1px solid var(--border-color); display: flex; background: #f8f9fa;">
                    <button class="component-tab active" onclick="switchComponent('overall')">整机</button>
                    <button class="component-tab" onclick="switchComponent('ems')">EMS</button>
                    <button class="component-tab" onclick="switchComponent('pcs')">逆变器</button>
                    <button class="component-tab" onclick="switchComponent('bms')">BMS</button>
                    <button class="component-tab" onclick="switchComponent('battery')">电池</button>
                    <button class="component-tab" onclick="switchComponent('thermal')">温度</button>
                    <button class="component-tab" onclick="switchComponent('fire')">消防</button>
                </div>
                
                <!-- 数据标签页 -->
                <div class="data-tabs">
                    <button class="data-tab active" onclick="switchTab('realtime')">实时数据</button>
                    <button class="data-tab" onclick="switchTab('history')">历史数据</button>
                </div>
                
                <!-- 数据内容 -->
                <div class="data-content" id="dataContent">
                    <!-- 实时数据 -->
                    <div id="realtimeData">
                        <!-- 核心运行参数 -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">核心运行参数</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">SOC</div>
                                    <div class="metric-value">
                                        <span id="soc">85.6</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="metric-status good" id="socStatus">电量充足</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">SOH</div>
                                    <div class="metric-value">
                                        <span id="soh">96.8</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="metric-status good" id="sohStatus">健康状态良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">温度</div>
                                    <div class="metric-value">
                                        <span id="temperature">28.5</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div class="metric-status good" id="tempStatus">温度正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">充放电功率</div>
                                    <div class="metric-value">
                                        <span id="power" style="color: #10b981;">+118.2</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div class="metric-status" id="powerStatus">充电中</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池电流</div>
                                    <div class="metric-value">
                                        <span id="batteryCurrent">0</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div class="metric-status" id="currentStatus">正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池电压</div>
                                    <div class="metric-value">
                                        <span id="batteryVoltage">58</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div class="metric-status" id="voltageStatus">正常</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 运行统计 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">运行统计</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">今日充电量</div>
                                    <div class="metric-value">
                                        <span id="todayCharge">856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">今日放电量</div>
                                    <div class="metric-value">
                                        <span id="todayDischarge">742.6</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">充电成本</div>
                                    <div class="metric-value">
                                        <span id="chargingCost">¥685.2</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">放电收益</div>
                                    <div class="metric-value">
                                        <span id="dischargingRevenue">¥1,126.8</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 历史数据 -->
                    <div id="historyData" style="display: none;">
                        <!-- 时间范围选择 -->
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            <button class="time-range-btn active" onclick="changeTimeRange('24h')">24小时</button>
                            <button class="time-range-btn" onclick="changeTimeRange('7d')">7天</button>
                            <button class="time-range-btn" onclick="changeTimeRange('30d')">30天</button>
                            <button class="time-range-btn" onclick="changeTimeRange('1y')">1年</button>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">功率曲线</div>
                            <div class="chart-wrapper">
                                <canvas id="powerHistoryChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">SOC与充放电状态</div>
                            <div class="chart-wrapper">
                                <canvas id="socHistoryChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">电池温度分布</div>
                            <div class="chart-wrapper">
                                <canvas id="tempHistoryChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">电压一致性</div>
                            <div class="chart-wrapper">
                                <canvas id="voltageConsistencyChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">充放电效率分析</div>
                            <div class="chart-wrapper">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">峰谷套利分析</div>
                            <div class="chart-wrapper">
                                <canvas id="arbitrageChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">健康度趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="sohTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 累计统计 -->
                        <div class="statistics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">累计统计</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">累计充电量</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">186,524 <span style="font-size: 12px; font-weight: 400;">kWh</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">累计放电量</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">178,956 <span style="font-size: 12px; font-weight: 400;">kWh</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">等效循环次数</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">1,892 <span style="font-size: 12px; font-weight: 400;">次</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">平均效率</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">95.8 <span style="font-size: 12px; font-weight: 400;">%</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">累计收益</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px; color: #10b981;">¥124,658</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">平均日收益</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">¥266 <span style="font-size: 12px; font-weight: 400;">/天</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 运维建议 -->
                        <div class="maintenance-section" style="margin-top: 20px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px;">
                            <h4 style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-lightbulb"></i>
                                运维建议
                            </h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f;">
                                <li style="margin-bottom: 6px;">建议在电价低谷期（23:00-07:00）增加充电功率</li>
                                <li style="margin-bottom: 6px;">当前温度控制良好，继续保持现有热管理策略</li>
                                <li style="margin-bottom: 6px;">电池健康度保持在95%以上，建议每月进行一次深度充放电循环</li>
                                <li>下次维护时间：2024年2月15日</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 移动端遮罩 -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <script src="common.js"></script>
    <script>
        // 检查登录状态
        checkAuth();
        
        // 设置当前页面菜单项
        setActiveMenuItem('station1');
        
        // Three.js 相关变量
        let scene, camera, renderer, controls;
        let cabinet;
        let components = {};
        let selectedComponent = null;
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        
        // 返回上一页
        function goBack() {
            window.location.href = 'devices.html';
        }
        
        // 初始化3D场景
        function init3DScene() {
            const container = document.getElementById('canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // 创建场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xe5e5e5);

            // 创建相机
            camera = new THREE.PerspectiveCamera(55, width / height, 0.1, 1000);
            camera.position.set(50, 35, 50);

            // 创建渲染器 - 增强真实感设置
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: false,
                powerPreference: "high-performance"
            });
            renderer.setSize(width, height);
            renderer.setClearColor(0xf8f8f8);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.physicallyCorrectLights = true;
            container.appendChild(renderer.domElement);

            // 创建控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.target.set(0, 12, 0);
            controls.update();

            // 设置更真实的光照系统
            // 环境光 - 模拟室内散射光
            const ambientLight = new THREE.AmbientLight(0xf8f8f8, 0.45);
            scene.add(ambientLight);

            // 主光源 - 模拟工业照明
            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.65);
            directionalLight1.position.set(25, 40, 20);
            directionalLight1.castShadow = true;
            directionalLight1.shadow.mapSize.width = 4096;
            directionalLight1.shadow.mapSize.height = 4096;
            directionalLight1.shadow.camera.near = 0.1;
            directionalLight1.shadow.camera.far = 100;
            directionalLight1.shadow.camera.left = -40;
            directionalLight1.shadow.camera.right = 40;
            directionalLight1.shadow.camera.top = 40;
            directionalLight1.shadow.camera.bottom = -40;
            directionalLight1.shadow.bias = -0.0005;
            scene.add(directionalLight1);

            // 补光 - 填充阴影
            const directionalLight2 = new THREE.DirectionalLight(0xe8f0ff, 0.35);
            directionalLight2.position.set(-20, 25, -15);
            scene.add(directionalLight2);
            
            // 顶部点光源
            const pointLight = new THREE.PointLight(0xffffff, 0.3, 50);
            pointLight.position.set(0, 35, 0);
            scene.add(pointLight);


            // 创建储能柜模型
            createCabinetModel();

            // 窗口大小调整
            window.addEventListener('resize', onWindowResize);
            
            // 鼠标事件
            container.addEventListener('click', onMouseClick);
            container.addEventListener('mousemove', onMouseMove);

            // 开始渲染
            animate();
        }
        
        // 创建储能柜模型（打开状态）
        function createCabinetModel() {
            cabinet = new THREE.Group();
            
            // 柜体框架 - 更真实的工业设计
            const frameGroup = new THREE.Group();
            
            // 加强型底座 - 更真实的金属材质
            const baseGeometry = new THREE.BoxGeometry(22, 3, 14);
            const baseMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x4a5568,
                metalness: 0.85,
                roughness: 0.15,
                envMapIntensity: 1.0
            });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.y = 1.5;
            base.castShadow = true;
            base.receiveShadow = true;
            frameGroup.add(base);
            
            // 底座支撑脚
            for (let i = 0; i < 4; i++) {
                const footGeometry = new THREE.CylinderGeometry(0.8, 1, 1, 8);
                const footMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1a202c,
                    metalness: 0.5,
                    roughness: 0.5
                });
                const foot = new THREE.Mesh(footGeometry, footMaterial);
                foot.position.set(
                    i < 2 ? -9 : 9,
                    0.5,
                    i % 2 === 0 ? -5 : 5
                );
                frameGroup.add(foot);
            }
            
            // 加厚后板 - 喷塑金属板
            const backGeometry = new THREE.BoxGeometry(21, 30, 1);
            const backMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xf5f5f5,
                metalness: 0.2,
                roughness: 0.8,
                envMapIntensity: 0.3
            });
            const back = new THREE.Mesh(backGeometry, backMaterial);
            back.position.set(0, 17, -6.5);
            back.castShadow = true;
            frameGroup.add(back);
            
            // 后板散热孔
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 12; col++) {
                    const holeGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1.2, 6);
                    const holeMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x1a202c,
                        metalness: 0.8,
                        roughness: 0.2
                    });
                    const hole = new THREE.Mesh(holeGeometry, holeMaterial);
                    hole.rotation.x = Math.PI / 2;
                    hole.position.set(-9 + col * 1.5, 8 + row * 2.5, -6.5);
                    frameGroup.add(hole);
                }
            }
            
            // 加强型侧板（左）- 喷塑金属
            const sideGeometry = new THREE.BoxGeometry(1, 30, 13);
            const sideMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xf5f5f5,
                metalness: 0.2,
                roughness: 0.8,
                envMapIntensity: 0.3
            });
            const leftSide = new THREE.Mesh(sideGeometry, sideMaterial);
            leftSide.position.set(-10.5, 17, 0);
            leftSide.castShadow = true;
            frameGroup.add(leftSide);
            
            // 右侧板（带观察窗）
            const rightSide = leftSide.clone();
            rightSide.position.set(10.5, 17, 0);
            frameGroup.add(rightSide);
            
            // 侧面观察窗
            const windowGeometry = new THREE.BoxGeometry(0.2, 20, 8);
            const windowMaterial = new THREE.MeshPhysicalMaterial({
                color: 0x88ccff,
                metalness: 0.1,
                roughness: 0.1,
                transmission: 0.6,
                thickness: 0.5,
                transparent: true
            });
            const sideWindow = new THREE.Mesh(windowGeometry, windowMaterial);
            sideWindow.position.set(10.6, 17, 0);
            frameGroup.add(sideWindow);
            
            // 顶板带通风格栅
            const topGeometry = new THREE.BoxGeometry(21, 1, 13);
            const topMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xe2e8f0,
                metalness: 0.4,
                roughness: 0.6
            });
            const top = new THREE.Mesh(topGeometry, topMaterial);
            top.position.set(0, 31.5, 0);
            top.castShadow = true;
            frameGroup.add(top);
            
            // 顶部通风格栅
            for (let i = 0; i < 10; i++) {
                const grillGeometry = new THREE.BoxGeometry(18, 0.2, 0.5);
                const grillMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x4a5568,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const grill = new THREE.Mesh(grillGeometry, grillMaterial);
                grill.position.set(0, 32.1, -5 + i * 1.1);
                frameGroup.add(grill);
            }
            
            // 内部支撑架构
            for (let i = 0; i < 3; i++) {
                const beamGeometry = new THREE.BoxGeometry(0.5, 28, 0.5);
                const beamMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x718096,
                    metalness: 0.6,
                    roughness: 0.4
                });
                const beam = new THREE.Mesh(beamGeometry, beamMaterial);
                beam.position.set(-6 + i * 6, 16, -5.5);
                frameGroup.add(beam);
            }
            
            cabinet.add(frameGroup);
            
            
            // 创建内部组件
            createBatteryModules();
            createPCSModule();
            createBMSModule();
            createCoolingSystem();
            createFireSystem();
            createElectricalPanel();
            
            // 创建组件标签
            createComponentLabels();
            
            scene.add(cabinet);
        }
        
        // 创建电池模组
        function createBatteryModules() {
            const batteryGroup = new THREE.Group();
            components.battery = batteryGroup;
            
            // 铝合金框架材质
            const frameMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xd4d4d8,
                metalness: 0.8,
                roughness: 0.15,
                envMapIntensity: 0.8
            });
            
            // 创建主框架结构
            // 垂直支柱 - 使用L型角钢
            for (let i = 0; i < 4; i++) {
                const angleBar = new THREE.Group();
                
                // L型角钢的两个面
                const face1Geometry = new THREE.BoxGeometry(0.8, 20, 0.1);
                const face1 = new THREE.Mesh(face1Geometry, frameMaterial);
                angleBar.add(face1);
                
                const face2Geometry = new THREE.BoxGeometry(0.1, 20, 0.8);
                const face2 = new THREE.Mesh(face2Geometry, frameMaterial);
                face2.position.x = -0.35;
                face2.position.z = 0.35;
                angleBar.add(face2);
                
                angleBar.position.set(-8.5 + (i % 2) * 17, 12, -4.5 + Math.floor(i / 2) * 9);
                angleBar.castShadow = true;
                batteryGroup.add(angleBar);
            }
            
            // 横向支撑梁
            for (let level = 0; level < 5; level++) {
                // 前后横梁
                for (let fb = 0; fb < 2; fb++) {
                    const beamGeometry = new THREE.BoxGeometry(17, 0.8, 0.8);
                    const beam = new THREE.Mesh(beamGeometry, frameMaterial);
                    beam.position.set(0, 2 + level * 5, fb === 0 ? -4.5 : 4.5);
                    beam.castShadow = true;
                    batteryGroup.add(beam);
                }
                
                // 左右横梁
                for (let lr = 0; lr < 2; lr++) {
                    const sideBeamGeometry = new THREE.BoxGeometry(0.8, 0.8, 9);
                    const sideBeam = new THREE.Mesh(sideBeamGeometry, frameMaterial);
                    sideBeam.position.set(lr === 0 ? -8.5 : 8.5, 2 + level * 5, 0);
                    sideBeam.castShadow = true;
                    batteryGroup.add(sideBeam);
                }
            }
            
            // 层板材质 - 灰色金属
            const shelfMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xe5e5e5,
                metalness: 0.6,
                roughness: 0.3
            });
            
            // 创建7层电池模组（参考图片）
            for (let layer = 0; layer < 7; layer++) {
                // 层架板
                const shelfGeometry = new THREE.BoxGeometry(16.5, 0.5, 9.5);
                const shelf = new THREE.Mesh(shelfGeometry, shelfMaterial);
                shelf.position.set(0, 2.5 + layer * 3.5, 0);
                shelf.castShadow = true;
                shelf.receiveShadow = true;
                batteryGroup.add(shelf);
                
                // 只创建一个电池包（Pack）整体，像参考图片
                const packGroup = new THREE.Group();
                
                // 电池包主体 - 黑色，像参考图片
                const packGeometry = new THREE.BoxGeometry(15, 2.8, 8.5);
                const packMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1a1a1a,
                    metalness: 0.3,
                    roughness: 0.7
                });
                const pack = new THREE.Mesh(packGeometry, packMaterial);
                pack.castShadow = true;
                pack.receiveShadow = true;
                packGroup.add(pack);
                
                // 前面板 - 更深的黑色
                const frontPanelGeometry = new THREE.BoxGeometry(14.8, 2.6, 0.2);
                const frontPanelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x0a0a0a,
                    metalness: 0.4,
                    roughness: 0.6
                });
                const frontPanel = new THREE.Mesh(frontPanelGeometry, frontPanelMaterial);
                frontPanel.position.z = 4.35;
                packGroup.add(frontPanel);
                    
                // 标签 - 白色标签带Pack编号
                const labelGeometry = new THREE.BoxGeometry(3, 1.2, 0.05);
                const labelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xffffff,
                    metalness: 0.1,
                    roughness: 0.9
                });
                const label = new THREE.Mesh(labelGeometry, labelMaterial);
                label.position.set(-5, 0, 4.4);
                packGroup.add(label);
                
                // 标签文字背景（模拟文字）
                const textBgGeometry = new THREE.BoxGeometry(2.5, 0.8, 0.01);
                const textBgMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x000000
                });
                const textBg = new THREE.Mesh(textBgGeometry, textBgMaterial);
                textBg.position.set(0, 0, 0.03);
                label.add(textBg);
                
                // DC标志
                const dcLabelGeometry = new THREE.BoxGeometry(1.5, 0.8, 0.05);
                const dcLabelMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x9ca3af,
                    metalness: 0.3,
                    roughness: 0.7
                });
                const dcLabel = new THREE.Mesh(dcLabelGeometry, dcLabelMaterial);
                dcLabel.position.set(6, -0.8, 4.4);
                packGroup.add(dcLabel);
                
                // 位置
                packGroup.position.set(0, 4 + layer * 3.5, 0);
                packGroup.userData = { component: 'battery', pack: `Pack${String(layer + 1).padStart(2, '0')}` };
                batteryGroup.add(packGroup);
            }
            
            // 添加橙色连接线缆
            const cableMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xff6b35,
                metalness: 0.3,
                roughness: 0.6
            });
            
            // 垂直主线缆
            for (let side = 0; side < 2; side++) {
                const mainCableGeometry = new THREE.CylinderGeometry(0.15, 0.15, 25, 8);
                const mainCable = new THREE.Mesh(mainCableGeometry, cableMaterial);
                mainCable.position.set(side === 0 ? -7 : 7, 12.5, 3);
                mainCable.castShadow = true;
                batteryGroup.add(mainCable);
                
                // 每层的连接线
                for (let layer = 0; layer < 7; layer++) {
                    // 水平连接线
                    const connectorGeometry = new THREE.CylinderGeometry(0.1, 0.1, 2, 6);
                    const connector = new THREE.Mesh(connectorGeometry, cableMaterial);
                    connector.rotation.z = Math.PI / 2;
                    connector.position.set(side === 0 ? -6 : 6, 4 + layer * 3.5, 3);
                    batteryGroup.add(connector);
                }
            }
            
            // 底部红色汇流排
            const busbarMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xdc2626,
                metalness: 0.8,
                roughness: 0.2
            });
            
            const busbarGeometry = new THREE.BoxGeometry(16, 0.8, 1.5);
            const busbar = new THREE.Mesh(busbarGeometry, busbarMaterial);
            busbar.position.set(0, 1, 3);
            busbar.castShadow = true;
            batteryGroup.add(busbar);
            
            // 汇流排连接端子
            for (let i = 0; i < 4; i++) {
                const terminalGeometry = new THREE.CylinderGeometry(0.4, 0.4, 0.6, 8);
                const terminal = new THREE.Mesh(terminalGeometry, busbarMaterial);
                terminal.position.set(-6 + i * 4, 1.7, 3);
                batteryGroup.add(terminal);
            }
            
            cabinet.add(batteryGroup);
        }
        
        // 创建PCS变流器模块
        function createPCSModule() {
            const pcsGroup = new THREE.Group();
            components.pcs = pcsGroup;
            
            // PCS主体 - 工业级设计
            const pcsBodyGeometry = new THREE.BoxGeometry(7, 10, 8);
            const pcsBodyMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2563eb,
                metalness: 0.5,
                roughness: 0.4
            });
            const pcsBody = new THREE.Mesh(pcsBodyGeometry, pcsBodyMaterial);
            pcsBody.castShadow = true;
            pcsGroup.add(pcsBody);
            
            // 前面板
            const frontPanelGeometry = new THREE.BoxGeometry(6.8, 9.8, 0.2);
            const frontPanelMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1e40af,
                metalness: 0.6,
                roughness: 0.3
            });
            const frontPanel = new THREE.Mesh(frontPanelGeometry, frontPanelMaterial);
            frontPanel.position.z = 4.1;
            pcsGroup.add(frontPanel);
            
            // 显示屏
            const displayGeometry = new THREE.BoxGeometry(5, 3, 0.1);
            const displayMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x0f172a,
                emissive: 0x1e40af,
                emissiveIntensity: 0.2
            });
            const display = new THREE.Mesh(displayGeometry, displayMaterial);
            display.position.set(0, 2, 4.2);
            pcsGroup.add(display);
            
            // 控制按钮组
            const buttonGroup = new THREE.Group();
            buttonGroup.position.set(0, -1, 4.2);
            
            for (let row = 0; row < 2; row++) {
                for (let col = 0; col < 4; col++) {
                    const buttonGeometry = new THREE.BoxGeometry(0.8, 0.8, 0.2);
                    const buttonMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x475569,
                        metalness: 0.3,
                        roughness: 0.6
                    });
                    const button = new THREE.Mesh(buttonGeometry, buttonMaterial);
                    button.position.set(-2.1 + col * 1.4, -0.5 + row * 1.2, 0);
                    buttonGroup.add(button);
                }
            }
            pcsGroup.add(buttonGroup);
            
            // 散热系统 - 两侧散热片
            for (let side = 0; side < 2; side++) {
                const heatsinkGroup = new THREE.Group();
                
                // 散热片基座
                const baseGeometry = new THREE.BoxGeometry(0.5, 9, 7);
                const baseMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x64748b,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const base = new THREE.Mesh(baseGeometry, baseMaterial);
                heatsinkGroup.add(base);
                
                // 散热鳍片
                for (let i = 0; i < 15; i++) {
                    const finGeometry = new THREE.BoxGeometry(0.8, 8.5, 0.15);
                    const finMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x475569,
                        metalness: 0.8,
                        roughness: 0.2
                    });
                    const fin = new THREE.Mesh(finGeometry, finMaterial);
                    fin.position.set(0.65, 0, -3 + i * 0.45);
                    heatsinkGroup.add(fin);
                }
                
                heatsinkGroup.position.x = side === 0 ? -3.75 : 3.75;
                pcsGroup.add(heatsinkGroup);
            }
            
            // 通风口
            const ventGroup = new THREE.Group();
            for (let i = 0; i < 6; i++) {
                const ventGeometry = new THREE.BoxGeometry(0.3, 6, 0.3);
                const ventMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1e293b,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const vent = new THREE.Mesh(ventGeometry, ventMaterial);
                vent.position.set(-2.5 + i * 1, -2, 4.15);
                ventGroup.add(vent);
            }
            pcsGroup.add(ventGroup);
            
            // 电气端子排
            const terminalGroup = new THREE.Group();
            terminalGroup.position.set(0, -4.5, 0);
            
            const terminalBlockGeometry = new THREE.BoxGeometry(6, 1, 2);
            const terminalBlockMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x0f172a,
                metalness: 0.4,
                roughness: 0.6
            });
            const terminalBlock = new THREE.Mesh(terminalBlockGeometry, terminalBlockMaterial);
            terminalGroup.add(terminalBlock);
            
            // 接线端子
            for (let i = 0; i < 6; i++) {
                const termGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.8, 8);
                const termMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xfbbf24,
                    metalness: 0.9,
                    roughness: 0.1
                });
                const term = new THREE.Mesh(termGeometry, termMaterial);
                term.position.set(-2.5 + i * 1, 0.5, 0);
                terminalGroup.add(term);
            }
            pcsGroup.add(terminalGroup);
            
            pcsGroup.position.set(6, 24, -1);
            pcsGroup.userData = { component: 'pcs' };
            cabinet.add(pcsGroup);
        }
        
        // 创建BMS电池管理系统
        function createBMSModule() {
            const bmsGroup = new THREE.Group();
            components.bms = bmsGroup;
            
            // BMS机架式外壳
            const bmsBodyGeometry = new THREE.BoxGeometry(6, 4, 5);
            const bmsBodyMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xf59e0b,
                metalness: 0.4,
                roughness: 0.5
            });
            const bmsBody = new THREE.Mesh(bmsBodyGeometry, bmsBodyMaterial);
            bmsBody.castShadow = true;
            bmsGroup.add(bmsBody);
            
            // 前面板
            const frontPanelGeometry = new THREE.BoxGeometry(5.8, 3.8, 0.2);
            const frontPanelMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xd97706,
                metalness: 0.5,
                roughness: 0.4
            });
            const frontPanel = new THREE.Mesh(frontPanelGeometry, frontPanelMaterial);
            frontPanel.position.z = 2.6;
            bmsGroup.add(frontPanel);
            
            // LCD显示屏
            const lcdGeometry = new THREE.BoxGeometry(4, 2, 0.1);
            const lcdMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x065f46,
                emissive: 0x10b981,
                emissiveIntensity: 0.3
            });
            const lcd = new THREE.Mesh(lcdGeometry, lcdMaterial);
            lcd.position.set(0, 0.5, 2.7);
            bmsGroup.add(lcd);
            
            // 状态指示灯矩阵
            const ledMatrixGroup = new THREE.Group();
            ledMatrixGroup.position.set(0, -1.2, 2.7);
            
            // LED背板
            const ledBackGeometry = new THREE.BoxGeometry(4.5, 1, 0.1);
            const ledBackMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1f2937,
                metalness: 0.3,
                roughness: 0.7
            });
            const ledBack = new THREE.Mesh(ledBackGeometry, ledBackMaterial);
            ledMatrixGroup.add(ledBack);
            
            // 创建LED阵列 (2行8列)
            for (let row = 0; row < 2; row++) {
                for (let col = 0; col < 8; col++) {
                    const ledGeometry = new THREE.BoxGeometry(0.25, 0.25, 0.15);
                    const isActive = Math.random() > 0.3;
                    const ledMaterial = new THREE.MeshStandardMaterial({ 
                        color: isActive ? 0x10b981 : 0x374151,
                        emissive: isActive ? 0x10b981 : 0x000000,
                        emissiveIntensity: isActive ? 0.8 : 0
                    });
                    const led = new THREE.Mesh(ledGeometry, ledMaterial);
                    led.position.set(-1.75 + col * 0.5, -0.25 + row * 0.5, 0.1);
                    ledMatrixGroup.add(led);
                }
            }
            bmsGroup.add(ledMatrixGroup);
            
            // 通信端口
            const portGroup = new THREE.Group();
            portGroup.position.set(2.5, 0, 0);
            
            for (let i = 0; i < 3; i++) {
                const portGeometry = new THREE.BoxGeometry(0.6, 0.4, 0.8);
                const portMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1f2937,
                    metalness: 0.6,
                    roughness: 0.4
                });
                const port = new THREE.Mesh(portGeometry, portMaterial);
                port.position.y = -1 + i * 1;
                portGroup.add(port);
            }
            bmsGroup.add(portGroup);
            
            // 散热孔
            for (let i = 0; i < 10; i++) {
                const ventGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.3, 6);
                const ventMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1f2937,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const vent = new THREE.Mesh(ventGeometry, ventMaterial);
                vent.rotation.z = Math.PI / 2;
                vent.position.set(-3.1, -1.5 + i * 0.35, 0);
                bmsGroup.add(vent);
            }
            
            bmsGroup.position.set(-6, 27, 0);
            bmsGroup.userData = { component: 'bms' };
            cabinet.add(bmsGroup);
        }
        
        // 创建热管理系统
        function createCoolingSystem() {
            const coolingGroup = new THREE.Group();
            components.cooling = coolingGroup;
            
            // 空调机组
            const acUnitGeometry = new THREE.BoxGeometry(8, 3, 4);
            const acUnitMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x0891b2,
                metalness: 0.4,
                roughness: 0.5
            });
            const acUnit = new THREE.Mesh(acUnitGeometry, acUnitMaterial);
            acUnit.position.set(0, 0, -3);
            coolingGroup.add(acUnit);
            
            // 前面板格栅
            const grillGroup = new THREE.Group();
            grillGroup.position.set(0, 0, -0.9);
            
            for (let row = 0; row < 5; row++) {
                const grillGeometry = new THREE.BoxGeometry(7, 0.15, 0.3);
                const grillMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x064e3b,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const grill = new THREE.Mesh(grillGeometry, grillMaterial);
                grill.position.y = -1 + row * 0.5;
                grillGroup.add(grill);
            }
            coolingGroup.add(grillGroup);
            
            // 风扇组件
            for (let i = 0; i < 2; i++) {
                const fanUnit = new THREE.Group();
                
                // 风扇外框
                const fanHousingGeometry = new THREE.CylinderGeometry(1.8, 1.8, 0.8, 32);
                const fanHousingMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x1e293b,
                    metalness: 0.6,
                    roughness: 0.4
                });
                const fanHousing = new THREE.Mesh(fanHousingGeometry, fanHousingMaterial);
                fanHousing.rotation.x = Math.PI / 2;
                fanUnit.add(fanHousing);
                
                // 风扇护网
                const guardGeometry = new THREE.TorusGeometry(1.7, 0.1, 8, 16);
                const guardMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x475569,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const guard = new THREE.Mesh(guardGeometry, guardMaterial);
                guard.rotation.x = Math.PI / 2;
                guard.position.z = 0.5;
                fanUnit.add(guard);
                
                // 内圈
                const innerGuard = guard.clone();
                innerGuard.scale.set(0.6, 0.6, 1);
                fanUnit.add(innerGuard);
                
                // 风扇叶片组
                const bladeGroup = new THREE.Group();
                const bladeCount = 7;
                
                for (let j = 0; j < bladeCount; j++) {
                    const bladeShape = new THREE.Shape();
                    bladeShape.moveTo(0, 0);
                    bladeShape.lineTo(1.3, 0.3);
                    bladeShape.quadraticCurveTo(1.5, 0, 1.3, -0.3);
                    bladeShape.lineTo(0, 0);
                    
                    const bladeGeometry = new THREE.ExtrudeGeometry(bladeShape, {
                        depth: 0.15,
                        bevelEnabled: true,
                        bevelThickness: 0.02,
                        bevelSize: 0.02,
                        bevelSegments: 2
                    });
                    
                    const bladeMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x1f2937,
                        metalness: 0.7,
                        roughness: 0.3
                    });
                    const blade = new THREE.Mesh(bladeGeometry, bladeMaterial);
                    blade.rotation.z = (Math.PI * 2 / bladeCount) * j;
                    blade.position.z = 0.2;
                    bladeGroup.add(blade);
                }
                
                // 中心轴
                const hubGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.6, 16);
                const hubMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0x374151,
                    metalness: 0.8,
                    roughness: 0.2
                });
                const hub = new THREE.Mesh(hubGeometry, hubMaterial);
                hub.rotation.x = Math.PI / 2;
                hub.position.z = 0.3;
                bladeGroup.add(hub);
                
                bladeGroup.position.z = 0.1;
                fanUnit.add(bladeGroup);
                fanUnit.userData = { blades: bladeGroup };
                
                fanUnit.position.set(-2.5 + i * 5, 0, -0.5);
                coolingGroup.add(fanUnit);
            }
            
            // 温度传感器
            const sensorGroup = new THREE.Group();
            for (let i = 0; i < 3; i++) {
                const sensorGeometry = new THREE.CylinderGeometry(0.15, 0.15, 0.8, 8);
                const sensorMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xfbbf24,
                    metalness: 0.7,
                    roughness: 0.3
                });
                const sensor = new THREE.Mesh(sensorGeometry, sensorMaterial);
                sensor.position.set(-3 + i * 3, 1.8, 0);
                sensorGroup.add(sensor);
            }
            coolingGroup.add(sensorGroup);
            
            coolingGroup.position.set(0, 4, -2);
            coolingGroup.userData = { component: 'cooling' };
            cabinet.add(coolingGroup);
        }
        
        // 创建消防系统
        function createFireSystem() {
            const fireGroup = new THREE.Group();
            components.fire = fireGroup;
            
            // 灭火器罐
            const cylinderGeometry = new THREE.CylinderGeometry(1, 1, 4, 16);
            const cylinderMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xef4444,
                metalness: 0.3,
                roughness: 0.7
            });
            const cylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
            cylinder.position.set(0, 26, -4);
            cylinder.rotation.z = Math.PI / 2;
            cylinder.castShadow = true;
            cylinder.userData = { component: 'fire' };
            fireGroup.add(cylinder);
            
            // 喷嘴
            const nozzleGeometry = new THREE.ConeGeometry(0.3, 1, 8);
            const nozzleMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xfbbf24,
                metalness: 0.5,
                roughness: 0.5
            });
            
            for (let i = 0; i < 3; i++) {
                const nozzle = new THREE.Mesh(nozzleGeometry, nozzleMaterial);
                nozzle.position.set(-3 + i * 3, 28, 0);
                nozzle.rotation.x = Math.PI;
                fireGroup.add(nozzle);
            }
            
            cabinet.add(fireGroup);
        }
        
        // 创建配电柜
        function createElectricalPanel() {
            const electricalGroup = new THREE.Group();
            components.electrical = electricalGroup;
            
            const panelGeometry = new THREE.BoxGeometry(4, 6, 2);
            const panelMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x8b5cf6,
                metalness: 0.3,
                roughness: 0.7
            });
            const panel = new THREE.Mesh(panelGeometry, panelMaterial);
            panel.position.set(0, 22, -4);
            panel.castShadow = true;
            panel.userData = { component: 'electrical' };
            electricalGroup.add(panel);
            
            // 开关
            for (let row = 0; row < 3; row++) {
                for (let col = 0; col < 2; col++) {
                    const switchGeometry = new THREE.BoxGeometry(0.8, 1.2, 0.3);
                    const switchMaterial = new THREE.MeshStandardMaterial({ 
                        color: 0x4c1d95,
                        metalness: 0.4,
                        roughness: 0.6
                    });
                    const switchMesh = new THREE.Mesh(switchGeometry, switchMaterial);
                    switchMesh.position.set(
                        -1 + col * 2,
                        2 - row * 1.5,
                        1.2
                    );
                    panel.add(switchMesh);
                }
            }
            
            cabinet.add(electricalGroup);
        }
        
        // 创建组件标签
        function createComponentLabels() {
            const annotations = document.getElementById('annotations');
            
            // 组件位置信息 - 根据实际储能柜组件更新
            const componentPositions = [
                { name: 'EMS', component: 'ems', worldPos: new THREE.Vector3(0, 22, -4), screenOffset: { x: 80, y: -20 } },
                { name: '逆变器', component: 'pcs', worldPos: new THREE.Vector3(6, 24, 0), screenOffset: { x: 80, y: -30 } },
                { name: 'BMS', component: 'bms', worldPos: new THREE.Vector3(-6, 27, 0), screenOffset: { x: -120, y: -30 } },
                { name: '电池', component: 'battery', worldPos: new THREE.Vector3(0, 15, 0), screenOffset: { x: -100, y: -20 } },
                { name: '温度', component: 'thermal', worldPos: new THREE.Vector3(0, 4, 0), screenOffset: { x: -100, y: 20 } },
                { name: '消防', component: 'fire', worldPos: new THREE.Vector3(0, 26, -4), screenOffset: { x: -80, y: -40 } }
            ];
            
            // 更新标注位置
            function updateAnnotations() {
                componentPositions.forEach((comp, index) => {
                    // 将3D坐标转换为屏幕坐标
                    const vector = comp.worldPos.clone();
                    vector.project(camera);
                    
                    const x = (vector.x * 0.5 + 0.5) * renderer.domElement.clientWidth;
                    const y = (-vector.y * 0.5 + 0.5) * renderer.domElement.clientHeight;
                    
                    // 获取或创建标注元素
                    let annotation = document.getElementById(`annotation-${index}`);
                    if (!annotation) {
                        // 创建标注
                        annotation = document.createElement('div');
                        annotation.id = `annotation-${index}`;
                        annotation.className = 'annotation';
                        annotation.textContent = comp.name;
                        annotation.dataset.component = comp.component;
                        
                        // 添加点击事件
                        annotation.addEventListener('click', function() {
                            selectComponent(comp.component);
                        });
                        
                        annotations.appendChild(annotation);
                        
                        // 创建连线
                        const line = document.createElement('div');
                        line.id = `line-${index}`;
                        line.className = 'annotation-line';
                        annotations.appendChild(line);
                    }
                    
                    // 计算标注位置
                    const labelX = x + comp.screenOffset.x;
                    const labelY = y + comp.screenOffset.y;
                    
                    // 更新标注位置
                    annotation.style.left = labelX + 'px';
                    annotation.style.top = labelY + 'px';
                    
                    // 更新连线
                    const line = document.getElementById(`line-${index}`);
                    if (line) {
                        const dx = x - labelX;
                        const dy = y - labelY;
                        const length = Math.sqrt(dx * dx + dy * dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        
                        line.style.left = labelX + 'px';
                        line.style.top = (labelY + 15) + 'px';
                        line.style.width = length + 'px';
                        line.style.transform = `rotate(${angle}deg)`;
                    }
                });
            }
            
            // 在渲染循环中更新标注
            window.updateAnnotations = updateAnnotations;
        }
        
        // 选择组件
        function selectComponent(componentName) {
            selectedComponent = componentName;
            
            // 更新UI - 移除了组件标签面板相关代码
            
            // 高亮显示组件
            Object.keys(components).forEach(key => {
                const group = components[key];
                group.traverse(child => {
                    if (child.isMesh) {
                        child.material.opacity = key === componentName ? 1 : 0.3;
                        child.material.transparent = true;
                        if (key === componentName) {
                            child.material.emissive = child.material.color;
                            child.material.emissiveIntensity = 0.2;
                        } else {
                            child.material.emissive = new THREE.Color(0x000000);
                            child.material.emissiveIntensity = 0;
                        }
                    }
                });
            });
            
            // 映射3D组件到tab组件
            const tabMapping = {
                'pcs': 'pcs',
                'bms': 'bms',
                'battery': 'battery',
                'cooling': 'thermal',
                'fire': 'fire',
                'electrical': 'hv',
                'ems': 'ems'
            };
            
            const tabComponent = tabMapping[componentName] || 'overall';
            
            // 更新标签选中状态
            document.querySelectorAll('.component-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            const targetTab = document.querySelector(`.component-tab[onclick*="'${tabComponent}'"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 更新当前组件
            currentComponent = tabComponent;
            
            // 更新数据显示
            updateComponentData(tabComponent);
        }
        
        // 获取组件对应的标签名称
        function getComponentTabName(componentName) {
            const mapping = {
                'overall': '整机',
                'ems': 'EMS',
                'pcs': 'PCS',
                'bms': 'BMS',
                'battery': '电池',
                'thermal': '温度',
                'cooling': '温度',
                'fire': '消防',
                'electrical': '高压箱',
                'hv': '高压箱'
            };
            return mapping[componentName] || '整体';
        }
        
        // 更新组件数据
        function updateComponentData(componentName) {
            const dataContent = document.getElementById('dataContent');
            const realtimeData = document.getElementById('realtimeData');
            
            // 清空现有内容
            realtimeData.innerHTML = '';
            
            // 如果是从3D模型点击的组件，更新顶部标签选中状态
            if (componentName && componentName !== currentComponent) {
                currentComponent = componentName;
                document.querySelectorAll('.component-tab').forEach(t => {
                    t.classList.remove('active');
                    if (t.textContent.includes(getComponentTabName(componentName))) {
                        t.classList.add('active');
                    }
                });
            }
            
            switch(componentName) {
                case 'overall':
                    realtimeData.innerHTML = `
                        <!-- 核心运行参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">核心运行参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">SOC</div>
                                    <div class="metric-value">
                                        <span id="soc">85.4</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">电量充足</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">SOH</div>
                                    <div class="metric-value">
                                        <span id="soh">96.8</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">健康状态良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">温度</div>
                                    <div class="metric-value">
                                        <span id="temperature">26.3</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">充放电功率</div>
                                    <div class="metric-value">
                                        <span id="power">0.0</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">待机</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池电流</div>
                                    <div class="metric-value">
                                        <span id="current">0.1</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池电压</div>
                                    <div class="metric-value">
                                        <span id="voltage">748.8</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                                </div>
                            </div>
                        </div>

                        <!-- 运行统计 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">运行统计</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">充电次数</div>
                                    <div class="metric-value">
                                        <span>3</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">充电量</div>
                                    <div class="metric-value">
                                        <span>856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">充电成本</div>
                                    <div class="metric-value">
                                        <span style="color: #ef4444;">￥685.0</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">放电次数</div>
                                    <div class="metric-value">
                                        <span>2</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">放电量</div>
                                    <div class="metric-value">
                                        <span>743.0</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">放电收益</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">￥1114.5</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'ems':
                    realtimeData.innerHTML = `
                        <!-- EMS实时监控参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">EMS实时监控参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">系统状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常运行</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">系统稳定</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">策略模式</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #2563eb;">峰谷套利</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">自动调度</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">当前功率</div>
                                    <div class="metric-value">
                                        <span id="emsPower">125.8</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">充电中</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">目标SOC</div>
                                    <div class="metric-value">
                                        <span>90</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">峰时放电</div>
                                </div>
                            </div>
                        </div>

                        <!-- 控制参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">控制参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">充电限额</div>
                                    <div class="metric-value">
                                        <span>150</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">最大充电功率</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">放电限额</div>
                                    <div class="metric-value">
                                        <span>150</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">最大放电功率</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">通信状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">在线</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">通信正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">响应时间</div>
                                    <div class="metric-value">
                                        <span id="emsResponseTime">28</span>
                                        <span class="metric-unit">ms</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">响应及时</div>
                                </div>
                            </div>
                        </div>

                        <!-- 调度统计 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">调度统计</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">今日调度次数</div>
                                    <div class="metric-value">
                                        <span>24</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">较昨日+2次</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">策略执行率</div>
                                    <div class="metric-value">
                                        <span>98.5</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">执行良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">今日收益</div>
                                    <div class="metric-value">
                                        <span>1,245</span>
                                        <span class="metric-unit">元</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">较昨日+12%</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">运行效率</div>
                                    <div class="metric-value">
                                        <span>96.8</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">高效运行</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                case 'pcs':
                    realtimeData.innerHTML = `
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">PCS变流器实时数据</h3>
                        
                        <!-- 核心参数 -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">核心运行参数</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">直流侧电压</div>
                                    <div class="metric-value">
                                        <span id="pcs-dc-voltage">${(750 + Math.random() * 20).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">直流侧电流</div>
                                    <div class="metric-value">
                                        <span id="pcs-dc-current">${(150 + Math.random() * 50).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">交流侧电压</div>
                                    <div class="metric-value">
                                        <span id="pcs-ac-voltage">${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">交流侧电流</div>
                                    <div class="metric-value">
                                        <span id="pcs-ac-current">${(280 + Math.random() * 40).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">有功功率</div>
                                    <div class="metric-value">
                                        <span id="pcs-power" style="color: #10b981;">${(100 + Math.random() * 50).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">功率因数</div>
                                    <div class="metric-value">
                                        <span id="pcs-pf">${(0.95 + Math.random() * 0.04).toFixed(3)}</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 运行状态 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">运行状态</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">转换效率</div>
                                    <div class="metric-value">
                                        <span id="pcs-efficiency">${(96.5 + Math.random() * 2).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">散热器温度</div>
                                    <div class="metric-value">
                                        <span id="pcs-temp">${(45 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">IGBT温度</div>
                                    <div class="metric-value">
                                        <span id="pcs-igbt-temp">${(55 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">运行时长</div>
                                    <div class="metric-value">
                                        <span id="pcs-runtime">15,862</span>
                                        <span class="metric-unit">h</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 告警信息 -->
                        <div class="alert-section" style="margin-top: 20px;">
                            <div class="alert-title">
                                <i class="fas fa-info-circle"></i>
                                PCS运行状态
                            </div>
                            <div style="font-size: 13px; color: #065f46;">• 系统运行正常，无告警</div>
                            <div style="font-size: 13px; color: #065f46;">• 效率维持在96%以上</div>
                            <div style="font-size: 13px; color: #065f46;">• 建议定期清理散热器</div>
                        </div>
                    `;
                    break;
                    
                case 'bms':
                    realtimeData.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--text-primary);">BMS电池管理系统 - 实时数据</h3>
                            <button onclick="location.reload()" style="padding: 6px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-arrow-left" style="margin-right: 6px;"></i>返回整机
                            </button>
                        </div>
                        
                        <!-- 电池状态 -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">电池组状态</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">总电压</div>
                                    <div class="metric-value">
                                        <span>${(750 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">总电流</div>
                                    <div class="metric-value">
                                        <span>${(150 + Math.random() * 50).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">SOC</div>
                                    <div class="metric-value">
                                        <span>${(80 + Math.random() * 15).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">SOH</div>
                                    <div class="metric-value">
                                        <span>${(96 + Math.random() * 2).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 单体监控 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">单体监控</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">最高单体电压</div>
                                    <div class="metric-value">
                                        <span>${(3.35 + Math.random() * 0.01).toFixed(3)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">最低单体电压</div>
                                    <div class="metric-value">
                                        <span>${(3.34 + Math.random() * 0.01).toFixed(3)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">压差</div>
                                    <div class="metric-value">
                                        <span>${(0.005 + Math.random() * 0.005).toFixed(3)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">一致性</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">${(98 + Math.random() * 1.5).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 温度监控 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">温度监控</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">最高温度</div>
                                    <div class="metric-value">
                                        <span>${(30 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">最低温度</div>
                                    <div class="metric-value">
                                        <span>${(25 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">平均温度</div>
                                    <div class="metric-value">
                                        <span>${(27 + Math.random() * 3).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">温差</div>
                                    <div class="metric-value">
                                        <span>${(3 + Math.random() * 2).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'thermal':
                case 'cooling':
                    realtimeData.innerHTML = `
                        <!-- 核心监控参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">核心监控参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">电池包最高温度</div>
                                    <div class="metric-value">
                                        <span id="battMaxTemp">${(26 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常范围</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池包最低温度</div>
                                    <div class="metric-value">
                                        <span id="battMinTemp">${(22 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常范围</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池包平均温度</div>
                                    <div class="metric-value">
                                        <span id="battAvgTemp">${(24 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常范围</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池包温差</div>
                                    <div class="metric-value">
                                        <span id="battTempDiff">${(2 + Math.random() * 3).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度均匀</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">进风温度</div>
                                    <div class="metric-value">
                                        <span id="inletTemp">${(20 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">环境正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">出风温度</div>
                                    <div class="metric-value">
                                        <span id="outletTemp">${(28 + Math.random() * 6).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">散热正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">相对湿度</div>
                                    <div class="metric-value">
                                        <span id="humidity">${(40 + Math.random() * 20).toFixed(1)}</span>
                                        <span class="metric-unit">%RH</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">湿度适宜</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">冷却液温度</div>
                                    <div class="metric-value">
                                        <span id="coolantTemp">${(18 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">冷却正常</div>
                                </div>
                            </div>
                        </div>

                        <!-- 系统运行参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">系统运行参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">主风机转速</div>
                                    <div class="metric-value">
                                        <span id="mainFanSpeed">${(1800 + Math.random() * 400).toFixed(0)}</span>
                                        <span class="metric-unit">RPM</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">运转正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">辅助风机转速</div>
                                    <div class="metric-value">
                                        <span id="auxFanSpeed">${(1200 + Math.random() * 300).toFixed(0)}</span>
                                        <span class="metric-unit">RPM</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">运转正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">冷却液流速</div>
                                    <div class="metric-value">
                                        <span id="coolantFlow">${(15 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">L/min</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">流速稳定</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">压缩机功率</div>
                                    <div class="metric-value">
                                        <span id="compressorPower">${(3.2 + Math.random() * 1.8).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">负载正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">热管理功耗</div>
                                    <div class="metric-value">
                                        <span id="thermalPower">${(5.8 + Math.random() * 2.2).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">能耗正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">温升速率</div>
                                    <div class="metric-value">
                                        <span id="tempRiseRate">${(0.05 + Math.random() * 0.25).toFixed(3)}</span>
                                        <span class="metric-unit">°C/min</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">变化缓慢</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">制冷效率</div>
                                    <div class="metric-value">
                                        <span id="coolingEff">${(88 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">效率良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">COP系数</div>
                                    <div class="metric-value">
                                        <span id="copValue">${(3.2 + Math.random() * 0.8).toFixed(2)}</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">性能优秀</div>
                                </div>
                            </div>
                        </div>

                        <!-- 运行状态 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">运行状态</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">热管理状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">自动调节</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">智能温控运行</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">冷却模式</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">主动制冷</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">风冷+液冷混合</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">今日运行时间</div>
                                    <div class="metric-value">
                                        <span id="thermalRuntime">${(18 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">小时</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">连续稳定运行</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">维护状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">良好</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">过滤器状态正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">启停次数</div>
                                    <div class="metric-value">
                                        <span id="thermalCycles">${Math.floor(2 + Math.random() * 3)}</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">今日启停统计</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">过滤器状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">清洁</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">使用时长: 45天</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">报警状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">无报警</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">系统运行正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">能效等级</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">一级</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">节能优秀</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'fire':
                    realtimeData.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--text-primary);">消防系统 - 实时数据</h3>
                            <button onclick="location.reload()" style="padding: 6px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-arrow-left" style="margin-right: 6px;"></i>返回整机
                            </button>
                        </div>
                        
                        <!-- 系统状态 -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">系统状态</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">系统状态</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常待命</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">压力</div>
                                    <div class="metric-value">
                                        <span>${(1.2 + Math.random() * 0.2).toFixed(1)}</span>
                                        <span class="metric-unit">MPa</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">烟感探测器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">温感探测器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 检测记录 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">最近检测记录</h4>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                    • 2024-01-28 10:00 - 月度检查完成<br>
                                    • 2024-01-15 14:30 - 压力测试正常<br>
                                    • 2023-12-28 09:00 - 年度维护完成<br>
                                    • 上次触发：无
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'electrical':
                    realtimeData.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--text-primary);">配电柜 - 实时数据</h3>
                            <button onclick="location.reload()" style="padding: 6px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-arrow-left" style="margin-right: 6px;"></i>返回整机
                            </button>
                        </div>
                        
                        <!-- 电气参数 -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">电气参数</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">A相电压</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">B相电压</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">C相电压</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">频率</div>
                                    <div class="metric-value">
                                        <span>${(49.9 + Math.random() * 0.2).toFixed(2)}</span>
                                        <span class="metric-unit">Hz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 开关状态 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">开关状态</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">主断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">PCS断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">辅助电源</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'battery':
                    realtimeData.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--text-primary);">电池模组 - 实时数据</h3>
                            <button onclick="location.reload()" style="padding: 6px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-arrow-left" style="margin-right: 6px;"></i>返回整机
                            </button>
                        </div>
                        
                        <!-- 电池组参数 -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">电池组参数</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">组电压</div>
                                    <div class="metric-value">
                                        <span>${(750 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">组电流</div>
                                    <div class="metric-value">
                                        <span>${(150 + Math.random() * 50).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">剩余容量</div>
                                    <div class="metric-value">
                                        <span>${(200 + Math.random() * 50).toFixed(1)}</span>
                                        <span class="metric-unit">Ah</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">可用能量</div>
                                    <div class="metric-value">
                                        <span>${(150 + Math.random() * 50).toFixed(1)}</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pack状态 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">Pack状态监控</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
                                ${Array.from({length: 7}, (_, i) => `
                                    <div style="background: var(--bg-secondary); padding: 12px; border-radius: 6px; text-align: center;">
                                        <div style="font-size: 12px; color: var(--text-secondary);">Pack ${String(i + 1).padStart(2, '0')}</div>
                                        <div style="font-size: 16px; font-weight: 600; margin-top: 4px; color: #10b981;">${(3.35 + Math.random() * 0.01).toFixed(3)}V</div>
                                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${(25 + Math.random() * 5).toFixed(1)}°C</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'hv':
                case 'electrical':
                    realtimeData.innerHTML = `
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">高压箱实时数据</h3>
                            
                            <!-- 主断路器状态 -->
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">主断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">防雷器状态</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">绝缘电阻</div>
                                    <div class="metric-value">
                                        <span>${(500 + Math.random() * 100).toFixed(0)}</span>
                                        <span class="metric-unit">MΩ</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">直流母线电压</div>
                                    <div class="metric-value">
                                        <span>${(750 + Math.random() * 20).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 支路保护 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">支路保护状态</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">电池支路</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">PCS支路</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">辅助电源</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">接地状态</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">良好</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    // 默认显示整体数据
                    updateComponentData('overall');
            }
        }
        
        // 当前选中的组件
        let currentComponent = 'overall';
        
        // 切换组件标签页
        function switchComponent(component) {
            currentComponent = component;
            
            // 更新组件标签样式
            document.querySelectorAll('.component-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 更新数据内容
            updateComponentData(component);
            
            // 如果在历史数据页面，重新加载图表
            if (document.getElementById('historyData').style.display !== 'none') {
                initHistoryCharts();
            }
        }
        
        // 切换数据标签页
        function switchTab(tab) {
            document.querySelectorAll('.data-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (tab === 'realtime') {
                document.getElementById('realtimeData').style.display = 'block';
                document.getElementById('historyData').style.display = 'none';
            } else {
                document.getElementById('realtimeData').style.display = 'none';
                document.getElementById('historyData').style.display = 'block';
                initHistoryCharts();
            }
        }
        
        
        // 初始化历史图表
        function initHistoryCharts() {
            // 根据当前选中的组件显示不同的历史数据
            if (currentComponent === 'overall') {
                // 整机历史数据 - 显示功率和SOC趋势
                document.getElementById('historyData').innerHTML = `
                    <!-- 累计指标卡片 -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px;">
                        <div class="card metric-card">
                            <div class="metric-value" id="totalCharging">2,456,789<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">kWh</span></div>
                            <div class="metric-label">累计充电量</div>
                            <div class="metric-change positive">↑ 12.5% 较上月</div>
                        </div>
                        <div class="card metric-card">
                            <div class="metric-value" id="totalDischarging">2,234,567<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">kWh</span></div>
                            <div class="metric-label">累计放电量</div>
                            <div class="metric-change positive">↑ 8.3% 较上月</div>
                        </div>
                        <div class="card metric-card">
                            <div class="metric-value" id="totalRevenue">383,301<span style="font-size: 1rem; font-weight: 400; color: var(--text-secondary); margin-left: 2px;">元</span></div>
                            <div class="metric-label">累计收益</div>
                            <div class="metric-change positive">↑ 15.2% 较上月</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title">功率与SOC综合分析</div>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="date" class="form-input" id="historyEndDatePicker" style="width: 140px; height: 32px; padding: 4px 8px; font-size: 13px;" onchange="updateHistoryChart()">
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="powerSocChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title">收益分析</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select class="form-input" id="revenueTimeFilter" style="width: 80px; height: 32px; padding: 4px 8px; font-size: 13px;" onchange="toggleRevenueTimePicker()">
                                    <option value="day">日</option>
                                    <option value="month">月</option>
                                    <option value="year">年</option>
                                    <option value="total">总</option>
                                </select>
                                <input type="date" class="form-input" id="revenueDayPicker" style="width: 140px; height: 32px; padding: 4px 8px; font-size: 13px;" onchange="updateRevenueChart()">
                                <input type="month" class="form-input" id="revenueMonthPicker" style="width: 140px; height: 32px; padding: 4px 8px; font-size: 13px; display: none;" onchange="updateRevenueChart()">
                                <select class="form-input" id="revenueYearPicker" style="width: 100px; height: 32px; padding: 4px 8px; font-size: 13px; display: none;" onchange="updateRevenueChart()">
                                    <option value="2024">2024年</option>
                                    <option value="2023">2023年</option>
                                    <option value="2022">2022年</option>
                                    <option value="2021">2021年</option>
                                    <option value="2020">2020年</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                `;
                
                // 延迟初始化图表，确保DOM已更新
                setTimeout(() => {
                    initOverallHistoryCharts();
                    initRevenueChart();
                    updateCumulativeMetrics();
                    initRevenueTimePickers();
                }, 100);
                return;
            }
            
            // 根据组件类型显示不同的历史数据
            if (currentComponent === 'ems') {
                // EMS历史数据
                document.getElementById('historyData').innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">EMS策略执行历史</div>
                        <div class="chart-wrapper">
                            <canvas id="emsStrategyChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">调度响应时间</div>
                        <div class="chart-wrapper">
                            <canvas id="emsResponseChart"></canvas>
                        </div>
                    </div>
                `;
                
                // 延迟初始化EMS图表
                setTimeout(() => {
                    initEMSHistoryCharts();
                }, 100);
                return;
            }
            
            if (currentComponent === 'pcs') {
                // 逆变器历史数据
                document.getElementById('historyData').innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">PCS功率转换历史</div>
                        <div class="chart-wrapper">
                            <canvas id="pcsPowerChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">电压电流趋势</div>
                        <div class="chart-wrapper">
                            <canvas id="pcsVoltageChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">转换效率统计</div>
                        <div class="chart-wrapper">
                            <canvas id="pcsEfficiencyChart"></canvas>
                        </div>
                    </div>
                `;
                
                // 延迟初始化PCS图表
                setTimeout(() => {
                    initPCSHistoryCharts();
                }, 100);
                return;
            }
            
            if (currentComponent === 'bms') {
                // BMS历史数据
                document.getElementById('historyData').innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">电池管理状态历史</div>
                        <div class="chart-wrapper">
                            <canvas id="bmsStatusChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">SOC均衡管理</div>
                        <div class="chart-wrapper">
                            <canvas id="bmsBalanceChart"></canvas>
                        </div>
                    </div>
                `;
                
                setTimeout(() => { initBMSHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'battery') {
                // 电池历史数据
                document.getElementById('historyData').innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">电池性能趋势</div>
                        <div class="chart-wrapper">
                            <canvas id="batteryPerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">循环寿命统计</div>
                        <div class="chart-wrapper">
                            <canvas id="batteryCycleChart"></canvas>
                        </div>
                    </div>
                `;
                
                setTimeout(() => { initBatteryHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'thermal') {
                // 温度历史数据
                document.getElementById('historyData').innerHTML = `
                    <!-- 时间范围选择 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="display: flex; gap: 8px;">
                            <button class="time-range-btn active" onclick="changeTimeRange('24h')">24小时</button>
                            <button class="time-range-btn" onclick="changeTimeRange('7d')">7天</button>
                            <button class="time-range-btn" onclick="changeTimeRange('30d')">30天</button>
                            <button class="time-range-btn" onclick="changeTimeRange('90d')">90天</button>
                        </div>
                        <input type="date" class="form-input" id="thermalEndDatePicker" style="width: 140px; height: 32px; padding: 4px 8px;" onchange="updateThermalHistoryCharts()">
                    </div>
                    
                    <!-- 温度统计卡片 -->
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
                        <div class="card metric-card">
                            <div class="metric-value" id="avgTempPeriod">24.5<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">°C</span></div>
                            <div class="metric-label">期间平均温度</div>
                            <div class="metric-change positive">↓ 1.2°C 较上期</div>
                        </div>
                        <div class="card metric-card">
                            <div class="metric-value" id="maxTempPeriod">32.8<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">°C</span></div>
                            <div class="metric-label">期间最高温度</div>
                            <div class="metric-change warning">↑ 0.8°C 较上期</div>
                        </div>
                        <div class="card metric-card">
                            <div class="metric-value" id="coolingRuntime">18.5<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">h</span></div>
                            <div class="metric-label">制冷运行时长</div>
                            <div class="metric-change positive">↓ 2.3h 较上期</div>
                        </div>
                        <div class="card metric-card">
                            <div class="metric-value" id="energyConsumption">156.8<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">kWh</span></div>
                            <div class="metric-label">制冷能耗</div>
                            <div class="metric-change positive">↓ 8.5% 较上期</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">电池包温度分布历史</div>
                        <div class="chart-wrapper">
                            <canvas id="batteryTempChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">环境温度与湿度变化</div>
                        <div class="chart-wrapper">
                            <canvas id="environmentChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">制冷系统性能分析</div>
                        <div class="chart-wrapper">
                            <canvas id="coolingPerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">热管理能效统计</div>
                        <div class="chart-wrapper">
                            <canvas id="thermalEfficiencyChart"></canvas>
                        </div>
                    </div>
                `;
                
                setTimeout(() => { initThermalHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'fire') {
                // 消防历史数据
                document.getElementById('historyData').innerHTML = `
                    <div class="chart-container">
                        <div class="chart-title">消防系统状态</div>
                        <div class="chart-wrapper">
                            <canvas id="fireSystemChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">气体浓度监测</div>
                        <div class="chart-wrapper">
                            <canvas id="gasDetectionChart"></canvas>
                        </div>
                    </div>
                `;
                
                setTimeout(() => { initFireHistoryCharts(); }, 100);
                return;
            }
            
            // 其他组件的历史数据保持原样
            // 功率历史
            const powerCtx = document.getElementById('powerHistoryChart').getContext('2d');
            new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: '充电功率',
                        data: Array.from({length: 24}, (_, i) => {
                            // 模拟典型充放电曲线
                            if (i >= 10 && i <= 16) return Math.random() * 50 + 100;
                            if (i >= 6 && i <= 9) return -(Math.random() * 50 + 80);
                            if (i >= 18 && i <= 22) return -(Math.random() * 50 + 60);
                            return Math.random() * 20 - 10;
                        }),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return value > 0 ? `充电: ${value.toFixed(1)} kW` : `放电: ${Math.abs(value).toFixed(1)} kW`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return '#666';
                                    }
                                    return 'rgba(0, 0, 0, 0.05)';
                                }
                            }
                        }
                    }
                }
            });
            
            // SOC历史
            const socCtx = document.getElementById('socHistoryChart').getContext('2d');
            new Chart(socCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: 'SOC',
                        data: Array.from({length: 24}, (_, i) => {
                            // 模拟SOC变化
                            const base = 85;
                            if (i <= 6) return base - i * 2;
                            if (i <= 10) return 73 + (i - 6) * 5;
                            if (i <= 16) return 93 - (i - 10) * 2;
                            if (i <= 22) return 81 - (i - 16) * 3;
                            return 63 + (i - 22) * 11;
                        }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: '充放电状态',
                        data: Array.from({length: 24}, (_, i) => {
                            if (i >= 10 && i <= 16) return 1; // 充电
                            if (i >= 6 && i <= 9) return -1; // 放电
                            if (i >= 18 && i <= 22) return -1; // 放电
                            return 0; // 待机
                        }),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        stepped: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: -1.5,
                            max: 1.5,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value === 1) return '充电';
                                    if (value === -1) return '放电';
                                    if (value === 0) return '待机';
                                    return '';
                                }
                            }
                        }
                    }
                }
            });
            
            // 温度分布
            const tempCtx = document.getElementById('tempHistoryChart').getContext('2d');
            new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: '最高温度',
                        data: Array.from({length: 24}, () => Math.random() * 5 + 30),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }, {
                        label: '平均温度',
                        data: Array.from({length: 24}, () => Math.random() * 5 + 27),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    }, {
                        label: '最低温度',
                        data: Array.from({length: 24}, () => Math.random() * 5 + 24),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // 电压一致性
            const voltageCtx = document.getElementById('voltageConsistencyChart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '单体电压分布',
                            data: Array.from({length: 100}, () => ({
                                x: Math.floor(Math.random() * 20) + 1,
                                y: 3.35 + (Math.random() - 0.5) * 0.01
                            })),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '电池单体编号'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '电压 (V)'
                                },
                                min: 3.34,
                                max: 3.36
                            }
                        }
                    }
                });
            }
            
            // 充放电效率分析
            const efficiencyCtx = document.getElementById('efficiencyChart');
            if (efficiencyCtx) {
                new Chart(efficiencyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        datasets: [{
                            label: '充电效率',
                            data: [96.2, 96.5, 96.3, 96.8, 96.4, 96.1, 95.8, 95.5, 96.0, 96.3, 96.4, 96.2],
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }, {
                            label: '放电效率',
                            data: [95.8, 96.0, 95.9, 96.2, 96.0, 95.7, 95.4, 95.1, 95.6, 95.9, 96.0, 95.8],
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 94,
                                max: 97,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 峰谷套利分析
            const arbitrageCtx = document.getElementById('arbitrageChart');
            if (arbitrageCtx) {
                new Chart(arbitrageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['00:00', '02:00', '04:00', '06:00', '08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'],
                        datasets: [{
                            label: '电价',
                            data: [0.3, 0.3, 0.3, 0.4, 0.8, 1.2, 1.5, 1.5, 1.2, 1.5, 1.2, 0.6],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: '功率',
                            data: [150, 180, 200, 150, -100, -150, -180, -200, -150, -180, -100, 100],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '电价 (元/kWh)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: '功率 (kW)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
            
            // 健康度趋势
            const sohTrendCtx = document.getElementById('sohTrendChart');
            if (sohTrendCtx) {
                new Chart(sohTrendCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['2023-01', '2023-03', '2023-05', '2023-07', '2023-09', '2023-11', '2024-01'],
                        datasets: [{
                            label: 'SOH',
                            data: [100, 99.5, 99.1, 98.5, 97.8, 97.2, 96.8],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }, {
                            label: '预测趋势',
                            data: [null, null, null, null, null, null, 96.8, 96.2, 95.5, 94.8],
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 94,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 95,
                                        yMax: 95,
                                        borderColor: 'rgb(255, 99, 132)',
                                        borderWidth: 2,
                                        borderDash: [5, 5]
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 生成历史每日数据
        function generateHistoryDailyData(timeRange, endDate) {
            const end = new Date(endDate);
            const days = parseInt(timeRange);
            const labels = [];
            const powerData = [];
            const socData = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(end);
                date.setDate(date.getDate() - i);
                
                // 格式化日期标签
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                labels.push(label);
                
                // 生成模拟功率数据（正数充电，负数放电）
                const basePower = 1000 + Math.sin(i * 0.5) * 800;
                const powerVariation = (Math.random() - 0.5) * 600;
                powerData.push(Math.round(basePower + powerVariation));
                
                // 生成模拟SOC数据
                const baseSOC = 75 + Math.sin(i * 0.3) * 15;
                const socVariation = (Math.random() - 0.5) * 10;
                socData.push(Math.max(20, Math.min(95, Math.round(baseSOC + socVariation))));
            }
            
            return { labels, powerData, socData };
        }
        
        // 更新历史图表
        function updateHistoryChart() {
            const endDate = document.getElementById('historyEndDatePicker').value;
            initOverallHistoryCharts('30d', endDate);
        }
        
        // 初始化收益分析图表
        function initRevenueChart(timeFilter = 'day', selectedTime = null) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            const { labels, chargingData, dischargingData, revenueData } = generateRevenueData(timeFilter, selectedTime);
            
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '充电量 (kWh)',
                        data: chargingData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: '放电量 (kWh)',
                        data: dischargingData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: '净收益 (¥)',
                        data: revenueData,
                        type: 'line',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderColor: '#f59e0b',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('收益')) {
                                        return context.dataset.label + ': ¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' kWh';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: '电量 (kWh)'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: '收益 (¥)'
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // 生成收益分析数据
        function generateRevenueData(timeFilter, selectedTime = null) {
            let labels = [];
            let dataPoints = 0;
            
            switch(timeFilter) {
                case 'day':
                    // 选择具体日期当天的24小时时间点
                    dataPoints = 24;
                    for (let i = 0; i < 24; i++) {
                        labels.push(`${i}:00`);
                    }
                    break;
                case 'month':
                    // 选择具体月份的每一天
                    if (selectedTime) {
                        const [year, month] = selectedTime.split('-');
                        const daysInMonth = new Date(year, month, 0).getDate();
                        dataPoints = daysInMonth;
                        for (let i = 1; i <= daysInMonth; i++) {
                            labels.push(`${i}日`);
                        }
                    } else {
                        // 默认显示当前月
                        const now = new Date();
                        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                        dataPoints = daysInMonth;
                        for (let i = 1; i <= daysInMonth; i++) {
                            labels.push(`${i}日`);
                        }
                    }
                    break;
                case 'year':
                    // 选择具体年份的12个月
                    dataPoints = 12;
                    const selectedYear = selectedTime || new Date().getFullYear();
                    const monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                    for (let i = 0; i < 12; i++) {
                        labels.push(monthNames[i]);
                    }
                    break;
                case 'total':
                    // 总计按年显示
                    dataPoints = 5;
                    const currentYear = new Date().getFullYear();
                    for (let i = 4; i >= 0; i--) {
                        labels.push(`${currentYear - i}年`);
                    }
                    break;
            }
            
            // 生成模拟数据
            const chargingData = [];
            const dischargingData = [];
            const revenueData = [];
            
            for (let i = 0; i < dataPoints; i++) {
                // 充电量数据
                const baseCharging = timeFilter === 'day' ? 2000 + Math.random() * 1000 : 
                                   timeFilter === 'month' ? 50000 + Math.random() * 25000 :
                                   timeFilter === 'year' ? 600000 + Math.random() * 200000 :
                                   150000 + Math.random() * 50000;
                chargingData.push(Math.round(baseCharging));
                
                // 放电量数据
                const baseDischarging = baseCharging * (0.85 + Math.random() * 0.1); // 85-95%效率
                dischargingData.push(Math.round(baseDischarging));
                
                // 收益数据（放电收入 - 充电成本）
                const chargingCost = chargingData[i] * 0.4; // 充电成本0.4元/kWh
                const dischargingRevenue = dischargingData[i] * 0.7; // 放电收入0.7元/kWh
                const netRevenue = dischargingRevenue - chargingCost;
                revenueData.push(Math.round(netRevenue));
            }
            
            return { labels, chargingData, dischargingData, revenueData };
        }
        
        // 初始化收益时间选择器
        function initRevenueTimePickers() {
            // 设置默认日期为今天
            const today = new Date();
            document.getElementById('revenueDayPicker').value = today.toISOString().split('T')[0];
            
            // 设置默认月份为当前月
            const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            document.getElementById('revenueMonthPicker').value = currentMonth;
            
            // 设置默认年份为当前年
            document.getElementById('revenueYearPicker').value = today.getFullYear().toString();
        }
        
        // 切换收益时间选择器显示
        function toggleRevenueTimePicker() {
            const timeFilter = document.getElementById('revenueTimeFilter').value;
            const dayPicker = document.getElementById('revenueDayPicker');
            const monthPicker = document.getElementById('revenueMonthPicker');
            const yearPicker = document.getElementById('revenueYearPicker');
            
            // 隐藏所有选择器
            dayPicker.style.display = 'none';
            monthPicker.style.display = 'none';
            yearPicker.style.display = 'none';
            
            // 根据时间类型显示对应选择器
            switch(timeFilter) {
                case 'day':
                    dayPicker.style.display = 'block';
                    break;
                case 'month':
                    monthPicker.style.display = 'block';
                    break;
                case 'year':
                    yearPicker.style.display = 'block';
                    break;
                case 'total':
                    // 总计不显示时间选择器
                    break;
            }
            
            // 更新图表
            updateRevenueChart();
        }
        
        // 更新收益分析图表
        function updateRevenueChart() {
            const timeFilter = document.getElementById('revenueTimeFilter').value;
            let selectedTime = null;
            
            // 获取选中的时间
            switch(timeFilter) {
                case 'day':
                    selectedTime = document.getElementById('revenueDayPicker').value;
                    break;
                case 'month':
                    selectedTime = document.getElementById('revenueMonthPicker').value;
                    break;
                case 'year':
                    selectedTime = document.getElementById('revenueYearPicker').value;
                    break;
                case 'total':
                    selectedTime = null;
                    break;
            }
            
            // 销毁现有图表
            const canvas = document.getElementById('revenueChart');
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // 重新初始化图表
            initRevenueChart(timeFilter, selectedTime);
        }
        
        // 更新累计指标
        function updateCumulativeMetrics() {
            // 模拟累计数据更新
            const chargingElement = document.getElementById('totalCharging');
            const dischargingElement = document.getElementById('totalDischarging');
            const revenueElement = document.getElementById('totalRevenue');
            
            if (chargingElement) {
                // 生成累计充电量（240万-280万kWh）
                const totalCharging = 2400000 + Math.random() * 400000;
                chargingElement.innerHTML = `${Math.round(totalCharging).toLocaleString()}<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">kWh</span>`;
            }
            
            if (dischargingElement) {
                // 生成累计放电量（220万-260万kWh，考虑效率损失）
                const totalDischarging = 2200000 + Math.random() * 400000;
                dischargingElement.innerHTML = `${Math.round(totalDischarging).toLocaleString()}<span style="font-size: 0.9rem; font-weight: 400; color: var(--text-secondary);">kWh</span>`;
            }
            
            if (revenueElement) {
                // 生成累计收益（30万-40万元）
                const totalRevenue = 300000 + Math.random() * 100000;
                revenueElement.innerHTML = `${Math.round(totalRevenue).toLocaleString()}<span style="font-size: 1rem; font-weight: 400; color: var(--text-secondary); margin-left: 2px;">元</span>`;
            }
        }
        
        // 初始化EMS历史数据图表
        function initEMSHistoryCharts() {
            // EMS策略执行历史
            const strategyCtx = document.getElementById('emsStrategyChart');
            if (strategyCtx) {
                new Chart(strategyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '调度次数',
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 5) + 1),
                            backgroundColor: 'rgba(37, 99, 235, 0.8)',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }, {
                            label: '执行成功率',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 90),
                            type: 'line',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '调度次数' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: '成功率 (%)' },
                                min: 80,
                                max: 100,
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // 调度响应时间
            const responseCtx = document.getElementById('emsResponseChart');
            if (responseCtx) {
                new Chart(responseCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '平均响应时间',
                            data: Array.from({length: 24}, () => Math.random() * 30 + 20),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: '最大响应时间',
                            data: Array.from({length: 24}, () => Math.random() * 50 + 40),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '响应时间 (ms)' }
                            }
                        }
                    }
                });
            }
        }
        
        // 初始化PCS历史数据图表
        function initPCSHistoryCharts() {
            // PCS功率转换历史
            const powerCtx = document.getElementById('pcsPowerChart');
            if (powerCtx) {
                new Chart(powerCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'AC功率输出',
                            data: Array.from({length: 24}, () => Math.random() * 100 + 50),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'DC功率输入',
                            data: Array.from({length: 24}, () => Math.random() * 110 + 55),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '功率 (kW)' }
                            }
                        }
                    }
                });
            }
            
            // 电压电流趋势
            const voltageCtx = document.getElementById('pcsVoltageChart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'DC电压',
                            data: Array.from({length: 24}, () => Math.random() * 20 + 750),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: 'DC电流',
                            data: Array.from({length: 24}, () => Math.random() * 50 + 150),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                position: 'left',
                                title: { display: true, text: '电压 (V)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: '电流 (A)' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // 转换效率统计
            const efficiencyCtx = document.getElementById('pcsEfficiencyChart');
            if (efficiencyCtx) {
                new Chart(efficiencyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '转换效率',
                            data: Array.from({length: 24}, () => Math.random() * 5 + 93),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                min: 90,
                                max: 100,
                                title: { display: true, text: '效率 (%)' }
                            }
                        }
                    }
                });
            }
        }
        
        // 初始化BMS历史数据图表
        function initBMSHistoryCharts() {
            const statusCtx = document.getElementById('bmsStatusChart');
            if (statusCtx) {
                new Chart(statusCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '总电压',
                            data: Array.from({length: 24}, () => Math.random() * 20 + 750),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: '总电流',
                            data: Array.from({length: 24}, () => Math.random() * 50 + 150),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: { position: 'left', title: { display: true, text: '电压 (V)' } },
                            y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: '电流 (A)' }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
            
            const balanceCtx = document.getElementById('bmsBalanceChart');
            if (balanceCtx) {
                new Chart(balanceCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['模组1', '模组2', '模组3', '模组4', '模组5', '模组6'],
                        datasets: [{
                            label: 'SOC分布',
                            data: [85, 83, 87, 84, 86, 85],
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { min: 80, max: 90, title: { display: true, text: 'SOC (%)' } } }
                    }
                });
            }
        }
        
        // 初始化电池历史数据图表
        function initBatteryHistoryCharts() {
            const performanceCtx = document.getElementById('batteryPerformanceChart');
            if (performanceCtx) {
                new Chart(performanceCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '容量保持率',
                            data: Array.from({length: 24}, () => Math.random() * 2 + 96),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: '内阻变化',
                            data: Array.from({length: 24}, () => Math.random() * 0.5 + 2),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: { title: { display: true, text: '容量保持率 (%)' } },
                            y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: '内阻 (mΩ)' }, grid: { drawOnChartArea: false } }
                        }
                    }
                });
            }
            
            const cycleCtx = document.getElementById('batteryCycleChart');
            if (cycleCtx) {
                new Chart(cycleCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['本周', '上周', '2周前', '3周前'],
                        datasets: [{
                            label: '循环次数',
                            data: [28, 32, 29, 31],
                            backgroundColor: 'rgba(37, 99, 235, 0.8)',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, title: { display: true, text: '循环次数' } } }
                    }
                });
            }
        }
        
        // 初始化温度历史数据图表
        function initThermalHistoryCharts() {
            // 设置日期选择器默认值
            const today = new Date();
            const endDatePicker = document.getElementById('thermalEndDatePicker');
            if (endDatePicker) {
                endDatePicker.value = today.toISOString().split('T')[0];
            }
            
            // 电池包温度分布历史
            const batteryTempCtx = document.getElementById('batteryTempChart');
            if (batteryTempCtx) {
                new Chart(batteryTempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '电池包最高温度',
                            data: Array.from({length: 24}, (_, i) => {
                                // 模拟电池温度随时间和充放电状态变化
                                const baseTemp = 25;
                                const timeVariation = Math.sin(i * Math.PI / 12) * 3;
                                const randomVariation = (Math.random() - 0.5) * 2;
                                return (baseTemp + timeVariation + randomVariation + (i >= 10 && i <= 16 ? 4 : 0)).toFixed(1);
                            }),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '电池包平均温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 23;
                                const timeVariation = Math.sin(i * Math.PI / 12) * 2;
                                const randomVariation = (Math.random() - 0.5) * 1.5;
                                return (baseTemp + timeVariation + randomVariation + (i >= 10 && i <= 16 ? 2 : 0)).toFixed(1);
                            }),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '电池包最低温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 21;
                                const timeVariation = Math.sin(i * Math.PI / 12) * 1.5;
                                const randomVariation = (Math.random() - 0.5) * 1;
                                return (baseTemp + timeVariation + randomVariation + (i >= 10 && i <= 16 ? 1 : 0)).toFixed(1);
                            }),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'top' },
                            title: { display: true, text: '电池包温度变化趋势' }
                        },
                        scales: { 
                            y: { 
                                title: { display: true, text: '温度 (°C)' },
                                min: 15,
                                max: 35
                            },
                            x: { title: { display: true, text: '时间' } }
                        }
                    }
                });
            }
            
            // 环境温度与湿度变化
            const environmentCtx = document.getElementById('environmentChart');
            if (environmentCtx) {
                new Chart(environmentCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '进风温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 22;
                                const timeVariation = Math.sin((i - 6) * Math.PI / 12) * 4;
                                return (baseTemp + timeVariation + Math.random() * 2).toFixed(1);
                            }),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: '出风温度',
                            data: Array.from({length: 24}, (_, i) => {
                                const baseTemp = 28;
                                const timeVariation = Math.sin((i - 6) * Math.PI / 12) * 3;
                                return (baseTemp + timeVariation + Math.random() * 2).toFixed(1);
                            }),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: '相对湿度',
                            data: Array.from({length: 24}, () => (45 + Math.random() * 20).toFixed(1)),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: '温度 (°C)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: '湿度 (%RH)' },
                                min: 0,
                                max: 100,
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // 制冷系统性能分析
            const coolingPerformanceCtx = document.getElementById('coolingPerformanceChart');
            if (coolingPerformanceCtx) {
                new Chart(coolingPerformanceCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '主风机转速',
                            data: Array.from({length: 24}, (_, i) => {
                                // 根据温度需求调节风机转速
                                const baseSpeed = 1500;
                                const tempDemand = (i >= 10 && i <= 16) ? 300 : 0;
                                return baseSpeed + tempDemand + Math.random() * 200;
                            }),
                            backgroundColor: 'rgba(59, 130, 246, 0.7)',
                            yAxisID: 'y'
                        }, {
                            label: '制冷功耗',
                            data: Array.from({length: 24}, (_, i) => {
                                const basePower = 3;
                                const tempDemand = (i >= 10 && i <= 16) ? 2 : 0;
                                return (basePower + tempDemand + Math.random() * 1).toFixed(1);
                            }),
                            backgroundColor: 'rgba(245, 158, 11, 0.7)',
                            yAxisID: 'y1',
                            type: 'line',
                            borderColor: '#f59e0b',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: '转速 (RPM)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: '功耗 (kW)' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // 热管理能效统计
            const thermalEfficiencyCtx = document.getElementById('thermalEfficiencyChart');
            if (thermalEfficiencyCtx) {
                new Chart(thermalEfficiencyCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['制冷能耗', '风机能耗', '控制系统能耗', '其他能耗'],
                        datasets: [{
                            data: [65, 20, 10, 5],
                            backgroundColor: [
                                'rgba(59, 130, 246, 0.8)',
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)',
                                'rgba(156, 163, 175, 0.8)'
                            ],
                            borderColor: [
                                '#3b82f6',
                                '#10b981',
                                '#f59e0b',
                                '#9ca3af'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right' },
                            title: { 
                                display: true, 
                                text: '热管理系统能耗分布',
                                font: { size: 16 }
                            }
                        }
                    }
                });
            }
        }
        
        // 更新温度历史图表
        function updateThermalHistoryCharts() {
            // 重新初始化图表
            initThermalHistoryCharts();
        }
        
        // 初始化消防历史数据图表
        function initFireHistoryCharts() {
            const systemCtx = document.getElementById('fireSystemChart');
            if (systemCtx) {
                new Chart(systemCtx.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: ['正常', '预警', '告警'],
                        datasets: [{
                            data: [95, 4, 1],
                            backgroundColor: ['#10b981', '#f59e0b', '#dc2626'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
            
            const gasCtx = document.getElementById('gasDetectionChart');
            if (gasCtx) {
                new Chart(gasCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: 'CO浓度',
                            data: Array.from({length: 24}, () => Math.random() * 10 + 5),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: '烟雾浓度',
                            data: Array.from({length: 24}, () => Math.random() * 8 + 3),
                            borderColor: '#6b7280',
                            backgroundColor: 'rgba(107, 114, 128, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: { y: { beginAtZero: true, title: { display: true, text: '浓度 (ppm)' } } }
                    }
                });
            }
        }
        
        // 初始化整机历史数据图表
        function initOverallHistoryCharts(timeRange = '30d', endDate = null) {
            // 设置默认日期为今天
            if (!endDate) {
                const today = new Date();
                document.getElementById('historyEndDatePicker').value = today.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            }
            
            // 生成每日数据
            const { labels, powerData, socData } = generateHistoryDailyData(timeRange, endDate);
            
            // 功率与SOC综合分析
            const powerSocCtx = document.getElementById('powerSocChart');
            if (powerSocCtx) {
                new Chart(powerSocCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '功率',
                            data: powerData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        }, {
                            label: 'SOC',
                            data: socData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: '功率 (kW)'
                                },
                                grid: {
                                    color: function(context) {
                                        if (context.tick.value === 0) {
                                            return '#666';
                                        }
                                        return 'rgba(0, 0, 0, 0.05)';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'SOC (%)'
                                },
                                min: 0,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 鼠标点击事件
        function onMouseClick(event) {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            // 检测点击的组件
            const intersects = raycaster.intersectObjects(scene.children, true);
            if (intersects.length > 0) {
                let clickedObject = intersects[0].object;
                
                // 向上遍历找到带有component标识的父对象
                while (clickedObject && !clickedObject.userData.component) {
                    clickedObject = clickedObject.parent;
                }
                
                if (clickedObject && clickedObject.userData.component) {
                    selectComponent(clickedObject.userData.component);
                }
            }
        }
        
        // 鼠标移动事件
        function onMouseMove(event) {
            const container = document.getElementById('canvas-container');
            const rect = container.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        }
        
        // 窗口大小调整
        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
            
            // 更新标注位置
            if (window.updateAnnotations) {
                window.updateAnnotations();
            }
        }
        
        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            
            controls.update();
            
            // 旋转冷却风扇
            if (components.cooling) {
                components.cooling.children.forEach(fan => {
                    if (fan.userData.blades) {
                        fan.userData.blades.rotation.z += 0.1;
                    }
                });
            }
            
            renderer.render(scene, camera);
            
            // 更新标注位置
            if (window.updateAnnotations) {
                window.updateAnnotations();
            }
        }
        
        // 更新实时数据值
        function updateRealtimeValues() {
            // 更新核心运行参数
            const power = 100 + Math.random() * 50;
            
            const powerElement = document.getElementById('power');
            const random = Math.random();
            let isCharging = false;
            let isDischarging = false;
            let operationStatus = '';
            let statusIcon = '';
            let statusColor = '';
            
            if (random < 0.4) {
                // 充电状态
                isCharging = true;
                powerElement.textContent = '+' + power.toFixed(1);
                powerElement.style.color = '#10b981';
                operationStatus = '充电中';
                statusIcon = 'fa-bolt';
                statusColor = '#10b981';
            } else if (random < 0.7) {
                // 放电状态
                isDischarging = true;
                powerElement.textContent = '-' + power.toFixed(1);
                powerElement.style.color = '#f59e0b';
                operationStatus = '放电中';
                statusIcon = 'fa-battery-three-quarters';
                statusColor = '#f59e0b';
            } else {
                // 待机状态
                powerElement.textContent = '0.0';
                powerElement.style.color = '#6b7280';
                operationStatus = '待机';
                statusIcon = 'fa-pause-circle';
                statusColor = '#6b7280';
            }
            
            // 更新运行状态显示
            const operationStatusElement = document.getElementById('operationStatusTop');
            operationStatusElement.innerHTML = `<i class="fas ${statusIcon}" style="color: ${statusColor};"></i> ${operationStatus}`;
            
            // 随机更新设备状态（在线/离线/故障）
            const statusRandom = Math.random();
            const statusDot = document.getElementById('statusDotTop');
            const statusText = document.getElementById('statusTextTop');
            
            if (statusRandom < 0.85) {
                // 85% 在线
                statusDot.className = 'status-dot online';
                statusText.textContent = '在线';
            } else if (statusRandom < 0.95) {
                // 10% 离线
                statusDot.className = 'status-dot offline';
                statusText.textContent = '离线';
            } else {
                // 5% 故障
                statusDot.className = 'status-dot fault';
                statusText.textContent = '故障';
            }
            
            
            // SOC缓慢变化
            const currentSOC = parseFloat(document.getElementById('soc').textContent);
            const socChange = isCharging ? 0.3 : (isDischarging ? -0.2 : 0);
            const newSOC = Math.max(0, Math.min(100, currentSOC + socChange));
            document.getElementById('soc').textContent = newSOC.toFixed(1);
            
            // 更新SOC状态文字
            const socStatusElement = document.getElementById('socStatus');
            if (newSOC >= 80) {
                socStatusElement.textContent = '电量充足';
                socStatusElement.className = 'metric-status good';
            } else if (newSOC >= 50) {
                socStatusElement.textContent = '电量适中';
                socStatusElement.className = 'metric-status good';
            } else if (newSOC >= 20) {
                socStatusElement.textContent = '电量偏低';
                socStatusElement.className = 'metric-status warning';
            } else {
                socStatusElement.textContent = '电量不足';
                socStatusElement.className = 'metric-status critical';
            }
            
            // 温度更新（核心运行参数中的温度）
            const temperature = 25 + Math.random() * 8;
            document.getElementById('temperature').textContent = temperature.toFixed(1);
            
            // 更新温度状态文字
            const tempStatusElement = document.getElementById('tempStatus');
            if (temperature <= 35) {
                tempStatusElement.textContent = '温度正常';
                tempStatusElement.className = 'metric-status good';
            } else if (temperature <= 40) {
                tempStatusElement.textContent = '温度偏高';
                tempStatusElement.className = 'metric-status warning';
            } else {
                tempStatusElement.textContent = '温度过高';
                tempStatusElement.className = 'metric-status critical';
            }
            
            // SOH缓慢变化（健康度基本稳定）
            const currentSOH = parseFloat(document.getElementById('soh').textContent);
            const sohChange = (Math.random() - 0.5) * 0.01; // 很小的变化
            const newSOH = Math.max(90, Math.min(100, currentSOH + sohChange));
            document.getElementById('soh').textContent = newSOH.toFixed(1);
            
            // 更新SOH状态文字
            const sohStatusElement = document.getElementById('sohStatus');
            if (newSOH >= 95) {
                sohStatusElement.textContent = '健康状态良好';
                sohStatusElement.className = 'metric-status good';
            } else if (newSOH >= 90) {
                sohStatusElement.textContent = '健康状态正常';
                sohStatusElement.className = 'metric-status good';
            } else if (newSOH >= 80) {
                sohStatusElement.textContent = '轻度老化';
                sohStatusElement.className = 'metric-status warning';
            } else {
                sohStatusElement.textContent = '需要维护';
                sohStatusElement.className = 'metric-status critical';
            }
            
            // 更新功率状态文字
            const powerStatusElement = document.getElementById('powerStatus');
            if (isCharging) {
                powerStatusElement.textContent = '充电中';
                powerStatusElement.className = 'metric-status good';
            } else if (isDischarging) {
                powerStatusElement.textContent = '放电中';
                powerStatusElement.className = 'metric-status warning';
            } else {
                powerStatusElement.textContent = '待机';
                powerStatusElement.className = 'metric-status';
            }
            
            // 更新充电成本和放电收益（基于今日充放电量）
            const todayCharge = parseFloat(document.getElementById('todayCharge').textContent);
            const todayDischarge = parseFloat(document.getElementById('todayDischarge').textContent);
            
            // 假设低谷电价0.8元/kWh，高峰电价1.5元/kWh
            const chargingCost = todayCharge * 0.8;
            const dischargingRevenue = todayDischarge * 1.5;
            
            document.getElementById('chargingCost').textContent = '¥' + chargingCost.toFixed(1);
            document.getElementById('dischargingRevenue').textContent = '¥' + dischargingRevenue.toFixed(1);
            
            // 缓慢更新今日充放电量
            if (isCharging) {
                document.getElementById('todayCharge').textContent = (todayCharge + 0.5).toFixed(1);
            } else if (isDischarging) {
                document.getElementById('todayDischarge').textContent = (todayDischarge + 0.4).toFixed(1);
            }
            
            // 更新电池电流和电压
            let batteryCurrent, batteryVoltage;
            const baseVoltage = 750; // 基础电压
            
            if (isCharging) {
                batteryCurrent = 150 + Math.random() * 50; // 充电时正电流
                batteryVoltage = baseVoltage + Math.random() * 20; // 充电时电压较高
            } else if (isDischarging) {
                batteryCurrent = -(150 + Math.random() * 50); // 放电时负电流
                batteryVoltage = baseVoltage - Math.random() * 20; // 放电时电压较低
            } else {
                batteryCurrent = Math.random() * 5 - 2.5; // 待机时接近0
                batteryVoltage = baseVoltage + Math.random() * 10 - 5; // 待机时电压稳定
            }
            
            document.getElementById('batteryCurrent').textContent = batteryCurrent.toFixed(1);
            document.getElementById('batteryVoltage').textContent = batteryVoltage.toFixed(1);
            
            // 更新电流状态
            const currentStatusElement = document.getElementById('currentStatus');
            const absCurrent = Math.abs(batteryCurrent);
            if (absCurrent < 200) {
                currentStatusElement.textContent = '正常';
                currentStatusElement.className = 'metric-status good';
            } else if (absCurrent < 250) {
                currentStatusElement.textContent = '偏高';
                currentStatusElement.className = 'metric-status warning';
            } else {
                currentStatusElement.textContent = '过载';
                currentStatusElement.className = 'metric-status critical';
            }
            
            // 更新电压状态
            const voltageStatusElement = document.getElementById('voltageStatus');
            if (batteryVoltage >= 720 && batteryVoltage <= 780) {
                voltageStatusElement.textContent = '正常';
                voltageStatusElement.className = 'metric-status good';
            } else if (batteryVoltage >= 700 && batteryVoltage <= 800) {
                voltageStatusElement.textContent = '偏差';
                voltageStatusElement.className = 'metric-status warning';
            } else {
                voltageStatusElement.textContent = '异常';
                voltageStatusElement.className = 'metric-status critical';
            }
        }
        
        // 启动实时数据更新
        let realtimeInterval;
        function startRealtimeUpdates() {
            updateRealtimeValues();
            realtimeInterval = setInterval(updateRealtimeValues, 2000);
        }
        
        function stopRealtimeUpdates() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', function() {
            init3DScene();
            startRealtimeUpdates();
            
            // 初始化显示整机数据
            updateComponentData('overall');
        });
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            stopRealtimeUpdates();
        });
    </script>
</body>
</html>