<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾å¤‡ç®¡ç† - å‚¨èƒ½æŸœç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <style>
        /* è§†å›¾åˆ‡æ¢æŒ‰é’®æ ·å¼ - æµ®åŠ¨å±‚ */
        .view-toggle {
            position: fixed;
            top: 100px;
            right: 30px;
            z-index: 100;
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 6px;
            gap: 4px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        [data-theme="dark"] .view-toggle {
            background: rgba(30, 41, 59, 0.95);
        }
        
        .view-toggle button {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-toggle button:hover {
            color: var(--text-primary);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .view-toggle button.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        /* 3Dåœºæ™¯å®¹å™¨ */
        #scene-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 160px);
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            border-radius: 12px;
            overflow: hidden;
            display: none;
        }
        
        /* 3Dè§†å›¾ä¿¡æ¯é¢æ¿ */
        .info-panel-3d {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        
        [data-theme="dark"] .info-panel-3d {
            background: rgba(30, 41, 59, 0.95);
        }
        
        /* æ’åºå’ŒæŠ½å±‰æ ·å¼ */
        th[data-sort]:hover {
            background-color: rgba(59, 130, 246, 0.05);
            color: var(--primary-color);
        }
        
        .sort-icon {
            transition: all 0.2s ease;
        }
        
        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„æŠ½å±‰æ ·å¼ */
        [data-theme="dark"] #addDeviceDrawer > div:last-child {
            background: #1e293b;
        }
        
        [data-theme="dark"] #addDeviceDrawer input {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] #addDeviceDrawer .btn {
            background: #334155;
            border-color: #475569;
        }
        
        [data-theme="dark"] #addDeviceDrawer .btn:hover {
            background: #475569;
        }
        
        /* æ·±è‰²ä¸»é¢˜ä¸‹çš„åˆ é™¤ç¡®è®¤å¼¹çª— */
        [data-theme="dark"] #deleteConfirmModal > div {
            background: #1e293b;
        }
        
        [data-theme="dark"] #deleteConfirmModal h3,
        [data-theme="dark"] #deleteConfirmModal p {
            color: #e2e8f0;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="header-left">
            <button class="menu-trigger" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">
                <img src="logo.png" alt="AlwaysControl Technology" />
            </div>
        </div>
        
        <div class="header-right">
            <button class="theme-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-moon" id="headerThemeIcon"></i>
            </button>
            <button class="lang-btn" onclick="toggleLanguage()" title="åˆ‡æ¢è¯­è¨€">
                <i class="fas fa-globe"></i>
            </button>
            <a href="alarm-management.html" class="notification-badge" style="text-decoration: none;">
                <i class="fas fa-bell" style="font-size: 20px; color: var(--text-secondary);"></i>
            </a>
            <div class="user-menu" onclick="logout()">
                <div class="avatar">A</div>
                <span class="user-name" id="userName">ç®¡ç†å‘˜</span>
            </div>
        </div>
    </header>

    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar" id="sidebar">
        <div class="menu">
            <a href="dashboard.html" class="menu-item" data-menu="dashboard">
                <span style="font-size: 18px; margin-right: 12px;">ğŸ“Š</span>
                <span id="menuDashboard">ä»ªè¡¨ç›˜</span>
            </a>
            <a href="site1.html" class="menu-item" data-menu="site1">
                <span style="font-size: 18px; margin-right: 12px;">ğŸ¢</span>
                <span>ç«™ç‚¹ç®¡ç†</span>
            </a>
            <a href="devices.html" class="menu-item active" data-menu="devices">
                <span style="font-size: 18px; margin-right: 12px;">âš™ï¸</span>
                <span id="menuDevices">è®¾å¤‡ç®¡ç†</span>
            </a>
            <a href="alarm-management.html" class="menu-item" data-menu="alarm-management">
                <span style="font-size: 18px; margin-right: 12px;">ğŸ””</span>
                <span id="menuAlarms">å‘Šè­¦ç®¡ç†</span>
            </a>
            <a href="rule-engine.html" class="menu-item" data-menu="rule-engine" style="display: none;">
                <i class="fas fa-code-branch"></i>
                <span>è§„åˆ™å¼•æ“</span>
            </a>
            <div class="menu-item-group">
                <a href="javascript:void(0)" class="menu-item" data-menu="system-management" onclick="toggleSubmenu(this)">
                    <span style="font-size: 18px; margin-right: 12px;">ğŸ”§</span>
                    <span id="menuSystem">ç³»ç»Ÿç®¡ç†</span>
                    <i class="fas fa-chevron-down" style="margin-left: auto; font-size: 12px;"></i>
                </a>
                <div class="submenu" style="display: none;">
                    <a href="system-management.html?module=roles" class="menu-item submenu-item">
                        <span style="font-size: 16px; margin-right: 10px;">ğŸ‘¥</span>
                        <span>è§’è‰²ç®¡ç†</span>
                    </a>
                    <a href="system-management.html?module=personnel" class="menu-item submenu-item">
                        <span style="font-size: 16px; margin-right: 10px;">ğŸ‘¤</span>
                        <span>äººå‘˜ç®¡ç†</span>
                    </a>
                    <a href="system-management.html?module=logs" class="menu-item submenu-item">
                        <span style="font-size: 16px; margin-right: 10px;">ğŸ“„</span>
                        <span>æ—¥å¿—ç®¡ç†</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="main-content" id="mainContent">
        <!-- è§†å›¾åˆ‡æ¢æŒ‰é’® -->
        <div class="view-toggle">
            <button class="active" onclick="switchView('table')">
                <i class="fas fa-table"></i>
                è¡¨æ ¼è§†å›¾
            </button>
            <button onclick="switchView('3d')">
                <i class="fas fa-cube"></i>
                3Dè§†å›¾
            </button>
        </div>
        
        <!-- è¡¨æ ¼è§†å›¾ -->
        <div id="table-container">
            <!-- æŸ¥è¯¢åŒºåŸŸ -->
            <div class="card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; flex: 1;">
                        <div class="input-wrapper">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" id="searchInput" class="form-input" placeholder="æœç´¢è®¾å¤‡..." style="width: 250px; height: 40px; padding-left: 40px;">
                        </div>
                        <select id="statusFilter" class="form-input" style="width: 120px; height: 40px; padding-left: 12px;">
                            <option value="">å…¨éƒ¨çŠ¶æ€</option>
                            <option value="online">åœ¨çº¿</option>
                            <option value="offline">ç¦»çº¿</option>
                            <option value="fault">æ•…éšœ</option>
                        </select>
                        <select id="modeFilter" class="form-input" style="width: 150px; height: 40px; padding-left: 12px;">
                            <option value="">å…¨éƒ¨æ¨¡å¼</option>
                            <option value="manual-charge">æ‰‹åŠ¨å……ç”µ</option>
                            <option value="manual-discharge">æ‰‹åŠ¨æ”¾ç”µ</option>
                            <option value="standby">å¾…æœºä¸­</option>
                            <option value="auto-charge">è‡ªåŠ¨å……ç”µ</option>
                            <option value="auto-discharge">è‡ªåŠ¨æ”¾ç”µ</option>
                            <option value="waiting">ç­‰å¾…æ‰§è¡Œ</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" onclick="searchDevices()" style="height: 40px; padding: 0 16px;">
                            <i class="fas fa-search"></i> æŸ¥è¯¢
                        </button>
                        <button class="btn" onclick="resetSearch()" style="height: 40px; padding: 0 16px;">
                            <i class="fas fa-redo"></i> é‡ç½®
                        </button>
                    </div>
                </div>
            </div>

            <!-- è®¾å¤‡è¡¨æ ¼ -->
            <div class="card">
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="showAddDeviceModal()" style="height: 40px; padding: 0 16px; width: auto; display: inline-block;">
                        <i class="fas fa-plus"></i>
                        æ·»åŠ è®¾å¤‡
                    </button>
                </div>
                <div style="overflow-x: auto;">
                    <table id="deviceTable" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-color);">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">è®¾å¤‡ç¼–ç </th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary);">åç§°</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer;" onclick="sortTable('soc')" data-sort="soc">
                                    SOC <i class="fas fa-sort sort-icon" style="font-size: 12px; margin-left: 4px;"></i>
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer;" onclick="sortTable('soh')" data-sort="soh">
                                    SOH <i class="fas fa-sort sort-icon" style="font-size: 12px; margin-left: 4px;"></i>
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer;" onclick="sortTable('power')" data-sort="power">
                                    åŠŸç‡ <i class="fas fa-sort sort-icon" style="font-size: 12px; margin-left: 4px;"></i>
                                </th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">çŠ¶æ€</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">æ¨¡å¼</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary);">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="deviceTableBody">
                            <!-- è®¾å¤‡æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </tbody>
                    </table>
                </div>
                
                <!-- åˆ†é¡µ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 0 12px;">
                    <div style="color: var(--text-secondary); font-size: 14px;">
                        å…± <span id="totalCount">0</span> æ¡è®°å½•
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" onclick="previousPage()" style="padding: 6px 12px;">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span style="padding: 6px 12px; color: var(--text-secondary);">
                            ç¬¬ <span id="currentPage">1</span> / <span id="totalPages">1</span> é¡µ
                        </span>
                        <button class="btn" onclick="nextPage()" style="padding: 6px 12px;">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3Dè§†å›¾ -->
        <div id="scene-container">
            <div id="threejs-container" style="width: 100%; height: 100%;"></div>
            
            <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
            <div class="info-panel-3d">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color);">
                    <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                        <span style="width: 3px; height: 16px; background: #3b82f6; border-radius: 2px;"></span>
                        å‚¨èƒ½æŸœå®æ—¶ç›‘æ§
                    </h4>
                    <button onclick="toggleInfoPanel()" style="background: none; border: none; cursor: pointer; padding: 4px; color: var(--text-secondary);">
                        <i id="infoPanelToggleIcon" class="fas fa-chevron-up" style="font-size: 14px;"></i>
                    </button>
                </div>
                
                <div id="infoPanelContent" style="padding: 15px; max-height: calc(100vh - 200px); overflow-y: auto;">
                    <!-- çŠ¶æ€æ¦‚è§ˆ -->
                    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">æ€»ä½“çŠ¶æ€</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%;"></div>
                            <span style="font-size: 15px; font-weight: 600; color: var(--text-primary);">è¿è¡Œæ­£å¸¸</span>
                        </div>
                    </div>
                    
                    <!-- è®¾å¤‡ç»Ÿè®¡ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px;">
                            <div style="font-size: 12px; color: var(--text-secondary);">åœ¨çº¿è®¾å¤‡</div>
                            <div style="font-size: 20px; font-weight: 600; color: #10b981; margin-top: 4px;">6</div>
                        </div>
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px;">
                            <div style="font-size: 12px; color: var(--text-secondary);">ç¦»çº¿è®¾å¤‡</div>
                            <div style="font-size: 20px; font-weight: 600; color: #6b7280; margin-top: 4px;">1</div>
                        </div>
                    </div>
                    
                    <!-- é€‰ä¸­è®¾å¤‡ä¿¡æ¯ -->
                    <div id="selectedDeviceInfo" style="display: none;">
                        <h5 style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">è®¾å¤‡è¯¦æƒ…</h5>
                        <div style="background: var(--bg-secondary); border-radius: 8px; padding: 12px;">
                            <div id="deviceDetails">
                                <!-- åŠ¨æ€å¡«å……è®¾å¤‡ä¿¡æ¯ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ç§»åŠ¨ç«¯é®ç½© -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <!-- æ·»åŠ /ç¼–è¾‘è®¾å¤‡æŠ½å±‰ -->
    <div id="addDeviceDrawer" style="display: none;">
        <!-- é®ç½©å±‚ -->
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeAddDeviceDrawer()"></div>
        <!-- æŠ½å±‰å†…å®¹ -->
        <div style="position: fixed; top: 0; right: -400px; bottom: 0; width: 400px; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1000; transition: right 0.3s ease;">
            <div style="padding: 24px; height: 100%; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 id="drawerTitle" style="margin: 0; font-size: 18px;">æ·»åŠ è®¾å¤‡</h3>
                    <button onclick="closeAddDeviceDrawer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                </div>
                <form id="addDeviceForm" style="flex: 1;">
                    <input type="hidden" name="deviceId" id="deviceId">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">è®¾å¤‡ç¼–ç  <span style="color: #ef4444;">*</span></label>
                        <input type="text" name="code" class="form-input" required style="width: 100%; height: 40px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">è®¾å¤‡åç§° <span style="color: #ef4444;">*</span></label>
                        <input type="text" name="name" class="form-input" required style="width: 100%; height: 40px;">
                    </div>
                    <div style="position: absolute; bottom: 24px; left: 24px; right: 24px; display: flex; gap: 12px;">
                        <button type="button" class="btn" onclick="closeAddDeviceDrawer()" style="flex: 1; height: 40px;">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1; height: 40px;">ç¡®å®š</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div id="deleteConfirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 60px; height: 60px; background: #fee2e2; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #ef4444;"></i>
                </div>
                <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--text-primary);">ç¡®è®¤åˆ é™¤</h3>
                <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">æ‚¨ç¡®å®šè¦åˆ é™¤è®¾å¤‡ <span id="deleteDeviceName" style="font-weight: 600;"></span> å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="closeDeleteConfirm()" style="flex: 1; height: 40px;">å–æ¶ˆ</button>
                <button class="btn" onclick="confirmDelete()" style="flex: 1; height: 40px; background: #ef4444; color: white;">åˆ é™¤</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        checkAuth();
        
        // è®¾ç½®å½“å‰é¡µé¢èœå•é¡¹
        setActiveMenuItem('devices');

        // å½“å‰è§†å›¾æ¨¡å¼
        let currentView = 'table';
        
        // 3Dåœºæ™¯ç›¸å…³å˜é‡
        let scene, camera, renderer, controls;
        let cabinets = [];
        let raycaster, mouse;
        let selectedCabinet = null;

        // æ¨¡æ‹Ÿè®¾å¤‡æ•°æ®
        let devices = [
            { id: 1, code: 'ESS001', name: 'å‚¨èƒ½æŸœ-AåŒº-01', soc: 85, soh: 98, power: 125.5, status: 'online', mode: 'auto-charge' },
            { id: 2, code: 'ESS002', name: 'å‚¨èƒ½æŸœ-AåŒº-02', soc: 92, soh: 97, power: -89.3, status: 'online', mode: 'auto-discharge' },
            { id: 3, code: 'ESS003', name: 'å‚¨èƒ½æŸœ-BåŒº-01', soc: 45, soh: 95, power: 0, status: 'online', mode: 'standby' },
            { id: 4, code: 'ESS004', name: 'å‚¨èƒ½æŸœ-BåŒº-02', soc: 78, soh: 96, power: 156.8, status: 'offline', mode: 'standby' },
            { id: 5, code: 'ESS005', name: 'å‚¨èƒ½æŸœ-CåŒº-01', soc: 25, soh: 94, power: 0, status: 'fault', mode: 'standby' },
            { id: 6, code: 'ESS006', name: 'å‚¨èƒ½æŸœ-CåŒº-02', soc: 67, soh: 99, power: 98.7, status: 'online', mode: 'manual-charge' },
            { id: 7, code: 'ESS007', name: 'å‚¨èƒ½æŸœ-DåŒº-01', soc: 88, soh: 93, power: -112.4, status: 'online', mode: 'manual-discharge' },
            { id: 8, code: 'ESS008', name: 'å‚¨èƒ½æŸœ-DåŒº-02', soc: 55, soh: 92, power: 0, status: 'online', mode: 'waiting' }
        ];

        let currentPage = 1;
        let pageSize = 10;
        let sortField = '';
        let sortOrder = 'asc';
        let filteredDevices = [...devices];

        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            currentView = view;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('button').classList.add('active');
            
            if (view === 'table') {
                document.getElementById('table-container').style.display = 'block';
                document.getElementById('scene-container').style.display = 'none';
            } else {
                document.getElementById('table-container').style.display = 'none';
                document.getElementById('scene-container').style.display = 'block';
                
                // åˆå§‹åŒ–3Dåœºæ™¯ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
                if (!scene) {
                    init3DScene();
                }
            }
        }

        // åˆå§‹åŒ–3Dåœºæ™¯
        function init3DScene() {
            const container = document.getElementById('threejs-container');
            
            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);
            scene.fog = new THREE.Fog(0x0a0a0a, 10, 100);
            
            // åˆ›å»ºç›¸æœº
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(15, 10, 15);
            
            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);
            
            // åˆ›å»ºæ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 50;
            
            // æ·»åŠ ç¯å…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.camera.near = 0.1;
            directionalLight.shadow.camera.far = 50;
            scene.add(directionalLight);
            
            // åˆ›å»ºåœ°é¢
            const groundGeometry = new THREE.PlaneGeometry(40, 40);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1a1a1a,
                roughness: 0.8,
                metalness: 0.2
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // æ·»åŠ ç½‘æ ¼
            const gridHelper = new THREE.GridHelper(40, 20, 0x333333, 0x222222);
            scene.add(gridHelper);
            
            // åˆ›å»ºå‚¨èƒ½æŸœ
            createCabinets();
            
            // åˆå§‹åŒ–å°„çº¿æ£€æµ‹
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            
            // æ·»åŠ é¼ æ ‡äº‹ä»¶
            renderer.domElement.addEventListener('click', onMouseClick);
            renderer.domElement.addEventListener('mousemove', onMouseMove);
            
            // çª—å£è°ƒæ•´
            window.addEventListener('resize', onWindowResize);
            
            // å¼€å§‹åŠ¨ç”»å¾ªç¯
            animate();
        }

        // åˆ›å»ºå‚¨èƒ½æŸœ
        function createCabinets() {
            const positions = [
                { x: -9, z: -9 }, { x: -3, z: -9 }, { x: 3, z: -9 }, { x: 9, z: -9 },
                { x: -9, z: -3 }, { x: -3, z: -3 }, { x: 3, z: -3 }, { x: 9, z: -3 }
            ];
            
            devices.forEach((device, index) => {
                if (index < positions.length) {
                    const cabinet = createCabinet(device, positions[index]);
                    cabinets.push(cabinet);
                    scene.add(cabinet.group);
                }
            });
        }

        // åˆ›å»ºå•ä¸ªå‚¨èƒ½æŸœ
        function createCabinet(device, position) {
            const group = new THREE.Group();
            
            // å‚¨èƒ½æŸœä¸»ä½“
            const geometry = new THREE.BoxGeometry(2, 3, 1.5);
            const material = new THREE.MeshStandardMaterial({
                color: device.status === 'online' ? 0x2563eb : 
                       device.status === 'offline' ? 0x6b7280 : 0xef4444,
                roughness: 0.5,
                metalness: 0.8
            });
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.position.y = 1.5;
            group.add(mesh);
            
            // çŠ¶æ€æŒ‡ç¤ºç¯
            const lightGeometry = new THREE.SphereGeometry(0.1, 16, 16);
            const lightMaterial = new THREE.MeshBasicMaterial({
                color: device.status === 'online' ? 0x10b981 : 
                       device.status === 'offline' ? 0x6b7280 : 0xef4444,
                emissive: device.status === 'online' ? 0x10b981 : 0x000000,
                emissiveIntensity: 0.5
            });
            const light = new THREE.Mesh(lightGeometry, lightMaterial);
            light.position.set(0, 2.8, 0.76);
            group.add(light);
            
            // è®¾ç½®ä½ç½®
            group.position.set(position.x, 0, position.z);
            
            return {
                group: group,
                mesh: mesh,
                light: light,
                device: device,
                material: material
            };
        }

        // é¼ æ ‡ç‚¹å‡»äº‹ä»¶
        function onMouseClick(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            
            const intersects = raycaster.intersectObjects(scene.children, true);
            
            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                
                // æŸ¥æ‰¾ç‚¹å‡»çš„å‚¨èƒ½æŸœ
                const cabinet = cabinets.find(c => c.mesh === clickedObject || c.group === clickedObject.parent);
                
                if (cabinet) {
                    selectCabinet(cabinet);
                }
            }
        }

        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        function onMouseMove(event) {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
        }

        // é€‰æ‹©å‚¨èƒ½æŸœ
        function selectCabinet(cabinet) {
            // é‡ç½®ä¹‹å‰é€‰ä¸­çš„å‚¨èƒ½æŸœ
            if (selectedCabinet) {
                selectedCabinet.material.emissive = new THREE.Color(0x000000);
            }
            
            selectedCabinet = cabinet;
            cabinet.material.emissive = new THREE.Color(0x3b82f6);
            cabinet.material.emissiveIntensity = 0.3;
            
            // æ›´æ–°å³ä¾§ä¿¡æ¯é¢æ¿
            updateDeviceInfo(cabinet.device);
        }

        // æ›´æ–°è®¾å¤‡ä¿¡æ¯é¢æ¿
        function updateDeviceInfo(device) {
            const infoDiv = document.getElementById('selectedDeviceInfo');
            const detailsDiv = document.getElementById('deviceDetails');
            
            infoDiv.style.display = 'block';
            
            detailsDiv.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: var(--text-secondary);">è®¾å¤‡ç¼–ç </span>
                        <span style="font-size: 13px; font-weight: 600;">${device.code}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: var(--text-secondary);">è®¾å¤‡åç§°</span>
                        <span style="font-size: 13px; font-weight: 600;">${device.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: var(--text-secondary);">SOC</span>
                        <span style="font-size: 13px; font-weight: 600;">${device.soc}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: var(--text-secondary);">SOH</span>
                        <span style="font-size: 13px; font-weight: 600;">${device.soh}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: var(--text-secondary);">åŠŸç‡</span>
                        <span style="font-size: 13px; font-weight: 600;">${device.power > 0 ? '+' : ''}${device.power} kW</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: var(--text-secondary);">çŠ¶æ€</span>
                        ${getStatusBadge(device.status)}
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-size: 13px; color: var(--text-secondary);">æ¨¡å¼</span>
                        <span style="font-size: 13px;">${getModeBadge(device.mode)}</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="viewDetails(${device.id})" style="width: 100%; margin-top: 12px; height: 36px; font-size: 13px;">
                    <i class="fas fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                </button>
            `;
        }

        // çª—å£è°ƒæ•´
        function onWindowResize() {
            if (camera && renderer) {
                const container = document.getElementById('threejs-container');
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        }

        // åŠ¨ç”»å¾ªç¯
        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) {
                controls.update();
            }
            
            // æ—‹è½¬çŠ¶æ€æŒ‡ç¤ºç¯
            cabinets.forEach(cabinet => {
                if (cabinet.device.status === 'online') {
                    cabinet.light.material.emissiveIntensity = 0.5 + Math.sin(Date.now() * 0.003) * 0.3;
                }
            });
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // åˆ‡æ¢ä¿¡æ¯é¢æ¿
        function toggleInfoPanel() {
            const content = document.getElementById('infoPanelContent');
            const icon = document.getElementById('infoPanelToggleIcon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('deviceTableBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageDevices = filteredDevices.slice(start, end);

            pageDevices.forEach(device => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';
                
                tr.innerHTML = `
                    <td style="padding: 12px;">${device.code}</td>
                    <td style="padding: 12px;">${device.name}</td>
                    <td style="padding: 12px; text-align: center;">${device.soc}%</td>
                    <td style="padding: 12px; text-align: center;">${device.soh}%</td>
                    <td style="padding: 12px; text-align: center;">${device.power > 0 ? '+' : ''}${device.power} kW</td>
                    <td style="padding: 12px; text-align: center;">
                        ${getStatusBadge(device.status)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${getModeBadge(device.mode)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn" onclick="viewDetails(${device.id})" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                        </button>
                        <button class="btn" onclick="editDevice(${device.id})" style="padding: 4px 8px; font-size: 12px; margin-right: 4px;">
                            <i class="fas fa-edit"></i> ç¼–è¾‘
                        </button>
                        <button class="btn" onclick="deleteDevice(${device.id})" style="padding: 4px 8px; font-size: 12px; background: #ef4444; color: white;">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            document.getElementById('totalCount').textContent = filteredDevices.length;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = Math.ceil(filteredDevices.length / pageSize);
        }

        // è·å–çŠ¶æ€å¾½ç« 
        function getStatusBadge(status) {
            const statusMap = {
                'online': { text: 'åœ¨çº¿', color: '#10b981' },
                'offline': { text: 'ç¦»çº¿', color: '#6b7280' },
                'fault': { text: 'æ•…éšœ', color: '#ef4444' }
            };
            const statusInfo = statusMap[status];
            return `
                <span style="display: inline-flex; align-items: center; gap: 6px; font-size: 13px;">
                    <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${statusInfo.color};"></span>
                    <span style="color: var(--text-secondary);">${statusInfo.text}</span>
                </span>
            `;
        }

        // è·å–æ¨¡å¼å¾½ç« 
        function getModeBadge(mode) {
            const modeMap = {
                'manual-charge': { text: 'æ‰‹åŠ¨å……ç”µ', color: '#3b82f6' },
                'manual-discharge': { text: 'æ‰‹åŠ¨æ”¾ç”µ', color: '#f59e0b' },
                'standby': { text: 'å¾…æœºä¸­', color: '#6b7280' },
                'auto-charge': { text: 'è‡ªåŠ¨å……ç”µ', color: '#10b981' },
                'auto-discharge': { text: 'è‡ªåŠ¨æ”¾ç”µ', color: '#8b5cf6' },
                'waiting': { text: 'ç­‰å¾…æ‰§è¡Œ', color: '#ec4899' }
            };
            const modeInfo = modeMap[mode];
            return `<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; background: ${modeInfo.color}20; color: ${modeInfo.color};">${modeInfo.text}</span>`;
        }

        // æ’åºè¡¨æ ¼
        function sortTable(field) {
            if (sortField === field) {
                // åŒä¸€åˆ—ç‚¹å‡»ï¼Œå¾ªç¯åˆ‡æ¢ï¼šå‡åº -> é™åº -> æ— æ’åº
                if (sortOrder === 'asc') {
                    sortOrder = 'desc';
                } else if (sortOrder === 'desc') {
                    sortOrder = '';
                    sortField = '';
                } else {
                    sortOrder = 'asc';
                }
            } else {
                // ä¸åŒåˆ—ç‚¹å‡»ï¼Œé‡ç½®ä¸ºå‡åº
                sortField = field;
                sortOrder = 'asc';
            }

            // æ›´æ–°æ’åºå›¾æ ‡
            updateSortIcons();

            // é‡æ–°åº”ç”¨æœç´¢æ¡ä»¶
            searchDevices();
        }

        // æ›´æ–°æ’åºå›¾æ ‡
        function updateSortIcons() {
            // é‡ç½®æ‰€æœ‰æ’åºå›¾æ ‡
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'fas fa-sort sort-icon';
                icon.style.color = '';
            });

            // æ›´æ–°å½“å‰æ’åºåˆ—çš„å›¾æ ‡
            if (sortField) {
                const th = document.querySelector(`[data-sort="${sortField}"]`);
                if (th) {
                    const icon = th.querySelector('.sort-icon');
                    if (icon) {
                        if (sortOrder === 'asc') {
                            icon.className = 'fas fa-sort-up sort-icon';
                            icon.style.color = '#3b82f6';
                        } else {
                            icon.className = 'fas fa-sort-down sort-icon';
                            icon.style.color = '#3b82f6';
                        }
                    }
                }
            }
        }

        // æœç´¢è®¾å¤‡
        function searchDevices() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const modeFilter = document.getElementById('modeFilter').value;

            filteredDevices = devices.filter(device => {
                const matchSearch = !searchText || 
                    device.code.toLowerCase().includes(searchText) || 
                    device.name.toLowerCase().includes(searchText);
                const matchStatus = !statusFilter || device.status === statusFilter;
                const matchMode = !modeFilter || device.mode === modeFilter;
                
                return matchSearch && matchStatus && matchMode;
            });

            // åº”ç”¨æ’åº
            if (sortField && sortOrder) {
                filteredDevices.sort((a, b) => {
                    let aVal = a[sortField];
                    let bVal = b[sortField];
                    
                    if (sortOrder === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            }

            currentPage = 1;
            renderTable();
        }

        // é‡ç½®æœç´¢
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('modeFilter').value = '';
            filteredDevices = [...devices];
            currentPage = 1;
            renderTable();
        }

        // åˆ†é¡µåŠŸèƒ½
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredDevices.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        // æŸ¥çœ‹è¯¦æƒ…
        function viewDetails(id) {
            // è·³è½¬åˆ°å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢
            window.location.href = `cabinet-detail.html?cabinetId=${id}`;
        }

        // ç¼–è¾‘è®¾å¤‡
        function editDevice(id) {
            const device = devices.find(d => d.id === id);
            if (device) {
                // è®¾ç½®ä¸ºç¼–è¾‘æ¨¡å¼
                document.getElementById('drawerTitle').textContent = 'ç¼–è¾‘è®¾å¤‡';
                document.getElementById('deviceId').value = id;
                document.querySelector('input[name="code"]').value = device.code;
                document.querySelector('input[name="name"]').value = device.name;
                
                // æ˜¾ç¤ºæŠ½å±‰
                const drawer = document.getElementById('addDeviceDrawer');
                const drawerContent = drawer.querySelector('div:last-child');
                drawer.style.display = 'block';
                setTimeout(() => {
                    drawerContent.style.right = '0';
                }, 10);
            }
        }

        // åˆ é™¤è®¾å¤‡
        let deleteDeviceId = null;
        function deleteDevice(id) {
            const device = devices.find(d => d.id === id);
            if (device) {
                deleteDeviceId = id;
                document.getElementById('deleteDeviceName').textContent = device.name;
                document.getElementById('deleteConfirmModal').style.display = 'flex';
            }
        }

        // ç¡®è®¤åˆ é™¤
        function confirmDelete() {
            if (deleteDeviceId) {
                devices = devices.filter(d => d.id !== deleteDeviceId);
                searchDevices();
                closeDeleteConfirm();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast('è®¾å¤‡åˆ é™¤æˆåŠŸï¼', '#ef4444');
            }
        }

        // å…³é—­åˆ é™¤ç¡®è®¤
        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            deleteDeviceId = null;
        }

        // æ˜¾ç¤ºæ·»åŠ è®¾å¤‡æŠ½å±‰
        function showAddDeviceModal() {
            // è®¾ç½®ä¸ºæ·»åŠ æ¨¡å¼
            document.getElementById('drawerTitle').textContent = 'æ·»åŠ è®¾å¤‡';
            document.getElementById('deviceId').value = '';
            document.getElementById('addDeviceForm').reset();
            
            const drawer = document.getElementById('addDeviceDrawer');
            const drawerContent = drawer.querySelector('div:last-child');
            drawer.style.display = 'block';
            // è§¦å‘é‡æ’ä»¥ç¡®ä¿åŠ¨ç”»ç”Ÿæ•ˆ
            setTimeout(() => {
                drawerContent.style.right = '0';
            }, 10);
        }

        // å…³é—­æ·»åŠ è®¾å¤‡æŠ½å±‰
        function closeAddDeviceDrawer() {
            const drawer = document.getElementById('addDeviceDrawer');
            const drawerContent = drawer.querySelector('div:last-child');
            drawerContent.style.right = '-400px';
            setTimeout(() => {
                drawer.style.display = 'none';
                document.getElementById('addDeviceForm').reset();
            }, 300);
        }

        // å¤„ç†æ·»åŠ /ç¼–è¾‘è®¾å¤‡è¡¨å•æäº¤
        document.getElementById('addDeviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const deviceId = formData.get('deviceId');
            const code = formData.get('code');
            const name = formData.get('name');
            
            if (deviceId) {
                // ç¼–è¾‘æ¨¡å¼
                const device = devices.find(d => d.id === parseInt(deviceId));
                if (device) {
                    device.code = code;
                    device.name = name;
                }
                searchDevices();
                closeAddDeviceDrawer();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast('è®¾å¤‡ç¼–è¾‘æˆåŠŸï¼', '#10b981');
            } else {
                // æ·»åŠ æ¨¡å¼
                const newDevice = {
                    id: devices.length + 1,
                    code: code,
                    name: name,
                    soc: Math.floor(Math.random() * 50 + 50), // éšæœºç”Ÿæˆ50-100ä¹‹é—´çš„å€¼
                    soh: Math.floor(Math.random() * 10 + 90), // éšæœºç”Ÿæˆ90-100ä¹‹é—´çš„å€¼
                    power: 0, // é»˜è®¤åŠŸç‡ä¸º0
                    status: 'online',
                    mode: 'standby'
                };
                
                devices.push(newDevice);
                searchDevices();
                closeAddDeviceDrawer();
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast('è®¾å¤‡æ·»åŠ æˆåŠŸï¼', '#10b981');
            }
        });

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, color = '#10b981') {
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${color}; color: white; padding: 12px 24px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 2000;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // åˆå§‹åŒ–
        renderTable();
    </script>
</body>
</html>