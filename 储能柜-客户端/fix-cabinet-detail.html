<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢ - è¯Šæ–­ä¸ä¿®å¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f8fafc;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 28px;
            color: #1e293b;
            margin-bottom: 12px;
        }

        h2 {
            font-size: 20px;
            color: #1e293b;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .subtitle {
            font-size: 16px;
            color: #64748b;
            margin-bottom: 32px;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .status.warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border-left: 4px solid #10b981;
        }

        button {
            padding: 12px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            margin-right: 12px;
            margin-bottom: 12px;
        }

        button:hover {
            background: #2563eb;
        }

        button.secondary {
            background: #64748b;
        }

        button.secondary:hover {
            background: #475569;
        }

        button.danger {
            background: #ef4444;
        }

        button.danger:hover {
            background: #dc2626;
        }

        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
            margin-top: 12px;
        }

        .code-inline {
            background: #f1f5f9;
            color: #dc2626;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }

        .step {
            margin-bottom: 24px;
            padding-left: 28px;
            position: relative;
        }

        .step::before {
            content: 'â—';
            position: absolute;
            left: 0;
            color: #3b82f6;
            font-size: 20px;
        }

        .step-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .step-desc {
            color: #64748b;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸ”§ å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢ - è¯Šæ–­ä¸ä¿®å¤å·¥å…·</h1>
            <p class="subtitle">è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤"ç‚¹å‡»tabæ•°æ®æ¶ˆå¤±"çš„é—®é¢˜</p>

            <div id="diagnosisResult"></div>
        </div>

        <div class="card">
            <h2>ğŸ“‹ è¯Šæ–­ç»“æœ</h2>
            <div id="diagnosticInfo"></div>
        </div>

        <div class="card">
            <h2>ğŸ› ï¸ ä¿®å¤é€‰é¡¹</h2>

            <div class="step">
                <div class="step-title">æ–¹æ¡ˆ 1ï¼šæ¸…é™¤å­—æ®µè®¾ç½®ï¼ˆæ¨èï¼‰</div>
                <div class="step-desc">
                    æ¸…é™¤ localStorage ä¸­çš„å­—æ®µè®¾ç½®ï¼Œæ¢å¤æ‰€æœ‰å­—æ®µåˆ°é»˜è®¤å¯è§çŠ¶æ€ã€‚
                    è¿™ä¸ä¼šå½±å“å…¶ä»–è®¾ç½®ï¼ˆå¦‚ä¸ªæ€§åŒ–è®¾ç½®ï¼‰ã€‚
                </div>
                <button onclick="fixOption1()">æ¸…é™¤å­—æ®µè®¾ç½®</button>
            </div>

            <div class="step">
                <div class="step-title">æ–¹æ¡ˆ 2ï¼šé‡ç½®ä¸ºé»˜è®¤å­—æ®µæ˜¾ç¤º</div>
                <div class="step-desc">
                    é‡æ–°åˆå§‹åŒ–å­—æ®µè®¾ç½®ï¼Œç¡®ä¿æ‰€æœ‰é‡è¦å­—æ®µéƒ½å¤„äºå¯è§çŠ¶æ€ã€‚
                </div>
                <button onclick="fixOption2()">é‡ç½®å­—æ®µè®¾ç½®</button>
            </div>

            <div class="step">
                <div class="step-title">æ–¹æ¡ˆ 3ï¼šæŸ¥çœ‹å®Œæ•´ localStorage æ•°æ®</div>
                <div class="step-desc">
                    æ˜¾ç¤ºå½“å‰ localStorage ä¸­çš„æ‰€æœ‰å‚¨èƒ½æŸœç›¸å…³æ•°æ®ï¼Œç”¨äºé«˜çº§è°ƒè¯•ã€‚
                </div>
                <button class="secondary" onclick="showFullData()">æŸ¥çœ‹å®Œæ•´æ•°æ®</button>
            </div>

            <div class="step">
                <div class="step-title">æ–¹æ¡ˆ 4ï¼šå®Œå…¨æ¸…ç©º localStorageï¼ˆæ…ç”¨ï¼‰</div>
                <div class="step-desc">
                    âš ï¸ <strong>è­¦å‘Šï¼š</strong>è¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°è®¾ç½®ï¼ŒåŒ…æ‹¬ä¸ªæ€§åŒ–è®¾ç½®ã€å­—æ®µè®¾ç½®ç­‰ã€‚
                </div>
                <button class="danger" onclick="clearAll()">å®Œå…¨æ¸…ç©º</button>
            </div>

            <div id="fullDataDisplay"></div>
        </div>

        <div class="card">
            <h2>ğŸ¯ æ“ä½œå®Œæˆå</h2>
            <p style="margin-bottom: 16px; color: #64748b;">æ‰§è¡Œä¿®å¤åï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>

            <div class="step">
                <div class="step-title">æ­¥éª¤ 1ï¼šå…³é—­æ­¤é¡µé¢</div>
                <div class="step-desc">è¯Šæ–­å’Œä¿®å¤å·²å®Œæˆ</div>
            </div>

            <div class="step">
                <div class="step-title">æ­¥éª¤ 2ï¼šåˆ·æ–°å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢</div>
                <div class="step-desc">æŒ‰ F5 æˆ–ç‚¹å‡»æµè§ˆå™¨åˆ·æ–°æŒ‰é’®</div>
            </div>

            <div class="step">
                <div class="step-title">æ­¥éª¤ 3ï¼šæµ‹è¯•åŠŸèƒ½</div>
                <div class="step-desc">ç‚¹å‡»ä¸åŒçš„ tabï¼Œæ£€æŸ¥æ•°æ®æ˜¯å¦æ­£å¸¸æ˜¾ç¤º</div>
            </div>

            <button onclick="openCabinetDetail()">æ‰“å¼€å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢</button>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
        window.addEventListener('DOMContentLoaded', function() {
            runDiagnosis();
        });

        // è¿è¡Œè¯Šæ–­
        function runDiagnosis() {
            const resultDiv = document.getElementById('diagnosisResult');
            const infoDiv = document.getElementById('diagnosticInfo');

            // æ£€æŸ¥ localStorage ä¸­çš„ fieldSettings
            const fieldSettings = localStorage.getItem('fieldSettings');

            if (!fieldSettings) {
                resultDiv.innerHTML = `
                    <div class="status info">
                        <strong>âœ“ æœªå‘ç°å­—æ®µè®¾ç½®é—®é¢˜</strong><br>
                        localStorage ä¸­æ²¡æœ‰å­—æ®µè®¾ç½®æ•°æ®ï¼Œæ‰€æœ‰å­—æ®µåº”ä½¿ç”¨é»˜è®¤é…ç½®ã€‚
                    </div>
                `;

                infoDiv.innerHTML = `
                    <div class="status info">
                        æ²¡æœ‰æ‰¾åˆ° <code class="code-inline">fieldSettings</code> æ•°æ®ã€‚
                    </div>
                `;
                return;
            }

            try {
                const settings = JSON.parse(fieldSettings);
                const components = Object.keys(settings);

                if (components.length === 0) {
                    resultDiv.innerHTML = `
                        <div class="status success">
                            <strong>âœ“ å­—æ®µè®¾ç½®ä¸ºç©ºå¯¹è±¡</strong><br>
                            æ²¡æœ‰ä»»ä½•ç»„ä»¶çš„å­—æ®µè®¾ç½®ï¼Œæ‰€æœ‰å­—æ®µåº”ä½¿ç”¨é»˜è®¤é…ç½®ã€‚
                        </div>
                    `;
                } else {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç»„ä»¶çš„æ‰€æœ‰å­—æ®µéƒ½è¢«éšè—
                    let hasIssue = false;
                    let issueDetails = [];

                    for (let comp of components) {
                        const compSettings = settings[comp];
                        if (compSettings && compSettings.realtime) {
                            const realtimeFields = compSettings.realtime;
                            const visibleFields = Object.values(realtimeFields).filter(v => v === true);

                            if (visibleFields.length === 0) {
                                hasIssue = true;
                                issueDetails.push(`<strong>${comp}</strong> ç»„ä»¶çš„æ‰€æœ‰å®æ—¶æ•°æ®å­—æ®µéƒ½è¢«éšè—`);
                            }
                        }
                    }

                    if (hasIssue) {
                        resultDiv.innerHTML = `
                            <div class="status error">
                                <strong>âœ— å‘ç°é—®é¢˜ï¼</strong><br>
                                ä»¥ä¸‹ç»„ä»¶çš„æ‰€æœ‰å­—æ®µéƒ½è¢«éšè—ï¼Œå¯¼è‡´ç‚¹å‡» tab æ—¶æ•°æ®æ¶ˆå¤±ï¼š<br>
                                ${issueDetails.map(d => `â€¢ ${d}`).join('<br>')}
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <div class="status warning">
                                <strong>âš  å‘ç°å­—æ®µè®¾ç½®</strong><br>
                                æ‰¾åˆ°äº†å­—æ®µè®¾ç½®æ•°æ®ï¼Œä½†çœ‹èµ·æ¥æ²¡æœ‰æ˜æ˜¾é—®é¢˜ã€‚<br>
                                å¦‚æœä»ç„¶é‡åˆ°æ•°æ®æ¶ˆå¤±çš„é—®é¢˜ï¼Œå»ºè®®æ¸…é™¤å­—æ®µè®¾ç½®ã€‚
                            </div>
                        `;
                    }
                }

                // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                infoDiv.innerHTML = `
                    <div class="status info">
                        <strong>å­—æ®µè®¾ç½®å†…å®¹ï¼š</strong>
                        <pre>${JSON.stringify(settings, null, 2)}</pre>
                    </div>
                `;

            } catch (e) {
                resultDiv.innerHTML = `
                    <div class="status error">
                        <strong>âœ— æ•°æ®æ ¼å¼é”™è¯¯ï¼</strong><br>
                        localStorage ä¸­çš„ fieldSettings æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼š${e.message}
                    </div>
                `;

                infoDiv.innerHTML = `
                    <div class="status error">
                        <strong>åŸå§‹æ•°æ®ï¼š</strong>
                        <pre>${fieldSettings}</pre>
                    </div>
                `;
            }
        }

        // ä¿®å¤æ–¹æ¡ˆ 1ï¼šæ¸…é™¤å­—æ®µè®¾ç½®
        function fixOption1() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­—æ®µè®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤æ‰€æœ‰å­—æ®µåˆ°é»˜è®¤å¯è§çŠ¶æ€ã€‚')) {
                localStorage.removeItem('fieldSettings');
                alert('âœ“ å­—æ®µè®¾ç½®å·²æ¸…é™¤ï¼\n\nè¯·åˆ·æ–°å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢æŸ¥çœ‹æ•ˆæœã€‚');
                runDiagnosis();
            }
        }

        // ä¿®å¤æ–¹æ¡ˆ 2ï¼šé‡ç½®ä¸ºé»˜è®¤è®¾ç½®
        function fixOption2() {
            if (confirm('ç¡®å®šè¦é‡ç½®å­—æ®µè®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) {
                // è®¾ç½®ä¸ºç©ºå¯¹è±¡ï¼Œè®©é¡µé¢ä½¿ç”¨ fieldConfigs ä¸­çš„é»˜è®¤å€¼
                localStorage.setItem('fieldSettings', JSON.stringify({}));
                alert('âœ“ å­—æ®µè®¾ç½®å·²é‡ç½®ï¼\n\nè¯·åˆ·æ–°å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢æŸ¥çœ‹æ•ˆæœã€‚');
                runDiagnosis();
            }
        }

        // æ˜¾ç¤ºå®Œæ•´æ•°æ®
        function showFullData() {
            const display = document.getElementById('fullDataDisplay');

            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    const value = localStorage.getItem(key);
                    // å°è¯•è§£æ JSON
                    try {
                        allData[key] = JSON.parse(value);
                    } catch {
                        allData[key] = value;
                    }
                } catch (e) {
                    allData[key] = `[è¯»å–å¤±è´¥: ${e.message}]`;
                }
            }

            display.innerHTML = `
                <div class="status info" style="margin-top: 16px;">
                    <strong>localStorage å®Œæ•´æ•°æ®ï¼š</strong>
                    <pre>${JSON.stringify(allData, null, 2)}</pre>
                </div>
            `;
        }

        // å®Œå…¨æ¸…ç©º
        function clearAll() {
            if (confirm('âš ï¸ è­¦å‘Šï¼\n\nè¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨æ•°æ®ï¼ŒåŒ…æ‹¬ï¼š\nâ€¢ ä¸ªæ€§åŒ–è®¾ç½®ï¼ˆLogoã€æµ·æŠ¥ã€èƒ½é‡æµå›¾æ ‡ï¼‰\nâ€¢ å­—æ®µè®¾ç½®\nâ€¢ å…¶ä»–æ‰€æœ‰è®¾ç½®\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                if (confirm('å†æ¬¡ç¡®è®¤ï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    localStorage.clear();
                    alert('âœ“ æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼\n\nè¯·åˆ·æ–°å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢ã€‚');
                    runDiagnosis();
                }
            }
        }

        // æ‰“å¼€å‚¨èƒ½æŸœè¯¦æƒ…é¡µé¢
        function openCabinetDetail() {
            window.open('cabinet-detail.html?cabinetId=1', '_blank');
        }
    </script>
</body>
</html>
