<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒ½é‡æµè®¾ç½® - å‚¨èƒ½æŸœç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="navbar.js"></script>
    <style>
        /* é¡µé¢å¸ƒå±€ */
        .main-content {
            padding: 0 !important;
            margin: 0 !important;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* èƒ½é‡æµè§†å›¾æ ·å¼ - ç”µæ°”å•çº¿å›¾é£æ ¼ */
        #energy-flow-container {
            width: 100%;
            height: 100vh;
            position: relative;
            background: var(--bg-secondary);
            border-radius: 0;
            overflow: auto;
            display: block;
            padding-top: 64px;
            box-sizing: border-box;
        }

        .energy-flow-canvas {
            width: 100%;
            min-height: 100%;
            position: relative;
            padding: 40px;
            background: var(--bg-primary);
            overflow: auto;
        }

        /* è®¾å¤‡å®¹å™¨æ ·å¼ */
        #devicesContainer {
            background: var(--bg-secondary);
            background-image:
                linear-gradient(rgba(148, 163, 184, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.08) 1px, transparent 1px);
            background-size: 100px 100px;
        }

        /* æ·±è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] #devicesContainer {
            background: #0f172a;
            background-image:
                linear-gradient(rgba(148, 163, 184, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.05) 1px, transparent 1px);
            background-size: 100px 100px;
        }

        /* å±‚çº§å®¹å™¨ */
        .flow-layer {
            width: 100%;
            min-height: 180px;
            margin-bottom: 60px;
            position: relative;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s ease;
        }

        .flow-layer:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .flow-layer-title {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 16px;
            font-weight: 600;
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 8px;
        }

        /* è®¾å¤‡èŠ‚ç‚¹æ ·å¼ - ç°ä»£å¡ç‰‡é£æ ¼ */
        .flow-device {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: move;
            position: relative;
            z-index: 10;
        }

        .flow-device:hover {
            background: var(--bg-primary);
            border-color: #3562E3;
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(53, 98, 227, 0.25);
        }

        /* è®¾å¤‡é€‰ä¸­çŠ¶æ€ */
        .flow-device.selected {
            border: 3px solid #3562E3 !important;
            box-shadow:
                0 0 0 4px rgba(53, 98, 227, 0.1),
                0 10px 25px -5px rgba(53, 98, 227, 0.4) !important;
            background: var(--bg-primary);
        }

        /* æ·±è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .flow-device {
            background: #1e293b;
            border-color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .flow-device:hover {
            border-color: #60a5fa;
            box-shadow: 0 10px 25px -5px rgba(96, 165, 250, 0.3);
        }

        [data-theme="dark"] .flow-device.selected {
            border-color: #60a5fa !important;
            box-shadow:
                0 0 0 4px rgba(96, 165, 250, 0.15),
                0 10px 25px -5px rgba(96, 165, 250, 0.4) !important;
        }

        /* è¿æ¥ç‚¹å®¹å™¨ */
        .connection-points {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: block;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹æ‚¬æµ®æˆ–é€‰ä¸­æ—¶æ˜¾ç¤ºè¿æ¥ç‚¹ */
        .flow-device:hover .connection-points,
        .flow-device.selected .connection-points {
            opacity: 1;
        }

        /* å•ä¸ªè¿æ¥ç‚¹ */
        .connection-point {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #3562E3;
            border: 3px solid var(--bg-primary);
            border-radius: 50%;
            cursor: crosshair;
            pointer-events: auto;
            transform: translate(-50%, -50%);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.3);
        }

        .connection-point:hover {
            width: 18px;
            height: 18px;
            background: #2952d3;
            box-shadow:
                0 0 0 4px rgba(53, 98, 227, 0.15),
                0 4px 12px rgba(53, 98, 227, 0.4);
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* æ·±è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .connection-point {
            background: #60a5fa;
            border-color: #1e293b;
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.3);
        }

        [data-theme="dark"] .connection-point:hover {
            background: #3b82f6;
            box-shadow:
                0 0 0 4px rgba(96, 165, 250, 0.15),
                0 4px 12px rgba(96, 165, 250, 0.4);
        }

        /* å››ä¸ªæ–¹å‘çš„è¿æ¥ç‚¹ */
        .connection-point.top {
            top: 0;
            left: 50%;
        }

        .connection-point.bottom {
            bottom: 0;
            left: 50%;
            transform: translate(-50%, 50%);
        }

        .connection-point.left {
            top: 50%;
            left: 0;
        }

        .connection-point.right {
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
        }

        /* è®¾å¤‡å›¾æ ‡ */
        .flow-device-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 12px;
            filter: none;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flow-device:hover .flow-device-icon {
            transform: scale(1.05);
        }

        .flow-device-icon img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        /* è®¾å¤‡æ ‡ç­¾ */
        .flow-device-label {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            text-align: center;
            letter-spacing: 0.3px;
            width: 100%;
        }

        /* è®¾å¤‡å¤–éƒ¨å‚æ•°æ˜¾ç¤º */
        .device-external-param {
            position: absolute;
            background: rgba(53, 98, 227, 0.1);
            border: 1px solid var(--primary-color);
            padding: 6px 12px 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: var(--primary-color);
            backdrop-filter: blur(4px);
            white-space: nowrap;
            cursor: move;
            user-select: none;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 15;
        }

        .device-external-param:hover {
            background: rgba(53, 98, 227, 0.2);
            border-color: #2952d3;
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.3);
        }


        [data-theme="dark"] .device-external-param {
            background: rgba(96, 165, 250, 0.15);
            border-color: #60a5fa;
            color: #60a5fa;
        }

        [data-theme="dark"] .device-external-param:hover {
            background: rgba(96, 165, 250, 0.25);
            border-color: #3b82f6;
        }

        /* å‚æ•°åˆ é™¤æŒ‰é’® */
        .param-delete-btn {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .param-delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: scale(1.1);
        }

        [data-theme="dark"] .param-delete-btn {
            background: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.3);
            color: #f87171;
        }

        [data-theme="dark"] .param-delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* è®¾å¤‡å¡ç‰‡åˆ é™¤æŒ‰é’®ï¼ˆä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ */
        .device-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
        }

        .device-delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        [data-theme="dark"] .device-delete-btn {
            background: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.3);
            color: #f87171;
        }

        [data-theme="dark"] .device-delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* è®¾å¤‡å‚æ•°å®¹å™¨ï¼ˆå†…éƒ¨ï¼Œå·²åºŸå¼ƒï¼‰ */
        .flow-device-params {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        /* å•ä¸ªå‚æ•° */
        .flow-device-param {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            padding: 2px 0;
        }

        .flow-device-param.power {
            color: #3562E3;
        }

        .flow-device-param.positive {
            color: #10b981;
        }

        .flow-device-param.negative {
            color: #ef4444;
        }

        /* æ±‡æµæŸœæ ·å¼ */
        .flow-busbar-device {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .flow-busbar-icon {
            width: 60px;
            height: 60px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .flow-busbar-icon i {
            color: var(--primary-color);
            font-size: 32px;
        }

        /* PCSå’ŒBMSèŠ‚ç‚¹æ ·å¼ */
        .flow-pcs-bms-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 30px;
        }

        .flow-pcs-device {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        .flow-pcs-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 8px;
            filter: grayscale(20%);
        }

        .flow-bms-device {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }

        .flow-bms-icon {
            width: 40px;
            height: 60px;
            background: var(--success-color);
            border-radius: 4px;
            margin-bottom: 8px;
            position: relative;
            border: 2px solid var(--success-color);
        }

        .flow-bms-icon::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        /* SVGè¿æ¥çº¿å®¹å™¨ */
        .energy-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* è¿æ¥çº¿åŸºç¡€æ ·å¼ - å®çº¿ */
        .energy-connection-line,
        .flow-busbar,
        .flow-vline {
            stroke: #3562E3;
            stroke-width: 3px;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.3s ease;
            /* å®çº¿ï¼Œä¸ä½¿ç”¨è™šçº¿ */
        }

        /* æ‚¬æµ®çŠ¶æ€ */
        .energy-connection-line:hover {
            stroke: #2952d3;
            stroke-width: 4px;
            filter: drop-shadow(0 0 8px rgba(53, 98, 227, 0.5));
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .energy-connection-line.selected {
            stroke: #10b981;
            stroke-width: 4px;
            filter: drop-shadow(0 0 12px rgba(16, 185, 129, 0.6));
        }

        /* è¿æ¥ç‚¹æ ‡è®° */
        .flow-connection-point {
            fill: #3562E3;
            r: 4;
        }

        /* èƒ½é‡æµåŠ¨æ–¹å‘ç®­å¤´ */
        .energy-flow-arrow {
            fill: #3562E3;
            filter: drop-shadow(0 2px 4px rgba(53, 98, 227, 0.3));
        }

        /* æµåŠ¨ç²’å­åŠ¨ç”» */
        @keyframes flowAnimation {
            0% {
                stroke-dashoffset: 20;
                opacity: 1;
            }
            100% {
                stroke-dashoffset: 0;
                opacity: 0.8;
            }
        }

        /* æµåŠ¨åŠ¨ç”» - å®çº¿å¾®åŠ¨æ•ˆï¼ˆé€šè¿‡æŸ”å’Œçš„é˜´å½±å˜åŒ–ï¼‰ */
        .flow-vline.animated,
        .energy-connection-line.flowing {
            animation: flowPulse 3s ease-in-out infinite;
        }

        /* æµå…¥åŠ¨ç”»ï¼ˆæ­£å‘ï¼‰ - ä»…å‘å…‰æ•ˆæœ */
        .energy-connection-line.flow-in {
            filter: drop-shadow(0 0 4px rgba(53, 98, 227, 0.6));
        }

        /* æµå‡ºåŠ¨ç”»ï¼ˆåå‘ï¼‰ - ä»…å‘å…‰æ•ˆæœ */
        .energy-connection-line.flow-out {
            filter: drop-shadow(0 0 4px rgba(239, 68, 68, 0.6));
        }

        /* é€šç”¨è„‰å†²åŠ¨ç”» */
        @keyframes flowPulse {
            0%, 100% {
                filter: drop-shadow(0 0 2px rgba(53, 98, 227, 0.3));
            }
            50% {
                filter: drop-shadow(0 0 5px rgba(53, 98, 227, 0.7));
            }
        }

        /* æµåŠ¨ç²’å­æ•ˆæœ */
        .flow-particle {
            fill: #00d9ff;
            animation: particleMove 2s linear infinite;
        }

        @keyframes particleMove {
            0% {
                offset-distance: 0%;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                offset-distance: 100%;
                opacity: 0;
            }
        }

        /* æ·±è‰²ä¸»é¢˜é€‚é… */
        [data-theme="dark"] .energy-connection-line,
        [data-theme="dark"] .flow-busbar,
        [data-theme="dark"] .flow-vline {
            stroke: #60a5fa;
        }

        [data-theme="dark"] .energy-connection-line:hover {
            stroke: #3b82f6;
        }

        [data-theme="dark"] .flow-connection-point,
        [data-theme="dark"] .energy-flow-arrow {
            fill: #60a5fa;
        }

        /* è®¾å¤‡åˆ—è¡¨é¢æ¿ */
        .device-list-panel {
            position: fixed;
            top: 230px;
            left: 276px;
            width: 280px;
            max-height: calc(100vh - 250px);
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            z-index: 150;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .device-list-title {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-toggle-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .panel-toggle-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* é¢æ¿æ”¶èµ·çŠ¶æ€ */
        .device-list-panel.collapsed {
            width: 48px;
            padding: 12px;
        }

        .device-list-panel.collapsed .device-list-title span,
        .device-list-panel.collapsed .device-category {
            display: none;
        }

        /* å³ä¾§è®¾å¤‡è®¾ç½®é¢æ¿ */
        .device-settings-panel {
            position: fixed;
            top: 230px;
            right: 20px;
            width: 320px;
            max-height: calc(100vh - 250px);
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            z-index: 150;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .device-settings-panel.collapsed {
            width: 48px;
            padding: 12px;
        }

        .device-settings-panel.collapsed .device-list-title span,
        .device-settings-panel.collapsed #settingsPanelContent {
            display: none;
        }

        /* è®¾ç½®é¡¹æ ·å¼ */
        .settings-item {
            margin-bottom: 16px;
        }

        .settings-item-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .settings-item-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .settings-item-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .settings-item-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .settings-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .settings-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .settings-btn.primary:hover {
            background: #2451cc;
        }

        .settings-btn.danger {
            background: #ef4444;
            color: white;
        }

        .settings-btn.danger:hover {
            background: #dc2626;
        }

        .device-category {
            margin-bottom: 20px;
        }

        .device-category-title {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-category-icon {
            font-size: 18px;
        }

        .device-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary-color);
            transform: translateX(4px);
        }

        .device-item:active {
            cursor: grabbing;
        }

        .device-item-icon {
            font-size: 24px;
        }

        .device-item-info {
            flex: 1;
        }

        .device-item-name {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
        }

        .device-item-desc {
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 2px;
        }

        /* æ‹–æ‹½å ä½ç¬¦ */
        .drag-placeholder {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.7;
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 10px;
            display: none;
        }

        /* èƒ½é‡æµé¡µé¢å¤´éƒ¨ */
        .energy-flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: relative;
            z-index: 10;
        }

        .energy-flow-title {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .energy-flow-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* å·¥å…·æ  (ä¿ç•™åŸæœ‰æ ·å¼ä½œä¸ºå¤‡ç”¨) */
        .energy-flow-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .toolbar-btn {
            min-width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
        }

        .toolbar-btn i {
            font-size: 16px;
            color: var(--primary-color);
        }

        .toolbar-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.15);
        }

        .toolbar-btn.active,
        .toolbar-btn.primary {
            background: linear-gradient(135deg, #3562E3 0%, #2952d3 100%);
            color: white;
            border-color: #3562E3;
        }

        .toolbar-btn.active i,
        .toolbar-btn.primary i {
            color: white;
        }

        .toolbar-btn.active:hover,
        .toolbar-btn.primary:hover {
            background: #2952d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(53, 98, 227, 0.3);
        }

        /* å·¥å…·æ æŒ‰é’®æ‚¬åœæç¤º */
        .toolbar-btn::before {
            content: attr(title);
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 300;
        }

        .toolbar-btn:hover::before {
            opacity: 1;
        }

        /* è®¾å¤‡é…ç½®é¢æ¿ */
        .device-config-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            z-index: 100;
        }

        .config-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .device-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .device-type-btn {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .device-type-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
        }

        .device-type-icon {
            font-size: 20px;
        }

        .device-type-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* èƒ½é‡æµä¿¡æ¯é¢æ¿ */
        .energy-info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow-lg);
            min-width: 250px;
            z-index: 100;
    </style>
</head>
<body data-page="energy-flow">
    <div id="navbar-container"></div>

    <div class="main-content">
        <div id="energy-flow-container">
            <!-- é¡µé¢å¤´éƒ¨ -->
            <div class="energy-flow-header">
                <div class="energy-flow-title">
                    <i class="fas fa-project-diagram" style="margin-right: 12px; color: #3562E3;"></i>
                    <span>èƒ½é‡æµè½¬å›¾</span>
                </div>

                <div class="energy-flow-actions" style="display: flex; gap: 12px;">
                    <!-- ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢æŒ‰é’® -->
                    <button class="toolbar-btn primary" id="editModeBtn" onclick="toggleEditMode()" title="åˆ‡æ¢ç¼–è¾‘æ¨¡å¼">
                        <i class="fas fa-edit"></i>
                        <span>ç¼–è¾‘</span>
                    </button>

                    <!-- ä¿å­˜æŒ‰é’®ï¼ˆåªåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
                    <button class="toolbar-btn" id="saveBtn" onclick="saveFlowConfig()" title="ä¿å­˜é…ç½®" style="display: none;">
                        <i class="fas fa-save"></i>
                        <span>ä¿å­˜</span>
                    </button>

                    <!-- å¯¹é½æŒ‰é’®ç»„ï¼ˆåªåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
                    <div id="alignmentBtns" style="display: none; gap: 8px;">
                        <button class="toolbar-btn" onclick="alignDevicesHorizontal()" title="æ°´å¹³å¯¹é½é€‰ä¸­çš„è®¾å¤‡">
                            <i class="fas fa-arrows-alt-h"></i>
                            <span>æ°´å¹³å¯¹é½</span>
                        </button>
                        <button class="toolbar-btn" onclick="alignDevicesVertical()" title="å‚ç›´å¯¹é½é€‰ä¸­çš„è®¾å¤‡">
                            <i class="fas fa-arrows-alt-v"></i>
                            <span>å‚ç›´å¯¹é½</span>
                        </button>
                        <button class="toolbar-btn" onclick="straightenConnections()" title="å°†é€‰ä¸­çš„è¿çº¿æ‹‰ç›´">
                            <i class="fas fa-ruler"></i>
                            <span>è¿çº¿æ‹‰ç›´</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="energy-flow-canvas" id="energyFlowCanvas">
                <!-- SVGè¿æ¥çº¿å®¹å™¨ -->
                <svg class="energy-connections" id="energyConnections" style="position: absolute; inset: 0; pointer-events: none; z-index: 5;">
                </svg>

                <!-- è®¾å¤‡å®¹å™¨ï¼ˆè‡ªç”±æ”¾ç½®ï¼‰ -->
                <div id="devicesContainer" ondrop="dropDevice(event)" ondragover="allowDrop(event)" style="position: absolute; inset: 0;">
                    <!-- è®¾å¤‡å°†é€šè¿‡æ‹–æ‹½æ·»åŠ åˆ°æ­¤å¤„ï¼Œå¯è‡ªç”±æ”¾ç½®åœ¨ä»»æ„ä½ç½® -->
                </div>
            </div>

            <!-- è®¾å¤‡åˆ—è¡¨é¢æ¿ -->
            <div class="device-list-panel" id="deviceListPanel">
                <div class="device-list-title">
                    <span>å¯ç”¨è®¾å¤‡</span>
                    <button class="panel-toggle-btn" id="panelToggleBtn" onclick="toggleDevicePanel()" title="æ”¶èµ·é¢æ¿">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>

                <!-- ç”µæºè®¾å¤‡ -->
                <div class="device-category">
                    <div class="device-category-title">
                        <span class="device-category-icon">âš¡</span>
                        <span>ç”µæºè®¾å¤‡</span>
                    </div>
                    <div id="powerDevicesList">
                        <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å‚¨èƒ½è®¾å¤‡ -->
                <div class="device-category">
                    <div class="device-category-title">
                        <span class="device-category-icon">ğŸ”‹</span>
                        <span>å‚¨èƒ½è®¾å¤‡</span>
                    </div>
                    <div id="storageDevicesList">
                        <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- è´Ÿè½½è®¾å¤‡ -->
                <div class="device-category">
                    <div class="device-category-title">
                        <span class="device-category-icon">ğŸ­</span>
                        <span>è´Ÿè½½è®¾å¤‡</span>
                    </div>
                    <div id="loadDevicesList">
                        <!-- å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ‹–æ‹½å ä½ç¬¦ -->
            <div id="dragPlaceholder" class="drag-placeholder"></div>

            <!-- å³ä¾§è®¾å¤‡è®¾ç½®é¢æ¿ -->
            <div class="device-settings-panel" id="deviceSettingsPanel" style="display: none;">
                <div class="device-list-title">
                    <span id="settingsPanelTitle">è®¾å¤‡è®¾ç½®</span>
                    <button class="panel-toggle-btn" id="settingsPanelToggleBtn" onclick="toggleSettingsPanel()" title="æ”¶èµ·é¢æ¿">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div id="settingsPanelContent" style="margin-top: 16px;">
                    <!-- è®¾ç½®å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let availableDevices = {
            power: [
                { id: 'grid-1', type: 'grid', label: 'å¸‚ç”µ', icon: 'ç”µç½‘.png', desc: '380V 3ç›¸' },
                { id: 'gen-1', type: 'generator', label: 'æŸ´å‘', icon: 'æŸœå­æ‰“å¼€.png', desc: '500KW' },
                { id: 'solar-1', type: 'solar', label: 'å…‰ä¼', icon: 'å…‰ä¼.png', desc: '200KW' }
            ],
            storage: [
                { id: 'pcs-1', type: 'pcs', label: 'å‚¨èƒ½æŸœ', icon: 'å‚¨èƒ½æŸœ.png', desc: '250KW/500KWh' }
            ],
            load: [
                { id: 'load-1', type: 'load', label: 'è´Ÿè½½', icon: 'è´Ÿè½½.png', desc: 'å·¥ä¸šè´Ÿè½½' }
            ]
        };

        // ç¼–è¾‘æ¨¡å¼çŠ¶æ€
        let isEditMode = true; // é»˜è®¤ä¸ºç¼–è¾‘æ¨¡å¼

        // ç”»å¸ƒä¸Šå·²æ”¾ç½®çš„è®¾å¤‡ï¼ˆè‡ªç”±ç”»å¸ƒï¼Œä¸å†åˆ†å±‚ï¼‰
        let placedDevices = [];

        // è®¾å¤‡è¿æ¥çº¿
        let deviceConnections = [];

        // è¿æ¥çŠ¶æ€
        let connectionStart = null; // {deviceId, direction, x, y}
        let selectedDevice = null; // å½“å‰é€‰ä¸­çš„è®¾å¤‡ID
        let isDraggingConnection = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½è¿çº¿
        let tempConnectionLine = null; // ä¸´æ—¶è¿çº¿å…ƒç´ 

        // è¿çº¿è‡ªå®šä¹‰ç¼–è¾‘çŠ¶æ€
        let selectedConnection = null; // å½“å‰é€‰ä¸­çš„è¿çº¿ç´¢å¼•
        let isDraggingControlPoint = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½æ§åˆ¶ç‚¹
        let draggingControlPointIndex = null; // æ­£åœ¨æ‹–æ‹½çš„æ§åˆ¶ç‚¹ç´¢å¼•

        // æ‹–æ‹½ç›¸å…³
        let draggedDeviceData = null;
        let draggedPlacedDevice = null; // æ­£åœ¨æ‹–æ‹½çš„å·²æ”¾ç½®è®¾å¤‡ {deviceId}
        let isDraggingPlacedDevice = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ‹–æ‹½å·²æ”¾ç½®çš„è®¾å¤‡

        // åˆ‡æ¢è®¾å¤‡é¢æ¿æ”¶èµ·/å±•å¼€
        function toggleDevicePanel() {
            const panel = document.getElementById('deviceListPanel');
            const toggleBtn = document.getElementById('panelToggleBtn');
            const isPanelCollapsed = panel.classList.contains('collapsed');

            if (isPanelCollapsed) {
                // å±•å¼€é¢æ¿
                panel.classList.remove('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                toggleBtn.title = 'æ”¶èµ·é¢æ¿';
            } else {
                // æ”¶èµ·é¢æ¿
                panel.classList.add('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                toggleBtn.title = 'å±•å¼€é¢æ¿';
            }

            // é¢æ¿æ˜¯å›ºå®šå®šä½ï¼Œç”»å¸ƒä¸éœ€è¦è°ƒæ•´
        }

        // åˆ‡æ¢å³ä¾§è®¾ç½®é¢æ¿
        function toggleSettingsPanel() {
            const panel = document.getElementById('deviceSettingsPanel');
            const toggleBtn = document.getElementById('settingsPanelToggleBtn');
            const isPanelCollapsed = panel.classList.contains('collapsed');

            if (isPanelCollapsed) {
                // å±•å¼€é¢æ¿
                panel.classList.remove('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                toggleBtn.title = 'æ”¶èµ·é¢æ¿';
            } else {
                // æ”¶èµ·é¢æ¿
                panel.classList.add('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                toggleBtn.title = 'å±•å¼€é¢æ¿';
            }
        }

        // å¤„ç†è®¾å¤‡é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        let deviceClickTimer = null;
        function handleDeviceMouseDown(event, deviceId) {
            if (!isEditMode) return;

            // å»¶è¿Ÿæ˜¾ç¤ºè®¾ç½®é¢æ¿ï¼Œé¿å…æ‹–æ‹½æ—¶è¯¯è§¦
            deviceClickTimer = setTimeout(() => {
                showDeviceSettings(deviceId);
            }, 200);
        }

        // åœ¨æ‹–æ‹½å¼€å§‹æ—¶å–æ¶ˆç‚¹å‡»å®šæ—¶å™¨
        window.addEventListener('dragstart', () => {
            if (deviceClickTimer) {
                clearTimeout(deviceClickTimer);
                deviceClickTimer = null;
            }
        });

        // åˆ‡æ¢è®¾å¤‡å‚æ•°æ˜¾ç¤ºï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
        function toggleDeviceParam(deviceId, paramName, enabled) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            device.displayParams[paramName].enabled = enabled;
            renderPlacedDevices();
        }

        // å®æ—¶æ›´æ–°è®¾å¤‡å±æ€§
        function updateDeviceProperty(deviceId, property, value) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            device[property] = value;
            renderPlacedDevices();
        }

        // åˆ é™¤è®¾å¤‡å‚æ•°
        function removeDeviceParam(deviceId, paramName, event) {
            event.stopPropagation();
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            device.displayParams[paramName].enabled = false;

            // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„checkbox
            const checkbox = document.getElementById(`display${paramName.charAt(0).toUpperCase() + paramName.slice(1)}`);
            if (checkbox) checkbox.checked = false;

            renderPlacedDevices();
        }

        // åˆ é™¤å‚æ•°ï¼ˆç‚¹å‡»Ã—æŒ‰é’®ï¼‰
        function deleteDeviceParam(event, deviceId, paramType) {
            event.stopPropagation();
            event.preventDefault();

            // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼
            if (!isEditMode) {
                showMiniToast('è¯·å…ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼', 'warning');
                return;
            }

            const device = placedDevices.find(d => d.id === deviceId);
            if (!device || !device.displayParams) return;

            // ç¦ç”¨è¯¥å‚æ•°
            device.displayParams[paramType].enabled = false;

            // æ›´æ–°è®¾ç½®é¢æ¿ä¸­çš„checkbox
            const checkbox = document.getElementById(`display${paramType.charAt(0).toUpperCase() + paramType.slice(1)}`);
            if (checkbox) checkbox.checked = false;

            // é‡æ–°æ¸²æŸ“
            renderPlacedDevices();
            showMiniToast(`å·²éšè— ${paramType.toUpperCase()} å‚æ•°`, 'success');
        }

        // åˆ é™¤è®¾å¤‡ï¼ˆç‚¹å‡»Ã—æŒ‰é’®ï¼‰
        function deleteDevice(event, deviceId) {
            event.stopPropagation();
            event.preventDefault();

            // æ£€æŸ¥æ˜¯å¦åœ¨ç¼–è¾‘æ¨¡å¼
            if (!isEditMode) {
                showMiniToast('âš ï¸ è¯·å…ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼', 'warning');
                return;
            }

            // åˆ é™¤ç›¸å…³è¿çº¿
            deviceConnections = deviceConnections.filter(conn =>
                conn.from !== deviceId && conn.to !== deviceId
            );

            // åˆ é™¤è®¾å¤‡
            const deviceName = placedDevices.find(d => d.id === deviceId)?.label || 'è®¾å¤‡';
            placedDevices = placedDevices.filter(d => d.id !== deviceId);

            // é‡æ–°æ¸²æŸ“
            renderPlacedDevices();
            drawAllConnections();

            // ä¿å­˜åˆ°localStorage
            saveToLocalStorage();

            showMiniToast(`âœ… å·²åˆ é™¤ ${deviceName}`, 'success');
        }

        // å‚æ•°æ‹–æ‹½ç›¸å…³å˜é‡
        let draggedParam = null;
        let paramDragStartX = 0;
        let paramDragStartY = 0;

        // å¼€å§‹æ‹–æ‹½å‚æ•°
        function startParamDrag(event, deviceId, paramName) {
            if (!isEditMode) return;

            // é˜»æ­¢äº‹ä»¶å†’æ³¡å’Œé»˜è®¤è¡Œä¸ºï¼Œé˜²æ­¢è§¦å‘è®¾å¤‡æ‹–æ‹½
            event.stopPropagation();
            event.preventDefault();

            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            draggedParam = { deviceId, paramName };
            paramDragStartX = event.clientX;
            paramDragStartY = event.clientY;

            // ä¸´æ—¶ç¦ç”¨è®¾å¤‡çš„ draggable å±æ€§
            const deviceElement = document.getElementById(`placed-${deviceId}`);
            if (deviceElement) {
                deviceElement.setAttribute('draggable', 'false');
            }

            document.addEventListener('mousemove', onParamDrag);
            document.addEventListener('mouseup', endParamDrag);
        }

        // æ‹–æ‹½å‚æ•°ä¸­
        function onParamDrag(event) {
            if (!draggedParam) return;

            const device = placedDevices.find(d => d.id === draggedParam.deviceId);
            if (!device) return;

            const deltaX = event.clientX - paramDragStartX;
            const deltaY = event.clientY - paramDragStartY;

            device.displayParams[draggedParam.paramName].x += deltaX;
            device.displayParams[draggedParam.paramName].y += deltaY;

            paramDragStartX = event.clientX;
            paramDragStartY = event.clientY;

            renderPlacedDevices();
        }

        // ç»“æŸæ‹–æ‹½å‚æ•°
        function endParamDrag() {
            // æ¢å¤è®¾å¤‡çš„ draggable å±æ€§
            if (draggedParam && isEditMode) {
                const deviceElement = document.getElementById(`placed-${draggedParam.deviceId}`);
                if (deviceElement) {
                    deviceElement.setAttribute('draggable', 'true');
                }
            }

            draggedParam = null;
            document.removeEventListener('mousemove', onParamDrag);
            document.removeEventListener('mouseup', endParamDrag);
        }

        // æ˜¾ç¤ºè®¾å¤‡è®¾ç½®é¢æ¿
        function showDeviceSettings(deviceId) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            const panel = document.getElementById('deviceSettingsPanel');
            const titleEl = document.getElementById('settingsPanelTitle');
            const contentEl = document.getElementById('settingsPanelContent');

            // è®¾ç½®æ ‡é¢˜
            titleEl.textContent = `${device.label} - è®¾ç½®`;

            // åˆå§‹åŒ–è®¾å¤‡çš„æ˜¾ç¤ºå‚æ•°å’Œæµå‘ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!device.displayParams) {
                device.displayParams = {
                    power: { enabled: true, x: 120, y: 0 },
                    voltage: { enabled: false, x: 120, y: 30 },
                    current: { enabled: false, x: 120, y: 60 },
                    soc: { enabled: false, x: 120, y: 90 }
                };
            }
            // æµå‘åˆ¤æ–­åŸºäºå“ªä¸ªå±æ€§å’Œæ­£è´Ÿ
            if (!device.flowControl) {
                device.flowControl = {
                    inAttribute: 'power',      // æµå…¥åˆ¤æ–­å±æ€§
                    inDirection: 'positive',   // æµå…¥æ–¹å‘ï¼ˆpositive/negativeï¼‰
                    outAttribute: 'power',     // æµå‡ºåˆ¤æ–­å±æ€§
                    outDirection: 'negative'   // æµå‡ºæ–¹å‘ï¼ˆpositive/negativeï¼‰
                };
            }

            // ç”Ÿæˆè®¾ç½®å†…å®¹
            let settingsHTML = `
                <div class="settings-item">
                    <label class="settings-item-label">è®¾å¤‡åç§°</label>
                    <input type="text" class="settings-item-input" id="deviceName" value="${device.label}"
                           oninput="updateDeviceProperty('${deviceId}', 'label', this.value)" />
                </div>

                <div class="settings-item">
                    <label class="settings-item-label">æ˜¾ç¤ºå‚æ•°ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displayPower" ${device.displayParams.power.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'power', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">åŠŸç‡ (P)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displayVoltage" ${device.displayParams.voltage.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'voltage', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">ç”µå‹ (U)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displayCurrent" ${device.displayParams.current.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'current', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">ç”µæµ (I)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displaySOC" ${device.displayParams.soc.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'soc', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">SOC (%)</span>
                        </label>
                    </div>
                </div>

                <div class="settings-item">
                    <label class="settings-item-label">æµå‘</label>
                    <div style="margin-top: 8px;">
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(53, 98, 227, 0.05); border-radius: 6px; border-left: 3px solid var(--primary-color);">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: var(--text-primary);">
                                æµå…¥
                            </label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select class="settings-item-select" id="flowInAttribute" style="flex: 1;">
                                    <option value="power" ${device.flowControl.inAttribute === 'power' ? 'selected' : ''}>åŠŸç‡ (P)</option>
                                    <option value="voltage" ${device.flowControl.inAttribute === 'voltage' ? 'selected' : ''}>ç”µå‹ (U)</option>
                                    <option value="current" ${device.flowControl.inAttribute === 'current' ? 'selected' : ''}>ç”µæµ (I)</option>
                                    <option value="soc" ${device.flowControl.inAttribute === 'soc' ? 'selected' : ''}>SOC</option>
                                </select>
                                <select class="settings-item-select" id="flowInDirection" style="flex: 0 0 100px;">
                                    <option value="positive" ${device.flowControl.inDirection === 'positive' ? 'selected' : ''}>æ­£æ•°</option>
                                    <option value="negative" ${device.flowControl.inDirection === 'negative' ? 'selected' : ''}>è´Ÿæ•°</option>
                                </select>
                            </div>
                        </div>
                        <div style="padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 6px; border-left: 3px solid #ef4444;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: var(--text-primary);">
                                æµå‡º
                            </label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select class="settings-item-select" id="flowOutAttribute" style="flex: 1;">
                                    <option value="power" ${device.flowControl.outAttribute === 'power' ? 'selected' : ''}>åŠŸç‡ (P)</option>
                                    <option value="voltage" ${device.flowControl.outAttribute === 'voltage' ? 'selected' : ''}>ç”µå‹ (U)</option>
                                    <option value="current" ${device.flowControl.outAttribute === 'current' ? 'selected' : ''}>ç”µæµ (I)</option>
                                    <option value="soc" ${device.flowControl.outAttribute === 'soc' ? 'selected' : ''}>SOC</option>
                                </select>
                                <select class="settings-item-select" id="flowOutDirection" style="flex: 0 0 100px;">
                                    <option value="positive" ${device.flowControl.outDirection === 'positive' ? 'selected' : ''}>æ­£æ•°</option>
                                    <option value="negative" ${device.flowControl.outDirection === 'negative' ? 'selected' : ''}>è´Ÿæ•°</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; line-height: 1.5;">
                            ç¤ºä¾‹ï¼šé€‰æ‹©"åŠŸç‡ + æ­£æ•°"è¡¨ç¤ºåŠŸç‡ä¸ºæ­£æ—¶æµå…¥/æµå‡º
                        </div>
                    </div>
                </div>
            `;

            // æ ¹æ®è®¾å¤‡ç±»å‹æ·»åŠ ç‰¹å®šè®¾ç½®
            if (device.type === 'å¸‚ç”µ' || device.type === 'æŸ´å‘' || device.type === 'å…‰ä¼') {
                settingsHTML += `
                    <div class="settings-item">
                        <label class="settings-item-label">é¢å®šåŠŸç‡ (KW)</label>
                        <input type="number" class="settings-item-input" id="devicePower" value="${device.power || 500}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">ç”µå‹ç­‰çº§</label>
                        <select class="settings-item-select" id="deviceVoltage">
                            <option value="380V" ${device.voltage === '380V' ? 'selected' : ''}>380V</option>
                            <option value="220V" ${device.voltage === '220V' ? 'selected' : ''}>220V</option>
                            <option value="10KV" ${device.voltage === '10KV' ? 'selected' : ''}>10KV</option>
                        </select>
                    </div>
                `;
            } else if (device.type === 'å‚¨èƒ½æŸœ') {
                settingsHTML += `
                    <div class="settings-item">
                        <label class="settings-item-label">å®¹é‡ (KWh)</label>
                        <input type="number" class="settings-item-input" id="deviceCapacity" value="${device.capacity || 1000}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">å……ç”µåŠŸç‡ (KW)</label>
                        <input type="number" class="settings-item-input" id="deviceChargePower" value="${device.chargePower || 500}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">æ”¾ç”µåŠŸç‡ (KW)</label>
                        <input type="number" class="settings-item-input" id="deviceDischargePower" value="${device.dischargePower || 500}" />
                    </div>
                `;
            } else if (device.type === 'è´Ÿè½½') {
                settingsHTML += `
                    <div class="settings-item">
                        <label class="settings-item-label">è´Ÿè½½åŠŸç‡ (KW)</label>
                        <input type="number" class="settings-item-input" id="deviceLoadPower" value="${device.loadPower || 300}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">è´Ÿè½½ç±»å‹</label>
                        <select class="settings-item-select" id="deviceLoadType">
                            <option value="æ’å®šè´Ÿè½½" ${device.loadType === 'æ’å®šè´Ÿè½½' ? 'selected' : ''}>æ’å®šè´Ÿè½½</option>
                            <option value="å¯è°ƒè´Ÿè½½" ${device.loadType === 'å¯è°ƒè´Ÿè½½' ? 'selected' : ''}>å¯è°ƒè´Ÿè½½</option>
                            <option value="ä¼˜å…ˆçº§è´Ÿè½½" ${device.loadType === 'ä¼˜å…ˆçº§è´Ÿè½½' ? 'selected' : ''}>ä¼˜å…ˆçº§è´Ÿè½½</option>
                        </select>
                    </div>
                `;
            }

            // ä¸å†æ·»åŠ æ“ä½œæŒ‰é’®ï¼Œæ‰€æœ‰ä¿®æ”¹å³æ—¶ç”Ÿæ•ˆï¼Œé€šè¿‡é¡¶éƒ¨ä¿å­˜æŒ‰é’®ç»Ÿä¸€ä¿å­˜

            contentEl.innerHTML = settingsHTML;

            // æ˜¾ç¤ºé¢æ¿
            panel.style.display = 'block';
            panel.classList.remove('collapsed');
        }

        // ä¿å­˜è®¾å¤‡è®¾ç½®
        function saveDeviceSettings(deviceId) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            const nameInput = document.getElementById('deviceName');
            if (nameInput) device.label = nameInput.value;

            // æ˜¾ç¤ºå‚æ•°å·²é€šè¿‡checkboxç«‹å³æ›´æ–°ï¼Œè¿™é‡Œä¸éœ€è¦å†ä¿å­˜

            // æ›´æ–°æµå‘è®¾ç½®
            const flowInAttribute = document.getElementById('flowInAttribute');
            const flowInDirection = document.getElementById('flowInDirection');
            const flowOutAttribute = document.getElementById('flowOutAttribute');
            const flowOutDirection = document.getElementById('flowOutDirection');

            if (flowInAttribute && flowInDirection && flowOutAttribute && flowOutDirection) {
                device.flowControl = {
                    inAttribute: flowInAttribute.value,
                    inDirection: flowInDirection.value,
                    outAttribute: flowOutAttribute.value,
                    outDirection: flowOutDirection.value
                };
            }

            // æ ¹æ®è®¾å¤‡ç±»å‹æ›´æ–°ç‰¹å®šå±æ€§
            if (device.type === 'å¸‚ç”µ' || device.type === 'æŸ´å‘' || device.type === 'å…‰ä¼') {
                const powerInput = document.getElementById('devicePower');
                const voltageSelect = document.getElementById('deviceVoltage');
                if (powerInput) device.power = parseFloat(powerInput.value);
                if (voltageSelect) device.voltage = voltageSelect.value;
            } else if (device.type === 'å‚¨èƒ½æŸœ') {
                const capacityInput = document.getElementById('deviceCapacity');
                const chargePowerInput = document.getElementById('deviceChargePower');
                const dischargePowerInput = document.getElementById('deviceDischargePower');
                if (capacityInput) device.capacity = parseFloat(capacityInput.value);
                if (chargePowerInput) device.chargePower = parseFloat(chargePowerInput.value);
                if (dischargePowerInput) device.dischargePower = parseFloat(dischargePowerInput.value);
            } else if (device.type === 'è´Ÿè½½') {
                const loadPowerInput = document.getElementById('deviceLoadPower');
                const loadTypeSelect = document.getElementById('deviceLoadType');
                if (loadPowerInput) device.loadPower = parseFloat(loadPowerInput.value);
                if (loadTypeSelect) device.loadType = loadTypeSelect.value;
            }

            // é‡æ–°æ¸²æŸ“è®¾å¤‡
            renderPlacedDevices();

            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            showMiniToast('âœ… è®¾å¤‡è®¾ç½®å·²ä¿å­˜', 'success');
        }

        // åº”ç”¨ç¼–è¾‘æ¨¡å¼UIï¼ˆä¸åˆ‡æ¢çŠ¶æ€ï¼Œä»…åº”ç”¨UIï¼‰
        function applyEditModeUI() {
            console.log('âœï¸ åº”ç”¨ç¼–è¾‘æ¨¡å¼UI');
            const editModeBtn = document.getElementById('editModeBtn');
            const saveBtn = document.getElementById('saveBtn');
            const deviceListPanel = document.getElementById('deviceListPanel');

            editModeBtn.style.display = 'inline-flex';
            editModeBtn.innerHTML = '<i class="fas fa-eye" style="color: white;"></i><span>é¢„è§ˆ</span>';
            editModeBtn.className = 'toolbar-btn';
            editModeBtn.style.background = '#6b7280';
            editModeBtn.style.borderColor = '#6b7280';
            editModeBtn.style.color = 'white';
            editModeBtn.title = 'åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼';
            saveBtn.style.display = 'inline-flex';
            document.getElementById('alignmentBtns').style.display = 'flex';
            deviceListPanel.style.display = 'block';

            // é‡æ–°æ¸²æŸ“è®¾å¤‡ä»¥æ˜¾ç¤ºåˆ é™¤æŒ‰é’®å’Œè¿æ¥ç‚¹
            renderPlacedDevices();

            // å¯ç”¨æ‰€æœ‰å·²æ”¾ç½®è®¾å¤‡çš„æ‹–æ‹½å’Œè¿çº¿åŠŸèƒ½
            const placedDeviceElements = document.querySelectorAll('.placed-device');
            placedDeviceElements.forEach(el => {
                el.style.cursor = 'move';
            });
        }

        // åˆ‡æ¢ç¼–è¾‘/é¢„è§ˆæ¨¡å¼
        function toggleEditMode() {
            isEditMode = !isEditMode;
            console.log('ğŸ”„ åˆ‡æ¢ç¼–è¾‘æ¨¡å¼ï¼Œå½“å‰çŠ¶æ€:', isEditMode ? 'ç¼–è¾‘æ¨¡å¼' : 'é¢„è§ˆæ¨¡å¼');

            const editModeBtn = document.getElementById('editModeBtn');
            const saveBtn = document.getElementById('saveBtn');
            const deviceListPanel = document.getElementById('deviceListPanel');

            if (isEditMode) {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                console.log('âœï¸ è¿›å…¥ç¼–è¾‘æ¨¡å¼');
                editModeBtn.style.display = 'inline-flex'; // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®
                editModeBtn.innerHTML = '<i class="fas fa-eye" style="color: white;"></i><span>é¢„è§ˆ</span>';
                editModeBtn.className = 'toolbar-btn';
                editModeBtn.style.background = '#6b7280';
                editModeBtn.style.borderColor = '#6b7280';
                editModeBtn.style.color = 'white';
                editModeBtn.title = 'åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼';
                saveBtn.style.display = 'inline-flex'; // æ˜¾ç¤ºä¿å­˜æŒ‰é’®
                document.getElementById('alignmentBtns').style.display = 'flex'; // æ˜¾ç¤ºå¯¹é½æŒ‰é’®ç»„
                deviceListPanel.style.display = 'block';

                // é‡æ–°æ¸²æŸ“è®¾å¤‡ä»¥æ˜¾ç¤ºåˆ é™¤æŒ‰é’®å’Œè¿æ¥ç‚¹
                renderPlacedDevices();

                // å¯ç”¨æ‰€æœ‰å·²æ”¾ç½®è®¾å¤‡çš„æ‹–æ‹½å’Œè¿çº¿åŠŸèƒ½
                const placedDeviceElements = document.querySelectorAll('.placed-device');
                placedDeviceElements.forEach(el => {
                    el.style.cursor = 'move';
                });
            } else {
                // è¿›å…¥é¢„è§ˆæ¨¡å¼
                console.log('ğŸ‘ï¸ è¿›å…¥é¢„è§ˆæ¨¡å¼');
                editModeBtn.style.display = 'inline-flex'; // æ˜¾ç¤ºæŒ‰é’®
                editModeBtn.innerHTML = '<i class="fas fa-edit"></i><span>è¿”å›ç¼–è¾‘</span>';
                editModeBtn.className = 'toolbar-btn primary';
                editModeBtn.style.background = '';
                editModeBtn.style.borderColor = '';
                editModeBtn.style.color = '';
                editModeBtn.title = 'è¿”å›ç¼–è¾‘æ¨¡å¼';
                saveBtn.style.display = 'none'; // éšè—ä¿å­˜æŒ‰é’®
                document.getElementById('alignmentBtns').style.display = 'none'; // éšè—å¯¹é½æŒ‰é’®ç»„
                deviceListPanel.style.display = 'none';

                // éšè—å³ä¾§è®¾ç½®é¢æ¿
                const settingsPanel = document.getElementById('deviceSettingsPanel');
                if (settingsPanel) settingsPanel.style.display = 'none';

                // ç¦ç”¨æ‰€æœ‰å·²æ”¾ç½®è®¾å¤‡çš„æ‹–æ‹½å’Œè¿çº¿åŠŸèƒ½
                const placedDeviceElements = document.querySelectorAll('.placed-device');
                placedDeviceElements.forEach(el => {
                    el.style.cursor = 'default';
                });

                // å–æ¶ˆæ‰€æœ‰é€‰ä¸­çŠ¶æ€
                selectedDevice = null;
                selectedConnection = null;
                connectionStart = null;
                isDraggingConnection = false;
                renderPlacedDevices();

                // å±…ä¸­æ˜¾ç¤ºç”»å¸ƒå†…å®¹
                console.log('â±ï¸ å»¶è¿Ÿ100msåè°ƒç”¨å±…ä¸­å‡½æ•°');
                setTimeout(() => {
                    centerCanvasContent();
                }, 100);
            }
        }

        // è‡ªåŠ¨ä¿®å¤å¸‚ç”µåˆ°å‚¨èƒ½æŸœçš„è¿çº¿è·¯å¾„
        function fixUtilityToStorageConnection() {
            console.log('ğŸ”§ æ£€æŸ¥å¹¶ä¿®å¤å¸‚ç”µåˆ°å‚¨èƒ½æŸœçš„è¿çº¿...');

            // æŸ¥æ‰¾å¸‚ç”µåˆ°å‚¨èƒ½æŸœçš„è¿çº¿ï¼ˆæ”¯æŒå¤šç§IDæ ¼å¼ï¼‰
            const connIndex = deviceConnections.findIndex(conn => {
                const fromId = conn.from.toLowerCase();
                const toId = conn.to.toLowerCase();

                const isFromUtility = fromId.includes('grid-1') || fromId.includes('utility') || fromId.includes('å¸‚ç”µ');
                const isToStorage = toId.includes('storage') || toId.includes('å‚¨èƒ½') || toId.includes('battery');

                const isFromStorage = fromId.includes('storage') || fromId.includes('å‚¨èƒ½') || fromId.includes('battery');
                const isToUtility = toId.includes('grid-1') || toId.includes('utility') || toId.includes('å¸‚ç”µ');

                return (isFromUtility && isToStorage) || (isFromStorage && isToUtility);
            });

            if (connIndex === -1) {
                console.log('âš ï¸ æœªæ‰¾åˆ°å¸‚ç”µåˆ°å‚¨èƒ½æŸœçš„è¿çº¿');
                return;
            }

            const conn = deviceConnections[connIndex];
            console.log('âœ… æ‰¾åˆ°è¿çº¿:', conn);

            // è·å–ä¸¤ä¸ªè®¾å¤‡
            const fromDevice = placedDevices.find(d => d.id === conn.from);
            const toDevice = placedDevices.find(d => d.id === conn.to);

            if (!fromDevice || !toDevice) {
                console.log('âš ï¸ è®¾å¤‡æœªæ‰¾åˆ°');
                return;
            }

            console.log('ğŸ“ å¸‚ç”µä½ç½®:', fromDevice.x, fromDevice.y);
            console.log('ğŸ“ å‚¨èƒ½æŸœä½ç½®:', toDevice.x, toDevice.y);

            // å¦‚æœå·²ç»æœ‰æ§åˆ¶ç‚¹ï¼Œè·³è¿‡
            if (conn.controlPoints && conn.controlPoints.length > 0) {
                console.log('â„¹ï¸ è¿çº¿å·²æœ‰æ§åˆ¶ç‚¹ï¼Œè·³è¿‡ä¿®å¤');
                return;
            }

            // è®¡ç®—æ§åˆ¶ç‚¹ä½ç½®ï¼ˆåªè¦ä¸€ä¸ªæ‹ç‚¹ï¼‰
            const fromCenterX = fromDevice.x + 70; // è®¾å¤‡ä¸­å¿ƒXï¼ˆå‡è®¾è®¾å¤‡å®½åº¦140pxï¼‰
            const fromCenterY = fromDevice.y + 75; // è®¾å¤‡ä¸­å¿ƒY
            const toCenterX = toDevice.x + 70;
            const toCenterY = toDevice.y + 75;

            // è®¡ç®—æ‹ç‚¹ï¼šä»å¸‚ç”µå‚ç›´å‘ä¸‹åˆ°å‚¨èƒ½æŸœYåæ ‡çš„ä¸­ç‚¹
            const cornerY = (fromCenterY + toCenterY) / 2;

            // åªæ·»åŠ ä¸€ä¸ªæ§åˆ¶ç‚¹ï¼ˆä»å¸‚ç”µå‚ç›´å‘ä¸‹åæ‹å¼¯ï¼‰
            conn.controlPoints = [
                { x: fromCenterX, y: cornerY }  // æ‹ç‚¹ï¼šå¸‚ç”µä¸‹æ–¹ï¼Œç„¶åæ–œå‘å‚¨èƒ½æŸœ
            ];

            // è°ƒæ•´è¿æ¥æ–¹å‘
            conn.fromDirection = 'bottom';
            conn.toDirection = 'top';

            console.log('âœ… å·²æ·»åŠ æ§åˆ¶ç‚¹:', conn.controlPoints);

            // é‡æ–°ç»˜åˆ¶è¿çº¿
            drawAllConnections();

            // ä¿å­˜é…ç½®
            saveToLocalStorage();

            console.log('ğŸ‰ è¿çº¿è·¯å¾„ä¿®å¤å®Œæˆï¼');
        }

        // åˆå§‹åŒ–èƒ½é‡æµè§†å›¾
        function initEnergyFlow() {
            // åˆå§‹åŒ–ä¸ºé¢„è§ˆæ¨¡å¼ï¼Œéšè—è®¾å¤‡åˆ—è¡¨å’Œè®¾ç½®é¢æ¿
            const deviceListPanel = document.getElementById('deviceListPanel');
            if (deviceListPanel) deviceListPanel.style.display = 'none';

            const settingsPanel = document.getElementById('deviceSettingsPanel');
            if (settingsPanel) settingsPanel.style.display = 'none';

            loadAvailableDevices();
            loadSavedConfig();

            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é…ç½®ï¼ˆç¬¬ä¸€æ¬¡è®¿é—®ï¼‰ï¼Œè‡ªåŠ¨åº”ç”¨é»˜è®¤å¸ƒå±€
            if (placedDevices.length === 0) {
                console.log('ğŸ¯ æœªæ‰¾åˆ°ä¿å­˜çš„é…ç½®ï¼Œè‡ªåŠ¨åº”ç”¨é»˜è®¤èƒ½é‡æµå¸ƒå±€');
                applyGridLayout();
            } else {
                renderPlacedDevices();
            }

            // è‡ªåŠ¨ä¿®å¤å¸‚ç”µåˆ°å‚¨èƒ½æŸœçš„è¿çº¿
            setTimeout(() => {
                fixUtilityToStorageConnection();
            }, 300);

            // åˆå§‹åŒ–åå±…ä¸­æ˜¾ç¤ºå†…å®¹
            setTimeout(() => {
                centerCanvasContent();
            }, 500);

            // æ·»åŠ å…¨å±€é¼ æ ‡äº‹ä»¶ç›‘å¬å™¨ï¼Œç”¨äºè¿çº¿æ‹–æ‹½
            const canvas = document.getElementById('energyFlowCanvas');

            // é¼ æ ‡ç§»åŠ¨æ—¶æ›´æ–°ä¸´æ—¶è¿çº¿æˆ–æ§åˆ¶ç‚¹ä½ç½®
            canvas.addEventListener('mousemove', function(event) {
                const canvasRect = canvas.getBoundingClientRect();
                const x = event.clientX - canvasRect.left;
                const y = event.clientY - canvasRect.top;

                // å¦‚æœæ­£åœ¨æ‹–æ‹½æ§åˆ¶ç‚¹
                if (isDraggingControlPoint && selectedConnection !== null && draggingControlPointIndex !== null) {
                    // æ›´æ–°æ§åˆ¶ç‚¹ä½ç½®
                    if (deviceConnections[selectedConnection] && deviceConnections[selectedConnection].controlPoints) {
                        deviceConnections[selectedConnection].controlPoints[draggingControlPointIndex] = { x, y };
                        drawAllConnections();
                    }
                }
                // å¦‚æœæ­£åœ¨æ‹–æ‹½åˆ›å»ºè¿çº¿
                else if (isDraggingConnection && connectionStart) {
                    updateTempConnectionLine(x, y);

                    // æ£€æŸ¥æ˜¯å¦æ‚¬åœåœ¨è¿æ¥ç‚¹ä¸Šï¼Œé«˜äº®æ˜¾ç¤º
                    const target = document.elementFromPoint(event.clientX, event.clientY);
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                    if (target && target.classList.contains('connection-point')) {
                        const targetDeviceId = target.getAttribute('data-device-id');
                        if (targetDeviceId !== connectionStart.deviceId) {
                            target.style.transform = 'translate(-50%, -50%) scale(1.5)';
                            target.style.width = '18px';
                            target.style.height = '18px';
                        }
                    }
                }
            });

            // é¼ æ ‡æ¾å¼€æ—¶å®Œæˆè¿çº¿æˆ–ç»“æŸæ§åˆ¶ç‚¹æ‹–æ‹½
            canvas.addEventListener('mouseup', function(event) {
                // ç»“æŸæ§åˆ¶ç‚¹æ‹–æ‹½
                if (isDraggingControlPoint) {
                    isDraggingControlPoint = false;
                    draggingControlPointIndex = null;
                    document.body.style.cursor = '';
                }
                // ç»“æŸè¿çº¿æ‹–æ‹½
                else if (isDraggingConnection) {
                    endConnectionDrag(event);
                    // é‡ç½®æ‰€æœ‰è¿æ¥ç‚¹æ ·å¼
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                }
            });

            // é¼ æ ‡ç¦»å¼€ç”»å¸ƒæ—¶ä¹Ÿç»“æŸè¿çº¿
            canvas.addEventListener('mouseleave', function(event) {
                if (isDraggingConnection) {
                    endConnectionDrag(event);
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                }
            });

            // åœ¨å…¨å±€ document çº§åˆ«ä¹Ÿç›‘å¬ mouseupï¼Œä»¥é˜² canvas äº‹ä»¶è¢«é˜»æ­¢
            document.addEventListener('mouseup', function(event) {
                // ç»“æŸæ§åˆ¶ç‚¹æ‹–æ‹½
                if (isDraggingControlPoint) {
                    isDraggingControlPoint = false;
                    draggingControlPointIndex = null;
                    document.body.style.cursor = '';
                }
                // ç»“æŸè¿çº¿æ‹–æ‹½
                else if (isDraggingConnection) {
                    endConnectionDrag(event);
                    // é‡ç½®æ‰€æœ‰è¿æ¥ç‚¹æ ·å¼
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                }
            });

            // ç‚¹å‡»ç”»å¸ƒç©ºç™½å¤„å–æ¶ˆé€‰ä¸­
            canvas.addEventListener('click', function(event) {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¿çº¿ã€æ§åˆ¶ç‚¹æˆ–è®¾å¤‡ï¼Œåˆ™å–æ¶ˆé€‰ä¸­
                if (event.target === canvas || event.target.id === 'energyConnections') {
                    if (selectedConnection !== null) {
                        selectedConnection = null;
                        drawAllConnections();
                    }
                }
            });

            // æš´éœ²å˜é‡å’Œå‡½æ•°åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œæµ‹è¯•
            window.placedDevices = placedDevices;
            window.deviceConnections = deviceConnections;
            window.selectedConnection = selectedConnection;
            window.renderPlacedDevices = renderPlacedDevices;
            window.drawAllConnections = drawAllConnections;
            window.selectConnection = selectConnection;
            window.availableDevices = availableDevices;
        }

        // åŠ è½½å¯ç”¨è®¾å¤‡åˆ—è¡¨ï¼ˆè¿‡æ»¤å·²æ”¾ç½®çš„è®¾å¤‡ï¼‰
        function loadAvailableDevices() {
            // è·å–å·²æ”¾ç½®è®¾å¤‡çš„IDåˆ—è¡¨
            const placedDeviceIds = placedDevices.map(d => d.id);

            // æ¸²æŸ“ç”µæºè®¾å¤‡ï¼ˆè¿‡æ»¤å·²æ”¾ç½®çš„ï¼‰
            const powerList = document.getElementById('powerDevicesList');
            const availablePower = availableDevices.power.filter(d => !placedDeviceIds.includes(d.id));
            powerList.innerHTML = availablePower.map(device => `
                <div class="device-item" draggable="true" ondragstart="startDragDevice(event, '${device.id}', 'power')">
                    <div class="device-item-icon">
                        <img src="${device.icon}" alt="${device.label}" style="width: 32px; height: 32px; object-fit: contain;" />
                    </div>
                    <div class="device-item-info">
                        <div class="device-item-name">${device.label}</div>
                    </div>
                </div>
            `).join('');

            // æ¸²æŸ“å‚¨èƒ½è®¾å¤‡ï¼ˆè¿‡æ»¤å·²æ”¾ç½®çš„ï¼‰
            const storageList = document.getElementById('storageDevicesList');
            const availableStorage = availableDevices.storage.filter(d => !placedDeviceIds.includes(d.id));
            storageList.innerHTML = availableStorage.map(device => `
                <div class="device-item" draggable="true" ondragstart="startDragDevice(event, '${device.id}', 'storage')">
                    <div class="device-item-icon">
                        <img src="${device.icon}" alt="${device.label}" style="width: 32px; height: 32px; object-fit: contain;" />
                    </div>
                    <div class="device-item-info">
                        <div class="device-item-name">${device.label}</div>
                    </div>
                </div>
            `).join('');

            // æ¸²æŸ“è´Ÿè½½è®¾å¤‡ï¼ˆè¿‡æ»¤å·²æ”¾ç½®çš„ï¼‰
            const loadList = document.getElementById('loadDevicesList');
            const availableLoad = availableDevices.load.filter(d => !placedDeviceIds.includes(d.id));
            loadList.innerHTML = availableLoad.map(device => `
                <div class="device-item" draggable="true" ondragstart="startDragDevice(event, '${device.id}', 'load')">
                    <div class="device-item-icon">
                        <img src="${device.icon}" alt="${device.label}" style="width: 32px; height: 32px; object-fit: contain;" />
                    </div>
                    <div class="device-item-info">
                        <div class="device-item-name">${device.label}</div>
                    </div>
                </div>
            `).join('');
        }

        // å¼€å§‹æ‹–æ‹½è®¾å¤‡
        function startDragDevice(event, deviceId, category) {
            // ä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å…è®¸æ‹–æ‹½
            if (!isEditMode) {
                event.preventDefault();
                return;
            }
            const device = availableDevices[category].find(d => d.id === deviceId);
            draggedDeviceData = { ...device, category };
            event.dataTransfer.effectAllowed = 'copy';
            event.dataTransfer.setData('text/plain', deviceId);
        }

        // å…è®¸æ”¾ç½®
        function allowDrop(event) {
            event.preventDefault();
            // æ ¹æ®æ‹–æ‹½ç±»å‹è®¾ç½®ä¸åŒçš„ dropEffect
            if (isDraggingPlacedDevice) {
                event.dataTransfer.dropEffect = 'move';
            } else {
                event.dataTransfer.dropEffect = 'copy';
            }
        }

        // æ”¾ç½®è®¾å¤‡ï¼ˆè‡ªç”±ç”»å¸ƒï¼‰
        function dropDevice(event) {
            event.preventDefault();

            // ä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å…è®¸æ”¾ç½®
            if (!isEditMode) {
                return;
            }

            const canvas = document.getElementById('devicesContainer');
            const canvasRect = canvas.getBoundingClientRect();

            // è®¡ç®—æ”¾ç½®ä½ç½®ï¼ˆç›¸å¯¹äºç”»å¸ƒï¼‰
            const x = event.clientX - canvasRect.left;
            const y = event.clientY - canvasRect.top;

            // å¤„ç†ä»è®¾å¤‡åˆ—è¡¨æ‹–æ¥çš„æ–°è®¾å¤‡
            if (draggedDeviceData && !isDraggingPlacedDevice) {
                // æ£€æŸ¥è®¾å¤‡æ˜¯å¦å·²ç»åœ¨ç”»å¸ƒä¸Š
                const alreadyPlaced = placedDevices.some(d => d.id === draggedDeviceData.id);
                if (alreadyPlaced) {
                    showMiniToast('âš ï¸ è¯¥è®¾å¤‡å·²åœ¨ç”»å¸ƒä¸Š', 'warning');
                    draggedDeviceData = null;
                    return;
                }

                // æ·»åŠ åˆ°ç”»å¸ƒ
                placedDevices.push({
                    ...draggedDeviceData,
                    x: Math.max(0, x - 60), // å±…ä¸­æ”¾ç½®ï¼Œ60æ˜¯è®¾å¤‡å®½åº¦çš„ä¸€åŠ
                    y: Math.max(0, y - 60),
                    power: Math.random() * 100 + 50,
                    voltage: 380 + Math.random() * 20,
                    current: 100 + Math.random() * 50,
                    soc: 50 + Math.random() * 40,
                    displayParams: {
                        power: { enabled: false, x: 120, y: 0 },
                        voltage: { enabled: false, x: 120, y: 30 },
                        current: { enabled: false, x: 120, y: 60 },
                        soc: { enabled: false, x: 120, y: 90 }
                    },
                    flowControl: {
                        inAttribute: 'power',   // é»˜è®¤ä½¿ç”¨åŠŸç‡åˆ¤æ–­æµå…¥
                        outAttribute: 'power'   // é»˜è®¤ä½¿ç”¨åŠŸç‡åˆ¤æ–­æµå‡º
                    }
                });

                draggedDeviceData = null;

                // é‡æ–°æ¸²æŸ“è®¾å¤‡åˆ—è¡¨ï¼ˆç§»é™¤å·²æ”¾ç½®çš„è®¾å¤‡ï¼‰
                loadAvailableDevices();
            }
            // å¤„ç†ç”»å¸ƒå†…å·²æ”¾ç½®è®¾å¤‡çš„ç§»åŠ¨
            else if (draggedPlacedDevice && isDraggingPlacedDevice) {
                const { deviceId } = draggedPlacedDevice;

                // æŸ¥æ‰¾è®¾å¤‡å¹¶æ›´æ–°ä½ç½®
                const device = placedDevices.find(d => d.id === deviceId);
                if (device) {
                    device.x = Math.max(0, x - 60);
                    device.y = Math.max(0, y - 60);
                }
            }

            renderPlacedDevices();
            drawAllConnections();
        }

        // å¼€å§‹æ‹–æ‹½å·²æ”¾ç½®çš„è®¾å¤‡
        function startDragPlacedDevice(event, deviceId) {
            isDraggingPlacedDevice = true;
            draggedPlacedDevice = { deviceId };
            draggedDeviceData = null; // ç¡®ä¿æ¸…ç©ºæ–°è®¾å¤‡æ•°æ®

            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', deviceId);

            // è®¾ç½®æ‹–æ‹½æ—¶çš„é€æ˜åº¦
            const deviceElement = document.getElementById(`placed-${deviceId}`);
            if (deviceElement) {
                deviceElement.style.opacity = '0.5';
            }
        }

        // ç»“æŸæ‹–æ‹½å·²æ”¾ç½®çš„è®¾å¤‡
        function endDragPlacedDevice(event) {
            // æ¢å¤é€æ˜åº¦
            event.target.style.opacity = '1';

            // å»¶è¿Ÿæ¸…ç†ï¼Œç¡®ä¿ drop äº‹ä»¶å…ˆæ‰§è¡Œ
            setTimeout(() => {
                isDraggingPlacedDevice = false;
                draggedPlacedDevice = null;
            }, 100);
        }

        // æ¸²æŸ“å·²æ”¾ç½®çš„è®¾å¤‡ï¼ˆè‡ªç”±ç”»å¸ƒï¼‰
        function renderPlacedDevices() {
            const container = document.getElementById('devicesContainer');

            container.innerHTML = placedDevices.map(device => {
                // è®¾ç½®è®¾å¤‡ä½ç½®
                const left = device.x || 50;
                const top = device.y || 50;

                // å¤–éƒ¨å‚æ•° - æ¯ä¸ªå‚æ•°ç‹¬ç«‹å¯æ‹–æ‹½
                let externalParams = '';
                if (device.displayParams) {
                    const paramsList = [];

                    // åŠŸç‡å‚æ•°
                    if (device.displayParams.power.enabled && device.power !== undefined) {
                        const pos = device.displayParams.power;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'power')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>P: ${device.power.toFixed(1)} kW</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'power\')">Ã—</span>' : ''}
                            </div>
                        `);
                    }

                    // ç”µå‹å‚æ•°
                    if (device.displayParams.voltage.enabled && device.voltage !== undefined) {
                        const pos = device.displayParams.voltage;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'voltage')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>U: ${device.voltage.toFixed(1)} V</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'voltage\')">Ã—</span>' : ''}
                            </div>
                        `);
                    }

                    // ç”µæµå‚æ•°
                    if (device.displayParams.current.enabled && device.current !== undefined) {
                        const pos = device.displayParams.current;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'current')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>I: ${device.current.toFixed(1)} A</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'current\')">Ã—</span>' : ''}
                            </div>
                        `);
                    }

                    // SOCå‚æ•°
                    if (device.displayParams.soc.enabled && device.soc !== undefined) {
                        const pos = device.displayParams.soc;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'soc')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>SOC: ${device.soc.toFixed(1)} %</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'soc\')">Ã—</span>' : ''}
                            </div>
                        `);
                    }

                    externalParams = paramsList.join('');
                }

                let html = `
                    <div class="flow-device"
                         id="placed-${device.id}"
                         draggable="${isEditMode}"
                         ondragstart="startDragPlacedDevice(event, '${device.id}')"
                         ondragend="endDragPlacedDevice(event)"
                         onmousedown="handleDeviceMouseDown(event, '${device.id}')"
                         data-device-id="${device.id}"
                         style="position: absolute; left: ${left}px; top: ${top}px; cursor: ${isEditMode ? 'pointer' : 'default'};">

                        <!-- è®¾å¤‡åˆ é™¤æŒ‰é’®ï¼ˆä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                        ${isEditMode ? '<span class="device-delete-btn" onclick="deleteDevice(event, \'' + device.id + '\')">Ã—</span>' : ''}

                        <!-- è¿æ¥ç‚¹å®¹å™¨ï¼ˆä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                        <div class="connection-points" style="display: ${isEditMode ? 'block' : 'none'};">
                            <div class="connection-point top" data-device-id="${device.id}" data-direction="top"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'top')"
                                 draggable="false"></div>
                            <div class="connection-point bottom" data-device-id="${device.id}" data-direction="bottom"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'bottom')"
                                 draggable="false"></div>
                            <div class="connection-point left" data-device-id="${device.id}" data-direction="left"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'left')"
                                 draggable="false"></div>
                            <div class="connection-point right" data-device-id="${device.id}" data-direction="right"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'right')"
                                 draggable="false"></div>
                        </div>

                        <div class="flow-device-icon">
                            <img src="${device.icon}" alt="${device.label}" draggable="false" />
                        </div>
                        <div class="flow-device-label" draggable="false">${device.label}</div>

                        ${externalParams}
                    </div>`;
                return html;
            }).join('');

            // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä»…åœ¨è¿çº¿æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼‰
            attachDeviceClickListeners();

            // é‡æ–°ç»˜åˆ¶è¿æ¥çº¿ï¼ˆåº”ç”¨æµå‘åŠ¨ç”»ï¼‰
            drawAllConnections();
        }

        // ç»‘å®šè®¾å¤‡ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
        function attachDeviceClickListeners() {
            const devices = document.querySelectorAll('.flow-device');
            devices.forEach(deviceEl => {
                deviceEl.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ç§»é™¤æŒ‰é’®æˆ–è¿æ¥ç‚¹ï¼Œä¸å¤„ç†
                    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('connection-point')) {
                        return;
                    }

                    // å¦‚æœåˆšåˆšå®Œæˆæ‹–æ‹½ï¼Œå¿½ç•¥ç‚¹å‡»
                    if (isDraggingPlacedDevice) {
                        return;
                    }

                    const deviceId = this.getAttribute('data-device-id');
                    const event = window.event || e;

                    // åœ¨é¢„è§ˆæ¨¡å¼ä¸‹æ‰“å¼€è®¾å¤‡è¯¦æƒ…é¢æ¿
                    if (!isEditMode) {
                        openDevicePanel(deviceId);
                        return;
                    }

                    // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹åˆ‡æ¢è®¾å¤‡é€‰ä¸­çŠ¶æ€
                    toggleDeviceSelection(deviceId, event);
                });
            });
        }

        // åˆ‡æ¢è®¾å¤‡é€‰ä¸­çŠ¶æ€ï¼ˆæ”¯æŒShiftå¤šé€‰ï¼‰
        function toggleDeviceSelection(deviceId, event) {
            const element = document.getElementById(`placed-${deviceId}`);
            if (!element) return;

            // æ£€æŸ¥æ˜¯å¦æŒ‰ä½äº† Shift é”®
            const isMultiSelect = event && event.shiftKey;

            if (isMultiSelect) {
                // å¤šé€‰æ¨¡å¼ï¼šåˆ‡æ¢å½“å‰è®¾å¤‡çš„é€‰ä¸­çŠ¶æ€
                if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                } else {
                    element.classList.add('selected');
                }
            } else {
                // å•é€‰æ¨¡å¼ï¼šæ¸…é™¤å…¶ä»–è®¾å¤‡çš„é€‰ä¸­ï¼Œåªé€‰ä¸­å½“å‰è®¾å¤‡
                const allDevices = document.querySelectorAll('.flow-device');
                allDevices.forEach(dev => {
                    if (dev.id !== `placed-${deviceId}`) {
                        dev.classList.remove('selected');
                    }
                });

                // åˆ‡æ¢å½“å‰è®¾å¤‡
                if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                    selectedDevice = null;
                } else {
                    element.classList.add('selected');
                    selectedDevice = deviceId;
                }
            }

            // æ˜¾ç¤ºæç¤º
            const selectedCount = document.querySelectorAll('.flow-device.selected').length;
            if (selectedCount > 1) {
                showMiniToast(`âœ… å·²é€‰ä¸­ ${selectedCount} ä¸ªè®¾å¤‡`);
            }
        }

        // å¼€å§‹æ‹–æ‹½è¿çº¿
        function startConnectionDrag(event, deviceId, direction) {
            event.stopPropagation();
            event.preventDefault();

            // ä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å…è®¸è¿çº¿
            if (!isEditMode) {
                return;
            }

            isDraggingConnection = true;

            // è·å–è¿æ¥ç‚¹çš„ç»å¯¹ä½ç½®
            const pointElement = event.target;
            const pointRect = pointElement.getBoundingClientRect();
            const canvas = document.getElementById('energyFlowCanvas');
            const canvasRect = canvas.getBoundingClientRect();

            const x = pointRect.left + pointRect.width / 2 - canvasRect.left;
            const y = pointRect.top + pointRect.height / 2 - canvasRect.top;

            connectionStart = { deviceId, direction, x, y };

            // é€‰ä¸­èµ·å§‹è®¾å¤‡
            const element = document.getElementById(`placed-${deviceId}`);
            if (element) {
                element.classList.add('selected');
                selectedDevice = deviceId;
            }

            // åˆ›å»ºä¸´æ—¶è¿çº¿
            createTempConnectionLine(x, y, x, y);
        }

        // åˆ›å»ºä¸´æ—¶è¿çº¿
        function createTempConnectionLine(x1, y1, x2, y2) {
            const svg = document.getElementById('energyConnections');

            // ç§»é™¤æ—§çš„ä¸´æ—¶çº¿
            if (tempConnectionLine) {
                tempConnectionLine.remove();
            }

            // åˆ›å»ºæ–°çš„ä¸´æ—¶çº¿
            tempConnectionLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const pathData = `M ${x1} ${y1} L ${x2} ${y2}`;
            tempConnectionLine.setAttribute('d', pathData);
            tempConnectionLine.setAttribute('stroke', '#3562E3');
            tempConnectionLine.setAttribute('stroke-width', '3');
            tempConnectionLine.setAttribute('stroke-dasharray', '8 4');
            tempConnectionLine.setAttribute('fill', 'none');
            tempConnectionLine.style.opacity = '0.7';

            svg.appendChild(tempConnectionLine);
        }

        // æ›´æ–°ä¸´æ—¶è¿çº¿
        function updateTempConnectionLine(x2, y2) {
            if (!tempConnectionLine || !connectionStart) return;

            const pathData = `M ${connectionStart.x} ${connectionStart.y} L ${x2} ${y2}`;
            tempConnectionLine.setAttribute('d', pathData);
        }

        // å®Œæˆè¿çº¿æ‹–æ‹½
        function endConnectionDrag(event) {
            if (!isDraggingConnection || !connectionStart) {
                return;
            }

            // æ£€æŸ¥é¼ æ ‡æ˜¯å¦åœ¨æŸä¸ªè¿æ¥ç‚¹ä¸Š
            const target = document.elementFromPoint(event.clientX, event.clientY);

            if (target && target.classList.contains('connection-point')) {
                const toDeviceId = target.getAttribute('data-device-id');
                const toDirection = target.getAttribute('data-direction');

                // ä¸èƒ½è¿æ¥åˆ°åŒä¸€ä¸ªè®¾å¤‡
                if (toDeviceId !== connectionStart.deviceId) {
                    const fromDevice = placedDevices.find(d => d.id === connectionStart.deviceId);
                    const toDevice = placedDevices.find(d => d.id === toDeviceId);

                    // æ·»åŠ è¿æ¥ï¼ˆä¸è‡ªåŠ¨åˆ›å»ºæ§åˆ¶ç‚¹ï¼Œä½¿ç”¨æ™ºèƒ½è·¯å¾„ï¼‰
                    deviceConnections.push({
                        from: connectionStart.deviceId,
                        fromDirection: connectionStart.direction,
                        to: toDeviceId,
                        toDirection: toDirection,
                        controlPoints: [], // ç©ºæ•°ç»„ï¼Œä½¿ç”¨æ™ºèƒ½è·¯å¾„
                        pathMode: 'orthogonal' // é»˜è®¤ä½¿ç”¨æ­£äº¤æ¨¡å¼
                    });

                    drawAllConnections();
                    showMiniToast(`âœ… è¿æ¥æˆåŠŸï¼<br>${fromDevice.label} â¡ï¸ ${toDevice.label}`);
                }
            }

            // æ¸…ç†çŠ¶æ€
            isDraggingConnection = false;
            connectionStart = null;

            // ç§»é™¤ä¸´æ—¶çº¿
            if (tempConnectionLine) {
                tempConnectionLine.remove();
                tempConnectionLine = null;
            }

            // æ¸…é™¤é€‰ä¸­çŠ¶æ€
            if (selectedDevice) {
                const element = document.getElementById(`placed-${selectedDevice}`);
                if (element) {
                    element.classList.remove('selected');
                }
                selectedDevice = null;
            }
        }

        // è·å–æ–¹å‘åç§°ï¼ˆä¸­æ–‡ï¼‰
        function getDirectionName(direction) {
            const names = {
                'top': 'ä¸Š',
                'bottom': 'ä¸‹',
                'left': 'å·¦',
                'right': 'å³'
            };
            return names[direction] || direction;
        }

        // æ˜¾ç¤ºå°å‹æç¤ºæ¶ˆæ¯
        function showMiniToast(message, type = 'info') {
            // ç§»é™¤æ—§æç¤º
            const oldToast = document.getElementById('miniToast');
            if (oldToast) oldToast.remove();

            // æ ¹æ®ç±»å‹é€‰æ‹©æ ·å¼
            let bgColor, iconSymbol;
            if (type === 'success') {
                bgColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                iconSymbol = 'âœ“';
            } else if (type === 'warning') {
                bgColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                iconSymbol = 'âš ';
            } else if (type === 'error') {
                bgColor = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                iconSymbol = 'âœ—';
            } else {
                bgColor = 'linear-gradient(135deg, #00d9ff 0%, #0099cc 100%)';
                iconSymbol = 'â„¹';
            }

            const toast = document.createElement('div');
            toast.id = 'miniToast';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                z-index: 99999;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
                pointer-events: none;
                animation: slideDown 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            `;

            toast.innerHTML = `
                <span style="font-size: 18px; font-weight: bold;">${iconSymbol}</span>
                <span>${message}</span>
            `;

            // æ·»åŠ æ»‘å…¥åŠ¨ç”»
            if (!document.getElementById('toastAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'toastAnimationStyle';
                style.textContent = `
                    @keyframes slideDown {
                        from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                        to { opacity: 1; transform: translateX(-50%) translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }

            // æ·»åŠ åˆ° body è€Œä¸æ˜¯ canvasï¼Œç¡®ä¿å¯è§
            document.body.appendChild(toast);

            // 2ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => {
                        if (toast && toast.parentNode) toast.remove();
                    }, 300);
                }
            }, 2000);
        }

        // ç§»é™¤è®¾å¤‡
        function removeDevice(deviceId, event) {
            event.stopPropagation();

            if (!confirm('ç¡®å®šè¦ç§»é™¤è¯¥è®¾å¤‡å—ï¼Ÿ')) {
                return;
            }

            // ä»ç”»å¸ƒç§»é™¤è®¾å¤‡
            placedDevices = placedDevices.filter(d => d.id !== deviceId);

            // ç§»é™¤æ¶‰åŠè¯¥è®¾å¤‡çš„æ‰€æœ‰è¿æ¥
            deviceConnections = deviceConnections.filter(
                conn => conn.from !== deviceId && conn.to !== deviceId
            );

            renderPlacedDevices();
            drawAllConnections();
            loadAvailableDevices(); // åˆ·æ–°è®¾å¤‡åˆ—è¡¨ï¼Œä½¿ç§»é™¤çš„è®¾å¤‡é‡æ–°æ˜¾ç¤º
        }

        // ç»˜åˆ¶æ‰€æœ‰è¿æ¥çº¿ï¼ˆæ”¯æŒæ‹å¼¯ï¼Œè‡ªç”±ç”»å¸ƒï¼‰
        function drawAllConnections() {
            const svg = document.getElementById('energyConnections');
            svg.innerHTML = '';

            const canvasRect = document.getElementById('energyFlowCanvas').getBoundingClientRect();

            // åœ¨ç»˜åˆ¶å‰ï¼Œæ£€æŸ¥å¹¶ä¿®å¤å¸‚ç”µåˆ°å‚¨èƒ½æŸœçš„è¿çº¿
            deviceConnections.forEach((conn, index) => {
                const fromId = conn.from.toLowerCase();
                const toId = conn.to.toLowerCase();

                const isUtilityToStorage =
                    (fromId.includes('grid-1') || fromId.includes('utility') || fromId.includes('å¸‚ç”µ')) &&
                    (toId.includes('storage') || toId.includes('å‚¨èƒ½') || toId.includes('battery'));

                const isStorageToUtility =
                    (fromId.includes('storage') || fromId.includes('å‚¨èƒ½') || fromId.includes('battery')) &&
                    (toId.includes('grid-1') || toId.includes('utility') || toId.includes('å¸‚ç”µ'));

                // å¦‚æœæ˜¯å¸‚ç”µå’Œå‚¨èƒ½æŸœä¹‹é—´çš„è¿çº¿ï¼Œä¸”æ²¡æœ‰æ§åˆ¶ç‚¹
                if ((isUtilityToStorage || isStorageToUtility) && (!conn.controlPoints || conn.controlPoints.length === 0)) {
                    const fromDevice = placedDevices.find(d => d.id === conn.from);
                    const toDevice = placedDevices.find(d => d.id === conn.to);

                    if (fromDevice && toDevice) {
                        // æ·»åŠ ä¸€ä¸ªæ‹ç‚¹
                        const fromX = fromDevice.x + 70;
                        const fromY = fromDevice.y + 75;
                        const toX = toDevice.x + 70;
                        const toY = toDevice.y + 75;

                        const cornerY = (fromY + toY) / 2;

                        conn.controlPoints = [{ x: fromX, y: cornerY }];
                        conn.fromDirection = 'bottom';
                        conn.toDirection = 'top';

                        console.log('âœ… è‡ªåŠ¨ä¿®å¤å¸‚ç”µ-å‚¨èƒ½æŸœè¿çº¿ï¼Œæ·»åŠ æ‹ç‚¹:', conn.controlPoints);
                    }
                }
            });

            // ç§»é™¤ç®­å¤´æ ‡è®°å®šä¹‰ - ç”¨æˆ·ä¸éœ€è¦ç®­å¤´
            // const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            // const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            // marker.id = 'arrowhead';
            // marker.setAttribute('markerWidth', '10');
            // marker.setAttribute('markerHeight', '10');
            // marker.setAttribute('refX', '9');
            // marker.setAttribute('refY', '3');
            // marker.setAttribute('orient', 'auto');

            // const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            // polygon.setAttribute('points', '0 0, 10 3, 0 6');
            // polygon.setAttribute('fill', '#3562E3');
            // marker.appendChild(polygon);
            // defs.appendChild(marker);
            // svg.appendChild(defs);

            // ç»˜åˆ¶æ¯æ¡è¿æ¥
            deviceConnections.forEach((conn, index) => {
                const fromElement = document.getElementById(`placed-${conn.from}`);
                const toElement = document.getElementById(`placed-${conn.to}`);

                if (fromElement && toElement) {
                    const fromRect = fromElement.getBoundingClientRect();
                    const toRect = toElement.getBoundingClientRect();

                    // è®¡ç®—èµ·ç‚¹å’Œç»ˆç‚¹è¿æ¥ç‚¹çš„ä½ç½®
                    const fromPoint = getConnectionPointPosition(fromRect, conn.fromDirection, canvasRect);
                    const toPoint = getConnectionPointPosition(toRect, conn.toDirection, canvasRect);

                    // è®¡ç®—è·¯å¾„ï¼ˆä½¿ç”¨æ§åˆ¶ç‚¹æˆ–è‡ªåŠ¨è®¡ç®—ï¼‰
                    let pathData;
                    // é»˜è®¤ä½¿ç”¨æ­£äº¤æ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡ conn.pathMode ä¿®æ”¹
                    const useOrthogonal = conn.pathMode !== 'straight'; // é»˜è®¤ä¸ºæ­£äº¤æ¨¡å¼ï¼Œé™¤éæ˜ç¡®è®¾ç½®ä¸ºç›´çº¿

                    if (conn.controlPoints && conn.controlPoints.length > 0) {
                        // ä½¿ç”¨è‡ªå®šä¹‰æ§åˆ¶ç‚¹è·¯å¾„
                        pathData = calculatePathWithControlPoints(fromPoint.x, fromPoint.y, toPoint.x, toPoint.y, conn.controlPoints, useOrthogonal);
                    } else {
                        // ä½¿ç”¨æ™ºèƒ½æ‹å¼¯è·¯å¾„
                        pathData = calculateOrthogonalPath(fromPoint.x, fromPoint.y, toPoint.x, toPoint.y);
                    }

                    // åˆ›å»ºå®½çš„é€æ˜è·¯å¾„ä½œä¸ºç‚¹å‡»åŒºåŸŸï¼ˆæ”¾åœ¨ä¸‹å±‚ï¼‰
                    const hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    hitArea.setAttribute('d', pathData);
                    hitArea.setAttribute('stroke', 'transparent');
                    hitArea.setAttribute('stroke-width', '20'); // æ›´å®½çš„ç‚¹å‡»åŒºåŸŸ
                    hitArea.setAttribute('fill', 'none');
                    hitArea.style.cursor = isEditMode ? 'pointer' : 'default'; // ç¼–è¾‘æ¨¡å¼æ‰æ˜¾ç¤ºæ‰‹å‹
                    hitArea.style.pointerEvents = 'stroke'; // å…è®¸hitAreaæ¥æ”¶é¼ æ ‡äº‹ä»¶
                    hitArea.setAttribute('data-connection-index', index);

                    // æ·»åŠ æ‚¬åœæ•ˆæœï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰
                    hitArea.addEventListener('mouseenter', () => {
                        if (isEditMode && selectedConnection !== index) {
                            path.setAttribute('stroke', '#00e5ff');
                            path.setAttribute('stroke-width', '4');
                        }
                    });

                    hitArea.addEventListener('mouseleave', () => {
                        if (isEditMode && selectedConnection !== index) {
                            path.setAttribute('stroke', '#3562E3');
                            path.setAttribute('stroke-width', '3');
                        }
                    });

                    // æ·»åŠ ç‚¹å‡»é€‰ä¸­åŠŸèƒ½ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰
                    hitArea.addEventListener('click', (e) => {
                        if (!isEditMode) return; // é¢„è§ˆæ¨¡å¼ä¸‹ä¸å“åº”ç‚¹å‡»
                        e.stopPropagation();
                        selectConnection(index);
                    });

                    // æ·»åŠ å³é”®èœå•ï¼ˆä»…åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰
                    hitArea.addEventListener('contextmenu', (e) => {
                        if (!isEditMode) return; // é¢„è§ˆæ¨¡å¼ä¸‹ä¸æ˜¾ç¤ºå³é”®èœå•
                        e.preventDefault();
                        e.stopPropagation();
                        showConnectionContextMenu(e, index);
                    });

                    svg.appendChild(hitArea);

                    // åˆ›å»ºå¯è§çš„è·¯å¾„å…ƒç´ ï¼ˆæ˜¾ç¤ºåœ¨ä¸Šå±‚ï¼‰
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);

                    // æ ¹æ®æ¨¡å¼è®¾ç½®é¢œè‰²
                    if (selectedConnection === index) {
                        // é€‰ä¸­çŠ¶æ€ï¼šæ©™è‰²
                        path.setAttribute('stroke', '#ffaa00');
                        path.setAttribute('stroke-width', '4');
                        path.style.filter = 'drop-shadow(0 0 8px rgba(255, 170, 0, 0.8))';
                    } else if (isEditMode) {
                        // ç¼–è¾‘æ¨¡å¼ï¼šè“è‰²
                        path.setAttribute('stroke', '#3562E3');
                        path.setAttribute('stroke-width', '3');
                        path.style.filter = 'drop-shadow(0 0 4px rgba(53, 98, 227, 0.6))';
                    } else {
                        // é¢„è§ˆæ¨¡å¼ï¼šç°è‰²
                        path.setAttribute('stroke', '#CCCCCC');
                        path.setAttribute('stroke-width', '4');
                    }

                    path.setAttribute('stroke-linecap', 'round');
                    path.setAttribute('stroke-linejoin', 'round');
                    path.setAttribute('fill', 'none');
                    path.style.pointerEvents = 'none'; // ä¸æ¥æ”¶äº‹ä»¶ï¼Œäº‹ä»¶ç”±hitAreaå¤„ç†

                    svg.appendChild(path);

                    // åœ¨é¢„è§ˆæ¨¡å¼ä¸‹æ·»åŠ æµåŠ¨çº¿æ®µæ•ˆæœï¼ˆä»¿ç…§é¦–é¡µï¼‰
                    if (!isEditMode && selectedConnection !== index) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯å¸‚ç”µåˆ°å…‰ä¼/å‚¨èƒ½æŸœçš„è¿çº¿
                        const fromId = conn.from.toLowerCase();
                        const toId = conn.to.toLowerCase();

                        const isGridToSolar =
                            (fromId.includes('grid') || fromId.includes('utility') || fromId.includes('å¸‚ç”µ')) &&
                            (toId.includes('solar') || toId.includes('pv') || toId.includes('å…‰ä¼'));

                        const isSolarToGrid =
                            (fromId.includes('solar') || fromId.includes('pv') || fromId.includes('å…‰ä¼')) &&
                            (toId.includes('grid') || toId.includes('utility') || toId.includes('å¸‚ç”µ'));

                        const isGridToStorage =
                            (fromId.includes('grid') || fromId.includes('utility') || fromId.includes('å¸‚ç”µ')) &&
                            (toId.includes('storage') || toId.includes('å‚¨èƒ½') || toId.includes('battery') || toId.includes('pcs'));

                        const isStorageToGrid =
                            (fromId.includes('storage') || fromId.includes('å‚¨èƒ½') || fromId.includes('battery') || fromId.includes('pcs')) &&
                            (toId.includes('grid') || toId.includes('utility') || toId.includes('å¸‚ç”µ'));

                        // å¦‚æœæ˜¯å¸‚ç”µåˆ°å…‰ä¼æˆ–å‚¨èƒ½æŸœçš„è¿çº¿ï¼Œè·³è¿‡æ·»åŠ åŠ¨ç”»
                        if (isGridToSolar || isSolarToGrid || isGridToStorage || isStorageToGrid) {
                            // ä¸æ·»åŠ æµåŠ¨åŠ¨ç”»
                        } else {
                            // åˆ›å»ºéšè—çš„è·¯å¾„ç”¨äºåŠ¨ç”»
                            const animPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            const pathId = `flow-path-${index}`;
                            animPath.setAttribute('id', pathId);
                            animPath.setAttribute('d', pathData);
                            animPath.style.display = 'none';
                            svg.appendChild(animPath);

                            // åˆ›å»ºæµåŠ¨çš„çŸ­çº¿æ®µï¼ˆè“è‰²ï¼‰
                            const flowingLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            flowingLine.setAttribute('x1', '-20');
                            flowingLine.setAttribute('y1', '0');
                            flowingLine.setAttribute('x2', '20');
                            flowingLine.setAttribute('y2', '0');
                            flowingLine.setAttribute('stroke', '#3562E3');
                            flowingLine.setAttribute('stroke-width', '5');
                            flowingLine.setAttribute('stroke-linecap', 'round');
                            flowingLine.setAttribute('opacity', '1');
                            flowingLine.style.pointerEvents = 'none';
                            flowingLine.style.filter = 'drop-shadow(0 0 6px rgba(53, 98, 227, 0.8))';

                            // æ·»åŠ æ²¿è·¯å¾„è¿åŠ¨çš„åŠ¨ç”»ï¼ˆè‡ªåŠ¨æ—‹è½¬è·Ÿéšè·¯å¾„æ–¹å‘ï¼‰
                            const animateMotion = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
                            animateMotion.setAttribute('dur', '2s');
                            animateMotion.setAttribute('repeatCount', 'indefinite');
                            animateMotion.setAttribute('rotate', 'auto'); // è‡ªåŠ¨æ—‹è½¬ï¼Œæ²¿è·¯å¾„æ–¹å‘

                            const mpath = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
                            mpath.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', `#${pathId}`);

                            animateMotion.appendChild(mpath);
                            flowingLine.appendChild(animateMotion);
                            svg.appendChild(flowingLine);
                        }
                    }

                    // å¦‚æœè¿çº¿è¢«é€‰ä¸­ï¼Œç»˜åˆ¶æ§åˆ¶ç‚¹
                    if (selectedConnection === index) {
                        drawControlPoints(conn, index, fromPoint, toPoint, canvasRect);
                    }
                }
            });
        }

        // æ ¹æ®è¿æ¥ç‚¹æ–¹å‘è®¡ç®—å…¶åœ¨ç”»å¸ƒä¸Šçš„ç»å¯¹ä½ç½®
        function getConnectionPointPosition(deviceRect, direction, canvasRect) {
            const centerX = deviceRect.left + deviceRect.width / 2 - canvasRect.left;
            const centerY = deviceRect.top + deviceRect.height / 2 - canvasRect.top;

            switch (direction) {
                case 'top':
                    return { x: centerX, y: deviceRect.top - canvasRect.top };
                case 'bottom':
                    return { x: centerX, y: deviceRect.bottom - canvasRect.top };
                case 'left':
                    return { x: deviceRect.left - canvasRect.left, y: centerY };
                case 'right':
                    return { x: deviceRect.right - canvasRect.left, y: centerY };
                default:
                    return { x: centerX, y: centerY };
            }
        }

        // è®¡ç®—æ­£äº¤è·¯å¾„ï¼ˆæ”¯æŒç›´è§’æ‹å¼¯ï¼‰
        function calculateOrthogonalPath(x1, y1, x2, y2) {
            const gap = 30; // æ‹å¼¯é—´è·

            // è®¡ç®—æ°´å¹³å’Œå‚ç›´è·ç¦»
            const dx = x2 - x1;
            const dy = y2 - y1;

            // å¦‚æœä¸¤ç‚¹å¾ˆè¿‘ï¼Œç›´æ¥è¿çº¿
            if (Math.abs(dx) < 10 && Math.abs(dy) < 10) {
                return `M ${x1} ${y1} L ${x2} ${y2}`;
            }

            // å¦‚æœæ°´å¹³è·ç¦»è¶³å¤Ÿï¼Œä½¿ç”¨ç®€å•çš„ä¸‰æ®µå¼è·¯å¾„
            if (Math.abs(dx) > gap * 2) {
                const midX = (x1 + x2) / 2;
                return `M ${x1} ${y1}
                        L ${midX} ${y1}
                        L ${midX} ${y2}
                        L ${x2} ${y2}`;
            }
            // å¦‚æœå‚ç›´è·ç¦»è¶³å¤Ÿï¼Œä½¿ç”¨ç®€å•çš„ä¸‰æ®µå¼è·¯å¾„
            else if (Math.abs(dy) > gap * 2) {
                const midY = (y1 + y2) / 2;
                return `M ${x1} ${y1}
                        L ${x1} ${midY}
                        L ${x2} ${midY}
                        L ${x2} ${y2}`;
            }
            // å¦åˆ™ä½¿ç”¨äº”æ®µå¼ç»•è¡Œè·¯å¾„
            else {
                const direction = dx > 0 ? 1 : -1;
                const offsetX = gap;
                const midY = (y1 + y2) / 2;

                return `M ${x1} ${y1}
                        L ${x1} ${y1 + gap}
                        L ${x1 + direction * offsetX} ${y1 + gap}
                        L ${x1 + direction * offsetX} ${y2 - gap}
                        L ${x2} ${y2 - gap}
                        L ${x2} ${y2}`;
            }
        }

        // è®¡ç®—è´å¡å°”æ›²çº¿è·¯å¾„ï¼ˆå¯é€‰çš„å¹³æ»‘æ‹å¼¯ï¼‰
        function calculateSmoothPath(x1, y1, x2, y2) {
            const midY = (y1 + y2) / 2;
            const controlOffset = 40;

            // ä½¿ç”¨ä¸‰æ¬¡è´å¡å°”æ›²çº¿åˆ›å»ºå¹³æ»‘è·¯å¾„
            return `M ${x1} ${y1}
                    C ${x1} ${y1 + controlOffset},
                      ${x1} ${midY - controlOffset},
                      ${x1} ${midY}
                    L ${x2} ${midY}
                    C ${x2} ${midY + controlOffset},
                      ${x2} ${y2 - controlOffset},
                      ${x2} ${y2}`;
        }

        // æ ¹æ®æ§åˆ¶ç‚¹è®¡ç®—è·¯å¾„ï¼ˆæ”¯æŒæ­£äº¤æ¨¡å¼ï¼‰
        function calculatePathWithControlPoints(x1, y1, x2, y2, controlPoints, orthogonal = true) {
            if (!controlPoints || controlPoints.length === 0) {
                return calculateOrthogonalPath(x1, y1, x2, y2);
            }

            let path = `M ${x1} ${y1}`;

            // å¦‚æœä½¿ç”¨æ­£äº¤æ¨¡å¼ï¼Œåœ¨æ¯ä¸¤ä¸ªç‚¹ä¹‹é—´åˆ›å»º90åº¦æ‹å¼¯
            if (orthogonal) {
                let prevX = x1;
                let prevY = y1;

                controlPoints.forEach(point => {
                    // åœ¨ä¸¤ç‚¹ä¹‹é—´åˆ›å»ºLå½¢è·¯å¾„ï¼ˆå…ˆæ°´å¹³åå‚ç›´ï¼Œæˆ–å…ˆå‚ç›´åæ°´å¹³ï¼‰
                    const dx = Math.abs(point.x - prevX);
                    const dy = Math.abs(point.y - prevY);

                    // æ ¹æ®è·ç¦»å†³å®šæ˜¯å…ˆèµ°æ°´å¹³è¿˜æ˜¯å…ˆèµ°å‚ç›´
                    if (dx > dy) {
                        // å…ˆæ°´å¹³åå‚ç›´
                        path += ` L ${point.x} ${prevY}`;
                        path += ` L ${point.x} ${point.y}`;
                    } else {
                        // å…ˆå‚ç›´åæ°´å¹³
                        path += ` L ${prevX} ${point.y}`;
                        path += ` L ${point.x} ${point.y}`;
                    }

                    prevX = point.x;
                    prevY = point.y;
                });

                // ä»æœ€åä¸€ä¸ªæ§åˆ¶ç‚¹åˆ°ç»ˆç‚¹ï¼Œä¹Ÿä½¿ç”¨æ­£äº¤è·¯å¾„
                const dx = Math.abs(x2 - prevX);
                const dy = Math.abs(y2 - prevY);

                if (dx > dy) {
                    path += ` L ${x2} ${prevY}`;
                    path += ` L ${x2} ${y2}`;
                } else {
                    path += ` L ${prevX} ${y2}`;
                    path += ` L ${x2} ${y2}`;
                }
            } else {
                // ç›´çº¿æ¨¡å¼ï¼šç›´æ¥è¿æ¥æ‰€æœ‰æ§åˆ¶ç‚¹
                controlPoints.forEach(point => {
                    path += ` L ${point.x} ${point.y}`;
                });
                path += ` L ${x2} ${y2}`;
            }

            return path;
        }

        // é€‰ä¸­è¿çº¿
        function selectConnection(index) {
            selectedConnection = index;

            // ä¸è‡ªåŠ¨åˆ›å»ºæ§åˆ¶ç‚¹ï¼Œä¿æŒåŸæœ‰è·¯å¾„
            // ç”¨æˆ·å¯ä»¥é€šè¿‡å³é”®èœå•"æ·»åŠ æ§åˆ¶ç‚¹"æ¥æ‰‹åŠ¨æ·»åŠ 

            drawAllConnections();

            const hasControlPoints = deviceConnections[index].controlPoints &&
                                    deviceConnections[index].controlPoints.length > 0;

            if (hasControlPoints) {
                showMiniToast('âœï¸ è¿çº¿å·²é€‰ä¸­ï¼Œæ‹–æ‹½æ§åˆ¶ç‚¹è°ƒæ•´è·¯å¾„');
            } else {
                showMiniToast('âœï¸ è¿çº¿å·²é€‰ä¸­ï¼Œå³é”®å¯æ·»åŠ æ§åˆ¶ç‚¹');
            }
        }

        // ç»˜åˆ¶æ§åˆ¶ç‚¹
        function drawControlPoints(conn, connIndex, fromPoint, toPoint, canvasRect) {
            const svg = document.getElementById('energyConnections');

            if (!conn.controlPoints) return;

            conn.controlPoints.forEach((point, pointIndex) => {
                // åˆ›å»ºæ§åˆ¶ç‚¹åœ†åœˆ
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', '8');
                circle.setAttribute('fill', '#ffaa00');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', '2');
                circle.style.cursor = 'move';
                circle.style.pointerEvents = 'all'; // å…è®¸æ§åˆ¶ç‚¹æ¥æ”¶é¼ æ ‡äº‹ä»¶
                circle.style.filter = 'drop-shadow(0 0 6px rgba(255, 170, 0, 0.8))';

                // æ·»åŠ æ§åˆ¶ç‚¹æ‹–æ‹½äº‹ä»¶
                circle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    startDraggingControlPoint(connIndex, pointIndex, e);
                });

                svg.appendChild(circle);

                // æ·»åŠ æ§åˆ¶ç‚¹æ–‡æœ¬æç¤º
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', point.y - 15);
                text.setAttribute('fill', '#ffaa00');
                text.setAttribute('font-size', '11');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = 'â—';
                text.style.pointerEvents = 'none';
                text.style.userSelect = 'none';

                svg.appendChild(text);
            });

            // æ·»åŠ æ–°å¢æ§åˆ¶ç‚¹æŒ‰é’®ï¼ˆåœ¨è¿çº¿ä¸­ç‚¹ï¼‰
            if (conn.controlPoints.length < 5) {
                const midX = (fromPoint.x + toPoint.x) / 2;
                const midY = (fromPoint.y + toPoint.y) / 2;

                const addButton = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                addButton.setAttribute('cx', midX);
                addButton.setAttribute('cy', midY);
                addButton.setAttribute('r', '6');
                addButton.setAttribute('fill', '#22c55e');
                addButton.setAttribute('stroke', '#fff');
                addButton.setAttribute('stroke-width', '2');
                addButton.style.cursor = 'pointer';
                addButton.style.pointerEvents = 'all'; // å…è®¸æ·»åŠ æŒ‰é’®æ¥æ”¶é¼ æ ‡äº‹ä»¶
                addButton.style.opacity = '0.7';

                addButton.addEventListener('mouseenter', () => {
                    addButton.style.opacity = '1';
                });

                addButton.addEventListener('mouseleave', () => {
                    addButton.style.opacity = '0.7';
                });

                addButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addControlPoint(connIndex, midX, midY);
                });

                svg.appendChild(addButton);

                const plusText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                plusText.setAttribute('x', midX);
                plusText.setAttribute('y', midY + 1);
                plusText.setAttribute('fill', '#fff');
                plusText.setAttribute('font-size', '10');
                plusText.setAttribute('font-weight', 'bold');
                plusText.setAttribute('text-anchor', 'middle');
                plusText.setAttribute('dominant-baseline', 'middle');
                plusText.textContent = '+';
                plusText.style.pointerEvents = 'none';

                svg.appendChild(plusText);
            }
        }

        // å¼€å§‹æ‹–æ‹½æ§åˆ¶ç‚¹
        function startDraggingControlPoint(connIndex, pointIndex, event) {
            isDraggingControlPoint = true;
            selectedConnection = connIndex;
            draggingControlPointIndex = pointIndex;

            document.body.style.cursor = 'move';
        }

        // æ·»åŠ æ§åˆ¶ç‚¹
        function addControlPoint(connIndex, x, y) {
            if (!deviceConnections[connIndex].controlPoints) {
                deviceConnections[connIndex].controlPoints = [];
            }

            deviceConnections[connIndex].controlPoints.push({ x, y });
            drawAllConnections();
            showMiniToast('â• å·²æ·»åŠ æ§åˆ¶ç‚¹');
        }

        // æ˜¾ç¤ºè¿çº¿å³é”®èœå•
        function showConnectionContextMenu(event, connIndex) {
            // ç§»é™¤æ—§èœå•
            const oldMenu = document.getElementById('connectionContextMenu');
            if (oldMenu) oldMenu.remove();

            const menu = document.createElement('div');
            menu.id = 'connectionContextMenu';
            menu.style.cssText = `
                position: fixed;
                left: ${event.clientX}px;
                top: ${event.clientY}px;
                background: #2a2a2a;
                border: 1px solid #3a3a3a;
                border-radius: 8px;
                padding: 8px 0;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                min-width: 160px;
            `;

            // è·å–å½“å‰è·¯å¾„æ¨¡å¼
            const currentMode = deviceConnections[connIndex].pathMode || 'orthogonal';
            const isOrthogonal = currentMode !== 'straight';

            const menuItems = [
                {
                    icon: isOrthogonal ? 'ğŸ“' : 'ğŸ“',
                    text: isOrthogonal ? 'åˆ‡æ¢ä¸ºç›´çº¿æ¨¡å¼' : 'åˆ‡æ¢ä¸ºæ­£äº¤æ¨¡å¼',
                    action: () => {
                        // åˆ‡æ¢è·¯å¾„æ¨¡å¼
                        deviceConnections[connIndex].pathMode = isOrthogonal ? 'straight' : 'orthogonal';
                        drawAllConnections();
                        showMiniToast(isOrthogonal ? 'ğŸ“ å·²åˆ‡æ¢ä¸ºç›´çº¿æ¨¡å¼' : 'ğŸ“ å·²åˆ‡æ¢ä¸ºæ­£äº¤æ¨¡å¼ï¼ˆ90åº¦æ‹å¼¯ï¼‰');
                        menu.remove();
                    }
                },
                {
                    icon: 'ğŸ”„',
                    text: 'é‡ç½®è·¯å¾„',
                    action: () => {
                        resetConnectionPath(connIndex);
                        menu.remove();
                    }
                },
                {
                    icon: 'â•',
                    text: 'æ·»åŠ æ§åˆ¶ç‚¹',
                    action: () => {
                        selectConnection(connIndex);
                        menu.remove();
                    }
                },
                {
                    icon: 'ğŸ—‘ï¸',
                    text: 'åˆ é™¤è¿çº¿',
                    action: () => {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¿çº¿å—ï¼Ÿ')) {
                            deviceConnections.splice(connIndex, 1);
                            selectedConnection = null;
                            drawAllConnections();
                            showMiniToast('âœ… å·²åˆ é™¤è¿çº¿');
                        }
                        menu.remove();
                    }
                }
            ];

            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.style.cssText = `
                    padding: 10px 16px;
                    cursor: pointer;
                    transition: background 0.2s;
                    color: #e2e8f0;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                `;

                menuItem.innerHTML = `<span>${item.icon}</span><span>${item.text}</span>`;

                menuItem.addEventListener('mouseenter', () => {
                    menuItem.style.background = '#3a3a3a';
                });

                menuItem.addEventListener('mouseleave', () => {
                    menuItem.style.background = 'transparent';
                });

                menuItem.addEventListener('click', item.action);

                menu.appendChild(menuItem);
            });

            document.body.appendChild(menu);

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }

        // é‡ç½®è¿çº¿è·¯å¾„
        function resetConnectionPath(connIndex) {
            deviceConnections[connIndex].controlPoints = [];
            selectedConnection = null;
            drawAllConnections();
            showMiniToast('ğŸ”„ è·¯å¾„å·²é‡ç½®');
        }

        // æ˜¾ç¤ºè¿çº¿ç¼–è¾‘å¸®åŠ©
        function showConnectionEditHelp() {
            // ç§»é™¤æ—§çš„å¸®åŠ©çª—å£
            const oldHelp = document.getElementById('connectionEditHelp');
            if (oldHelp) oldHelp.remove();

            const helpModal = document.createElement('div');
            helpModal.id = 'connectionEditHelp';
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;

            helpModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
                    border: 2px solid #3562E3;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 600px;
                    box-shadow: 0 8px 32px rgba(53, 98, 227, 0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #3562E3; font-size: 24px;">
                            <i class="fas fa-edit"></i> è¿çº¿ç¼–è¾‘æŒ‡å—
                        </h2>
                        <button onclick="document.getElementById('connectionEditHelp').remove()" style="
                            background: transparent;
                            border: none;
                            color: #3562E3;
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(53, 98, 227, 0.1)'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div style="color: #e2e8f0; line-height: 1.8; font-size: 14px;">
                        <div style="background: rgba(53, 98, 227, 0.1); border-left: 4px solid #3562E3; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0 0 12px 0; font-weight: 600; font-size: 16px; color: #3562E3;">
                                ğŸ’¡ å¦‚ä½•è‡ªå®šä¹‰è¿çº¿è·¯å¾„
                            </p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 12px;">
                                    <strong>é¼ æ ‡æ‚¬åœ</strong>åœ¨è¿çº¿ä¸Š â†’ è¿çº¿ä¼š<span style="color: #00e5ff;">é«˜äº®å˜äº®</span>
                                </li>
                                <li style="margin-bottom: 12px;">
                                    <strong>ç‚¹å‡»è¿çº¿</strong> â†’ è¿çº¿å˜ä¸º<span style="color: #ffaa00;">æ©™è‰²</span>ï¼Œè‡ªåŠ¨æ˜¾ç¤ºæ§åˆ¶ç‚¹
                                </li>
                                <li style="margin-bottom: 12px;">
                                    <strong>æ‹–æ‹½æ©™è‰²åœ†ç‚¹</strong> â†’ å®æ—¶è°ƒæ•´è¿çº¿è·¯å¾„
                                </li>
                                <li style="margin-bottom: 12px;">
                                    <strong>ç‚¹å‡»ç»¿è‰²â•</strong> â†’ æ·»åŠ æ›´å¤šæ§åˆ¶ç‚¹ï¼ˆæœ€å¤š5ä¸ªï¼‰
                                </li>
                                <li>
                                    <strong>å³é”®è¿çº¿</strong> â†’ é‡ç½®è·¯å¾„ / åˆ é™¤è¿çº¿
                                </li>
                            </ol>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div style="background: rgba(255, 170, 0, 0.1); border: 1px solid #ffaa00; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;">ğŸŸ </div>
                                <div style="font-weight: 600; color: #ffaa00; margin-bottom: 4px;">æ§åˆ¶ç‚¹</div>
                                <div style="font-size: 12px; color: #cbd5e1;">æ‹–æ‹½è°ƒæ•´è·¯å¾„</div>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;">ğŸŸ¢</div>
                                <div style="font-weight: 600; color: #22c55e; margin-bottom: 4px;">æ·»åŠ æŒ‰é’®</div>
                                <div style="font-size: 12px; color: #cbd5e1;">ç‚¹å‡»æ·»åŠ æ§åˆ¶ç‚¹</div>
                            </div>
                        </div>

                        <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; padding: 12px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 13px;">
                                <strong>âš ï¸ æç¤ºï¼š</strong>ç‚¹å‡»ç”»å¸ƒç©ºç™½å¤„å¯å–æ¶ˆé€‰ä¸­è¿çº¿
                            </p>
                        </div>
                    </div>

                    <div style="margin-top: 24px; text-align: center;">
                        <button onclick="document.getElementById('connectionEditHelp').remove()" style="
                            background: linear-gradient(135deg, #3562E3 0%, #2347C5 100%);
                            border: none;
                            color: #fff;
                            padding: 12px 32px;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,217,255,0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            æˆ‘çŸ¥é“äº†
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(helpModal);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }

        // æ¸…é™¤æ‰€æœ‰è¿çº¿
        function clearAllConnections() {
            if (deviceConnections.length === 0) {
                showMiniToast('âš ï¸ å½“å‰æ²¡æœ‰è¿çº¿');
                return;
            }

            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è¿çº¿å—ï¼Ÿ')) {
                deviceConnections = [];
                drawAllConnections();
                showMiniToast('âœ… å·²æ¸…é™¤æ‰€æœ‰è¿çº¿');
            }
        }

        // æ˜¾ç¤ºè¿çº¿ä½¿ç”¨æç¤º
        function showConnectionHint() {
            // ç§»é™¤æ—§æç¤º
            const oldHint = document.getElementById('connectionHint');
            if (oldHint) oldHint.remove();

            const hint = document.createElement('div');
            hint.id = 'connectionHint';
            hint.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 217, 255, 0.95);
                color: #000;
                padding: 24px 32px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 600;
                z-index: 200;
                box-shadow: 0 8px 32px rgba(0, 217, 255, 0.5);
                text-align: center;
                pointer-events: none;
                animation: fadeIn 0.3s ease;
            `;
            hint.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 12px;">ğŸ”— è¿çº¿æ¨¡å¼å·²å¼€å¯</div>
                <div style="font-size: 14px; font-weight: normal; line-height: 1.6;">
                    1ï¸âƒ£ ç‚¹å‡»ç¬¬ä¸€ä¸ªè®¾å¤‡ï¼ˆèµ·ç‚¹ï¼‰<br>
                    2ï¸âƒ£ ç‚¹å‡»ç¬¬äºŒä¸ªè®¾å¤‡ï¼ˆç»ˆç‚¹ï¼‰<br>
                    3ï¸âƒ£ è‡ªåŠ¨åˆ›å»ºè¿æ¥çº¿<br>
                    <br>
                    <span style="color: #1a1a1a;">ğŸ’¡ ç‚¹å‡»å·¥å…·æ æŒ‰é’®å…³é—­è¿çº¿æ¨¡å¼</span>
                </div>
            `;

            // æ·»åŠ æ·¡å…¥åŠ¨ç”»
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
            `;
            document.head.appendChild(style);

            document.getElementById('energyFlowCanvas').appendChild(hint);

            // 3ç§’åè‡ªåŠ¨æ·¡å‡º
            setTimeout(() => {
                if (hint && hint.parentNode) {
                    hint.style.transition = 'opacity 0.5s ease';
                    hint.style.opacity = '0';
                    setTimeout(() => {
                        if (hint && hint.parentNode) hint.remove();
                    }, 500);
                }
            }, 3000);
        }

        // éšè—è¿çº¿æç¤º
        function hideConnectionHint() {
            const hint = document.getElementById('connectionHint');
            if (hint) {
                hint.style.transition = 'opacity 0.3s ease';
                hint.style.opacity = '0';
                setTimeout(() => {
                    if (hint && hint.parentNode) hint.remove();
                }, 300);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰è®¾å¤‡
        function clearAllDevices() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®¾å¤‡å’Œè¿æ¥å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                return;
            }

            placedDevices = [];
            deviceConnections = [];
            connectionStart = null;

            renderPlacedDevices();
            drawAllConnections();
        }

        // æ°´å¹³å¯¹é½é€‰ä¸­çš„è®¾å¤‡
        function alignDevicesHorizontal() {
            if (!isEditMode) {
                showMiniToast('âš ï¸ è¯·å…ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼');
                return;
            }

            const selectedDevices = document.querySelectorAll('.flow-device.selected');
            if (selectedDevices.length < 2) {
                showMiniToast('âš ï¸ è¯·å…ˆé€‰ä¸­è‡³å°‘2ä¸ªè®¾å¤‡ï¼ˆæŒ‰ä½Ctrl/Cmdç‚¹å‡»å¤šé€‰ï¼‰');
                return;
            }

            // è·å–æ‰€æœ‰é€‰ä¸­è®¾å¤‡çš„Yåæ ‡ï¼Œè®¡ç®—å¹³å‡å€¼
            const deviceIds = Array.from(selectedDevices).map(el => el.dataset.deviceId);
            const devices = placedDevices.filter(d => deviceIds.includes(d.id));

            const avgY = devices.reduce((sum, d) => sum + (d.y || 0), 0) / devices.length;

            // å°†æ‰€æœ‰è®¾å¤‡çš„Yåæ ‡è®¾ç½®ä¸ºå¹³å‡å€¼
            devices.forEach(device => {
                device.y = Math.round(avgY);
            });

            // é‡æ–°æ¸²æŸ“
            renderPlacedDevices();
            drawAllConnections();

            showMiniToast(`âœ… å·²æ°´å¹³å¯¹é½ ${devices.length} ä¸ªè®¾å¤‡`);
        }

        // å‚ç›´å¯¹é½é€‰ä¸­çš„è®¾å¤‡
        function alignDevicesVertical() {
            if (!isEditMode) {
                showMiniToast('âš ï¸ è¯·å…ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼');
                return;
            }

            const selectedDevices = document.querySelectorAll('.flow-device.selected');
            if (selectedDevices.length < 2) {
                showMiniToast('âš ï¸ è¯·å…ˆé€‰ä¸­è‡³å°‘2ä¸ªè®¾å¤‡ï¼ˆæŒ‰ä½Ctrl/Cmdç‚¹å‡»å¤šé€‰ï¼‰');
                return;
            }

            // è·å–æ‰€æœ‰é€‰ä¸­è®¾å¤‡çš„Xåæ ‡ï¼Œè®¡ç®—å¹³å‡å€¼
            const deviceIds = Array.from(selectedDevices).map(el => el.dataset.deviceId);
            const devices = placedDevices.filter(d => deviceIds.includes(d.id));

            const avgX = devices.reduce((sum, d) => sum + (d.x || 0), 0) / devices.length;

            // å°†æ‰€æœ‰è®¾å¤‡çš„Xåæ ‡è®¾ç½®ä¸ºå¹³å‡å€¼
            devices.forEach(device => {
                device.x = Math.round(avgX);
            });

            // é‡æ–°æ¸²æŸ“
            renderPlacedDevices();
            drawAllConnections();

            showMiniToast(`âœ… å·²å‚ç›´å¯¹é½ ${devices.length} ä¸ªè®¾å¤‡`);
        }

        // è¿çº¿æ‹‰ç›´ï¼ˆè½¬ä¸ºç›´çº¿æ¨¡å¼ï¼‰
        function straightenConnections() {
            if (!isEditMode) {
                showMiniToast('âš ï¸ è¯·å…ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼');
                return;
            }

            if (deviceConnections.length === 0) {
                showMiniToast('âš ï¸ æ²¡æœ‰è¿çº¿å¯ä»¥æ‹‰ç›´');
                return;
            }

            // å°†æ‰€æœ‰è¿çº¿è½¬ä¸ºç›´çº¿æ¨¡å¼
            let changedCount = 0;
            deviceConnections.forEach(conn => {
                if (conn.pathMode !== 'straight' ||
                    (conn.controlPoints && conn.controlPoints.length > 0)) {
                    conn.pathMode = 'straight';
                    conn.controlPoints = [];
                    changedCount++;
                }
            });

            if (changedCount === 0) {
                showMiniToast('âœ… æ‰€æœ‰è¿çº¿å·²ç»æ˜¯ç›´çº¿');
                return;
            }

            // å–æ¶ˆé€‰ä¸­çŠ¶æ€
            selectedConnection = null;

            // é‡æ–°ç»˜åˆ¶æ‰€æœ‰è¿çº¿
            drawAllConnections();

            showMiniToast(`âœ… å·²æ‹‰ç›´ ${changedCount} æ¡è¿çº¿`);
        }

        // å±…ä¸­æ˜¾ç¤ºç”»å¸ƒå†…å®¹
        function centerCanvasContent() {
            console.log('ğŸ¯ centerCanvasContent è¢«è°ƒç”¨');

            if (placedDevices.length === 0) {
                console.log('âš ï¸ æ²¡æœ‰è®¾å¤‡ï¼Œè·³è¿‡å±…ä¸­');
                return;
            }

            const canvas = document.getElementById('energyFlowCanvas');
            const devicesContainer = document.getElementById('devicesContainer');

            if (!canvas || !devicesContainer) {
                console.log('âŒ ç”»å¸ƒå…ƒç´ æœªæ‰¾åˆ°');
                return;
            }

            // è®¡ç®—æ‰€æœ‰è®¾å¤‡çš„è¾¹ç•Œ
            let minX = Infinity, minY = Infinity;
            let maxX = -Infinity, maxY = -Infinity;

            placedDevices.forEach(device => {
                const x = device.x || 0;
                const y = device.y || 0;
                const width = 240; // è®¾å¤‡å¡ç‰‡å®½åº¦
                const height = 200; // è®¾å¤‡å¡ç‰‡é«˜åº¦

                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x + width);
                maxY = Math.max(maxY, y + height);
            });

            console.log('ğŸ“ å†…å®¹è¾¹ç•Œ:', { minX, minY, maxX, maxY });

            // è®¡ç®—å†…å®¹çš„å®½é«˜
            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;

            // è·å–ç”»å¸ƒå¯è§†åŒºåŸŸ
            const canvasWidth = canvas.clientWidth - 80; // å‡å» padding
            const canvasHeight = canvas.clientHeight - 80;

            console.log('ğŸ“ ç”»å¸ƒå°ºå¯¸:', { canvasWidth, canvasHeight });
            console.log('ğŸ“¦ å†…å®¹å°ºå¯¸:', { contentWidth, contentHeight });

            // è®¡ç®—å±…ä¸­æ‰€éœ€çš„åç§»é‡
            const offsetX = Math.max(0, (canvasWidth - contentWidth) / 2 - minX);
            const offsetY = Math.max(0, (canvasHeight - contentHeight) / 2 - minY);

            console.log('â¡ï¸ åç§»é‡:', { offsetX, offsetY });

            // åº”ç”¨åç§»
            if (offsetX > 0 || offsetY > 0) {
                placedDevices.forEach(device => {
                    if (offsetX > 0) device.x = (device.x || 0) + offsetX;
                    if (offsetY > 0) device.y = (device.y || 0) + offsetY;
                });

                // é‡æ–°æ¸²æŸ“
                renderPlacedDevices();
                drawAllConnections();

                console.log('âœ… å†…å®¹å·²å±…ä¸­');
            } else {
                console.log('â„¹ï¸ å†…å®¹å·²ç»å±…ä¸­ï¼Œæ— éœ€è°ƒæ•´');
            }
        }

        // åº”ç”¨ç½‘æ ¼å¸ƒå±€ï¼ˆå¸‚ç”µ-å…‰ä¼-å‚¨èƒ½æŸœï¼‰
        function applyGridLayout() {
            console.log('ğŸ“ åº”ç”¨ç½‘æ ¼å¸ƒå±€');

            // è·å–ç”»å¸ƒå°ºå¯¸
            const container = document.getElementById('devicesContainer');
            const canvasWidth = container.offsetWidth;
            const canvasHeight = container.offsetHeight;

            // è®¡ç®—ç½‘æ ¼ä½ç½®ï¼ˆå·¦å³ä¸¤åˆ—å¸ƒå±€ï¼‰
            const marginTop = 150; // é¡¶éƒ¨è¾¹è·
            const marginLeft = 280; // å·¦è¾¹è·
            const marginRight = 280; // å³è¾¹è·
            const verticalSpacing = 280; // å‚ç›´é—´è·

            const positions = {
                utility: { x: marginLeft, y: marginTop }, // å·¦ä¸Šï¼šå¸‚ç”µ
                solar: { x: canvasWidth - marginRight - 140, y: marginTop }, // å³ä¸Šï¼šå…‰ä¼
                storage: { x: canvasWidth - marginRight - 140, y: marginTop + verticalSpacing } // å³ä¸‹ï¼šå‚¨èƒ½æŸœ
            };

            // æ¸…ç©ºç°æœ‰è®¾å¤‡å’Œè¿çº¿
            placedDevices = [];
            deviceConnections = [];

            // åˆ›å»º3ä¸ªå…¸å‹è®¾å¤‡
            const devices = [
                {
                    id: 'grid-utility',
                    label: 'å¸‚ç”µ',
                    icon: 'ç”µç½‘.png',
                    desc: '380V 3ç›¸',
                    category: 'power',
                    x: positions.utility.x,
                    y: positions.utility.y,
                    voltage: 380.0,
                    power: 0,
                    current: 0,
                    flowControl: 'bidirectional', // å¸‚ç”µåŒå‘
                    displayParams: {
                        power: { enabled: false, x: -80, y: -30 },
                        voltage: { enabled: false, x: -80, y: 0 },
                        current: { enabled: false, x: -80, y: 30 },
                        soc: { enabled: false, x: -80, y: 60 }
                    }
                },
                {
                    id: 'grid-solar',
                    label: 'å…‰ä¼',
                    icon: 'å…‰ä¼.png',
                    desc: '500KW',
                    category: 'power',
                    x: positions.solar.x,
                    y: positions.solar.y,
                    voltage: 380.0,
                    power: 108.6,
                    current: 285.8,
                    flowControl: 'in', // å…‰ä¼è¾“å…¥
                    displayParams: {
                        power: { enabled: true, x: 160, y: -10 },
                        voltage: { enabled: false, x: 160, y: 20 },
                        current: { enabled: false, x: 160, y: 50 },
                        soc: { enabled: false, x: 160, y: 80 }
                    }
                },
                {
                    id: 'grid-storage',
                    label: 'å‚¨èƒ½æŸœ',
                    icon: 'å‚¨èƒ½æŸœ.png',
                    desc: '500KWh',
                    category: 'storage',
                    x: positions.storage.x,
                    y: positions.storage.y,
                    voltage: 380.0,
                    power: 104.4,
                    current: 274.7,
                    soc: 85.0,
                    flowControl: 'bidirectional', // å‚¨èƒ½åŒå‘
                    displayParams: {
                        power: { enabled: true, x: 160, y: -10 },
                        voltage: { enabled: false, x: 160, y: 20 },
                        current: { enabled: false, x: 160, y: 50 },
                        soc: { enabled: false, x: 160, y: 80 }
                    }
                }
            ];

            // æ·»åŠ è®¾å¤‡åˆ°ç”»å¸ƒ
            devices.forEach(device => {
                placedDevices.push(device);
            });

            // åˆ›å»ºè¿çº¿ï¼ˆèƒ½é‡æµæ‹“æ‰‘ï¼‰
            const connections = [
                // å…‰ä¼ â†’ å‚¨èƒ½æŸœ (å‚ç›´)
                { from: 'grid-solar', fromDirection: 'bottom', to: 'grid-storage', toDirection: 'top', controlPoints: [] },
                // å¸‚ç”µ â†’ å‚¨èƒ½æŸœ (æ–œçº¿)
                { from: 'grid-utility', fromDirection: 'right', to: 'grid-storage', toDirection: 'left', controlPoints: [] }
            ];

            connections.forEach(conn => {
                deviceConnections.push(conn);
            });

            // æ¸²æŸ“è®¾å¤‡å’Œè¿çº¿
            renderPlacedDevices();
            drawAllConnections();

            // ä¿å­˜é…ç½®
            saveToLocalStorage();

            console.log('âœ… ç½‘æ ¼å¸ƒå±€å·²åº”ç”¨');
            console.log('è®¾å¤‡æ•°é‡:', placedDevices.length);
            console.log('è¿çº¿æ•°é‡:', deviceConnections.length);

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showSuccessMessage('âœ… å·²åº”ç”¨èƒ½é‡æµå¸ƒå±€ï¼šå¸‚ç”µ â‡„ å‚¨èƒ½æŸœ â‡„ å…‰ä¼');
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #22c55e;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // ä¿å­˜é…ç½®åˆ°localStorage
        function saveFlowConfig() {
            console.log('ğŸ’¾ saveFlowConfig è¢«è°ƒç”¨');

            // æŒ‰é’®è§†è§‰åé¦ˆ
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.style.background = '#0099cc';
                saveBtn.disabled = true;
            }

            if (!isEditMode) {
                showMiniToast('è¯·å…ˆè¿›å…¥ç¼–è¾‘æ¨¡å¼', 'warning');
                if (saveBtn) {
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }
                return;
            }

            const config = {
                placedDevices: placedDevices,
                connections: deviceConnections,
                timestamp: new Date().toISOString()
            };

            try {
                const configStr = JSON.stringify(config);
                console.log('ğŸ“¦ å‡†å¤‡ä¿å­˜é…ç½®');
                console.log('   - æ•°æ®å¤§å°:', configStr.length, 'å­—èŠ‚');
                console.log('   - è®¾å¤‡æ•°é‡:', placedDevices.length);
                console.log('   - è¿çº¿æ•°é‡:', deviceConnections.length);

                localStorage.setItem('energyFlowConfig', configStr);

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showMiniToast(`ä¿å­˜æˆåŠŸ (${placedDevices.length} ä¸ªè®¾å¤‡, ${deviceConnections.length} æ¡è¿çº¿)`, 'success');
                console.log('âœ… é…ç½®ä¿å­˜æˆåŠŸ');

                // ä¿å­˜æˆåŠŸåè·³è½¬å›ä»ªè¡¨ç›˜
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 800);

            } catch (e) {
                console.error('âŒ ä¿å­˜é…ç½®å¤±è´¥:', e);
                showMiniToast('ä¿å­˜å¤±è´¥ï¼š' + e.message, 'error');
                if (saveBtn) {
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }
            }
        }

        // ä»localStorageåŠ è½½é…ç½®
        function loadFlowConfig() {
            console.log('loadFlowConfig è¢«è°ƒç”¨');

            try {
                const saved = localStorage.getItem('energyFlowConfig');
                console.log('ä» localStorage è¯»å–æ•°æ®:', saved ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®');

                if (saved) {
                    const config = JSON.parse(saved);
                    console.log('è§£æé…ç½®æˆåŠŸ:', config);

                    placedDevices = config.placedDevices || [];
                    deviceConnections = config.connections || [];

                    console.log('è®¾å¤‡æ•°é‡:', placedDevices.length);
                    console.log('è¿çº¿æ•°é‡:', deviceConnections.length);

                    renderPlacedDevices();
                    drawAllConnections();

                    const saveTime = new Date(config.timestamp).toLocaleString('zh-CN');
                    showMiniToast(`âœ… é…ç½®åŠ è½½æˆåŠŸï¼\n${placedDevices.length}ä¸ªè®¾å¤‡, ${deviceConnections.length}æ¡è¿çº¿\nä¿å­˜æ—¶é—´: ${saveTime}`);
                } else {
                    showMiniToast('âš ï¸ æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„é…ç½®');
                }
            } catch (e) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
                showMiniToast('âŒ åŠ è½½å¤±è´¥ï¼š' + e.message);
            }
        }

        // åˆå§‹åŒ–æ—¶åŠ è½½ä¿å­˜çš„é…ç½®
        function loadSavedConfig() {
            try {
                const saved = localStorage.getItem('energyFlowConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    placedDevices = config.placedDevices || [];
                    deviceConnections = config.connections || [];
                }
            } catch (e) {
                console.error('è‡ªåŠ¨åŠ è½½é…ç½®å¤±è´¥:', e);
            }
        }

        // ç»˜åˆ¶è¿æ¥çº¿
        function drawConnections() {
            const svg = document.getElementById('energyConnections');
            svg.innerHTML = '';

            const layer1 = document.getElementById('layer1');
            const layer2 = document.getElementById('layer2');
            const layer3 = document.getElementById('layer3');

            // è·å–å„å±‚ä½ç½®
            const layer1Rect = layer1.getBoundingClientRect();
            const layer2Rect = layer2.getBoundingClientRect();
            const layer3Rect = layer3.getBoundingClientRect();
            const containerRect = document.getElementById('energyFlowCanvas').getBoundingClientRect();

            // ç¬¬ä¸€å±‚è®¾å¤‡åˆ°æ¯çº¿
            const sources = layer1.querySelectorAll('.flow-device');
            sources.forEach(source => {
                const rect = source.getBoundingClientRect();
                const x = rect.left + rect.width / 2 - containerRect.left;
                const y1 = rect.bottom - containerRect.top;
                const y2 = layer2Rect.top - containerRect.top;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x);
                line.setAttribute('y2', y2);
                line.setAttribute('class', 'flow-vline animated');
                svg.appendChild(line);
            });

            // ç¬¬ä¸€æ¡æ¯çº¿ï¼ˆè¿æ¥ç”µæºå±‚å’Œæ±‡æµæŸœï¼‰
            const busbar1Y = layer2Rect.top - containerRect.top;
            const busbar1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            busbar1.setAttribute('x1', 100);
            busbar1.setAttribute('y1', busbar1Y);
            busbar1.setAttribute('x2', containerRect.width - 100);
            busbar1.setAttribute('y2', busbar1Y);
            busbar1.setAttribute('class', 'flow-busbar');
            svg.appendChild(busbar1);

            // æ±‡æµæŸœåˆ°ç¬¬äºŒæ¡æ¯çº¿
            const busbarDevice = layer2.querySelector('.flow-busbar-device');
            if (busbarDevice) {
                const rect = busbarDevice.getBoundingClientRect();
                const x = rect.left + rect.width / 2 - containerRect.left;
                const y1 = rect.bottom - containerRect.top;
                const y2 = layer3Rect.top - containerRect.top - 20;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x);
                line.setAttribute('y2', y2);
                line.setAttribute('class', 'flow-vline animated');
                svg.appendChild(line);
            }

            // ç¬¬äºŒæ¡æ¯çº¿ï¼ˆè¿æ¥æ±‡æµæŸœå’ŒPCSï¼‰
            const busbar2Y = layer3Rect.top - containerRect.top - 20;
            const busbar2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            busbar2.setAttribute('x1', 100);
            busbar2.setAttribute('y1', busbar2Y);
            busbar2.setAttribute('x2', containerRect.width - 100);
            busbar2.setAttribute('y2', busbar2Y);
            busbar2.setAttribute('class', 'flow-busbar');
            svg.appendChild(busbar2);

            // æ¯çº¿åˆ°å„ä¸ªPCS/BMSç»„
            const groups = layer3.querySelectorAll('.flow-pcs-bms-group');
            groups.forEach(group => {
                const pcs = group.querySelector('.flow-pcs-device');
                const bms = group.querySelector('.flow-bms-device');

                if (pcs && bms) {
                    const pcsRect = pcs.getBoundingClientRect();
                    const bmsRect = bms.getBoundingClientRect();
                    const x = pcsRect.left + pcsRect.width / 2 - containerRect.left;

                    // æ¯çº¿åˆ°PCS
                    const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line1.setAttribute('x1', x);
                    line1.setAttribute('y1', busbar2Y);
                    line1.setAttribute('x2', x);
                    line1.setAttribute('y2', pcsRect.top - containerRect.top);
                    line1.setAttribute('class', 'flow-vline animated');
                    svg.appendChild(line1);

                    // PCSåˆ°BMS
                    const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line2.setAttribute('x1', x);
                    line2.setAttribute('y1', pcsRect.bottom - containerRect.top);
                    line2.setAttribute('x2', x);
                    line2.setAttribute('y2', bmsRect.top - containerRect.top);
                    line2.setAttribute('class', 'flow-vline animated');
                    svg.appendChild(line2);
                }
            });
        }

        // å¯åŠ¨å®æ—¶æ•°æ®æ›´æ–°
        function startEnergyFlowUpdates() {
            setInterval(() => {
                if (window.energyFlowInitialized && document.getElementById('energy-flow-container').style.display !== 'none') {
                    // æ›´æ–°ç”µæºåŠŸç‡
                    flowData.sources.forEach(source => {
                        if (source.power) {
                            source.power = Math.max(50, source.power + (Math.random() - 0.5) * 10);
                        }
                    });

                    // æ›´æ–°BMSæ•°æ®
                    flowData.bms.forEach(bms => {
                        bms.voltage = Math.max(370, Math.min(395, bms.voltage + (Math.random() - 0.5) * 2));
                        bms.current = Math.max(80, Math.min(150, bms.current + (Math.random() - 0.5) * 5));
                        bms.soc = Math.max(10, Math.min(100, bms.soc + (Math.random() - 0.5) * 1));
                    });

                    // é‡æ–°æ¸²æŸ“ï¼ˆä¸é‡ç»˜è¿æ¥çº¿ä»¥ä¿æŒæ€§èƒ½ï¼‰
                    renderLayer1();
                    renderLayer4();
                }
            }, 3000);
        }

        // ==================== èƒ½é‡æµè§†å›¾åŠŸèƒ½ç»“æŸ ====================

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            initNavbar('energy-flow');
            // è‡ªåŠ¨æ˜¾ç¤ºå¹¶åˆå§‹åŒ–èƒ½é‡æµ
            const container = document.getElementById('energy-flow-container');
            if (container) {
                container.style.display = 'block';
                initEnergyFlow();
                window.energyFlowInitialized = true;

                // åº”ç”¨ç¼–è¾‘æ¨¡å¼UIï¼ˆå› ä¸ºisEditModeé»˜è®¤ä¸ºtrueï¼‰
                setTimeout(function() {
                    applyEditModeUI();
                }, 100);
            }
        });
    </script>
</body>
</html>
