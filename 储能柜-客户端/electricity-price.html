<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”µä»·è®¾ç½® - AlwaysControl Technology</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* é¡µé¢å®¹å™¨ */
        .electricity-price-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 8px 0;
        }

        .page-description {
            font-size: 14px;
            color: #64748b;
            margin: 0;
        }

        /* Tab åˆ‡æ¢ */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: #3b82f6;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* æ•°æ®è¡¨æ ¼åŒºåŸŸ */
        .data-table-wrapper {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .table-actions {
            display: flex;
            gap: 12px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            height: 36px;
            padding: 0 16px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            width: auto;
            flex-shrink: 0;
            min-width: fit-content;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-text {
            background: transparent;
            color: #3b82f6;
            padding: 0 8px;
            height: auto;
        }

        .btn-text:hover {
            color: #2563eb;
            background: rgba(59, 130, 246, 0.1);
        }

        .btn-danger {
            background: #ef4444;
            color: #ffffff;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #22c55e;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        /* è¡¨æ ¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8fafc;
        }

        .data-table th {
            padding: 14px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        .data-table td {
            padding: 16px 20px;
            font-size: 14px;
            color: #1e293b;
        }

        /* æ ‡ç­¾ */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .badge-warning {
            background: rgba(234, 179, 8, 0.15);
            color: #eab308;
        }

        .badge-gray {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
        }

        .badge-purple {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* è¡¨å• */
        .form-section {
            margin-bottom: 32px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }

        .form-label.required::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            height: 36px;
            padding: 0 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #1e293b;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-textarea {
            height: auto;
            min-height: 80px;
            padding: 10px 12px;
            resize: vertical;
        }

        .form-input:hover,
        .form-select:hover,
        .form-textarea:hover {
            border-color: #3b82f6;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* æ—¶é—´æ®µé…ç½® */
        .time-periods {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .time-period-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .time-period-card:hover {
            border-color: #3b82f6;
        }

        .time-period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .time-period-type {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-period-type-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .time-period-type-icon.peak {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .time-period-type-icon.valley {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .time-period-type-icon.flat {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .time-period-type-icon.super-peak {
            background: rgba(220, 38, 38, 0.15);
            color: #dc2626;
        }

        .time-period-remove {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-period-remove:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .time-period-fields {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 12px;
        }

        .add-period-btn {
            width: 100%;
            height: 40px;
            border: 1px dashed #e2e8f0;
            background: transparent;
            color: #3b82f6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .add-period-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            color: #cbd5e1;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            margin: 0 0 8px 0;
        }

        .empty-state-description {
            font-size: 14px;
            color: #94a3b8;
            margin: 0;
        }

        /* æ“ä½œæŒ‰é’®ç»„ */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* ç«™ç‚¹å¡ç‰‡ */
        .site-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .site-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .site-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .site-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .site-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            color: #64748b;
        }

        .info-value {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }
    </style>
</head>
<body data-page="electricity-price">
    <!-- å¯¼èˆªæ å®¹å™¨ -->
    <div id="navbar-container"></div>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
        <div class="electricity-price-container">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="fas fa-bolt" style="color: #3b82f6; margin-right: 8px;"></i>
                    ç”µä»·è®¾ç½®
                </h1>
                <p class="page-description">ç®¡ç†ç”µä»·æ¨¡ç‰ˆå¹¶åº”ç”¨åˆ°ç”µç«™ï¼Œå®ç°å³°è°·å¹³å°–æ—¶æ®µã€åˆ†æ—¶ç”µä»·ç­‰å¤šç§å®šä»·ç­–ç•¥</p>
            </div>

            <!-- Tab åˆ‡æ¢ -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('templates')">
                    <i class="fas fa-file-alt"></i> ç”µä»·æ¨¡ç‰ˆåº“
                </button>
                <button class="tab-btn" onclick="switchTab('sites')">
                    <i class="fas fa-building"></i> ç”µç«™ç”µä»·é…ç½®
                </button>
            </div>

            <!-- Tab 1: ç”µä»·æ¨¡ç‰ˆåº“ -->
            <div class="tab-content active" id="templates-tab">
                <div class="data-table-wrapper">
                    <div class="table-header">
                        <h2 class="table-title">ç”µä»·æ¨¡ç‰ˆç®¡ç†</h2>
                        <div class="table-actions">
                            <button class="btn btn-primary" onclick="openTemplateModal()">
                                <i class="fas fa-plus"></i>
                                æ–°å»ºæ¨¡ç‰ˆ
                            </button>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>æ¨¡ç‰ˆåç§°</th>
                                <th>ç±»å‹</th>
                                <th>æ—¶æ®µé…ç½®</th>
                                <th>å·²åº”ç”¨ç«™ç‚¹</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="templatesTableBody">
                            <!-- æ•°æ®å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: ç”µç«™ç”µä»·é…ç½® -->
            <div class="tab-content" id="sites-tab">
                <div class="data-table-wrapper">
                    <div class="table-header">
                        <h2 class="table-title">ç”µç«™ç”µä»·é…ç½®</h2>
                        <div class="table-actions">
                            <button class="btn btn-secondary" onclick="refreshSites()">
                                <i class="fas fa-sync"></i>
                                åˆ·æ–°
                            </button>
                        </div>
                    </div>

                    <div style="padding: 20px;" id="sitesContainer">
                        <!-- ç«™ç‚¹å¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€å¡«å…… -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ¨¡ç‰ˆç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="templateModalTitle">æ–°å»ºç”µä»·æ¨¡ç‰ˆ</h3>
                <button class="modal-close" onclick="closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <!-- åŸºæœ¬ä¿¡æ¯ -->
                    <div class="form-section">
                        <h4 class="form-section-title">åŸºæœ¬ä¿¡æ¯</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">æ¨¡ç‰ˆåç§°</label>
                                <input type="text" class="form-input" id="templateName" placeholder="å¦‚ï¼šæ±Ÿè‹å³°è°·ç”µä»·" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label required">ç­–ç•¥ç±»å‹</label>
                                <select class="form-select" id="templateStrategy" required onchange="onTemplateStrategyChange()">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="peak-valley">å³°è°·å¹³å°–</option>
                                    <option value="tou">åˆ†æ—¶ç”µä»·</option>
                                    <option value="fixed">å›ºå®šç”µä»·</option>
                                    <option value="tiered">é˜¶æ¢¯ç”µä»·</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">æ¨¡ç‰ˆè¯´æ˜</label>
                                <textarea class="form-textarea" id="templateDescription" placeholder="å¯é€‰ï¼šæè¿°æ­¤æ¨¡ç‰ˆçš„é€‚ç”¨åœºæ™¯"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- å›ºå®šç”µä»·é…ç½® -->
                    <div class="form-section" id="fixedPriceSection" style="display: none;">
                        <h4 class="form-section-title">å›ºå®šç”µä»·é…ç½®</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required">ä¹°å…¥ç”µä»· (å…ƒ/kWh)</label>
                                <input type="number" class="form-input" id="fixedBuyPrice" placeholder="0.00" step="0.01" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label required">å–å‡ºç”µä»· (å…ƒ/kWh)</label>
                                <input type="number" class="form-input" id="fixedSellPrice" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- æ—¶æ®µç”µä»·é…ç½® -->
                    <div class="form-section" id="periodPriceSection" style="display: none;">
                        <h4 class="form-section-title">æ—¶æ®µç”µä»·é…ç½®</h4>
                        <div class="time-periods" id="timePeriods">
                            <!-- æ—¶æ®µå¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€æ·»åŠ  -->
                        </div>
                        <button type="button" class="add-period-btn" onclick="addTimePeriod()">
                            <i class="fas fa-plus"></i>
                            æ·»åŠ æ—¶é—´æ®µ
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTemplateModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveTemplate()">
                    <i class="fas fa-save"></i>
                    ä¿å­˜æ¨¡ç‰ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- åº”ç”¨æ¨¡ç‰ˆåˆ°ç«™ç‚¹æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="applyTemplateModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">åº”ç”¨ç”µä»·æ¨¡ç‰ˆåˆ°ç«™ç‚¹</h3>
                <button class="modal-close" onclick="closeApplyModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4 class="form-section-title">é€‰æ‹©ç”µä»·æ¨¡ç‰ˆ</h4>
                    <div class="form-group">
                        <label class="form-label required">ç”µä»·æ¨¡ç‰ˆ</label>
                        <select class="form-select" id="applyTemplateSelect" required>
                            <option value="">è¯·é€‰æ‹©æ¨¡ç‰ˆ</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label class="form-label required">ç”Ÿæ•ˆæ—¶é—´</label>
                        <input type="datetime-local" class="form-input" id="applyEffectiveTime" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeApplyModal()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="confirmApplyTemplate()">
                    <i class="fas fa-check"></i>
                    ç¡®è®¤åº”ç”¨
                </button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å…¬å…±è„šæœ¬ -->
    <script src="navbar.js"></script>
    <script src="common.js"></script>
    <script src="i18n.js"></script>

    <script>
        // ==================== æ•°æ®æ¨¡å‹ ====================

        // ç”µä»·æ¨¡ç‰ˆæ•°æ®
        let priceTemplates = [
            {
                id: 1,
                name: 'æ±Ÿè‹å³°è°·ç”µä»·',
                type: 'peak-valley',
                typeName: 'å³°è°·å¹³å°–',
                description: 'é€‚ç”¨äºæ±Ÿè‹åœ°åŒºå·¥å•†ä¸šç”¨ç”µ',
                createTime: '2024-01-15 10:30',
                periods: [
                    { type: 'super-peak', start: '19:00', end: '21:00', buyPrice: 1.2, sellPrice: 0.9 },
                    { type: 'peak', start: '08:00', end: '11:00', buyPrice: 0.9, sellPrice: 0.7 },
                    { type: 'peak', start: '14:00', end: '19:00', buyPrice: 0.9, sellPrice: 0.7 },
                    { type: 'flat', start: '11:00', end: '14:00', buyPrice: 0.6, sellPrice: 0.5 },
                    { type: 'flat', start: '21:00', end: '23:00', buyPrice: 0.6, sellPrice: 0.5 },
                    { type: 'valley', start: '23:00', end: '08:00', buyPrice: 0.3, sellPrice: 0.25 }
                ]
            },
            {
                id: 2,
                name: 'å¹¿ä¸œåˆ†æ—¶ç”µä»·',
                type: 'tou',
                typeName: 'åˆ†æ—¶ç”µä»·',
                description: 'é€‚ç”¨äºå¹¿ä¸œåœ°åŒºå•†ä¸šç”¨ç”µ',
                createTime: '2024-01-20 14:20',
                periods: [
                    { type: 'peak', start: '08:00', end: '22:00', buyPrice: 0.85, sellPrice: 0.65 },
                    { type: 'valley', start: '22:00', end: '08:00', buyPrice: 0.45, sellPrice: 0.35 }
                ]
            },
            {
                id: 3,
                name: 'å±…æ°‘å›ºå®šç”µä»·',
                type: 'fixed',
                typeName: 'å›ºå®šç”µä»·',
                description: 'é€‚ç”¨äºå±…æ°‘ç”¨ç”µ',
                createTime: '2024-02-01 09:15',
                fixedPrice: { buyPrice: 0.52, sellPrice: 0.42 }
            }
        ];

        // ç”µç«™æ•°æ®ï¼ˆä»ç³»ç»Ÿå…¶ä»–é¡µé¢è·å–ï¼‰
        let sites = [
            { id: 'site1', name: 'ç§‘æŠ€å›­åŒºç«™', location: 'æ±Ÿè‹å—äº¬', capacity: '2.5MWh', deviceCount: 8, templateId: 1 },
            { id: 'site2', name: 'å·¥ä¸šå›­åŒºç«™', location: 'å¹¿ä¸œæ·±åœ³', capacity: '3.75MWh', deviceCount: 12, templateId: 2 },
            { id: 'site3', name: 'å•†ä¸šä¸­å¿ƒç«™', location: 'æµ™æ±Ÿæ­å·', capacity: '3.1MWh', deviceCount: 10, templateId: null },
            { id: 'site4', name: 'ç‰©æµå›­åŒºç«™', location: 'ä¸Šæµ·æµ¦ä¸œ', capacity: '4.7MWh', deviceCount: 15, templateId: null }
        ];

        let currentEditTemplateId = null;
        let currentApplySiteId = null;
        let periodCounter = 0;

        // ==================== é¡µé¢åˆå§‹åŒ– ====================

        document.addEventListener('DOMContentLoaded', function() {
            renderTemplatesTable();
            renderSitesCards();
        });

        // ==================== Tab åˆ‡æ¢ ====================

        function switchTab(tab) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');

            // åˆ‡æ¢å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            // æ ¹æ®tabç±»å‹é‡æ–°æ¸²æŸ“æ•°æ®
            if (tab === 'templates') {
                renderTemplatesTable();
            } else if (tab === 'sites') {
                renderSitesCards();
            }
        }

        // ==================== æ¨¡ç‰ˆç®¡ç†åŠŸèƒ½ ====================

        // æ¸²æŸ“æ¨¡ç‰ˆè¡¨æ ¼
        function renderTemplatesTable() {
            const tbody = document.getElementById('templatesTableBody');

            if (priceTemplates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                                <h3 class="empty-state-title">æš‚æ— ç”µä»·æ¨¡ç‰ˆ</h3>
                                <p class="empty-state-description">ç‚¹å‡»"æ–°å»ºæ¨¡ç‰ˆ"åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªç”µä»·ç­–ç•¥æ¨¡ç‰ˆ</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = priceTemplates.map(template => {
                const appliedSites = sites.filter(s => s.templateId === template.id);
                const periodInfo = template.type === 'fixed'
                    ? `ä¹°å…¥${template.fixedPrice.buyPrice}å…ƒ å–å‡º${template.fixedPrice.sellPrice}å…ƒ`
                    : `${template.periods.length}ä¸ªæ—¶æ®µ`;

                return `
                    <tr>
                        <td><strong>${template.name}</strong></td>
                        <td><span class="badge badge-primary">${template.typeName}</span></td>
                        <td>${periodInfo}</td>
                        <td>${appliedSites.length}ä¸ªç«™ç‚¹</td>
                        <td>${template.createTime}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-text" onclick="viewTemplate(${template.id})">
                                    <i class="fas fa-eye"></i> æŸ¥çœ‹
                                </button>
                                <button class="btn btn-text" onclick="editTemplate(${template.id})">
                                    <i class="fas fa-edit"></i> ç¼–è¾‘
                                </button>
                                <button class="btn btn-text" style="color: #ef4444;" onclick="deleteTemplate(${template.id})">
                                    <i class="fas fa-trash"></i> åˆ é™¤
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // æ‰“å¼€æ¨¡ç‰ˆç¼–è¾‘æ¨¡æ€æ¡†
        function openTemplateModal() {
            currentEditTemplateId = null;
            document.getElementById('templateModalTitle').textContent = 'æ–°å»ºç”µä»·æ¨¡ç‰ˆ';
            document.getElementById('templateForm').reset();
            clearTimePeriods();
            hideTemplateSections();
            document.getElementById('templateModal').classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
        }

        // ç¼–è¾‘æ¨¡ç‰ˆ
        function editTemplate(id) {
            const template = priceTemplates.find(t => t.id === id);
            if (!template) return;

            currentEditTemplateId = id;
            document.getElementById('templateModalTitle').textContent = 'ç¼–è¾‘ç”µä»·æ¨¡ç‰ˆ';
            document.getElementById('templateName').value = template.name;
            document.getElementById('templateStrategy').value = template.type;
            document.getElementById('templateDescription').value = template.description || '';

            onTemplateStrategyChange();

            if (template.type === 'fixed') {
                document.getElementById('fixedBuyPrice').value = template.fixedPrice.buyPrice;
                document.getElementById('fixedSellPrice').value = template.fixedPrice.sellPrice;
            } else {
                clearTimePeriods();
                template.periods.forEach(period => addTimePeriod(period));
            }

            document.getElementById('templateModal').classList.add('active');
        }

        // æŸ¥çœ‹æ¨¡ç‰ˆ
        function viewTemplate(id) {
            editTemplate(id);
            // å¯ä»¥æ·»åŠ åªè¯»é€»è¾‘
        }

        // åˆ é™¤æ¨¡ç‰ˆ
        function deleteTemplate(id) {
            const appliedSites = sites.filter(s => s.templateId === id);
            if (appliedSites.length > 0) {
                showToast(`è¯¥æ¨¡ç‰ˆå·²åº”ç”¨åˆ°${appliedSites.length}ä¸ªç«™ç‚¹ï¼Œæ— æ³•åˆ é™¤`, 'error');
                return;
            }

            if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ¨¡ç‰ˆå—ï¼Ÿ')) {
                priceTemplates = priceTemplates.filter(t => t.id !== id);
                renderTemplatesTable();
                showToast('åˆ é™¤æˆåŠŸ', 'success');
            }
        }

        // ç­–ç•¥ç±»å‹å˜æ›´
        function onTemplateStrategyChange() {
            const strategy = document.getElementById('templateStrategy').value;
            hideTemplateSections();

            if (strategy === 'fixed') {
                document.getElementById('fixedPriceSection').style.display = 'block';
            } else if (strategy === 'tou' || strategy === 'peak-valley' || strategy === 'tiered') {
                document.getElementById('periodPriceSection').style.display = 'block';
            }
        }

        function hideTemplateSections() {
            document.getElementById('fixedPriceSection').style.display = 'none';
            document.getElementById('periodPriceSection').style.display = 'none';
        }

        // ä¿å­˜æ¨¡ç‰ˆ
        function saveTemplate() {
            const form = document.getElementById('templateForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const name = document.getElementById('templateName').value;
            const type = document.getElementById('templateStrategy').value;
            const description = document.getElementById('templateDescription').value;

            const typeNames = {
                'peak-valley': 'å³°è°·å¹³å°–',
                'tou': 'åˆ†æ—¶ç”µä»·',
                'fixed': 'å›ºå®šç”µä»·',
                'tiered': 'é˜¶æ¢¯ç”µä»·'
            };

            const template = {
                id: currentEditTemplateId || Date.now(),
                name,
                type,
                typeName: typeNames[type],
                description,
                createTime: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '-')
            };

            if (type === 'fixed') {
                template.fixedPrice = {
                    buyPrice: parseFloat(document.getElementById('fixedBuyPrice').value),
                    sellPrice: parseFloat(document.getElementById('fixedSellPrice').value)
                };
            } else {
                template.periods = [];
                document.querySelectorAll('.time-period-card').forEach(card => {
                    const typeSelect = card.querySelector('select');
                    const inputs = card.querySelectorAll('input');
                    template.periods.push({
                        type: typeSelect.value,
                        start: inputs[0].value,
                        end: inputs[1].value,
                        buyPrice: parseFloat(inputs[2].value),
                        sellPrice: parseFloat(inputs[3].value)
                    });
                });
            }

            if (currentEditTemplateId) {
                const index = priceTemplates.findIndex(t => t.id === currentEditTemplateId);
                priceTemplates[index] = template;
                showToast('æ¨¡ç‰ˆæ›´æ–°æˆåŠŸ', 'success');
            } else {
                priceTemplates.unshift(template);
                showToast('æ¨¡ç‰ˆåˆ›å»ºæˆåŠŸ', 'success');
            }

            renderTemplatesTable();
            closeTemplateModal();
        }

        // ==================== æ—¶é—´æ®µç®¡ç† ====================

        function addTimePeriod(data = null) {
            periodCounter++;
            const periodsContainer = document.getElementById('timePeriods');
            const periodCard = document.createElement('div');
            periodCard.className = 'time-period-card';
            periodCard.id = `period-${periodCounter}`;

            const typeOptions = {
                'super-peak': { label: 'å°–æ—¶æ®µ', icon: 'âš¡' },
                'peak': { label: 'å³°æ—¶æ®µ', icon: 'ğŸ“ˆ' },
                'flat': { label: 'å¹³æ—¶æ®µ', icon: 'â¡ï¸' },
                'valley': { label: 'è°·æ—¶æ®µ', icon: 'ğŸ“‰' }
            };

            const selectedType = data?.type || 'peak';

            periodCard.innerHTML = `
                <div class="time-period-header">
                    <div class="time-period-type">
                        <div class="time-period-type-icon ${selectedType}">
                            ${typeOptions[selectedType].icon}
                        </div>
                        <select class="form-select" style="background: transparent; border: none; font-weight: 600; cursor: pointer; padding: 0;">
                            ${Object.entries(typeOptions).map(([value, {label}]) =>
                                `<option value="${value}" ${value === selectedType ? 'selected' : ''}>${label}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <button type="button" class="time-period-remove" onclick="removePeriod(${periodCounter})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="time-period-fields">
                    <div class="form-group">
                        <label class="form-label">å¼€å§‹æ—¶é—´</label>
                        <input type="time" class="form-input" value="${data?.start || '00:00'}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç»“æŸæ—¶é—´</label>
                        <input type="time" class="form-input" value="${data?.end || '23:59'}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ä¹°å…¥ç”µä»·(å…ƒ/kWh)</label>
                        <input type="number" class="form-input" placeholder="0.00" step="0.01" min="0" value="${data?.buyPrice || ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å–å‡ºç”µä»·(å…ƒ/kWh)</label>
                        <input type="number" class="form-input" placeholder="0.00" step="0.01" min="0" value="${data?.sellPrice || ''}">
                    </div>
                </div>
            `;

            periodsContainer.appendChild(periodCard);
        }

        function removePeriod(periodId) {
            const periodCard = document.getElementById(`period-${periodId}`);
            if (periodCard) periodCard.remove();
        }

        function clearTimePeriods() {
            document.getElementById('timePeriods').innerHTML = '';
            periodCounter = 0;
        }

        // ==================== ç”µç«™é…ç½®åŠŸèƒ½ ====================

        // æ¸²æŸ“ç”µç«™å¡ç‰‡
        function renderSitesCards() {
            const container = document.getElementById('sitesContainer');

            if (sites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-building"></i></div>
                        <h3 class="empty-state-title">æš‚æ— ç”µç«™</h3>
                    </div>
                `;
                return;
            }

            container.innerHTML = sites.map(site => {
                const template = site.templateId ? priceTemplates.find(t => t.id === site.templateId) : null;

                return `
                    <div class="site-card">
                        <div class="site-card-header">
                            <div>
                                <div class="site-name">
                                    <i class="fas fa-building" style="color: #3b82f6; margin-right: 8px;"></i>
                                    ${site.name}
                                </div>
                            </div>
                            <div class="action-buttons">
                                ${template ? `
                                    <button class="btn btn-secondary" onclick="viewSiteTemplate('${site.id}')">
                                        <i class="fas fa-eye"></i> æŸ¥çœ‹é…ç½®
                                    </button>
                                    <button class="btn btn-primary" onclick="changeSiteTemplate('${site.id}')">
                                        <i class="fas fa-exchange-alt"></i> æ›´æ¢æ¨¡ç‰ˆ
                                    </button>
                                ` : `
                                    <button class="btn btn-success" onclick="applySiteTemplate('${site.id}')">
                                        <i class="fas fa-plus"></i> åº”ç”¨æ¨¡ç‰ˆ
                                    </button>
                                `}
                            </div>
                        </div>
                        <div class="site-info">
                            <div class="info-item">
                                <div class="info-label">æ‰€åœ¨åœ°åŒº</div>
                                <div class="info-value">${site.location}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">è£…æœºå®¹é‡</div>
                                <div class="info-value">${site.capacity}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">è®¾å¤‡æ•°é‡</div>
                                <div class="info-value">${site.deviceCount} å°</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å½“å‰ç”µä»·æ¨¡ç‰ˆ</div>
                                <div class="info-value">
                                    ${template
                                        ? `<span class="badge badge-success">${template.name}</span>`
                                        : `<span class="badge badge-gray">æœªé…ç½®</span>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åº”ç”¨æ¨¡ç‰ˆåˆ°ç«™ç‚¹
        function applySiteTemplate(siteId) {
            currentApplySiteId = siteId;

            // å¡«å……æ¨¡ç‰ˆé€‰æ‹©å™¨
            const select = document.getElementById('applyTemplateSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡ç‰ˆ</option>' +
                priceTemplates.map(t => `<option value="${t.id}">${t.name} (${t.typeName})</option>`).join('');

            // è®¾ç½®é»˜è®¤ç”Ÿæ•ˆæ—¶é—´ä¸ºå½“å‰æ—¶é—´
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('applyEffectiveTime').value = now.toISOString().slice(0, 16);

            document.getElementById('applyTemplateModal').classList.add('active');
        }

        // æ›´æ¢ç«™ç‚¹æ¨¡ç‰ˆ
        function changeSiteTemplate(siteId) {
            applySiteTemplate(siteId);
        }

        // æŸ¥çœ‹ç«™ç‚¹æ¨¡ç‰ˆé…ç½®
        function viewSiteTemplate(siteId) {
            const site = sites.find(s => s.id === siteId);
            if (!site || !site.templateId) return;

            const template = priceTemplates.find(t => t.id === site.templateId);
            if (!template) return;

            viewTemplate(template.id);
        }

        function closeApplyModal() {
            document.getElementById('applyTemplateModal').classList.remove('active');
            currentApplySiteId = null;
        }

        // ç¡®è®¤åº”ç”¨æ¨¡ç‰ˆ
        function confirmApplyTemplate() {
            const templateId = parseInt(document.getElementById('applyTemplateSelect').value);
            const effectiveTime = document.getElementById('applyEffectiveTime').value;

            if (!templateId) {
                showToast('è¯·é€‰æ‹©ç”µä»·æ¨¡ç‰ˆ', 'error');
                return;
            }

            if (!effectiveTime) {
                showToast('è¯·è®¾ç½®ç”Ÿæ•ˆæ—¶é—´', 'error');
                return;
            }

            const site = sites.find(s => s.id === currentApplySiteId);
            const template = priceTemplates.find(t => t.id === templateId);

            site.templateId = templateId;
            site.effectiveTime = effectiveTime;

            closeApplyModal();
            renderSitesCards();
            showToast(`æˆåŠŸå°†"${template.name}"åº”ç”¨åˆ°"${site.name}"`, 'success');
        }

        function refreshSites() {
            renderSitesCards();
            showToast('å·²åˆ·æ–°', 'success');
        }

        // ==================== å·¥å…·å‡½æ•° ====================

        function showToast(message, type = 'success') {
            const colors = {
                'success': '#22c55e',
                'error': '#ef4444',
                'info': '#3b82f6'
            };

            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${colors[type]};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const toastAnimationStyle = document.createElement('style');
        toastAnimationStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(toastAnimationStyle);
    </script>
</body>
</html>
