<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备管理 - 储能柜管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- 不需要Three.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="navbar.js"></script>
    <style>
        /* 页面布局 */
        .main-content {
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 20px;
        }
        
        th[data-sort]:hover {
            background-color: rgba(59, 130, 246, 0.05);
            color: var(--primary-color);
        }
        
        .sort-icon {
            transition: all 0.2s ease;
        }
        
        /* 深色主题下的抽屉样式 */
        [data-theme="dark"] #addDeviceDrawer > div:last-child {
            background: #1e293b;
        }
        
        [data-theme="dark"] #addDeviceDrawer input {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] #addDeviceDrawer .btn {
            background: #334155;
            border-color: #475569;
        }
        
        [data-theme="dark"] #addDeviceDrawer .btn:hover {
            background: #475569;
        }
        
        /* 深色主题下的删除确认弹窗 */
        [data-theme="dark"] #deleteConfirmModal > div {
            background: #1e293b;
        }
        
        [data-theme="dark"] #deleteConfirmModal h3,
        [data-theme="dark"] #deleteConfirmModal p {
            color: #e2e8f0;
        }
        
        /* 可拖动弹窗样式 */
        .floating-modal {
            position: absolute;
            top: 50px;
            right: 30px;
            width: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 999;
            display: block;
            transition: all 0.3s ease;
        }
        
        /* 放大状态 */
        .floating-modal.expanded {
            transform: scale(1.5);
            transform-origin: top right;
        }
        
        [data-theme="dark"] .floating-modal {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .floating-modal:hover {
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
        }
        
        /* 弹窗头部 */
        .modal-header {
            padding: 6px 16px 8px 16px;
            user-select: none;
            position: relative;
        }
        
        /* 缩放按钮 */
        .resize-button {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        .resize-button:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .resize-button:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        /* 拖动手柄 */
        .drag-handle {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 12px;
            cursor: move;
            margin-bottom: 6px;
        }
        
        .drag-handle::before {
            content: '';
            width: 24px;
            height: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 2px;
            transition: background 0.2s;
        }
        
        .drag-handle:hover::before {
            background: rgba(0, 0, 0, 0.5);
        }
        
        [data-theme="dark"] .drag-handle::before {
            background: rgba(255, 255, 255, 0.3);
        }
        
        [data-theme="dark"] .drag-handle:hover::before {
            background: rgba(255, 255, 255, 0.5);
        }
        
        
        /* Tab 切换按钮 - 查询区域上方 */
        .tab-switcher {
            display: flex;
            flex-direction: row;
            gap: 8px;
        }
        
        .tab-button {
            position: relative;
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background: white;
            color: #64748b;
            cursor: pointer;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            overflow: hidden;
        }
        
        [data-theme="dark"] .tab-button {
            background: #1e293b;
            border-color: #475569;
        }
        
        /* 深色主题下的自定义下拉框样式 */
        [data-theme="dark"] #siteDropdown {
            background: #1e293b;
            border-color: #475569;
        }
        
        [data-theme="dark"] .site-option:hover {
            background: #334155 !important;
        }
        
        [data-theme="dark"] .site-option {
            color: #e2e8f0;
        }
        
        .tab-button i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }
        
        .tab-button span {
            font-size: 14px;
        }
        
        .tab-button:hover {
            color: #3562E3;
            background: rgba(53, 98, 227, 0.05);
            border-color: #3562E3;
            transform: translateY(-1px);
        }
        
        .tab-button:hover i {
            transform: scale(1.1);
        }
        
        .tab-button.active {
            background: #3562E3;
            color: white;
            border-color: #3562E3;
            box-shadow: 0 4px 12px rgba(53, 98, 227, 0.2);
            transform: translateY(-1px);
        }
        
        .tab-button.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            border-radius: 8px;
        }
        
        /* 弹窗内容 */
        .modal-content {
            padding: 4px 16px 8px 16px;
            min-height: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* 占位内容样式 */
        .tab-content {
            display: none;
            min-height: 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 3D场景容器样式 */
        #scene-container {
            width: 100%;
            height: calc(100vh - 64px); /* 减去顶部导航栏高度 */
            position: relative;
            background: transparent;
            border-radius: 0; /* 移除圆角以实现真正全屏 */
            overflow: visible;
            display: none;
        }
        
        #scene-container canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }
        
        /* 确保主内容区域有相对定位 */
        .main-content {
            position: relative;
        }
        
        /* 3D场景中的2D电池样式 */
        .battery-icon-3d {
            width: 60px;
            height: 30px;
            border: 2px solid #334155;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            background: #0a0a0a;
        }
        
        .battery-icon-3d::after {
            content: '';
            position: absolute;
            right: -4px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 12px;
            background: #334155;
            border-radius: 0 2px 2px 0;
        }
        
        .battery-level-3d {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            transition: width 0.3s ease;
        }

        /* 视图切换按钮 */
        .view-switcher {
            display: flex;
            gap: 12px;
            margin-left: auto;
        }

        .view-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .view-btn:hover {
            background: var(--bg-secondary);
        }

        .view-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 表格视图样式 */
        .table-view {
            display: block;
        }

        .station-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .station-table th {
            background: var(--bg-secondary);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .station-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .station-table tr:hover {
            background: var(--bg-secondary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.online {
            background: #10b981;
            color: white;
        }

        .status-badge.offline {
            background: #ef4444;
            color: white;
        }

        .status-badge.warning {
            background: #f59e0b;
            color: white;
        }

        /* 3D视图样式 */
        .three-d-view {
            display: none;
            height: calc(100vh - 160px);
            position: relative;
        }

        #canvas-container {
            width: 100%;
            height: 100%;
            background: #f5f5f5;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        /* 储能柜信息面板 */
        .cabinet-info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background: transparent;
            border-radius: 0;
            padding: 20px;
            box-shadow: none;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        .cabinet-info-panel.active {
            display: block;
        }

        [data-theme="dark"] .cabinet-info-panel {
            background: transparent;
        }

        .cabinet-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cabinet-info-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close-panel {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        /* 零部件列表 */
        .component-list {
            margin-top: 20px;
        }

        .component-item {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .component-item:hover {
            background: var(--primary-color);
            color: white;
            transform: translateX(4px);
        }

        .component-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .component-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* 数据图表区域 */
        .data-charts {
            margin-top: 20px;
        }

        .chart-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .chart-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .chart-content {
            height: 300px;
            background: var(--bg-secondary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        /* 3D控制按钮 */
        .three-d-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px;
            border-radius: 8px;
        }

        [data-theme="dark"] .three-d-controls {
            background: rgba(30, 41, 59, 0.9);
        }

        .control-btn {
            padding: 8px 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            opacity: 0.8;
        }

        /* 加载提示 */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 2D平面视图样式 */
        .cabinet-grid {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            padding: 40px;
            background: #f0f0f0;
            box-sizing: border-box;
            overflow: auto;
        }
        
        /* 适应不同屏幕尺寸 */
        @media (max-width: 1200px) {
            .cabinet-grid {
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .cabinet-grid {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(4, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .cabinet-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                padding: 20px;
            }
        }
        
        /* 3D场景信息面板样式 */
        .info-section {
            margin-bottom: 20px;
        }
        
        .info-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        
        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 站点选择tab样式 */
        .site-tab {
            position: relative;
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            min-width: 70px;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
        }

        .site-tab:hover {
            color: #3562E3;
            background: rgba(53, 98, 227, 0.05);
        }

        .site-tab.active {
            color: #3562E3;
            border-bottom-color: #3562E3;
        }

        .site-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 20%;
            right: 20%;
            height: 2px;
            background: #3562E3;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { width: 0; left: 50%; right: 50%; }
            to { left: 20%; right: 20%; }
        }

        .site-name {
            font-size: 13px;
            font-weight: 600;
        }

        .site-info {
            font-size: 11px;
            opacity: 0.8;
        }

        .site-tab.active .site-info {
            opacity: 1;
            color: #3562E3;
        }

        /* 滚动箭头样式 */
        .scroll-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border: none;
            background: white;
            color: #64748b;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scroll-arrow:hover {
            background: #f8fafc;
            color: #3562E3;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .scroll-arrow:active {
            transform: translateY(-50%) scale(0.95);
        }

        .scroll-arrow-left {
            left: 8px;
        }

        .scroll-arrow-right {
            right: 8px;
        }

        .scroll-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* 隐藏默认滚动条 */
        .site-tabs-container {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .site-tabs-container::-webkit-scrollbar {
            display: none;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .cabinet-info-panel {
                width: 100%;
                right: 0;
                top: auto;
                bottom: 0;
                max-height: 50vh;
                border-radius: 0;
            }

            .three-d-controls {
                bottom: auto;
                top: 20px;
            }
        }

        .metric-box {
            background: var(--bg-primary);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        [data-theme="dark"] .metric-box {
            background: #0f172a;
        }

        /* 动画效果 */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* 能量流视图样式 - 电气单线图风格 */
        #energy-flow-container {
            width: 100%;
            height: calc(100vh - 64px - 60px - 20px);
            position: relative;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: auto;
            display: none;
        }

        .energy-flow-canvas {
            width: 100%;
            min-height: 100%;
            position: relative;
            padding: 40px;
            background: var(--bg-primary);
            overflow: auto;
        }

        /* 设备容器样式 */
        #devicesContainer {
            background: var(--bg-secondary);
            background-image:
                linear-gradient(rgba(148, 163, 184, 0.08) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.08) 1px, transparent 1px);
            background-size: 100px 100px;
        }

        /* 深色主题适配 */
        [data-theme="dark"] #devicesContainer {
            background: #0f172a;
            background-image:
                linear-gradient(rgba(148, 163, 184, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(148, 163, 184, 0.05) 1px, transparent 1px);
            background-size: 100px 100px;
        }

        /* 层级容器 */
        .flow-layer {
            width: 100%;
            min-height: 180px;
            margin-bottom: 60px;
            position: relative;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s ease;
        }

        .flow-layer:hover {
            border-color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .flow-layer-title {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 16px;
            font-weight: 600;
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 8px;
        }

        /* 设备节点样式 - 现代卡片风格 */
        .flow-device {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: move;
            position: relative;
            z-index: 10;
        }

        .flow-device:hover {
            background: var(--bg-primary);
            border-color: #3562E3;
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(53, 98, 227, 0.25);
        }

        /* 设备选中状态 */
        .flow-device.selected {
            border: 3px solid #3562E3 !important;
            box-shadow:
                0 0 0 4px rgba(53, 98, 227, 0.1),
                0 10px 25px -5px rgba(53, 98, 227, 0.4) !important;
            background: var(--bg-primary);
        }

        /* 深色主题适配 */
        [data-theme="dark"] .flow-device {
            background: #1e293b;
            border-color: #374151;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] .flow-device:hover {
            border-color: #60a5fa;
            box-shadow: 0 10px 25px -5px rgba(96, 165, 250, 0.3);
        }

        [data-theme="dark"] .flow-device.selected {
            border-color: #60a5fa !important;
            box-shadow:
                0 0 0 4px rgba(96, 165, 250, 0.15),
                0 10px 25px -5px rgba(96, 165, 250, 0.4) !important;
        }

        /* 连接点容器 */
        .connection-points {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: block;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        /* 编辑模式下悬浮或选中时显示连接点 */
        .flow-device:hover .connection-points,
        .flow-device.selected .connection-points {
            opacity: 1;
        }

        /* 单个连接点 */
        .connection-point {
            position: absolute;
            width: 14px;
            height: 14px;
            background: #3562E3;
            border: 3px solid var(--bg-primary);
            border-radius: 50%;
            cursor: crosshair;
            pointer-events: auto;
            transform: translate(-50%, -50%);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.3);
        }

        .connection-point:hover {
            width: 18px;
            height: 18px;
            background: #2952d3;
            box-shadow:
                0 0 0 4px rgba(53, 98, 227, 0.15),
                0 4px 12px rgba(53, 98, 227, 0.4);
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* 深色主题适配 */
        [data-theme="dark"] .connection-point {
            background: #60a5fa;
            border-color: #1e293b;
            box-shadow: 0 2px 8px rgba(96, 165, 250, 0.3);
        }

        [data-theme="dark"] .connection-point:hover {
            background: #3b82f6;
            box-shadow:
                0 0 0 4px rgba(96, 165, 250, 0.15),
                0 4px 12px rgba(96, 165, 250, 0.4);
        }

        /* 四个方向的连接点 */
        .connection-point.top {
            top: 0;
            left: 50%;
        }

        .connection-point.bottom {
            bottom: 0;
            left: 50%;
            transform: translate(-50%, 50%);
        }

        .connection-point.left {
            top: 50%;
            left: 0;
        }

        .connection-point.right {
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
        }

        /* 设备图标 */
        .flow-device-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 12px;
            filter: none;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flow-device:hover .flow-device-icon {
            transform: scale(1.05);
        }

        .flow-device-icon img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        /* 设备标签 */
        .flow-device-label {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            text-align: center;
            letter-spacing: 0.3px;
            width: 100%;
        }

        /* 设备外部参数显示 */
        .device-external-param {
            position: absolute;
            background: rgba(53, 98, 227, 0.1);
            border: 1px solid var(--primary-color);
            padding: 6px 12px 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            color: var(--primary-color);
            backdrop-filter: blur(4px);
            white-space: nowrap;
            cursor: move;
            user-select: none;
            pointer-events: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 15;
        }

        .device-external-param:hover {
            background: rgba(53, 98, 227, 0.2);
            border-color: #2952d3;
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.3);
        }


        [data-theme="dark"] .device-external-param {
            background: rgba(96, 165, 250, 0.15);
            border-color: #60a5fa;
            color: #60a5fa;
        }

        [data-theme="dark"] .device-external-param:hover {
            background: rgba(96, 165, 250, 0.25);
            border-color: #3b82f6;
        }

        /* 参数删除按钮 */
        .param-delete-btn {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .param-delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: scale(1.1);
        }

        [data-theme="dark"] .param-delete-btn {
            background: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.3);
            color: #f87171;
        }

        [data-theme="dark"] .param-delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* 设备卡片删除按钮（仅编辑模式显示） */
        .device-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 20;
        }

        .device-delete-btn:hover {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        }

        [data-theme="dark"] .device-delete-btn {
            background: rgba(248, 113, 113, 0.15);
            border-color: rgba(248, 113, 113, 0.3);
            color: #f87171;
        }

        [data-theme="dark"] .device-delete-btn:hover {
            background: #ef4444;
            color: white;
        }

        /* 设备参数容器（内部，已废弃） */
        .flow-device-params {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        /* 单个参数 */
        .flow-device-param {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            padding: 2px 0;
        }

        .flow-device-param.power {
            color: #3562E3;
        }

        .flow-device-param.positive {
            color: #10b981;
        }

        .flow-device-param.negative {
            color: #ef4444;
        }

        /* 汇流柜样式 */
        .flow-busbar-device {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .flow-busbar-icon {
            width: 60px;
            height: 60px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .flow-busbar-icon i {
            color: var(--primary-color);
            font-size: 32px;
        }

        /* PCS和BMS节点样式 */
        .flow-pcs-bms-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 30px;
        }

        .flow-pcs-device {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }

        .flow-pcs-icon {
            width: 50px;
            height: 50px;
            margin-bottom: 8px;
            filter: grayscale(20%);
        }

        .flow-bms-device {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid var(--success-color);
            border-radius: 8px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }

        .flow-bms-icon {
            width: 40px;
            height: 60px;
            background: var(--success-color);
            border-radius: 4px;
            margin-bottom: 8px;
            position: relative;
            border: 2px solid var(--success-color);
        }

        .flow-bms-icon::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        /* SVG连接线容器 */
        .energy-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* 连接线基础样式 - 实线 */
        .energy-connection-line,
        .flow-busbar,
        .flow-vline {
            stroke: #3562E3;
            stroke-width: 3px;
            fill: none;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: all 0.3s ease;
            /* 实线，不使用虚线 */
        }

        /* 悬浮状态 */
        .energy-connection-line:hover {
            stroke: #2952d3;
            stroke-width: 4px;
            filter: drop-shadow(0 0 8px rgba(53, 98, 227, 0.5));
        }

        /* 选中状态 */
        .energy-connection-line.selected {
            stroke: #10b981;
            stroke-width: 4px;
            filter: drop-shadow(0 0 12px rgba(16, 185, 129, 0.6));
        }

        /* 连接点标记 */
        .flow-connection-point {
            fill: #3562E3;
            r: 4;
        }

        /* 能量流动方向箭头 */
        .energy-flow-arrow {
            fill: #3562E3;
            filter: drop-shadow(0 2px 4px rgba(53, 98, 227, 0.3));
        }

        /* 流动粒子动画 */
        @keyframes flowAnimation {
            0% {
                stroke-dashoffset: 20;
                opacity: 1;
            }
            100% {
                stroke-dashoffset: 0;
                opacity: 0.8;
            }
        }

        /* 流动动画 - 实线微动效（通过柔和的阴影变化） */
        .flow-vline.animated,
        .energy-connection-line.flowing {
            animation: flowPulse 3s ease-in-out infinite;
        }

        /* 流入动画（正向） - 仅发光效果 */
        .energy-connection-line.flow-in {
            filter: drop-shadow(0 0 4px rgba(53, 98, 227, 0.6));
        }

        /* 流出动画（反向） - 仅发光效果 */
        .energy-connection-line.flow-out {
            filter: drop-shadow(0 0 4px rgba(239, 68, 68, 0.6));
        }

        /* 通用脉冲动画 */
        @keyframes flowPulse {
            0%, 100% {
                filter: drop-shadow(0 0 2px rgba(53, 98, 227, 0.3));
            }
            50% {
                filter: drop-shadow(0 0 5px rgba(53, 98, 227, 0.7));
            }
        }

        /* 流动粒子效果 */
        .flow-particle {
            fill: #00d9ff;
            animation: particleMove 2s linear infinite;
        }

        @keyframes particleMove {
            0% {
                offset-distance: 0%;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                offset-distance: 100%;
                opacity: 0;
            }
        }

        /* 深色主题适配 */
        [data-theme="dark"] .energy-connection-line,
        [data-theme="dark"] .flow-busbar,
        [data-theme="dark"] .flow-vline {
            stroke: #60a5fa;
        }

        [data-theme="dark"] .energy-connection-line:hover {
            stroke: #3b82f6;
        }

        [data-theme="dark"] .flow-connection-point,
        [data-theme="dark"] .energy-flow-arrow {
            fill: #60a5fa;
        }

        /* 设备列表面板 */
        .device-list-panel {
            position: fixed;
            top: 230px;
            left: 276px;
            width: 280px;
            max-height: calc(100vh - 250px);
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            z-index: 150;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .device-list-title {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-toggle-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .panel-toggle-btn:hover {
            background: var(--primary-color);
            color: white;
        }

        /* 面板收起状态 */
        .device-list-panel.collapsed {
            width: 48px;
            padding: 12px;
        }

        .device-list-panel.collapsed .device-list-title span,
        .device-list-panel.collapsed .device-category {
            display: none;
        }

        /* 右侧设备设置面板 */
        .device-settings-panel {
            position: fixed;
            top: 230px;
            right: 20px;
            width: 320px;
            max-height: calc(100vh - 250px);
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            z-index: 150;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .device-settings-panel.collapsed {
            width: 48px;
            padding: 12px;
        }

        .device-settings-panel.collapsed .device-list-title span,
        .device-settings-panel.collapsed #settingsPanelContent {
            display: none;
        }

        /* 设置项样式 */
        .settings-item {
            margin-bottom: 16px;
        }

        .settings-item-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .settings-item-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .settings-item-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .settings-item-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        .settings-actions {
            display: flex;
            gap: 8px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .settings-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .settings-btn.primary:hover {
            background: #2451cc;
        }

        .settings-btn.danger {
            background: #ef4444;
            color: white;
        }

        .settings-btn.danger:hover {
            background: #dc2626;
        }

        .device-category {
            margin-bottom: 20px;
        }

        .device-category-title {
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-category-icon {
            font-size: 18px;
        }

        .device-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .device-item:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary-color);
            transform: translateX(4px);
        }

        .device-item:active {
            cursor: grabbing;
        }

        .device-item-icon {
            font-size: 24px;
        }

        .device-item-info {
            flex: 1;
        }

        .device-item-name {
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
        }

        .device-item-desc {
            color: var(--text-secondary);
            font-size: 11px;
            margin-top: 2px;
        }

        /* 拖拽占位符 */
        .drag-placeholder {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.7;
            background: rgba(59, 130, 246, 0.1);
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            padding: 10px;
            display: none;
        }

        /* 能量流页面头部 */
        .energy-flow-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .energy-flow-title {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .energy-flow-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* 工具栏 (保留原有样式作为备用) */
        .energy-flow-toolbar {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
            box-shadow: var(--shadow-lg);
        }

        .toolbar-btn {
            min-width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 12px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            white-space: nowrap;
        }

        .toolbar-btn i {
            font-size: 16px;
            color: var(--primary-color);
        }

        .toolbar-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--primary-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.15);
        }

        .toolbar-btn.active,
        .toolbar-btn.primary {
            background: linear-gradient(135deg, #3562E3 0%, #2952d3 100%);
            color: white;
            border-color: #3562E3;
        }

        .toolbar-btn.active i,
        .toolbar-btn.primary i {
            color: white;
        }

        .toolbar-btn.active:hover,
        .toolbar-btn.primary:hover {
            background: #2952d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(53, 98, 227, 0.3);
        }

        /* 工具栏按钮悬停提示 */
        .toolbar-btn::before {
            content: attr(title);
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
            z-index: 300;
        }

        .toolbar-btn:hover::before {
            opacity: 1;
        }

        /* 设备配置面板 */
        .device-config-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            z-index: 100;
        }

        .config-panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .device-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .device-type-btn {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .device-type-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
        }

        .device-type-icon {
            font-size: 20px;
        }

        .device-type-label {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* 能量流信息面板 */
        .energy-info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow-lg);
            min-width: 250px;
            z-index: 100;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 设备详情面板样式 */
        /* 面板蒙版 */
        .device-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .device-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* 设备详情面板 */
        .device-detail-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            height: 100vh;
            background: #ffffff;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .device-detail-panel.active {
            right: 0;
        }

        .device-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: linear-gradient(135deg, #f8f9fb 0%, #ffffff 100%);
            border-bottom: 1px solid #e0e6ed;
        }

        .device-panel-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }

        .device-panel-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3562E3 0%, #2952d3 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            padding: 6px;
        }

        .device-panel-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .device-panel-close {
            width: 32px;
            height: 32px;
            background: #f5f7fa;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #64748b;
        }

        .device-panel-close:hover {
            background: #e0e6ed;
            border-color: #cbd5e1;
            color: #2c3e50;
        }

        .device-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f5f7fa;
        }

        /* Header actions container */
        .device-panel-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* View details link */
        .device-detail-link {
            font-size: 14px;
            font-weight: 500;
            color: #3562E3;
            text-decoration: none;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .device-detail-link:hover {
            color: #2952d3;
            text-decoration: underline;
        }

        .device-section {
            margin-bottom: 24px;
        }

        .device-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .device-section-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: linear-gradient(180deg, #3562E3 0%, #2952d3 100%);
            border-radius: 2px;
        }

        .device-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .device-data-card {
            background: #ffffff;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.2s;
        }

        .device-data-card:hover {
            background: #f8f9fb;
            border-color: #3562E3;
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.1);
        }

        .device-data-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .device-data-value {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: baseline;
            gap: 4px;
        }

        .device-data-unit {
            font-size: 12px;
            font-weight: 400;
            color: #64748b;
        }

        .device-data-card.highlight {
            background: linear-gradient(135deg, rgba(53, 98, 227, 0.05) 0%, rgba(41, 82, 211, 0.05) 100%);
            border-color: #3562E3;
        }

        .device-data-card.highlight .device-data-value {
            color: #3562E3;
        }

        .device-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: rgba(40, 199, 111, 0.1);
            border: 1px solid rgba(40, 199, 111, 0.3);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            color: #28c76f;
        }

        .device-status-badge::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #28c76f;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(40, 199, 111, 0.6);
        }

        .device-status-badge.warning {
            background: rgba(255, 159, 67, 0.1);
            border-color: rgba(255, 159, 67, 0.3);
            color: #ff9f43;
        }

        .device-status-badge.warning::before {
            background: #ff9f43;
            box-shadow: 0 0 8px rgba(255, 159, 67, 0.6);
        }

        .device-status-badge.error {
            background: rgba(234, 84, 85, 0.1);
            border-color: rgba(234, 84, 85, 0.3);
            color: #ea5455;
        }

        .device-status-badge.error::before {
            background: #ea5455;
            box-shadow: 0 0 8px rgba(234, 84, 85, 0.6);
        }

        .device-data-full {
            grid-column: span 2;
        }

        .device-panel-body::-webkit-scrollbar {
            width: 6px;
        }

        .device-panel-body::-webkit-scrollbar-track {
            background: #f5f7fa;
        }

        .device-panel-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .device-panel-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

    </style>
</head>
<body data-page="devices">
    <!-- 主内容区域 -->
    <main class="main-content" id="mainContent">
        <!-- 页面标题和视图切换 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 24px;">
                <!-- 统一的站点选择器（两个视图共用） -->
                <div style="display: flex; gap: 12px; align-items: center;">
                    <label style="font-size: 14px; font-weight: 500; color: #333; white-space: nowrap;" data-translate="devicesSelectSite">选择站点：</label>
                    <select id="unifiedSiteSelect" onchange="handleSiteChange()" style="padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white; cursor: pointer; min-width: 200px;">
                        <option value="" data-translate="devicesAllSites">全部站点</option>
                        <option value="site1" data-translate="siteNameTech">科技园区站</option>
                        <option value="site2" data-translate="siteNameIndustrial">工业园区站</option>
                        <option value="site3" data-translate="siteNameCommerce">商业中心站</option>
                        <option value="site4" data-translate="siteNameLogistics">物流园区站</option>
                        <option value="site5" data-translate="siteNameRD">研发中心站</option>
                        <option value="site6" data-translate="siteNameDataCenter">数据中心站</option>
                        <option value="sz" data-translate="siteOptionShenzhen">深圳储能站 (8台 • 2.5MWh)</option>
                        <option value="gz" data-translate="siteOptionGuangzhou">广州储能站 (12台 • 3.75MWh)</option>
                        <option value="sh" data-translate="siteOptionShanghai">上海储能站 (10台 • 3.1MWh)</option>
                        <option value="bj" data-translate="siteOptionBeijing">北京储能站 (15台 • 4.7MWh)</option>
                        <option value="cd" data-translate="siteOptionChengdu">成都储能站 (6台 • 1.9MWh)</option>
                        <option value="hz" data-translate="siteOptionHangzhou">杭州储能站 (9台 • 2.8MWh)</option>
                        <option value="wh" data-translate="siteOptionWuhan">武汉储能站 (11台 • 3.4MWh)</option>
                        <option value="xa" data-translate="siteOptionXian">西安储能站 (8台 • 2.5MWh)</option>
                        <option value="nj" data-translate="siteOptionNanjing">南京储能站 (7台 • 2.2MWh)</option>
                        <option value="cq" data-translate="siteOptionChongqing">重庆储能站 (13台 • 4.1MWh)</option>
                    </select>
                </div>
            </div>
            
            <!-- 视图切换按钮 -->
            <div class="tab-switcher" id="viewSwitcher">
                <button class="tab-button active" onclick="switchTab('table')" id="tableViewBtn" title="表格视图">
                    <i class="fas fa-table"></i>
                    <span data-translate="devicesTabTable">表格视图</span>
                </button>
                <button class="tab-button" onclick="switchTab('view')" id="sceneViewBtn" title="场景视图">
                    <i class="fas fa-cube"></i>
                    <span data-translate="devicesTabScene">场景视图</span>
                </button>
                <button class="tab-button" onclick="switchTab('flow')" id="flowViewBtn" title="能量流" style="display: none;">
                    <i class="fas fa-project-diagram"></i>
                    <span data-translate="devicesTabFlow">能量流</span>
                </button>
            </div>
        </div>
        
        <!-- 表格视图内容容器 -->
        <div id="content-container">
            <!-- 查询区域 -->
            <div id="query-area" class="card" style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; flex: 1;">
                    <div class="input-wrapper">
                        <i class="fas fa-search input-icon"></i>
                        <input type="text" id="searchInput" class="form-input" data-translate-placeholder="devicesSearchPlaceholder" placeholder="搜索设备..." style="width: 250px; height: 40px; padding-left: 40px;">
                    </div>
                    <select id="modeFilter" class="form-input" style="width: 150px; height: 40px; padding-left: 12px;">
                        <option value="" data-translate="devicesAllModes">全部模式</option>
                        <option value="manual-charge" data-translate="devicesModeManualCharge">手动充电</option>
                        <option value="manual-discharge" data-translate="devicesModeManualDischarge">手动放电</option>
                        <option value="standby" data-translate="devicesModeStandby">待机中</option>
                        <option value="auto-charge" data-translate="devicesModeAutoCharge">自动充电</option>
                        <option value="auto-discharge" data-translate="devicesModeAutoDischarge">自动放电</option>
                        <option value="waiting" data-translate="devicesModeWaiting">等待执行</option>
                    </select>
                    <select id="statusFilter" class="form-input" style="width: 120px; height: 40px; padding-left: 12px;">
                        <option value="" data-translate="devicesAllStatus">全部状态</option>
                        <option value="charging" data-translate="devicesStatusCharging">充电</option>
                        <option value="discharging" data-translate="devicesStatusDischarging">放电</option>
                        <option value="offline" data-translate="devicesStatusOffline">离线</option>
                        <option value="standby" data-translate="devicesStatusStandby">待机</option>
                    </select>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn" onclick="searchDevices()" style="height: 40px; padding: 0 16px;">
                        <i class="fas fa-search"></i> <span data-translate="devicesBtnSearch">查询</span>
                    </button>
                    <button class="btn" onclick="resetSearch()" style="height: 40px; padding: 0 16px;">
                        <i class="fas fa-redo"></i> <span data-translate="devicesBtnReset">重置</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 表格视图容器 -->
        <div id="table-view" class="card">
            <div style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="showAddDeviceModal()" style="height: 40px; padding: 0 16px; width: auto; display: inline-block;">
                    <i class="fas fa-plus"></i>
                    <span data-translate="devicesBtnAdd">添加设备</span>
                </button>
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 0 8px; height: 40px; border: 1px solid var(--border-color); border-radius: 6px; background: white;">
                    <input type="checkbox" id="selectAllForExport" onchange="toggleSelectAllForExport()" style="width: 16px; height: 16px; cursor: pointer;">
                    <span data-translate="devicesSelectAll" style="font-size: 14px; color: var(--text-secondary);">全部设备</span>
                </label>
                <button class="btn" onclick="exportDevices()" style="height: 40px; padding: 0 16px; width: auto; display: inline-block;">
                    <i class="fas fa-download"></i>
                    <span data-translate="devicesBtnExport">导出</span>
                </button>
                <button class="btn btn-primary" onclick="showOTAUpgrade()" style="height: 40px; padding: 0 16px; width: auto; display: none; background: #10b981;">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span data-translate="devicesBtnOTA">OTA升级</span>
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table id="deviceTable" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); vertical-align: middle; width: 50px;">
                                <input type="checkbox" id="selectAllDevices" onchange="toggleSelectAll()" style="width: 16px; height: 16px; cursor: pointer;">
                            </th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); vertical-align: middle;" data-translate="devicesTableCode">设备编码</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); vertical-align: middle;" data-translate="devicesTableName">名称</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); vertical-align: middle;" data-translate="devicesTableSite">所属站点</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer; vertical-align: middle;" onclick="sortTable('soc')" data-sort="soc">
                                <div style="display: inline-flex; align-items: center; gap: 4px;">
                                    <span data-translate="devicesTableSOC">SOC</span>
                                    <span class="sort-arrows" style="display: inline-flex; flex-direction: column; align-items: center; line-height: 1;">
                                        <i class="fas fa-caret-up" style="font-size: 8px; cursor: pointer; color: #94a3b8;" onclick="event.stopPropagation(); sortTable('soc', 'asc')"></i>
                                        <i class="fas fa-caret-down" style="font-size: 8px; cursor: pointer; color: #94a3b8; margin-top: -1px;" onclick="event.stopPropagation(); sortTable('soc', 'desc')"></i>
                                    </span>
                                </div>
                            </th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer; vertical-align: middle;" onclick="sortTable('soh')" data-sort="soh">
                                <div style="display: inline-flex; align-items: center; gap: 4px;">
                                    <span data-translate="devicesTableSOH">SOH</span>
                                    <span class="sort-arrows" style="display: inline-flex; flex-direction: column; align-items: center; line-height: 1;">
                                        <i class="fas fa-caret-up" style="font-size: 8px; cursor: pointer; color: #94a3b8;" onclick="event.stopPropagation(); sortTable('soh', 'asc')"></i>
                                        <i class="fas fa-caret-down" style="font-size: 8px; cursor: pointer; color: #94a3b8; margin-top: -1px;" onclick="event.stopPropagation(); sortTable('soh', 'desc')"></i>
                                    </span>
                                </div>
                            </th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); cursor: pointer; vertical-align: middle;" onclick="sortTable('power')" data-sort="power">
                                <div style="display: inline-flex; align-items: center; gap: 4px;">
                                    <span data-translate="devicesTablePower">功率</span>
                                    <span class="sort-arrows" style="display: inline-flex; flex-direction: column; align-items: center; line-height: 1;">
                                        <i class="fas fa-caret-up" style="font-size: 8px; cursor: pointer; color: #94a3b8;" onclick="event.stopPropagation(); sortTable('power', 'asc')"></i>
                                        <i class="fas fa-caret-down" style="font-size: 8px; cursor: pointer; color: #94a3b8; margin-top: -1px;" onclick="event.stopPropagation(); sortTable('power', 'desc')"></i>
                                    </span>
                                </div>
                            </th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); vertical-align: middle;" data-translate="devicesTableMode">模式</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); vertical-align: middle;" data-translate="devicesTableStatus">状态</th>
                            <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-secondary); vertical-align: middle;" data-translate="devicesTableActions">操作</th>
                        </tr>
                    </thead>
                    <tbody id="deviceTableBody">
                        <!-- 设备数据将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 0 12px;">
                <div style="color: var(--text-secondary); font-size: 14px;">
                    <span data-translate="devicesTotalRecords">共</span> <span id="totalCount">0</span> <span data-translate="devicesTotalRecordsUnit">条记录</span>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" onclick="previousPage()" style="padding: 6px 12px;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span style="padding: 6px 12px; color: var(--text-secondary);">
                        <span data-translate="devicesPageOf">第</span> <span id="currentPage">1</span> / <span id="totalPages">1</span> <span data-translate="devicesPageTotal">页</span>
                    </span>
                    <button class="btn" onclick="nextPage()" style="padding: 6px 12px;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 3D视图容器 -->
        <div id="scene-container" style="position: relative; display: none;">
            <div class="loading-indicator" id="loadingIndicator">
                <div class="loading-spinner"></div>
                <p data-translate="devicesLoadingView">加载视图中...</p>
            </div>

            <!-- 艹！状态图例 - 放在内容区域内，左下角位置向上移100px，水平排列 -->
            <div id="devicesSceneStatusLegend" style="position: absolute; bottom: 130px; left: 30px; z-index: 100; background: rgba(255, 255, 255, 0.95); border-radius: 8px; padding: 12px 16px; box-shadow: 0 2px 12px rgba(0,0,0,0.15); display: none;">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); border-radius: 3px; box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);"></div>
                        <span style="font-size: 13px; color: #333; font-weight: 500;" data-translate="devicesPanelOnline">在线</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); border-radius: 3px; box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);"></div>
                        <span style="font-size: 13px; color: #333; font-weight: 500;" data-translate="devicesPanelOffline">离线</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 16px; height: 16px; background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); border-radius: 3px; box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);"></div>
                        <span style="font-size: 13px; color: #333; font-weight: 500;" data-translate="devicesPanelFault">故障</span>
                    </div>
                </div>
            </div>

        <!-- 统计数据面板 -->
            <div id="dataPanel" style="position: fixed; top: 150px; right: 20px; z-index: 1001; transition: all 0.3s ease; display: none;">
                <div style="background: rgba(255, 255, 255, 0.98); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 340px;">
                    <!-- 标题栏 -->
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid #e5e7eb;">
                        <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #1f2937;" data-translate="devicesPanelTitle">储能柜监控</h4>
                        <button onclick="toggleDataPanel()" style="background: none; border: none; cursor: pointer; padding: 2px; color: #64748b;">
                            <i id="panelToggleIcon" class="fas fa-chevron-up" style="font-size: 12px;"></i>
                        </button>
                    </div>
                    <!-- 内容区域 -->
                    <div id="dataPanelContent" style="padding: 12px 16px; max-height: calc(100vh - 120px); overflow-y: auto; transition: all 0.3s ease;">
                    
                    <!-- 状态概览（合并版） -->
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <div style="text-align: center; padding: 8px; background: #f0fdf4; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #10b981;" id="online-count">5</div>
                                <div style="font-size: 10px; color: #666;" data-translate="devicesPanelOnline">在线</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #fef3c7; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #f59e0b;" id="offline-count">2</div>
                                <div style="font-size: 10px; color: #666;" data-translate="devicesPanelOffline">离线</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #fee2e2; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #ef4444;" id="fault-count">1</div>
                                <div style="font-size: 10px; color: #666;" data-translate="devicesPanelFault">故障</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #dcfce7; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #10b981;" id="charging-count">3</div>
                                <div style="font-size: 10px; color: #666;" data-translate="devicesPanelCharging">充电</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #3b82f6;" id="discharging-count">2</div>
                                <div style="font-size: 10px; color: #666;" data-translate="devicesPanelDischarging">放电</div>
                            </div>
                            <div style="text-align: center; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                                <div style="font-size: 16px; font-weight: 600; color: #64748b;" id="standby-count">3</div>
                                <div style="font-size: 10px; color: #666;" data-translate="devicesPanelStandby">待机</div>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- 关键运行指标 -->
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; flex-direction: column; gap: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: #666;" data-translate="devicesPanelSystemCapacity">系统容量</span>
                                <div style="text-align: right;">
                                    <div style="font-size: 16px; font-weight: 700; color: #333;"><span id="total-capacity">2.5</span> MWh</div>
                                    <div style="font-size: 10px; color: #999;" data-translate="devicesPanelTotalCapacity">总装机容量</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: #666;" data-translate="devicesPanelCurrentEnergy">当前电量</span>
                                <div style="text-align: right;">
                                    <div style="font-size: 16px; font-weight: 700; color: #10b981;"><span id="current-energy">1.96</span> MWh</div>
                                    <div style="font-size: 10px; color: #999;"><span data-translate="devicesPanelEnergyRatio">占比</span> <span id="energy-percent">78.4</span>%</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: #666;" data-translate="devicesPanelMinSOC">最低SOC</span>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; font-weight: 600; color: #ef4444;"><span id="min-soc">15</span>%</div>
                                    <div style="font-size: 10px; color: #999;"><span data-translate="devicesPanelCabinet">储能柜</span><span id="min-soc-cabinet">008</span></div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 12px; color: #666;" data-translate="devicesPanelMinSOH">最低SOH</span>
                                <div style="text-align: right;">
                                    <div style="font-size: 14px; font-weight: 600; color: #ef4444;"><span id="min-soh">93.2</span>%</div>
                                    <div style="font-size: 10px; color: #999;"><span data-translate="devicesPanelCabinet">储能柜</span><span id="min-soh-cabinet">006</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 收益统计 -->
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 13px; font-weight: 600; color: #1f2937; margin-bottom: 12px;" data-translate="devicesPanelProfitStats">收益统计</div>
                        <div style="background: #f8fafc; border-radius: 8px; padding: 12px;">
                            <!-- 第一排 -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;" data-translate="devicesPanelYesterdayProfit">昨日收益</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #3b82f6;">¥<span id="yesterday-profit">12,350</span></div>
                                </div>
                                <div style="width: 1px; height: 40px; background: #e5e7eb;"></div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;" data-translate="devicesPanelTodayProfit">今日收益</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #10b981;">¥<span id="today-profit">8,450</span></div>
                                </div>
                            </div>
                            <!-- 第二排 -->
                            <div style="display: flex; align-items: center; justify-content: space-between; padding-top: 12px;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;" data-translate="devicesPanelMonthProfit">本月收益</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #f59e0b;">¥<span id="month-profit">326.5</span>K</div>
                                </div>
                                <div style="width: 1px; height: 40px; background: #e5e7eb;"></div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 10px; color: #666; margin-bottom: 4px;" data-translate="devicesPanelTotalProfit">累计收益</div>
                                    <div style="font-size: 16px; font-weight: 700; color: #8b5cf6;">¥<span id="total-profit">1.85</span>M</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    </div>
                </div>
            </div>

            <!-- 显示数据选择 - 移到顶部水平排列 -->
            <div id="displayDataOptions" style="position: absolute; top: 10px; left: 0px; z-index: 100;">
                <div style="background: rgba(255, 255, 255, 0.9); border-radius: 8px; padding: 12px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 20px;">
                    <div style="font-size: 14px; font-weight: 600; color: #333;" data-translate="devicesDisplayData">显示数据：</div>
                    <div style="display: flex; gap: 20px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="displayMode" value="soc" onchange="changeDisplayMode('soc')">
                            <span style="font-size: 14px; color: #666;" data-translate="devicesDisplaySOC">SOC</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="displayMode" value="power" onchange="changeDisplayMode('power')">
                            <span style="font-size: 14px; color: #666;" data-translate="devicesDisplayPower">功率</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="displayMode" value="temperature" onchange="changeDisplayMode('temperature')">
                            <span style="font-size: 14px; color: #666;" data-translate="devicesDisplayTemperature">温度</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="displayMode" value="soh" onchange="changeDisplayMode('soh')">
                            <span style="font-size: 14px; color: #666;" data-translate="devicesDisplaySOH">SOH</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="radio" name="displayMode" value="status" onchange="changeDisplayMode('status')">
                            <span style="font-size: 14px; color: #666;" data-translate="devicesDisplayStatus">状态</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- 储能柜展示区域 - 2.5D效果 -->
            <div id="cabinetDisplay" style="position: absolute; top: 80px; left: 80px; transform: perspective(1000px); z-index: 99; width: 60%; max-width: 800px;">
                <div style="transform: rotateX(30deg) translateZ(-50px); transform-style: preserve-3d;">
                    <!-- 第一排 -->
                    <div style="display: flex; justify-content: flex-start; gap: 35px; margin-bottom: 40px;">
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-1" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜001" id="cabinet-img-1" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(1)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-1" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-2" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜002" id="cabinet-img-2" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(2)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-2" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-3" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜003" id="cabinet-img-3" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(3)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-3" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-4" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜004" id="cabinet-img-4" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(4)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-4" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                    </div>
                    <!-- 第二排 -->
                    <div style="display: flex; justify-content: flex-start; gap: 35px;">
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-5" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜005" id="cabinet-img-5" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(5)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-5" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-6" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜006" id="cabinet-img-6" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(6)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-6" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-7" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜007" id="cabinet-img-7" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(7)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-7" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                        <div style="position: relative;">
                            <div class="data-label" id="data-label-8" style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; white-space: nowrap; z-index: 101; display: none;"></div>
                            <img src="储能柜.jpg" alt="储能柜008" id="cabinet-img-8" style="width: 150px; height: auto; cursor: pointer; transition: all 0.3s ease; transform: translateZ(0);" onclick="selectCabinet(8)" onmouseover="this.style.transform='translateZ(20px) scale(1.05)'" onmouseout="this.style.transform='translateZ(0)'">
                            <div class="status-overlay" id="status-overlay-8" style="position: absolute; top: calc(15% - 10px); left: calc(15% - 5px); width: calc(70% + 10px); height: calc(70% + 20px); pointer-events: none; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            

            <!-- 储能柜信息面板 -->
            <div class="cabinet-info-panel" id="cabinetInfoPanel">
                <div class="cabinet-info-header">
                    <h3 class="cabinet-info-title" id="cabinetName">储能柜 001</h3>
                    <button class="close-panel" onclick="closeCabinetPanel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- 基本信息 -->
                <div class="info-section">
                    <h4>基本信息</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">型号</span>
                            <span class="info-value" id="cabinetModel">ESS-2500</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">容量</span>
                            <span class="info-value" id="cabinetCapacity">312.5 kWh</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">当前SOC</span>
                            <span class="info-value" id="cabinetSOC">85%</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">SOH</span>
                            <span class="info-value" id="cabinetSOH">98%</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">电压</span>
                            <span class="info-value" id="cabinetVoltage">750.5 V</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">电流</span>
                            <span class="info-value" id="cabinetCurrent">168.3 A</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">功率</span>
                            <span class="info-value" id="cabinetPower">126.5 kW</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">温度</span>
                            <span class="info-value" id="cabinetTemp">26.5°C</span>
                        </div>
                    </div>
                </div>

                <!-- 零部件列表 -->
                <div class="component-list">
                    <h4>零部件</h4>
                    <div class="component-item" onclick="selectComponent('battery')">
                        <div class="component-name">电池模组</div>
                        <div class="component-status">运行正常 • 温度: 25.8°C</div>
                    </div>
                    <div class="component-item" onclick="selectComponent('pcs')">
                        <div class="component-name">PCS模块</div>
                        <div class="component-status">运行正常 • 效率: 97.2%</div>
                    </div>
                    <div class="component-item" onclick="selectComponent('bms')">
                        <div class="component-name">BMS系统</div>
                        <div class="component-status">运行正常 • CPU: 15%</div>
                    </div>
                    <div class="component-item" onclick="selectComponent('cooling')">
                        <div class="component-name">冷却系统</div>
                        <div class="component-status">运行正常 • 功率: 2.5kW</div>
                    </div>
                    <div class="component-item" onclick="selectComponent('fire')">
                        <div class="component-name">消防系统</div>
                        <div class="component-status">待机中 • 压力: 正常</div>
                    </div>
                </div>

                <!-- 数据图表 -->
                <div class="data-charts">
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="switchChartTab('realtime')">实时数据</button>
                        <button class="chart-tab" onclick="switchChartTab('history')">历史数据</button>
                    </div>
                    <div class="chart-content" id="chartContent">
                        <span>选择零部件查看数据</span>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- 能量流视图容器 - 自由画布 -->
        <div id="energy-flow-container">
            <!-- 页面头部 -->
            <div class="energy-flow-header">
                <div class="energy-flow-title">
                    <i class="fas fa-project-diagram" style="margin-right: 12px; color: #3562E3;"></i>
                    <span>能量流转图</span>
                </div>

                <div class="energy-flow-actions" style="display: flex; gap: 12px;">
                    <!-- 编辑/预览切换按钮 -->
                    <button class="toolbar-btn primary" id="editModeBtn" onclick="toggleEditMode()" title="切换编辑模式">
                        <i class="fas fa-edit"></i>
                        <span>编辑</span>
                    </button>

                    <!-- 保存按钮（只在编辑模式下显示） -->
                    <button class="toolbar-btn" id="saveBtn" onclick="saveFlowConfig()" title="保存配置" style="display: none;">
                        <i class="fas fa-save"></i>
                        <span>保存</span>
                    </button>

                    <!-- 对齐按钮组（只在编辑模式下显示） -->
                    <div id="alignmentBtns" style="display: none; gap: 8px;">
                        <button class="toolbar-btn" onclick="alignDevicesHorizontal()" title="水平对齐选中的设备">
                            <i class="fas fa-arrows-alt-h"></i>
                            <span>水平对齐</span>
                        </button>
                        <button class="toolbar-btn" onclick="alignDevicesVertical()" title="垂直对齐选中的设备">
                            <i class="fas fa-arrows-alt-v"></i>
                            <span>垂直对齐</span>
                        </button>
                        <button class="toolbar-btn" onclick="straightenConnections()" title="将选中的连线拉直">
                            <i class="fas fa-ruler"></i>
                            <span>连线拉直</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="energy-flow-canvas" id="energyFlowCanvas">
                <!-- SVG连接线容器 -->
                <svg class="energy-connections" id="energyConnections" style="position: absolute; inset: 0; pointer-events: none; z-index: 5;">
                </svg>

                <!-- 设备容器（自由放置） -->
                <div id="devicesContainer" ondrop="dropDevice(event)" ondragover="allowDrop(event)" style="position: absolute; inset: 0;">
                    <!-- 设备将通过拖拽添加到此处，可自由放置在任意位置 -->
                </div>
            </div>

            <!-- 设备列表面板 -->
            <div class="device-list-panel" id="deviceListPanel">
                <div class="device-list-title">
                    <span>可用设备</span>
                    <button class="panel-toggle-btn" id="panelToggleBtn" onclick="toggleDevicePanel()" title="收起面板">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>

                <!-- 电源设备 -->
                <div class="device-category">
                    <div class="device-category-title">
                        <span class="device-category-icon">⚡</span>
                        <span>电源设备</span>
                    </div>
                    <div id="powerDevicesList">
                        <!-- 将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 储能设备 -->
                <div class="device-category">
                    <div class="device-category-title">
                        <span class="device-category-icon">🔋</span>
                        <span>储能设备</span>
                    </div>
                    <div id="storageDevicesList">
                        <!-- 将通过JavaScript动态生成 -->
                    </div>
                </div>

                <!-- 负载设备 -->
                <div class="device-category">
                    <div class="device-category-title">
                        <span class="device-category-icon">🏭</span>
                        <span>负载设备</span>
                    </div>
                    <div id="loadDevicesList">
                        <!-- 将通过JavaScript动态生成 -->
                    </div>
                </div>
            </div>

            <!-- 拖拽占位符 -->
            <div id="dragPlaceholder" class="drag-placeholder"></div>

            <!-- 右侧设备设置面板 -->
            <div class="device-settings-panel" id="deviceSettingsPanel" style="display: none;">
                <div class="device-list-title">
                    <span id="settingsPanelTitle">设备设置</span>
                    <button class="panel-toggle-btn" id="settingsPanelToggleBtn" onclick="toggleSettingsPanel()" title="收起面板">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div id="settingsPanelContent" style="margin-top: 16px;">
                    <!-- 设置内容将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </main>

    <!-- 移动端遮罩 -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <!-- 添加/编辑设备抽屉 -->
    <div id="addDeviceDrawer" style="display: none;">
        <!-- 遮罩层 -->
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeAddDeviceDrawer()"></div>
        <!-- 抽屉内容 -->
        <div style="position: fixed; top: 0; right: -400px; bottom: 0; width: 400px; background: white; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1000; transition: right 0.3s ease;">
            <div style="padding: 24px; height: 100%; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 id="drawerTitle" style="margin: 0; font-size: 18px;" data-translate="devicesDrawerTitleAdd">添加设备</h3>
                    <button onclick="closeAddDeviceDrawer()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
                </div>
                <form id="addDeviceForm" style="flex: 1;">
                    <input type="hidden" name="deviceId" id="deviceId">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);"><span data-translate="devicesTableCode">设备编码</span> <span style="color: #ef4444;">*</span></label>
                        <input type="text" name="code" class="form-input" required style="width: 100%; height: 40px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);"><span data-translate="devicesTableName">设备名称</span> <span style="color: #ef4444;">*</span></label>
                        <input type="text" name="name" class="form-input" required style="width: 100%; height: 40px;">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);"><span data-translate="devicesTableSite">所属站点</span> <span style="color: #ef4444;">*</span></label>
                        <select name="site" class="form-input" required style="width: 100%; height: 40px;">
                            <option value="" data-translate="devicesPleaseSelectSite">请选择站点</option>
                            <option value="site1" data-translate="siteNameTech">科技园区站</option>
                            <option value="site2" data-translate="siteNameIndustrial">工业园区站</option>
                            <option value="site3" data-translate="siteNameCommerce">商业中心站</option>
                            <option value="site4" data-translate="siteNameLogistics">物流园区站</option>
                            <option value="site5" data-translate="siteNameRD">研发中心站</option>
                            <option value="site6" data-translate="siteNameDataCenter">数据中心站</option>
                        </select>
                    </div>
                    <div style="position: absolute; bottom: 24px; left: 24px; right: 24px;">
                        <!-- 查看详情按钮（只在编辑储能柜时显示） -->
                        <button type="button" id="viewDetailsBtn" class="btn btn-primary" onclick="viewDetailsFromDrawer()" style="width: 100%; height: 40px; margin-bottom: 12px; display: none;">
                            <i class="fas fa-arrow-right" style="margin-right: 8px;"></i>
                            <span>查看详情</span>
                        </button>
                        <!-- 取消和确定按钮 -->
                        <div style="display: flex; gap: 12px;">
                            <button type="button" class="btn" onclick="closeAddDeviceDrawer()" style="flex: 1; height: 40px;"><span data-translate="devicesBtnCancel">取消</span></button>
                            <button type="submit" class="btn btn-primary" style="flex: 1; height: 40px;"><span data-translate="devicesBtnSave">确定</span></button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
        </div> <!-- 结束 content-container -->
    </main> <!-- 结束 main-content -->

    <!-- 删除确认弹窗 -->
    <div id="deleteConfirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 24px; width: 90%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 60px; height: 60px; background: #fee2e2; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #ef4444;"></i>
                </div>
                <h3 style="margin: 0 0 8px 0; font-size: 18px; color: var(--text-primary);">确认删除</h3>
                <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">您确定要删除设备 <span id="deleteDeviceName" style="font-weight: 600;"></span> 吗？此操作无法撤销。</p>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn" onclick="closeDeleteConfirm()" style="flex: 1; height: 40px;">取消</button>
                <button class="btn" onclick="confirmDelete()" style="flex: 1; height: 40px; background: #ef4444; color: white;">删除</button>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // 检查登录状态
        checkAuth();
        
        // 设置当前页面菜单项
        setActiveMenuItem('devices');

        // 艹！模拟设备数据，添加中英文名称支持
        let devices = [
            { id: 1, code: 'ESS001', name: { zh: '储能柜-A区-01', en: 'ESS Cabinet A1' }, site: 'site1', siteName: { zh: '科技园区站', en: 'Tech Park Station' }, soc: 85, soh: 98, power: 125.5, maxPower: 250, status: 'charging', mode: 'auto-charge' },
            { id: 2, code: 'ESS002', name: { zh: '储能柜-A区-02', en: 'ESS Cabinet A2' }, site: 'site1', siteName: { zh: '科技园区站', en: 'Tech Park Station' }, soc: 92, soh: 97, power: -89.3, maxPower: 250, status: 'discharging', mode: 'auto-discharge' },
            { id: 3, code: 'ESS003', name: { zh: '储能柜-B区-01', en: 'ESS Cabinet B1' }, site: 'site2', siteName: { zh: '工业园区站', en: 'Industrial Park Station' }, soc: 45, soh: 95, power: 0, maxPower: 200, status: 'standby', mode: 'standby' },
            { id: 4, code: 'ESS004', name: { zh: '储能柜-B区-02', en: 'ESS Cabinet B2' }, site: 'site2', siteName: { zh: '工业园区站', en: 'Industrial Park Station' }, soc: 78, soh: 96, power: 156.8, maxPower: 200, status: 'charging', mode: 'standby' },
            { id: 5, code: 'ESS005', name: { zh: '储能柜-C区-01', en: 'ESS Cabinet C1' }, site: 'site3', siteName: { zh: '商业中心站', en: 'Business Center Station' }, soc: 25, soh: 94, power: 0, maxPower: 300, status: 'standby', mode: 'standby' },
            { id: 6, code: 'ESS006', name: { zh: '储能柜-C区-02', en: 'ESS Cabinet C2' }, site: 'site3', siteName: { zh: '商业中心站', en: 'Business Center Station' }, soc: 67, soh: 99, power: 98.7, maxPower: 300, status: 'charging', mode: 'manual-charge' },
            { id: 7, code: 'ESS007', name: { zh: '储能柜-D区-01', en: 'ESS Cabinet D1' }, site: 'site1', siteName: { zh: '科技园区站', en: 'Tech Park Station' }, soc: 88, soh: 93, power: -112.4, maxPower: 250, status: 'discharging', mode: 'manual-discharge' },
            { id: 8, code: 'ESS008', name: { zh: '储能柜-D区-02', en: 'ESS Cabinet D2' }, site: 'site2', siteName: { zh: '工业园区站', en: 'Industrial Park Station' }, soc: 55, soh: 92, power: 0, maxPower: 200, status: 'standby', mode: 'waiting' }
        ];

        let currentPage = 1;
        let pageSize = 10;
        let sortField = '';
        let sortOrder = 'asc';
        let filteredDevices = [...devices];

        // 渲染表格
        function renderTable() {
            const tbody = document.getElementById('deviceTableBody');
            if (!tbody) {
                return;
            }
            tbody.innerHTML = '';

            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageDevices = filteredDevices.slice(start, end);

            pageDevices.forEach(device => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';
                tr.style.cursor = 'pointer';
                tr.style.transition = 'background-color 0.2s ease';
                tr.setAttribute('onclick', `viewDetails(${device.id})`);
                tr.setAttribute('onmouseover', 'this.style.backgroundColor = "var(--bg-secondary)"');
                tr.setAttribute('onmouseout', 'this.style.backgroundColor = ""');
                
                // 艹！根据当前语言获取设备名称和站点名称
                const deviceName = typeof device.name === 'object' ? device.name[currentLang] : device.name;
                const siteName = typeof device.siteName === 'object' ? device.siteName[currentLang] : device.siteName;

                tr.innerHTML = `
                    <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation()">
                        <input type="checkbox" class="device-checkbox" data-device-id="${device.id}" data-device-code="${device.code}" data-device-name="${deviceName}" onchange="updateSelectedDevices()" style="width: 16px; height: 16px; cursor: pointer;">
                    </td>
                    <td style="padding: 12px;">${device.code}</td>
                    <td style="padding: 12px;">${deviceName}</td>
                    <td style="padding: 12px;">${siteName || ''}</td>
                    <td style="padding: 12px; text-align: center;">${device.soc}%</td>
                    <td style="padding: 12px; text-align: center;">${device.soh}%</td>
                    <td style="padding: 12px; text-align: center;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <span>${device.power > 0 ? '+' : ''}${device.power} kW</span>
                            <div style="width: 60px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                                <div style="width: ${Math.abs(device.power) / (device.maxPower || 250) * 100}%; height: 100%; background: ${device.power > 0 ? '#10b981' : device.power < 0 ? '#3b82f6' : '#9ca3af'}; border-radius: 2px;"></div>
                            </div>
                        </div>
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${getModeBadge(device.mode)}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${getStatusBadge(device.status)}
                    </td>
                    <td style="padding: 12px; text-align: center;" onclick="event.stopPropagation()">
                        <button class="btn" onclick="viewDetails(${device.id})" style="padding: 0; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; border: none; background: transparent; border-radius: 6px; cursor: pointer;" title="查看详情">
                            <i class="fas fa-arrow-right" style="font-size: 16px; color: var(--text-secondary);"></i>
                        </button>
                        <button class="btn" onclick="editDevice(${device.id})" style="padding: 0; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; margin-right: 8px; border: none; background: transparent; border-radius: 6px; cursor: pointer;" title="编辑">
                            <i class="far fa-edit" style="font-size: 16px; color: var(--text-secondary);"></i>
                        </button>
                        <button class="btn" onclick="deleteDevice(${device.id})" style="padding: 0; width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; border: none; background: transparent; border-radius: 6px; cursor: pointer;" title="删除">
                            <i class="far fa-trash-alt" style="font-size: 16px; color: #ef4444;"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // 更新分页信息
            document.getElementById('totalCount').textContent = filteredDevices.length;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = Math.ceil(filteredDevices.length / pageSize);
        }

        // 获取状态徽章
        function getStatusBadge(status) {
            const statusMap = {
                'standby': { key: 'devicesStatusStandby', color: '#6b7280' },
                'charging': { key: 'devicesStatusCharging', color: '#3b82f6' },
                'discharging': { key: 'devicesStatusDischarging', color: '#f59e0b' }
            };
            const statusInfo = statusMap[status];
            const text = getTranslation(statusInfo.key);
            return `
                <span style="display: inline-flex; align-items: center; gap: 6px; font-size: 13px;">
                    <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: ${statusInfo.color};"></span>
                    <span style="color: var(--text-secondary);">${text}</span>
                </span>
            `;
        }

        // 获取模式徽章
        function getModeBadge(mode) {
            const modeMap = {
                'manual-charge': { key: 'devicesModeManualCharge', color: '#3b82f6' },
                'manual-discharge': { key: 'devicesModeManualDischarge', color: '#f59e0b' },
                'standby': { key: 'devicesModeStandby', color: '#6b7280' },
                'auto-charge': { key: 'devicesModeAutoCharge', color: '#10b981' },
                'auto-discharge': { key: 'devicesModeAutoDischarge', color: '#8b5cf6' },
                'waiting': { key: 'devicesModeWaiting', color: '#ec4899' }
            };
            const modeInfo = modeMap[mode];
            const text = getTranslation(modeInfo.key);
            return `<span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; background: ${modeInfo.color}20; color: ${modeInfo.color};">${text}</span>`;
        }

        // 排序表格
        function sortTable(field, direction = null) {
            if (direction) {
                // 点击箭头
                if (direction === 'asc') {
                    // 点击上箭头
                    if (sortField === field && sortOrder === 'asc') {
                        // 如果当前就是这列的升序，则取消排序
                        sortOrder = '';
                        sortField = '';
                    } else {
                        // 否则设置为升序
                        sortField = field;
                        sortOrder = 'asc';
                    }
                } else if (direction === 'desc') {
                    // 点击下箭头
                    if (sortField === field && sortOrder === 'desc') {
                        // 如果当前就是这列的降序，则取消排序
                        sortOrder = '';
                        sortField = '';
                    } else {
                        // 否则设置为降序
                        sortField = field;
                        sortOrder = 'desc';
                    }
                }
            } else {
                // 点击列头文字
                if (sortField === field) {
                    if (sortOrder === 'asc') {
                        sortOrder = 'desc';
                    } else if (sortOrder === 'desc') {
                        sortOrder = '';
                        sortField = '';
                    } else {
                        sortOrder = 'asc';
                    }
                } else {
                    sortField = field;
                    sortOrder = 'asc';
                }
            }

            // 更新排序图标
            updateSortIcons();

            // 重新应用搜索条件
            searchDevices();
        }

        // 更新排序图标
        function updateSortIcons() {
            // 重置所有排序箭头颜色
            document.querySelectorAll('.sort-arrows i').forEach(arrow => {
                arrow.style.color = '#94a3b8';
            });

            // 更新当前排序列的图标
            if (sortField && sortOrder) {
                const th = document.querySelector(`[data-sort="${sortField}"]`);
                if (th) {
                    const arrows = th.querySelector('.sort-arrows');
                    if (arrows) {
                        if (sortOrder === 'asc') {
                            arrows.querySelector('.fa-caret-up').style.color = '#3b82f6';
                        } else if (sortOrder === 'desc') {
                            arrows.querySelector('.fa-caret-down').style.color = '#3b82f6';
                        }
                    }
                }
            }
        }

        // 搜索设备
        function searchDevices() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const modeFilter = document.getElementById('modeFilter').value;
            const siteFilter = document.getElementById('siteFilter').value;

            filteredDevices = devices.filter(device => {
                const matchSearch = !searchText || 
                    device.code.toLowerCase().includes(searchText) || 
                    device.name.toLowerCase().includes(searchText);
                const matchStatus = !statusFilter || device.status === statusFilter;
                const matchMode = !modeFilter || device.mode === modeFilter;
                const matchSite = !siteFilter || device.site === siteFilter;
                
                return matchSearch && matchStatus && matchMode && matchSite;
            });

            // 应用排序
            if (sortField && sortOrder) {
                filteredDevices.sort((a, b) => {
                    let aVal = a[sortField];
                    let bVal = b[sortField];
                    
                    if (sortOrder === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
            }

            currentPage = 1;
            renderTable();
        }

        // 重置搜索
        function resetSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('modeFilter').value = '';
            document.getElementById('siteFilter').value = '';
            document.getElementById('siteFilterInput').value = '全部站点';
            filteredDevices = [...devices];
            currentPage = 1;
            renderTable();
        }

        // 全选/取消全选导出
        function toggleSelectAllForExport() {
            const selectAllCheckbox = document.getElementById('selectAllForExport');
            const isChecked = selectAllCheckbox.checked;

            // 同步表格中的所有复选框
            const checkboxes = document.querySelectorAll('#deviceTable tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });

            // 同步表头的全选框
            const selectAllDevices = document.getElementById('selectAllDevices');
            if (selectAllDevices) {
                selectAllDevices.checked = isChecked;
            }
        }

        // 导出设备列表
        function exportDevices() {
            const t = translations[localStorage.getItem('language') || 'zh'];
            const selectAllForExport = document.getElementById('selectAllForExport');

            let dataToExport;

            if (selectAllForExport && selectAllForExport.checked) {
                // 勾选"全部设备"时，导出所有设备（不受筛选条件影响）
                dataToExport = devices;
            } else {
                // 未勾选时，导出当前筛选后的数据
                dataToExport = filteredDevices.length > 0 ? filteredDevices : devices;
            }

            if (dataToExport.length === 0) {
                showNotification(t.devicesExportNoData || '没有可导出的数据', 'warning');
                return;
            }

            // 定义CSV表头
            const headers = [
                t.devicesTableSN || '设备SN',
                t.devicesTableName || '设备名称',
                t.devicesTableSite || '所属站点',
                t.devicesTableSOC || 'SOC',
                t.devicesTablePower || '功率',
                t.devicesTableMode || '运行模式',
                t.devicesTableStatus || '状态'
            ];

            // 获取状态和模式的翻译
            const getStatusText = (status) => {
                const statusMap = {
                    'charging': t.devicesStatusCharging || '充电',
                    'discharging': t.devicesStatusDischarging || '放电',
                    'standby': t.devicesStatusStandby || '待机',
                    'offline': t.devicesStatusOffline || '离线'
                };
                return statusMap[status] || status;
            };

            const getModeText = (mode) => {
                const modeMap = {
                    'manual-charge': t.devicesModeManualCharge || '手动充电',
                    'manual-discharge': t.devicesModeManualDischarge || '手动放电',
                    'auto-charge': t.devicesModeAutoCharge || '自动充电',
                    'auto-discharge': t.devicesModeAutoDischarge || '自动放电',
                    'standby': t.devicesModeStandby || '待机中',
                    'waiting': t.devicesModeWaiting || '等待执行'
                };
                return modeMap[mode] || mode;
            };

            // 构建CSV内容
            let csvContent = '\uFEFF'; // BOM for UTF-8
            csvContent += headers.join(',') + '\n';

            dataToExport.forEach(device => {
                const row = [
                    device.sn || '',
                    device.name || '',
                    device.siteName || device.site || '',
                    (device.soc || 0) + '%',
                    (device.power || 0) + 'kW',
                    getModeText(device.mode),
                    getStatusText(device.status)
                ];
                // 处理包含逗号或引号的字段
                const escapedRow = row.map(field => {
                    const str = String(field);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                });
                csvContent += escapedRow.join(',') + '\n';
            });

            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);

            // 生成文件名（包含日期）
            const now = new Date();
            const dateStr = now.getFullYear() +
                String(now.getMonth() + 1).padStart(2, '0') +
                String(now.getDate()).padStart(2, '0') + '_' +
                String(now.getHours()).padStart(2, '0') +
                String(now.getMinutes()).padStart(2, '0');
            const fileName = (t.devicesExportFileName || '设备列表') + '_' + dateStr + '.csv';

            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification(t.devicesExportSuccess || '导出成功', 'success');
        }

        // 分页功能
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredDevices.length / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        // 艹！全局函数：获取设备名称（支持中英文）
        function getDeviceDisplayName(device) {
            if (typeof device.name === 'object' && device.name !== null) {
                return currentLang === 'zh' ? (device.name.zh || '') : (device.name.en || '');
            }
            return device.name || '';
        }

        // 查看详情
        function viewDetails(id) {
            // 跳转到储能柜详情页面
            window.location.href = `cabinet-detail.html?cabinetId=${id}`;
        }

        // 从抽屉中查看详情
        function viewDetailsFromDrawer() {
            const deviceId = document.getElementById('deviceId').value;
            if (deviceId) {
                viewDetails(deviceId);
            }
        }

        // 编辑设备
        function editDevice(id) {
            const device = devices.find(d => d.id === id);
            if (device) {
                // 设置为编辑模式
                document.getElementById('drawerTitle').textContent = getTranslation('devicesDrawerTitleEdit');
                document.getElementById('deviceId').value = id;
                document.querySelector('input[name="code"]').value = device.code;
                // 艹！修复name对象显示问题，使用getDeviceDisplayName获取正确的名称
                document.querySelector('input[name="name"]').value = getDeviceDisplayName(device);
                document.querySelector('select[name="site"]').value = device.site || '';

                // 判断是否为储能柜（设备编码以ESS开头）
                const viewDetailsBtn = document.getElementById('viewDetailsBtn');
                if (device.code && device.code.startsWith('ESS')) {
                    viewDetailsBtn.style.display = 'block';
                } else {
                    viewDetailsBtn.style.display = 'none';
                }

                // 显示抽屉
                const drawer = document.getElementById('addDeviceDrawer');
                const drawerContent = drawer.querySelector('div:last-child');
                drawer.style.display = 'block';
                setTimeout(() => {
                    drawerContent.style.right = '0';
                }, 10);
            }
        }

        // 删除设备
        let deleteDeviceId = null;
        function deleteDevice(id) {
            const device = devices.find(d => d.id === id);
            if (device) {
                deleteDeviceId = id;
                // 艹！修复name对象显示问题，使用getDeviceDisplayName获取正确的名称
                document.getElementById('deleteDeviceName').textContent = getDeviceDisplayName(device);
                document.getElementById('deleteConfirmModal').style.display = 'flex';
            }
        }

        // 确认删除
        function confirmDelete() {
            if (deleteDeviceId) {
                devices = devices.filter(d => d.id !== deleteDeviceId);
                searchDevices();
                closeDeleteConfirm();
                
                // 显示成功提示
                showToast('设备删除成功！', '#ef4444');
            }
        }

        // 关闭删除确认
        function closeDeleteConfirm() {
            document.getElementById('deleteConfirmModal').style.display = 'none';
            deleteDeviceId = null;
        }

        // 显示添加设备抽屉
        function showAddDeviceModal() {
            // 设置为添加模式
            document.getElementById('drawerTitle').textContent = getTranslation('devicesDrawerTitleAdd');
            document.getElementById('deviceId').value = '';
            document.getElementById('addDeviceForm').reset();

            // 添加模式时隐藏查看详情按钮
            document.getElementById('viewDetailsBtn').style.display = 'none';

            const drawer = document.getElementById('addDeviceDrawer');
            const drawerContent = drawer.querySelector('div:last-child');
            drawer.style.display = 'block';
            // 触发重排以确保动画生效
            setTimeout(() => {
                drawerContent.style.right = '0';
            }, 10);
        }

        // 关闭添加设备抽屉
        function closeAddDeviceDrawer() {
            const drawer = document.getElementById('addDeviceDrawer');
            const drawerContent = drawer.querySelector('div:last-child');
            drawerContent.style.right = '-400px';
            setTimeout(() => {
                drawer.style.display = 'none';
                document.getElementById('addDeviceForm').reset();
            }, 300);
        }

        // 存储选中的设备
        let selectedDevices = [];

        // 切换全选
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllDevices');
            const checkboxes = document.querySelectorAll('.device-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            updateSelectedDevices();
        }

        // 更新选中的设备列表
        function updateSelectedDevices() {
            const checkboxes = document.querySelectorAll('.device-checkbox:checked');
            selectedDevices = Array.from(checkboxes).map(checkbox => ({
                id: checkbox.dataset.deviceId,
                code: checkbox.dataset.deviceCode,
                name: checkbox.dataset.deviceName
            }));
            
            // 更新全选框状态
            const selectAll = document.getElementById('selectAllDevices');
            const allCheckboxes = document.querySelectorAll('.device-checkbox');
            selectAll.checked = allCheckboxes.length > 0 && checkboxes.length === allCheckboxes.length;
            selectAll.indeterminate = checkboxes.length > 0 && checkboxes.length < allCheckboxes.length;
        }

        // 显示OTA升级弹窗
        function showOTAUpgrade() {
            // 检查是否选择了设备
            if (selectedDevices.length === 0) {
                showNotification(getTranslation('devicesOTAWarning'), 'warning');
                return;
            }
            
            // 显示文件选择弹窗
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';

            modal.innerHTML = `
                <div class="modal-content" style="background: white; border-radius: 16px; width: 95vw; max-width: 1400px; height: 95vh; max-height: 95vh; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); display: flex; flex-direction: column;">
                    <div class="modal-header" style="padding: 24px 32px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                        <h3 style="font-size: 24px; font-weight: 600; color: #1e293b; margin: 0;">${getTranslation('devicesOTATitle')}</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #64748b; padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 32px; flex: 1; overflow-y: auto;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                            <!-- 左侧：版本信息 -->
                            <div>
                                <div class="form-group" style="margin-bottom: 24px;">
                                    <label class="form-label" style="display: block; font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 16px;">
                                        ${getTranslation('devicesOTALatestVersion')}
                                    </label>
                                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 12px; padding: 24px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <p style="font-size: 24px; font-weight: 600; color: #1e293b; margin: 0;">v2.5.0</p>
                                                <p style="font-size: 14px; color: #64748b; margin: 4px 0 0 0;">${getTranslation('devicesOTAReleaseDate')}2024-01-15</p>
                                            </div>
                                            <div style="text-align: right;">
                                                <span style="background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500;">${getTranslation('devicesOTALatestBadge')}</span>
                                            </div>
                                        </div>
                                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e0e7ff;">
                                            <p style="font-size: 15px; color: #374151; font-weight: 500; margin-bottom: 12px;">${getTranslation('devicesOTAUpdateContent')}</p>
                                            <ul style="font-size: 14px; color: #6b7280; margin: 0; padding-left: 24px; line-height: 1.8;">
                                                <li>${getTranslation('devicesOTAUpdate1')}</li>
                                                <li>${getTranslation('devicesOTAUpdate2')}</li>
                                                <li>${getTranslation('devicesOTAUpdate3')}</li>
                                                <li>${getTranslation('devicesOTAUpdate4')}</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 12px; padding: 16px; display: flex; gap: 12px;">
                                    <i class="fas fa-info-circle" style="color: #f59e0b; margin-top: 2px; font-size: 16px;"></i>
                                    <div style="flex: 1;">
                                        <p style="font-size: 14px; color: #92400e; margin: 0;">${getTranslation('devicesOTANotice')}</p>
                                    </div>
                                </div>
                            </div>

                            <!-- 右侧：设备列表 -->
                            <div>
                                <div class="form-group">
                                    <label class="form-label" style="display: block; font-weight: 600; color: #374151; margin-bottom: 12px; font-size: 16px;">
                                        ${getTranslation('devicesOTASelectedDevices')} <span style="background: #e0e7ff; color: #3730a3; padding: 4px 12px; border-radius: 6px; font-size: 14px; margin-left: 8px;">${selectedDevices.length} ${currentLang === 'zh' ? '个' : ''}</span>
                                    </label>
                                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; max-height: 400px; overflow-y: auto;">
                                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px;">
                                            ${selectedDevices.map(device => `
                                                <div style="padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb; transition: all 0.2s;" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'" onmouseout="this.style.boxShadow='none'">
                                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                                        <div style="flex: 1;">
                                                            <p style="font-size: 15px; color: #1e293b; font-weight: 500; margin: 0;">${device.code}</p>
                                                            <p style="font-size: 14px; color: #6b7280; margin: 4px 0 0 0;">${getDeviceDisplayName(device)}</p>
                                                            <p style="font-size: 13px; color: #9ca3af; margin: 2px 0 0 0;">${getTranslation('devicesOTACurrentVersion')}v2.4.8</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 24px 32px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; align-items: center; gap: 12px; flex-shrink: 0; background: #f8fafc;">
                        <button type="button" class="btn" onclick="this.closest('.modal').remove()" style="padding: 8px 16px; height: 36px; font-size: 14px; width: auto !important; min-width: 80px; max-width: 120px;">${getTranslation('devicesOTABtnCancel')}</button>
                        <button type="button" class="btn btn-primary" onclick="startOTAUpgrade()" style="padding: 8px 16px; height: 36px; font-size: 14px; background: #10b981; width: auto !important; min-width: 100px; max-width: 150px;">
                            <i class="fas fa-cloud-upload-alt" style="margin-right: 6px; font-size: 14px;"></i>
                            ${getTranslation('devicesOTABtnStart')}
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // 显示OTA确认弹窗
        function showOTAConfirmModal() {
            const confirmModal = document.createElement('div');
            confirmModal.className = 'modal show';
            confirmModal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            
            confirmModal.innerHTML = `
                <div class="modal-content" style="background: white; border-radius: 12px; width: 500px; max-width: 90vw; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                    <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0;">确认升级</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px;">
                            <span style="transform: rotate(45deg);">+</span>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 20px;">
                        <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                            <div style="display: flex; gap: 12px;">
                                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 20px; margin-top: 2px;"></i>
                                <div>
                                    <p style="font-size: 14px; color: #92400e; font-weight: 500; margin-bottom: 8px;">请确认以下信息：</p>
                                    <ul style="font-size: 13px; color: #92400e; margin: 0; padding-left: 20px;">
                                        <li>目标版本：v2.5.0</li>
                                        <li>升级包大小：约 15.6 MB</li>
                                        <li>设备数量：${selectedDevices.length} 个</li>
                                        <li>升级过程中设备将重启，请确保设备处于安全状态</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <p style="font-size: 14px; color: #374151; font-weight: 500; margin-bottom: 8px;">将升级以下设备：</p>
                            <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px; max-height: 150px; overflow-y: auto;">
                                ${selectedDevices.map(device => `
                                    <div style="padding: 6px 0; font-size: 13px; color: #6b7280;">
                                        <i class="fas fa-check-circle" style="color: #10b981; margin-right: 8px;"></i>
                                        ${device.code} - ${device.name}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <p style="font-size: 14px; color: #374151; font-weight: 500; margin-bottom: 8px;">升级说明：</p>
                            <div style="font-size: 13px; color: #6b7280; background: #f9fafb; padding: 12px; border-radius: 6px;">
                                <p style="margin: 0 0 8px 0;">本次升级将从云端自动下载最新固件包，升级过程包括：</p>
                                <ol style="margin: 0; padding-left: 20px;">
                                    <li>连接云端服务器验证设备信息</li>
                                    <li>下载适配的固件包</li>
                                    <li>备份当前配置</li>
                                    <li>执行固件升级</li>
                                    <li>重启并验证升级结果</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 20px; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
                        <button type="button" class="btn" onclick="this.closest('.modal').remove()" style="padding: 8px 16px;">取消</button>
                        <button type="button" class="btn btn-primary" onclick="startOTAUpgrade()" style="padding: 8px 16px; background: #10b981;">确认升级</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
        }

        // 检查最新版本
        function checkLatestVersion() {
            // 显示加载提示
            const checkBtn = event.target.closest('button');
            const originalContent = checkBtn.innerHTML;
            checkBtn.disabled = true;
            checkBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>检查中...';
            
            // 模拟检查版本
            setTimeout(() => {
                checkBtn.disabled = false;
                checkBtn.innerHTML = originalContent;
                
                // 显示成功提示
                showNotification('已是最新版本 v2.5.0', 'success');
            }, 2000);
        }
        
        // 开始OTA升级
        function startOTAUpgrade() {
            // 关闭确认弹窗
            document.querySelector('.modal').remove();
            
            // 显示右下角进度小弹窗
            showOTAProgressToast();
            
            // 开始升级流程
            startUpgradeProcess();
        }

        // 显示右下角进度小弹窗
        function showOTAProgressToast() {
            const toast = document.createElement('div');
            toast.id = 'otaProgressToast';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                padding: 16px;
                width: 320px;
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h4 style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;" data-translate="otaProgressTitle">OTA升级进度</h4>
                </div>
                <div style="margin-bottom: 8px;">
                    <p id="upgradePhase" style="font-size: 12px; color: #3b82f6; margin: 0 0 4px 0;">
                        <i class="fas fa-cloud-download-alt" style="margin-right: 4px;"></i>
                        <span data-translate="otaDownloadingFirmware">正在从云端下载固件...</span>
                    </p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span style="font-size: 12px; color: #6b7280;"><span data-translate="otaUpgradeProgress">升级进度</span> <span id="upgradingCount">0</span>/${selectedDevices.length} <span data-translate="otaDevices">个设备</span></span>
                        <span id="progressPercent" style="font-size: 12px; color: #6b7280;">0%</span>
                    </div>
                    <div style="background: #f3f4f6; border-radius: 4px; height: 6px; overflow: hidden;">
                        <div id="toastProgress" style="background: #10b981; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; font-size: 12px; color: #6b7280;">
                    <span><span data-translate="otaSuccess">成功</span>: <span id="successCount" style="color: #10b981; font-weight: 500;">0</span></span>
                    <span><span data-translate="otaFailed">失败</span>: <span id="failCount" style="color: #ef4444; font-weight: 500;">0</span></span>
                    <span><span data-translate="otaRemainingTime">剩余时间</span>: <span id="remainingTime" data-translate="otaCalculating">计算中...</span></span>
                </div>
            `;

            document.body.appendChild(toast);

            // 艹！应用翻译到新添加的toast元素
            applyTranslations();
        }

        // OTA升级详情状态
        let otaUpgradeDetails = [];

        // 开始升级流程
        function startUpgradeProcess() {
            // 初始化升级详情
            otaUpgradeDetails = selectedDevices.map(device => ({
                ...device,
                status: 'waiting',
                progress: 0,
                message: '等待升级',
                startTime: null,
                endTime: null
            }));
            
            let currentIndex = 0;
            let successCount = 0;
            let failCount = 0;
            let downloadComplete = false;
            
            // 先模拟云端下载
            const phaseElement = document.getElementById('upgradePhase');
            let downloadProgress = 0;
            const downloadInterval = setInterval(() => {
                downloadProgress += Math.random() * 15;
                if (downloadProgress >= 100) {
                    downloadProgress = 100;
                    clearInterval(downloadInterval);
                    downloadComplete = true;
                    
                    // 更新阶段显示
                    phaseElement.innerHTML = '<i class="fas fa-upload" style="margin-right: 4px;"></i><span data-translate="otaUpgradingDevices">正在升级设备...</span>';

                    // 艹！应用翻译
                    applyTranslations();

                    // 开始设备升级
                    startDeviceUpgrade();
                } else {
                    document.getElementById('toastProgress').style.width = (downloadProgress * 0.3) + '%';
                    document.getElementById('progressPercent').textContent = Math.floor(downloadProgress * 0.3) + '%';
                }
            }, 300);
            
            // 设备升级函数
            function startDeviceUpgrade() {
                // 模拟逐个设备升级
                const upgradeInterval = setInterval(() => {
                    if (currentIndex >= otaUpgradeDetails.length) {
                        clearInterval(upgradeInterval);
                        onUpgradeComplete();
                        return;
                    }
                    
                    const device = otaUpgradeDetails[currentIndex];
                    device.status = 'upgrading';
                    device.startTime = new Date();
                    device.message = '正在升级...';
                    
                    // 模拟升级过程
                    let deviceProgress = 0;
                    const deviceInterval = setInterval(() => {
                        deviceProgress += Math.random() * 20;
                        if (deviceProgress >= 100) {
                            deviceProgress = 100;
                            clearInterval(deviceInterval);
                            
                            // 随机成功或失败
                            const isSuccess = Math.random() > 0.1;
                            device.status = isSuccess ? 'success' : 'failed';
                            device.progress = 100;
                            device.endTime = new Date();
                            device.message = isSuccess ? '升级成功' : '升级失败：设备无响应';
                            
                            if (isSuccess) {
                                successCount++;
                            } else {
                                failCount++;
                            }
                            
                            currentIndex++;
                            updateProgressDisplay(currentIndex, successCount, failCount);
                        } else {
                            device.progress = Math.floor(deviceProgress);
                            updateProgressDisplay(currentIndex, successCount, failCount);
                        }
                    }, 500);
                }, 2000);
            }
        }

        // 更新进度显示
        function updateProgressDisplay(current, success, fail) {
            // 调用统一的更新函数
            updateUpgradeStats();
            
            // 计算剩余时间
            const total = selectedDevices.length;
            const remaining = total - current;
            const remainingTime = remaining * 2; // 假设每个设备2秒
            document.getElementById('remainingTime').textContent = remaining > 0 ? `${remainingTime}秒` : '完成';
        }

        // 升级完成
        function onUpgradeComplete() {
            const toast = document.getElementById('otaProgressToast');
            if (toast) {
                // 检查是否已经添加了完成提示
                if (!toast.querySelector('.upgrade-complete-section')) {
                    const successCount = otaUpgradeDetails.filter(d => d.status === 'success').length;
                    const failCount = otaUpgradeDetails.filter(d => d.status === 'failed').length;
                    
                    toast.innerHTML += `
                        <div class="upgrade-complete-section" style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                            <p style="font-size: 13px; color: #374151; font-weight: 500; margin-bottom: 8px;" data-translate="otaUpgradeCompleted">升级完成！</p>
                            <div style="display: flex; gap: 12px;">
                                <button onclick="showOTADetails()" class="btn btn-primary" style="flex: 1; height: 32px; font-size: 13px;" data-translate="otaViewDetails">查看详情</button>
                                <button onclick="this.closest('#otaProgressToast').remove()" class="btn" style="flex: 1; height: 32px; font-size: 13px;" data-translate="otaClose">关闭</button>
                            </div>
                        </div>
                    `;

                    // 艹！应用翻译到新添加的完成提示
                    applyTranslations();
                }
            }
        }

        // 显示OTA详情抽屉
        function showOTADetails() {
            // 创建蒙版
            const overlay = document.createElement('div');
            overlay.id = 'otaDetailsOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            overlay.onclick = closeOTADetails;
            document.body.appendChild(overlay);
            
            // 创建右侧抽屉
            const drawer = document.createElement('div');
            drawer.id = 'otaDetailsDrawer';
            drawer.style.cssText = `
                position: fixed;
                top: 0;
                right: 0;
                bottom: 0;
                width: 500px;
                background: white;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
                z-index: 1001;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            const successDevices = otaUpgradeDetails.filter(d => d.status === 'success');
            const failedDevices = otaUpgradeDetails.filter(d => d.status === 'failed');
            
            drawer.innerHTML = `
                <div style="height: 100%; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0;">OTA升级详情</h3>
                        <button onclick="closeOTADetails()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='none'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Tab切换按钮 -->
                    <div style="display: flex; background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
                        <button id="successTab" onclick="switchOTATab('success')" style="flex: 1; padding: 16px; background: none; border: none; border-bottom: 3px solid #10b981; cursor: pointer; transition: all 0.2s;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <i class="fas fa-check-circle" style="color: #10b981; font-size: 18px;"></i>
                                <span style="font-size: 15px; font-weight: 600; color: #1e293b;">成功 (${successDevices.length})</span>
                            </div>
                        </button>
                        <button id="failedTab" onclick="switchOTATab('failed')" style="flex: 1; padding: 16px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; transition: all 0.2s;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                <i class="fas fa-times-circle" style="color: #ef4444; font-size: 18px;"></i>
                                <span style="font-size: 15px; font-weight: 600; color: #6b7280;">失败 (${failedDevices.length})</span>
                            </div>
                        </button>
                    </div>
                    
                    <!-- Tab内容区域 -->
                    <div style="flex: 1; overflow-y: auto;">
                        <!-- 成功Tab内容 -->
                        <div id="successContent" style="padding: 20px; display: block;">
                            ${successDevices.length > 0 ? `
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    ${successDevices.map(device => `
                                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);" onmouseover="this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)'">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                                        <h4 style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0;">${device.code}</h4>
                                                        <span style="background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">升级成功</span>
                                                    </div>
                                                    <p style="font-size: 14px; color: #6b7280; margin: 0 0 12px 0;">${device.name}</p>
                                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                                        <div>
                                                            <p style="font-size: 12px; color: #9ca3af; margin: 0 0 4px 0;">版本更新</p>
                                                            <p style="font-size: 14px; color: #374151; margin: 0;">v2.4.8 → v2.5.0</p>
                                                        </div>
                                                        <div>
                                                            <p style="font-size: 12px; color: #9ca3af; margin: 0 0 4px 0;">升级时间</p>
                                                            <p style="font-size: 14px; color: #374151; margin: 0;">${new Date().toLocaleTimeString()}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 60px 20px;">
                                    <i class="fas fa-inbox" style="font-size: 48px; color: #e5e7eb; margin-bottom: 16px;"></i>
                                    <p style="font-size: 16px; color: #9ca3af; margin: 0;">暂无成功的设备</p>
                                </div>
                            `}
                        </div>
                        
                        <!-- 失败Tab内容 -->
                        <div id="failedContent" style="padding: 20px; display: none;">
                            ${failedDevices.length > 0 ? `
                                <button onclick="retryAllFailed()" class="btn" style="height: 36px; padding: 0 16px; font-size: 14px; background: white; border: 1px solid #ef4444; color: #ef4444; margin-bottom: 16px; display: inline-flex; align-items: center; width: auto;" onmouseover="this.style.background='#fef2f2'" onmouseout="this.style.background='white'">
                                    <i class="fas fa-redo" style="margin-right: 6px; font-size: 12px;"></i>
                                    重试所有失败的设备 (${failedDevices.length})
                                </button>
                                
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    ${failedDevices.map(device => `
                                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);" onmouseover="this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'" onmouseout="this.style.boxShadow='0 1px 3px rgba(0, 0, 0, 0.1)'">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                                                        <h4 style="font-size: 16px; font-weight: 600; color: #1e293b; margin: 0;">${device.code}</h4>
                                                        <span style="background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">升级失败</span>
                                                    </div>
                                                    <p style="font-size: 14px; color: #6b7280; margin: 0 0 8px 0;">${device.name}</p>
                                                    <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 12px;">
                                                        <p style="font-size: 13px; color: #dc2626; margin: 0;">
                                                            ${device.message}
                                                        </p>
                                                    </div>
                                                </div>
                                                <button onclick="retryOTAUpgrade('${device.id}')" class="btn" style="padding: 8px 16px; height: 36px; font-size: 13px; background: white; border: 1px solid #ef4444; color: #ef4444; transition: all 0.2s; margin-left: 16px; white-space: nowrap;" onmouseover="this.style.background='#ef4444'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#ef4444'">
                                                    <i class="fas fa-redo" style="margin-right: 6px;"></i>
                                                    重新升级
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 60px 20px;">
                                    <i class="fas fa-check-circle" style="font-size: 48px; color: #10b981; margin-bottom: 16px;"></i>
                                    <p style="font-size: 16px; color: #6b7280; margin: 0;">太好了！没有失败的设备</p>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(drawer);
            
            // 触发动画
            setTimeout(() => {
                overlay.style.opacity = '1';
                drawer.style.transform = 'translateX(0)';
            }, 10);
            
            // 添加全局函数
            window.switchOTATab = switchOTATab;
        }
        
        // 切换OTA详情Tab
        function switchOTATab(tab) {
            const successTab = document.getElementById('successTab');
            const failedTab = document.getElementById('failedTab');
            const successContent = document.getElementById('successContent');
            const failedContent = document.getElementById('failedContent');
            
            if (tab === 'success') {
                successTab.style.borderBottomColor = '#10b981';
                successTab.querySelector('span').style.color = '#1e293b';
                failedTab.style.borderBottomColor = 'transparent';
                failedTab.querySelector('span').style.color = '#6b7280';
                
                successContent.style.display = 'block';
                failedContent.style.display = 'none';
            } else {
                successTab.style.borderBottomColor = 'transparent';
                successTab.querySelector('span').style.color = '#6b7280';
                failedTab.style.borderBottomColor = '#ef4444';
                failedTab.querySelector('span').style.color = '#1e293b';
                
                successContent.style.display = 'none';
                failedContent.style.display = 'block';
            }
        }

        // 关闭OTA详情抽屉
        function closeOTADetails() {
            const drawer = document.getElementById('otaDetailsDrawer');
            const overlay = document.getElementById('otaDetailsOverlay');
            if (drawer) {
                drawer.style.transform = 'translateX(100%)';
                if (overlay) {
                    overlay.style.opacity = '0';
                }
                setTimeout(() => {
                    drawer.remove();
                    if (overlay) {
                        overlay.remove();
                    }
                }, 300);
            }
        }

        // 重试OTA升级
        function retryOTAUpgrade(deviceId) {
            const device = otaUpgradeDetails.find(d => d.id === deviceId);
            if (device) {
                device.status = 'upgrading';
                device.progress = 0;
                device.message = '正在重新升级...';
                
                // 刷新详情抽屉
                closeOTADetails();
                setTimeout(() => {
                    showOTADetails();
                }, 100);
                
                // 模拟重新升级
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        
                        // 这次假设成功
                        device.status = 'success';
                        device.progress = 100;
                        device.message = '升级成功';
                        
                        // 刷新显示
                        closeOTADetails();
                        setTimeout(() => {
                            showOTADetails();
                        }, 100);
                    } else {
                        device.progress = Math.floor(progress);
                    }
                }, 500);
            }
        }
        
        // 重试所有失败的设备
        function retryAllFailed() {
            const failedDevices = otaUpgradeDetails.filter(d => d.status === 'failed');
            
            if (failedDevices.length === 0) {
                showNotification('没有需要重试的设备', 'info');
                return;
            }
            
            // 将所有失败的设备设置为正在升级状态
            failedDevices.forEach(device => {
                device.status = 'upgrading';
                device.progress = 0;
                device.message = '正在重新升级...';
            });
            
            // 刷新详情抽屉
            closeOTADetails();
            setTimeout(() => {
                showOTADetails();
            }, 100);
            
            // 依次升级每个设备
            let currentIndex = 0;
            
            function upgradeNextDevice() {
                if (currentIndex >= failedDevices.length) {
                    return;
                }
                
                const device = failedDevices[currentIndex];
                let progress = 0;
                
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        
                        // 随机成功或失败（80%成功率）
                        if (Math.random() > 0.2) {
                            device.status = 'success';
                            device.message = '升级成功';
                        } else {
                            device.status = 'failed';
                            device.message = '升级失败：设备响应超时';
                        }
                        device.progress = 100;
                        
                        // 更新统计数据
                        updateUpgradeStats();
                        
                        // 刷新显示
                        closeOTADetails();
                        setTimeout(() => {
                            showOTADetails();
                        }, 100);
                        
                        // 继续下一个设备
                        currentIndex++;
                        setTimeout(upgradeNextDevice, 500);
                    } else {
                        device.progress = Math.floor(progress);
                    }
                }, 500);
            }
            
            // 开始升级第一个设备
            upgradeNextDevice();
        }
        
        // 更新升级统计数据
        function updateUpgradeStats() {
            const successCount = otaUpgradeDetails.filter(d => d.status === 'success').length;
            const failCount = otaUpgradeDetails.filter(d => d.status === 'failed').length;
            const progressCount = otaUpgradeDetails.filter(d => d.status === 'upgrading').length;
            
            // 更新进度弹窗中的统计
            const successElement = document.getElementById('successCount');
            const failElement = document.getElementById('failCount');
            const upgradingElement = document.getElementById('upgradingCount');
            
            if (successElement) successElement.textContent = successCount;
            if (failElement) failElement.textContent = failCount;
            if (upgradingElement) upgradingElement.textContent = successCount + failCount;
            
            // 更新进度条
            const totalDevices = otaUpgradeDetails.length;
            const completedDevices = successCount + failCount;
            const progressPercent = totalDevices > 0 ? Math.floor((completedDevices / totalDevices) * 100) : 0;
            
            const progressBar = document.getElementById('toastProgress');
            const percentText = document.getElementById('progressPercent');
            
            if (progressBar) progressBar.style.width = progressPercent + '%';
            if (percentText) percentText.textContent = progressPercent + '%';
            
            // 如果所有设备都完成了升级
            if (completedDevices === totalDevices && progressCount === 0) {
                onUpgradeComplete();
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // 处理添加/编辑设备表单提交
        document.getElementById('addDeviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const deviceId = formData.get('deviceId');
            const code = formData.get('code');
            const name = formData.get('name');
            const site = formData.get('site');
            
            if (deviceId) {
                // 编辑模式
                const device = devices.find(d => d.id === parseInt(deviceId));
                if (device) {
                    device.code = code;
                    device.name = name;
                    device.site = site;
                    // 更新站点名称
                    const siteOption = document.querySelector(`select[name="site"] option[value="${site}"]`);
                    if (siteOption) {
                        device.siteName = siteOption.textContent;
                    }
                }
                searchDevices();
                closeAddDeviceDrawer();
                
                // 显示成功提示
                showToast('设备编辑成功！', '#10b981');
            } else {
                // 添加模式
                // 获取站点名称
                const siteOption = document.querySelector(`select[name="site"] option[value="${site}"]`);
                const siteName = siteOption ? siteOption.textContent : '';
                
                const newDevice = {
                    id: devices.length + 1,
                    code: code,
                    name: name,
                    site: site,
                    siteName: siteName,
                    soc: Math.floor(Math.random() * 50 + 50), // 随机生成50-100之间的值
                    soh: Math.floor(Math.random() * 10 + 90), // 随机生成90-100之间的值
                    power: 0, // 默认功率为0
                    status: 'standby',
                    mode: 'standby'
                };
                
                devices.push(newDevice);
                searchDevices();
                closeAddDeviceDrawer();
                
                // 显示成功提示
                showToast('设备添加成功！', '#10b981');
            }
        });

        // 显示提示消息
        function showToast(message, color = '#10b981') {
            const toast = document.createElement('div');
            toast.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${color}; color: white; padding: 12px 24px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 2000;`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // 添加隐藏的siteFilter input
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = 'siteFilter';
        hiddenInput.value = '';
        document.body.appendChild(hiddenInput);
        
        // 确保DOM加载完成后再渲染表格
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                // 确保表格视图可见
                const tableView = document.getElementById('table-view');
                if (tableView) {
                    tableView.style.display = 'block';
                }
                // 确保查询区域可见
                const queryArea = document.getElementById('query-area');
                if (queryArea) {
                    queryArea.style.display = 'block';
                }

                // 检查localStorage中的站点筛选条件（从故障分析跳转）
                const storedSite = localStorage.getItem('deviceFilterSite');
                if (storedSite) {
                    // 清除localStorage中的值（只使用一次）
                    localStorage.removeItem('deviceFilterSite');

                    // 设置站点筛选
                    const siteFilterInput = document.getElementById('siteFilterInput');
                    const siteFilter = document.getElementById('siteFilter');
                    const unifiedSelect = document.getElementById('unifiedSiteSelect');

                    if (siteFilter) {
                        siteFilter.value = storedSite;
                    }
                    if (unifiedSelect) {
                        unifiedSelect.value = storedSite;
                    }

                    // 更新显示文本
                    const siteNames = {
                        'site1': '科技园区站',
                        'site2': '工业园区站',
                        'site3': '商业中心站',
                        'site4': '物流园区站',
                        'site5': '产业园区站',
                        'site6': '数据中心站'
                    };
                    if (siteFilterInput && siteNames[storedSite]) {
                        siteFilterInput.value = siteNames[storedSite];
                    }

                    // 触发搜索
                    if (typeof searchDevices === 'function') {
                        searchDevices();
                    }

                    console.log(`从故障分析跳转，已筛选站点: ${siteNames[storedSite] || storedSite}`);
                } else {
                    // 检查URL参数，如果有站点参数则自动选择
                    const urlParams = new URLSearchParams(window.location.search);
                    const siteParam = urlParams.get('site');
                    const siteNameParam = urlParams.get('siteName');

                    if (siteParam) {
                        const unifiedSelect = document.getElementById('unifiedSiteSelect');
                        if (unifiedSelect) {
                            // 设置选中的站点
                            unifiedSelect.value = siteParam;

                            // 触发站点变更事件
                            handleSiteChange();

                            console.log(`从站点管理跳转，已选择站点: ${siteNameParam || siteParam}`);
                        }
                    }
                }

                renderTable();
            });
        } else {
            // 确保表格视图可见
            const tableView = document.getElementById('table-view');
            if (tableView) {
                tableView.style.display = 'block';
            }
            // 确保查询区域可见
            const queryArea = document.getElementById('query-area');
            if (queryArea) {
                queryArea.style.display = 'block';
            }

            // 检查localStorage中的站点筛选条件（从故障分析跳转）
            const storedSite = localStorage.getItem('deviceFilterSite');
            if (storedSite) {
                // 清除localStorage中的值（只使用一次）
                localStorage.removeItem('deviceFilterSite');

                // 设置站点筛选
                const siteFilterInput = document.getElementById('siteFilterInput');
                const siteFilter = document.getElementById('siteFilter');
                const unifiedSelect = document.getElementById('unifiedSiteSelect');

                if (siteFilter) {
                    siteFilter.value = storedSite;
                }
                if (unifiedSelect) {
                    unifiedSelect.value = storedSite;
                }

                // 更新显示文本
                const siteNames = {
                    'site1': '科技园区站',
                    'site2': '工业园区站',
                    'site3': '商业中心站',
                    'site4': '物流园区站',
                    'site5': '产业园区站',
                    'site6': '数据中心站'
                };
                if (siteFilterInput && siteNames[storedSite]) {
                    siteFilterInput.value = siteNames[storedSite];
                }

                // 触发搜索
                if (typeof searchDevices === 'function') {
                    searchDevices();
                }

                console.log(`从故障分析跳转，已筛选站点: ${siteNames[storedSite] || storedSite}`);
            } else {
                // 检查URL参数，如果有站点参数则自动选择
                const urlParams = new URLSearchParams(window.location.search);
                const siteParam = urlParams.get('site');
                const siteNameParam = urlParams.get('siteName');

                if (siteParam) {
                    const unifiedSelect = document.getElementById('unifiedSiteSelect');
                    if (unifiedSelect) {
                        // 设置选中的站点
                        unifiedSelect.value = siteParam;

                        // 触发站点变更事件
                        handleSiteChange();

                        console.log(`从站点管理跳转，已选择站点: ${siteNameParam || siteParam}`);
                    }
                }
            }

            renderTable();
        }
        
        // 隐藏3D视图相关元素
        const sceneContainer = document.getElementById('scene-container');
        if (sceneContainer) {
            sceneContainer.style.display = 'none';
        }
        const dataPanel = document.getElementById('dataPanel');
        if (dataPanel) {
            dataPanel.style.display = 'none';
        }
        
        // 初始化浮动弹窗
        // 浮动模态框已移除，注释掉初始化
        // setTimeout(() => {
        //     initFloatingModal();
        // }, 100);
        
        // 浮动弹窗拖动功能
        function initFloatingModal() {
            const modal = document.getElementById('floatingModal');
            const dragHandle = document.getElementById('dragHandle');
            
            console.log('Modal:', modal);
            console.log('DragHandle:', dragHandle);
            
            // 确保元素存在
            if (!modal || !dragHandle) {
                console.error('Modal elements not found');
                return;
            }
            
            console.log('Initializing drag functionality...');
            
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            dragHandle.onmousedown = dragMouseDown;
            console.log('Drag event handler attached');
            
            function dragMouseDown(e) {
                console.log('Drag started!');
                e = e || window.event;
                e.preventDefault();
                
                // 记录鼠标初始位置
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // 绑定移动和释放事件
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                
                // 改变光标
                dragHandle.style.cursor = 'grabbing';
                document.body.style.userSelect = 'none';
                
                console.log('Drag events bound');
            }
            
            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                
                // 计算鼠标移动距离
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                // 设置元素的新位置
                const newTop = modal.offsetTop - pos2;
                const newLeft = modal.offsetLeft - pos1;
                
                modal.style.top = newTop + "px";
                modal.style.left = newLeft + "px";
            }
            
            function closeDragElement() {
                // 停止移动
                document.onmouseup = null;
                document.onmousemove = null;
                
                // 恢复光标
                dragHandle.style.cursor = 'move';
                document.body.style.userSelect = '';
            }
        }
        
        // 切换弹窗大小
        function toggleModalSize() {
            const modal = document.getElementById('floatingModal');
            const icon = document.getElementById('resizeIcon');
            
            if (modal.classList.contains('expanded')) {
                modal.classList.remove('expanded');
                icon.className = 'fas fa-expand';
            } else {
                modal.classList.add('expanded');
                icon.className = 'fas fa-compress';
            }
        }
        
        // 切换Tab
        function switchTab(tabName) {
            // 艹！保存当前视图状态到localStorage
            localStorage.setItem('devicesViewMode', tabName);

            // 更新按钮状态
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.tab-button').classList.add('active');

            const tableView = document.getElementById('table-view');
            const sceneContainer = document.getElementById('scene-container');
            const energyFlowContainer = document.getElementById('energy-flow-container');
            const queryArea = document.getElementById('query-area');
            const dataPanel = document.getElementById('dataPanel');
            const mainContent = document.getElementById('mainContent');
            const statusLegend = document.getElementById('devicesSceneStatusLegend');

            const tablePlaceholder = document.getElementById('tablePlaceholder');

            if (tabName === 'table') {
                // 显示表格视图
                if (tableView) tableView.style.display = 'block';
                if (sceneContainer) sceneContainer.style.display = 'none';
                if (energyFlowContainer) energyFlowContainer.style.display = 'none';
                if (queryArea) queryArea.style.display = 'block'; // 表格模式显示查询区域
                if (dataPanel) dataPanel.style.display = 'none'; // 表格模式隐藏储能柜监控面板
                if (statusLegend) statusLegend.style.display = 'none'; // 艹！表格模式隐藏状态图例
                if (tablePlaceholder) tablePlaceholder.style.display = 'block'; // 显示占位元素
                // 保持视图切换按钮的padding
                if (mainContent) {
                    mainContent.style.padding = '24px';
                    mainContent.style.background = ''; // 恢复默认背景
                }
            } else if (tabName === 'view') {
                // 显示3D视图
                if (tableView) tableView.style.display = 'none';
                if (energyFlowContainer) energyFlowContainer.style.display = 'none';
                if (sceneContainer) {
                    sceneContainer.style.display = 'block';
                    // 确保容器填满可用空间，减去顶部导航栏和视图切换按钮的高度
                    sceneContainer.style.height = 'calc(100vh - 64px - 60px - 20px)'; // 导航栏 + 切换按钮 + margin

                    // 如果3D场景还未初始化，则初始化
                    if (!window.sceneInitialized) {
                        init3DScene();
                        window.sceneInitialized = true;
                    }
                }
                if (queryArea) queryArea.style.display = 'none'; // 视图模式隐藏查询区域
                if (dataPanel) dataPanel.style.display = 'block'; // 视图模式显示储能柜监控面板
                if (statusLegend) statusLegend.style.display = 'block'; // 艹！视图模式显示状态图例
                if (tablePlaceholder) tablePlaceholder.style.display = 'none'; // 隐藏占位元素
                // 3D视图模式下也保持padding，确保视图切换按钮正常显示
                if (mainContent) {
                    mainContent.style.padding = '24px';
                    mainContent.style.paddingBottom = '0'; // 底部不需要padding
                    mainContent.style.background = ''; // 使用默认背景
                }
            } else if (tabName === 'flow') {
                // 显示能量流视图
                if (tableView) tableView.style.display = 'none';
                if (sceneContainer) sceneContainer.style.display = 'none';
                if (energyFlowContainer) {
                    energyFlowContainer.style.display = 'block';
                    // 如果能量流视图还未初始化，则初始化
                    if (!window.energyFlowInitialized) {
                        initEnergyFlow();
                        window.energyFlowInitialized = true;
                    }
                }
                if (queryArea) queryArea.style.display = 'none'; // 能量流模式隐藏查询区域
                if (dataPanel) dataPanel.style.display = 'none'; // 能量流模式隐藏储能柜监控面板
                if (statusLegend) statusLegend.style.display = 'none'; // 能量流模式隐藏状态图例
                if (tablePlaceholder) tablePlaceholder.style.display = 'none'; // 隐藏占位元素
                // 能量流视图模式下保持padding
                if (mainContent) {
                    mainContent.style.padding = '24px';
                    mainContent.style.paddingBottom = '0';
                    mainContent.style.background = '';
                }
            }
        }
        
        // 场景相关变量
        let cabinets = [];
        let selectedCabinet = null;
        let stats = {
            totalCapacity: 2.5, // MWh
            currentEnergy: 1.96, // MWh
            onlineCount: 5,
            offlineCount: 2,
            faultCount: 1
        };
        
        // 初始化简单背景
        function init3DScene() {
            console.log('开始初始化场景');
            
            const container = document.getElementById('scene-container');
            if (!container) {
                throw new Error('找不到scene-container元素');
            }
            
            // 设置容器样式
            container.style.background = 'transparent';
            container.style.position = 'relative';
            container.style.height = 'calc(100vh - 64px)';
            container.style.overflow = 'hidden';
            container.style.display = 'block';
            
            // 隐藏加载提示
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // 确保数据面板可见
            const dataPanel = document.getElementById('dataPanel');
            if (dataPanel) {
                dataPanel.style.display = 'block';
            }
            
            // 确保显示数据选择可见
            const displayDataOptions = document.getElementById('displayDataOptions');
            if (displayDataOptions) {
                displayDataOptions.style.display = 'block';
            }
            
            // 确保状态图例可见
            const statusLegend = document.getElementById('devicesSceneStatusLegend');
            if (statusLegend) {
                statusLegend.style.display = 'block';
            }
            
            // 确保储能柜展示区域可见
            const cabinetDisplay = document.getElementById('cabinetDisplay');
            if (cabinetDisplay) {
                cabinetDisplay.style.display = 'block';
            }
            
            // 更新统计面板
            updateStatsPanel();
            
            // 默认选择SOC显示模式
            changeDisplayMode('soc');
        }
        
        // 设置灯光
        function setupLights() {
            // 灯光系统已删除
        }
        
        // 创建地面
        function createGround() {
            // 不创建地面和网格，保持空场景
        }
        
        // 加载3D储能柜
        function loadCabinets3D() {
            cabinets = [];
            
            // 暂时不创建任何储能柜模型
            
            // 更新统计面板
            updateStatsPanel();
        }
        
        // 创建2D储能柜
        function createCabinet2D(index) {
            // 创建储能柜容器
            const cabinetElement = document.createElement('div');
            cabinetElement.className = 'cabinet-item';
            cabinetElement.style.cssText = `
                position: relative;
                width: 100%;
                height: 100%;
                min-height: 300px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                overflow: hidden;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            // 随机生成状态
            const statuses = ['standby', 'charging', 'discharging', 'standby', 'charging'];
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            const soc = Math.floor(Math.random() * 40 + 60);
            const power = status === 'charging' ? (Math.random() * 100 + 50).toFixed(1) : 
                        status === 'discharging' ? -(Math.random() * 100 + 50).toFixed(1) : 0;
            const temperature = Math.random() * 15 + 25;
            const soh = 95 + Math.random() * 5;
            
            // 状态颜色
            const statusColors = {
                online: '#10b981',
                offline: '#f97316',
                fault: '#ef4444'
            };
            
            // 状态指示灯
            const statusLight = document.createElement('div');
            statusLight.style.cssText = `
                position: absolute;
                top: 10px;
                right: 10px;
                width: 12px;
                height: 12px;
                background: ${statusColors[status]};
                border-radius: 50%;
                box-shadow: 0 0 8px ${statusColors[status]};
            `;
            cabinetElement.appendChild(statusLight);
            
            // 储能柜图片
            const img = document.createElement('img');
            img.src = '储能柜.png';
            img.alt = '储能柜';
            img.style.cssText = `
                max-width: 80%;
                max-height: 200px;
                object-fit: contain;
            `;
            
            // 图片加载失败时使用备用样式
            img.onerror = function() {
                this.style.display = 'none';
                const fallback = document.createElement('div');
                fallback.style.cssText = `
                    width: 120px;
                    height: 180px;
                    background: #3a4556;
                    border-radius: 8px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 18px;
                    font-weight: bold;
                `;
                fallback.innerHTML = `
                    <div>储能柜</div>
                    <div style="font-size: 24px; margin-top: 10px;">${String(index + 1).padStart(3, '0')}</div>
                `;
                cabinetElement.appendChild(fallback);
            };
            
            cabinetElement.appendChild(img);
            
            // 信息面板
            const infoPanel = document.createElement('div');
            infoPanel.style.cssText = `
                width: 100%;
                margin-top: 16px;
                text-align: center;
            `;
            
            infoPanel.innerHTML = `
                <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">储能柜 ${String(index + 1).padStart(3, '0')}</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                    <div style="text-align: left;">
                        <span style="color: #666;">SOC:</span>
                        <span style="font-weight: 600; color: #333;">${soc}%</span>
                    </div>
                    <div style="text-align: right;">
                        <span style="color: #666;">功率:</span>
                        <span style="font-weight: 600; color: #333;">${power}kW</span>
                    </div>
                </div>
            `;
            
            cabinetElement.appendChild(infoPanel);
            
            // 悬停效果
            cabinetElement.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-4px)';
                this.style.boxShadow = '0 8px 24px rgba(0, 0, 0, 0.15)';
            });
            
            cabinetElement.addEventListener('mouseleave', function() {
                if (!this.classList.contains('selected')) {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                }
            });
            
            // 点击事件
            cabinetElement.addEventListener('click', function() {
                selectCabinet2D(index);
            });
            
            // 存储数据
            const cabinetData = {
                element: cabinetElement,
                index: index,
                status: status,
                soc: soc,
                power: parseFloat(power),
                temperature: temperature,
                soh: soh,
                utilization: Math.random() * 100,
                data: {
                    name: `储能柜 ${String(index + 1).padStart(3, '0')}`,
                    model: 'ESS-2500',
                    capacity: '312.5 kWh',
                    voltage: (Math.random() * 50 + 700).toFixed(1) + ' V',
                    current: (Math.random() * 100 + 150).toFixed(1) + ' A'
                }
            };
            
            return cabinetData;
        }
        
        // 不需要动画循环和窗口调整，因为只是静态背景
        
        // 显示储能柜信息
        function showCabinetInfo(cabinet) {
            if (!cabinet) return;
            
            const panel = document.getElementById('cabinetInfoPanel');
            if (!panel) return;
            
            // 更新面板信息
            document.getElementById('cabinetName').textContent = cabinet.data.name;
            document.getElementById('cabinetModel').textContent = cabinet.data.model;
            document.getElementById('cabinetCapacity').textContent = cabinet.data.capacity;
            document.getElementById('cabinetSOC').textContent = cabinet.soc + '%';
            document.getElementById('cabinetSOH').textContent = cabinet.soh.toFixed(1) + '%';
            document.getElementById('cabinetVoltage').textContent = cabinet.data.voltage;
            document.getElementById('cabinetCurrent').textContent = cabinet.data.current;
            document.getElementById('cabinetPower').textContent = cabinet.power + ' kW';
            document.getElementById('cabinetTemp').textContent = cabinet.temperature.toFixed(1) + '°C';
            
            // 显示面板
            panel.style.display = 'block';
        }
        
        // 关闭储能柜信息面板
        function closeCabinetPanel() {
            const panel = document.getElementById('cabinetInfoPanel');
            if (panel) {
                panel.classList.remove('active');
                panel.style.display = 'none';
            }
            selectedCabinet = null;
        }
        
        // 选择储能柜
        function selectCabinet(cabinetId) {
            console.log('选择储能柜:', cabinetId);
            
            // 跳转到储能柜详情页面
            window.location.href = `cabinet-detail.html?cabinetId=${cabinetId}`;
        }
        
        // 改变显示模式
        function changeDisplayMode(mode) {
            console.log('切换显示模式:', mode);
            
            // 更新全局显示模式
            window.currentDisplayMode = mode;
            
            // 更新单选按钮状态
            const radioButtons = document.querySelectorAll('input[name="displayMode"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value === mode;
            });
            
            // 更新所有储能柜的数据标签
            if (cabinets.length > 0) {
                cabinets.forEach(cabinet => {
                    const label = document.getElementById(`data-label-${cabinet.id}`);
                    if (label) {
                        let displayText = '';
                        switch(mode) {
                            case 'soc':
                                displayText = `${cabinet.soc}%`;
                                break;
                            case 'power':
                                displayText = `${cabinet.power} kWh`;
                                break;
                            case 'temperature':
                                displayText = `${cabinet.temperature}°`;
                                break;
                            case 'soh':
                                displayText = `${cabinet.soh}%`;
                                break;
                            case 'status':
                                displayText = cabinet.status === 'charging' ? '充电' : 
                                            cabinet.status === 'discharging' ? '放电' : '待机';
                                break;
                        }
                        label.textContent = displayText;
                        label.style.display = 'block';
                    }
                });
            }
        }
        
        // 切换数据面板
        function toggleDataPanel() {
            const content = document.getElementById('dataPanelContent');
            const icon = document.getElementById('panelToggleIcon');
            
            if (content.style.maxHeight === '0px') {
                content.style.maxHeight = 'calc(100vh - 120px)';
                icon.className = 'fas fa-chevron-up';
            } else {
                content.style.maxHeight = '0px';
                icon.className = 'fas fa-chevron-down';
            }
        }
        
        // 切换展开部分
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const icon = document.getElementById(sectionId + '-icon');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
            }
        }
        
        // 选择组件
        function selectComponent(componentName) {
            console.log('选择组件:', componentName);
            // 可以在这里添加组件高亮或显示详细信息的逻辑
        }
        
        // 切换图表选项卡
        function switchChartTab(tabName) {
            console.log('切换图表选项卡:', tabName);
            // 可以在这里添加图表切换逻辑
        }
        
        function updateStatsPanel() {
            // 初始化储能柜数据（如果还没有）
            if (cabinets.length === 0) {
                // 创建8个储能柜的模拟数据
                // 艹！状态：online（在线）、offline（离线）、fault（故障）
                for (let i = 1; i <= 8; i++) {
                    cabinets.push({
                        id: i,
                        status: i <= 5 ? 'online' : (i <= 7 ? 'offline' : 'fault'),
                        soc: Math.floor(Math.random() * 40 + 50),
                        soh: Math.floor(Math.random() * 10 + 90),
                        power: i <= 3 ? Math.floor(Math.random() * 100 + 50) :
                               (i <= 6 ? -Math.floor(Math.random() * 100 + 50) : 0),
                        voltage: (Math.random() * 50 + 720).toFixed(1),
                        current: (Math.random() * 100 + 100).toFixed(1),
                        temperature: (Math.random() * 5 + 23).toFixed(1),
                        charge_status: i <= 3 ? 'charging' : (i <= 5 ? 'discharging' : 'standby'),
                        efficiency: Math.floor(Math.random() * 5 + 93),
                        utilization: Math.floor(Math.random() * 30 + 60)
                    });
                }
            }
            
            // 统计状态
            let onlineCount = 0;
            let offlineCount = 0;
            let faultCount = 0;
            let totalSOC = 0;
            let totalPower = 0;
            let chargePower = 0;
            let dischargePower = 0;
            let socValues = [];
            let temperatures = [];
            let efficiencies = [];
            
            cabinets.forEach(cabinet => {
                // 状态统计 - 艹！统计在线、离线、故障数量
                if (cabinet.status === 'online') onlineCount++;
                else if (cabinet.status === 'offline') offlineCount++;
                else if (cabinet.status === 'fault') faultCount++;
                
                // 收集SOC值
                if (cabinet.status !== 'standby') {
                    totalSOC += cabinet.soc;
                    socValues.push(cabinet.soc);
                }
                
                // 温度数据（模拟）
                const temp = Math.random() * 15 + 25; // 25-40°C
                temperatures.push(temp);
                
                // 效率数据（模拟）
                if (cabinet.status !== 'standby') {
                    const efficiency = Math.random() * 5 + 92; // 92-97%
                    efficiencies.push(efficiency);
                }
                
                // 功率统计
                const power = parseFloat(cabinet.power);
                if (cabinet.status !== 'standby') {
                    totalPower += Math.abs(power);
                    // 根据状态分配充放电
                    if (cabinet.status === 'charging') {
                        chargePower += Math.abs(power);
                    } else if (cabinet.status === 'discharging') {
                        dischargePower += power * 0.6;
                    }
                }
            });
            
            // 计算关键指标
            const avgSOC = onlineCount > 0 ? Math.round(totalSOC / onlineCount) : 0;
            const socRange = socValues.length > 0 ? Math.max(...socValues) - Math.min(...socValues) : 0;
            const maxTemp = temperatures.length > 0 ? Math.max(...temperatures).toFixed(1) : 0;
            const tempRange = temperatures.length > 0 ? (Math.max(...temperatures) - Math.min(...temperatures)).toFixed(1) : 0;
            
            // 运行指标
            const totalCapacity = cabinets.length * 0.3125; // MWh
            const dispatchableCapacity = onlineCount * 0.3125 * 0.9; // 90%可调度
            const avgEfficiency = efficiencies.length > 0 ? (efficiencies.reduce((a, b) => a + b) / efficiencies.length).toFixed(1) : 0;
            const throughput = (Math.random() * 2 + 2).toFixed(1); // 模拟吞吐量
            
            // 更新DOM元素
            // 状态概览
            const onlineCountEl = document.getElementById('online-count');
            const offlineCountEl = document.getElementById('offline-count');
            const faultCountEl = document.getElementById('fault-count');
            if (onlineCountEl) onlineCountEl.textContent = onlineCount;
            if (offlineCountEl) offlineCountEl.textContent = offlineCount;
            if (faultCountEl) faultCountEl.textContent = faultCount;
            
            // 充放电状态
            let chargingCount = 0;
            let dischargingCount = 0;
            let standbyCount = 0;
            cabinets.forEach(cabinet => {
                if (cabinet.charge_status === 'charging') chargingCount++;
                else if (cabinet.charge_status === 'discharging') dischargingCount++;
                else if (cabinet.charge_status === 'standby') standbyCount++;
            });
            const chargingCountEl = document.getElementById('charging-count');
            const dischargingCountEl = document.getElementById('discharging-count');
            const standbyCountEl = document.getElementById('standby-count');
            if (chargingCountEl) chargingCountEl.textContent = chargingCount;
            if (dischargingCountEl) dischargingCountEl.textContent = dischargingCount;
            if (standbyCountEl) standbyCountEl.textContent = standbyCount;
            
            // 关键运行指标
            const totalCapacityEl = document.getElementById('total-capacity');
            const currentEnergyEl = document.getElementById('current-energy');
            const energyPercentEl = document.getElementById('energy-percent');
            const maxUtilizationEl = document.getElementById('max-utilization');
            const maxUtilCabinetEl = document.getElementById('max-util-cabinet');
            const minSocEl = document.getElementById('min-soc');
            const minSocCabinetEl = document.getElementById('min-soc-cabinet');
            const minSohEl = document.getElementById('min-soh');
            const minSohCabinetEl = document.getElementById('min-soh-cabinet');
            
            if (totalCapacityEl) totalCapacityEl.textContent = totalCapacity.toFixed(1);
            if (currentEnergyEl) currentEnergyEl.textContent = (totalCapacity * avgSOC / 100).toFixed(2);
            if (energyPercentEl) energyPercentEl.textContent = avgSOC;
            
            // 找出最高利用率和最低SOC/SOH的储能柜
            let maxUtil = { value: 0, id: 0 };
            let minSoc = { value: 100, id: 0 };
            let minSoh = { value: 100, id: 0 };
            
            cabinets.forEach(cabinet => {
                if (cabinet.utilization > maxUtil.value) {
                    maxUtil.value = cabinet.utilization;
                    maxUtil.id = cabinet.id;
                }
                if (cabinet.soc < minSoc.value) {
                    minSoc.value = cabinet.soc;
                    minSoc.id = cabinet.id;
                }
                if (cabinet.soh < minSoh.value) {
                    minSoh.value = cabinet.soh;
                    minSoh.id = cabinet.id;
                }
            });
            
            if (maxUtilizationEl) maxUtilizationEl.textContent = maxUtil.value;
            if (maxUtilCabinetEl) maxUtilCabinetEl.textContent = String(maxUtil.id).padStart(3, '0');
            if (minSocEl) minSocEl.textContent = minSoc.value;
            if (minSocCabinetEl) minSocCabinetEl.textContent = String(minSoc.id).padStart(3, '0');
            if (minSohEl) minSohEl.textContent = minSoh.value;
            if (minSohCabinetEl) minSohCabinetEl.textContent = String(minSoh.id).padStart(3, '0');
            
            // 收益统计
            const yesterdayProfitEl = document.getElementById('yesterday-profit');
            const todayProfitEl = document.getElementById('today-profit');
            const monthProfitEl = document.getElementById('month-profit');
            const totalProfitEl = document.getElementById('total-profit');
            
            if (yesterdayProfitEl) yesterdayProfitEl.textContent = '12,350';
            if (todayProfitEl) todayProfitEl.textContent = '8,450';
            if (monthProfitEl) monthProfitEl.textContent = '326.5';
            if (totalProfitEl) totalProfitEl.textContent = '1.85';
            
            // 更新储能柜状态颜色叠加 - 艹！蓝色在线、黄色离线、红色故障
            cabinets.forEach((cabinet, index) => {
                const overlay = document.getElementById(`status-overlay-${cabinet.id}`);
                if (overlay) {
                    if (cabinet.status === 'online') {
                        // 在线 - 蓝色叠加
                        overlay.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';
                    } else if (cabinet.status === 'offline') {
                        // 离线 - 黄色叠加
                        overlay.style.backgroundColor = 'rgba(245, 158, 11, 0.3)';
                    } else if (cabinet.status === 'fault') {
                        // 故障 - 红色叠加
                        overlay.style.backgroundColor = 'rgba(239, 68, 68, 0.3)';
                    }
                }
            });
        }

        // 不需要鼠标事件，因为没有模型

        // 处理站点选择变化
        function handleSiteChange() {
            const unifiedSelect = document.getElementById('unifiedSiteSelect');
            const selectedValue = unifiedSelect.value;
            
            // 获取当前视图
            const tableView = document.getElementById('table-view');
            const isTableView = tableView && tableView.style.display !== 'none';
            
            if (isTableView) {
                // 表格视图：更新筛选
                document.getElementById('siteFilter').value = selectedValue;
                searchDevices();
            } else {
                // 3D视图：更新场景
                changeSite(selectedValue);
            }
        }
        
        // 切换站点（3D视图）
        function changeSite(siteId) {
            if (!siteId) {
                // 获取选择的值
                const siteSelect = document.getElementById('unifiedSiteSelect');
                siteId = siteSelect.value;
            }
            
            console.log('切换到站点:', siteId);
            
            // 根据站点更新储能柜数量和布局
            updateCabinetDisplay(siteId);
            
            // 更新统计数据
            updateStatsPanel();
        }
        
        // 根据站点更新储能柜显示
        function updateCabinetDisplay(siteId) {
            // 这里可以根据不同站点更新储能柜的数量和数据
            // 示例：不同站点有不同数量的储能柜
            const siteConfigs = {
                'sz': { count: 8, name: '深圳储能站' },
                'gz': { count: 12, name: '广州储能站' },
                'sh': { count: 10, name: '上海储能站' },
                'bj': { count: 15, name: '北京储能站' },
                'cd': { count: 6, name: '成都储能站' },
                'hz': { count: 9, name: '杭州储能站' },
                'wh': { count: 11, name: '武汉储能站' },
                'xa': { count: 8, name: '西安储能站' },
                'nj': { count: 7, name: '南京储能站' },
                'cq': { count: 13, name: '重庆储能站' }
            };
            
            const config = siteConfigs[siteId] || siteConfigs['sz'];
            console.log(`加载${config.name}，共${config.count}台储能柜`);

            // 这里可以动态更新储能柜的显示
            // 例如：隐藏多余的储能柜图片，或者重新排列等
        }

        // ==================== 能量流视图功能（可配置拖拽版）====================

        // 站点可用设备数据（模拟从后端获取）
        let availableDevices = {
            power: [
                { id: 'grid-1', type: 'grid', label: '市电', icon: '电网.png', desc: '380V 3相' },
                { id: 'gen-1', type: 'generator', label: '柴发', icon: '柜子打开.png', desc: '500KW' },
                { id: 'solar-1', type: 'solar', label: '光伏', icon: '光伏.png', desc: '200KW' }
            ],
            storage: [
                { id: 'pcs-1', type: 'pcs', label: '储能柜', icon: '储能柜.png', desc: '250KW/500KWh' }
            ],
            load: [
                { id: 'load-1', type: 'load', label: '负载', icon: '负载.png', desc: '工业负载' }
            ]
        };

        // 编辑模式状态
        let isEditMode = false; // 默认为预览模式

        // 画布上已放置的设备（自由画布，不再分层）
        let placedDevices = [];

        // 设备连接线
        let deviceConnections = [];

        // 连接状态
        let connectionStart = null; // {deviceId, direction, x, y}
        let selectedDevice = null; // 当前选中的设备ID
        let isDraggingConnection = false; // 是否正在拖拽连线
        let tempConnectionLine = null; // 临时连线元素

        // 连线自定义编辑状态
        let selectedConnection = null; // 当前选中的连线索引
        let isDraggingControlPoint = false; // 是否正在拖拽控制点
        let draggingControlPointIndex = null; // 正在拖拽的控制点索引

        // 拖拽相关
        let draggedDeviceData = null;
        let draggedPlacedDevice = null; // 正在拖拽的已放置设备 {deviceId}
        let isDraggingPlacedDevice = false; // 标记是否正在拖拽已放置的设备

        // 切换设备面板收起/展开
        function toggleDevicePanel() {
            const panel = document.getElementById('deviceListPanel');
            const toggleBtn = document.getElementById('panelToggleBtn');
            const isPanelCollapsed = panel.classList.contains('collapsed');

            if (isPanelCollapsed) {
                // 展开面板
                panel.classList.remove('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                toggleBtn.title = '收起面板';
            } else {
                // 收起面板
                panel.classList.add('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                toggleBtn.title = '展开面板';
            }

            // 面板是固定定位，画布不需要调整
        }

        // 切换右侧设置面板
        function toggleSettingsPanel() {
            const panel = document.getElementById('deviceSettingsPanel');
            const toggleBtn = document.getElementById('settingsPanelToggleBtn');
            const isPanelCollapsed = panel.classList.contains('collapsed');

            if (isPanelCollapsed) {
                // 展开面板
                panel.classList.remove('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                toggleBtn.title = '收起面板';
            } else {
                // 收起面板
                panel.classList.add('collapsed');
                toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                toggleBtn.title = '展开面板';
            }
        }

        // 处理设备鼠标按下事件
        let deviceClickTimer = null;
        function handleDeviceMouseDown(event, deviceId) {
            if (!isEditMode) return;

            // 延迟显示设置面板，避免拖拽时误触
            deviceClickTimer = setTimeout(() => {
                showDeviceSettings(deviceId);
            }, 200);
        }

        // 在拖拽开始时取消点击定时器
        window.addEventListener('dragstart', () => {
            if (deviceClickTimer) {
                clearTimeout(deviceClickTimer);
                deviceClickTimer = null;
            }
        });

        // 切换设备参数显示（立即生效）
        function toggleDeviceParam(deviceId, paramName, enabled) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            device.displayParams[paramName].enabled = enabled;
            renderPlacedDevices();
        }

        // 实时更新设备属性
        function updateDeviceProperty(deviceId, property, value) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            device[property] = value;
            renderPlacedDevices();
        }

        // 删除设备参数
        function removeDeviceParam(deviceId, paramName, event) {
            event.stopPropagation();
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            device.displayParams[paramName].enabled = false;

            // 更新设置面板中的checkbox
            const checkbox = document.getElementById(`display${paramName.charAt(0).toUpperCase() + paramName.slice(1)}`);
            if (checkbox) checkbox.checked = false;

            renderPlacedDevices();
        }

        // 删除参数（点击×按钮）
        function deleteDeviceParam(event, deviceId, paramType) {
            event.stopPropagation();
            event.preventDefault();

            // 检查是否在编辑模式
            if (!isEditMode) {
                showMiniToast('请先进入编辑模式', 'warning');
                return;
            }

            const device = placedDevices.find(d => d.id === deviceId);
            if (!device || !device.displayParams) return;

            // 禁用该参数
            device.displayParams[paramType].enabled = false;

            // 更新设置面板中的checkbox
            const checkbox = document.getElementById(`display${paramType.charAt(0).toUpperCase() + paramType.slice(1)}`);
            if (checkbox) checkbox.checked = false;

            // 重新渲染
            renderPlacedDevices();
            showMiniToast(`已隐藏 ${paramType.toUpperCase()} 参数`, 'success');
        }

        // 删除设备（点击×按钮）
        function deleteDevice(event, deviceId) {
            event.stopPropagation();
            event.preventDefault();

            // 检查是否在编辑模式
            if (!isEditMode) {
                showMiniToast('⚠️ 请先进入编辑模式', 'warning');
                return;
            }

            // 删除相关连线
            deviceConnections = deviceConnections.filter(conn =>
                conn.from !== deviceId && conn.to !== deviceId
            );

            // 删除设备
            const deviceName = placedDevices.find(d => d.id === deviceId)?.label || '设备';
            placedDevices = placedDevices.filter(d => d.id !== deviceId);

            // 重新渲染
            renderPlacedDevices();
            drawAllConnections();

            // 保存到localStorage
            saveToLocalStorage();

            showMiniToast(`✅ 已删除 ${deviceName}`, 'success');
        }

        // 参数拖拽相关变量
        let draggedParam = null;
        let paramDragStartX = 0;
        let paramDragStartY = 0;

        // 开始拖拽参数
        function startParamDrag(event, deviceId, paramName) {
            if (!isEditMode) return;

            // 阻止事件冒泡和默认行为，防止触发设备拖拽
            event.stopPropagation();
            event.preventDefault();

            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            draggedParam = { deviceId, paramName };
            paramDragStartX = event.clientX;
            paramDragStartY = event.clientY;

            // 临时禁用设备的 draggable 属性
            const deviceElement = document.getElementById(`placed-${deviceId}`);
            if (deviceElement) {
                deviceElement.setAttribute('draggable', 'false');
            }

            document.addEventListener('mousemove', onParamDrag);
            document.addEventListener('mouseup', endParamDrag);
        }

        // 拖拽参数中
        function onParamDrag(event) {
            if (!draggedParam) return;

            const device = placedDevices.find(d => d.id === draggedParam.deviceId);
            if (!device) return;

            const deltaX = event.clientX - paramDragStartX;
            const deltaY = event.clientY - paramDragStartY;

            device.displayParams[draggedParam.paramName].x += deltaX;
            device.displayParams[draggedParam.paramName].y += deltaY;

            paramDragStartX = event.clientX;
            paramDragStartY = event.clientY;

            renderPlacedDevices();
        }

        // 结束拖拽参数
        function endParamDrag() {
            // 恢复设备的 draggable 属性
            if (draggedParam && isEditMode) {
                const deviceElement = document.getElementById(`placed-${draggedParam.deviceId}`);
                if (deviceElement) {
                    deviceElement.setAttribute('draggable', 'true');
                }
            }

            draggedParam = null;
            document.removeEventListener('mousemove', onParamDrag);
            document.removeEventListener('mouseup', endParamDrag);
        }

        // 显示设备设置面板
        function showDeviceSettings(deviceId) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            const panel = document.getElementById('deviceSettingsPanel');
            const titleEl = document.getElementById('settingsPanelTitle');
            const contentEl = document.getElementById('settingsPanelContent');

            // 设置标题
            titleEl.textContent = `${device.label} - 设置`;

            // 初始化设备的显示参数和流向（如果不存在）
            if (!device.displayParams) {
                device.displayParams = {
                    power: { enabled: true, x: 120, y: 0 },
                    voltage: { enabled: false, x: 120, y: 30 },
                    current: { enabled: false, x: 120, y: 60 },
                    soc: { enabled: false, x: 120, y: 90 }
                };
            }
            // 流向判断基于哪个属性和正负
            if (!device.flowControl) {
                device.flowControl = {
                    inAttribute: 'power',      // 流入判断属性
                    inDirection: 'positive',   // 流入方向（positive/negative）
                    outAttribute: 'power',     // 流出判断属性
                    outDirection: 'negative'   // 流出方向（positive/negative）
                };
            }

            // 生成设置内容
            let settingsHTML = `
                <div class="settings-item">
                    <label class="settings-item-label">设备名称</label>
                    <input type="text" class="settings-item-input" id="deviceName" value="${device.label}"
                           oninput="updateDeviceProperty('${deviceId}', 'label', this.value)" />
                </div>

                <div class="settings-item">
                    <label class="settings-item-label">显示参数（可多选）</label>
                    <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displayPower" ${device.displayParams.power.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'power', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">功率 (P)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displayVoltage" ${device.displayParams.voltage.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'voltage', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">电压 (U)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displayCurrent" ${device.displayParams.current.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'current', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">电流 (I)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="displaySOC" ${device.displayParams.soc.enabled ? 'checked' : ''}
                                   onchange="toggleDeviceParam('${deviceId}', 'soc', this.checked)"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="font-size: 13px; color: var(--text-primary);">SOC (%)</span>
                        </label>
                    </div>
                </div>

                <div class="settings-item">
                    <label class="settings-item-label">流向</label>
                    <div style="margin-top: 8px;">
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(53, 98, 227, 0.05); border-radius: 6px; border-left: 3px solid var(--primary-color);">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: var(--text-primary);">
                                流入
                            </label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select class="settings-item-select" id="flowInAttribute" style="flex: 1;">
                                    <option value="power" ${device.flowControl.inAttribute === 'power' ? 'selected' : ''}>功率 (P)</option>
                                    <option value="voltage" ${device.flowControl.inAttribute === 'voltage' ? 'selected' : ''}>电压 (U)</option>
                                    <option value="current" ${device.flowControl.inAttribute === 'current' ? 'selected' : ''}>电流 (I)</option>
                                    <option value="soc" ${device.flowControl.inAttribute === 'soc' ? 'selected' : ''}>SOC</option>
                                </select>
                                <select class="settings-item-select" id="flowInDirection" style="flex: 0 0 100px;">
                                    <option value="positive" ${device.flowControl.inDirection === 'positive' ? 'selected' : ''}>正数</option>
                                    <option value="negative" ${device.flowControl.inDirection === 'negative' ? 'selected' : ''}>负数</option>
                                </select>
                            </div>
                        </div>
                        <div style="padding: 12px; background: rgba(239, 68, 68, 0.05); border-radius: 6px; border-left: 3px solid #ef4444;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: var(--text-primary);">
                                流出
                            </label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select class="settings-item-select" id="flowOutAttribute" style="flex: 1;">
                                    <option value="power" ${device.flowControl.outAttribute === 'power' ? 'selected' : ''}>功率 (P)</option>
                                    <option value="voltage" ${device.flowControl.outAttribute === 'voltage' ? 'selected' : ''}>电压 (U)</option>
                                    <option value="current" ${device.flowControl.outAttribute === 'current' ? 'selected' : ''}>电流 (I)</option>
                                    <option value="soc" ${device.flowControl.outAttribute === 'soc' ? 'selected' : ''}>SOC</option>
                                </select>
                                <select class="settings-item-select" id="flowOutDirection" style="flex: 0 0 100px;">
                                    <option value="positive" ${device.flowControl.outDirection === 'positive' ? 'selected' : ''}>正数</option>
                                    <option value="negative" ${device.flowControl.outDirection === 'negative' ? 'selected' : ''}>负数</option>
                                </select>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; line-height: 1.5;">
                            示例：选择"功率 + 正数"表示功率为正时流入/流出
                        </div>
                    </div>
                </div>
            `;

            // 根据设备类型添加特定设置
            if (device.type === '市电' || device.type === '柴发' || device.type === '光伏') {
                settingsHTML += `
                    <div class="settings-item">
                        <label class="settings-item-label">额定功率 (KW)</label>
                        <input type="number" class="settings-item-input" id="devicePower" value="${device.power || 500}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">电压等级</label>
                        <select class="settings-item-select" id="deviceVoltage">
                            <option value="380V" ${device.voltage === '380V' ? 'selected' : ''}>380V</option>
                            <option value="220V" ${device.voltage === '220V' ? 'selected' : ''}>220V</option>
                            <option value="10KV" ${device.voltage === '10KV' ? 'selected' : ''}>10KV</option>
                        </select>
                    </div>
                `;
            } else if (device.type === '储能柜') {
                settingsHTML += `
                    <div class="settings-item">
                        <label class="settings-item-label">容量 (KWh)</label>
                        <input type="number" class="settings-item-input" id="deviceCapacity" value="${device.capacity || 1000}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">充电功率 (KW)</label>
                        <input type="number" class="settings-item-input" id="deviceChargePower" value="${device.chargePower || 500}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">放电功率 (KW)</label>
                        <input type="number" class="settings-item-input" id="deviceDischargePower" value="${device.dischargePower || 500}" />
                    </div>
                `;
            } else if (device.type === '负载') {
                settingsHTML += `
                    <div class="settings-item">
                        <label class="settings-item-label">负载功率 (KW)</label>
                        <input type="number" class="settings-item-input" id="deviceLoadPower" value="${device.loadPower || 300}" />
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">负载类型</label>
                        <select class="settings-item-select" id="deviceLoadType">
                            <option value="恒定负载" ${device.loadType === '恒定负载' ? 'selected' : ''}>恒定负载</option>
                            <option value="可调负载" ${device.loadType === '可调负载' ? 'selected' : ''}>可调负载</option>
                            <option value="优先级负载" ${device.loadType === '优先级负载' ? 'selected' : ''}>优先级负载</option>
                        </select>
                    </div>
                `;
            }

            // 不再添加操作按钮，所有修改即时生效，通过顶部保存按钮统一保存

            contentEl.innerHTML = settingsHTML;

            // 显示面板
            panel.style.display = 'block';
            panel.classList.remove('collapsed');
        }

        // 保存设备设置
        function saveDeviceSettings(deviceId) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            // 更新基本信息
            const nameInput = document.getElementById('deviceName');
            if (nameInput) device.label = nameInput.value;

            // 显示参数已通过checkbox立即更新，这里不需要再保存

            // 更新流向设置
            const flowInAttribute = document.getElementById('flowInAttribute');
            const flowInDirection = document.getElementById('flowInDirection');
            const flowOutAttribute = document.getElementById('flowOutAttribute');
            const flowOutDirection = document.getElementById('flowOutDirection');

            if (flowInAttribute && flowInDirection && flowOutAttribute && flowOutDirection) {
                device.flowControl = {
                    inAttribute: flowInAttribute.value,
                    inDirection: flowInDirection.value,
                    outAttribute: flowOutAttribute.value,
                    outDirection: flowOutDirection.value
                };
            }

            // 根据设备类型更新特定属性
            if (device.type === '市电' || device.type === '柴发' || device.type === '光伏') {
                const powerInput = document.getElementById('devicePower');
                const voltageSelect = document.getElementById('deviceVoltage');
                if (powerInput) device.power = parseFloat(powerInput.value);
                if (voltageSelect) device.voltage = voltageSelect.value;
            } else if (device.type === '储能柜') {
                const capacityInput = document.getElementById('deviceCapacity');
                const chargePowerInput = document.getElementById('deviceChargePower');
                const dischargePowerInput = document.getElementById('deviceDischargePower');
                if (capacityInput) device.capacity = parseFloat(capacityInput.value);
                if (chargePowerInput) device.chargePower = parseFloat(chargePowerInput.value);
                if (dischargePowerInput) device.dischargePower = parseFloat(dischargePowerInput.value);
            } else if (device.type === '负载') {
                const loadPowerInput = document.getElementById('deviceLoadPower');
                const loadTypeSelect = document.getElementById('deviceLoadType');
                if (loadPowerInput) device.loadPower = parseFloat(loadPowerInput.value);
                if (loadTypeSelect) device.loadType = loadTypeSelect.value;
            }

            // 重新渲染设备
            renderPlacedDevices();

            // 显示保存成功提示
            showMiniToast('✅ 设备设置已保存', 'success');
        }

        // 切换编辑/预览模式
        function toggleEditMode() {
            isEditMode = !isEditMode;
            console.log('🔄 切换编辑模式，当前状态:', isEditMode ? '编辑模式' : '预览模式');

            const editModeBtn = document.getElementById('editModeBtn');
            const saveBtn = document.getElementById('saveBtn');
            const deviceListPanel = document.getElementById('deviceListPanel');

            if (isEditMode) {
                // 进入编辑模式
                console.log('✏️ 进入编辑模式');
                editModeBtn.innerHTML = '<i class="fas fa-eye" style="color: white;"></i><span>预览</span>';
                editModeBtn.className = 'toolbar-btn';
                editModeBtn.style.background = '#6b7280';
                editModeBtn.style.borderColor = '#6b7280';
                editModeBtn.style.color = 'white';
                editModeBtn.title = '切换到预览模式';
                saveBtn.style.display = 'inline-flex'; // 显示保存按钮
                document.getElementById('alignmentBtns').style.display = 'flex'; // 显示对齐按钮组
                deviceListPanel.style.display = 'block';

                // 重新渲染设备以显示删除按钮和连接点
                renderPlacedDevices();

                // 启用所有已放置设备的拖拽和连线功能
                const placedDeviceElements = document.querySelectorAll('.placed-device');
                placedDeviceElements.forEach(el => {
                    el.style.cursor = 'move';
                });
            } else {
                // 进入预览模式
                console.log('👁️ 进入预览模式');
                editModeBtn.innerHTML = '<i class="fas fa-edit"></i><span>编辑</span>';
                editModeBtn.className = 'toolbar-btn primary';
                // 清除编辑模式设置的内联样式
                editModeBtn.style.background = '';
                editModeBtn.style.borderColor = '';
                editModeBtn.style.color = '';
                editModeBtn.title = '进入编辑模式';
                saveBtn.style.display = 'none'; // 隐藏保存按钮
                document.getElementById('alignmentBtns').style.display = 'none'; // 隐藏对齐按钮组
                deviceListPanel.style.display = 'none';

                // 隐藏右侧设置面板
                const settingsPanel = document.getElementById('deviceSettingsPanel');
                if (settingsPanel) settingsPanel.style.display = 'none';

                // 禁用所有已放置设备的拖拽和连线功能
                const placedDeviceElements = document.querySelectorAll('.placed-device');
                placedDeviceElements.forEach(el => {
                    el.style.cursor = 'default';
                });

                // 取消所有选中状态
                selectedDevice = null;
                selectedConnection = null;
                connectionStart = null;
                isDraggingConnection = false;
                renderPlacedDevices();

                // 居中显示画布内容
                console.log('⏱️ 延迟100ms后调用居中函数');
                setTimeout(() => {
                    centerCanvasContent();
                }, 100);
            }
        }

        // 自动修复市电到储能柜的连线路径
        function fixUtilityToStorageConnection() {
            console.log('🔧 检查并修复市电到储能柜的连线...');

            // 查找市电到储能柜的连线（支持多种ID格式）
            const connIndex = deviceConnections.findIndex(conn => {
                const fromId = conn.from.toLowerCase();
                const toId = conn.to.toLowerCase();

                const isFromUtility = fromId.includes('grid-1') || fromId.includes('utility') || fromId.includes('市电');
                const isToStorage = toId.includes('storage') || toId.includes('储能') || toId.includes('battery');

                const isFromStorage = fromId.includes('storage') || fromId.includes('储能') || fromId.includes('battery');
                const isToUtility = toId.includes('grid-1') || toId.includes('utility') || toId.includes('市电');

                return (isFromUtility && isToStorage) || (isFromStorage && isToUtility);
            });

            if (connIndex === -1) {
                console.log('⚠️ 未找到市电到储能柜的连线');
                return;
            }

            const conn = deviceConnections[connIndex];
            console.log('✅ 找到连线:', conn);

            // 获取两个设备
            const fromDevice = placedDevices.find(d => d.id === conn.from);
            const toDevice = placedDevices.find(d => d.id === conn.to);

            if (!fromDevice || !toDevice) {
                console.log('⚠️ 设备未找到');
                return;
            }

            console.log('📍 市电位置:', fromDevice.x, fromDevice.y);
            console.log('📍 储能柜位置:', toDevice.x, toDevice.y);

            // 如果已经有控制点，跳过
            if (conn.controlPoints && conn.controlPoints.length > 0) {
                console.log('ℹ️ 连线已有控制点，跳过修复');
                return;
            }

            // 计算控制点位置（只要一个拐点）
            const fromCenterX = fromDevice.x + 70; // 设备中心X（假设设备宽度140px）
            const fromCenterY = fromDevice.y + 75; // 设备中心Y
            const toCenterX = toDevice.x + 70;
            const toCenterY = toDevice.y + 75;

            // 计算拐点：从市电垂直向下到储能柜Y坐标的中点
            const cornerY = (fromCenterY + toCenterY) / 2;

            // 只添加一个控制点（从市电垂直向下后拐弯）
            conn.controlPoints = [
                { x: fromCenterX, y: cornerY }  // 拐点：市电下方，然后斜向储能柜
            ];

            // 调整连接方向
            conn.fromDirection = 'bottom';
            conn.toDirection = 'top';

            console.log('✅ 已添加控制点:', conn.controlPoints);

            // 重新绘制连线
            drawAllConnections();

            // 保存配置
            saveToLocalStorage();

            console.log('🎉 连线路径修复完成！');
        }

        // 初始化能量流视图
        function initEnergyFlow() {
            // 初始化为预览模式，隐藏设备列表和设置面板
            const deviceListPanel = document.getElementById('deviceListPanel');
            if (deviceListPanel) deviceListPanel.style.display = 'none';

            const settingsPanel = document.getElementById('deviceSettingsPanel');
            if (settingsPanel) settingsPanel.style.display = 'none';

            loadAvailableDevices();
            loadSavedConfig();

            // 如果没有保存的配置（第一次访问），自动应用默认布局
            if (placedDevices.length === 0) {
                console.log('🎯 未找到保存的配置，自动应用默认能量流布局');
                applyGridLayout();
            } else {
                renderPlacedDevices();
            }

            // 自动修复市电到储能柜的连线
            setTimeout(() => {
                fixUtilityToStorageConnection();
            }, 300);

            // 初始化后居中显示内容
            setTimeout(() => {
                centerCanvasContent();
            }, 500);

            // 添加全局鼠标事件监听器，用于连线拖拽
            const canvas = document.getElementById('energyFlowCanvas');

            // 鼠标移动时更新临时连线或控制点位置
            canvas.addEventListener('mousemove', function(event) {
                const canvasRect = canvas.getBoundingClientRect();
                const x = event.clientX - canvasRect.left;
                const y = event.clientY - canvasRect.top;

                // 如果正在拖拽控制点
                if (isDraggingControlPoint && selectedConnection !== null && draggingControlPointIndex !== null) {
                    // 更新控制点位置
                    if (deviceConnections[selectedConnection] && deviceConnections[selectedConnection].controlPoints) {
                        deviceConnections[selectedConnection].controlPoints[draggingControlPointIndex] = { x, y };
                        drawAllConnections();
                    }
                }
                // 如果正在拖拽创建连线
                else if (isDraggingConnection && connectionStart) {
                    updateTempConnectionLine(x, y);

                    // 检查是否悬停在连接点上，高亮显示
                    const target = document.elementFromPoint(event.clientX, event.clientY);
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                    if (target && target.classList.contains('connection-point')) {
                        const targetDeviceId = target.getAttribute('data-device-id');
                        if (targetDeviceId !== connectionStart.deviceId) {
                            target.style.transform = 'translate(-50%, -50%) scale(1.5)';
                            target.style.width = '18px';
                            target.style.height = '18px';
                        }
                    }
                }
            });

            // 鼠标松开时完成连线或结束控制点拖拽
            canvas.addEventListener('mouseup', function(event) {
                // 结束控制点拖拽
                if (isDraggingControlPoint) {
                    isDraggingControlPoint = false;
                    draggingControlPointIndex = null;
                    document.body.style.cursor = '';
                }
                // 结束连线拖拽
                else if (isDraggingConnection) {
                    endConnectionDrag(event);
                    // 重置所有连接点样式
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                }
            });

            // 鼠标离开画布时也结束连线
            canvas.addEventListener('mouseleave', function(event) {
                if (isDraggingConnection) {
                    endConnectionDrag(event);
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                }
            });

            // 在全局 document 级别也监听 mouseup，以防 canvas 事件被阻止
            document.addEventListener('mouseup', function(event) {
                // 结束控制点拖拽
                if (isDraggingControlPoint) {
                    isDraggingControlPoint = false;
                    draggingControlPointIndex = null;
                    document.body.style.cursor = '';
                }
                // 结束连线拖拽
                else if (isDraggingConnection) {
                    endConnectionDrag(event);
                    // 重置所有连接点样式
                    document.querySelectorAll('.connection-point').forEach(point => {
                        point.style.transform = '';
                        point.style.width = '';
                        point.style.height = '';
                    });
                }
            });

            // 点击画布空白处取消选中
            canvas.addEventListener('click', function(event) {
                // 如果点击的不是连线、控制点或设备，则取消选中
                if (event.target === canvas || event.target.id === 'energyConnections') {
                    if (selectedConnection !== null) {
                        selectedConnection = null;
                        drawAllConnections();
                    }
                }
            });

            // 暴露变量和函数到全局，方便调试和测试
            window.placedDevices = placedDevices;
            window.deviceConnections = deviceConnections;
            window.selectedConnection = selectedConnection;
            window.renderPlacedDevices = renderPlacedDevices;
            window.drawAllConnections = drawAllConnections;
            window.selectConnection = selectConnection;
            window.availableDevices = availableDevices;
        }

        // 加载可用设备列表（过滤已放置的设备）
        function loadAvailableDevices() {
            // 获取已放置设备的ID列表
            const placedDeviceIds = placedDevices.map(d => d.id);

            // 渲染电源设备（过滤已放置的）
            const powerList = document.getElementById('powerDevicesList');
            const availablePower = availableDevices.power.filter(d => !placedDeviceIds.includes(d.id));
            powerList.innerHTML = availablePower.map(device => `
                <div class="device-item" draggable="true" ondragstart="startDragDevice(event, '${device.id}', 'power')">
                    <div class="device-item-icon">
                        <img src="${device.icon}" alt="${device.label}" style="width: 32px; height: 32px; object-fit: contain;" />
                    </div>
                    <div class="device-item-info">
                        <div class="device-item-name">${device.label}</div>
                    </div>
                </div>
            `).join('');

            // 渲染储能设备（过滤已放置的）
            const storageList = document.getElementById('storageDevicesList');
            const availableStorage = availableDevices.storage.filter(d => !placedDeviceIds.includes(d.id));
            storageList.innerHTML = availableStorage.map(device => `
                <div class="device-item" draggable="true" ondragstart="startDragDevice(event, '${device.id}', 'storage')">
                    <div class="device-item-icon">
                        <img src="${device.icon}" alt="${device.label}" style="width: 32px; height: 32px; object-fit: contain;" />
                    </div>
                    <div class="device-item-info">
                        <div class="device-item-name">${device.label}</div>
                    </div>
                </div>
            `).join('');

            // 渲染负载设备（过滤已放置的）
            const loadList = document.getElementById('loadDevicesList');
            const availableLoad = availableDevices.load.filter(d => !placedDeviceIds.includes(d.id));
            loadList.innerHTML = availableLoad.map(device => `
                <div class="device-item" draggable="true" ondragstart="startDragDevice(event, '${device.id}', 'load')">
                    <div class="device-item-icon">
                        <img src="${device.icon}" alt="${device.label}" style="width: 32px; height: 32px; object-fit: contain;" />
                    </div>
                    <div class="device-item-info">
                        <div class="device-item-name">${device.label}</div>
                    </div>
                </div>
            `).join('');
        }

        // 开始拖拽设备
        function startDragDevice(event, deviceId, category) {
            // 仅在编辑模式下允许拖拽
            if (!isEditMode) {
                event.preventDefault();
                return;
            }
            const device = availableDevices[category].find(d => d.id === deviceId);
            draggedDeviceData = { ...device, category };
            event.dataTransfer.effectAllowed = 'copy';
            event.dataTransfer.setData('text/plain', deviceId);
        }

        // 允许放置
        function allowDrop(event) {
            event.preventDefault();
            // 根据拖拽类型设置不同的 dropEffect
            if (isDraggingPlacedDevice) {
                event.dataTransfer.dropEffect = 'move';
            } else {
                event.dataTransfer.dropEffect = 'copy';
            }
        }

        // 放置设备（自由画布）
        function dropDevice(event) {
            event.preventDefault();

            // 仅在编辑模式下允许放置
            if (!isEditMode) {
                return;
            }

            const canvas = document.getElementById('devicesContainer');
            const canvasRect = canvas.getBoundingClientRect();

            // 计算放置位置（相对于画布）
            const x = event.clientX - canvasRect.left;
            const y = event.clientY - canvasRect.top;

            // 处理从设备列表拖来的新设备
            if (draggedDeviceData && !isDraggingPlacedDevice) {
                // 检查设备是否已经在画布上
                const alreadyPlaced = placedDevices.some(d => d.id === draggedDeviceData.id);
                if (alreadyPlaced) {
                    showMiniToast('⚠️ 该设备已在画布上', 'warning');
                    draggedDeviceData = null;
                    return;
                }

                // 添加到画布
                placedDevices.push({
                    ...draggedDeviceData,
                    x: Math.max(0, x - 60), // 居中放置，60是设备宽度的一半
                    y: Math.max(0, y - 60),
                    power: Math.random() * 100 + 50,
                    voltage: 380 + Math.random() * 20,
                    current: 100 + Math.random() * 50,
                    soc: 50 + Math.random() * 40,
                    displayParams: {
                        power: { enabled: false, x: 120, y: 0 },
                        voltage: { enabled: false, x: 120, y: 30 },
                        current: { enabled: false, x: 120, y: 60 },
                        soc: { enabled: false, x: 120, y: 90 }
                    },
                    flowControl: {
                        inAttribute: 'power',   // 默认使用功率判断流入
                        outAttribute: 'power'   // 默认使用功率判断流出
                    }
                });

                draggedDeviceData = null;

                // 重新渲染设备列表（移除已放置的设备）
                loadAvailableDevices();
            }
            // 处理画布内已放置设备的移动
            else if (draggedPlacedDevice && isDraggingPlacedDevice) {
                const { deviceId } = draggedPlacedDevice;

                // 查找设备并更新位置
                const device = placedDevices.find(d => d.id === deviceId);
                if (device) {
                    device.x = Math.max(0, x - 60);
                    device.y = Math.max(0, y - 60);
                }
            }

            renderPlacedDevices();
            drawAllConnections();
        }

        // 开始拖拽已放置的设备
        function startDragPlacedDevice(event, deviceId) {
            isDraggingPlacedDevice = true;
            draggedPlacedDevice = { deviceId };
            draggedDeviceData = null; // 确保清空新设备数据

            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', deviceId);

            // 设置拖拽时的透明度
            const deviceElement = document.getElementById(`placed-${deviceId}`);
            if (deviceElement) {
                deviceElement.style.opacity = '0.5';
            }
        }

        // 结束拖拽已放置的设备
        function endDragPlacedDevice(event) {
            // 恢复透明度
            event.target.style.opacity = '1';

            // 延迟清理，确保 drop 事件先执行
            setTimeout(() => {
                isDraggingPlacedDevice = false;
                draggedPlacedDevice = null;
            }, 100);
        }

        // 渲染已放置的设备（自由画布）
        function renderPlacedDevices() {
            const container = document.getElementById('devicesContainer');

            container.innerHTML = placedDevices.map(device => {
                // 设置设备位置
                const left = device.x || 50;
                const top = device.y || 50;

                // 外部参数 - 每个参数独立可拖拽
                let externalParams = '';
                if (device.displayParams) {
                    const paramsList = [];

                    // 功率参数
                    if (device.displayParams.power.enabled && device.power !== undefined) {
                        const pos = device.displayParams.power;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'power')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>P: ${device.power.toFixed(1)} kW</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'power\')">×</span>' : ''}
                            </div>
                        `);
                    }

                    // 电压参数
                    if (device.displayParams.voltage.enabled && device.voltage !== undefined) {
                        const pos = device.displayParams.voltage;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'voltage')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>U: ${device.voltage.toFixed(1)} V</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'voltage\')">×</span>' : ''}
                            </div>
                        `);
                    }

                    // 电流参数
                    if (device.displayParams.current.enabled && device.current !== undefined) {
                        const pos = device.displayParams.current;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'current')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>I: ${device.current.toFixed(1)} A</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'current\')">×</span>' : ''}
                            </div>
                        `);
                    }

                    // SOC参数
                    if (device.displayParams.soc.enabled && device.soc !== undefined) {
                        const pos = device.displayParams.soc;
                        paramsList.push(`
                            <div class="device-external-param"
                                 draggable="false"
                                 onmousedown="startParamDrag(event, '${device.id}', 'soc')"
                                 style="left: ${pos.x}px; top: ${pos.y}px;">
                                <span>SOC: ${device.soc.toFixed(1)} %</span>
                                ${isEditMode ? '<span class="param-delete-btn" onclick="deleteDeviceParam(event, \'' + device.id + '\', \'soc\')">×</span>' : ''}
                            </div>
                        `);
                    }

                    externalParams = paramsList.join('');
                }

                let html = `
                    <div class="flow-device"
                         id="placed-${device.id}"
                         draggable="${isEditMode}"
                         ondragstart="startDragPlacedDevice(event, '${device.id}')"
                         ondragend="endDragPlacedDevice(event)"
                         onmousedown="handleDeviceMouseDown(event, '${device.id}')"
                         data-device-id="${device.id}"
                         style="position: absolute; left: ${left}px; top: ${top}px; cursor: ${isEditMode ? 'pointer' : 'default'};">

                        <!-- 设备删除按钮（仅编辑模式显示） -->
                        ${isEditMode ? '<span class="device-delete-btn" onclick="deleteDevice(event, \'' + device.id + '\')">×</span>' : ''}

                        <!-- 连接点容器（仅编辑模式显示） -->
                        <div class="connection-points" style="display: ${isEditMode ? 'block' : 'none'};">
                            <div class="connection-point top" data-device-id="${device.id}" data-direction="top"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'top')"
                                 draggable="false"></div>
                            <div class="connection-point bottom" data-device-id="${device.id}" data-direction="bottom"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'bottom')"
                                 draggable="false"></div>
                            <div class="connection-point left" data-device-id="${device.id}" data-direction="left"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'left')"
                                 draggable="false"></div>
                            <div class="connection-point right" data-device-id="${device.id}" data-direction="right"
                                 onmousedown="startConnectionDrag(event, '${device.id}', 'right')"
                                 draggable="false"></div>
                        </div>

                        <div class="flow-device-icon">
                            <img src="${device.icon}" alt="${device.label}" draggable="false" />
                        </div>
                        <div class="flow-device-label" draggable="false">${device.label}</div>

                        ${externalParams}
                    </div>`;
                return html;
            }).join('');

            // 重新绑定点击事件（仅在连线模式下生效）
            attachDeviceClickListeners();

            // 重新绘制连接线（应用流向动画）
            drawAllConnections();
        }

        // 绑定设备点击事件监听器
        function attachDeviceClickListeners() {
            const devices = document.querySelectorAll('.flow-device');
            devices.forEach(deviceEl => {
                deviceEl.addEventListener('click', function(e) {
                    // 如果点击的是移除按钮或连接点，不处理
                    if (e.target.tagName === 'BUTTON' || e.target.classList.contains('connection-point')) {
                        return;
                    }

                    // 如果刚刚完成拖拽，忽略点击
                    if (isDraggingPlacedDevice) {
                        return;
                    }

                    const deviceId = this.getAttribute('data-device-id');
                    const event = window.event || e;

                    // 在预览模式下打开设备详情面板
                    if (!isEditMode) {
                        openDevicePanel(deviceId);
                        return;
                    }

                    // 在编辑模式下切换设备选中状态
                    toggleDeviceSelection(deviceId, event);
                });
            });
        }

        // 切换设备选中状态（支持Shift多选）
        function toggleDeviceSelection(deviceId, event) {
            const element = document.getElementById(`placed-${deviceId}`);
            if (!element) return;

            // 检查是否按住了 Shift 键
            const isMultiSelect = event && event.shiftKey;

            if (isMultiSelect) {
                // 多选模式：切换当前设备的选中状态
                if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                } else {
                    element.classList.add('selected');
                }
            } else {
                // 单选模式：清除其他设备的选中，只选中当前设备
                const allDevices = document.querySelectorAll('.flow-device');
                allDevices.forEach(dev => {
                    if (dev.id !== `placed-${deviceId}`) {
                        dev.classList.remove('selected');
                    }
                });

                // 切换当前设备
                if (element.classList.contains('selected')) {
                    element.classList.remove('selected');
                    selectedDevice = null;
                } else {
                    element.classList.add('selected');
                    selectedDevice = deviceId;
                }
            }

            // 显示提示
            const selectedCount = document.querySelectorAll('.flow-device.selected').length;
            if (selectedCount > 1) {
                showMiniToast(`✅ 已选中 ${selectedCount} 个设备`);
            }
        }

        // 开始拖拽连线
        function startConnectionDrag(event, deviceId, direction) {
            event.stopPropagation();
            event.preventDefault();

            // 仅在编辑模式下允许连线
            if (!isEditMode) {
                return;
            }

            isDraggingConnection = true;

            // 获取连接点的绝对位置
            const pointElement = event.target;
            const pointRect = pointElement.getBoundingClientRect();
            const canvas = document.getElementById('energyFlowCanvas');
            const canvasRect = canvas.getBoundingClientRect();

            const x = pointRect.left + pointRect.width / 2 - canvasRect.left;
            const y = pointRect.top + pointRect.height / 2 - canvasRect.top;

            connectionStart = { deviceId, direction, x, y };

            // 选中起始设备
            const element = document.getElementById(`placed-${deviceId}`);
            if (element) {
                element.classList.add('selected');
                selectedDevice = deviceId;
            }

            // 创建临时连线
            createTempConnectionLine(x, y, x, y);
        }

        // 创建临时连线
        function createTempConnectionLine(x1, y1, x2, y2) {
            const svg = document.getElementById('energyConnections');

            // 移除旧的临时线
            if (tempConnectionLine) {
                tempConnectionLine.remove();
            }

            // 创建新的临时线
            tempConnectionLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const pathData = `M ${x1} ${y1} L ${x2} ${y2}`;
            tempConnectionLine.setAttribute('d', pathData);
            tempConnectionLine.setAttribute('stroke', '#3562E3');
            tempConnectionLine.setAttribute('stroke-width', '3');
            tempConnectionLine.setAttribute('stroke-dasharray', '8 4');
            tempConnectionLine.setAttribute('fill', 'none');
            tempConnectionLine.style.opacity = '0.7';

            svg.appendChild(tempConnectionLine);
        }

        // 更新临时连线
        function updateTempConnectionLine(x2, y2) {
            if (!tempConnectionLine || !connectionStart) return;

            const pathData = `M ${connectionStart.x} ${connectionStart.y} L ${x2} ${y2}`;
            tempConnectionLine.setAttribute('d', pathData);
        }

        // 完成连线拖拽
        function endConnectionDrag(event) {
            if (!isDraggingConnection || !connectionStart) {
                return;
            }

            // 检查鼠标是否在某个连接点上
            const target = document.elementFromPoint(event.clientX, event.clientY);

            if (target && target.classList.contains('connection-point')) {
                const toDeviceId = target.getAttribute('data-device-id');
                const toDirection = target.getAttribute('data-direction');

                // 不能连接到同一个设备
                if (toDeviceId !== connectionStart.deviceId) {
                    const fromDevice = placedDevices.find(d => d.id === connectionStart.deviceId);
                    const toDevice = placedDevices.find(d => d.id === toDeviceId);

                    // 添加连接（不自动创建控制点，使用智能路径）
                    deviceConnections.push({
                        from: connectionStart.deviceId,
                        fromDirection: connectionStart.direction,
                        to: toDeviceId,
                        toDirection: toDirection,
                        controlPoints: [], // 空数组，使用智能路径
                        pathMode: 'orthogonal' // 默认使用正交模式
                    });

                    drawAllConnections();
                    showMiniToast(`✅ 连接成功！<br>${fromDevice.label} ➡️ ${toDevice.label}`);
                }
            }

            // 清理状态
            isDraggingConnection = false;
            connectionStart = null;

            // 移除临时线
            if (tempConnectionLine) {
                tempConnectionLine.remove();
                tempConnectionLine = null;
            }

            // 清除选中状态
            if (selectedDevice) {
                const element = document.getElementById(`placed-${selectedDevice}`);
                if (element) {
                    element.classList.remove('selected');
                }
                selectedDevice = null;
            }
        }

        // 获取方向名称（中文）
        function getDirectionName(direction) {
            const names = {
                'top': '上',
                'bottom': '下',
                'left': '左',
                'right': '右'
            };
            return names[direction] || direction;
        }

        // 显示小型提示消息
        function showMiniToast(message, type = 'info') {
            // 移除旧提示
            const oldToast = document.getElementById('miniToast');
            if (oldToast) oldToast.remove();

            // 根据类型选择样式
            let bgColor, iconSymbol;
            if (type === 'success') {
                bgColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                iconSymbol = '✓';
            } else if (type === 'warning') {
                bgColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
                iconSymbol = '⚠';
            } else if (type === 'error') {
                bgColor = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                iconSymbol = '✗';
            } else {
                bgColor = 'linear-gradient(135deg, #00d9ff 0%, #0099cc 100%)';
                iconSymbol = 'ℹ';
            }

            const toast = document.createElement('div');
            toast.id = 'miniToast';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: ${bgColor};
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                z-index: 99999;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                text-align: center;
                pointer-events: none;
                animation: slideDown 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            `;

            toast.innerHTML = `
                <span style="font-size: 18px; font-weight: bold;">${iconSymbol}</span>
                <span>${message}</span>
            `;

            // 添加滑入动画
            if (!document.getElementById('toastAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'toastAnimationStyle';
                style.textContent = `
                    @keyframes slideDown {
                        from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                        to { opacity: 1; transform: translateX(-50%) translateY(0); }
                    }
                `;
                document.head.appendChild(style);
            }

            // 添加到 body 而不是 canvas，确保可见
            document.body.appendChild(toast);

            // 2秒后自动消失
            setTimeout(() => {
                if (toast && toast.parentNode) {
                    toast.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(-20px)';
                    setTimeout(() => {
                        if (toast && toast.parentNode) toast.remove();
                    }, 300);
                }
            }, 2000);
        }

        // 移除设备
        function removeDevice(deviceId, event) {
            event.stopPropagation();

            if (!confirm('确定要移除该设备吗？')) {
                return;
            }

            // 从画布移除设备
            placedDevices = placedDevices.filter(d => d.id !== deviceId);

            // 移除涉及该设备的所有连接
            deviceConnections = deviceConnections.filter(
                conn => conn.from !== deviceId && conn.to !== deviceId
            );

            renderPlacedDevices();
            drawAllConnections();
            loadAvailableDevices(); // 刷新设备列表，使移除的设备重新显示
        }

        // 绘制所有连接线（支持拐弯，自由画布）
        function drawAllConnections() {
            const svg = document.getElementById('energyConnections');
            svg.innerHTML = '';

            const canvasRect = document.getElementById('energyFlowCanvas').getBoundingClientRect();

            // 在绘制前，检查并修复市电到储能柜的连线
            deviceConnections.forEach((conn, index) => {
                const fromId = conn.from.toLowerCase();
                const toId = conn.to.toLowerCase();

                const isUtilityToStorage =
                    (fromId.includes('grid-1') || fromId.includes('utility') || fromId.includes('市电')) &&
                    (toId.includes('storage') || toId.includes('储能') || toId.includes('battery'));

                const isStorageToUtility =
                    (fromId.includes('storage') || fromId.includes('储能') || fromId.includes('battery')) &&
                    (toId.includes('grid-1') || toId.includes('utility') || toId.includes('市电'));

                // 如果是市电和储能柜之间的连线，且没有控制点
                if ((isUtilityToStorage || isStorageToUtility) && (!conn.controlPoints || conn.controlPoints.length === 0)) {
                    const fromDevice = placedDevices.find(d => d.id === conn.from);
                    const toDevice = placedDevices.find(d => d.id === conn.to);

                    if (fromDevice && toDevice) {
                        // 添加一个拐点
                        const fromX = fromDevice.x + 70;
                        const fromY = fromDevice.y + 75;
                        const toX = toDevice.x + 70;
                        const toY = toDevice.y + 75;

                        const cornerY = (fromY + toY) / 2;

                        conn.controlPoints = [{ x: fromX, y: cornerY }];
                        conn.fromDirection = 'bottom';
                        conn.toDirection = 'top';

                        console.log('✅ 自动修复市电-储能柜连线，添加拐点:', conn.controlPoints);
                    }
                }
            });

            // 移除箭头标记定义 - 用户不需要箭头
            // const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
            // const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
            // marker.id = 'arrowhead';
            // marker.setAttribute('markerWidth', '10');
            // marker.setAttribute('markerHeight', '10');
            // marker.setAttribute('refX', '9');
            // marker.setAttribute('refY', '3');
            // marker.setAttribute('orient', 'auto');

            // const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            // polygon.setAttribute('points', '0 0, 10 3, 0 6');
            // polygon.setAttribute('fill', '#3562E3');
            // marker.appendChild(polygon);
            // defs.appendChild(marker);
            // svg.appendChild(defs);

            // 绘制每条连接
            deviceConnections.forEach((conn, index) => {
                const fromElement = document.getElementById(`placed-${conn.from}`);
                const toElement = document.getElementById(`placed-${conn.to}`);

                if (fromElement && toElement) {
                    const fromRect = fromElement.getBoundingClientRect();
                    const toRect = toElement.getBoundingClientRect();

                    // 计算起点和终点连接点的位置
                    const fromPoint = getConnectionPointPosition(fromRect, conn.fromDirection, canvasRect);
                    const toPoint = getConnectionPointPosition(toRect, conn.toDirection, canvasRect);

                    // 计算路径（使用控制点或自动计算）
                    let pathData;
                    // 默认使用正交模式，可以通过 conn.pathMode 修改
                    const useOrthogonal = conn.pathMode !== 'straight'; // 默认为正交模式，除非明确设置为直线

                    if (conn.controlPoints && conn.controlPoints.length > 0) {
                        // 使用自定义控制点路径
                        pathData = calculatePathWithControlPoints(fromPoint.x, fromPoint.y, toPoint.x, toPoint.y, conn.controlPoints, useOrthogonal);
                    } else {
                        // 使用智能拐弯路径
                        pathData = calculateOrthogonalPath(fromPoint.x, fromPoint.y, toPoint.x, toPoint.y);
                    }

                    // 创建宽的透明路径作为点击区域（放在下层）
                    const hitArea = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    hitArea.setAttribute('d', pathData);
                    hitArea.setAttribute('stroke', 'transparent');
                    hitArea.setAttribute('stroke-width', '20'); // 更宽的点击区域
                    hitArea.setAttribute('fill', 'none');
                    hitArea.style.cursor = isEditMode ? 'pointer' : 'default'; // 编辑模式才显示手型
                    hitArea.style.pointerEvents = 'stroke'; // 允许hitArea接收鼠标事件
                    hitArea.setAttribute('data-connection-index', index);

                    // 添加悬停效果（仅在编辑模式下）
                    hitArea.addEventListener('mouseenter', () => {
                        if (isEditMode && selectedConnection !== index) {
                            path.setAttribute('stroke', '#00e5ff');
                            path.setAttribute('stroke-width', '4');
                        }
                    });

                    hitArea.addEventListener('mouseleave', () => {
                        if (isEditMode && selectedConnection !== index) {
                            path.setAttribute('stroke', '#3562E3');
                            path.setAttribute('stroke-width', '3');
                        }
                    });

                    // 添加点击选中功能（仅在编辑模式下）
                    hitArea.addEventListener('click', (e) => {
                        if (!isEditMode) return; // 预览模式下不响应点击
                        e.stopPropagation();
                        selectConnection(index);
                    });

                    // 添加右键菜单（仅在编辑模式下）
                    hitArea.addEventListener('contextmenu', (e) => {
                        if (!isEditMode) return; // 预览模式下不显示右键菜单
                        e.preventDefault();
                        e.stopPropagation();
                        showConnectionContextMenu(e, index);
                    });

                    svg.appendChild(hitArea);

                    // 创建可见的路径元素（显示在上层）
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);

                    // 根据模式设置颜色
                    if (selectedConnection === index) {
                        // 选中状态：橙色
                        path.setAttribute('stroke', '#ffaa00');
                        path.setAttribute('stroke-width', '4');
                        path.style.filter = 'drop-shadow(0 0 8px rgba(255, 170, 0, 0.8))';
                    } else if (isEditMode) {
                        // 编辑模式：蓝色
                        path.setAttribute('stroke', '#3562E3');
                        path.setAttribute('stroke-width', '3');
                        path.style.filter = 'drop-shadow(0 0 4px rgba(53, 98, 227, 0.6))';
                    } else {
                        // 预览模式：灰色
                        path.setAttribute('stroke', '#CCCCCC');
                        path.setAttribute('stroke-width', '4');
                    }

                    path.setAttribute('stroke-linecap', 'round');
                    path.setAttribute('stroke-linejoin', 'round');
                    path.setAttribute('fill', 'none');
                    path.style.pointerEvents = 'none'; // 不接收事件，事件由hitArea处理

                    svg.appendChild(path);

                    // 在预览模式下添加流动线段效果（仿照首页）
                    if (!isEditMode && selectedConnection !== index) {
                        // 检查是否是市电到光伏/储能柜的连线
                        const fromId = conn.from.toLowerCase();
                        const toId = conn.to.toLowerCase();

                        const isGridToSolar =
                            (fromId.includes('grid') || fromId.includes('utility') || fromId.includes('市电')) &&
                            (toId.includes('solar') || toId.includes('pv') || toId.includes('光伏'));

                        const isSolarToGrid =
                            (fromId.includes('solar') || fromId.includes('pv') || fromId.includes('光伏')) &&
                            (toId.includes('grid') || toId.includes('utility') || toId.includes('市电'));

                        const isGridToStorage =
                            (fromId.includes('grid') || fromId.includes('utility') || fromId.includes('市电')) &&
                            (toId.includes('storage') || toId.includes('储能') || toId.includes('battery') || toId.includes('pcs'));

                        const isStorageToGrid =
                            (fromId.includes('storage') || fromId.includes('储能') || fromId.includes('battery') || fromId.includes('pcs')) &&
                            (toId.includes('grid') || toId.includes('utility') || toId.includes('市电'));

                        // 如果是市电到光伏或储能柜的连线，跳过添加动画
                        if (isGridToSolar || isSolarToGrid || isGridToStorage || isStorageToGrid) {
                            // 不添加流动动画
                        } else {
                            // 创建隐藏的路径用于动画
                            const animPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                            const pathId = `flow-path-${index}`;
                            animPath.setAttribute('id', pathId);
                            animPath.setAttribute('d', pathData);
                            animPath.style.display = 'none';
                            svg.appendChild(animPath);

                            // 创建流动的短线段（蓝色）
                            const flowingLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            flowingLine.setAttribute('x1', '-20');
                            flowingLine.setAttribute('y1', '0');
                            flowingLine.setAttribute('x2', '20');
                            flowingLine.setAttribute('y2', '0');
                            flowingLine.setAttribute('stroke', '#3562E3');
                            flowingLine.setAttribute('stroke-width', '5');
                            flowingLine.setAttribute('stroke-linecap', 'round');
                            flowingLine.setAttribute('opacity', '1');
                            flowingLine.style.pointerEvents = 'none';
                            flowingLine.style.filter = 'drop-shadow(0 0 6px rgba(53, 98, 227, 0.8))';

                            // 添加沿路径运动的动画（自动旋转跟随路径方向）
                            const animateMotion = document.createElementNS('http://www.w3.org/2000/svg', 'animateMotion');
                            animateMotion.setAttribute('dur', '2s');
                            animateMotion.setAttribute('repeatCount', 'indefinite');
                            animateMotion.setAttribute('rotate', 'auto'); // 自动旋转，沿路径方向

                            const mpath = document.createElementNS('http://www.w3.org/2000/svg', 'mpath');
                            mpath.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', `#${pathId}`);

                            animateMotion.appendChild(mpath);
                            flowingLine.appendChild(animateMotion);
                            svg.appendChild(flowingLine);
                        }
                    }

                    // 如果连线被选中，绘制控制点
                    if (selectedConnection === index) {
                        drawControlPoints(conn, index, fromPoint, toPoint, canvasRect);
                    }
                }
            });
        }

        // 根据连接点方向计算其在画布上的绝对位置
        function getConnectionPointPosition(deviceRect, direction, canvasRect) {
            const centerX = deviceRect.left + deviceRect.width / 2 - canvasRect.left;
            const centerY = deviceRect.top + deviceRect.height / 2 - canvasRect.top;

            switch (direction) {
                case 'top':
                    return { x: centerX, y: deviceRect.top - canvasRect.top };
                case 'bottom':
                    return { x: centerX, y: deviceRect.bottom - canvasRect.top };
                case 'left':
                    return { x: deviceRect.left - canvasRect.left, y: centerY };
                case 'right':
                    return { x: deviceRect.right - canvasRect.left, y: centerY };
                default:
                    return { x: centerX, y: centerY };
            }
        }

        // 计算正交路径（支持直角拐弯）
        function calculateOrthogonalPath(x1, y1, x2, y2) {
            const gap = 30; // 拐弯间距

            // 计算水平和垂直距离
            const dx = x2 - x1;
            const dy = y2 - y1;

            // 如果两点很近，直接连线
            if (Math.abs(dx) < 10 && Math.abs(dy) < 10) {
                return `M ${x1} ${y1} L ${x2} ${y2}`;
            }

            // 如果水平距离足够，使用简单的三段式路径
            if (Math.abs(dx) > gap * 2) {
                const midX = (x1 + x2) / 2;
                return `M ${x1} ${y1}
                        L ${midX} ${y1}
                        L ${midX} ${y2}
                        L ${x2} ${y2}`;
            }
            // 如果垂直距离足够，使用简单的三段式路径
            else if (Math.abs(dy) > gap * 2) {
                const midY = (y1 + y2) / 2;
                return `M ${x1} ${y1}
                        L ${x1} ${midY}
                        L ${x2} ${midY}
                        L ${x2} ${y2}`;
            }
            // 否则使用五段式绕行路径
            else {
                const direction = dx > 0 ? 1 : -1;
                const offsetX = gap;
                const midY = (y1 + y2) / 2;

                return `M ${x1} ${y1}
                        L ${x1} ${y1 + gap}
                        L ${x1 + direction * offsetX} ${y1 + gap}
                        L ${x1 + direction * offsetX} ${y2 - gap}
                        L ${x2} ${y2 - gap}
                        L ${x2} ${y2}`;
            }
        }

        // 计算贝塞尔曲线路径（可选的平滑拐弯）
        function calculateSmoothPath(x1, y1, x2, y2) {
            const midY = (y1 + y2) / 2;
            const controlOffset = 40;

            // 使用三次贝塞尔曲线创建平滑路径
            return `M ${x1} ${y1}
                    C ${x1} ${y1 + controlOffset},
                      ${x1} ${midY - controlOffset},
                      ${x1} ${midY}
                    L ${x2} ${midY}
                    C ${x2} ${midY + controlOffset},
                      ${x2} ${y2 - controlOffset},
                      ${x2} ${y2}`;
        }

        // 根据控制点计算路径（支持正交模式）
        function calculatePathWithControlPoints(x1, y1, x2, y2, controlPoints, orthogonal = true) {
            if (!controlPoints || controlPoints.length === 0) {
                return calculateOrthogonalPath(x1, y1, x2, y2);
            }

            let path = `M ${x1} ${y1}`;

            // 如果使用正交模式，在每两个点之间创建90度拐弯
            if (orthogonal) {
                let prevX = x1;
                let prevY = y1;

                controlPoints.forEach(point => {
                    // 在两点之间创建L形路径（先水平后垂直，或先垂直后水平）
                    const dx = Math.abs(point.x - prevX);
                    const dy = Math.abs(point.y - prevY);

                    // 根据距离决定是先走水平还是先走垂直
                    if (dx > dy) {
                        // 先水平后垂直
                        path += ` L ${point.x} ${prevY}`;
                        path += ` L ${point.x} ${point.y}`;
                    } else {
                        // 先垂直后水平
                        path += ` L ${prevX} ${point.y}`;
                        path += ` L ${point.x} ${point.y}`;
                    }

                    prevX = point.x;
                    prevY = point.y;
                });

                // 从最后一个控制点到终点，也使用正交路径
                const dx = Math.abs(x2 - prevX);
                const dy = Math.abs(y2 - prevY);

                if (dx > dy) {
                    path += ` L ${x2} ${prevY}`;
                    path += ` L ${x2} ${y2}`;
                } else {
                    path += ` L ${prevX} ${y2}`;
                    path += ` L ${x2} ${y2}`;
                }
            } else {
                // 直线模式：直接连接所有控制点
                controlPoints.forEach(point => {
                    path += ` L ${point.x} ${point.y}`;
                });
                path += ` L ${x2} ${y2}`;
            }

            return path;
        }

        // 选中连线
        function selectConnection(index) {
            selectedConnection = index;

            // 不自动创建控制点，保持原有路径
            // 用户可以通过右键菜单"添加控制点"来手动添加

            drawAllConnections();

            const hasControlPoints = deviceConnections[index].controlPoints &&
                                    deviceConnections[index].controlPoints.length > 0;

            if (hasControlPoints) {
                showMiniToast('✏️ 连线已选中，拖拽控制点调整路径');
            } else {
                showMiniToast('✏️ 连线已选中，右键可添加控制点');
            }
        }

        // 绘制控制点
        function drawControlPoints(conn, connIndex, fromPoint, toPoint, canvasRect) {
            const svg = document.getElementById('energyConnections');

            if (!conn.controlPoints) return;

            conn.controlPoints.forEach((point, pointIndex) => {
                // 创建控制点圆圈
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', point.x);
                circle.setAttribute('cy', point.y);
                circle.setAttribute('r', '8');
                circle.setAttribute('fill', '#ffaa00');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', '2');
                circle.style.cursor = 'move';
                circle.style.pointerEvents = 'all'; // 允许控制点接收鼠标事件
                circle.style.filter = 'drop-shadow(0 0 6px rgba(255, 170, 0, 0.8))';

                // 添加控制点拖拽事件
                circle.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    startDraggingControlPoint(connIndex, pointIndex, e);
                });

                svg.appendChild(circle);

                // 添加控制点文本提示
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', point.x);
                text.setAttribute('y', point.y - 15);
                text.setAttribute('fill', '#ffaa00');
                text.setAttribute('font-size', '11');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = '●';
                text.style.pointerEvents = 'none';
                text.style.userSelect = 'none';

                svg.appendChild(text);
            });

            // 添加新增控制点按钮（在连线中点）
            if (conn.controlPoints.length < 5) {
                const midX = (fromPoint.x + toPoint.x) / 2;
                const midY = (fromPoint.y + toPoint.y) / 2;

                const addButton = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                addButton.setAttribute('cx', midX);
                addButton.setAttribute('cy', midY);
                addButton.setAttribute('r', '6');
                addButton.setAttribute('fill', '#22c55e');
                addButton.setAttribute('stroke', '#fff');
                addButton.setAttribute('stroke-width', '2');
                addButton.style.cursor = 'pointer';
                addButton.style.pointerEvents = 'all'; // 允许添加按钮接收鼠标事件
                addButton.style.opacity = '0.7';

                addButton.addEventListener('mouseenter', () => {
                    addButton.style.opacity = '1';
                });

                addButton.addEventListener('mouseleave', () => {
                    addButton.style.opacity = '0.7';
                });

                addButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    addControlPoint(connIndex, midX, midY);
                });

                svg.appendChild(addButton);

                const plusText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                plusText.setAttribute('x', midX);
                plusText.setAttribute('y', midY + 1);
                plusText.setAttribute('fill', '#fff');
                plusText.setAttribute('font-size', '10');
                plusText.setAttribute('font-weight', 'bold');
                plusText.setAttribute('text-anchor', 'middle');
                plusText.setAttribute('dominant-baseline', 'middle');
                plusText.textContent = '+';
                plusText.style.pointerEvents = 'none';

                svg.appendChild(plusText);
            }
        }

        // 开始拖拽控制点
        function startDraggingControlPoint(connIndex, pointIndex, event) {
            isDraggingControlPoint = true;
            selectedConnection = connIndex;
            draggingControlPointIndex = pointIndex;

            document.body.style.cursor = 'move';
        }

        // 添加控制点
        function addControlPoint(connIndex, x, y) {
            if (!deviceConnections[connIndex].controlPoints) {
                deviceConnections[connIndex].controlPoints = [];
            }

            deviceConnections[connIndex].controlPoints.push({ x, y });
            drawAllConnections();
            showMiniToast('➕ 已添加控制点');
        }

        // 显示连线右键菜单
        function showConnectionContextMenu(event, connIndex) {
            // 移除旧菜单
            const oldMenu = document.getElementById('connectionContextMenu');
            if (oldMenu) oldMenu.remove();

            const menu = document.createElement('div');
            menu.id = 'connectionContextMenu';
            menu.style.cssText = `
                position: fixed;
                left: ${event.clientX}px;
                top: ${event.clientY}px;
                background: #2a2a2a;
                border: 1px solid #3a3a3a;
                border-radius: 8px;
                padding: 8px 0;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
                min-width: 160px;
            `;

            // 获取当前路径模式
            const currentMode = deviceConnections[connIndex].pathMode || 'orthogonal';
            const isOrthogonal = currentMode !== 'straight';

            const menuItems = [
                {
                    icon: isOrthogonal ? '📐' : '📏',
                    text: isOrthogonal ? '切换为直线模式' : '切换为正交模式',
                    action: () => {
                        // 切换路径模式
                        deviceConnections[connIndex].pathMode = isOrthogonal ? 'straight' : 'orthogonal';
                        drawAllConnections();
                        showMiniToast(isOrthogonal ? '📏 已切换为直线模式' : '📐 已切换为正交模式（90度拐弯）');
                        menu.remove();
                    }
                },
                {
                    icon: '🔄',
                    text: '重置路径',
                    action: () => {
                        resetConnectionPath(connIndex);
                        menu.remove();
                    }
                },
                {
                    icon: '➕',
                    text: '添加控制点',
                    action: () => {
                        selectConnection(connIndex);
                        menu.remove();
                    }
                },
                {
                    icon: '🗑️',
                    text: '删除连线',
                    action: () => {
                        if (confirm('确定要删除这条连线吗？')) {
                            deviceConnections.splice(connIndex, 1);
                            selectedConnection = null;
                            drawAllConnections();
                            showMiniToast('✅ 已删除连线');
                        }
                        menu.remove();
                    }
                }
            ];

            menuItems.forEach(item => {
                const menuItem = document.createElement('div');
                menuItem.style.cssText = `
                    padding: 10px 16px;
                    cursor: pointer;
                    transition: background 0.2s;
                    color: #e2e8f0;
                    font-size: 14px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                `;

                menuItem.innerHTML = `<span>${item.icon}</span><span>${item.text}</span>`;

                menuItem.addEventListener('mouseenter', () => {
                    menuItem.style.background = '#3a3a3a';
                });

                menuItem.addEventListener('mouseleave', () => {
                    menuItem.style.background = 'transparent';
                });

                menuItem.addEventListener('click', item.action);

                menu.appendChild(menuItem);
            });

            document.body.appendChild(menu);

            // 点击其他地方关闭菜单
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 0);
        }

        // 重置连线路径
        function resetConnectionPath(connIndex) {
            deviceConnections[connIndex].controlPoints = [];
            selectedConnection = null;
            drawAllConnections();
            showMiniToast('🔄 路径已重置');
        }

        // 显示连线编辑帮助
        function showConnectionEditHelp() {
            // 移除旧的帮助窗口
            const oldHelp = document.getElementById('connectionEditHelp');
            if (oldHelp) oldHelp.remove();

            const helpModal = document.createElement('div');
            helpModal.id = 'connectionEditHelp';
            helpModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease;
            `;

            helpModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
                    border: 2px solid #3562E3;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 600px;
                    box-shadow: 0 8px 32px rgba(53, 98, 227, 0.3);
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2 style="margin: 0; color: #3562E3; font-size: 24px;">
                            <i class="fas fa-edit"></i> 连线编辑指南
                        </h2>
                        <button onclick="document.getElementById('connectionEditHelp').remove()" style="
                            background: transparent;
                            border: none;
                            color: #3562E3;
                            font-size: 24px;
                            cursor: pointer;
                            padding: 0;
                            width: 32px;
                            height: 32px;
                            border-radius: 50%;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(53, 98, 227, 0.1)'" onmouseout="this.style.background='transparent'">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div style="color: #e2e8f0; line-height: 1.8; font-size: 14px;">
                        <div style="background: rgba(53, 98, 227, 0.1); border-left: 4px solid #3562E3; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <p style="margin: 0 0 12px 0; font-weight: 600; font-size: 16px; color: #3562E3;">
                                💡 如何自定义连线路径
                            </p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 12px;">
                                    <strong>鼠标悬停</strong>在连线上 → 连线会<span style="color: #00e5ff;">高亮变亮</span>
                                </li>
                                <li style="margin-bottom: 12px;">
                                    <strong>点击连线</strong> → 连线变为<span style="color: #ffaa00;">橙色</span>，自动显示控制点
                                </li>
                                <li style="margin-bottom: 12px;">
                                    <strong>拖拽橙色圆点</strong> → 实时调整连线路径
                                </li>
                                <li style="margin-bottom: 12px;">
                                    <strong>点击绿色➕</strong> → 添加更多控制点（最多5个）
                                </li>
                                <li>
                                    <strong>右键连线</strong> → 重置路径 / 删除连线
                                </li>
                            </ol>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
                            <div style="background: rgba(255, 170, 0, 0.1); border: 1px solid #ffaa00; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;">🟠</div>
                                <div style="font-weight: 600; color: #ffaa00; margin-bottom: 4px;">控制点</div>
                                <div style="font-size: 12px; color: #cbd5e1;">拖拽调整路径</div>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 28px; margin-bottom: 8px;">🟢</div>
                                <div style="font-weight: 600; color: #22c55e; margin-bottom: 4px;">添加按钮</div>
                                <div style="font-size: 12px; color: #cbd5e1;">点击添加控制点</div>
                            </div>
                        </div>

                        <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid #ef4444; padding: 12px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 13px;">
                                <strong>⚠️ 提示：</strong>点击画布空白处可取消选中连线
                            </p>
                        </div>
                    </div>

                    <div style="margin-top: 24px; text-align: center;">
                        <button onclick="document.getElementById('connectionEditHelp').remove()" style="
                            background: linear-gradient(135deg, #3562E3 0%, #2347C5 100%);
                            border: none;
                            color: #fff;
                            padding: 12px 32px;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,217,255,0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                            我知道了
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(helpModal);

            // 点击背景关闭
            helpModal.addEventListener('click', (e) => {
                if (e.target === helpModal) {
                    helpModal.remove();
                }
            });
        }

        // 清除所有连线
        function clearAllConnections() {
            if (deviceConnections.length === 0) {
                showMiniToast('⚠️ 当前没有连线');
                return;
            }

            if (confirm('确定要清除所有连线吗？')) {
                deviceConnections = [];
                drawAllConnections();
                showMiniToast('✅ 已清除所有连线');
            }
        }

        // 显示连线使用提示
        function showConnectionHint() {
            // 移除旧提示
            const oldHint = document.getElementById('connectionHint');
            if (oldHint) oldHint.remove();

            const hint = document.createElement('div');
            hint.id = 'connectionHint';
            hint.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 217, 255, 0.95);
                color: #000;
                padding: 24px 32px;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 600;
                z-index: 200;
                box-shadow: 0 8px 32px rgba(0, 217, 255, 0.5);
                text-align: center;
                pointer-events: none;
                animation: fadeIn 0.3s ease;
            `;
            hint.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 12px;">🔗 连线模式已开启</div>
                <div style="font-size: 14px; font-weight: normal; line-height: 1.6;">
                    1️⃣ 点击第一个设备（起点）<br>
                    2️⃣ 点击第二个设备（终点）<br>
                    3️⃣ 自动创建连接线<br>
                    <br>
                    <span style="color: #1a1a1a;">💡 点击工具栏按钮关闭连线模式</span>
                </div>
            `;

            // 添加淡入动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                    to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
                }
            `;
            document.head.appendChild(style);

            document.getElementById('energyFlowCanvas').appendChild(hint);

            // 3秒后自动淡出
            setTimeout(() => {
                if (hint && hint.parentNode) {
                    hint.style.transition = 'opacity 0.5s ease';
                    hint.style.opacity = '0';
                    setTimeout(() => {
                        if (hint && hint.parentNode) hint.remove();
                    }, 500);
                }
            }, 3000);
        }

        // 隐藏连线提示
        function hideConnectionHint() {
            const hint = document.getElementById('connectionHint');
            if (hint) {
                hint.style.transition = 'opacity 0.3s ease';
                hint.style.opacity = '0';
                setTimeout(() => {
                    if (hint && hint.parentNode) hint.remove();
                }, 300);
            }
        }

        // 清空所有设备
        function clearAllDevices() {
            if (!confirm('确定要清空所有设备和连接吗？此操作无法撤销！')) {
                return;
            }

            placedDevices = [];
            deviceConnections = [];
            connectionStart = null;

            renderPlacedDevices();
            drawAllConnections();
        }

        // 水平对齐选中的设备
        function alignDevicesHorizontal() {
            if (!isEditMode) {
                showMiniToast('⚠️ 请先进入编辑模式');
                return;
            }

            const selectedDevices = document.querySelectorAll('.flow-device.selected');
            if (selectedDevices.length < 2) {
                showMiniToast('⚠️ 请先选中至少2个设备（按住Ctrl/Cmd点击多选）');
                return;
            }

            // 获取所有选中设备的Y坐标，计算平均值
            const deviceIds = Array.from(selectedDevices).map(el => el.dataset.deviceId);
            const devices = placedDevices.filter(d => deviceIds.includes(d.id));

            const avgY = devices.reduce((sum, d) => sum + (d.y || 0), 0) / devices.length;

            // 将所有设备的Y坐标设置为平均值
            devices.forEach(device => {
                device.y = Math.round(avgY);
            });

            // 重新渲染
            renderPlacedDevices();
            drawAllConnections();

            showMiniToast(`✅ 已水平对齐 ${devices.length} 个设备`);
        }

        // 垂直对齐选中的设备
        function alignDevicesVertical() {
            if (!isEditMode) {
                showMiniToast('⚠️ 请先进入编辑模式');
                return;
            }

            const selectedDevices = document.querySelectorAll('.flow-device.selected');
            if (selectedDevices.length < 2) {
                showMiniToast('⚠️ 请先选中至少2个设备（按住Ctrl/Cmd点击多选）');
                return;
            }

            // 获取所有选中设备的X坐标，计算平均值
            const deviceIds = Array.from(selectedDevices).map(el => el.dataset.deviceId);
            const devices = placedDevices.filter(d => deviceIds.includes(d.id));

            const avgX = devices.reduce((sum, d) => sum + (d.x || 0), 0) / devices.length;

            // 将所有设备的X坐标设置为平均值
            devices.forEach(device => {
                device.x = Math.round(avgX);
            });

            // 重新渲染
            renderPlacedDevices();
            drawAllConnections();

            showMiniToast(`✅ 已垂直对齐 ${devices.length} 个设备`);
        }

        // 连线拉直（转为直线模式）
        function straightenConnections() {
            if (!isEditMode) {
                showMiniToast('⚠️ 请先进入编辑模式');
                return;
            }

            if (deviceConnections.length === 0) {
                showMiniToast('⚠️ 没有连线可以拉直');
                return;
            }

            // 将所有连线转为直线模式
            let changedCount = 0;
            deviceConnections.forEach(conn => {
                if (conn.pathMode !== 'straight' ||
                    (conn.controlPoints && conn.controlPoints.length > 0)) {
                    conn.pathMode = 'straight';
                    conn.controlPoints = [];
                    changedCount++;
                }
            });

            if (changedCount === 0) {
                showMiniToast('✅ 所有连线已经是直线');
                return;
            }

            // 取消选中状态
            selectedConnection = null;

            // 重新绘制所有连线
            drawAllConnections();

            showMiniToast(`✅ 已拉直 ${changedCount} 条连线`);
        }

        // 居中显示画布内容
        function centerCanvasContent() {
            console.log('🎯 centerCanvasContent 被调用');

            if (placedDevices.length === 0) {
                console.log('⚠️ 没有设备，跳过居中');
                return;
            }

            const canvas = document.getElementById('energyFlowCanvas');
            const devicesContainer = document.getElementById('devicesContainer');

            if (!canvas || !devicesContainer) {
                console.log('❌ 画布元素未找到');
                return;
            }

            // 计算所有设备的边界
            let minX = Infinity, minY = Infinity;
            let maxX = -Infinity, maxY = -Infinity;

            placedDevices.forEach(device => {
                const x = device.x || 0;
                const y = device.y || 0;
                const width = 240; // 设备卡片宽度
                const height = 200; // 设备卡片高度

                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x + width);
                maxY = Math.max(maxY, y + height);
            });

            console.log('📐 内容边界:', { minX, minY, maxX, maxY });

            // 计算内容的宽高
            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;

            // 获取画布可视区域
            const canvasWidth = canvas.clientWidth - 80; // 减去 padding
            const canvasHeight = canvas.clientHeight - 80;

            console.log('📏 画布尺寸:', { canvasWidth, canvasHeight });
            console.log('📦 内容尺寸:', { contentWidth, contentHeight });

            // 计算居中所需的偏移量
            const offsetX = Math.max(0, (canvasWidth - contentWidth) / 2 - minX);
            const offsetY = Math.max(0, (canvasHeight - contentHeight) / 2 - minY);

            console.log('➡️ 偏移量:', { offsetX, offsetY });

            // 应用偏移
            if (offsetX > 0 || offsetY > 0) {
                placedDevices.forEach(device => {
                    if (offsetX > 0) device.x = (device.x || 0) + offsetX;
                    if (offsetY > 0) device.y = (device.y || 0) + offsetY;
                });

                // 重新渲染
                renderPlacedDevices();
                drawAllConnections();

                console.log('✅ 内容已居中');
            } else {
                console.log('ℹ️ 内容已经居中，无需调整');
            }
        }

        // 应用网格布局（市电-光伏-储能柜）
        function applyGridLayout() {
            console.log('📐 应用网格布局');

            // 获取画布尺寸
            const container = document.getElementById('devicesContainer');
            const canvasWidth = container.offsetWidth;
            const canvasHeight = container.offsetHeight;

            // 计算网格位置（左右两列布局）
            const marginTop = 150; // 顶部边距
            const marginLeft = 280; // 左边距
            const marginRight = 280; // 右边距
            const verticalSpacing = 280; // 垂直间距

            const positions = {
                utility: { x: marginLeft, y: marginTop }, // 左上：市电
                solar: { x: canvasWidth - marginRight - 140, y: marginTop }, // 右上：光伏
                storage: { x: canvasWidth - marginRight - 140, y: marginTop + verticalSpacing } // 右下：储能柜
            };

            // 清空现有设备和连线
            placedDevices = [];
            deviceConnections = [];

            // 创建3个典型设备
            const devices = [
                {
                    id: 'grid-utility',
                    label: '市电',
                    icon: '电网.png',
                    desc: '380V 3相',
                    category: 'power',
                    x: positions.utility.x,
                    y: positions.utility.y,
                    voltage: 380.0,
                    power: 0,
                    current: 0,
                    flowControl: 'bidirectional', // 市电双向
                    displayParams: {
                        power: { enabled: false, x: -80, y: -30 },
                        voltage: { enabled: false, x: -80, y: 0 },
                        current: { enabled: false, x: -80, y: 30 },
                        soc: { enabled: false, x: -80, y: 60 }
                    }
                },
                {
                    id: 'grid-solar',
                    label: '光伏',
                    icon: '光伏.png',
                    desc: '500KW',
                    category: 'power',
                    x: positions.solar.x,
                    y: positions.solar.y,
                    voltage: 380.0,
                    power: 108.6,
                    current: 285.8,
                    flowControl: 'in', // 光伏输入
                    displayParams: {
                        power: { enabled: true, x: 160, y: -10 },
                        voltage: { enabled: false, x: 160, y: 20 },
                        current: { enabled: false, x: 160, y: 50 },
                        soc: { enabled: false, x: 160, y: 80 }
                    }
                },
                {
                    id: 'grid-storage',
                    label: '储能柜',
                    icon: '储能柜.png',
                    desc: '500KWh',
                    category: 'storage',
                    x: positions.storage.x,
                    y: positions.storage.y,
                    voltage: 380.0,
                    power: 104.4,
                    current: 274.7,
                    soc: 85.0,
                    flowControl: 'bidirectional', // 储能双向
                    displayParams: {
                        power: { enabled: true, x: 160, y: -10 },
                        voltage: { enabled: false, x: 160, y: 20 },
                        current: { enabled: false, x: 160, y: 50 },
                        soc: { enabled: false, x: 160, y: 80 }
                    }
                }
            ];

            // 添加设备到画布
            devices.forEach(device => {
                placedDevices.push(device);
            });

            // 创建连线（能量流拓扑）
            const connections = [
                // 光伏 → 储能柜 (垂直)
                { from: 'grid-solar', fromDirection: 'bottom', to: 'grid-storage', toDirection: 'top', controlPoints: [] },
                // 市电 → 储能柜 (斜线)
                { from: 'grid-utility', fromDirection: 'right', to: 'grid-storage', toDirection: 'left', controlPoints: [] }
            ];

            connections.forEach(conn => {
                deviceConnections.push(conn);
            });

            // 渲染设备和连线
            renderPlacedDevices();
            drawAllConnections();

            // 保存配置
            saveToLocalStorage();

            console.log('✅ 网格布局已应用');
            console.log('设备数量:', placedDevices.length);
            console.log('连线数量:', deviceConnections.length);

            // 显示成功提示
            showSuccessMessage('✅ 已应用能量流布局：市电 ⇄ 储能柜 ⇄ 光伏');
        }

        // 显示成功消息
        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #22c55e;
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // 保存配置到localStorage
        function saveFlowConfig() {
            console.log('💾 saveFlowConfig 被调用');

            // 按钮视觉反馈
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.style.background = '#0099cc';
                saveBtn.disabled = true;
            }

            if (!isEditMode) {
                showMiniToast('请先进入编辑模式', 'warning');
                if (saveBtn) {
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }
                return;
            }

            const config = {
                placedDevices: placedDevices,
                connections: deviceConnections,
                timestamp: new Date().toISOString()
            };

            try {
                const configStr = JSON.stringify(config);
                console.log('📦 准备保存配置');
                console.log('   - 数据大小:', configStr.length, '字节');
                console.log('   - 设备数量:', placedDevices.length);
                console.log('   - 连线数量:', deviceConnections.length);

                localStorage.setItem('energyFlowConfig', configStr);

                // 显示成功提示
                showMiniToast(`保存成功 (${placedDevices.length} 个设备, ${deviceConnections.length} 条连线)`, 'success');
                console.log('✅ 配置保存成功');
                console.log('🔍 保存时的编辑模式状态:', isEditMode);

                // 保存成功后，立即准备切换到预览模式
                // 先恢复按钮状态
                if (saveBtn) {
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }

                // 延迟300ms切换到预览模式（等待提示显示）
                setTimeout(() => {
                    console.log('🔍 准备切换前的编辑模式状态:', isEditMode);
                    // 确保切换回预览模式（只有在编辑模式下才切换）
                    if (isEditMode) {
                        console.log('💾 保存后自动切换到预览模式');
                        toggleEditMode();
                        console.log('🔍 切换后的编辑模式状态:', isEditMode);
                    } else {
                        console.log('⚠️ 已经在预览模式，无需切换');
                    }
                }, 300);

            } catch (e) {
                console.error('❌ 保存配置失败:', e);
                showMiniToast('保存失败：' + e.message, 'error');
                if (saveBtn) {
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }
            }
        }

        // 从localStorage加载配置
        function loadFlowConfig() {
            console.log('loadFlowConfig 被调用');

            try {
                const saved = localStorage.getItem('energyFlowConfig');
                console.log('从 localStorage 读取数据:', saved ? '有数据' : '无数据');

                if (saved) {
                    const config = JSON.parse(saved);
                    console.log('解析配置成功:', config);

                    placedDevices = config.placedDevices || [];
                    deviceConnections = config.connections || [];

                    console.log('设备数量:', placedDevices.length);
                    console.log('连线数量:', deviceConnections.length);

                    renderPlacedDevices();
                    drawAllConnections();

                    const saveTime = new Date(config.timestamp).toLocaleString('zh-CN');
                    showMiniToast(`✅ 配置加载成功！\n${placedDevices.length}个设备, ${deviceConnections.length}条连线\n保存时间: ${saveTime}`);
                } else {
                    showMiniToast('⚠️ 没有找到保存的配置');
                }
            } catch (e) {
                console.error('加载配置失败:', e);
                showMiniToast('❌ 加载失败：' + e.message);
            }
        }

        // 初始化时加载保存的配置
        function loadSavedConfig() {
            try {
                const saved = localStorage.getItem('energyFlowConfig');
                if (saved) {
                    const config = JSON.parse(saved);
                    placedDevices = config.placedDevices || [];
                    deviceConnections = config.connections || [];
                }
            } catch (e) {
                console.error('自动加载配置失败:', e);
            }
        }

        // 绘制连接线
        function drawConnections() {
            const svg = document.getElementById('energyConnections');
            svg.innerHTML = '';

            const layer1 = document.getElementById('layer1');
            const layer2 = document.getElementById('layer2');
            const layer3 = document.getElementById('layer3');

            // 获取各层位置
            const layer1Rect = layer1.getBoundingClientRect();
            const layer2Rect = layer2.getBoundingClientRect();
            const layer3Rect = layer3.getBoundingClientRect();
            const containerRect = document.getElementById('energyFlowCanvas').getBoundingClientRect();

            // 第一层设备到母线
            const sources = layer1.querySelectorAll('.flow-device');
            sources.forEach(source => {
                const rect = source.getBoundingClientRect();
                const x = rect.left + rect.width / 2 - containerRect.left;
                const y1 = rect.bottom - containerRect.top;
                const y2 = layer2Rect.top - containerRect.top;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x);
                line.setAttribute('y2', y2);
                line.setAttribute('class', 'flow-vline animated');
                svg.appendChild(line);
            });

            // 第一条母线（连接电源层和汇流柜）
            const busbar1Y = layer2Rect.top - containerRect.top;
            const busbar1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            busbar1.setAttribute('x1', 100);
            busbar1.setAttribute('y1', busbar1Y);
            busbar1.setAttribute('x2', containerRect.width - 100);
            busbar1.setAttribute('y2', busbar1Y);
            busbar1.setAttribute('class', 'flow-busbar');
            svg.appendChild(busbar1);

            // 汇流柜到第二条母线
            const busbarDevice = layer2.querySelector('.flow-busbar-device');
            if (busbarDevice) {
                const rect = busbarDevice.getBoundingClientRect();
                const x = rect.left + rect.width / 2 - containerRect.left;
                const y1 = rect.bottom - containerRect.top;
                const y2 = layer3Rect.top - containerRect.top - 20;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x);
                line.setAttribute('y2', y2);
                line.setAttribute('class', 'flow-vline animated');
                svg.appendChild(line);
            }

            // 第二条母线（连接汇流柜和PCS）
            const busbar2Y = layer3Rect.top - containerRect.top - 20;
            const busbar2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            busbar2.setAttribute('x1', 100);
            busbar2.setAttribute('y1', busbar2Y);
            busbar2.setAttribute('x2', containerRect.width - 100);
            busbar2.setAttribute('y2', busbar2Y);
            busbar2.setAttribute('class', 'flow-busbar');
            svg.appendChild(busbar2);

            // 母线到各个PCS/BMS组
            const groups = layer3.querySelectorAll('.flow-pcs-bms-group');
            groups.forEach(group => {
                const pcs = group.querySelector('.flow-pcs-device');
                const bms = group.querySelector('.flow-bms-device');

                if (pcs && bms) {
                    const pcsRect = pcs.getBoundingClientRect();
                    const bmsRect = bms.getBoundingClientRect();
                    const x = pcsRect.left + pcsRect.width / 2 - containerRect.left;

                    // 母线到PCS
                    const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line1.setAttribute('x1', x);
                    line1.setAttribute('y1', busbar2Y);
                    line1.setAttribute('x2', x);
                    line1.setAttribute('y2', pcsRect.top - containerRect.top);
                    line1.setAttribute('class', 'flow-vline animated');
                    svg.appendChild(line1);

                    // PCS到BMS
                    const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line2.setAttribute('x1', x);
                    line2.setAttribute('y1', pcsRect.bottom - containerRect.top);
                    line2.setAttribute('x2', x);
                    line2.setAttribute('y2', bmsRect.top - containerRect.top);
                    line2.setAttribute('class', 'flow-vline animated');
                    svg.appendChild(line2);
                }
            });
        }

        // 启动实时数据更新
        function startEnergyFlowUpdates() {
            setInterval(() => {
                if (window.energyFlowInitialized && document.getElementById('energy-flow-container').style.display !== 'none') {
                    // 更新电源功率
                    flowData.sources.forEach(source => {
                        if (source.power) {
                            source.power = Math.max(50, source.power + (Math.random() - 0.5) * 10);
                        }
                    });

                    // 更新BMS数据
                    flowData.bms.forEach(bms => {
                        bms.voltage = Math.max(370, Math.min(395, bms.voltage + (Math.random() - 0.5) * 2));
                        bms.current = Math.max(80, Math.min(150, bms.current + (Math.random() - 0.5) * 5));
                        bms.soc = Math.max(10, Math.min(100, bms.soc + (Math.random() - 0.5) * 1));
                    });

                    // 重新渲染（不重绘连接线以保持性能）
                    renderLayer1();
                    renderLayer4();
                }
            }, 3000);
        }

        // ==================== 能量流视图功能结束 ====================
    </script>

    <script>
        // 更新设备页面的动态翻译内容
        function updateDevicesTranslations() {
            // 更新按钮的 title 属性
            const tableViewBtn = document.getElementById('tableViewBtn');
            const sceneViewBtn = document.getElementById('sceneViewBtn');

            if (tableViewBtn && typeof getTranslation === 'function') {
                tableViewBtn.title = getTranslation('devicesTabTable');
            }
            if (sceneViewBtn && typeof getTranslation === 'function') {
                sceneViewBtn.title = getTranslation('devicesTabScene');
            }

            // 强制更新 select 选项的翻译
            const unifiedSelect = document.getElementById('unifiedSiteSelect');
            if (unifiedSelect && typeof getTranslation === 'function') {
                const options = unifiedSelect.querySelectorAll('option[data-translate]');
                options.forEach(option => {
                    const key = option.getAttribute('data-translate');
                    const translated = getTranslation(key);
                    if (translated) {
                        option.textContent = translated;
                    }
                });
            }
        }

        // 艹！初始化翻译，用正确的函数名
        document.addEventListener('DOMContentLoaded', function() {
            // 应用当前语言的翻译
            if (typeof setLanguage === 'function') {
                setLanguage(currentLang);
            }
            // 强制更新设备页面的翻译
            if (typeof updateDevicesTranslations === 'function') {
                updateDevicesTranslations();
            }
            // 重新渲染表格，让动态生成的内容使用正确的翻译
            if (typeof renderTable === 'function') {
                renderTable();
            }

            // 艹！恢复上次选择的视图模式
            const savedViewMode = localStorage.getItem('devicesViewMode');
            if (savedViewMode === 'view') {
                // 模拟点击场景视图按钮
                const sceneButton = document.querySelector('.tab-button[onclick*="view"]');
                if (sceneButton) {
                    sceneButton.click();
                }
            }

            // 添加键盘Del键监听
            document.addEventListener('keydown', function(event) {
                // 检查是否按下了Delete或Backspace键
                if (event.key === 'Delete' || event.key === 'Backspace') {
                    // 检查是否在能量流视图中
                    const energyFlowView = document.getElementById('energyFlowView');
                    if (!energyFlowView || energyFlowView.style.display === 'none') {
                        return; // 不在能量流视图中，不处理
                    }

                    // 检查是否在编辑模式
                    if (!isEditMode) {
                        return; // 不在编辑模式，不处理删除
                    }

                    // 检查是否在输入框中
                    const activeElement = document.activeElement;
                    if (activeElement.tagName === 'INPUT' ||
                        activeElement.tagName === 'TEXTAREA' ||
                        activeElement.isContentEditable) {
                        return; // 在输入框中，不处理删除
                    }

                    // 阻止浏览器后退
                    event.preventDefault();

                    // 查找所有选中的设备
                    const selectedDevices = document.querySelectorAll('.flow-device.selected');

                    if (selectedDevices.length > 0) {
                        // 如果有选中的设备，删除它们
                        if (confirm(`确定要删除 ${selectedDevices.length} 个选中的设备吗？\n相关的连线也会被删除。`)) {
                            selectedDevices.forEach(deviceElement => {
                                const deviceId = deviceElement.dataset.deviceId;

                                // 删除相关连线
                                deviceConnections = deviceConnections.filter(conn =>
                                    conn.from !== deviceId && conn.to !== deviceId
                                );

                                // 删除设备
                                placedDevices = placedDevices.filter(d => d.id !== deviceId);
                            });

                            // 重新渲染
                            renderPlacedDevices();
                            drawAllConnections();

                            showMiniToast(`🗑️ 已删除 ${selectedDevices.length} 个设备`);
                        }
                    } else if (selectedConnection !== null) {
                        // 如果有选中的连线，删除它
                        if (confirm('确定要删除选中的连线吗？')) {
                            deviceConnections.splice(selectedConnection, 1);
                            selectedConnection = null;
                            drawAllConnections();
                            showMiniToast('🗑️ 连线已删除');
                        }
                    }
                }
            });
        });

        // 监听语言切换事件
        window.addEventListener('languageChanged', function() {
            // 重新渲染表格（因为表格中的模式和状态是动态生成的，需要用新语言重新渲染）
            if (typeof renderTable === 'function') {
                renderTable();
            }
        });

        // ===========================================
        // 设备详情面板功能
        // ===========================================

        // 当前查看的设备ID（用于查看详情跳转）
        let currentDeviceId = null;

        // 打开设备详情面板
        function openDevicePanel(deviceId) {
            const device = placedDevices.find(d => d.id === deviceId);
            if (!device) return;

            // 保存当前设备ID
            currentDeviceId = deviceId;

            const panel = document.getElementById('deviceDetailPanel');
            const overlay = document.getElementById('devicePanelOverlay');
            const panelIcon = document.getElementById('devicePanelIcon');
            const panelName = document.getElementById('devicePanelName');
            const panelBody = document.getElementById('devicePanelBody');

            // 设置面板标题和图标
            panelName.textContent = device.label + ' 运行数据';

            // 使用设备的 icon 图标
            panelIcon.innerHTML = `<img src="${device.icon}" alt="${device.label}">`;

            // 判断设备类型（用于加载不同的数据模板）
            const label = device.label.toLowerCase();
            const id = deviceId.toLowerCase();
            let deviceType = 'unknown';

            if (label.includes('市电') || label.includes('电网') || id.includes('utility') || id.includes('grid')) {
                deviceType = 'grid';
            } else if (label.includes('储能') || label.includes('电池') || id.includes('storage') || id.includes('battery') || id.includes('pcs')) {
                deviceType = 'storage';
            } else if (label.includes('光伏') || id.includes('solar') || id.includes('pv')) {
                deviceType = 'solar';
            }

            // 根据设备类型加载不同的内容
            if (deviceType === 'grid') {
                // 电网/市电
                panelBody.innerHTML = `
                    <div class="device-section">
                        <div class="device-section-title">运行状态</div>
                        <div class="device-data-grid">
                            <div class="device-data-card device-data-full">
                                <div class="device-data-label">状态</div>
                                <div class="device-data-value">
                                    <span class="device-status-badge">正常运行</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="device-section">
                        <div class="device-section-title">电气参数</div>
                        <div class="device-data-grid">
                            <div class="device-data-card highlight">
                                <div class="device-data-label">电压</div>
                                <div class="device-data-value">
                                    <span id="grid-voltage">380.5</span>
                                    <span class="device-data-unit">V</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">频率</div>
                                <div class="device-data-value">
                                    <span id="grid-frequency">50.0</span>
                                    <span class="device-data-unit">Hz</span>
                                </div>
                            </div>
                            <div class="device-data-card highlight">
                                <div class="device-data-label">功率</div>
                                <div class="device-data-value">
                                    <span id="grid-power">152.3</span>
                                    <span class="device-data-unit">kW</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">电流</div>
                                <div class="device-data-value">
                                    <span id="grid-current">272.8</span>
                                    <span class="device-data-unit">A</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="device-section">
                        <div class="device-section-title">累计数据</div>
                        <div class="device-data-grid">
                            <div class="device-data-card">
                                <div class="device-data-label">今日购电</div>
                                <div class="device-data-value">
                                    <span id="grid-purchase">2156.8</span>
                                    <span class="device-data-unit">kWh</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">今日售电</div>
                                <div class="device-data-value">
                                    <span id="grid-sale">423.5</span>
                                    <span class="device-data-unit">kWh</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateGridData();
            } else if (deviceType === 'storage') {
                // 储能柜
                panelBody.innerHTML = `
                    <div class="device-section">
                        <div class="device-section-title">运行状态</div>
                        <div class="device-data-grid">
                            <div class="device-data-card device-data-full">
                                <div class="device-data-label">状态</div>
                                <div class="device-data-value">
                                    <span class="device-status-badge">充电中</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="device-section">
                        <div class="device-section-title">电池参数</div>
                        <div class="device-data-grid">
                            <div class="device-data-card highlight">
                                <div class="device-data-label">SOC</div>
                                <div class="device-data-value">
                                    <span id="storage-soc">58.5</span>
                                    <span class="device-data-unit">%</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">SOH</div>
                                <div class="device-data-value">
                                    <span id="storage-soh">96.8</span>
                                    <span class="device-data-unit">%</span>
                                </div>
                            </div>
                            <div class="device-data-card highlight">
                                <div class="device-data-label">充放电功率</div>
                                <div class="device-data-value">
                                    <span id="storage-power">118.6</span>
                                    <span class="device-data-unit">kW</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">电池温度</div>
                                <div class="device-data-value">
                                    <span id="storage-temp">28.7</span>
                                    <span class="device-data-unit">℃</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">电压</div>
                                <div class="device-data-value">
                                    <span id="storage-voltage">398.2</span>
                                    <span class="device-data-unit">V</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">电流</div>
                                <div class="device-data-value">
                                    <span id="storage-current">297.8</span>
                                    <span class="device-data-unit">A</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="device-section">
                        <div class="device-section-title">累计数据</div>
                        <div class="device-data-grid">
                            <div class="device-data-card">
                                <div class="device-data-label">今日充电</div>
                                <div class="device-data-value">
                                    <span id="storage-charge">203.5</span>
                                    <span class="device-data-unit">kWh</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">今日放电</div>
                                <div class="device-data-value">
                                    <span id="storage-discharge">178.6</span>
                                    <span class="device-data-unit">kWh</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">循环次数</div>
                                <div class="device-data-value">
                                    <span id="storage-cycles">1256</span>
                                    <span class="device-data-unit">次</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateStorageData();
            } else if (deviceType === 'solar') {
                // 光伏
                panelBody.innerHTML = `
                    <div class="device-section">
                        <div class="device-section-title">运行状态</div>
                        <div class="device-data-grid">
                            <div class="device-data-card device-data-full">
                                <div class="device-data-label">状态</div>
                                <div class="device-data-value">
                                    <span class="device-status-badge">正常发电</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="device-section">
                        <div class="device-section-title">发电参数</div>
                        <div class="device-data-grid">
                            <div class="device-data-card highlight">
                                <div class="device-data-label">实时功率</div>
                                <div class="device-data-value">
                                    <span id="solar-power">387.2</span>
                                    <span class="device-data-unit">kW</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">光照强度</div>
                                <div class="device-data-value">
                                    <span id="solar-irradiance">912</span>
                                    <span class="device-data-unit">W/m²</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">电压</div>
                                <div class="device-data-value">
                                    <span id="solar-voltage">379.8</span>
                                    <span class="device-data-unit">V</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">电流</div>
                                <div class="device-data-value">
                                    <span id="solar-current">605.2</span>
                                    <span class="device-data-unit">A</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">组件温度</div>
                                <div class="device-data-value">
                                    <span id="solar-temp">55.8</span>
                                    <span class="device-data-unit">℃</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">转换效率</div>
                                <div class="device-data-value">
                                    <span id="solar-efficiency">20.1</span>
                                    <span class="device-data-unit">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="device-section">
                        <div class="device-section-title">累计数据</div>
                        <div class="device-data-grid">
                            <div class="device-data-card">
                                <div class="device-data-label">今日发电</div>
                                <div class="device-data-value">
                                    <span id="solar-daily">2147.6</span>
                                    <span class="device-data-unit">kWh</span>
                                </div>
                            </div>
                            <div class="device-data-card">
                                <div class="device-data-label">累计发电</div>
                                <div class="device-data-value">
                                    <span id="solar-total">1.25</span>
                                    <span class="device-data-unit">MWh</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateSolarData();
            }

            // 显示面板和蒙版
            overlay.classList.add('active');
            panel.classList.add('active');
        }

        // 关闭设备详情面板
        function closeDevicePanel() {
            const panel = document.getElementById('deviceDetailPanel');
            const overlay = document.getElementById('devicePanelOverlay');
            panel.classList.remove('active');
            overlay.classList.remove('active');
        }

        // 查看设备详情（跳转到详情页）
        function viewDeviceDetails() {
            if (!currentDeviceId) {
                console.error('未选中任何设备');
                return;
            }

            // 从设备ID中提取数字作为 cabinetId
            // 例如：test-grid-1 -> 1, ESS001 -> 1
            let cabinetId = currentDeviceId;

            // 如果ID包含数字，提取最后的数字
            const match = currentDeviceId.match(/(\d+)$/);
            if (match) {
                cabinetId = match[1];
            }

            // 跳转到储能柜详情页面
            window.location.href = `cabinet-detail.html?cabinetId=${cabinetId}`;
        }

        // 更新电网数据（基于真实380V三相工业用电参数）
        function updateGridData() {
            setInterval(() => {
                const voltage = document.getElementById('grid-voltage');
                const frequency = document.getElementById('grid-frequency');
                const power = document.getElementById('grid-power');
                const current = document.getElementById('grid-current');
                const purchase = document.getElementById('grid-purchase');
                const sale = document.getElementById('grid-sale');

                // 380V线电压，正常波动±2%（375-385V）
                if (voltage) voltage.textContent = (378.5 + Math.random() * 4.5).toFixed(1);

                // 50Hz频率，允许±0.2Hz波动
                if (frequency) frequency.textContent = (50.0 + (Math.random() - 0.5) * 0.3).toFixed(2);

                // 功率：工商业负载典型值120-180kW
                if (power) power.textContent = (135 + Math.random() * 35).toFixed(1);

                // 电流：根据公式 I=P/(√3×U×cosφ)，功率因数0.85，150kW时约268A
                if (current) current.textContent = (240 + Math.random() * 60).toFixed(1);

                // 今日购电：工商业用户典型1500-2800kWh/天
                if (purchase) purchase.textContent = (1580 + Math.random() * 1150).toFixed(1);

                // 今日售电：光伏反向送电200-600kWh/天
                if (sale) sale.textContent = (285 + Math.random() * 285).toFixed(1);
            }, 2000);
        }

        // 更新储能柜数据（基于真实250kW/500kWh磷酸铁锂储能系统参数）
        function updateStorageData() {
            setInterval(() => {
                const soc = document.getElementById('storage-soc');
                const soh = document.getElementById('storage-soh');
                const power = document.getElementById('storage-power');
                const temp = document.getElementById('storage-temp');
                const voltage = document.getElementById('storage-voltage');
                const current = document.getElementById('storage-current');
                const charge = document.getElementById('storage-charge');
                const discharge = document.getElementById('storage-discharge');
                const cycles = document.getElementById('storage-cycles');

                // SOC：正常运行范围25-80%，避免深度充放电
                if (soc) soc.textContent = (52 + Math.random() * 23).toFixed(1);

                // SOH：健康度，新系统95-98%
                if (soh) soh.textContent = (96.2 + Math.random() * 1.5).toFixed(1);

                // 功率：充电状态，实际运行80-150kW（额定250kW）
                if (power) power.textContent = (95 + Math.random() * 45).toFixed(1);

                // 温度：正常运行25-32°C
                if (temp) temp.textContent = (26.5 + Math.random() * 4.5).toFixed(1);

                // 电压：磷酸铁锂直流侧约400V（范围360-420V）
                if (voltage) voltage.textContent = (392 + Math.random() * 16).toFixed(1);

                // 电流：根据功率，120kW时约300A（I=P/U）
                if (current) current.textContent = (265 + Math.random() * 70).toFixed(1);

                // 今日充电：典型值120-280kWh/天
                if (charge) charge.textContent = (165 + Math.random() * 95).toFixed(1);

                // 今日放电：典型值100-240kWh/天
                if (discharge) discharge.textContent = (145 + Math.random() * 80).toFixed(1);

                // 循环次数：使用1-2年约800-1500次
                if (cycles) cycles.textContent = '1047';
            }, 2000);
        }

        // 更新光伏数据（基于真实工商业光伏发电系统参数）
        function updateSolarData() {
            setInterval(() => {
                const power = document.getElementById('solar-power');
                const irradiance = document.getElementById('solar-irradiance');
                const voltage = document.getElementById('solar-voltage');
                const current = document.getElementById('solar-current');
                const temp = document.getElementById('solar-temp');
                const efficiency = document.getElementById('solar-efficiency');
                const daily = document.getElementById('solar-daily');
                const total = document.getElementById('solar-total');

                // 实时功率：晴天峰值约350-420kW（假设500kW装机，实际80-85%）
                if (power) power.textContent = (365 + Math.random() * 45).toFixed(1);

                // 辐照度：晴天800-1000 W/m²，多云400-700 W/m²
                if (irradiance) irradiance.textContent = Math.floor(870 + Math.random() * 95);

                // 电压：并网侧380V三相
                if (voltage) voltage.textContent = (377 + Math.random() * 6).toFixed(1);

                // 电流：根据功率约550-650A（I=P/(√3×U)）
                if (current) current.textContent = (580 + Math.random() * 55).toFixed(1);

                // 组件温度：工作时比环境高20-30°C，约50-60°C
                if (temp) temp.textContent = (52 + Math.random() * 7).toFixed(1);

                // 转换效率：单晶硅约19-21%
                if (efficiency) efficiency.textContent = (19.5 + Math.random() * 1.2).toFixed(1);

                // 今日发电：500kW系统晴天约1800-2400kWh/天
                if (daily) daily.textContent = (1920 + Math.random() * 420).toFixed(1);

                // 累计发电：运行1-2年约0.8-1.5MWh
                if (total) total.textContent = '1.18';
            }, 2000);
        }
    </script>

    <!-- 面板蒙版 -->
    <div id="devicePanelOverlay" class="device-panel-overlay" onclick="closeDevicePanel()"></div>

    <!-- 设备详情面板 -->
    <div id="deviceDetailPanel" class="device-detail-panel">
        <div class="device-panel-header">
            <div class="device-panel-title">
                <div class="device-panel-icon" id="devicePanelIcon">⚡</div>
                <span id="devicePanelName">设备详情</span>
            </div>
            <div class="device-panel-actions">
                <a href="javascript:void(0)" class="device-detail-link" onclick="viewDeviceDetails()">
                    查看详情 →
                </a>
                <div class="device-panel-close" onclick="closeDevicePanel()">✕</div>
            </div>
        </div>
        <div class="device-panel-body" id="devicePanelBody">
            <!-- 内容将动态加载 -->
        </div>
    </div>

    <!-- 退出确认弹窗已由 navbar.js 生成 -->
</body>
</html>