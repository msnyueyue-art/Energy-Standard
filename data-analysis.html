<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">收益分析 - 储能柜管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <link rel="stylesheet" href="styles.css">
    <script src="navbar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .main-content {
            height: calc(100vh - 64px);
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 20px;
            overflow: hidden;
        }

        /* 上方查询区域 */
        .left-panel {
            width: 100%;
            flex-shrink: 0;
        }

        /* 筛选器区域 */
        .filter-section {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            box-sizing: border-box;
        }

        .filter-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            border: none;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .filter-row {
            display: flex;
            flex-direction: row;
            gap: 16px;
            flex: 1;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .filter-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .filter-select, .filter-input {
            width: 200px;
            height: 38px;
            padding: 0 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:hover, .filter-input:hover {
            border-color: var(--primary-color);
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 树形选择器样式 */
        .filter-group.has-tree {
            position: relative;
        }

        .filter-group.has-tree .filter-input {
            cursor: pointer;
        }

        .tree-view {
            width: 280px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            max-height: 320px;
            overflow-y: auto;
            padding: 4px 0;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
        }

        .tree-view.active {
            display: block;
        }

        .tree-view::-webkit-scrollbar {
            width: 6px;
        }

        .tree-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .tree-view::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .tree-view::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .tree-node {
            padding: 0;
        }

        .tree-node-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.2s ease;
        }

        .tree-node-item:hover {
            background: var(--bg-secondary);
        }

        .tree-node-item.selected {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary-color);
            font-weight: 500;
        }

        .tree-node-item.child {
            padding-left: 36px;
        }

        .tree-expand-icon {
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
            cursor: pointer;
            padding: 4px;
            margin: -4px;
            border-radius: 4px;
        }

        .tree-expand-icon:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }

        .tree-node-item.expanded .tree-expand-icon {
            transform: rotate(90deg);
        }

        .tree-children {
            display: none;
        }

        .tree-children.expanded {
            display: block;
        }

        .tree-node-label {
            flex: 1;
        }

        /* 年份选择器样式 */
        #statisticTimeSelectYear {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
            margin-left: auto;
        }

        .btn-export {
            height: 38px;
            padding: 0 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-export:hover {
            background: #2563eb;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        /* 右侧内容区域 */
        .right-panel {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Tab容器 */
        .table-container {
            background: var(--bg-primary);
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Tab导航 */
        .tab-navigation {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            padding: 20px 20px 0 20px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(59, 130, 246, 0.05);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .tab-btn i {
            font-size: 16px;
        }

        .tab-actions {
            margin-left: auto;
            margin-bottom: -2px;
        }

        .btn-export-top {
            height: 38px;
            padding: 0 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-export-top:hover {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        /* Tab内容 */
        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 20px 20px 20px;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* 表格样式 */
        .table-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .table-scroll {
            flex: 1;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-primary);
            table-layout: fixed;
        }

        /* 固定列宽确保对齐 - 7列 */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            width: 12%;  /* 时间 */
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            width: 17%;  /* 站点/设备名称 */
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            width: 14%;  /* 充电成本 */
        }

        .data-table th:nth-child(4),
        .data-table td:nth-child(4) {
            width: 14%;  /* 卖电利润 */
        }

        .data-table th:nth-child(5),
        .data-table td:nth-child(5) {
            width: 14%;  /* 净利润 */
        }

        .data-table th:nth-child(6),
        .data-table td:nth-child(6) {
            width: 14%;  /* 自用节省 */
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) {
            width: 15%;  /* 总收益 */
        }

        .data-table thead {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .data-table th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
        }

        /* 金额列表头右对齐 */
        .data-table th:nth-child(3),
        .data-table th:nth-child(4),
        .data-table th:nth-child(5),
        .data-table th:nth-child(6),
        .data-table th:nth-child(7) {
            text-align: right;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-weight: 400;
        }

        /* 金额列数据右对齐 */
        .data-table td:nth-child(3),
        .data-table td:nth-child(4),
        .data-table td:nth-child(5),
        .data-table td:nth-child(6),
        .data-table td:nth-child(7) {
            text-align: right;
        }

        .data-table tbody tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .table-footer {
            position: sticky;
            bottom: 0;
            background: var(--bg-primary);
            border-top: 2px solid var(--border-color);
            z-index: 10;
        }

        .table-footer .data-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        /* 汇总行列宽设置 - 6列（第1列是colspan=2） */
        .table-footer .data-table td:nth-child(1) {
            width: 29%;  /* 合计（时间12% + 站点/设备17%） */
        }

        .table-footer .data-table td:nth-child(2) {
            width: 14%;  /* 充电成本 */
        }

        .table-footer .data-table td:nth-child(3) {
            width: 14%;  /* 卖电利润 */
        }

        .table-footer .data-table td:nth-child(4) {
            width: 14%;  /* 净利润 */
        }

        .table-footer .data-table td:nth-child(5) {
            width: 14%;  /* 自用节省 */
        }

        .table-footer .data-table td:nth-child(6) {
            width: 15%;  /* 总收益 */
        }

        .table-footer tfoot {
            background: #d1ecf1;
        }

        .summary-row {
            font-weight: 600;
            background: #d1ecf1;
        }

        .summary-row:hover {
            background: #d1ecf1;
        }

        .summary-row td {
            border-bottom: none;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            color: #0c5460;
            border-top: none;
        }

        .summary-label {
            font-weight: 700;
            color: #0c5460;
            text-align: left;
            font-size: 15px;
        }

        .summary-value {
            color: #0c5460;
            font-weight: 600;
            text-align: right;
        }

        /* 数值背景颜色样式 */
        .value-positive {
            background-color: #d1fae5;
            color: #065f46;
            font-weight: 400;
        }

        .value-negative {
            background-color: #fee2e2;
            color: #991b1b;
            font-weight: 400;
        }

        .value-neutral {
            color: var(--text-primary);
        }

        /* 汇总行背景颜色样式 */
        .summary-value.value-positive {
            background-color: #a7f3d0;
            color: #064e3b;
            font-weight: 700;
        }

        .summary-value.value-negative {
            background-color: #fecaca;
            color: #7f1d1d;
            font-weight: 700;
        }

        /* 收益卡片样式 - 第一排包含总收益卡片+收益结构图 */
        .revenue-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
            align-items: stretch;
        }

        .revenue-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 30px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 480px;
            margin: 0;
            position: relative;
            z-index: 1;
            overflow: hidden;
            box-sizing: border-box;
            justify-content: center;
        }

        .revenue-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        /* 卡片主标题 */
        .revenue-card-title-main {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        /* 利润行样式 */
        .profit-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .profit-row:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        /* 总利润行加大字体 */
        .profit-row-main {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 2px solid rgba(59, 130, 246, 0.2);
        }

        .profit-row-main .profit-label {
            font-size: 18px;
            font-weight: 700;
        }

        .profit-row-main .profit-value {
            font-size: 36px;
            font-weight: 800;
        }

        /* 标题 */
        .profit-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
            flex-shrink: 0;
        }

        /* 金额 */
        .profit-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
            text-align: left;
        }

        /* 环比 */
        .profit-compare {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            background: var(--bg-primary);
            flex-shrink: 0;
        }

        .profit-compare.increase {
            color: #059669;
            background: rgba(5, 150, 105, 0.15);
        }

        .profit-compare.decrease {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.15);
        }

        .profit-compare i {
            font-size: 11px;
        }

        .compare-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-right: 4px;
        }

        /* 详细数据卡片样式 - 单列布局 */
        .detail-data-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .detail-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .detail-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .detail-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .detail-card-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .detail-card-body {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .detail-item-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item-content {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .detail-item-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .detail-item-compare {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            padding: 6px 10px;
            border-radius: 6px;
            background: var(--bg-secondary);
            width: fit-content;
        }

        .detail-item-compare.increase {
            color: #059669;
            background: rgba(5, 150, 105, 0.1);
        }

        .detail-item-compare.decrease {
            color: #dc2626;
            background: rgba(220, 38, 38, 0.1);
        }

        .detail-item-compare i {
            font-size: 11px;
        }

        .detail-item-compare .compare-label {
            font-size: 11px;
            color: var(--text-secondary);
            margin-right: 4px;
        }

        /* 图表容器 */
        .charts-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
            margin-top: 0;
        }

        .chart-container {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 1;
            box-sizing: border-box;
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        /* 收益结构图在第一排时的样式 */
        .chart-container.in-first-row {
            display: flex;
            flex-direction: column;
            height: 480px;
            margin: 0;
            overflow: hidden;
            box-sizing: border-box;
        }

        .chart-container.in-first-row .chart-body {
            flex: 1;
            min-height: 0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: var(--primary-color);
        }

        .chart-body {
            width: 100%;
            height: 400px;
        }

        /* 响应式 */
        @media (max-width: 1024px) {
            /* 平板：第一排改为2行 */
            .revenue-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-container.in-first-row {
                grid-column: 1 / -1;
            }

            .detail-data-cards {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            /* 手机：全部单列 */
            .revenue-cards {
                grid-template-columns: 1fr;
            }

            .chart-container.in-first-row .chart-body {
                height: 250px;
            }
        }
    </style>
</head>
<body data-page="data-analysis">
    <!-- 主内容区 -->
    <main class="main-content">
        <!-- 上方查询区域 -->
        <div class="left-panel">
            <div class="filter-section">
                <div class="filter-row">
                    <!-- 1. 站点/设备 -->
                    <div class="filter-group has-tree">
                        <label class="filter-label">站点/设备</label>
                        <input type="text" class="filter-input" id="siteSelection" placeholder="请选择站点或设备" value="全部站点" readonly onclick="toggleTreeView()">
                        <div class="tree-view" id="treeView">
                            <div class="tree-node">
                                <div class="tree-node-item selected" data-value="all" onclick="selectTreeNode(event, 'all', '全部站点')">
                                    <span class="tree-node-label">全部站点</span>
                                </div>
                            </div>
                            <div class="tree-node">
                                <div class="tree-node-item expandable expanded" data-value="site1" onclick="handleSiteClick(event, 'site1', '北京朝阳站')">
                                    <i class="fas fa-caret-right tree-expand-icon" onclick="toggleTreeNode(event)"></i>
                                    <span class="tree-node-label">北京朝阳站</span>
                                </div>
                                <div class="tree-children expanded">
                                    <div class="tree-node-item child" data-value="site1-device1" onclick="selectTreeNode(event, 'site1-device1', '北京朝阳站 - 储能柜 #1')">
                                        <span class="tree-node-label">储能柜 #1</span>
                                    </div>
                                    <div class="tree-node-item child" data-value="site1-device2" onclick="selectTreeNode(event, 'site1-device2', '北京朝阳站 - 储能柜 #2')">
                                        <span class="tree-node-label">储能柜 #2</span>
                                    </div>
                                    <div class="tree-node-item child" data-value="site1-device3" onclick="selectTreeNode(event, 'site1-device3', '北京朝阳站 - 储能柜 #3')">
                                        <span class="tree-node-label">储能柜 #3</span>
                                    </div>
                                </div>
                            </div>
                            <div class="tree-node">
                                <div class="tree-node-item expandable" data-value="site2" onclick="handleSiteClick(event, 'site2', '上海浦东站')">
                                    <i class="fas fa-caret-right tree-expand-icon" onclick="toggleTreeNode(event)"></i>
                                    <span class="tree-node-label">上海浦东站</span>
                                </div>
                                <div class="tree-children">
                                    <div class="tree-node-item child" data-value="site2-device1" onclick="selectTreeNode(event, 'site2-device1', '上海浦东站 - 储能柜 #1')">
                                        <span class="tree-node-label">储能柜 #1</span>
                                    </div>
                                    <div class="tree-node-item child" data-value="site2-device2" onclick="selectTreeNode(event, 'site2-device2', '上海浦东站 - 储能柜 #2')">
                                        <span class="tree-node-label">储能柜 #2</span>
                                    </div>
                                </div>
                            </div>
                            <div class="tree-node">
                                <div class="tree-node-item expandable" data-value="site3" onclick="handleSiteClick(event, 'site3', '深圳南山站')">
                                    <i class="fas fa-caret-right tree-expand-icon" onclick="toggleTreeNode(event)"></i>
                                    <span class="tree-node-label">深圳南山站</span>
                                </div>
                                <div class="tree-children">
                                    <div class="tree-node-item child" data-value="site3-device1" onclick="selectTreeNode(event, 'site3-device1', '深圳南山站 - 储能柜 #1')">
                                        <span class="tree-node-label">储能柜 #1</span>
                                    </div>
                                    <div class="tree-node-item child" data-value="site3-device2" onclick="selectTreeNode(event, 'site3-device2', '深圳南山站 - 储能柜 #2')">
                                        <span class="tree-node-label">储能柜 #2</span>
                                    </div>
                                    <div class="tree-node-item child" data-value="site3-device3" onclick="selectTreeNode(event, 'site3-device3', '深圳南山站 - 储能柜 #3')">
                                        <span class="tree-node-label">储能柜 #3</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 时间维度 -->
                    <div class="filter-group">
                        <label class="filter-label">时间维度</label>
                        <select class="filter-select" id="reportType" onchange="changeDimension(this.value)">
                            <option value="monthly">月报</option>
                            <option value="yearly">年报</option>
                        </select>
                    </div>

                    <!-- 3. 统计时间 -->
                    <div class="filter-group">
                        <label class="filter-label" id="timeFilterLabel">选择日期</label>
                        <input type="text" class="filter-input" id="statisticTime" placeholder="选择日期" readonly style="cursor: pointer;">
                        <select class="filter-select" id="statisticTimeSelectYear" style="display: none;" onchange="onYearSelectChange()">
                            <!-- 动态生成年份选项 -->
                        </select>
                    </div>
                </div>

                <div class="export-buttons">
                    <button class="btn-export" onclick="queryData()">
                        <i class="fas fa-search"></i>
                        查询数据
                    </button>
                </div>
            </div>
        </div>

        <!-- 右侧内容区域 -->
        <div class="right-panel">
            <!-- Tab切换容器 -->
            <div class="table-container">
                <!-- Tab导航 -->
                <div class="tab-navigation">
                    <button class="tab-btn active" onclick="switchTab('chart')">
                        <i class="fas fa-chart-area"></i>
                        图表
                    </button>
                    <button class="tab-btn" onclick="switchTab('table')">
                        <i class="fas fa-table"></i>
                        表格
                    </button>
                    <div class="tab-actions">
                        <button class="btn-export-top" onclick="window.location.href='electricity-price-new.html'" style="margin-right: 8px;">
                            <i class="fas fa-cog"></i>
                            电价设置
                        </button>
                        <button class="btn-export-top" id="exportButton" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            导出数据
                        </button>
                    </div>
                </div>

                <!-- 表格视图 -->
                <div id="tableView" class="tab-content">
                    <div class="table-wrapper">
                        <div class="table-scroll">
                            <table class="data-table" id="revenueTable">
                                <thead>
                                    <tr>
                                        <th>时间</th>
                                        <th>站点/设备名称</th>
                                        <th>充电成本(元)</th>
                                        <th>卖电利润(元)</th>
                                        <th>净利润(元)</th>
                                        <th>自用节省(元)</th>
                                        <th>总收益(元)</th>
                                    </tr>
                                </thead>
                                <tbody id="revenueTableBody">
                                    <!-- 数据由JavaScript生成 -->
                                </tbody>
                            </table>
                        </div>
                        <div class="table-footer">
                            <table class="data-table">
                                <tfoot>
                                    <tr class="summary-row">
                                        <td class="summary-label" colspan="2">合计</td>
                                        <td id="summaryChargeCost" class="summary-value">¥0.00</td>
                                        <td id="summarySellRevenue" class="summary-value">¥0.00</td>
                                        <td id="summaryNetProfit" class="summary-value">¥0.00</td>
                                        <td id="summarySelfSaving" class="summary-value">¥0.00</td>
                                        <td id="summaryTotalRevenue" class="summary-value">¥0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 图表视图 -->
                <div id="chartView" class="tab-content active">
                    <!-- 第一排：总收益卡片 + 收益结构图 -->
                    <div class="revenue-cards">
                        <!-- 总收益卡片 -->
                        <div class="revenue-card">
                            <!-- 卡片标题 -->
                            <h3 class="revenue-card-title-main">收益统计</h3>

                            <!-- 总利润行 -->
                            <div class="profit-row profit-row-main">
                                <span class="profit-label">总利润</span>
                                <span class="profit-value" id="totalProfitValue">¥0.00</span>
                                <div class="profit-compare" id="totalProfitCompare">
                                    <span class="compare-label">环比</span>
                                    <i class="fas fa-arrow-up"></i>
                                    <span>0%</span>
                                </div>
                            </div>

                            <!-- 卖电利润行 -->
                            <div class="profit-row">
                                <span class="profit-label">卖电利润</span>
                                <span class="profit-value" id="sellProfitDetail">¥0.00</span>
                                <div class="profit-compare" id="sellProfitCompare">
                                    <span class="compare-label">环比</span>
                                    <i class="fas fa-arrow-up"></i>
                                    <span>0%</span>
                                </div>
                            </div>

                            <!-- 自用节省行 -->
                            <div class="profit-row">
                                <span class="profit-label">自用节省</span>
                                <span class="profit-value" id="selfSavingDetail">¥0.00</span>
                                <div class="profit-compare" id="selfSavingCompare">
                                    <span class="compare-label">环比</span>
                                    <i class="fas fa-arrow-up"></i>
                                    <span>0%</span>
                                </div>
                            </div>
                        </div>

                        <!-- 收益结构图 -->
                        <div class="chart-container in-first-row">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-pie"></i>
                                    收益结构分析
                                </h3>
                            </div>
                            <div class="chart-body" id="revenueStructureChart"></div>
                        </div>
                    </div>


                    <!-- 图表行 -->
                    <div class="charts-row">
                        <!-- 收益趋势图 -->
                        <div class="chart-container full-width">
                            <div class="chart-header">
                                <h3 class="chart-title">
                                    <i class="fas fa-chart-line"></i>
                                    收益趋势分析
                                </h3>
                            </div>
                            <div class="chart-body" id="revenueTrendChart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="common.js"></script>
    <script>
        // 全局变量
        let currentDimension = 'monthly'; // 当前时间维度
        let statisticTimePicker = null; // flatpickr实例
        let revenueTrendChart = null; // 趋势图实例
        let revenueStructureChart = null; // 结构图实例
        let selectedSite = 'all'; // 选中的站点/设备
        let selectedLabel = '全部站点'; // 选中的设备名称

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            initStatisticTimePicker('monthly');
            initCharts();
            queryData();
        });

        // 切换树形视图显示/隐藏
        function toggleTreeView() {
            const treeView = document.getElementById('treeView');
            treeView.classList.toggle('active');
        }

        // 切换树节点展开/折叠
        function toggleTreeNode(event) {
            event.stopPropagation();
            const icon = event.currentTarget;
            const item = icon.parentElement;
            const children = item.nextElementSibling;

            if (children && children.classList.contains('tree-children')) {
                item.classList.toggle('expanded');
                children.classList.toggle('expanded');
            }
        }

        // 处理站点节点点击
        function handleSiteClick(event, value, label) {
            // 如果点击的是箭头图标,不处理选择逻辑
            if (event.target.classList.contains('tree-expand-icon')) {
                return;
            }

            event.stopPropagation();

            // 移除所有选中状态
            document.querySelectorAll('.tree-node-item').forEach(item => {
                item.classList.remove('selected');
            });

            // 添加选中状态
            event.currentTarget.classList.add('selected');

            // 记录选择的值
            selectedSite = value;
            selectedLabel = label;

            // 更新输入框显示
            document.getElementById('siteSelection').value = label;

            // 隐藏树形视图
            document.getElementById('treeView').classList.remove('active');
        }

        // 选择树节点
        function selectTreeNode(event, value, label) {
            event.stopPropagation();

            // 移除所有选中状态
            document.querySelectorAll('.tree-node-item').forEach(item => {
                item.classList.remove('selected');
            });

            // 添加选中状态
            event.currentTarget.classList.add('selected');

            // 记录选择的值
            selectedSite = value;
            selectedLabel = label;

            // 更新输入框显示
            document.getElementById('siteSelection').value = label;

            // 隐藏树形视图
            document.getElementById('treeView').classList.remove('active');
        }

        // 点击页面其他地方关闭树形视图
        document.addEventListener('click', function(event) {
            const treeView = document.getElementById('treeView');
            const hasTree = event.target.closest('.has-tree');

            if (!hasTree && treeView && treeView.classList.contains('active')) {
                treeView.classList.remove('active');
            }
        });

        // 初始化时间筛选器
        function initStatisticTimePicker(dimension) {
            const label = document.getElementById('timeFilterLabel');
            const input = document.getElementById('statisticTime');
            const yearSelect = document.getElementById('statisticTimeSelectYear');
            const today = new Date();

            if (statisticTimePicker) {
                statisticTimePicker.destroy();
                statisticTimePicker = null;
            }

            switch(dimension) {
                case 'daily':
                    label.textContent = '选择日期';
                    input.placeholder = '选择日期';
                    input.style.display = 'block';
                    yearSelect.style.display = 'none';

                    statisticTimePicker = flatpickr(input, {
                        locale: "zh",
                        dateFormat: "Y-m-d",
                        defaultDate: today,
                        clickOpens: true,
                        allowInput: false
                    });
                    break;

                case 'monthly':
                    label.textContent = '选择月份';
                    input.placeholder = '选择月份';
                    input.style.display = 'block';
                    yearSelect.style.display = 'none';

                    statisticTimePicker = flatpickr(input, {
                        locale: "zh",
                        dateFormat: "Y-m",
                        defaultDate: today,
                        clickOpens: true,
                        allowInput: false,
                        plugins: [
                            new window.monthSelectPlugin({
                                shorthand: true,
                                dateFormat: "Y-m",
                                altFormat: "Y年m月"
                            })
                        ]
                    });
                    break;

                case 'yearly':
                    label.textContent = '选择年份';
                    input.style.display = 'none';
                    yearSelect.style.display = 'block';

                    const currentYear = today.getFullYear();
                    let yearOptions = '';
                    for (let i = currentYear - 10; i <= currentYear + 5; i++) {
                        const selected = i === currentYear ? 'selected' : '';
                        yearOptions += `<option value="${i}" ${selected}>${i}年</option>`;
                    }
                    yearSelect.innerHTML = yearOptions;
                    break;
            }
        }

        // 切换时间维度
        function changeDimension(dimension) {
            currentDimension = dimension;
            initStatisticTimePicker(dimension);
        }

        // 年份选择变化
        function onYearSelectChange() {
            // 可以在这里添加自动查询逻辑
        }

        // 初始化图表
        function initCharts() {
            revenueTrendChart = echarts.init(document.getElementById('revenueTrendChart'));
            revenueStructureChart = echarts.init(document.getElementById('revenueStructureChart'));

            // 响应式
            window.addEventListener('resize', () => {
                if (revenueTrendChart) revenueTrendChart.resize();
                if (revenueStructureChart) revenueStructureChart.resize();
            });
        }

        // 查询数据
        function queryData() {
            showNotification('正在查询数据...', 'info');

            setTimeout(() => {
                loadTableData();
                updateTotalRevenueCard();
                updateRevenueTrendChart();
                updateRevenueStructureChart();
                showNotification('数据查询成功', 'success');
            }, 800);
        }

        // 加载表格数据
        function loadTableData() {
            const tbody = document.getElementById('revenueTableBody');
            let htmlContent = '';

            let totalChargeEnergy = 0;
            let totalChargeCost = 0;
            let totalSellEnergy = 0;
            let totalSellRevenue = 0;
            let totalSelfEnergy = 0;
            let totalSelfSaving = 0;

            if (currentDimension === 'daily') {
                // 日报：24小时数据
                // 基于真实215kWh储能柜：1充1放模式，每天充电108kWh，放电97kWh（考虑90%效率）
                // 充电时段：23:00-07:00（谷时段，8小时），放电时段：峰时段（8小时）
                // 卖电和自用各占50%，约48.5kWh
                const dailyChargeEnergy = 108; // kWh per day
                const dailyDischargeEnergy = 97; // kWh per day (108 * 0.9)
                const chargingHours = 8; // 充电时长
                const dischargingHours = 8; // 放电时长

                for (let i = 0; i < 24; i++) {
                    const hour = i.toString().padStart(2, '0') + ':00';
                    let chargeEnergy = 0;
                    let chargePrice = 0;
                    let sellEnergy = 0;
                    let selfEnergy = 0;

                    // 谷时段充电（23:00-07:00，8小时）
                    if (i >= 23 || i < 7) {
                        // 每小时约充电13.5kWh（108kWh / 8小时）
                        chargeEnergy = ((dailyChargeEnergy / chargingHours) + (Math.random() * 2 - 1)).toFixed(2);
                        chargePrice = (Math.random() * 0.1 + 0.25).toFixed(3); // 谷时电价 0.25-0.35元/kWh
                    }

                    // 峰时段1放电（08:00-11:00，3小时）
                    if (i >= 8 && i < 11) {
                        // 每小时约放电12kWh（97kWh / 8小时）
                        const hourlyDischarge = dailyDischargeEnergy / dischargingHours;
                        sellEnergy = ((hourlyDischarge / 2) + (Math.random() * 2 - 1)).toFixed(2);
                        selfEnergy = ((hourlyDischarge / 2) + (Math.random() * 2 - 1)).toFixed(2);
                    }
                    // 峰时段2放电（17:00-22:00，5小时）
                    else if (i >= 17 && i < 22) {
                        // 每小时约放电12kWh
                        const hourlyDischarge = dailyDischargeEnergy / dischargingHours;
                        sellEnergy = ((hourlyDischarge / 2) + (Math.random() * 2 - 1)).toFixed(2);
                        selfEnergy = ((hourlyDischarge / 2) + (Math.random() * 2 - 1)).toFixed(2);
                    }
                    // 其他时段不放电
                    else {
                        sellEnergy = '0.00';
                        selfEnergy = '0.00';
                    }

                    // 计算各项金额
                    const chargeCost = (parseFloat(chargeEnergy) * parseFloat(chargePrice || 0)).toFixed(2);
                    const sellPrice = (Math.random() * 0.3 + 0.8).toFixed(3); // 峰时卖电价格 0.8-1.1元/kWh
                    const sellIncome = (parseFloat(sellEnergy) * parseFloat(sellPrice)).toFixed(2);
                    const selfPrice = (Math.random() * 0.2 + 0.6).toFixed(3); // 自用节省单价 0.6-0.8元/kWh
                    const selfSaving = (parseFloat(selfEnergy) * parseFloat(selfPrice)).toFixed(2);

                    // 注意:此处暂时显示卖电收入,实际的卖电利润会在合计后重新计算
                    // 卖电利润 = 总卖电收入 - 总充电成本
                    const sellRevenue = sellIncome; // 暂时等于卖电收入
                    const totalRevenue = (parseFloat(sellRevenue) + parseFloat(selfSaving)).toFixed(2);

                    totalChargeEnergy += parseFloat(chargeEnergy);
                    totalChargeCost += parseFloat(chargeCost);
                    totalSellEnergy += parseFloat(sellEnergy);
                    totalSellRevenue += parseFloat(sellRevenue);
                    totalSelfEnergy += parseFloat(selfEnergy);
                    totalSelfSaving += parseFloat(selfSaving);

                    const netProfit = (parseFloat(totalRevenue) - parseFloat(chargeCost)).toFixed(2);
                    const netProfitClass = parseFloat(netProfit) >= 0 ? 'value-positive' : 'value-negative';
                    const totalRevenueClass = parseFloat(totalRevenue) >= 0 ? 'value-positive' : 'value-negative';

                    htmlContent += `
                        <tr>
                            <td>${hour}</td>
                            <td>${selectedLabel}</td>
                            <td>¥${chargeCost}</td>
                            <td>¥${sellRevenue}</td>
                            <td class="${netProfitClass}">¥${netProfit}</td>
                            <td>¥${selfSaving}</td>
                            <td class="${totalRevenueClass}">¥${totalRevenue}</td>
                        </tr>
                    `;
                }

                // 日报:重新计算卖电利润(卖电收入合计 - 充电成本合计)
                totalSellRevenue = totalSellRevenue - totalChargeCost;
            } else if (currentDimension === 'monthly') {
                // 月报：30天数据
                // 基于真实储能柜：1充1放模式，每天充电108kWh，放电97kWh
                const dailyChargeEnergy = 108; // kWh per day
                const dailyDischargeEnergy = 97; // kWh per day (108 * 0.9)
                const dailySellEnergy = dailyDischargeEnergy / 2; // 卖电和自用各占50%
                const dailySelfEnergy = dailyDischargeEnergy / 2;

                // 获取当前选择的年月
                const selectedDate = statisticTimePicker ? statisticTimePicker.selectedDates[0] : new Date();
                const year = selectedDate.getFullYear();
                const month = (selectedDate.getMonth() + 1).toString().padStart(2, '0');

                for (let i = 1; i <= 30; i++) {
                    const dayNum = i.toString().padStart(2, '0');
                    const day = `${year}-${month}-${dayNum}`;
                    // 添加±5kWh随机波动
                    const chargeEnergy = (dailyChargeEnergy + (Math.random() * 10 - 5)).toFixed(2);
                    const chargePrice = (Math.random() * 0.1 + 0.25).toFixed(3); // 谷时电价 0.25-0.35元/kWh
                    const chargeCost = (parseFloat(chargeEnergy) * parseFloat(chargePrice)).toFixed(2);

                    const sellEnergy = (dailySellEnergy + (Math.random() * 5 - 2.5)).toFixed(2);
                    const sellPrice = (Math.random() * 0.3 + 0.8).toFixed(3); // 峰时卖电价格 0.8-1.1元/kWh
                    const sellIncome = (parseFloat(sellEnergy) * parseFloat(sellPrice)).toFixed(2);

                    const selfEnergy = (dailySelfEnergy + (Math.random() * 5 - 2.5)).toFixed(2);
                    const selfPrice = (Math.random() * 0.2 + 0.6).toFixed(3); // 自用节省单价 0.6-0.8元/kWh
                    const selfSaving = (parseFloat(selfEnergy) * parseFloat(selfPrice)).toFixed(2);

                    // 卖电利润 = 卖电收入 - 充电成本
                    const sellRevenue = (parseFloat(sellIncome) - parseFloat(chargeCost)).toFixed(2);
                    const totalRevenue = (parseFloat(sellRevenue) + parseFloat(selfSaving)).toFixed(2);

                    totalChargeEnergy += parseFloat(chargeEnergy);
                    totalChargeCost += parseFloat(chargeCost);
                    totalSellEnergy += parseFloat(sellEnergy);
                    totalSellRevenue += parseFloat(sellRevenue);
                    totalSelfEnergy += parseFloat(selfEnergy);
                    totalSelfSaving += parseFloat(selfSaving);

                    const netProfit = (parseFloat(totalRevenue) - parseFloat(chargeCost)).toFixed(2);
                    const netProfitClass = parseFloat(netProfit) >= 0 ? 'value-positive' : 'value-negative';
                    const totalRevenueClass = parseFloat(totalRevenue) >= 0 ? 'value-positive' : 'value-negative';

                    htmlContent += `
                        <tr>
                            <td>${day}</td>
                            <td>${selectedLabel}</td>
                            <td>¥${chargeCost}</td>
                            <td>¥${sellRevenue}</td>
                            <td class="${netProfitClass}">¥${netProfit}</td>
                            <td>¥${selfSaving}</td>
                            <td class="${totalRevenueClass}">¥${totalRevenue}</td>
                        </tr>
                    `;
                }
            } else {
                // 年报：12个月数据
                // 基于真实储能柜：1充1放模式，每天充电108kWh，放电97kWh
                // 每月约：充电108kWh × 天数，放电97kWh × 天数（根据实际天数调整）
                const daysInMonth = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]; // 2024年（闰年）
                const dailyChargeEnergy = 108; // kWh per day
                const dailyDischargeEnergy = 97; // kWh per day (108 * 0.9)
                const dailySellEnergy = dailyDischargeEnergy / 2; // 卖电和自用各占50%
                const dailySelfEnergy = dailyDischargeEnergy / 2;

                // 获取当前选择的年份
                const yearSelect = document.getElementById('statisticTimeSelectYear');
                const selectedYear = yearSelect.value || new Date().getFullYear();

                for (let i = 0; i < 12; i++) {
                    const monthNum = (i + 1).toString().padStart(2, '0');
                    const monthLabel = `${selectedYear}-${monthNum}`;
                    // 添加±5%随机波动
                    const chargeEnergy = ((dailyChargeEnergy * daysInMonth[i]) * (0.95 + Math.random() * 0.1)).toFixed(2);
                    const chargePrice = (Math.random() * 0.1 + 0.25).toFixed(3); // 谷时电价 0.25-0.35元/kWh
                    const chargeCost = (parseFloat(chargeEnergy) * parseFloat(chargePrice)).toFixed(2);

                    const sellEnergy = ((dailySellEnergy * daysInMonth[i]) * (0.95 + Math.random() * 0.1)).toFixed(2);
                    const sellPrice = (Math.random() * 0.3 + 0.8).toFixed(3); // 峰时卖电价格 0.8-1.1元/kWh
                    const sellIncome = (parseFloat(sellEnergy) * parseFloat(sellPrice)).toFixed(2);

                    const selfEnergy = ((dailySelfEnergy * daysInMonth[i]) * (0.95 + Math.random() * 0.1)).toFixed(2);
                    const selfPrice = (Math.random() * 0.2 + 0.6).toFixed(3); // 自用节省单价 0.6-0.8元/kWh
                    const selfSaving = (parseFloat(selfEnergy) * parseFloat(selfPrice)).toFixed(2);

                    // 卖电利润 = 卖电收入 - 充电成本
                    const sellRevenue = (parseFloat(sellIncome) - parseFloat(chargeCost)).toFixed(2);
                    const totalRevenue = (parseFloat(sellRevenue) + parseFloat(selfSaving)).toFixed(2);

                    totalChargeEnergy += parseFloat(chargeEnergy);
                    totalChargeCost += parseFloat(chargeCost);
                    totalSellEnergy += parseFloat(sellEnergy);
                    totalSellRevenue += parseFloat(sellRevenue);
                    totalSelfEnergy += parseFloat(selfEnergy);
                    totalSelfSaving += parseFloat(selfSaving);

                    const netProfit = (parseFloat(totalRevenue) - parseFloat(chargeCost)).toFixed(2);
                    const netProfitClass = parseFloat(netProfit) >= 0 ? 'value-positive' : 'value-negative';
                    const totalRevenueClass = parseFloat(totalRevenue) >= 0 ? 'value-positive' : 'value-negative';

                    htmlContent += `
                        <tr>
                            <td>${monthLabel}</td>
                            <td>${selectedLabel}</td>
                            <td>¥${chargeCost}</td>
                            <td>¥${sellRevenue}</td>
                            <td class="${netProfitClass}">¥${netProfit}</td>
                            <td>¥${selfSaving}</td>
                            <td class="${totalRevenueClass}">¥${totalRevenue}</td>
                        </tr>
                    `;
                }
            }

            tbody.innerHTML = htmlContent;

            // 更新合计（仅更新存在的DOM元素）
            const totalRevenue = totalSellRevenue + totalSelfSaving;
            const totalNetProfit = totalRevenue - totalChargeCost;

            // 更新数值
            document.getElementById('summaryChargeCost').textContent = '¥' + totalChargeCost.toFixed(2);
            document.getElementById('summarySellRevenue').textContent = '¥' + totalSellRevenue.toFixed(2);
            document.getElementById('summaryNetProfit').textContent = '¥' + totalNetProfit.toFixed(2);
            document.getElementById('summarySelfSaving').textContent = '¥' + totalSelfSaving.toFixed(2);
            document.getElementById('summaryTotalRevenue').textContent = '¥' + totalRevenue.toFixed(2);

            // 添加颜色类
            const netProfitElement = document.getElementById('summaryNetProfit');
            const totalRevenueElement = document.getElementById('summaryTotalRevenue');

            // 移除旧的颜色类
            netProfitElement.classList.remove('value-positive', 'value-negative');
            totalRevenueElement.classList.remove('value-positive', 'value-negative');

            // 根据正负值添加颜色类
            if (totalNetProfit >= 0) {
                netProfitElement.classList.add('value-positive');
            } else {
                netProfitElement.classList.add('value-negative');
            }

            if (totalRevenue >= 0) {
                totalRevenueElement.classList.add('value-positive');
            } else {
                totalRevenueElement.classList.add('value-negative');
            }
        }

        // 更新总收益卡片
        function updateTotalRevenueCard() {
            // 从汇总行获取数据
            const sellRevenue = parseFloat(document.getElementById('summarySellRevenue').textContent.replace('¥', ''));
            const selfSaving = parseFloat(document.getElementById('summarySelfSaving').textContent.replace('¥', ''));
            const totalRevenue = parseFloat(document.getElementById('summaryTotalRevenue').textContent.replace('¥', ''));

            // 生成模拟的上期数据（实际应用中从后端获取）
            const lastSellRevenue = sellRevenue * (0.85 + Math.random() * 0.3); // 上期数据波动±15%
            const lastSelfSaving = selfSaving * (0.85 + Math.random() * 0.3);
            const lastTotalRevenue = totalRevenue * (0.85 + Math.random() * 0.3);

            // 更新总利润
            document.getElementById('totalProfitValue').textContent = '¥' + totalRevenue.toFixed(2);
            updateCompareValue('totalProfitCompare', totalRevenue, lastTotalRevenue);

            // 更新卖电利润
            document.getElementById('sellProfitDetail').textContent = '¥' + sellRevenue.toFixed(2);
            updateCompareValue('sellProfitCompare', sellRevenue, lastSellRevenue);

            // 更新自用节省
            document.getElementById('selfSavingDetail').textContent = '¥' + selfSaving.toFixed(2);
            updateCompareValue('selfSavingCompare', selfSaving, lastSelfSaving);
        }

        // 更新对比值显示
        function updateCompareValue(elementId, currentValue, lastValue) {
            const element = document.getElementById(elementId);
            const diff = currentValue - lastValue;
            const percentage = lastValue !== 0 ? (diff / lastValue * 100) : 0;

            // 移除旧的class
            element.classList.remove('increase', 'decrease');

            // 设置图标和class
            const icon = element.querySelector('i');
            if (diff > 0) {
                element.classList.add('increase');
                icon.className = 'fas fa-arrow-up';
            } else if (diff < 0) {
                element.classList.add('decrease');
                icon.className = 'fas fa-arrow-down';
            } else {
                icon.className = 'fas fa-minus';
            }

            // 更新文本 - 新结构只显示百分比
            const spans = element.querySelectorAll('span');
            const valueSpan = spans[spans.length - 1]; // 最后一个span
            const sign = diff > 0 ? '+' : '';
            valueSpan.textContent = `${sign}${percentage.toFixed(1)}%`;
        }

        // 更新收益趋势图 - 基于表格数据
        function updateRevenueTrendChart() {
            const xAxisData = [];
            const sellRevenueData = [];
            const selfSavingData = [];
            const totalRevenueData = [];

            // 从表格中读取数据
            const tableRows = document.querySelectorAll('#revenueTableBody tr');

            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');

                // 提取数据
                const time = cells[0].textContent.trim();  // 时间
                const sellRevenue = cells[3].textContent.replace('¥', '').trim();  // 卖电利润
                const selfSaving = cells[5].textContent.replace('¥', '').trim();   // 自用节省
                const totalRevenue = cells[6].textContent.replace('¥', '').trim(); // 总收益

                // 添加到数组
                xAxisData.push(time);
                sellRevenueData.push(parseFloat(sellRevenue));
                selfSavingData.push(parseFloat(selfSaving));
                totalRevenueData.push(parseFloat(totalRevenue));
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        let total = 0;
                        params.forEach(item => {
                            result += item.marker + ' ' + item.seriesName + ': ¥' + item.value + '<br/>';
                            total += parseFloat(item.value);
                        });
                        result += '<strong>总收益: ¥' + total.toFixed(2) + '</strong>';
                        return result;
                    }
                },
                legend: {
                    data: ['卖电利润', '自用节省'],
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    boundaryGap: true,
                    data: xAxisData
                },
                yAxis: {
                    type: 'value',
                    axisLabel: {
                        formatter: '¥{value}'
                    }
                },
                series: [
                    {
                        name: '卖电利润',
                        type: 'bar',
                        stack: 'revenue',
                        data: sellRevenueData,
                        itemStyle: {
                            color: '#10b981'
                        },
                        barMaxWidth: 60
                    },
                    {
                        name: '自用节省',
                        type: 'bar',
                        stack: 'revenue',
                        data: selfSavingData,
                        itemStyle: {
                            color: '#3b82f6'
                        },
                        barMaxWidth: 60
                    }
                ]
            };

            revenueTrendChart.setOption(option);
        }

        // 更新收益结构图
        function updateRevenueStructureChart() {
            const sellRevenue = parseFloat(document.getElementById('summarySellRevenue').textContent.replace('¥', ''));
            const selfSaving = parseFloat(document.getElementById('summarySelfSaving').textContent.replace('¥', ''));

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: '{a} <br/>{b}: ¥{c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'center'
                },
                series: [
                    {
                        name: '收益构成',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        avoidLabelOverlap: false,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            formatter: '{b}\n¥{c}\n({d}%)'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 16,
                                fontWeight: 'bold'
                            }
                        },
                        data: [
                            {
                                value: sellRevenue.toFixed(2),
                                name: '卖电利润',
                                itemStyle: { color: '#10b981' }
                            },
                            {
                                value: selfSaving.toFixed(2),
                                name: '自用节省',
                                itemStyle: { color: '#3b82f6' }
                            }
                        ]
                    }
                ]
            };

            revenueStructureChart.setOption(option);
        }

        // Tab切换
        function switchTab(tab) {
            // 更新Tab按钮状态
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.tab-btn').classList.add('active');

            // 切换内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // 获取导出按钮
            const exportButton = document.getElementById('exportButton');

            if (tab === 'table') {
                document.getElementById('tableView').classList.add('active');
                // 表格视图：显示导出按钮
                exportButton.style.display = 'flex';
            } else {
                document.getElementById('chartView').classList.add('active');
                // 图表视图：也显示导出按钮
                exportButton.style.display = 'flex';
                // 调整图表大小
                setTimeout(() => {
                    if (revenueTrendChart) revenueTrendChart.resize();
                    if (revenueStructureChart) revenueStructureChart.resize();
                }, 100);
            }
        }

        // 导出数据
        function exportData() {
            showNotification('正在导出数据...', 'info');
            setTimeout(() => {
                showNotification('数据导出成功', 'success');
            }, 1000);
        }

        // 通知函数
        function showNotification(message, type = 'info') {
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };

            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 24px;
                background: ${colors[type]};
                color: white;
                padding: 14px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease;
                font-size: 14px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>

    <style>
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</body>
</html>
