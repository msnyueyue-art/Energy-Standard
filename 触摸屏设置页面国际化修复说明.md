# 触摸屏设置页面国际化修复说明

## 修复日期
2026-01-15

## 问题描述

在触摸屏系统的**中文环境**下，点击设置菜单后，存在以下国际化问题：

### 问题1: Logo文本显示英文
- **显示**: "Energy Storage System"
- **期望**: "储能柜管理系统"（中文环境下）

### 问题2: 导航菜单显示英文
- **显示**: "Home, Data, History, Control, Alarm, Log, Settings"
- **期望**: "首页, 数据, 历史, 控制, 告警, 日志, 设置"（中文环境下）

### 问题3: 下拉选项显示英文
**锁定时间下拉菜单**:
- **显示**: "5 Minutes, 10 Minutes, 15 Minutes, 30 Minutes, 1 Hour, Never"
- **期望**: "5分钟, 10分钟, 15分钟, 30分钟, 1小时, 永不"（中文环境下）

**数据刷新间隔下拉菜单**:
- **显示**: "1 Second, 3 Seconds, 5 Seconds, 10 Seconds"
- **期望**: "1秒, 3秒, 5秒, 10秒"（中文环境下）

### 用户反馈截图位置
红框标记的部分：
- 顶部 Logo 文字
- 顶部导航菜单
- 锁定时间下拉选项
- 数据刷新间隔下拉选项

## 根本原因

### 原因分析

在 [touchscreen/settings.html](touchscreen/settings.html) 中：

1. **Logo 和导航菜单缺少 `data-i18n` 属性**（第1495-1507行）
   - Logo 文本没有 `data-i18n` 属性
   - 所有导航菜单项没有 `data-i18n` 属性

2. **下拉选项缺少 `data-i18n` 属性**（第1686-1691行、第1718-1721行）
   - 锁定时间的所有选项没有 `data-i18n` 属性
   - 刷新间隔的所有选项没有 `data-i18n` 属性

3. **翻译配置文件缺少时间单位翻译键**
   - [touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js) 中没有定义时间单位的翻译键

### 代码问题示例

```html
<!-- 修复前 -->
<div class="logo-text">Energy Storage System</div>
<div class="nav-item" onclick="smoothSwitchPage('home')">Home</div>
<option value="15" selected>15 Minutes</option>

<!-- 修复后 -->
<div class="logo-text" data-i18n="systemName">Energy Storage System</div>
<div class="nav-item" data-i18n="navHome" onclick="smoothSwitchPage('home')">Home</div>
<option value="15" selected data-i18n="fifteenMinutes">15 Minutes</option>
```

## 完整修复方案

### 修改文件
1. **HTML文件**: [touchscreen/settings.html](touchscreen/settings.html)
2. **翻译配置**: [touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js)

### 修复内容

#### 修复1: Logo文本添加 data-i18n 属性（第1495行）

```html
<!-- 修复前 -->
<div class="logo-text">Energy Storage System</div>

<!-- 修复后 -->
<div class="logo-text" data-i18n="systemName">Energy Storage System</div>
```

#### 修复2: 导航菜单添加 data-i18n 属性（第1501-1507行）

```html
<!-- 修复前 -->
<div class="nav-item" onclick="smoothSwitchPage('home')">Home</div>
<a href="#data" class="nav-item" onclick="smoothSwitchPage('data')">Data</a>
<a href="#" class="nav-item" onclick="smoothSwitchPage('history')">History</a>
<a href="#control" class="nav-item" onclick="smoothSwitchPage('control')">Control</a>
<a href="#alarm" class="nav-item" onclick="smoothSwitchPage('alarm')">Alarm</a>
<a href="#log" class="nav-item" onclick="smoothSwitchPage('log')">Log</a>
<a href="#settings" class="nav-item active" onclick="smoothSwitchPage('settings')">Settings</a>

<!-- 修复后 -->
<div class="nav-item" data-i18n="navHome" onclick="smoothSwitchPage('home')">Home</div>
<a href="#data" class="nav-item" data-i18n="navData" onclick="smoothSwitchPage('data')">Data</a>
<a href="#" class="nav-item" data-i18n="navHistory" onclick="smoothSwitchPage('history')">History</a>
<a href="#control" class="nav-item" data-i18n="navControl" onclick="smoothSwitchPage('control')">Control</a>
<a href="#alarm" class="nav-item" data-i18n="navAlarm" onclick="smoothSwitchPage('alarm')">Alarm</a>
<a href="#log" class="nav-item" data-i18n="navLog" onclick="smoothSwitchPage('log')">Log</a>
<a href="#settings" class="nav-item active" data-i18n="navSettings" onclick="smoothSwitchPage('settings')">Settings</a>
```

#### 修复3: 锁定时间下拉选项添加 data-i18n 属性（第1686-1691行）

```html
<!-- 修复前 -->
<select class="form-select" id="lockTimeout">
    <option value="5">5 Minutes</option>
    <option value="10">10 Minutes</option>
    <option value="15" selected>15 Minutes</option>
    <option value="30">30 Minutes</option>
    <option value="60">1 Hour</option>
    <option value="never">Never</option>
</select>

<!-- 修复后 -->
<select class="form-select" id="lockTimeout">
    <option value="5" data-i18n="fiveMinutes">5 Minutes</option>
    <option value="10" data-i18n="tenMinutes">10 Minutes</option>
    <option value="15" selected data-i18n="fifteenMinutes">15 Minutes</option>
    <option value="30" data-i18n="thirtyMinutes">30 Minutes</option>
    <option value="60" data-i18n="oneHour">1 Hour</option>
    <option value="never" data-i18n="never">Never</option>
</select>
```

#### 修复4: 刷新间隔下拉选项添加 data-i18n 属性（第1718-1721行）

```html
<!-- 修复前 -->
<select class="form-select" id="refreshInterval">
    <option value="1">1 Second</option>
    <option value="3" selected>3 Seconds</option>
    <option value="5">5 Seconds</option>
    <option value="10">10 Seconds</option>
</select>

<!-- 修复后 -->
<select class="form-select" id="refreshInterval">
    <option value="1" data-i18n="oneSecond">1 Second</option>
    <option value="3" selected data-i18n="threeSeconds">3 Seconds</option>
    <option value="5" data-i18n="fiveSeconds">5 Seconds</option>
    <option value="10" data-i18n="tenSeconds">10 Seconds</option>
</select>
```

#### 修复5: 添加时间单位翻译键到翻译配置文件

**中文翻译**（第470-480行）：
```javascript
// 时间单位
oneSecond: '1秒',
threeSeconds: '3秒',
fiveSeconds: '5秒',
tenSeconds: '10秒',
fiveMinutes: '5分钟',
tenMinutes: '10分钟',
fifteenMinutes: '15分钟',
thirtyMinutes: '30分钟',
oneHour: '1小时',
never: '永不',
```

**英文翻译**（第1085-1095行）：
```javascript
// Time units
oneSecond: '1 Second',
threeSeconds: '3 Seconds',
fiveSeconds: '5 Seconds',
tenSeconds: '10 Seconds',
fiveMinutes: '5 Minutes',
tenMinutes: '10 Minutes',
fifteenMinutes: '15 Minutes',
thirtyMinutes: '30 Minutes',
oneHour: '1 Hour',
never: 'Never',
```

## 验证修复

### 修复后的代码结构

**HTML结构** (settings.html):
```html
<!-- Logo -->
<div class="logo-text" data-i18n="systemName">Energy Storage System</div>

<!-- 导航菜单 -->
<nav class="nav-menu">
    <div class="nav-item" data-i18n="navHome">Home</div>
    <a class="nav-item" data-i18n="navData">Data</a>
    <a class="nav-item" data-i18n="navHistory">History</a>
    <a class="nav-item" data-i18n="navControl">Control</a>
    <a class="nav-item" data-i18n="navAlarm">Alarm</a>
    <a class="nav-item" data-i18n="navLog">Log</a>
    <a class="nav-item active" data-i18n="navSettings">Settings</a>
</nav>

<!-- 锁定时间下拉 -->
<select id="lockTimeout">
    <option value="5" data-i18n="fiveMinutes">5 Minutes</option>
    <option value="10" data-i18n="tenMinutes">10 Minutes</option>
    <option value="15" selected data-i18n="fifteenMinutes">15 Minutes</option>
    <option value="30" data-i18n="thirtyMinutes">30 Minutes</option>
    <option value="60" data-i18n="oneHour">1 Hour</option>
    <option value="never" data-i18n="never">Never</option>
</select>

<!-- 刷新间隔下拉 -->
<select id="refreshInterval">
    <option value="1" data-i18n="oneSecond">1 Second</option>
    <option value="3" selected data-i18n="threeSeconds">3 Seconds</option>
    <option value="5" data-i18n="fiveSeconds">5 Seconds</option>
    <option value="10" data-i18n="tenSeconds">10 Seconds</option>
</select>
```

**翻译配置** (touchscreen-i18n.js):
```javascript
const touchscreenTranslations = {
    zh: {
        systemName: '储能柜管理系统',
        navHome: '首页',
        navData: '数据',
        navHistory: '历史',
        navControl: '控制',
        navAlarm: '告警',
        navLog: '日志',
        navSettings: '设置',

        // 时间单位
        oneSecond: '1秒',
        threeSeconds: '3秒',
        fiveSeconds: '5秒',
        tenSeconds: '10秒',
        fiveMinutes: '5分钟',
        tenMinutes: '10分钟',
        fifteenMinutes: '15分钟',
        thirtyMinutes: '30分钟',
        oneHour: '1小时',
        never: '永不'
    },
    en: {
        systemName: 'Energy Storage System',
        navHome: 'Home',
        navData: 'Data',
        navHistory: 'History',
        navControl: 'Control',
        navAlarm: 'Alarm',
        navLog: 'Log',
        navSettings: 'Settings',

        // Time units
        oneSecond: '1 Second',
        threeSeconds: '3 Seconds',
        fiveSeconds: '5 Seconds',
        tenSeconds: '10 Seconds',
        fiveMinutes: '5 Minutes',
        tenMinutes: '10 Minutes',
        fifteenMinutes: '15 Minutes',
        thirtyMinutes: '30 Minutes',
        oneHour: '1 Hour',
        never: 'Never'
    }
};
```

## 测试验证

### 中文环境测试
1. 设置语言为中文
2. 点击设置菜单
3. 验证显示：
   - ✅ Logo: "储能柜管理系统"
   - ✅ 导航菜单: "首页, 数据, 历史, 控制, 告警, 日志, 设置"
   - ✅ 锁定时间下拉: "5分钟, 10分钟, 15分钟, 30分钟, 1小时, 永不"
   - ✅ 刷新间隔下拉: "1秒, 3秒, 5秒, 10秒"

### 英文环境测试
1. 切换语言为英文
2. 导航至设置页面
3. 验证显示：
   - ✅ Logo: "Energy Storage System"
   - ✅ 导航菜单: "Home, Data, History, Control, Alarm, Log, Settings"
   - ✅ 锁定时间下拉: "5 Minutes, 10 Minutes, 15 Minutes, 30 Minutes, 1 Hour, Never"
   - ✅ 刷新间隔下拉: "1 Second, 3 Seconds, 5 Seconds, 10 Seconds"

### 语言切换测试
1. 在中文环境下查看设置页面 → 应显示中文
2. 点击语言切换按钮切换到英文 → 所有文本应立即显示英文
3. 切换回中文 → 所有文本应立即显示中文
4. 展开下拉菜单 → 选项应显示当前语言
5. ✅ 语言切换实时生效，无需刷新页面

### 下拉菜单交互测试
1. 点击锁定时间下拉菜单 → 展开显示所有选项（当前语言）
2. 选择不同选项 → 选项文本应保持当前语言
3. 切换语言 → 下拉选中项文本应更新为新语言
4. 再次展开下拉 → 所有选项应显示新语言

## 相关文件

- [touchscreen/settings.html](touchscreen/settings.html:1495) - Logo文本
- [touchscreen/settings.html](touchscreen/settings.html:1501-1507) - 导航菜单
- [touchscreen/settings.html](touchscreen/settings.html:1686-1691) - 锁定时间下拉选项
- [touchscreen/settings.html](touchscreen/settings.html:1718-1721) - 刷新间隔下拉选项
- [touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js:470-480) - 中文时间单位翻译
- [touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js:1085-1095) - 英文时间单位翻译

## 影响范围

### 直接影响
- **影响页面**: 触摸屏设置页面 (settings.html)
- **影响组件**:
  - Logo 文本
  - 顶部导航菜单（7个菜单项）
  - 锁定时间下拉菜单（6个选项）
  - 数据刷新间隔下拉菜单（4个选项）

### 用户体验改善
- ✅ 中文用户看到完整的中文界面
- ✅ 英文用户看到完整的英文界面
- ✅ Logo显示完整的系统名称
- ✅ 导航菜单正确翻译
- ✅ 下拉选项正确翻译
- ✅ 语言切换立即生效

### 向后兼容
- ✅ 完全兼容，不影响其他页面
- ✅ 翻译键添加到配置文件，统一管理
- ✅ 符合项目国际化架构规范

## 注意事项

1. ✅ 所有静态元素都添加了 `data-i18n` 属性
2. ✅ 所有翻译键都在中英文配置中定义
3. ✅ 下拉选项的 `data-i18n` 属性位置正确（在 `selected` 属性之后）
4. ⚠️ 设置页面没有动态生成内容，因此不需要手动调用翻译函数
5. ⚠️ 页面加载时的国际化由 `DOMContentLoaded` 事件自动处理
6. ⚠️ 语言切换由 `languageChanged` 事件自动触发翻译更新

## 国际化工作流程

### 页面加载时的翻译流程

```javascript
// 1. 页面加载完成
document.addEventListener('DOMContentLoaded', function() {
    const currentLang = getTouchscreenLang();  // 获取当前语言

    // 2. 如果是中文，应用翻译
    if (currentLang === 'zh') {
        applyTouchscreenTranslations();
    }
    // 3. 如果是英文，HTML默认就是英文，无需操作
});

// 4. 翻译函数查找所有 [data-i18n] 元素并替换文本
function applyTouchscreenTranslations() {
    const lang = getTouchscreenLang();

    document.querySelectorAll('[data-i18n]').forEach(elem => {
        const key = elem.getAttribute('data-i18n');
        const translation = touchscreenTranslations[lang][key];

        if (translation) {
            elem.textContent = translation;
        }
    });
}
```

### 语言切换时的翻译流程

```javascript
// 1. 用户点击语言切换按钮
function changeLanguage(lang) {
    // 2. 保存语言设置
    setTouchscreenLang(lang);

    // 3. 触发语言切换事件
    window.dispatchEvent(new CustomEvent('languageChanged', {
        detail: { lang: lang }
    }));
}

// 4. 所有页面监听语言切换事件
window.addEventListener('languageChanged', function(e) {
    // 5. 重新应用翻译
    if (typeof applyTouchscreenTranslations === 'function') {
        applyTouchscreenTranslations();
    }
});
```

## 与其他页面的一致性

### 相同的修复模式应用在：
1. **数据页面** - PCS 历史数据图表标题（已修复）
2. **历史页面** - Logo、导航、图表标题（已修复）
3. **控制页面** - Logo、导航、编辑按钮（已修复）
4. **告警页面** - 表格级别标签、操作按钮（已修复）
5. **设置页面** - Logo、导航、下拉选项（本次修复）

### 统一的国际化标准：
```html
<!-- 静态元素添加 data-i18n 属性 -->
<div data-i18n="key">Default English Text</div>

<!-- 下拉选项添加 data-i18n 属性 -->
<option value="val" data-i18n="key">Default English Text</option>

<!-- 翻译配置必须包含中英文 -->
zh: { key: '中文文本' }
en: { key: 'English Text' }
```

## 完整的翻译键列表

### 系统相关
```javascript
zh: { systemName: '储能柜管理系统' }
en: { systemName: 'Energy Storage System' }
```

### 导航菜单
```javascript
zh: {
    navHome: '首页',
    navData: '数据',
    navHistory: '历史',
    navControl: '控制',
    navAlarm: '告警',
    navLog: '日志',
    navSettings: '设置'
}
en: {
    navHome: 'Home',
    navData: 'Data',
    navHistory: 'History',
    navControl: 'Control',
    navAlarm: 'Alarm',
    navLog: 'Log',
    navSettings: 'Settings'
}
```

### 时间单位 - 秒
```javascript
zh: {
    oneSecond: '1秒',
    threeSeconds: '3秒',
    fiveSeconds: '5秒',
    tenSeconds: '10秒'
}
en: {
    oneSecond: '1 Second',
    threeSeconds: '3 Seconds',
    fiveSeconds: '5 Seconds',
    tenSeconds: '10 Seconds'
}
```

### 时间单位 - 分钟
```javascript
zh: {
    fiveMinutes: '5分钟',
    tenMinutes: '10分钟',
    fifteenMinutes: '15分钟',
    thirtyMinutes: '30分钟'
}
en: {
    fiveMinutes: '5 Minutes',
    tenMinutes: '10 Minutes',
    fifteenMinutes: '15 Minutes',
    thirtyMinutes: '30 Minutes'
}
```

### 时间单位 - 小时和其他
```javascript
zh: {
    oneHour: '1小时',
    never: '永不'
}
en: {
    oneHour: '1 Hour',
    never: 'Never'
}
```

## 经验总结

### 这次问题的教训

1. **静态元素国际化**：页面上所有用户可见的文本都应该添加 `data-i18n` 属性
2. **下拉选项特殊处理**：`<option>` 元素也需要 `data-i18n` 属性才能翻译
3. **翻译键命名规范**：使用驼峰命名法，清晰表达含义（如 `fifteenMinutes`）
4. **中英文对应完整**：每个翻译键必须在中英文配置中都存在
5. **HTML默认语言**：HTML默认文本应该是英文，中文通过翻译函数动态替换

### 如何避免类似问题

1. **开发规范**：
   ```html
   <!-- 任何用户可见的文本都要添加 data-i18n -->
   <div data-i18n="key">English Text</div>
   <option value="1" data-i18n="key">English Text</option>
   <button data-i18n="key">English Text</button>
   ```

2. **翻译配置检查清单**：
   - [ ] HTML中有 `data-i18n` 属性
   - [ ] 中文翻译配置中有对应的键值对
   - [ ] 英文翻译配置中有对应的键值对
   - [ ] 翻译键命名符合规范（驼峰命名）
   - [ ] 中英文翻译文本准确无误

3. **测试流程**：
   - 英文环境下查看所有文本
   - 中文环境下查看所有文本
   - 语言切换测试
   - 下拉菜单展开测试

## 总结

本次修复解决了触摸屏设置页面的国际化问题：

### 核心修复
1. **Logo和导航菜单**：添加 `data-i18n` 属性
2. **下拉选项**：添加 `data-i18n` 属性
3. **翻译配置**：添加时间单位翻译键

### 修复位置
- [touchscreen/settings.html](touchscreen/settings.html:1495,1501-1507,1686-1691,1718-1721)
- [touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js:470-480,1085-1095)

### 修复效果
- ✅ 中文环境显示完整中文界面（Logo、菜单、选项）
- ✅ 英文环境显示完整英文界面（Logo、菜单、选项）
- ✅ 语言切换立即生效
- ✅ 下拉选项正确翻译
- ✅ 符合项目国际化架构规范

### 关键要点
**静态HTML元素 + data-i18n属性 + 翻译配置 = 完整的国际化支持**

这是触摸屏系统国际化架构的核心原则，适用于所有页面的静态内容。
