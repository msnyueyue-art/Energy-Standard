<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>储能柜详情 - 储能柜管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .detail-container {
            display: flex;
            height: calc(100vh - 60px);
            background: #f5f5f5;
        }
        
        .cabinet-3d-container {
            flex: 0 0 35%;
            position: relative;
            background: #e5e5e5;
        }
        
        .component-annotations {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        .annotation {
            position: absolute;
            color: #ffffff;
            font-size: 20px;
            font-weight: 600;
            white-space: nowrap;
            pointer-events: auto;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .annotation:hover {
            background: rgba(0, 0, 0, 0.5);
            transform: scale(1.1);
        }
        
        .annotation-line {
            position: absolute;
            background: #ffffff;
            height: 2px;
            transform-origin: left center;
            pointer-events: none;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }
        
        .data-panel {
            flex: 1;
            background: white;
            overflow-y: auto;
            box-shadow: -4px 0 20px rgba(0,0,0,0.08);
        }
        
        [data-theme="dark"] .data-panel {
            background: #1e293b;
        }
        
        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            height: auto;
            padding: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            transition: all 0.3s;
        }

        .back-button:hover {
            color: #3b82f6;
        }

        /* 闪烁标记点样式 */
        .blinking-marker {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #3b82f6;
            border: 3px solid #ffffff;
            border-radius: 50%;
            cursor: pointer;
            z-index: 20;
            animation: blink 1.5s infinite;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .blinking-marker::after {
            content: '';
            position: absolute;
            top: -6px;
            left: -6px;
            right: -6px;
            bottom: -6px;
            border: 2px solid rgba(59, 130, 246, 0.6);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* 告警灯闪烁动画 - 状态点 */
        @keyframes alarm-blink-flat {
            0%, 45% {
                opacity: 1;
            }
            50%, 95% {
                opacity: 0.3;
            }
            100% {
                opacity: 1;
            }
        }

        /* 告警卡片光晕动画 - 浅色版本 */
        @keyframes alarm-card-glow-light {
            0%, 45% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 0 12px rgba(239,68,68,0.3);
            }
            50%, 95% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 0 4px rgba(239,68,68,0.15);
            }
            100% {
                box-shadow: 0 2px 8px rgba(0,0,0,0.1), 0 0 12px rgba(239,68,68,0.3);
            }
        }

        .marker-line {
            position: absolute;
            background: #10b981;
            height: 1px;
            transform-origin: left center;
            z-index: 15;
        }

        .marker-label {
            position: absolute;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 16;
        }
        
        
        
        .cabinet-name {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .cabinet-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.online {
            background: #10b981;
        }
        
        .status-dot.offline {
            background: #f59e0b;
        }
        
        .status-dot.fault {
            background: #ef4444;
        }
        
        .data-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-btn {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            color: #374151;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .settings-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* ==================== 纯黑高级升级按钮设计 ==================== */

        /* 升级按钮 - 纯黑高级质感 */
        .upgrade-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 28px 10px 20px;  /* 右侧增加空间给角标 */
            margin-right: 6px;  /* 给角标留出空间 */
            background: #000000;  /* 纯黑色 */
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            cursor: pointer;
            overflow: visible;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                0 4px 12px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        /* 箭头图标 */
        .upgrade-btn i {
            position: relative;
            z-index: 2;
            font-size: 14px;
        }

        /* 按钮文字（排除角标） */
        .upgrade-btn > span:not(.upgrade-badge) {
            position: relative;
            z-index: 2;
        }

        /* 悬停状态 */
        .upgrade-btn:hover {
            background: #1a1a1a;
            border-color: rgba(255, 255, 255, 0.25);
            box-shadow:
                0 6px 16px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* 激活状态 */
        .upgrade-btn:active {
            transform: translateY(0);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.4),
                inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* ---------- 定制角标 ---------- */
        .upgrade-badge {
            position: absolute;
            top: -10px;
            right: -18px;
            padding: 3px 8px;
            background: linear-gradient(135deg,
                #fbbf24 0%,
                #f59e0b 50%,
                #d97706 100%
            );
            border-radius: 6px;
            font-size: 10px;
            font-weight: 700;
            color: #451a03;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            z-index: 10;
            box-shadow:
                0 4px 8px rgba(251, 191, 36, 0.4),
                0 2px 4px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            animation: badgeFloat 3s ease-in-out infinite;
            white-space: nowrap;
        }

        /* ---------- 动画定义 ---------- */

        /* 角标浮动 */
        @keyframes badgeFloat {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-2px);
            }
        }

        .component-tabs {
            display: flex;
            overflow-x: auto;
            scrollbar-width: thin;
            background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%);
            padding: 8px 16px;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-bottom: 1px solid rgba(0,0,0,0.06);
        }
        
        .component-tab {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            background: transparent;
            border: 2px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            border-radius: 8px;
            position: relative;
            letter-spacing: 0.3px;
        }
        
        .component-tab:hover {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.08);
            border-color: #3b82f6;
            transform: translateY(-1px);
        }
        
        .component-tab.active {
            color: white;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }
        
        .component-tab.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #2563eb;
        }
        
        [data-theme="dark"] .component-tabs {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-bottom-color: rgba(255,255,255,0.06);
        }
        
        [data-theme="dark"] .component-tab {
            color: #94a3b8;
            border-color: #334155;
        }
        
        [data-theme="dark"] .component-tab:hover {
            color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
            border-color: #60a5fa;
        }
        
        [data-theme="dark"] .component-tab.active {
            color: white;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-color: transparent;
        }
        
        .data-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            padding: 0 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        
        [data-theme="dark"] .data-tabs {
            background: #1e293b;
            border-bottom-color: rgba(255,255,255,0.06);
        }
        
        .data-tab {
            flex: 1;
            padding: 16px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: #64748b;
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .data-tab:hover {
            color: #334155;
        }
        
        .data-tab.active {
            color: #3b82f6;
            font-weight: 600;
        }
        
        .data-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 3px 3px 0 0;
            box-shadow: 0 -2px 8px rgba(59, 130, 246, 0.3);
        }
        
        [data-theme="dark"] .data-tab {
            color: #94a3b8;
        }
        
        [data-theme="dark"] .data-tab:hover {
            color: #cbd5e1;
        }
        
        [data-theme="dark"] .data-tab.active {
            color: #60a5fa;
        }
        
        .data-content {
            padding: 24px;
        }
        
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
        }
        
        /* 系统信息卡片专用样式 */
        .system-info .metric-card {
            height: 123px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
        }
        
        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .metric-unit {
            font-size: 14px;
            font-weight: 400;
            color: var(--text-secondary);
            margin-left: 4px;
        }
        
        .metric-status {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .metric-status.good {
            color: #10b981;
        }
        
        .metric-status.warning {
            color: #f59e0b;
        }
        
        .metric-status.critical {
            color: #ef4444;
        }
        
        .chart-container {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        
        .chart-wrapper {
            height: 200px;
        }
        
        .alert-section {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .alert-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .alert-item {
            font-size: 13px;
            color: #78350f;
            margin-bottom: 4px;
        }
        
        .time-range-btn {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .time-range-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .time-range-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* 手动模式按钮样式 */
        .manual-mode-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .manual-mode-btn:active {
            transform: translateY(0);
        }
        
        .manual-mode-btn:disabled {
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        /* Toast 动画 */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body data-page="devices">
    <!-- Navbar将由navbar.js自动插入 -->

    <!-- 主内容区域 -->
    <main class="main-content" id="mainContent" style="padding: 0;">
        <div class="detail-container">
            <!-- 3D模型容器 -->
            <div class="cabinet-3d-container" style="position: relative;">
                <!-- 设备控制按钮 - 已隐藏 -->
                <div style="position: absolute; top: 80px; right: 0; z-index: 100; display: none;">
                    <button onclick="openDeviceControlPanel()" style="
                        writing-mode: vertical-rl;
                        text-orientation: upright;
                        padding: 15px 8px;
                        background: linear-gradient(135deg, #3562E3 0%, #4f46e5 100%);
                        color: white;
                        border: none;
                        border-radius: 8px 0 0 8px;
                        cursor: pointer;
                        transition: all 0.3s;
                        font-size: 14px;
                        font-weight: 500;
                        box-shadow: -4px 0 12px rgba(53, 98, 227, 0.2);
                        letter-spacing: 3px;
                        height: auto;
                        min-height: 90px;
                        width: 32px;
                        line-height: 1;
                        white-space: nowrap;
                    " onmouseover="this.style.transform='translateX(-3px)'; this.style.boxShadow='-6px 0 16px rgba(53, 98, 227, 0.3)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='-4px 0 12px rgba(53, 98, 227, 0.2)'">
                        设备控制
                    </button>
                </div>
                
                <!-- 储能柜图片展示 -->
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1;">
                    <div style="position: relative; display: inline-block;">
                        <img src="柜子打开.png" id="cabinetStructureImg" alt="储能柜内部结构" style="max-width: 90%; max-height: 70vh; object-fit: contain;">
                        
                        <!-- 组件标记点 -->
                        <!-- EMS控制器 (顶部白色控制盒) -->
                        <div class="blinking-marker" style="top: 15%; left: 48%;" onclick="switchComponent('ems')"></div>
                        <div class="marker-label" style="top: 13%; left: 56%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="emsMarkerLabel" onclick="switchComponent('ems')">
                            <span style="font-weight: 500; color: #333333;" data-translate="cabinetComponentEMS">EMS</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="emsMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="emsMarkerStatusText" data-translate="statusOnline">在线</span>
                            </div>
                        </div>
                        
                        <!-- PCS逆变器 (中间黑色大模块) -->
                        <div class="blinking-marker" style="top: 35%; left: 20%;" onclick="switchComponent('pcs')"></div>
                        <div class="marker-label" style="top: 33%; left: -22%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #ef4444; cursor: pointer;" id="pcsMarkerLabel" onclick="switchComponent('pcs')">
                            <span style="font-weight: 500; color: #333333;" data-translate="cabinetComponentPCS">逆变器</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot fault" id="pcsMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #ef4444;" id="pcsMarkerStatusText" data-translate="statusAbnormal">异常</span>
                            </div>
                        </div>
                        
                        <!-- BMS系统 (PCS下方的黑色模块) -->
                        <div class="blinking-marker" style="top: 45%; left: 45%;" onclick="switchComponent('bms')"></div>
                        <div class="marker-label" style="top: 43%; left: 3%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="bmsMarkerLabel" onclick="switchComponent('bms')">
                            <span style="font-weight: 500; color: #333333;" data-translate="cabinetComponentBMS">BMS</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="bmsMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="bmsMarkerStatusText" data-translate="statusOnline">在线</span>
                            </div>
                        </div>
                        
                        <!-- 电表 (新增，放在合适位置) -->
                        <div class="blinking-marker" style="top: 21%; left: 25%;" onclick="switchComponent('meter')"></div>
                        <div class="marker-label" style="top: 17%; left: -17%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #f59e0b; cursor: pointer;" id="meterMarkerLabel" onclick="switchComponent('meter')">
                            <span style="font-weight: 500; color: #333333;" data-translate="cabinetComponentMeter">电表</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot offline" id="meterMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #f59e0b;" id="meterMarkerStatusText" data-translate="statusOffline">离线</span>
                            </div>
                        </div>
                        
                        <!-- 温度监测 (橙色线缆区域) -->
                        <div class="blinking-marker" style="top: 38%; left: 71%;" onclick="switchComponent('thermal')"></div>
                        <div class="marker-label" style="top: 36%; left: 79%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="thermalMarkerLabel" onclick="switchComponent('thermal')">
                            <span style="font-weight: 500; color: #333333;" data-translate="cabinetComponentThermal">温度</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="thermalMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="thermalMarkerStatusText" data-translate="statusOnline">在线</span>
                            </div>
                        </div>
                        
                        <!-- 消防系统 (底部红色管道) -->
                        <div class="blinking-marker" style="top: 85%; left: 50%;" onclick="switchComponent('fire')"></div>
                        <div class="marker-label" style="top: 83%; left: 58%; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.98); padding: 6px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); border: 2px solid #10b981; cursor: pointer;" id="fireMarkerLabel" onclick="switchComponent('fire')">
                            <span style="font-weight: 500; color: #333333;" data-translate="cabinetComponentFire">消防</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span class="status-dot online" id="fireMarkerStatusDot"></span>
                                <span style="font-size: 11px; color: #10b981;" id="fireMarkerStatusText" data-translate="statusOnline">在线</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 状态指示灯和急停开关卡片（模型上方） -->
                <div style="position: absolute; top: 120px; left: 20px; z-index: 5; max-width: 95%;">
                    <div style="background: rgba(255, 255, 255, 0.95); padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; gap: 16px; white-space: nowrap; min-width: max-content;">
                        <!-- 运行灯 -->
                        <div id="runningLight" style="display: flex; flex-direction: row; align-items: center; gap: 10px; flex-shrink: 0;">
                            <span style="font-size: 13px; font-weight: 500; color: #1f2937;">运行灯</span>
                            <i id="runningLightIcon" class="fas fa-lightbulb" style="font-size: 13px; color: #10b981; filter: drop-shadow(0 0 4px rgba(16,185,129,0.6));"></i>
                        </div>

                        <!-- 分隔线 -->
                        <div style="width: 1px; height: 20px; background: #e5e7eb; flex-shrink: 0;"></div>

                        <!-- 告警灯 -->
                        <div id="alarmLight" style="display: flex; flex-direction: row; align-items: center; gap: 10px; flex-shrink: 0;">
                            <span style="font-size: 13px; font-weight: 500; color: #1f2937;">告警灯</span>
                            <i id="alarmLightIcon" class="fas fa-lightbulb" style="font-size: 13px; color: #9ca3af;"></i>
                        </div>

                        <!-- 分隔线 -->
                        <div style="width: 1px; height: 20px; background: #e5e7eb; flex-shrink: 0;"></div>

                        <!-- 急停开关 -->
                        <div onclick="handleEmergencyStop()" style="display: flex; flex-direction: row; align-items: center; gap: 10px; cursor: pointer; transition: all 0.2s; flex-shrink: 0;" title="紧急停止" id="emergencyStopBtn">
                            <span style="font-size: 13px; font-weight: 500; color: #1f2937;">急停开关</span>
                            <!-- 自定义Toggle开关 -->
                            <div id="customToggle" style="position: relative; width: 44px; height: 24px; background: #d1d5db; border-radius: 12px; transition: all 0.3s; flex-shrink: 0;">
                                <div id="toggleCircle" style="position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 顶部信息栏 -->
                <div style="position: absolute; top: 20px; left: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 12px; max-width: calc(100% - 40px);">
                    <!-- 返回按钮 -->
                    <button class="back-button" onclick="goBack()" style="position: static;">
                        <i class="fas fa-arrow-left"></i>
                        <span data-translate="btnBack">返回</span>
                    </button>

                    <!-- 储能柜信息和导出按钮容器 -->
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: nowrap;">
                        <!-- 储能柜信息卡片 -->
                        <div style="display: flex; align-items: center; gap: 12px; background: rgba(255, 255, 255, 0.95); padding: 10px 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); white-space: nowrap; flex-shrink: 1;">
                            <h2 id="cabinetNameTop" style="margin: 0; font-size: 16px; font-weight: 600; color: #333; white-space: nowrap;"><span data-translate="cabinetName">储能柜</span> 001</h2>
                            <div style="width: 1px; height: 20px; background: #e5e7eb; flex-shrink: 0;"></div>
                            <div style="display: flex; align-items: center; gap: 6px; flex-shrink: 0;">
                                <span class="status-dot online" id="statusDotTop"></span>
                                <span id="statusTextTop" style="font-size: 13px; color: #666; white-space: nowrap;" data-translate="statusOnline">在线</span>
                            </div>
                            <div style="width: 1px; height: 20px; background: #e5e7eb; flex-shrink: 0;"></div>
                            <div id="operationStatusTop" style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666; font-weight: 500; flex-shrink: 0;">
                                <i class="fas fa-bolt" style="color: #10b981;"></i>
                                <span data-translate="cabinetStatusCharging" style="white-space: nowrap;">充电中</span>
                            </div>
                        </div>

                        <!-- 历史数据导出按钮 -->
                        <button onclick="navigateToExportPage()" style="height: 40px; padding: 0 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; white-space: nowrap; flex-shrink: 0;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                            <i class="fas fa-download"></i>
                            <span>历史数据导出</span>
                        </button>
                    </div>
                </div>
                
                <!-- 告警 -->
                <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; max-width: 95%;">
                    <div style="background: rgba(255, 255, 255, 0.95); padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: row; flex-wrap: nowrap; align-items: center; gap: 16px; white-space: nowrap; min-width: max-content;">
                        <!-- 告警图标和标题 -->
                        <div style="display: flex; flex-direction: row; align-items: center; gap: 8px; flex-shrink: 0;">
                            <div style="width: 32px; height: 32px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 14px; color: #f59e0b;"></i>
                            </div>
                            <span style="font-size: 13px; font-weight: 600; color: #1f2937;">告警</span>
                        </div>

                        <!-- 分隔线 -->
                        <div style="width: 1px; height: 32px; background: #e5e7eb; flex-shrink: 0;"></div>

                        <!-- 告警内容 -->
                        <div style="flex: 1; display: flex; flex-direction: row; align-items: center; justify-content: space-between; gap: 12px; min-width: 0;">
                            <div style="display: flex; align-items: center; gap: 6px; white-space: nowrap;">
                                <span style="font-size: 12px; color: #78350f; flex-shrink: 0;">•</span>
                                <span style="font-size: 12px; color: #78350f;">电池模组3温度偏高 (32.5°C)</span>
                            </div>
                            <span style="font-size: 11px; color: #9ca3af; flex-shrink: 0;">3分钟前</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 数据面板 -->
            <div class="data-panel" style="position: relative;">
                
                <!-- 组件选择标签页 -->
                <div class="component-tabs">
                    <button class="component-tab active" onclick="switchComponent('overall')" data-translate="cabinetTabOverall">整机</button>
                    <button class="component-tab" onclick="switchComponent('ems')" data-translate="cabinetTabEMS">EMS</button>
                    <button class="component-tab" onclick="switchComponent('pcs')" data-translate="cabinetTabPCS">逆变器</button>
                    <button class="component-tab" onclick="switchComponent('bms')" data-translate="cabinetTabBMS">BMS</button>
                    <button class="component-tab" onclick="switchComponent('meter')" data-translate="cabinetTabMeter">电表</button>
                    <button class="component-tab" onclick="switchComponent('cooling')" data-translate="cabinetTabCooling">液冷机组</button>
                    <button class="component-tab" onclick="switchComponent('thermal')" data-translate="cabinetTabThermal">温度</button>
                    <button class="component-tab" onclick="switchComponent('fire')" data-translate="cabinetTabFire">消防</button>
                </div>

                <!-- 数据标签页 -->
                <div class="data-tabs">
                    <button class="data-tab active" onclick="switchTab('realtime', event)" data-translate="cabinetDataTabRealtime">实时数据</button>
                    <button class="data-tab" onclick="switchTab('history', event)" data-translate="cabinetDataTabHistory">历史数据</button>
                    <button class="data-tab" onclick="switchTab('control', event)" data-translate="cabinetDataTabControl">控制</button>
                </div>
                
                <!-- 数据内容 -->
                <div class="data-content" id="dataContent">
                    <!-- 实时数据 -->
                    <div id="realtimeData">
                        <!-- 核心运行参数 -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h4 id="cabinetCoreParamsTitle" data-translate="cabinetCoreParamsTitle" style="font-size: 14px; color: var(--text-secondary); margin: 0;">核心运行参数</h4>
                                <div style="display: flex; gap: 8px;">
                                    <button class="upgrade-btn" onclick="openUpgradeModal()" title="升级设备" style="padding: 4px 12px; font-size: 12px;">
                                        <i class="fas fa-arrow-up"></i>
                                        <span id="cabinetBtnUpgrade">升级</span>
                                        <span class="upgrade-badge">定制</span>
                                    </button>
                                    <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                        <i class="fas fa-cog"></i>
                                        <span id="cabinetBtnSettings" data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                    </button>
                                </div>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelSOC" data-translate="cabinetLabelSOC">SOC</div>
                                    <div class="metric-value">
                                        <span id="soc">85.6</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="metric-status good" id="socStatus" data-translate="cabinetStatusBatteryGood">电量充足</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelSOH" data-translate="cabinetLabelSOH">SOH</div>
                                    <div class="metric-value">
                                        <span id="soh">96.8</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div class="metric-status good" id="sohStatus" data-translate="cabinetStatusHealthGood">健康状态良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelTemp" data-translate="cabinetLabelTemp">温度</div>
                                    <div class="metric-value">
                                        <span id="temperature">28.5</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div class="metric-status good" id="tempStatus" data-translate="cabinetStatusTempNormal">温度正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelPower" data-translate="cabinetLabelPower">充放电功率</div>
                                    <div class="metric-value">
                                        <span id="power" style="color: #10b981;">+118.2</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div class="metric-status" id="powerStatus" data-translate="cabinetStatusCharging">充电中</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 运行统计 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 id="cabinetRunStatsTitle" data-translate="cabinetRunStatsTitle" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">运行统计</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelTodayCharge" data-translate="cabinetLabelTodayCharge">今日充电量</div>
                                    <div class="metric-value">
                                        <span id="todayCharge">856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelTodayDischarge" data-translate="cabinetLabelTodayDischarge">今日放电量</div>
                                    <div class="metric-value">
                                        <span id="todayDischarge">742.6</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelChargeCost" data-translate="cabinetLabelChargeCost">充电成本</div>
                                    <div class="metric-value">
                                        <span id="chargingCost">¥685.2</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label" id="cabinetLabelDischargeRevenue" data-translate="cabinetLabelDischargeRevenue">放电收益</div>
                                    <div class="metric-value">
                                        <span id="dischargingRevenue">¥1,126.8</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 历史数据 -->
                    <div id="historyData" style="display: none;">
                        <!-- 设置按钮和时间范围选择 -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; gap: 8px;">
                                <button class="time-range-btn active" onclick="changeTimeRange('24h')" data-translate="cabinetTimeRange24h">24小时</button>
                                <button class="time-range-btn" onclick="changeTimeRange('7d')" data-translate="cabinetTimeRange7d">7天</button>
                                <button class="time-range-btn" onclick="changeTimeRange('30d')" data-translate="cabinetTimeRange30d">30天</button>
                                <button class="time-range-btn" onclick="changeTimeRange('1y')" data-translate="cabinetTimeRange1y">1年</button>
                            </div>
                            <button class="settings-btn" onclick="navigateToExportPage()" title="导出数据" data-translate-title="btnExportData" style="margin-bottom: 0; margin-right: 8px;">
                                <i class="fas fa-download"></i>
                                <span id="cabinetBtnExportData" data-translate="cabinetBtnExportData">导出数据</span>
                            </button>
                            <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0;">
                                <i class="fas fa-cog"></i>
                                <span id="cabinetBtnFieldSettings" data-translate="cabinetBtnFieldSettings">字段设置</span>
                            </button>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title" data-translate="cabinetChartTitlePower">功率曲线</div>
                            <div class="chart-wrapper">
                                <canvas id="powerHistoryChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title" data-translate="cabinetChartTitleSOC">SOC与充放电状态</div>
                            <div class="chart-wrapper">
                                <canvas id="socHistoryChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title" data-translate="cabinetChartTitleTemp">电池温度分布</div>
                            <div class="chart-wrapper">
                                <canvas id="tempHistoryChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title" data-translate="cabinetChartTitleVoltage">电压一致性</div>
                            <div class="chart-wrapper">
                                <canvas id="voltageConsistencyChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title" data-translate="cabinetChartTitleEfficiency">充放电效率分析</div>
                            <div class="chart-wrapper">
                                <canvas id="efficiencyChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title" data-translate="cabinetChartTitleArbitrage">峰谷套利分析</div>
                            <div class="chart-wrapper">
                                <canvas id="arbitrageChart"></canvas>
                            </div>
                        </div>

                        <div class="chart-container">
                            <div class="chart-title" data-translate="cabinetChartTitleSOH">健康度趋势</div>
                            <div class="chart-wrapper">
                                <canvas id="sohTrendChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- 累计统计 -->
                        <div class="statistics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;" data-translate="cabinetStatsTitle">累计统计</h4>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);" data-translate="cabinetStatsTotalCharge">累计充电量</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">186,524 <span style="font-size: 12px; font-weight: 400;">kWh</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);" data-translate="cabinetStatsTotalDischarge">累计放电量</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">178,956 <span style="font-size: 12px; font-weight: 400;">kWh</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);" data-translate="cabinetStatsEquivCycles">等效循环次数</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">1,892 <span style="font-size: 12px; font-weight: 400;" data-translate="cabinetUnitTimes">次</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);" data-translate="cabinetStatsAvgEfficiency">平均效率</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">95.8 <span style="font-size: 12px; font-weight: 400;">%</span></div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);" data-translate="cabinetStatsTotalRevenue">累计收益</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px; color: #10b981;">¥124,658</div>
                                </div>
                                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px;">
                                    <div style="font-size: 12px; color: var(--text-secondary);" data-translate="cabinetStatsAvgDailyRevenue">平均日收益</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-top: 4px;">¥266 <span style="font-size: 12px; font-weight: 400;" data-translate="cabinetUnitDay">/天</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- 运维建议 -->
                        <div class="maintenance-section" style="margin-top: 20px; background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 16px;">
                            <h4 style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-lightbulb"></i>
                                <span data-translate="cabinetMaintenanceTitle">运维建议</span>
                            </h4>
                            <ul style="margin: 0; padding-left: 20px; font-size: 13px; color: #78350f;">
                                <li style="margin-bottom: 6px;" data-translate="cabinetMaintenanceTip1">建议在电价低谷期（23:00-07:00）增加充电功率</li>
                                <li style="margin-bottom: 6px;" data-translate="cabinetMaintenanceTip2">当前温度控制良好，继续保持现有热管理策略</li>
                                <li style="margin-bottom: 6px;" data-translate="cabinetMaintenanceTip3">电池健康度保持在95%以上，建议每月进行一次深度充放电循环</li>
                                <li data-translate="cabinetMaintenanceTip4">下次维护时间：2024年2月15日</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- 控制面板 -->
                    <div id="controlPanel" style="display: none;">
                        <div style="padding: 20px;">
                            <!-- 顶部编辑按钮 -->
                            <div style="display: flex; justify-content: flex-end; margin-bottom: 20px;">
                                <button id="editControlBtn" onclick="toggleControlEdit()" style="padding: 8px 20px; font-size: 14px; background: #3562E3; color: white; border: none; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-edit" style="font-size: 14px;"></i><span data-translate="cabinetControlEdit">编辑</span>
                                </button>
                            </div>

                            <!-- 控制要求 -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <!-- 运行模式选择 -->
                                <div style="margin-bottom: 20px;">
                                    <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;" data-translate="cabinetControlRunMode">运行模式</label>
                                    <div style="display: flex; gap: 20px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="mode" value="auto" checked onchange="changeMode('auto')">
                                            <span style="font-size: 14px;" data-translate="cabinetControlModeAutoLabel">自动模式</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="mode" value="manual" onchange="changeMode('manual')">
                                            <span style="font-size: 14px;" data-translate="cabinetControlModeManualLabel">手动模式</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- 自动模式控制 -->
                                <div id="autoControl" style="padding: 16px; background: #f8fafc; border-radius: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                                        <i class="fas fa-robot" style="color: #10b981; font-size: 20px;"></i>
                                        <div>
                                            <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);" data-translate="cabinetControlAutoDesc">系统根据下方时间轴自动控制充放电</div>
                                        </div>
                                    </div>
                                    
                                    <!-- 峰谷套利时间轴 -->
                                    <div style="margin-bottom: 16px;">
                                        <div style="position: relative; height: 60px; background: #f3f4f6; border-radius: 8px; overflow: hidden;">
                                            <!-- 时间刻度 -->
                                            <div style="position: absolute; top: 0; left: 0; right: 0; height: 20px; display: flex;">
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">0</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">2</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">4</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">6</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">8</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">10</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">12</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">14</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">16</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">18</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280; border-right: 1px solid #e5e7eb;">20</div>
                                                <div style="flex: 1; text-align: center; font-size: 11px; color: #6b7280;">22</div>
                                            </div>
                                            <!-- 时间块容器 -->
                                            <div id="timelineContainer" style="position: absolute; top: 20px; left: 0; right: 0; bottom: 0; display: flex;">
                                                <!-- 24个时间块 -->
                                            </div>
                                        </div>
                                        
                                        <!-- 图例 -->
                                        <div style="display: flex; gap: 20px; margin-top: 12px; font-size: 13px;">
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <div style="width: 16px; height: 16px; background: #ef4444; border-radius: 4px;"></div>
                                                <span data-translate="cabinetControlPeakPeriod">峰值时段</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <div style="width: 16px; height: 16px; background: #3b82f6; border-radius: 4px;"></div>
                                                <span data-translate="cabinetControlValleyPeriod">谷值时段</span>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 6px;">
                                                <div style="width: 16px; height: 16px; background: #e5e7eb; border-radius: 4px;"></div>
                                                <span data-translate="cabinetControlFlatPeriod">平价时段</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 手动模式控制 -->
                                <div id="manualControl" style="display: none;">
                                    <div id="manualButtons">
                                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                            <button class="manual-mode-btn" data-mode="charge" onclick="selectManualMode('charge')"
                                                    style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;
                                                           background: var(--bg-primary); font-size: 14px; font-weight: 600; cursor: pointer;
                                                           transition: all 0.2s;">
                                                <i class="fas fa-battery-three-quarters" style="margin-right: 8px;"></i><span data-translate="cabinetControlManualCharge">充电</span>
                                            </button>
                                            <button class="manual-mode-btn" data-mode="discharge" onclick="selectManualMode('discharge')"
                                                    style="flex: 1; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px;
                                                           background: var(--bg-primary); font-size: 14px; font-weight: 600; cursor: pointer;
                                                           transition: all 0.2s;">
                                                <i class="fas fa-bolt" style="margin-right: 8px;"></i><span data-translate="cabinetControlManualDischarge">放电</span>
                                            </button>
                                        </div>
                                        
                                    </div>
                                    
                                    <!-- 状态显示区 -->
                                    <div id="manualStatus" style="padding: 16px; background: #f8fafc; border-radius: 8px; text-align: center; display: none;">
                                        <div id="statusContent" style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                                            <!-- 动态内容 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            <!-- 电池参数设置 -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);" data-translate="cabinetBatteryParams">电池参数</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetBatteryChargeStopSOC">充电停止SOC (%)</label>
                                        <input type="number" value="95" min="0" max="100" class="form-input" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetBatteryChargePower">充电功率 (kW)</label>
                                        <input type="number" value="250" min="0" max="500" class="form-input" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetBatteryDischargeStopSOC">放电停止SOC (%)</label>
                                        <input type="number" value="10" min="0" max="100" class="form-input" style="width: 100%;">
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetBatteryDischargePower">放电功率 (kW)</label>
                                        <input type="number" value="250" min="0" max="500" class="form-input" style="width: 100%;">
                                    </div>
                                </div>
                                <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetBatteryBalanceControl">均衡控制</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetBatteryBalanceActive">主动均衡</option>
                                            <option data-translate="cabinetBatteryBalancePassive">被动均衡</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetBatteryFanControl">风扇控制</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetBatteryFanAuto">自动</option>
                                            <option data-translate="cabinetBatteryFanOn">开启</option>
                                            <option data-translate="cabinetBatteryFanOff">关闭</option>
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetBatteryTempProtect">温度保护</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetBatteryTempProtectOn">开启</option>
                                            <option data-translate="cabinetBatteryTempProtectOff">关闭</option>
                                        </select>
                                    </div>
                                    <div>
                                        <!-- 预留位置，保持网格布局平衡 -->
                                    </div>
                                </div>
                            </div>

                            <!-- 消防控制 -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);" data-translate="cabinetFireControlTitle">消防控制</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetFireStartMode">灭火启动</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetFireStartAuto">自动启动</option>
                                            <option data-translate="cabinetFireStartManual">手动启动</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetFireAgentType">灭火剂类型</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetFireAgentPerfluorohexanone">全氟己酮</option>
                                            <option data-translate="cabinetFireAgentHeptafluoropropane">七氟丙烷</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetFireAlarm">声光报警</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetFireAlarmEnable">启用</option>
                                            <option data-translate="cabinetFireAlarmDisable">禁用</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetFireEmergencyPower">紧急断电</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetFireEmergencyAuto">自动</option>
                                            <option data-translate="cabinetFireEmergencyManual">手动</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;" data-translate="cabinetFireVentControl">通风控制</label>
                                        <select class="form-input" style="width: 100%;">
                                            <option data-translate="cabinetFireVentAuto">自动控制</option>
                                            <option data-translate="cabinetFireVentForceOn">强制开启</option>
                                            <option data-translate="cabinetFireVentForceOff">强制关闭</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- 液冷控制 -->
                            <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary);">液冷控制</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">模式</label>
                                        <select id="coolantWorkMode" class="form-input" style="width: 100%;" onchange="updateCoolantSubMode()">
                                            <option value="standby">待机</option>
                                            <option value="auto">自循环</option>
                                            <option value="cooling">制冷</option>
                                            <option value="heating">制热</option>
                                        </select>
                                    </div>
                                    <div id="coolantSubModeContainer" style="display: none;">
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">工况</label>
                                        <select id="coolantSubMode" class="form-input" style="width: 100%;" onchange="updateCoolantRunData()">
                                            <option value="half">半工况</option>
                                            <option value="full">全工况</option>
                                        </select>
                                    </div>
                                    <div id="coolantRunDataContainer" style="grid-column: 1 / -1; display: none; margin-top: 8px;">
                                        <label style="display: block; font-size: 14px; color: var(--text-secondary); margin-bottom: 6px;">运行数据</label>
                                        <div style="background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px;">
                                            <p id="coolantRunData" style="margin: 0; font-size: 14px; color: #0c4a6e; line-height: 1.6;"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 底部按钮 -->
                            <div id="controlButtons" style="display: none; position: sticky; bottom: 0; background: white; padding: 16px 0; margin-top: 24px; border-top: 1px solid var(--border-color); text-align: center;">
                                <button onclick="cancelControlEdit()" style="padding: 10px 32px; margin-right: 16px; background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-times" style="margin-right: 6px;"></i><span data-translate="cabinetControlBtnCancel">取消</span>
                                </button>
                                <button onclick="saveControlSettings()" style="padding: 10px 32px; background: #3562E3; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-check" style="margin-right: 6px;"></i><span data-translate="cabinetControlBtnSave">保存</span>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 移动端遮罩 -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <!-- 字段设置模态框 -->
    <div id="fieldSettingsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <!-- 模态框头部 -->
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="modalTitle" data-translate="cabinetFieldSettingsTitle" style="margin: 0; font-size: 18px; font-weight: 600;">字段显示设置</h3>
                <button onclick="closeFieldSettings()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary);">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 模态框内容 -->
            <div style="padding: 20px; overflow-y: auto; flex: 1;">
                <div id="fieldSettingsContent">
                    <!-- 动态生成的字段列表 -->
                </div>
            </div>

            <!-- 模态框底部 -->
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px;">
                <button onclick="resetFieldSettings()" style="padding: 8px 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                    <span id="cabinetFieldSettingsReset" data-translate="cabinetFieldSettingsReset">重置默认</span>
                </button>
                <button onclick="saveFieldSettings()" style="padding: 8px 20px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">
                    <span id="cabinetFieldSettingsSave" data-translate="cabinetFieldSettingsSave">保存设置</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Pack详情弹窗 -->
    <div id="packDetailsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2002; align-items: center; justify-content: center;" onclick="if(event.target === this) closePackDetailsModal()">
        <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 1200px; max-height: 90vh; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column;">
            <!-- 弹窗头部 -->
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="packDetailsModalTitle" style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary);"></h3>
                <button onclick="closePackDetailsModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <!-- 弹窗内容 -->
            <div id="packDetailsModalContent" style="padding: 24px; overflow-y: auto; flex: 1;">
            </div>
        </div>
    </div>

    <!-- 升级提示模态框 -->
    <div id="upgradeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 2001; align-items: center; justify-content: center;">
        <div style="background: var(--bg-primary); border-radius: 12px; width: 90%; max-width: 500px; overflow: hidden; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2); display: flex; flex-direction: column;">

            <!-- 模态框头部 -->
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: var(--text-primary);">定制化升级</h3>
                <button onclick="closeUpgradeModal()" style="background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 模态框内容 -->
            <div style="padding: 24px; text-align: center;">
                <p style="font-size: 15px; color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
                    设备升级需要定制化开发，请联系我们
                </p>

                <!-- 联系方式 -->
                <div style="background: var(--bg-secondary); border-radius: 8px; padding: 20px; border: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 12px;">
                        <i class="fas fa-phone-alt" style="color: var(--text-secondary); font-size: 16px;"></i>
                        <span style="font-size: 14px; color: var(--text-secondary); font-weight: 500;">联系电话</span>
                    </div>
                    <a href="tel:18576677649" style="font-size: 20px; color: var(--text-primary); font-weight: 600; text-decoration: none; display: block; margin-bottom: 6px; letter-spacing: 0.5px;">
                        185 7667 7649
                    </a>
                    <div style="font-size: 13px; color: var(--text-secondary);">
                        Rory Chen
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        // 打开设备控制面板
        function openDeviceControlPanel() {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.id = 'deviceControlOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            
            // 创建控制面板
            const panel = document.createElement('div');
            panel.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 32px;
                width: 95%;
                max-width: 700px;
                max-height: 90vh;
                overflow-y: auto;
                box-shadow: 0 12px 48px rgba(0,0,0,0.2);
                transform: scale(0.9);
                transition: transform 0.3s ease;
            `;
            
            panel.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; color: var(--text-primary); font-weight: 600;">设备控制</h3>
                    <button onclick="closeDeviceControlPanel()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
                    <!-- 启动按钮 -->
                    <button onclick="deviceControl('start')" style="padding: 12px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(16, 185, 129, 0.2)'">
                        <i class="fas fa-play" style="font-size: 16px;"></i>
                        <span>启动</span>
                    </button>
                    
                    <!-- 停止按钮 -->
                    <button onclick="deviceControl('stop')" style="padding: 12px 16px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.2)'">
                        <i class="fas fa-stop" style="font-size: 16px;"></i>
                        <span>停止</span>
                    </button>
                    
                    <!-- 待机按钮 -->
                    <button onclick="deviceControl('standby')" style="padding: 12px 16px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(245, 158, 11, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(245, 158, 11, 0.2)'">
                        <i class="fas fa-pause" style="font-size: 16px;"></i>
                        <span>待机</span>
                    </button>
                    
                    <!-- 重启按钮 -->
                    <button onclick="deviceControl('restart')" style="padding: 12px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.2)'">
                        <i class="fas fa-redo" style="font-size: 16px;"></i>
                        <span>重启</span>
                    </button>
                    
                    <!-- 紧急停机按钮 -->
                    <button onclick="deviceControl('emergency')" style="padding: 12px 16px; background: linear-gradient(135deg, #7c2d12 0%, #991b1b 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(124, 45, 18, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(124, 45, 18, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(124, 45, 18, 0.2)'">
                        <i class="fas fa-power-off" style="font-size: 16px;"></i>
                        <span>紧急停机</span>
                    </button>
                    
                    <!-- 复位按钮 -->
                    <button onclick="deviceControl('reset')" style="padding: 12px 16px; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(107, 114, 128, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(107, 114, 128, 0.2)'">
                        <i class="fas fa-sync-alt" style="font-size: 16px;"></i>
                        <span>复位</span>
                    </button>
                </div>
                
                <!-- OTA升级部分 -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                    <h4 style="margin: 0 0 16px 0; font-size: 16px; color: var(--text-primary); font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cloud-download-alt" style="color: #3b82f6;"></i>
                        OTA固件升级
                    </h4>
                    
                    <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 13px;">
                            <div>
                                <span style="color: #6b7280;">当前版本：</span>
                                <span style="color: #1f2937; font-weight: 500;">V2.3.5</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">最新版本：</span>
                                <span style="color: #10b981; font-weight: 500;">V2.4.0</span>
                                <span style="background: #10b981; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 6px;">可更新</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">设备型号：</span>
                                <span style="color: #1f2937; font-weight: 500;">ESS-2500</span>
                            </div>
                            <div>
                                <span style="color: #6b7280;">更新时间：</span>
                                <span style="color: #1f2937; font-weight: 500;">2024-01-15</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 12px; color: #92400e;">
                        <i class="fas fa-info-circle" style="margin-right: 6px;"></i>
                        更新说明：修复BMS通信延迟问题，优化充放电控制算法，提升系统稳定性
                    </div>
                    
                    <div style="display: flex; gap: 12px;">
                        <button onclick="checkForUpdates()" style="flex: 1; padding: 12px 20px; background: #f3f4f6; color: #1f2937; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 500;" onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            <i class="fas fa-sync" style="margin-right: 6px;"></i>
                            检查更新
                        </button>
                        <button onclick="startOTAUpgrade()" style="flex: 1; padding: 12px 20px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; font-weight: 500; box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(59, 130, 246, 0.2)'">
                            <i class="fas fa-download" style="margin-right: 6px;"></i>
                            开始升级
                        </button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
            
            // 显示动画
            setTimeout(() => {
                overlay.style.opacity = '1';
                panel.style.transform = 'scale(1)';
            }, 10);
            
            // 点击遮罩关闭
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeDeviceControlPanel();
                }
            });
        }
        
        // 关闭设备控制面板
        function closeDeviceControlPanel() {
            const overlay = document.getElementById('deviceControlOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.querySelector('div').style.transform = 'scale(0.9)';
                setTimeout(() => {
                    overlay.remove();
                }, 300);
            }
        }
        
        // 检查更新
        function checkForUpdates() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `
                <i class="fas fa-sync fa-spin"></i>
                正在检查更新...
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.background = '#10b981';
                toast.innerHTML = `
                    <i class="fas fa-check"></i>
                    发现新版本 V2.4.0 可用
                `;
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, 2000);
            }, 1500);
        }
        
        // 开始OTA升级
        function startOTAUpgrade() {
            if (!confirm('确定要开始固件升级吗？\n升级过程中设备将暂停运行，请确保设备处于安全状态。')) {
                return;
            }
            
            // 关闭控制面板
            closeDeviceControlPanel();
            
            // 创建升级进度弹窗
            const progressOverlay = document.createElement('div');
            progressOverlay.id = 'otaProgressOverlay';
            progressOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const progressPanel = document.createElement('div');
            progressPanel.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 32px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            `;
            
            progressPanel.innerHTML = `
                <h3 style="margin: 0 0 24px 0; font-size: 18px; color: #1f2937; font-weight: 600; text-align: center;">
                    <i class="fas fa-cloud-download-alt" style="color: #3b82f6; margin-right: 8px;"></i>
                    固件升级中
                </h3>
                
                <div style="background: #f3f4f6; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                        <span style="color: #6b7280;">升级进度</span>
                        <span id="otaProgress" style="color: #3b82f6; font-weight: 600;">0%</span>
                    </div>
                    <div style="background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                        <div id="otaProgressBar" style="background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                
                <div id="otaStatus" style="text-align: center; font-size: 14px; color: #6b7280; margin-bottom: 20px;">
                    正在下载固件...
                </div>
                
                <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; font-size: 12px; color: #92400e;">
                    <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>
                    请勿断电或关闭设备，升级过程大约需要5-10分钟
                </div>
            `;
            
            progressOverlay.appendChild(progressPanel);
            document.body.appendChild(progressOverlay);

            // 等待DOM元素完全渲染后再开始更新进度
            setTimeout(() => {
                // 模拟升级进度
                let progress = 0;
                const updateInterval = setInterval(() => {
                    progress += Math.random() * 15 + 5;
                    if (progress > 100) progress = 100;

                    const progressText = document.getElementById('otaProgress');
                    const progressBar = document.getElementById('otaProgressBar');
                    const statusText = document.getElementById('otaStatus');

                    if (progressText) progressText.textContent = Math.round(progress) + '%';
                    if (progressBar) progressBar.style.width = progress + '%';

                    if (statusText) {
                        if (progress < 30) {
                            statusText.textContent = '正在下载固件...';
                        } else if (progress < 60) {
                            statusText.textContent = '正在验证固件...';
                        } else if (progress < 90) {
                            statusText.textContent = '正在安装固件...';
                        } else {
                            statusText.textContent = '正在重启设备...';
                        }
                    }

                    if (progress >= 100) {
                        clearInterval(updateInterval);
                        setTimeout(() => {
                            progressPanel.innerHTML = `
                                <div style="text-align: center;">
                                    <i class="fas fa-check-circle" style="font-size: 48px; color: #10b981; margin-bottom: 16px;"></i>
                                    <h3 style="margin: 0 0 8px 0; font-size: 18px; color: #1f2937; font-weight: 600;">升级成功</h3>
                                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 24px;">固件已成功升级至 V2.4.0</p>
                                    <button onclick="closeOTAProgress()" style="padding: 10px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500;">
                                        确定
                                    </button>
                                </div>
                            `;
                        }, 1000);
                    }
                }, 500);
            }, 100);
        }
        
        // 关闭OTA进度窗口
        function closeOTAProgress() {
            const overlay = document.getElementById('otaProgressOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
        
        // 设备控制函数
        function deviceControl(action) {
            const actionNames = {
                'start': '启动',
                'stop': '停止',
                'standby': '待机',
                'restart': '重启', 
                'emergency': '紧急停机',
                'reset': '复位'
            };
            
            const actionName = actionNames[action] || action;
            
            // 特殊处理紧急停机 - 需要确认
            if (action === 'emergency') {
                if (!confirm(`确定要执行${actionName}操作吗？\n此操作将立即停止设备运行，可能会影响正在进行的工作。`)) {
                    return;
                }
            } else {
                // 其他操作的确认
                if (!confirm(`确定要执行${actionName}操作吗？`)) {
                    return;
                }
            }
            
            // 关闭控制面板
            closeDeviceControlPanel();
            
            // 显示操作进度提示
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-size: 14px;
                transition: all 0.3s ease;
            `;
            
            toast.innerHTML = `
                <i class="fas fa-spinner fa-spin"></i>
                正在执行${actionName}操作...
            `;
            
            document.body.appendChild(toast);
            
            // 模拟操作延迟
            setTimeout(() => {
                // 更新提示为成功状态
                toast.style.background = '#10b981';
                toast.innerHTML = `
                    <i class="fas fa-check"></i>
                    ${actionName}操作执行成功
                `;
                
                // 2秒后移除提示
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }, 2000);
                
                // 这里可以添加实际的设备控制逻辑
                console.log(`设备控制: ${action} - ${actionName}`);
                
            }, 1500); // 模拟1.5秒的操作时间
        }
        
        // 检查登录状态
        checkAuth();
        
        // 设置当前页面菜单项
        setActiveMenuItem('devices');
        
        // 3D相关变量已删除
        
        // 返回上一页
        function goBack() {
            window.location.href = 'devices.html';
        }

        // 急停开关状态
        let emergencyStopActive = false;

        // 自定义确认弹窗
        function showCustomConfirm(title, message, type = 'warning', onConfirm, onCancel) {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // 创建弹窗
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: white;
                border-radius: 12px;
                padding: 32px;
                max-width: 420px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                text-align: center;
            `;

            // 图标颜色和样式
            const iconColors = {
                warning: { bg: '#fee2e2', icon: '#ef4444', iconClass: 'fa-exclamation-triangle' },
                success: { bg: '#d1fae5', icon: '#10b981', iconClass: 'fa-check-circle' }
            };
            const config = iconColors[type] || iconColors.warning;

            modal.innerHTML = `
                <div style="width: 60px; height: 60px; background: ${config.bg}; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                    <i class="fas ${config.iconClass}" style="font-size: 28px; color: ${config.icon};"></i>
                </div>
                <h3 style="margin: 0 0 12px 0; font-size: 20px; color: #1e293b; font-weight: 600;">${title}</h3>
                <p style="margin: 0 0 28px 0; font-size: 15px; color: #64748b; line-height: 1.6;">${message}</p>
                <div style="display: flex; gap: 12px;">
                    <button id="customConfirmCancel" style="flex: 1; height: 44px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; font-size: 15px; font-weight: 500; color: #64748b; cursor: pointer; transition: all 0.2s;">
                        取消
                    </button>
                    <button id="customConfirmOk" style="flex: 1; height: 44px; border: none; background: ${config.icon}; border-radius: 8px; font-size: 15px; font-weight: 500; color: white; cursor: pointer; transition: all 0.2s;">
                        确认
                    </button>
                </div>
            `;

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // 按钮hover效果
            const cancelBtn = modal.querySelector('#customConfirmCancel');
            const okBtn = modal.querySelector('#customConfirmOk');

            cancelBtn.onmouseover = () => cancelBtn.style.background = '#f9fafb';
            cancelBtn.onmouseout = () => cancelBtn.style.background = 'white';

            okBtn.onmouseover = () => okBtn.style.transform = 'scale(1.02)';
            okBtn.onmouseout = () => okBtn.style.transform = 'scale(1)';

            // 绑定事件
            cancelBtn.onclick = () => {
                overlay.remove();
                if (onCancel) onCancel();
            };

            okBtn.onclick = () => {
                overlay.remove();
                if (onConfirm) onConfirm();
            };

            // 点击遮罩关闭
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                    if (onCancel) onCancel();
                }
            };
        }

        // 急停开关处理
        function handleEmergencyStop() {
            // 获取DOM元素
            const runningLightIcon = document.getElementById('runningLightIcon');
            const alarmLight = document.getElementById('alarmLight');
            const alarmLightIcon = document.getElementById('alarmLightIcon');
            const customToggle = document.getElementById('customToggle');
            const toggleCircle = document.getElementById('toggleCircle');

            if (!emergencyStopActive) {
                // 显示自定义确认弹窗
                showCustomConfirm(
                    '警告',
                    '您确定要触发紧急停止吗？这将立即停止储能柜的所有运行操作！',
                    'warning',
                    () => {
                        emergencyStopActive = true;

                        // 更新急停开关状态：开（红色）
                        customToggle.style.background = '#ef4444';
                        toggleCircle.style.left = '22px';

                        // 运行灯：灭（灰色）
                        runningLightIcon.style.color = '#9ca3af';
                        runningLightIcon.style.filter = 'none';
                        runningLightIcon.style.animation = 'none';

                        // 告警灯：亮（红色闪烁）
                        alarmLightIcon.style.color = '#ef4444';
                        alarmLightIcon.style.filter = 'drop-shadow(0 0 4px rgba(239,68,68,0.6))';
                        alarmLightIcon.style.animation = 'alarm-blink-flat 1.2s ease-in-out infinite';
                        alarmLight.style.animation = 'alarm-card-glow-light 1.2s ease-in-out infinite';

                        // 显示急停执行提示
                        const emergencyToast = document.createElement('div');
                        emergencyToast.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                            color: white;
                            padding: 24px 32px;
                            border-radius: 12px;
                            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
                            z-index: 10000;
                            font-size: 16px;
                            font-weight: 600;
                            text-align: center;
                            border: 3px solid #7f1d1d;
                        `;
                        emergencyToast.innerHTML = `
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <div>急停已触发！</div>
                            <div style="font-size: 14px; font-weight: 400; margin-top: 8px;">系统正在安全关闭中...</div>
                        `;
                        document.body.appendChild(emergencyToast);

                        // 3秒后移除提示
                        setTimeout(() => {
                            emergencyToast.remove();
                        }, 3000);

                        console.log('🚨 急停开关已触发 - 时间:', new Date().toLocaleString());

                        // TODO: 实际应用中，这里应该调用后端API执行真正的急停操作
                        // 例如: fetch('/api/emergency-stop', { method: 'POST', ... })
                    }
                );
            } else {
                // 关闭急停 - 显示自定义确认弹窗
                showCustomConfirm(
                    '确认关闭急停',
                    '确认要关闭急停开关吗？\n系统将恢复正常运行。',
                    'success',
                    () => {
                        emergencyStopActive = false;

                        // 更新急停开关状态：关（灰色）
                        customToggle.style.background = '#d1d5db';
                        toggleCircle.style.left = '2px';

                        // 运行灯：亮（绿色）
                        runningLightIcon.style.color = '#10b981';
                        runningLightIcon.style.filter = 'drop-shadow(0 0 4px rgba(16,185,129,0.6))';

                        // 告警灯：灭（灰色）
                        alarmLightIcon.style.color = '#9ca3af';
                        alarmLightIcon.style.filter = 'none';
                        alarmLightIcon.style.animation = 'none';
                        alarmLight.style.animation = 'none';

                        // 显示恢复提示
                        const recoveryToast = document.createElement('div');
                        recoveryToast.style.cssText = `
                            position: fixed;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            padding: 24px 32px;
                            border-radius: 12px;
                            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
                            z-index: 10000;
                            font-size: 16px;
                            font-weight: 600;
                            text-align: center;
                            border: 3px solid #065f46;
                        `;
                        recoveryToast.innerHTML = `
                            <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 12px;"></i>
                            <div>急停已关闭！</div>
                            <div style="font-size: 14px; font-weight: 400; margin-top: 8px;">系统正在恢复正常运行...</div>
                        `;
                        document.body.appendChild(recoveryToast);

                        // 3秒后移除提示
                        setTimeout(() => {
                            recoveryToast.remove();
                        }, 3000);

                        console.log('✅ 急停开关已关闭 - 时间:', new Date().toLocaleString());
                    }
                );
            }
        }
        
        // 3D场景已删除
        
        // 3D模型创建函数已删除
        // 3D柜体创建代码已删除
        
        // 3D相关函数已删除 - createBatteryModules
        function createBatteryModules() {
            // createBatteryModules 3D函数已删除
        }
        
        // 创建PCS变流器模块
        // 3D相关函数已删除 - createPCSModule
        function createPCSModule() {
            // createPCSModule 3D函数已删除
        }
        
        // 创建BMS电池管理系统
        // 3D相关函数已删除 - createBMSModule
        function createBMSModule() {
            // createBMSModule 3D函数已删除
        }
        
        // 创建热管理系统
        // 3D相关函数已删除 - createCoolingSystem
        function createCoolingSystem() {
            // createCoolingSystem 3D函数已删除
        }
        
        // 创建消防系统
        // 3D相关函数已删除 - createFireSystem
        function createFireSystem() {
            // createFireSystem 3D函数已删除
        }
        
        // 创建配电柜
        // 3D相关函数已删除 - createElectricalPanel
        function createElectricalPanel() {
            // createElectricalPanel 3D函数已删除
        }
        
        // 创建组件标签
        // 3D相关函数已删除 - createComponentLabels
        function createComponentLabels() {
            // createComponentLabels 3D函数已删除
        }
        
        // 选择组件
        function selectComponent(componentName) {
            selectedComponent = componentName;
            
            // 更新UI - 移除了组件标签面板相关代码
            
            // 高亮显示组件
            Object.keys(components).forEach(key => {
                const group = components[key];
                group.traverse(child => {
                    if (child.isMesh) {
                        child.material.opacity = key === componentName ? 1 : 0.3;
                        child.material.transparent = true;
                        if (key === componentName) {
                            child.material.emissive = child.material.color;
                            child.material.emissiveIntensity = 0.2;
                        } else {
                            child.material.emissive = new THREE.Color(0x000000);
                            child.material.emissiveIntensity = 0;
                        }
                    }
                });
            });
            
            // 映射3D组件到tab组件
            const tabMapping = {
                'pcs': 'pcs',
                'bms': 'bms',
                'cooling': 'thermal',
                'fire': 'fire',
                'electrical': 'hv',
                'ems': 'ems'
            };
            
            const tabComponent = tabMapping[componentName] || 'overall';
            
            // 更新标签选中状态
            document.querySelectorAll('.component-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            const targetTab = document.querySelector(`.component-tab[onclick*="'${tabComponent}'"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 更新当前组件
            currentComponent = tabComponent;
            
            // 更新数据显示
            updateComponentData(tabComponent);
        }
        
        // 获取组件对应的标签名称
        function getComponentTabName(componentName) {
            const mapping = {
                'overall': '整机',
                'ems': 'EMS',
                'pcs': 'PCS',
                'bms': 'BMS',
                'meter': '电表',
                'cooling': '液冷机组',
                'thermal': '温度',
                'fire': '消防',
                'electrical': '高压箱',
                'hv': '高压箱'
            };
            return mapping[componentName] || '整体';
        }
        
        // 更新组件数据
        function updateComponentData(componentName) {
            const dataContent = document.getElementById('dataContent');
            const realtimeData = document.getElementById('realtimeData');
            
            // 清空现有内容
            realtimeData.innerHTML = '';
            
            // 组件名称已在switchComponent中处理
            
            switch(componentName) {
                case 'overall':
                    realtimeData.innerHTML = generateComponentHTML('overall');
                    break;
                case 'overall_old':
                    // 动态生成HTML，根据字段设置显示/隐藏
                    let overallHtml = `
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">核心运行参数</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                    `;
                    
                    // 核心数据字段
                    if (shouldShowField('overall', 'realtime', 'soc')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">SOC</div>
                                <div class="metric-value">
                                    <span id="soc">88.0</span>
                                    <span class="metric-unit">%</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">电量充足</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'soh')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">SOH</div>
                                <div class="metric-value">
                                    <span id="soh">96.8</span>
                                    <span class="metric-unit">%</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">健康状态良好</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'power')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">充放电功率</div>
                                <div class="metric-value">
                                    <span id="power">+142.8</span>
                                    <span class="metric-unit">kW</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">充电中</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'temperature')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">温度</div>
                                <div class="metric-value">
                                    <span id="temperature">26.3</span>
                                    <span class="metric-unit">°C</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度正常</div>
                            </div>
                        `;
                    }
                    
                    // 电气参数字段
                    if (shouldShowField('overall', 'realtime', 'voltage')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">电池电压</div>
                                <div class="metric-value">
                                    <span id="voltage">748.8</span>
                                    <span class="metric-unit">V</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'current')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">电池电流</div>
                                <div class="metric-value">
                                    <span id="current">0.1</span>
                                    <span class="metric-unit">A</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                            </div>
                        `;
                    }
                    
                    if (shouldShowField('overall', 'realtime', 'efficiency')) {
                        overallHtml += `
                            <div class="metric-card">
                                <div class="metric-label">系统效率</div>
                                <div class="metric-value">
                                    <span id="efficiency">94.5</span>
                                    <span class="metric-unit">%</span>
                                </div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">高效运行</div>
                            </div>
                        `;
                    }
                    
                    overallHtml += `
                            </div>
                        </div>
                    `;
                    
                    // 运行统计部分
                    let hasStatisticsData = shouldShowField('overall', 'realtime', 'chargeCount') || 
                                           shouldShowField('overall', 'realtime', 'chargeAmount') || 
                                           shouldShowField('overall', 'realtime', 'chargeCost') ||
                                           shouldShowField('overall', 'realtime', 'dischargeCount') ||
                                           shouldShowField('overall', 'realtime', 'dischargeAmount') ||
                                           shouldShowField('overall', 'realtime', 'dischargeRevenue');
                    
                    if (hasStatisticsData) {
                        overallHtml += `
                            <!-- 运行统计 -->
                            <div class="metrics-section" style="margin-top: 20px;">
                                <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">运行统计</h4>
                                <div class="metrics-grid">
                        `;
                        
                        if (shouldShowField('overall', 'realtime', 'chargeCount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">充电次数</div>
                                    <div class="metric-value">
                                        <span id="chargeCount">3</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'chargeAmount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">充电量</div>
                                    <div class="metric-value">
                                        <span id="chargeAmount">856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'chargeCost')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">充电成本</div>
                                    <div class="metric-value">
                                        <span id="chargeCost" style="color: #ef4444;">￥685.0</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'dischargeCount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">放电次数</div>
                                    <div class="metric-value">
                                        <span id="dischargeCount">2</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'dischargeAmount')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">放电量</div>
                                    <div class="metric-value">
                                        <span id="dischargeAmount">743.0</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'dischargeRevenue')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">放电收益</div>
                                    <div class="metric-value">
                                        <span id="dischargeRevenue" style="color: #10b981;">￥1114.5</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        
                        overallHtml += `
                                </div>
                            </div>
                        `;
                    }
                    
                    // 其他参数部分
                    let hasOtherData = shouldShowField('overall', 'realtime', 'cycles') || 
                                       shouldShowField('overall', 'realtime', 'totalCharge') || 
                                       shouldShowField('overall', 'realtime', 'totalDischarge');
                    
                    if (hasOtherData) {
                        overallHtml += `
                            <!-- 其他参数 -->
                            <div class="metrics-section" style="margin-top: 20px;">
                                <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">其他参数</h4>
                                <div class="metrics-grid" style="grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        `;
                        
                        if (shouldShowField('overall', 'realtime', 'cycles')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">循环次数</div>
                                    <div class="metric-value">
                                        <span id="cycles">128</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'totalCharge')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">累计充电量</div>
                                    <div class="metric-value">
                                        <span id="totalChargeAccumulated">12856.2</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (shouldShowField('overall', 'realtime', 'totalDischarge')) {
                            overallHtml += `
                                <div class="metric-card">
                                    <div class="metric-label">累计放电量</div>
                                    <div class="metric-value">
                                        <span id="totalDischargeAccumulated">11743.0</span>
                                        <span class="metric-unit">kWh</span>
                                    </div>
                                </div>
                            `;
                        }
                        
                        overallHtml += `
                                </div>
                            </div>
                        `;
                    }
                    
                    realtimeData.innerHTML = overallHtml;
                    break;
                    
                case 'ems':
                    realtimeData.innerHTML = generateComponentHTML('ems');
                    break;
                case 'ems_old':
                    realtimeData.innerHTML = `
                        <!-- 策略调度参数 -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">策略调度参数</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label" data-translate="cabinetCurrentStrategy">当前策略</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #2563eb;" data-translate="cabinetStrategyPeakValley">峰谷套利</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;" data-translate="cabinetStrategyAutoRunning">自动执行中</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label" data-translate="cabinetScheduleCmd">调度指令</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">充电</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">目标功率125kW</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">目标SOC</div>
                                    <div class="metric-value">
                                        <span id="emsTargetSOC">${(85 + Math.random() * 10).toFixed(0)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">峰时放电准备</div>
                                </div>
                            </div>
                        </div>

                        <!-- 通信控制参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">通信控制参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">主站通信</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">在线</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">通信正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">调度响应时间</div>
                                    <div class="metric-value">
                                        <span id="emsResponseTime">${(15 + Math.random() * 25).toFixed(0)}</span>
                                        <span class="metric-unit">ms</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">响应及时</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">AGC指令</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #2563eb;">${Math.random() > 0.5 ? '上调' : '下调'}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">自动发电控制</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电网频率</div>
                                    <div class="metric-value">
                                        <span id="gridFrequency">${(49.95 + Math.random() * 0.1).toFixed(3)}</span>
                                        <span class="metric-unit">Hz</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">频率稳定</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">功率偏差</div>
                                    <div class="metric-value">
                                        <span id="powerDeviation">${(Math.random() * 10 - 5).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">控制精度高</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">保护状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">无保护动作</div>
                                </div>
                            </div>
                        </div>

                    `;
                    break;
                case 'pcs':
                    realtimeData.innerHTML = generateComponentHTML('pcs');
                    break;
                case 'pcs_old':
                    realtimeData.innerHTML = `
                        <!-- 电力转换参数 -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">电力转换参数</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">直流侧电压</div>
                                    <div class="metric-value">
                                        <span id="pcs-dc-voltage">${(720 + Math.random() * 60).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">电压稳定</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">直流侧电流</div>
                                    <div class="metric-value">
                                        <span id="pcs-dc-current">${(180 + Math.random() * 70).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">电流正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">交流侧电压</div>
                                    <div class="metric-value">
                                        <span id="pcs-ac-voltage">${(376 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">380V标准</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">交流侧电流</div>
                                    <div class="metric-value">
                                        <span id="pcs-ac-current">${(320 + Math.random() * 80).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">负荷均衡</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">有功功率</div>
                                    <div class="metric-value">
                                        <span id="pcs-active-power">${(125 + Math.random() * 75).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">功率输出稳定</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">无功功率</div>
                                    <div class="metric-value">
                                        <span id="pcs-reactive-power">${(Math.random() * 20 - 10).toFixed(1)}</span>
                                        <span class="metric-unit">kVar</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">无功补偿</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">功率因数</div>
                                    <div class="metric-value">
                                        <span id="pcs-pf">${(0.95 + Math.random() * 0.04).toFixed(3)}</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">高功率因数</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">频率</div>
                                    <div class="metric-value">
                                        <span id="pcs-frequency">${(49.95 + Math.random() * 0.1).toFixed(2)}</span>
                                        <span class="metric-unit">Hz</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">频率稳定</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 设备运行参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">设备运行参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">转换效率</div>
                                    <div class="metric-value">
                                        <span id="pcs-efficiency">${(96.2 + Math.random() * 2.5).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">高效转换</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">开关频率</div>
                                    <div class="metric-value">
                                        <span id="pcs-switch-freq">${(8 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">kHz</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">PWM调制</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">IGBT温度</div>
                                    <div class="metric-value">
                                        <span id="pcs-igbt-temp">${(55 + Math.random() * 15).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电抗器温度</div>
                                    <div class="metric-value">
                                        <span id="pcs-reactor-temp">${(42 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">运行正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">变压器温度</div>
                                    <div class="metric-value">
                                        <span id="pcs-transformer-temp">${(48 + Math.random() * 12).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">散热良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">总谐波失真</div>
                                    <div class="metric-value">
                                        <span id="pcs-thd">${(2.5 + Math.random() * 1.5).toFixed(2)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">THD优秀</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">绝缘阻抗</div>
                                    <div class="metric-value">
                                        <span id="pcs-insulation">${(15 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">MΩ</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">绝缘良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">控制状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">运行</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常工作模式</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 保护与故障信息 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">保护与故障信息</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">过压保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">未触发</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">过流保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">未触发</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">过温保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度在范围内</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">故障计数</div>
                                    <div class="metric-value">
                                        <span id="pcs-fault-count">0</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">本月无故障</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">累计运行时间</div>
                                    <div class="metric-value">
                                        <span id="pcs-runtime">${(15000 + Math.random() * 2000).toFixed(0)}</span>
                                        <span class="metric-unit">h</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">设备寿命良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">维护状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">良好</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">下次维护45天后</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'bms':
                    realtimeData.innerHTML = generateBMSHTML();
                    break;
                case 'bms_old':
                    realtimeData.innerHTML = `
                        <!-- 电池组管理参数 -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">电池组管理参数</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">总电压</div>
                                    <div class="metric-value">
                                        <span id="bms-total-voltage">${(720 + Math.random() * 60).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">电压正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">总电流</div>
                                    <div class="metric-value">
                                        <span id="bms-total-current">${(Math.random() > 0.5 ? '+' : '-')}${(120 + Math.random() * 80).toFixed(1)}</span>
                                        <span class="metric-unit">A</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">${Math.random() > 0.5 ? '充电电流' : '放电电流'}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">剩余容量</div>
                                    <div class="metric-value">
                                        <span id="bms-remaining-capacity">${(450 + Math.random() * 100).toFixed(1)}</span>
                                        <span class="metric-unit">Ah</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">可用容量</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">充放电循环</div>
                                    <div class="metric-value">
                                        <span id="bms-cycles">${Math.floor(2800 + Math.random() * 500)}</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">循环寿命良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">内阻</div>
                                    <div class="metric-value">
                                        <span id="bms-internal-resistance">${(45 + Math.random() * 15).toFixed(1)}</span>
                                        <span class="metric-unit">mΩ</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">阻抗正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">绝缘阻抗</div>
                                    <div class="metric-value">
                                        <span id="bms-insulation">${(850 + Math.random() * 300).toFixed(0)}</span>
                                        <span class="metric-unit">kΩ</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">绝缘良好</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 单体电芯监控 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">单体电芯监控</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">最高单体电压</div>
                                    <div class="metric-value">
                                        <span id="bms-max-cell-voltage">${(3.35 + Math.random() * 0.02).toFixed(3)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">电芯编号: ${Math.floor(Math.random() * 280 + 1)}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">最低单体电压</div>
                                    <div class="metric-value">
                                        <span id="bms-min-cell-voltage">${(3.32 + Math.random() * 0.02).toFixed(3)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">电芯编号: ${Math.floor(Math.random() * 280 + 1)}</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">单体压差</div>
                                    <div class="metric-value">
                                        <span id="bms-voltage-diff">${(5 + Math.random() * 15).toFixed(1)}</span>
                                        <span class="metric-unit">mV</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">压差良好</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电芯一致性</div>
                                    <div class="metric-value">
                                        <span id="bms-consistency">${(96.5 + Math.random() * 2.5).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">一致性优秀</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">异常电芯数</div>
                                    <div class="metric-value">
                                        <span id="bms-abnormal-cells">0</span>
                                        <span class="metric-unit">个</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">全部正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">均衡状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">${Math.random() > 0.7 ? '均衡中' : '未均衡'}</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">主动均衡策略</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电芯总数</div>
                                    <div class="metric-value">
                                        <span>280</span>
                                        <span class="metric-unit">个</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">14串20并组合</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">采样精度</div>
                                    <div class="metric-value">
                                        <span id="bms-sampling-accuracy">${(99.5 + Math.random() * 0.4).toFixed(2)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">高精度采样</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 安全保护参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">安全保护参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">过压保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">阈值: 3.65V</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">欠压保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">阈值: 2.8V</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">过流保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">阈值: 300A</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">过温保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">阈值: 60°C</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">短路保护</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">未触发</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">通信状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">在线</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">CAN通信正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">故障代码</div>
                                    <div class="metric-value">
                                        <span id="bms-fault-code">0x0000</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">无故障</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">硬件版本</div>
                                    <div class="metric-value">
                                        <span>V2.1.3</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">软件版本V1.8.5</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'meter':
                    realtimeData.innerHTML = generateMeterHTML();
                    break;
                    
                case 'thermal':
                    realtimeData.innerHTML = generateComponentHTML('thermal');
                    break;

                case 'cooling':
                    realtimeData.innerHTML = generateCoolingHTML();
                    break;
                case 'thermal_old':
                case 'cooling_old':
                    realtimeData.innerHTML = `
                        <!-- 核心监控参数 -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">核心监控参数</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">电池包最高温度</div>
                                    <div class="metric-value">
                                        <span id="battMaxTemp">${(26 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常范围</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池包最低温度</div>
                                    <div class="metric-value">
                                        <span id="battMinTemp">${(22 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常范围</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池包平均温度</div>
                                    <div class="metric-value">
                                        <span id="battAvgTemp">${(24 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常范围</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池包温差</div>
                                    <div class="metric-value">
                                        <span id="battTempDiff">${(2 + Math.random() * 3).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度均匀</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">进风温度</div>
                                    <div class="metric-value">
                                        <span id="inletTemp">${(20 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">环境正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">出风温度</div>
                                    <div class="metric-value">
                                        <span id="outletTemp">${(28 + Math.random() * 6).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">散热正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">相对湿度</div>
                                    <div class="metric-value">
                                        <span id="humidity">${(40 + Math.random() * 20).toFixed(1)}</span>
                                        <span class="metric-unit">%RH</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">湿度适宜</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">冷却液温度</div>
                                    <div class="metric-value">
                                        <span id="coolantTemp">${(18 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">冷却正常</div>
                                </div>
                            </div>
                        </div>

                        <!-- 系统运行参数 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">系统运行参数</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">主风机转速</div>
                                    <div class="metric-value">
                                        <span id="mainFanSpeed">${(1800 + Math.random() * 400).toFixed(0)}</span>
                                        <span class="metric-unit">RPM</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">辅助风机转速</div>
                                    <div class="metric-value">
                                        <span id="auxFanSpeed">${(1200 + Math.random() * 300).toFixed(0)}</span>
                                        <span class="metric-unit">RPM</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">冷却液流速</div>
                                    <div class="metric-value">
                                        <span id="coolantFlow">${(15 + Math.random() * 5).toFixed(1)}</span>
                                        <span class="metric-unit">L/min</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">压缩机功率</div>
                                    <div class="metric-value">
                                        <span id="compressorPower">${(3.2 + Math.random() * 1.8).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">热管理功耗</div>
                                    <div class="metric-value">
                                        <span id="thermalPower">${(5.8 + Math.random() * 2.2).toFixed(1)}</span>
                                        <span class="metric-unit">kW</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">温升速率</div>
                                    <div class="metric-value">
                                        <span id="tempRiseRate">${(0.05 + Math.random() * 0.25).toFixed(3)}</span>
                                        <span class="metric-unit">°C/min</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">制冷效率</div>
                                    <div class="metric-value">
                                        <span id="coolingEff">${(88 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">COP系数</div>
                                    <div class="metric-value">
                                        <span id="copValue">${(3.2 + Math.random() * 0.8).toFixed(2)}</span>
                                        <span class="metric-unit"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 运行状态 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">运行状态</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">热管理状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">自动调节</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">冷却模式</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">主动制冷</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">今日运行时间</div>
                                    <div class="metric-value">
                                        <span id="thermalRuntime">${(18 + Math.random() * 4).toFixed(1)}</span>
                                        <span class="metric-unit">小时</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">维护状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">良好</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">启停次数</div>
                                    <div class="metric-value">
                                        <span id="thermalCycles">${Math.floor(2 + Math.random() * 3)}</span>
                                        <span class="metric-unit">次</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">过滤器状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">清洁</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">报警状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">无报警</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">能效等级</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">一级</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">节能优秀</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'fire':
                    realtimeData.innerHTML = generateComponentHTML('fire');
                    break;
                case 'fire_old':
                    realtimeData.innerHTML = `
                        <!-- 灭火系统状态 -->
                        <div class="metrics-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">灭火系统状态</h3>
                                <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                    <i class="fas fa-cog"></i>
                                    <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                </button>
                            </div>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">系统状态</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">待命</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">系统就绪</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">七氟丙烷压力</div>
                                    <div class="metric-value">
                                        <span id="fire-pressure">${(4.2 + Math.random() * 0.6).toFixed(1)}</span>
                                        <span class="metric-unit">MPa</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">压力正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">灭火剂余量</div>
                                    <div class="metric-value">
                                        <span id="fire-agent-remaining">${(85 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">%</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">储量充足</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">喷嘴数量</div>
                                    <div class="metric-value">
                                        <span>12</span>
                                        <span class="metric-unit">个</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">全部正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">管路压力</div>
                                    <div class="metric-value">
                                        <span id="fire-pipe-pressure">${(0.8 + Math.random() * 0.4).toFixed(2)}</span>
                                        <span class="metric-unit">MPa</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">管路正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">启动模式</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #2563eb;">自动</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">自动+手动</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 探测系统 -->
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">探测系统</h3>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">烟雾探测器</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">4个探头在线</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">温度探测器</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">6个探头在线</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">气体探测器</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">CO/CO2探测</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">环境温度</div>
                                    <div class="metric-value">
                                        <span id="fire-env-temp">${(25 + Math.random() * 8).toFixed(1)}</span>
                                        <span class="metric-unit">°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">烟雾浓度</div>
                                    <div class="metric-value">
                                        <span id="fire-smoke-density">${(0.01 + Math.random() * 0.02).toFixed(3)}</span>
                                        <span class="metric-unit">%vol</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">浓度正常</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">CO浓度</div>
                                    <div class="metric-value">
                                        <span id="fire-co-concentration">${(5 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">ppm</span>
                                    </div>
                                    <div style="font-size: 12px; color: #10b981; margin-top: 4px;">浓度安全</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">报警阈值</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #666;">60°C</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">温度报警点</div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">最后检测</div>
                                    <div class="metric-value">
                                        <span style="font-size: 16px; color: #10b981;">正常</span>
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 4px;">2分钟前</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 检测记录 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">最近检测记录</h4>
                            <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px;">
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                    • 2024-01-28 10:00 - 月度检查完成<br>
                                    • 2024-01-15 14:30 - 压力测试正常<br>
                                    • 2023-12-28 09:00 - 年度维护完成<br>
                                    • 上次触发：无
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'electrical':
                    realtimeData.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin: 0; color: var(--text-primary);">配电柜 - 实时数据</h3>
                            <button onclick="location.reload()" style="padding: 6px 16px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                                <i class="fas fa-arrow-left" style="margin-right: 6px;"></i>返回整机
                            </button>
                        </div>
                        
                        <!-- 电气参数 -->
                        <div class="metrics-section">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">电气参数</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">A相电压</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">B相电压</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">C相电压</div>
                                    <div class="metric-value">
                                        <span>${(380 + Math.random() * 10).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">频率</div>
                                    <div class="metric-value">
                                        <span>${(49.9 + Math.random() * 0.2).toFixed(2)}</span>
                                        <span class="metric-unit">Hz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 开关状态 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">开关状态</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">主断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">PCS断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">电池断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">辅助电源</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                    
                case 'hv':
                case 'electrical':
                    realtimeData.innerHTML = `
                        <div class="metrics-section">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px;">高压箱实时数据</h3>
                            
                            <!-- 主断路器状态 -->
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">主断路器</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">合闸</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">防雷器状态</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">绝缘电阻</div>
                                    <div class="metric-value">
                                        <span>${(500 + Math.random() * 100).toFixed(0)}</span>
                                        <span class="metric-unit">MΩ</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">直流母线电压</div>
                                    <div class="metric-value">
                                        <span>${(750 + Math.random() * 20).toFixed(1)}</span>
                                        <span class="metric-unit">V</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 支路保护 -->
                        <div class="metrics-section" style="margin-top: 20px;">
                            <h4 style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">支路保护状态</h4>
                            <div class="metrics-grid">
                                <div class="metric-card">
                                    <div class="metric-label">电池支路</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">PCS支路</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">辅助电源</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">正常</span>
                                    </div>
                                </div>
                                <div class="metric-card">
                                    <div class="metric-label">接地状态</div>
                                    <div class="metric-value">
                                        <span style="color: #10b981;">良好</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                default:
                    // 默认显示整体数据
                    updateComponentData('overall');
            }
        }
        
        // 当前选中的组件
        let currentComponent = 'overall';
        
        // 切换组件标签页
        function switchComponent(component) {
            currentComponent = component;

            // 更新组件标签样式
            document.querySelectorAll('.component-tab').forEach(t => {
                t.classList.remove('active');
            });
            // 使用onclick属性精确匹配当前组件按钮
            const activeButton = document.querySelector(`.component-tab[onclick="switchComponent('${component}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }
            
            // 重置为实时数据tab
            document.querySelectorAll('.data-tab').forEach(t => {
                t.classList.remove('active');
            });
            document.querySelector('[onclick*="switchTab(\'realtime\'"]')?.classList.add('active');
            
            // 显示实时数据，隐藏其他tab内容
            document.getElementById('realtimeData').style.display = 'block';
            document.getElementById('historyData').style.display = 'none';
            document.getElementById('controlPanel').style.display = 'none';
            
            // 更新数据内容
            updateComponentData(component);
        }
        
        // 切换数据标签页
        function switchTab(tab, evt) {
            document.querySelectorAll('.data-tab').forEach(t => {
                t.classList.remove('active');
            });
            if (evt && evt.target) {
                evt.target.classList.add('active');
            } else {
                // 如果没有event,根据tab参数找到对应的按钮
                document.querySelector(`[onclick*="switchTab('${tab}',"]`)?.classList.add('active');
            }

            if (tab === 'realtime') {
                document.getElementById('realtimeData').style.display = 'block';
                document.getElementById('historyData').style.display = 'none';
                document.getElementById('controlPanel').style.display = 'none';
            } else if (tab === 'history') {
                document.getElementById('realtimeData').style.display = 'none';
                document.getElementById('historyData').style.display = 'block';
                document.getElementById('controlPanel').style.display = 'none';
                initHistoryCharts();
            } else if (tab === 'control') {
                document.getElementById('realtimeData').style.display = 'none';
                document.getElementById('historyData').style.display = 'none';
                document.getElementById('controlPanel').style.display = 'block';
                // 初始化时间轴
                setTimeout(() => {
                    initTimeline();
                    // 初始化时禁用所有控件（只保留编辑按钮和数据标签页可用）
                    const controlPanel = document.getElementById('controlPanel');
                    controlPanel.querySelectorAll('input, select, button').forEach(element => {
                        if (element.id !== 'editControlBtn' && 
                            !element.classList.contains('data-tab') && 
                            element.parentElement?.id !== 'controlButtons') {
                            element.disabled = true;
                            element.style.opacity = '0.6';
                            element.style.cursor = 'not-allowed';
                        }
                    });
                    // 保存时间轴容器引用
                    window.timelineContainer = document.getElementById('timelineContainer');
                    if (window.timelineContainer) {
                        window.timelineContainer.style.pointerEvents = 'none';
                    }
                }, 100);
            }
        }
        
        
        // 初始化历史图表
        function initHistoryCharts() {
            // 根据当前选中的组件显示不同的历史数据
            if (currentComponent === 'overall') {
                // 整机历史数据 - 根据字段设置动态显示
                let historyHtml = `
                    <!-- 设置按钮 -->
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 8px;">
                        <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                            <i class="fas fa-cog"></i>
                            <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                        </button>
                    </div>

                `;
                
                // 移除累计统计数据显示
                
                // 运行趋势图表部分
                if (shouldShowField('overall', 'history', 'powerTrend')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div class="chart-title">${getTranslation('cabinetChartPowerSOC')}</div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <input type="date" class="form-input" id="historyEndDatePicker" style="width: 140px; height: 32px; padding: 4px 8px; font-size: 13px;" onchange="updateHistoryChart()">
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="powerSocChart"></canvas>
                            </div>
                        </div>
                    `;
                }

                if (shouldShowField('overall', 'history', 'efficiency')) {
                    historyHtml += `
                        <div class="chart-container">
                            <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div class="chart-title">${getTranslation('cabinetChartRevenue')}</div>
                                <div style="display: flex; gap: 12px; align-items: center;">
                                    <select id="revenueTimeType" class="form-input" style="width: 120px; height: 32px; padding: 4px 8px;" onchange="updateRevenueAnalysisChart()">
                                        <option value="day" selected>${getTranslation('cabinetTimeTypeDay')}</option>
                                        <option value="month">${getTranslation('cabinetTimeTypeMonth')}</option>
                                        <option value="year">${getTranslation('cabinetTimeTypeYear')}</option>
                                        <option value="total">${getTranslation('cabinetTimeTypeTotal')}</option>
                                    </select>
                                    <input type="date" id="revenueDatePicker" class="form-input" style="width: 140px; height: 32px; padding: 4px 8px; display: none;" onchange="updateRevenueAnalysisChart()">
                                    <select id="revenueMonthPicker" class="form-input" style="width: 120px; height: 32px; padding: 4px 8px; display: none;" onchange="updateRevenueAnalysisChart()">
                                        <option value="2025-01">2025-01</option>
                                        <option value="2025-02">2025-02</option>
                                        <option value="2025-03">2025-03</option>
                                        <option value="2025-04">2025-04</option>
                                        <option value="2025-05">2025-05</option>
                                        <option value="2025-06">2025-06</option>
                                        <option value="2025-07" selected>2025-07</option>
                                        <option value="2025-08">2025-08</option>
                                        <option value="2025-09">2025-09</option>
                                        <option value="2025-10">2025-10</option>
                                        <option value="2025-11">2025-11</option>
                                        <option value="2025-12">2025-12</option>
                                    </select>
                                    <select id="revenueYearPicker" class="form-input" style="width: 120px; height: 32px; padding: 4px 8px; display: none;" onchange="updateRevenueAnalysisChart()">
                                        <option value="2023">2023</option>
                                        <option value="2024">2024</option>
                                        <option value="2025" selected>2025</option>
                                    </select>
                                </div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="revenueAnalysisChart"></canvas>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('historyData').innerHTML = historyHtml;
                
                // 初始化图表
                setTimeout(() => {
                    initOverallHistoryCharts();
                }, 100);
                return;
            }
            
            // 根据组件类型显示不同的历史数据
            if (currentComponent === 'ems') {
                // EMS历史数据 - 使用动态生成
                document.getElementById('historyData').innerHTML = generateHistoryHTML('ems');
                
                // 延迟初始化EMS图表
                setTimeout(() => {
                    initEMSHistoryCharts();
                }, 100);
                return;
            }
            
            if (currentComponent === 'pcs') {
                // PCS历史数据 - 使用动态生成
                document.getElementById('historyData').innerHTML = generateHistoryHTML('pcs');
                
                // 延迟初始化PCS图表
                setTimeout(() => {
                    initPCSHistoryCharts();
                }, 100);
                return;
            }
            
            if (currentComponent === 'bms') {
                // BMS历史数据 - 使用动态生成
                document.getElementById('historyData').innerHTML = generateHistoryHTML('bms');
                
                setTimeout(() => { initBMSHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'meter') {
                // 电表历史数据 - 使用动态生成
                document.getElementById('historyData').innerHTML = generateHistoryHTML('meter');
                
                setTimeout(() => { initMeterHistoryCharts(); }, 100);
                return;
            }
            
            if (currentComponent === 'thermal') {
                // 温度历史数据 - 使用动态生成
                document.getElementById('historyData').innerHTML = generateHistoryHTML('thermal');

                setTimeout(() => { initThermalHistoryCharts(); }, 100);
                return;
            }

            if (currentComponent === 'cooling') {
                // 液冷机组历史数据 - 使用动态生成
                document.getElementById('historyData').innerHTML = generateHistoryHTML('cooling');

                setTimeout(() => { initCoolingHistoryCharts(); }, 100);
                return;
            }

            if (currentComponent === 'fire') {
                // Fire历史数据 - 使用动态生成
                document.getElementById('historyData').innerHTML = generateHistoryHTML('fire');
                
                setTimeout(() => { initFireHistoryCharts(); }, 100);
                return;
            }
            
            // 其他组件的历史数据保持原样
            // 功率历史
            const powerCtx = document.getElementById('powerHistoryChart').getContext('2d');
            new Chart(powerCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: getTranslation('cabinetChartLegendChargePower'),
                        data: Array.from({length: 24}, (_, i) => {
                            // 模拟典型充放电曲线
                            if (i >= 10 && i <= 16) return Math.random() * 50 + 100;
                            if (i >= 6 && i <= 9) return -(Math.random() * 50 + 80);
                            if (i >= 18 && i <= 22) return -(Math.random() * 50 + 60);
                            return Math.random() * 20 - 10;
                        }),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return value > 0 ? `充电: ${value.toFixed(1)} kW` : `放电: ${Math.abs(value).toFixed(1)} kW`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: {
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return '#666';
                                    }
                                    return 'rgba(0, 0, 0, 0.05)';
                                }
                            }
                        }
                    }
                }
            });
            
            // SOC历史
            const socCtx = document.getElementById('socHistoryChart').getContext('2d');
            new Chart(socCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: getTranslation('cabinetChartLegendSOC'),
                        data: Array.from({length: 24}, (_, i) => {
                            // 模拟SOC变化
                            const base = 85;
                            if (i <= 6) return base - i * 2;
                            if (i <= 10) return 73 + (i - 6) * 5;
                            if (i <= 16) return 93 - (i - 10) * 2;
                            if (i <= 22) return 81 - (i - 16) * 3;
                            return 63 + (i - 22) * 11;
                        }),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: getTranslation('cabinetChartLegendChargeDischargeStatus'),
                        data: Array.from({length: 24}, (_, i) => {
                            if (i >= 10 && i <= 16) return 1; // 充电
                            if (i >= 6 && i <= 9) return -1; // 放电
                            if (i >= 18 && i <= 22) return -1; // 放电
                            return 0; // 待机
                        }),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        stepped: true,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: -1.5,
                            max: 1.5,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value === 1) return '充电';
                                    if (value === -1) return '放电';
                                    if (value === 0) return '待机';
                                    return '';
                                }
                            }
                        }
                    }
                }
            });
            
            // 温度分布
            const tempCtx = document.getElementById('tempHistoryChart').getContext('2d');
            new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 24}, (_, i) => i + ':00'),
                    datasets: [{
                        label: getTranslation('cabinetChartLegendMaxTemp'),
                        data: Array.from({length: 24}, () => Math.random() * 5 + 30),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4
                    }, {
                        label: getTranslation('cabinetChartLegendAvgTemp'),
                        data: Array.from({length: 24}, () => Math.random() * 5 + 27),
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4
                    }, {
                        label: getTranslation('cabinetChartLegendMinTemp'),
                        data: Array.from({length: 24}, () => Math.random() * 5 + 24),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // 电压一致性
            const voltageCtx = document.getElementById('voltageConsistencyChart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: getTranslation('cabinetChartLegendCellVoltageDistribution'),
                            data: Array.from({length: 100}, () => ({
                                x: Math.floor(Math.random() * 20) + 1,
                                y: 3.35 + (Math.random() - 0.5) * 0.01
                            })),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: getTranslation('cabinetChartAxisCellNumber')
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: getTranslation('cabinetChartAxisVoltage')
                                },
                                min: 3.34,
                                max: 3.36
                            }
                        }
                    }
                });
            }
            
            // 充放电效率分析
            const efficiencyCtx = document.getElementById('efficiencyChart');
            if (efficiencyCtx) {
                new Chart(efficiencyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        datasets: [{
                            label: getTranslation('cabinetChartLegendChargeEfficiency'),
                            data: [96.2, 96.5, 96.3, 96.8, 96.4, 96.1, 95.8, 95.5, 96.0, 96.3, 96.4, 96.2],
                            backgroundColor: '#10b981',
                            borderRadius: 4
                        }, {
                            label: getTranslation('cabinetChartLegendDischargeEfficiency'),
                            data: [95.8, 96.0, 95.9, 96.2, 96.0, 95.7, 95.4, 95.1, 95.6, 95.9, 96.0, 95.8],
                            backgroundColor: '#3b82f6',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 94,
                                max: 97,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 峰谷套利分析
            const arbitrageCtx = document.getElementById('arbitrageChart');
            if (arbitrageCtx) {
                new Chart(arbitrageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['00:00', '02:00', '04:00', '06:00', '08:00', '10:00', '12:00', '14:00', '16:00', '18:00', '20:00', '22:00'],
                        datasets: [{
                            label: getTranslation('cabinetChartLegendElectricityPrice'),
                            data: [0.3, 0.3, 0.3, 0.4, 0.8, 1.2, 1.5, 1.5, 1.2, 1.5, 1.2, 0.6],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: getTranslation('cabinetChartLegendPower'),
                            data: [150, 180, 200, 150, -100, -150, -180, -200, -150, -180, -100, 100],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: getTranslation('cabinetChartAxisElectricityPrice')
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: getTranslation('cabinetChartAxisPower')
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
            
            // 健康度趋势
            const sohTrendCtx = document.getElementById('sohTrendChart');
            if (sohTrendCtx) {
                new Chart(sohTrendCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['2023-01', '2023-03', '2023-05', '2023-07', '2023-09', '2023-11', '2024-01'],
                        datasets: [{
                            label: getTranslation('cabinetChartLegendSOH'),
                            data: [100, 99.5, 99.1, 98.5, 97.8, 97.2, 96.8],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981'
                        }, {
                            label: getTranslation('cabinetChartLegendPredictionTrend'),
                            data: [null, null, null, null, null, null, 96.8, 96.2, 95.5, 94.8],
                            borderColor: '#f59e0b',
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 94,
                                max: 100,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            annotation: {
                                annotations: {
                                    line1: {
                                        type: 'line',
                                        yMin: 95,
                                        yMax: 95,
                                        borderColor: 'rgb(255, 99, 132)',
                                        borderWidth: 2,
                                        borderDash: [5, 5]
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // 生成历史每日数据
        function generateHistoryDailyData(timeRange, endDate) {
            const end = new Date(endDate);
            const days = parseInt(timeRange);
            const labels = [];
            const powerData = [];
            const socData = [];
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(end);
                date.setDate(date.getDate() - i);
                
                // 格式化日期标签
                const label = `${date.getMonth() + 1}/${date.getDate()}`;
                labels.push(label);
                
                // 生成模拟功率数据（正数充电，负数放电）
                const basePower = 1000 + Math.sin(i * 0.5) * 800;
                const powerVariation = (Math.random() - 0.5) * 600;
                powerData.push(Math.round(basePower + powerVariation));
                
                // 生成模拟SOC数据
                const baseSOC = 75 + Math.sin(i * 0.3) * 15;
                const socVariation = (Math.random() - 0.5) * 10;
                socData.push(Math.max(20, Math.min(95, Math.round(baseSOC + socVariation))));
            }
            
            return { labels, powerData, socData };
        }
        
        // 更新历史图表
        function updateHistoryChart() {
            const endDate = document.getElementById('historyEndDatePicker').value;
            initOverallHistoryCharts('30d', endDate);
        }
        
        // 初始化收益分析图表
        function initRevenueChart(timeFilter = 'day', selectedTime = null) {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            
            const { labels, chargingData, dischargingData, revenueData } = generateRevenueData(timeFilter, selectedTime);
            
            new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: getTranslation('cabinetChartLegendChargeAmountUnit'),
                        data: chargingData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: getTranslation('cabinetChartLegendDischargeAmountUnit'),
                        data: dischargingData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 1,
                        yAxisID: 'y'
                    }, {
                        label: getTranslation('cabinetChartLegendNetRevenue'),
                        data: revenueData,
                        type: 'line',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderColor: '#f59e0b',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: false,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label.includes('收益')) {
                                        return context.dataset.label + ': ¥' + context.parsed.y.toLocaleString();
                                    } else {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' kWh';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: getTranslation('cabinetChartAxisEnergyKWh')
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: getTranslation('cabinetChartAxisRevenueYuan')
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // 生成收益分析数据
        function generateRevenueData(timeFilter, selectedTime = null) {
            let labels = [];
            let dataPoints = 0;
            
            switch(timeFilter) {
                case 'day':
                    // 选择具体日期当天的24小时时间点
                    dataPoints = 24;
                    for (let i = 0; i < 24; i++) {
                        labels.push(`${i}:00`);
                    }
                    break;
                case 'month':
                    // 选择具体月份的每一天
                    if (selectedTime) {
                        const [year, month] = selectedTime.split('-');
                        const daysInMonth = new Date(year, month, 0).getDate();
                        dataPoints = daysInMonth;
                        for (let i = 1; i <= daysInMonth; i++) {
                            labels.push(`${i}`);
                        }
                    } else {
                        // 默认显示当前月
                        const now = new Date();
                        const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
                        dataPoints = daysInMonth;
                        for (let i = 1; i <= daysInMonth; i++) {
                            labels.push(`${i}`);
                        }
                    }
                    break;
                case 'year':
                    // 选择具体年份的12个月
                    dataPoints = 12;
                    const selectedYear = selectedTime || new Date().getFullYear();
                    for (let i = 1; i <= 12; i++) {
                        labels.push(`${i}`);
                    }
                    break;
                case 'total':
                    // 总计按年显示
                    dataPoints = 5;
                    const currentYear = new Date().getFullYear();
                    for (let i = 4; i >= 0; i--) {
                        labels.push(`${currentYear - i}`);
                    }
                    break;
            }
            
            // 生成模拟数据
            const chargingData = [];
            const dischargingData = [];
            const revenueData = [];
            
            for (let i = 0; i < dataPoints; i++) {
                // 充电量数据
                const baseCharging = timeFilter === 'day' ? 2000 + Math.random() * 1000 : 
                                   timeFilter === 'month' ? 50000 + Math.random() * 25000 :
                                   timeFilter === 'year' ? 600000 + Math.random() * 200000 :
                                   150000 + Math.random() * 50000;
                chargingData.push(Math.round(baseCharging));
                
                // 放电量数据
                const baseDischarging = baseCharging * (0.85 + Math.random() * 0.1); // 85-95%效率
                dischargingData.push(Math.round(baseDischarging));
                
                // 收益数据（放电收入 - 充电成本）
                const chargingCost = chargingData[i] * 0.4; // 充电成本0.4元/kWh
                const dischargingRevenue = dischargingData[i] * 0.7; // 放电收入0.7元/kWh
                const netRevenue = dischargingRevenue - chargingCost;
                revenueData.push(Math.round(netRevenue));
            }
            
            return { labels, chargingData, dischargingData, revenueData };
        }
        
        // 初始化收益时间选择器
        function initRevenueTimePickers() {
            // 设置默认日期为今天
            const today = new Date();
            document.getElementById('revenueDayPicker').value = today.toISOString().split('T')[0];
            
            // 设置默认月份为当前月
            const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            document.getElementById('revenueMonthPicker').value = currentMonth;
            
            // 设置默认年份为当前年
            document.getElementById('revenueYearPicker').value = today.getFullYear().toString();
        }
        
        // 切换收益时间选择器显示
        function toggleRevenueTimePicker() {
            const timeFilter = document.getElementById('revenueTimeFilter').value;
            const dayPicker = document.getElementById('revenueDayPicker');
            const monthPicker = document.getElementById('revenueMonthPicker');
            const yearPicker = document.getElementById('revenueYearPicker');
            
            // 隐藏所有选择器
            dayPicker.style.display = 'none';
            monthPicker.style.display = 'none';
            yearPicker.style.display = 'none';
            
            // 根据时间类型显示对应选择器
            switch(timeFilter) {
                case 'day':
                    dayPicker.style.display = 'block';
                    break;
                case 'month':
                    monthPicker.style.display = 'block';
                    break;
                case 'year':
                    yearPicker.style.display = 'block';
                    break;
                case 'total':
                    // 总计不显示时间选择器
                    break;
            }
            
            // 更新图表
            updateRevenueChart();
        }
        
        // 更新收益分析图表
        function updateRevenueChart() {
            const timeFilter = document.getElementById('revenueTimeFilter').value;
            let selectedTime = null;
            
            // 获取选中的时间
            switch(timeFilter) {
                case 'day':
                    selectedTime = document.getElementById('revenueDayPicker').value;
                    break;
                case 'month':
                    selectedTime = document.getElementById('revenueMonthPicker').value;
                    break;
                case 'year':
                    selectedTime = document.getElementById('revenueYearPicker').value;
                    break;
                case 'total':
                    selectedTime = null;
                    break;
            }
            
            // 销毁现有图表
            const canvas = document.getElementById('revenueChart');
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }
            
            // 重新初始化图表
            initRevenueChart(timeFilter, selectedTime);
        }
        
        // 更新累计指标
        function updateCumulativeMetrics() {
            // 模拟累计数据更新
            // 移除累计数据更新逻辑
        }
        
        // 初始化EMS历史数据图表
        function initEMSHistoryCharts() {
            // EMS策略执行历史
            const strategyCtx = document.getElementById('emsStrategyChart');
            if (strategyCtx) {
                new Chart(strategyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendDispatchTimes'),
                            data: Array.from({length: 24}, () => Math.floor(Math.random() * 5) + 1),
                            backgroundColor: 'rgba(37, 99, 235, 0.8)',
                            borderColor: '#2563eb',
                            borderWidth: 1
                        }, {
                            label: getTranslation('cabinetChartLegendExecutionSuccessRate'),
                            data: Array.from({length: 24}, () => Math.random() * 10 + 90),
                            type: 'line',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: getTranslation('cabinetChartAxisDispatchTimes') }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: getTranslation('cabinetChartAxisSuccessRate') },
                                min: 80,
                                max: 100,
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // 调度响应时间
            const responseCtx = document.getElementById('emsResponseChart');
            if (responseCtx) {
                new Chart(responseCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendAvgResponseTime'),
                            data: Array.from({length: 24}, () => Math.random() * 30 + 20),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: getTranslation('cabinetChartLegendMaxResponseTime'),
                            data: Array.from({length: 24}, () => Math.random() * 50 + 40),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: getTranslation('cabinetChartAxisResponseTime') }
                            }
                        }
                    }
                });
            }
        }
        
        // 初始化PCS历史数据图表
        function initPCSHistoryCharts() {
            // PCS功率转换历史
            const powerCtx = document.getElementById('pcsPowerChart');
            if (powerCtx) {
                pcsChartInstances['pcs-power'] = new Chart(powerCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendACPowerOutput'),
                            data: Array.from({length: 24}, () => Math.random() * 100 + 50),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }, {
                            label: getTranslation('cabinetChartLegendDCPowerInput'),
                            data: Array.from({length: 24}, () => Math.random() * 110 + 55),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: getTranslation('cabinetChartAxisPower') }
                            }
                        }
                    }
                });
            }
            
            // 电压电流趋势
            const voltageCtx = document.getElementById('pcsVoltageChart');
            if (voltageCtx) {
                pcsChartInstances['pcs-voltage'] = new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendDCVoltage'),
                            data: Array.from({length: 24}, () => Math.random() * 20 + 750),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: getTranslation('cabinetChartLegendDCCurrent'),
                            data: Array.from({length: 24}, () => Math.random() * 50 + 150),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                position: 'left',
                                title: { display: true, text: getTranslation('cabinetChartAxisVoltage') }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: getTranslation('cabinetChartAxisCurrent') },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }
            
            // 转换效率统计
            const efficiencyCtx = document.getElementById('pcsEfficiencyChart');
            if (efficiencyCtx) {
                pcsChartInstances['pcs-efficiency'] = new Chart(efficiencyCtx.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendConversionEfficiency'),
                            data: Array.from({length: 24}, () => Math.random() * 5 + 93),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                min: 90,
                                max: 100,
                                title: { display: true, text: getTranslation('cabinetChartAxisEfficiency') }
                            }
                        }
                    }
                });
            }
        }
        
        // 处理BMS图表的日期选择
        function changeBMSChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            // 这里可以根据选择的日期重新加载对应的图表数据
            // 实际应用中，这里会调用相应的数据更新函数来获取特定日期的数据
        }

        // 存储电表图表实例
        let meterChartInstances = {};

        // 存储温度图表实例
        let thermalChartInstances = {};
        
        // 存储消防图表实例
        let fireChartInstances = {};
        
        // 存储PCS图表实例
        let pcsChartInstances = {};

        // 处理电表图表的日期选择
        function changeMeterChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // 根据选择的日期生成对应的数据
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // 使用日期作为随机数种子，确保同一天的数据保持一致
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = (seed + i * 37) % 100 / 100;
                    return base + pseudoRandom * variation;
                });
            };

            const chartInstance = meterChartInstances[chartId];
            if (!chartInstance) return;

            switch(chartId) {
                case 'meter-power-trend':
                    chartInstance.data.datasets[0].data = generateData(184.4, 40);
                    chartInstance.data.datasets[1].data = generateData(31.9, 15);
                    chartInstance.data.datasets[2].data = generateData(255.4, 50);
                    break;
                    
                case 'meter-energy-stats':
                    chartInstance.data.datasets[0].data = generateData(52.1, 25);
                    chartInstance.data.datasets[1].data = generateData(7.8, 8);
                    break;
                    
                case 'meter-voltage-quality':
                    chartInstance.data.datasets[0].data = generateData(382.5, 6);
                    chartInstance.data.datasets[1].data = generateData(383.1, 6);
                    chartInstance.data.datasets[2].data = generateData(381.8, 6);
                    break;
                    
                case 'meter-harmonic':
                    const harmonicBaseData = [2.8, 2.3, 1.9, 1.4, 1.1, 0.8, 0.6, 0.5, 0.4, 0.3, 0.3, 0.2];
                    const harmonicData = harmonicBaseData.map((base, i) => {
                        const pseudoRandom = (seed + i * 53) % 100 / 100;
                        return Math.max(0.1, base + (pseudoRandom - 0.5) * base * 0.3);
                    });
                    chartInstance.data.datasets[0].data = harmonicData;
                    break;
            }
            
            chartInstance.update();
        }

        // 处理温度图表的日期选择
        function changeThermalChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // 根据选择的日期生成对应的数据
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // 使用日期作为随机数种子，确保同一天的数据保持一致
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = (seed + i * 41) % 100 / 100;
                    return base + pseudoRandom * variation;
                });
            };

            const chartInstance = thermalChartInstances[chartId];
            if (!chartInstance) return;

            switch(chartId) {
                case 'thermal-temp':
                    chartInstance.data.datasets[0].data = generateData(39.9, 5);
                    chartInstance.data.datasets[1].data = generateData(25.5, 3);
                    chartInstance.data.datasets[2].data = generateData(32.8, 4);
                    break;
                    
                case 'thermal-cooling':
                    chartInstance.data.datasets[0].data = generateData(1241, 200);
                    chartInstance.data.datasets[1].data = generateData(1115, 150);
                    chartInstance.data.datasets[2].data = generateData(5.8, 1.2);
                    break;
                    
                case 'thermal-heatmap':
                    // 温度热力图使用特殊的网格数据格式
                    const heatmapData = [];
                    for (let x = 0; x < 10; x++) {
                        for (let y = 0; y < 8; y++) {
                            const temp = 25 + (seed + x * 7 + y * 3) % 20;
                            heatmapData.push({x, y, v: temp});
                        }
                    }
                    chartInstance.data.datasets[0].data = heatmapData;
                    break;
            }
            
            chartInstance.update();
        }
        
        // 消防图表日期变更函数
        function changeFireChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // 根据选择的日期生成对应的数据
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // 使用日期作为随机数种子，确保同一天的数据保持一致
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = Math.sin(seed * 9.7 + i * 2.3) * 0.5 + 0.5;
                    return (base + (pseudoRandom - 0.5) * variation).toFixed(1);
                });
            };
            
            // 获取图表实例并更新数据
            const chartInstance = fireChartInstances[chartId];
            if (!chartInstance) return;
            
            switch (chartId) {
                case 'fire-system':
                    // 系统状态历史 - 状态分布图
                    chartInstance.data.datasets[0].data = [75, 20, 3, 2]; // 正常、警告、故障、维护
                    break;
                case 'fire-gas':
                    // 气体浓度监测
                    chartInstance.data.datasets[0].data = generateData(0.01, 0.02); // CO浓度
                    chartInstance.data.datasets[1].data = generateData(0.003, 0.005); // 烟雾浓度
                    break;
                case 'fire-alarm':
                    // 告警记录分析 - 告警次数
                    chartInstance.data.datasets[0].data = Array.from({length: 24}, (_, i) => {
                        const pseudoRandom = Math.sin(seed * 7.1 + i * 1.8) * 0.5 + 0.5;
                        return Math.floor(pseudoRandom * 3); // 0-2次告警
                    });
                    break;
            }
            
            chartInstance.update();
        }
        
        // PCS图表日期变更函数
        function changePCSChartDate(chartId, selectedDate) {
            console.log(`Loading data for ${chartId} on date: ${selectedDate}`);
            
            // 根据选择的日期生成对应的数据
            const dateObj = new Date(selectedDate);
            const dayOfYear = Math.floor((dateObj - new Date(dateObj.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            
            // 使用日期作为随机数种子，确保同一天的数据保持一致
            const seed = dayOfYear;
            const generateData = (base, variation, count = 24) => {
                return Array.from({length: count}, (_, i) => {
                    const pseudoRandom = Math.sin(seed * 8.3 + i * 1.9) * 0.5 + 0.5;
                    return (base + (pseudoRandom - 0.5) * variation).toFixed(1);
                });
            };
            
            // 获取图表实例并更新数据
            const chartInstance = pcsChartInstances[chartId];
            if (!chartInstance) return;
            
            switch (chartId) {
                case 'pcs-power':
                    // PCS功率转换历史
                    chartInstance.data.datasets[0].data = generateData(125, 30); // 充电功率
                    chartInstance.data.datasets[1].data = generateData(-98, 25); // 放电功率
                    break;
                case 'pcs-voltage':
                    // 电压电流趋势
                    chartInstance.data.datasets[0].data = generateData(385, 10); // 电压
                    chartInstance.data.datasets[1].data = generateData(95, 15); // 电流
                    break;
                case 'pcs-efficiency':
                    // 转换效率分析
                    chartInstance.data.datasets[0].data = generateData(96.5, 2); // 转换效率
                    chartInstance.data.datasets[1].data = generateData(3.8, 1.5); // 损耗功率
                    break;
            }
            
            chartInstance.update();
        }
        
        // 初始化BMS历史数据图表
        function initBMSHistoryCharts() {
            // 电池SOC趋势
            const socCtx = document.getElementById('bms-soc-chart');
            if (socCtx) {
                new Chart(socCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendSOC'),
                            data: Array.from({length: 24}, () => Math.random() * 10 + 85),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true, position: 'top' },
                            title: { display: false }
                        },
                        scales: {
                            y: { 
                                min: 0,
                                max: 100,
                                title: { display: true, text: getTranslation('cabinetChartAxisSOC') } 
                            },
                            x: {
                                title: { display: false }
                            }
                        }
                    }
                });
            }
            
            // 电池电压历史 - 显示最高、平均、最低电压
            const voltageCtx = document.getElementById('bms-voltage-chart');
            if (voltageCtx) {
                new Chart(voltageCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendMaxVoltage'),
                            data: Array.from({length: 24}, () => Math.random() * 10 + 770),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: getTranslation('cabinetChartLegendAvgVoltage'),
                            data: Array.from({length: 24}, () => Math.random() * 8 + 755),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: getTranslation('cabinetChartLegendMinVoltage'),
                            data: Array.from({length: 24}, () => Math.random() * 8 + 740),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: true, position: 'top' },
                            title: { display: false }
                        },
                        scales: {
                            y: { 
                                title: { display: true, text: getTranslation('cabinetChartAxisVoltage') },
                                min: 730,
                                max: 790
                            },
                            x: {
                                title: { display: false }
                            }
                        }
                    }
                });
            }
            
            // 温度分布分析
            const tempCtx = document.getElementById('bms-temp-chart');
            if (tempCtx) {
                new Chart(tempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: getTranslation('cabinetChartLegendMaxTemp'),
                            data: Array.from({length: 24}, () => Math.random() * 5 + 35),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: getTranslation('cabinetChartLegendAvgTemp'),
                            data: Array.from({length: 24}, () => Math.random() * 3 + 30),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: getTranslation('cabinetChartLegendMinTemp'),
                            data: Array.from({length: 24}, () => Math.random() * 3 + 25),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: { 
                                title: { display: true, text: getTranslation('cabinetChartAxisTemperature') },
                                min: 20,
                                max: 45
                            },
                            x: {
                                title: { display: false }
                            }
                        }
                    }
                });
            }
        }
        
        // 初始化电表历史数据图表
        function initMeterHistoryCharts() {
            // 功率趋势分析
            if (shouldShowField('meter', 'history', 'powerTrendAnalysis')) {
                const powerTrendCtx = document.getElementById('meter-power-trend-chart');
                if (powerTrendCtx) {
                    meterChartInstances['meter-power-trend'] = new Chart(powerTrendCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: getTranslation('cabinetChartLegendActivePower'),
                                data: Array.from({length: 24}, () => Math.random() * 50 + 150),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: getTranslation('cabinetChartLegendReactivePower'),
                                data: Array.from({length: 24}, () => Math.random() * 20 + 20),
                                borderColor: '#f59e0b',
                                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: getTranslation('cabinetChartLegendApparentPower'),
                                data: Array.from({length: 24}, () => Math.random() * 60 + 200),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: getTranslation('cabinetChartAxisPowerMulti') },
                                    beginAtZero: true
                                },
                                x: { title: { display: false } }
                            }
                        }
                    });
                }
            }
            
            // 电量消耗统计
            if (shouldShowField('meter', 'history', 'energyConsumptionStats')) {
                const energyStatsCtx = document.getElementById('meter-energy-stats-chart');
                if (energyStatsCtx) {
                    meterChartInstances['meter-energy-stats'] = new Chart(energyStatsCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: getTranslation('cabinetChartLegendActiveEnergy'),
                                data: Array.from({length: 24}, () => Math.random() * 100 + 50),
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: '#3b82f6',
                                borderWidth: 1
                            }, {
                                label: getTranslation('cabinetChartLegendReactiveEnergy'),
                                data: Array.from({length: 24}, () => Math.random() * 20 + 10),
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderColor: '#f59e0b',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: getTranslation('cabinetChartAxisEnergy') },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
            
            // 电压质量监测
            if (shouldShowField('meter', 'history', 'voltageQualityMonitoring')) {
                const voltageQualityCtx = document.getElementById('meter-voltage-quality-chart');
                if (voltageQualityCtx) {
                    meterChartInstances['meter-voltage-quality'] = new Chart(voltageQualityCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: getTranslation('cabinetChartLegendPhaseAVoltage'),
                                data: Array.from({length: 24}, () => Math.random() * 10 + 375),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: getTranslation('cabinetChartLegendPhaseBVoltage'),
                                data: Array.from({length: 24}, () => Math.random() * 10 + 380),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: getTranslation('cabinetChartLegendPhaseCVoltage'),
                                data: Array.from({length: 24}, () => Math.random() * 10 + 370),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: getTranslation('cabinetChartAxisVoltage') },
                                    min: 350,
                                    max: 400
                                },
                                x: { title: { display: false } }
                            }
                        }
                    });
                }
            }
            
            // 谐波分析
            if (shouldShowField('meter', 'history', 'harmonicAnalysis')) {
                const harmonicCtx = document.getElementById('meter-harmonic-chart');
                if (harmonicCtx) {
                    meterChartInstances['meter-harmonic'] = new Chart(harmonicCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [
                                getTranslation('harmonicFundamental'),
                                `2${getTranslation('harmonicOrder')}`,
                                `3${getTranslation('harmonicOrder')}`,
                                `4${getTranslation('harmonicOrder')}`,
                                `5${getTranslation('harmonicOrder')}`,
                                `6${getTranslation('harmonicOrder')}`,
                                `7${getTranslation('harmonicOrder')}`,
                                `8${getTranslation('harmonicOrder')}`,
                                `9${getTranslation('harmonicOrder')}`,
                                `10${getTranslation('harmonicOrder')}`,
                                `11${getTranslation('harmonicOrder')}`,
                                `12${getTranslation('harmonicOrder')}`
                            ],
                            datasets: [{
                                label: getTranslation('cabinetChartLegendHarmonicContent'),
                                data: [2.8, 2.3, 1.9, 1.4, 1.1, 0.8, 0.6, 0.5, 0.4, 0.3, 0.3, 0.2],
                                backgroundColor: [
                                    'rgba(59, 130, 246, 0.8)',   // 基波 - 蓝色
                                    'rgba(239, 68, 68, 0.8)',    // 2次 - 红色
                                    'rgba(245, 158, 11, 0.8)',   // 3次 - 橙色
                                    'rgba(16, 185, 129, 0.8)',   // 5次 - 绿色
                                    'rgba(139, 69, 19, 0.8)',    // 7次 - 棕色
                                    'rgba(147, 51, 234, 0.8)',   // 9次 - 紫色
                                    'rgba(236, 72, 153, 0.8)',   // 11次 - 粉色
                                    'rgba(14, 165, 233, 0.8)',   // 13次 - 天蓝色
                                    'rgba(34, 197, 94, 0.8)',    // 15次 - 浅绿色
                                    'rgba(251, 191, 36, 0.8)',   // 17次 - 黄色
                                    'rgba(168, 85, 247, 0.8)',   // 19次 - 浅紫色
                                    'rgba(244, 63, 94, 0.8)'     // 21次 - 玫红色
                                ],
                                borderColor: [
                                    '#3b82f6', '#ef4444', '#f59e0b', '#10b981',
                                    '#8b4513', '#9333ea', '#ec4899', '#0ea5e9',
                                    '#22c55e', '#fbbf24', '#a855f7', '#f43f5e'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { display: false }
                            },
                            scales: { 
                                y: { 
                                    title: { display: true, text: getTranslation('cabinetChartAxisHarmonic') },
                                    beginAtZero: true
                                },
                                x: { title: { display: false } }
                            }
                        }
                    });
                }
            }
        }
        
        // 初始化温度历史数据图表
        function initThermalHistoryCharts() {
            // 温度分布历史
            if (shouldShowField('thermal', 'history', 'tempDistribution')) {
                const tempCtx = document.getElementById('thermalTempChart');
                if (tempCtx) {
                    thermalChartInstances['thermal-temp'] = new Chart(tempCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: getTranslation('cabinetChartLegendBatteryMaxTemp'),
                                data: Array.from({length: 24}, () => (39.9 + (Math.random() - 0.5) * 5).toFixed(1)),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: getTranslation('cabinetChartLegendBatteryMinTemp'),
                                data: Array.from({length: 24}, () => (25.5 + (Math.random() - 0.5) * 3).toFixed(1)),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }, {
                                label: getTranslation('cabinetChartLegendBatteryAvgTemp'),
                                data: Array.from({length: 24}, () => (32.8 + (Math.random() - 0.5) * 4).toFixed(1)),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: {
                                y: {
                                    title: { display: true, text: getTranslation('cabinetChartAxisTemperature') },
                                    min: 20,
                                    max: 50
                                }
                            }
                        }
                    });
                }
            }
            
            // 冷却系统运行
            if (shouldShowField('thermal', 'history', 'coolingSystem')) {
                const coolingCtx = document.getElementById('thermalCoolingChart');
                if (coolingCtx) {
                    thermalChartInstances['thermal-cooling'] = new Chart(coolingCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: getTranslation('cabinetChartLegendInletTemp'),
                                data: Array.from({length: 24}, () => (28.5 + (Math.random() - 0.5) * 3).toFixed(1)),
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y'
                            }, {
                                label: getTranslation('cabinetChartLegendOutletTemp'),
                                data: Array.from({length: 24}, () => (22.8 + (Math.random() - 0.5) * 2.5).toFixed(1)),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y'
                            }, {
                                label: getTranslation('cabinetChartLegendHumidity'),
                                data: Array.from({length: 24}, () => (65.2 + (Math.random() - 0.5) * 8).toFixed(1)),
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: getTranslation('cabinetChartAxisTemperature') },
                                    min: 18,
                                    max: 35
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: getTranslation('cabinetChartAxisHumidity') },
                                    min: 50,
                                    max: 80,
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }
            }
            
            // 主风机转速和制冷功耗
            if (shouldShowField('thermal', 'history', 'heatMap')) {
                const heatMapCtx = document.getElementById('thermalHeatMapChart');
                if (heatMapCtx) {
                    thermalChartInstances['thermal-heatmap'] = new Chart(heatMapCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: getTranslation('cabinetChartLegendMainFanSpeed'),
                                data: Array.from({length: 24}, () => (1241 + (Math.random() - 0.5) * 200).toFixed(0)),
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                yAxisID: 'y'
                            }, {
                                label: getTranslation('cabinetChartLegendCoolingPower'),
                                data: Array.from({length: 24}, () => (5.8 + (Math.random() - 0.5) * 1.2).toFixed(1)),
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: '#ef4444',
                                borderWidth: 2,
                                type: 'line',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { 
                                legend: { position: 'top' }
                            },
                            scales: {
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: { display: true, text: getTranslation('cabinetChartAxisSpeed') },
                                    min: 800,
                                    max: 1600
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: { display: true, text: getTranslation('cabinetChartAxisPowerConsumption') },
                                    min: 3,
                                    max: 8,
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }
            }
        }

        // 初始化液冷机组历史图表
        function initCoolingHistoryCharts() {
            // 温度历史曲线
            const tempCtx = document.getElementById('coolingTempChart');
            if (tempCtx) {
                new Chart(tempCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '出水温度',
                            data: Array.from({length: 24}, () => (18 + Math.random() * 2).toFixed(1)),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '进水温度',
                            data: Array.from({length: 24}, () => (22 + Math.random() * 2).toFixed(1)),
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: '温度 (°C)' },
                                min: 15,
                                max: 30
                            }
                        }
                    }
                });
            }

            // 压力历史曲线
            const pressureCtx = document.getElementById('coolingPressureChart');
            if (pressureCtx) {
                new Chart(pressureCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '出水压力',
                            data: Array.from({length: 24}, () => (2.5 + Math.random() * 0.5).toFixed(2)),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }, {
                            label: '进水压力',
                            data: Array.from({length: 24}, () => (2.2 + Math.random() * 0.3).toFixed(2)),
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: '压力 (bar)' },
                                min: 1.5,
                                max: 3.5
                            }
                        }
                    }
                });
            }

            // 水泵转速历史曲线
            const pumpCtx = document.getElementById('coolingPumpChart');
            if (pumpCtx) {
                new Chart(pumpCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                        datasets: [{
                            label: '水泵转速',
                            data: Array.from({length: 24}, () => (1200 + Math.random() * 300).toFixed(0)),
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        },
                        scales: {
                            y: {
                                title: { display: true, text: '转速 (RPM)' },
                                min: 1000,
                                max: 1800
                            }
                        }
                    }
                });
            }
        }

        // 更新温度历史图表
        function updateThermalHistoryCharts() {
            // 重新初始化图表
            initThermalHistoryCharts();
        }
        
        // 初始化消防历史数据图表
        function initFireHistoryCharts() {
            // 系统状态历史
            if (shouldShowField('fire', 'history', 'systemStatus')) {
                const systemCtx = document.getElementById('fireSystemChart');
                if (systemCtx) {
                    fireChartInstances['fire-system'] = new Chart(systemCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: [
                                getTranslation('fireStatusNormal'),
                                getTranslation('fireStatusWarning'),
                                getTranslation('fireStatusAlarm')
                            ],
                            datasets: [{
                                data: [95, 4, 1],
                                backgroundColor: ['#10b981', '#f59e0b', '#dc2626'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
            }
            
            // 气体浓度监测
            if (shouldShowField('fire', 'history', 'gasConcentration')) {
                const gasCtx = document.getElementById('fireGasChart');
                if (gasCtx) {
                    fireChartInstances['fire-gas'] = new Chart(gasCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                            datasets: [{
                                label: getTranslation('cabinetChartLegendCOConcentration'),
                                data: Array.from({length: 24}, () => Math.random() * 10 + 5),
                                borderColor: '#dc2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                borderWidth: 2,
                                tension: 0.4
                            }, {
                                label: getTranslation('cabinetChartLegendSmokeConcentration'),
                                data: Array.from({length: 24}, () => Math.random() * 8 + 3),
                                borderColor: '#6b7280',
                                backgroundColor: 'rgba(107, 114, 128, 0.1)',
                                borderWidth: 2,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'top' } },
                            scales: { y: { beginAtZero: true, title: { display: true, text: getTranslation('cabinetChartAxisConcentration') } } }
                        }
                    });
                }
            }
            
            // 告警记录分析
            if (shouldShowField('fire', 'history', 'alarmHistory')) {
                const alarmCtx = document.getElementById('fireAlarmChart');
                if (alarmCtx) {
                    fireChartInstances['fire-alarm'] = new Chart(alarmCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['1', '2', '3', '4', '5', '6'],
                            datasets: [{
                                label: getTranslation('cabinetChartLegendSmokeAlarm'),
                                data: [2, 1, 0, 1, 0, 1],
                                backgroundColor: 'rgba(107, 114, 128, 0.8)',
                                borderColor: '#6b7280',
                                borderWidth: 1
                            }, {
                                label: getTranslation('cabinetChartLegendTempAlarm'),
                                data: [1, 0, 2, 0, 1, 0],
                                backgroundColor: 'rgba(245, 158, 11, 0.8)',
                                borderColor: '#f59e0b',
                                borderWidth: 1
                            }, {
                                label: getTranslation('cabinetChartLegendGasAlarm'),
                                data: [0, 1, 1, 0, 0, 1],
                                backgroundColor: 'rgba(220, 38, 38, 0.8)',
                                borderColor: '#dc2626',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'top' },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            label += context.parsed.y;
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: getTranslation('cabinetChartAxisAlarmTimes') },
                                    ticks: {
                                        stepSize: 1
                                    }
                                },
                                x: {
                                    stacked: true
                                }
                            }
                        }
                    });
                }
            }
        }
        
        // 收益分析图表相关函数
        let revenueAnalysisChartInstance = null;
        
        // 初始化收益分析图表
        function initRevenueAnalysisChart() {
            // 设置默认日期为今天
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('revenueDatePicker').value = todayStr;
            
            updateRevenueAnalysisChart();
        }
        
        // 更新收益分析图表
        function updateRevenueAnalysisChart() {
            const timeType = document.getElementById('revenueTimeType').value;
            
            // 控制时间选择器的显示
            document.getElementById('revenueDatePicker').style.display = timeType === 'day' ? 'block' : 'none';
            document.getElementById('revenueMonthPicker').style.display = timeType === 'month' ? 'block' : 'none';
            document.getElementById('revenueYearPicker').style.display = timeType === 'year' ? 'block' : 'none';
            
            // 如果是日选项但没有设置日期，设置为今天
            if (timeType === 'day' && !document.getElementById('revenueDatePicker').value) {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                document.getElementById('revenueDatePicker').value = todayStr;
            }
            
            // 生成图表数据
            const { labels, chargingData, dischargingData, revenueData } = generateRevenueAnalysisData(timeType);
            
            const ctx = document.getElementById('revenueAnalysisChart');
            if (!ctx) return;
            
            // 销毁现有图表
            if (revenueAnalysisChartInstance) {
                revenueAnalysisChartInstance.destroy();
            }
            
            // 创建混合图表
            revenueAnalysisChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: getTranslation('cabinetChartLegendChargeAmount'),
                        data: chargingData,
                        backgroundColor: '#10b981',
                        borderRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: getTranslation('cabinetChartLegendDischargeAmount'),
                        data: dischargingData,
                        backgroundColor: '#3b82f6',
                        borderRadius: 4,
                        yAxisID: 'y'
                    }, {
                        label: getTranslation('cabinetChartLegendRevenue'),
                        data: revenueData,
                        type: 'line',
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        yAxisID: 'y1',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: getTranslation('cabinetChartAxisEnergyKWh')
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: getTranslation('cabinetChartAxisRevenueYuan2')
                            },
                            beginAtZero: true,
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + '元';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 生成收益分析数据
        function generateRevenueAnalysisData(timeType) {
            let labels = [];
            let chargingData = [];
            let dischargingData = [];
            let revenueData = [];

            const today = new Date();
            // 获取当前语言设置
            const currentLanguage = localStorage.getItem('language') || 'zh';

            switch(timeType) {
                case 'day':
                    // 24小时数据
                    for (let i = 0; i < 24; i++) {
                        labels.push(i + ':00');
                        chargingData.push(Math.random() * 100 + 50);
                        dischargingData.push(Math.random() * 80 + 40);
                        revenueData.push(Math.random() * 500 + 200);
                    }
                    break;
                case 'month':
                    // 一个月31天的数据
                    for (let i = 1; i <= 31; i++) {
                        if (currentLanguage === 'en') {
                            labels.push(String(i));  // 英文：只显示数字
                        } else {
                            labels.push(i + '日');  // 中文：显示数字+日
                        }
                        chargingData.push(Math.random() * 2000 + 1000);
                        dischargingData.push(Math.random() * 1800 + 900);
                        revenueData.push(Math.random() * 8000 + 4000);
                    }
                    break;
                case 'year':
                    // 12个月数据
                    if (currentLanguage === 'en') {
                        // 英文：显示英文月份简写
                        const monthsEn = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        monthsEn.forEach(month => {
                            labels.push(month);
                            chargingData.push(Math.random() * 50000 + 25000);
                            dischargingData.push(Math.random() * 45000 + 22000);
                            revenueData.push(Math.random() * 200000 + 100000);
                        });
                    } else {
                        // 中文：显示数字+月
                        const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                        months.forEach(month => {
                            labels.push(month);
                            chargingData.push(Math.random() * 50000 + 25000);
                            dischargingData.push(Math.random() * 45000 + 22000);
                            revenueData.push(Math.random() * 200000 + 100000);
                        });
                    }
                    break;
                case 'total':
                default:
                    // 总览 - 按年显示
                    if (currentLanguage === 'en') {
                        // 英文：只显示年份数字
                        const years = ['2021', '2022', '2023', '2024', '2025'];
                        years.forEach(year => {
                            labels.push(year);
                            chargingData.push(Math.random() * 600000 + 300000);
                            dischargingData.push(Math.random() * 550000 + 280000);
                            revenueData.push(Math.random() * 2500000 + 1200000);
                        });
                    } else {
                        // 中文：显示年份+年
                        const years = ['2021年', '2022年', '2023年', '2024年', '2025年'];
                        years.forEach(year => {
                            labels.push(year);
                            chargingData.push(Math.random() * 600000 + 300000);
                            dischargingData.push(Math.random() * 550000 + 280000);
                            revenueData.push(Math.random() * 2500000 + 1200000);
                        });
                    }
                    break;
            }

            return { labels, chargingData, dischargingData, revenueData };
        }
        
        // 初始化整机历史数据图表
        function initOverallHistoryCharts(timeRange = '30d', endDate = null) {
            // 设置默认日期为今天
            if (!endDate) {
                const today = new Date();
                document.getElementById('historyEndDatePicker').value = today.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
            }
            
            // 生成每日数据
            const { labels, powerData, socData } = generateHistoryDailyData(timeRange, endDate);
            
            // 功率与SOC综合分析
            const powerSocCtx = document.getElementById('powerSocChart');
            if (powerSocCtx) {
                new Chart(powerSocCtx.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: getTranslation('cabinetChartLegendPower'),
                            data: powerData,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y',
                            fill: true
                        }, {
                            label: getTranslation('cabinetChartLegendSOC'),
                            data: socData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            yAxisID: 'y1',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    usePointStyle: true
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: getTranslation('cabinetChartAxisPower')
                                },
                                grid: {
                                    color: function(context) {
                                        if (context.tick.value === 0) {
                                            return '#666';
                                        }
                                        return 'rgba(0, 0, 0, 0.05)';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: getTranslation('cabinetChartAxisSOC')
                                },
                                min: 0,
                                max: 100,
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
            
            // 收益分析图表初始化
            initRevenueAnalysisChart();
        }
        
        // 鼠标点击事件
        // 3D相关函数已删除 - onMouseClick
        function onMouseClick(event) {
            // onMouseClick 3D函数已删除
        }
        
        // 鼠标移动事件
        // 3D相关函数已删除 - onMouseMove
        function onMouseMove(event) {
            // onMouseMove 3D函数已删除
        }
        
        // 窗口大小调整
        // 3D相关函数已删除 - onWindowResize
        function onWindowResize() {
            // onWindowResize 3D函数已删除
        }
        
        // 动画循环
        // 3D相关函数已删除 - animate
        function animate() {
            // animate 3D函数已删除
        }

        // 获取翻译文本的辅助函数
        function getTranslation(key) {
            // 安全检查：确保 translations 对象存在
            if (typeof translations === 'undefined') {
                console.warn('翻译对象未加载，返回原始键值:', key);
                return key;
            }

            let lang = localStorage.getItem('language') || 'zh';

            // 处理语言代码变体（如 en-US → en, zh-CN → zh）
            if (!translations[lang]) {
                // 尝试使用语言代码的前两位
                const baseLang = lang.split('-')[0];
                if (translations[baseLang]) {
                    lang = baseLang;
                } else {
                    console.warn(`语言 "${lang}" 的翻译数据不存在，回退到中文`);
                    lang = 'zh';
                }
            }

            // 返回翻译文本，如果不存在则返回键值
            return translations[lang][key] || key;
        }

        // 更新储能柜名称
        function updateCabinetName() {
            const cabinetNameElement = document.getElementById('cabinetNameTop');
            if (cabinetNameElement) {
                // 从URL获取cabinetId，默认为001
                const urlParams = new URLSearchParams(window.location.search);
                const cabinetId = urlParams.get('cabinetId') || '001';
                // 使用翻译函数构建名称
                const prefix = getTranslation('cabinetNamePrefix');
                cabinetNameElement.textContent = `${prefix} ${cabinetId}`;
            }

            // 更新图片alt属性
            const imgElement = document.getElementById('cabinetStructureImg');
            if (imgElement) {
                imgElement.alt = getTranslation('cabinetStructureTitle');
            }
        }

        // 安全更新元素的辅助函数
        function safeUpdateElement(elementId, updateFn) {
            const element = document.getElementById(elementId);
            if (element) {
                updateFn(element);
                return true;
            }
            return false;
        }

        // 更新实时数据值
        function updateRealtimeValues() {
            // 更新核心运行参数
            const power = 100 + Math.random() * 50;

            const powerElement = document.getElementById('power');
            const random = Math.random();
            let isCharging = false;
            let isDischarging = false;
            let operationStatus = '';
            let statusIcon = '';
            let statusColor = '';

            if (random < 0.4) {
                // 充电状态
                isCharging = true;
                if (powerElement) {
                    powerElement.textContent = '+' + power.toFixed(1);
                    powerElement.style.color = '#10b981';
                }
                operationStatus = getTranslation('cabinetStatusCharging');
                statusIcon = 'fa-bolt';
                statusColor = '#10b981';
            } else if (random < 0.7) {
                // 放电状态
                isDischarging = true;
                if (powerElement) {
                    powerElement.textContent = '-' + power.toFixed(1);
                    powerElement.style.color = '#f59e0b';
                }
                operationStatus = getTranslation('cabinetStatusDischarging');
                statusIcon = 'fa-battery-three-quarters';
                statusColor = '#f59e0b';
            } else {
                // 待机状态
                if (powerElement) {
                    powerElement.textContent = '0.0';
                    powerElement.style.color = '#6b7280';
                }
                operationStatus = getTranslation('cabinetStatusStandby');
                statusIcon = 'fa-pause-circle';
                statusColor = '#6b7280';
            }
            
            // 更新运行状态显示
            safeUpdateElement('operationStatusTop', (el) => {
                el.innerHTML = `<i class="fas ${statusIcon}" style="color: ${statusColor};"></i> ${operationStatus}`;
            });

            // 随机更新设备状态（在线/离线/故障）
            const statusRandom = Math.random();
            const statusDot = document.getElementById('statusDotTop');
            const statusText = document.getElementById('statusTextTop');

            if (statusDot && statusText) {
                if (statusRandom < 0.85) {
                    // 85% 在线
                    statusDot.className = 'status-dot online';
                    statusText.textContent = getTranslation('cabinetStatusOnline');
                } else if (statusRandom < 0.95) {
                    // 10% 离线
                    statusDot.className = 'status-dot offline';
                    statusText.textContent = getTranslation('cabinetStatusOffline');
                } else {
                    // 5% 故障
                    statusDot.className = 'status-dot fault';
                    statusText.textContent = getTranslation('fault');
                }
            }
            

            // SOC缓慢变化
            const socElement = document.getElementById('soc');
            if (socElement) {
                const currentSOC = parseFloat(socElement.textContent);
                const socChange = isCharging ? 0.3 : (isDischarging ? -0.2 : 0);
                const newSOC = Math.max(0, Math.min(100, currentSOC + socChange));
                socElement.textContent = newSOC.toFixed(1);

                // 更新SOC状态文字
                safeUpdateElement('socStatus', (el) => {
                    if (newSOC >= 80) {
                        el.textContent = getTranslation('cabinetStatusBatteryGood');
                        el.className = 'metric-status good';
                    } else if (newSOC >= 50) {
                        el.textContent = getTranslation('cabinetStatusBatteryMedium');
                        el.className = 'metric-status good';
                    } else if (newSOC >= 20) {
                        el.textContent = getTranslation('cabinetStatusBatteryLow');
                        el.className = 'metric-status warning';
                    } else {
                        el.textContent = getTranslation('cabinetStatusBatteryCritical');
                        el.className = 'metric-status critical';
                    }
                });
            }
            
            // 温度更新（核心运行参数中的温度）
            const temperature = 25 + Math.random() * 8;
            safeUpdateElement('temperature', (el) => {
                el.textContent = temperature.toFixed(1);
            });

            // 更新温度状态文字
            safeUpdateElement('tempStatus', (el) => {
                if (temperature <= 35) {
                    el.textContent = getTranslation('cabinetStatusTempNormal');
                    el.className = 'metric-status good';
                } else if (temperature <= 40) {
                    el.textContent = getTranslation('cabinetStatusTempHigh');
                    el.className = 'metric-status warning';
                } else {
                    el.textContent = getTranslation('cabinetStatusTempCritical');
                    el.className = 'metric-status critical';
                }
            });

            // SOH缓慢变化（健康度基本稳定）
            const sohElement = document.getElementById('soh');
            if (sohElement) {
                const currentSOH = parseFloat(sohElement.textContent);
                const sohChange = (Math.random() - 0.5) * 0.01; // 很小的变化
                const newSOH = Math.max(90, Math.min(100, currentSOH + sohChange));
                sohElement.textContent = newSOH.toFixed(1);

                // 更新SOH状态文字
                safeUpdateElement('sohStatus', (el) => {
                    if (newSOH >= 95) {
                        el.textContent = getTranslation('cabinetStatusHealthGood');
                        el.className = 'metric-status good';
                    } else if (newSOH >= 90) {
                        el.textContent = getTranslation('cabinetStatusHealthNormal');
                        el.className = 'metric-status good';
                    } else if (newSOH >= 80) {
                        el.textContent = getTranslation('cabinetStatusHealthAging');
                        el.className = 'metric-status warning';
                    } else {
                        el.textContent = getTranslation('cabinetStatusHealthMaintenance');
                        el.className = 'metric-status critical';
                    }
                });
            }

            // 更新功率状态文字
            safeUpdateElement('powerStatus', (el) => {
                if (isCharging) {
                    el.textContent = getTranslation('cabinetStatusCharging');
                    el.className = 'metric-status good';
                } else if (isDischarging) {
                    el.textContent = getTranslation('cabinetStatusDischarging');
                    el.className = 'metric-status warning';
                } else {
                    el.textContent = getTranslation('cabinetStatusStandby');
                    el.className = 'metric-status';
                }
            });
            
            // 更新充电成本和放电收益（基于今日充放电量）
            const todayChargeEl = document.getElementById('todayCharge');
            const todayDischargeEl = document.getElementById('todayDischarge');

            if (todayChargeEl && todayDischargeEl) {
                const todayCharge = parseFloat(todayChargeEl.textContent);
                const todayDischarge = parseFloat(todayDischargeEl.textContent);

                // 假设低谷电价0.8元/kWh，高峰电价1.5元/kWh
                const chargingCost = todayCharge * 0.8;
                const dischargingRevenue = todayDischarge * 1.5;

                safeUpdateElement('chargingCost', (el) => {
                    el.textContent = '¥' + chargingCost.toFixed(1);
                });

                safeUpdateElement('dischargingRevenue', (el) => {
                    el.textContent = '¥' + dischargingRevenue.toFixed(1);
                });

                // 缓慢更新今日充放电量
                if (isCharging) {
                    todayChargeEl.textContent = (todayCharge + 0.5).toFixed(1);
                } else if (isDischarging) {
                    todayDischargeEl.textContent = (todayDischarge + 0.4).toFixed(1);
                }
            }
            
            // 更新设备状态
            updateDeviceStatuses();
        }
        
        // 更新设备状态显示
        function updateDeviceStatuses() {
            const devices = [
                { id: 'ems', element: 'emsMarkerStatus', labelId: 'emsMarkerLabel' },
                { id: 'pcs', element: 'pcsMarkerStatus', labelId: 'pcsMarkerLabel' },
                { id: 'bms', element: 'bmsMarkerStatus', labelId: 'bmsMarkerLabel' },
                { id: 'meter', element: 'meterMarkerStatus', labelId: 'meterMarkerLabel' },
                { id: 'thermal', element: 'thermalMarkerStatus', labelId: 'thermalMarkerLabel' },
                { id: 'fire', element: 'fireMarkerStatus', labelId: 'fireMarkerLabel' }
            ];
            
            devices.forEach(device => {
                const random = Math.random();
                const dotElement = document.getElementById(device.element + 'Dot');
                const textElement = document.getElementById(device.element + 'Text');
                const labelElement = document.getElementById(device.labelId);
                
                if (!dotElement || !textElement) return;
                
                let borderColor = '';
                
                if (random < 0.7) {
                    // 70% 在线
                    dotElement.className = 'status-dot online';
                    textElement.textContent = '在线';
                    textElement.style.color = '#10b981';
                    borderColor = '#10b981';
                } else if (random < 0.85) {
                    // 15% 离线
                    dotElement.className = 'status-dot offline';
                    textElement.textContent = '离线';
                    textElement.style.color = '#f59e0b';
                    borderColor = '#f59e0b';
                } else {
                    // 15% 异常
                    dotElement.className = 'status-dot fault';
                    textElement.textContent = '异常';
                    textElement.style.color = '#ef4444';
                    borderColor = '#ef4444';
                }
                
                // 更新标签边框颜色
                if (labelElement) {
                    labelElement.style.borderColor = borderColor;
                }
            });
        }
        
        // 启动实时数据更新
        let realtimeInterval;
        function startRealtimeUpdates() {
            updateRealtimeValues();
            realtimeInterval = setInterval(updateRealtimeValues, 2000);
        }
        
        function stopRealtimeUpdates() {
            if (realtimeInterval) {
                clearInterval(realtimeInterval);
            }
        }
        
        // 字段设置相关功能
        const fieldConfigs = {
            overall: {
                realtime: [
                    { 
                        category: '策略调度参数',
                        fields: [
                            { id: 'currentStrategy', name: '当前策略', checked: true },
                            { id: 'dispatchCommand', name: '调度指令', checked: true },
                            { id: 'targetSOC', name: '目标SOC', checked: true },
                            { id: 'maxPower', name: '最大功率', checked: true }
                        ]
                    },
                    {
                        category: '核心运行参数',
                        fields: [
                            { id: 'soc', name: 'SOC', checked: true },
                            { id: 'soh', name: 'SOH', checked: true },
                            { id: 'temperature', name: '温度', checked: true },
                            { id: 'power', name: '充放电功率', checked: true },
                            { id: 'current', name: '电池电流', checked: true },
                            { id: 'voltage', name: '电池电压', checked: true }
                        ]
                    },
                    {
                        category: '运行统计',
                        fields: [
                            { id: 'todayCharge', name: '今日充电量', checked: true },
                            { id: 'todayDischarge', name: '今日放电量', checked: true },
                            { id: 'totalCharge', name: '累计充电量', checked: true },
                            { id: 'totalDischarge', name: '累计放电量', checked: true }
                        ]
                    },
                    {
                        category: '其他参数',
                        fields: [
                            { id: 'cycles', name: '循环次数', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'cabinetFieldCategoryCharts',
                        fields: [
                            { id: 'powerTrend', nameKey: 'cabinetChartPowerSOC', checked: true },
                            { id: 'efficiency', nameKey: 'cabinetChartRevenue', checked: true }
                        ]
                    }
                ]
            },
            ems: {
                realtime: [
                    {
                        categoryKey: 'emsCategoryCpuStatus',
                        fields: [
                            { id: 'cpuUsage', name: '使用率', checked: true },
                            { id: 'cpuTemp', name: '温度', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'emsCategoryMemoryStatus',
                        fields: [
                            { id: 'memoryUsage', name: '占用率', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'emsCategoryDiskStatus',
                        fields: [
                            { id: 'diskUsage', name: '空间使用率', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'emsCategoryBoardTemp',
                        fields: [
                            { id: 'boardTemp', name: '当前温度', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'emsCategory4GNetwork',
                        fields: [
                            { id: 'signal4G', name: '信号强度', checked: true },
                            { id: 'simStatus', name: 'SIM卡状态', checked: true },
                            { id: 'networkInterface', name: '网络接口', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'emsCategoryWifiStatus',
                        fields: [
                            { id: 'wifiSignal', name: '信号强度', checked: true },
                            { id: 'wifiInterface', name: 'WiFi网络接口', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'emsCategorySystemInfo',
                        fields: [
                            { id: 'uptime', name: '系统运行时长', checked: true },
                            { id: 'systemTime', name: '当前系统时间', checked: true },
                            { id: 'hardwareTime', name: '当前硬件时间', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'emsCategoryChart',
                        fields: [
                            { id: 'strategyHistory', nameKey: 'chartEmsStrategyHistory', checked: true },
                            { id: 'responseTime', nameKey: 'chartEmsResponseTime', checked: true }
                        ]
                    }
                ]
            },
            pcs: {
                realtime: [
                    {
                        categoryKey: 'pcsCategoryGridParams',
                        fields: [
                            { id: 'gridVoltage', name: 'PCS电网侧电压', checked: true },
                            { id: 'gridCurrent', name: 'PCS电网侧电流', checked: true },
                            { id: 'gridPower', name: 'PCS电网侧功率', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'pcsCategoryTemp',
                        fields: [
                            { id: 'pcsTemp', name: 'PCS温度', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'pcsCategoryChart',
                        fields: [
                            { id: 'powerConversion', nameKey: 'chartPcsPowerConversion', checked: true },
                            { id: 'voltageCurrent', nameKey: 'chartPcsVoltageCurrent', checked: true },
                            { id: 'efficiency', nameKey: 'chartPcsEfficiency', checked: true }
                        ]
                    }
                ]
            },
            bms: {
                realtime: [
                    {
                        category: '系统状态',
                        fields: [
                            { id: 'communicationStatus', name: '通讯状态', checked: true },
                            { id: 'runningStatus', name: '运行状态', checked: true },
                            { id: 'totalVoltage', name: '总压', checked: true },
                            { id: 'insulationResistancePos', name: '绝缘电阻(正)', checked: true },
                            { id: 'insulationResistanceNeg', name: '绝缘电阻(负)', checked: true },
                            { id: 'availableChargeCapacity', name: '可充电量', checked: true },
                            { id: 'availableDischargeCapacity', name: '可放电量', checked: true },
                            { id: 'maxChargeCurrentAllowed', name: '允许最大充电电流', checked: true },
                            { id: 'maxDischargeCurrentAllowed', name: '允许最大放电电流', checked: true }
                        ]
                    },
                    {
                        category: '核心指标',
                        fields: [
                            { id: 'totalCurrent', name: '总电流', checked: true },
                            { id: 'power', name: '功率', checked: true },
                            { id: 'soc', name: 'SOC', checked: true },
                            { id: 'soh', name: 'SOH', checked: true },
                            { id: 'packCount', name: 'Pack数量', checked: true },
                            { id: 'cycles', name: '循环次数', checked: true }
                        ]
                    },
                    {
                        category: '运行统计',
                        fields: [
                            { id: 'todayCharge', name: '今日充电量', checked: true },
                            { id: 'todayDischarge', name: '今日放电量', checked: true },
                            { id: 'totalCharge', name: '累计充电量', checked: true },
                            { id: 'totalDischarge', name: '累计放电量', checked: true }
                        ]
                    },
                    {
                        category: '电压温度极值',
                        fields: [
                            { id: 'maxCellVoltage', name: '最高单体电压', checked: true },
                            { id: 'minCellVoltage', name: '最低单体电压', checked: true },
                            { id: 'avgCellVoltage', name: '平均单体电压', checked: true },
                            { id: 'maxCellTemp', name: '最高单体温度', checked: true },
                            { id: 'minCellTemp', name: '最低单体温度', checked: true },
                            { id: 'avgCellTemp', name: '平均单体温度', checked: true }
                        ]
                    },
                    {
                        category: 'Pack电池簇信息',
                        fields: [
                            { id: 'packStatus', name: 'Pack状态', checked: true },
                            { id: 'packVoltage', name: 'Pack电压', checked: true },
                            { id: 'packCurrent', name: 'Pack电流', checked: true },
                            { id: 'packSOC', name: 'Pack SOC', checked: true },
                            { id: 'packSOH', name: 'Pack SOH', checked: true },
                            { id: 'packTemp', name: 'Pack温度', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'bmsCategoryChart',
                        fields: [
                            { id: 'voltageHistory', nameKey: 'chartBmsVoltageHistory', checked: true },
                            { id: 'socBalance', nameKey: 'chartBmsSocBalance', checked: true },
                            { id: 'tempDistribution', nameKey: 'chartBmsTempDistribution', checked: true }
                        ]
                    }
                ]
            },
            meter: {
                realtime: [
                    {
                        categoryKey: 'meterCategoryEnergyParams',
                        fields: [
                            { id: 'totalActivePower', name: '总有功功率', checked: true },
                            { id: 'totalReactivePower', name: '总无功功率', checked: true },
                            { id: 'frequency', name: '频率', checked: true },
                            { id: 'powerFactor', name: '功率因数', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'meterCategoryThreePhaseVoltage',
                        fields: [
                            { id: 'phaseAVoltage', name: 'A相电压', checked: true },
                            { id: 'phaseBVoltage', name: 'B相电压', checked: true },
                            { id: 'phaseCVoltage', name: 'C相电压', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'meterCategoryThreePhaseCurrent',
                        fields: [
                            { id: 'phaseACurrent', name: 'A相电流', checked: true },
                            { id: 'phaseBCurrent', name: 'B相电流', checked: true },
                            { id: 'phaseCCurrent', name: 'C相电流', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'meterCategoryEnergyStats',
                        fields: [
                            { id: 'dailyActiveEnergy', name: '日有功电量', checked: true },
                            { id: 'dailyReactiveEnergy', name: '日无功电量', checked: true },
                            { id: 'totalActiveEnergy', name: '累计有功电量', checked: true },
                            { id: 'totalReactiveEnergy', name: '累计无功电量', checked: true },
                            { id: 'totalApparentPower', name: '总视在功率', checked: true },
                            { id: 'meterStatus', name: '电表状态', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'meterCategoryChart',
                        fields: [
                            { id: 'powerTrendAnalysis', nameKey: 'chartMeterPowerTrend', checked: true },
                            { id: 'energyConsumptionStats', nameKey: 'chartMeterEnergyConsumption', checked: true },
                            { id: 'voltageQualityMonitoring', nameKey: 'chartMeterVoltageQuality', checked: true },
                            { id: 'harmonicAnalysis', nameKey: 'chartMeterHarmonics', checked: true }
                        ]
                    }
                ]
            },
            thermal: {
                realtime: [
                    {
                        categoryKey: 'thermalCategoryRunningStatus',
                        fields: [
                            { id: 'cabinetTemp', name: '储能柜温度', checked: true },
                            { id: 'runningMode', name: '运行模式', checked: true },
                            { id: 'humidity', name: '相对湿度', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'thermalCategoryCoreParams',
                        fields: [
                            { id: 'battMaxTemp', name: '电池包最高温度', checked: true },
                            { id: 'battMinTemp', name: '电池包最低温度', checked: true },
                            { id: 'battAvgTemp', name: '电池包平均温度', checked: true },
                            { id: 'battTempDiff', name: '电池包温差', checked: true },
                            { id: 'inletTemp', name: '进风温度', checked: true },
                            { id: 'outletTemp', name: '出风温度', checked: true },
                            { id: 'coolantTemp', name: '冷却液温度', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'thermalCategoryChart',
                        fields: [
                            { id: 'tempDistribution', nameKey: 'chartThermalTempHistory', checked: true },
                            { id: 'coolingSystem', nameKey: 'chartThermalCoolingSystem', checked: true },
                            { id: 'heatMap', nameKey: 'chartThermalFanSpeed', checked: true }
                        ]
                    }
                ]
            },
            cooling: {
                realtime: [
                    {
                        categoryKey: 'coolingCategoryStatus',
                        fields: [
                            { id: 'commStatus', name: '通讯状态', checked: true },
                            { id: 'runningStatus', name: '运行状态', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'coolingCategoryTemp',
                        fields: [
                            { id: 'outletTemp', name: '出水温度', checked: true },
                            { id: 'inletTemp', name: '进水温度', checked: true },
                            { id: 'tempDiff', name: '温差', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'coolingCategoryPressure',
                        fields: [
                            { id: 'outletPressure', name: '出水压力', checked: true },
                            { id: 'inletPressure', name: '进水压力', checked: true },
                            { id: 'pumpSpeed', name: '水泵转速', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'coolingCategoryChart',
                        fields: [
                            { id: 'tempHistory', nameKey: '温度历史', checked: true },
                            { id: 'pressureHistory', nameKey: '压力历史', checked: true },
                            { id: 'pumpSpeedHistory', nameKey: '水泵转速历史', checked: true }
                        ]
                    }
                ]
            },
            fire: {
                realtime: [
                    {
                        categoryKey: 'fireCategoryDetection',
                        fields: [
                            { id: 'smokeDetector', name: '烟感探测器', checked: true },
                            { id: 'fireAlarmStatus', name: '火警状态', checked: true }
                        ]
                    },
                    {
                        categoryKey: 'fireCategoryLinkage',
                        fields: [
                            { id: 'extinguisherStatus', name: '灭火器状态', checked: true },
                            { id: 'emergencyShutdown', name: '紧急停机', checked: true },
                            { id: 'alarmDevice', name: '声光报警器', checked: true }
                        ]
                    }
                ],
                history: [
                    {
                        categoryKey: 'fireCategoryChart',
                        fields: [
                            { id: 'systemStatus', nameKey: 'chartFireSystemStatus', checked: true },
                            { id: 'gasConcentration', nameKey: 'chartFireGasConcentration', checked: true },
                            { id: 'alarmHistory', nameKey: 'chartFireAlarmRecords', checked: true }
                        ]
                    }
                ]
            }
        };
        
        // 保存用户的字段设置
        let userFieldSettings = JSON.parse(localStorage.getItem('fieldSettings') || '{}');
        
        // 生成图表预览
        function getChartPreview(fieldId) {
            // 定义网格样式
            const gridDefs = `
                <defs>
                    <pattern id="grid" width="20" height="16" patternUnits="userSpaceOnUse">
                        <path d="M 20 0 L 0 0 0 16" fill="none" stroke="var(--border-color)" stroke-width="0.5" opacity="0.3"/>
                    </pattern>
                </defs>
            `;
            
            switch(fieldId) {
                // 整机组件图表
                case 'powerTrend':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,50 Q30,30 50,35 T90,40 Q110,25 130,30 T170,35 Q190,45 190,40"
                                  fill="none" stroke="#10b981" stroke-width="2" opacity="0.8"/>
                            <path d="M10,50 Q30,30 50,35 T90,40 Q110,25 130,30 T170,35 Q190,45 190,40 L190,70 L10,70 Z"
                                  fill="#10b981" opacity="0.1"/>
                            <path d="M10,60 Q30,65 50,62 T90,58 Q110,55 130,52 T170,48 Q190,50 190,45"
                                  fill="none" stroke="#f59e0b" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">${getTranslation('cabinetChartPowerSOCShort')}</text>
                        </svg>
                    `;
                case 'efficiency':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="40" width="12" height="25" fill="#10b981" opacity="0.8"/>
                            <rect x="40" y="35" width="12" height="30" fill="#10b981" opacity="0.8"/>
                            <rect x="60" y="45" width="12" height="20" fill="#10b981" opacity="0.8"/>
                            <rect x="32" y="42" width="12" height="23" fill="#3b82f6" opacity="0.8"/>
                            <rect x="52" y="37" width="12" height="28" fill="#3b82f6" opacity="0.8"/>
                            <rect x="72" y="47" width="12" height="18" fill="#3b82f6" opacity="0.8"/>
                            <path d="M25,55 Q45,45 65,40 T105,35 Q125,30 145,25 T185,20"
                                  fill="none" stroke="#f59e0b" stroke-width="2" opacity="0.9"/>
                            <circle cx="25" cy="55" r="2" fill="#f59e0b"/>
                            <circle cx="65" cy="40" r="2" fill="#f59e0b"/>
                            <circle cx="105" cy="35" r="2" fill="#f59e0b"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">${getTranslation('cabinetChartRevenueShort')}</text>
                        </svg>
                    `;
                
                // EMS组件图表
                case 'strategyHistory':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="15" y="45" width="25" height="20" fill="#10b981" opacity="0.7"/>
                            <rect x="50" y="35" width="30" height="30" fill="#3b82f6" opacity="0.7"/>
                            <rect x="90" y="40" width="35" height="25" fill="#f59e0b" opacity="0.7"/>
                            <rect x="135" y="30" width="25" height="35" fill="#8b5cf6" opacity="0.7"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">策略执行</text>
                        </svg>
                    `;
                case 'responseTime':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,60 L30,45 L50,50 L70,35 L90,40 L110,30 L130,45 L150,35 L170,40 L190,30" 
                                  fill="none" stroke="#ef4444" stroke-width="2" opacity="0.8"/>
                            <circle cx="30" cy="45" r="2" fill="#ef4444"/>
                            <circle cx="70" cy="35" r="2" fill="#ef4444"/>
                            <circle cx="110" cy="30" r="2" fill="#ef4444"/>
                            <circle cx="150" cy="35" r="2" fill="#ef4444"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">响应时间</text>
                        </svg>
                    `;
                
                // PCS组件图表
                case 'powerConversion':
                case 'voltageCurrent':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,40 Q30,25 50,30 T90,35 Q110,20 130,25 T170,30 Q190,40 190,35" 
                                  fill="none" stroke="#10b981" stroke-width="2" opacity="0.8"/>
                            <path d="M10,55 Q30,50 50,45 T90,50 Q110,45 130,40 T170,45 Q190,55 190,50" 
                                  fill="none" stroke="#3b82f6" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">功率转换</text>
                        </svg>
                    `;
                
                // BMS组件图表
                case 'voltageHistory':
                case 'socBalance':
                case 'tempDistribution':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="50" width="8" height="15" fill="#10b981" opacity="0.8"/>
                            <rect x="35" y="45" width="8" height="20" fill="#10b981" opacity="0.8"/>
                            <rect x="50" y="55" width="8" height="10" fill="#10b981" opacity="0.8"/>
                            <rect x="65" y="40" width="8" height="25" fill="#10b981" opacity="0.8"/>
                            <rect x="80" y="48" width="8" height="17" fill="#10b981" opacity="0.8"/>
                            <path d="M15,35 Q40,30 65,25 T115,20 Q140,15 165,20 T190,25" 
                                  fill="none" stroke="#f59e0b" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">电池管理</text>
                        </svg>
                    `;
                
                // 电池组件图表
                case 'performance':
                case 'cycles':
                case 'capacity':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,60 Q30,55 50,50 T90,45 Q110,40 130,35 T170,30 Q190,25 190,30" 
                                  fill="none" stroke="#8b5cf6" stroke-width="2" opacity="0.8"/>
                            <path d="M10,60 Q30,55 50,50 T90,45 Q110,40 130,35 T170,30 Q190,25 190,30 L190,70 L10,70 Z" 
                                  fill="#8b5cf6" opacity="0.1"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">电池性能</text>
                        </svg>
                    `;
                
                // 温度组件图表
                case 'tempDistribution':
                case 'coolingSystem':
                case 'heatMap':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="30" width="15" height="15" fill="#ef4444" opacity="0.6"/>
                            <rect x="40" y="35" width="15" height="15" fill="#f59e0b" opacity="0.6"/>
                            <rect x="60" y="40" width="15" height="15" fill="#10b981" opacity="0.6"/>
                            <rect x="80" y="35" width="15" height="15" fill="#3b82f6" opacity="0.6"/>
                            <rect x="100" y="30" width="15" height="15" fill="#8b5cf6" opacity="0.6"/>
                            <path d="M10,60 Q50,55 90,50 T150,45 Q170,40 190,35" 
                                  fill="none" stroke="#ef4444" stroke-width="2" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">温度分析</text>
                        </svg>
                    `;
                
                // 消防组件图表
                case 'systemStatus':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <circle cx="50" cy="40" r="35" fill="none" stroke="#10b981" stroke-width="3" opacity="0.8"/>
                            <circle cx="50" cy="40" r="25" fill="#10b981" opacity="0.6"/>
                            <circle cx="50" cy="40" r="15" fill="#f59e0b" opacity="0.3"/>
                            <circle cx="50" cy="40" r="8" fill="#ef4444" opacity="0.4"/>
                            <text x="110" y="20" font-size="8" fill="#10b981">正常 95%</text>
                            <text x="110" y="35" font-size="8" fill="#f59e0b">预警 4%</text>
                            <text x="110" y="50" font-size="8" fill="#ef4444">告警 1%</text>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">系统状态</text>
                        </svg>
                    `;
                case 'gasConcentration':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <path d="M10,60 Q30,55 50,50 T90,45 Q110,40 130,42 T170,45 Q190,50 190,48" 
                                  fill="none" stroke="#dc2626" stroke-width="2" opacity="0.8"/>
                            <path d="M10,65 Q30,62 50,58 T90,55 Q110,52 130,54 T170,56 Q190,60 190,58" 
                                  fill="none" stroke="#6b7280" stroke-width="2" opacity="0.6"/>
                            <circle cx="50" cy="50" r="2" fill="#dc2626"/>
                            <circle cx="90" cy="45" r="2" fill="#dc2626"/>
                            <circle cx="130" cy="42" r="2" fill="#dc2626"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">气体浓度</text>
                        </svg>
                    `;
                case 'alarmHistory':
                    return `
                        <svg width="100%" height="100%" viewBox="0 0 200 80" style="position: absolute; top: 0; left: 0;">
                            ${gridDefs}
                            <rect width="200" height="80" fill="url(#grid)"/>
                            <rect x="20" y="45" width="15" height="20" fill="#6b7280" opacity="0.8"/>
                            <rect x="40" y="50" width="15" height="15" fill="#f59e0b" opacity="0.8"/>
                            <rect x="60" y="40" width="15" height="25" fill="#dc2626" opacity="0.8"/>
                            <rect x="80" y="55" width="15" height="10" fill="#6b7280" opacity="0.8"/>
                            <rect x="100" y="48" width="15" height="17" fill="#f59e0b" opacity="0.8"/>
                            <rect x="120" y="52" width="15" height="13" fill="#dc2626" opacity="0.8"/>
                            <rect x="140" y="58" width="15" height="7" fill="#6b7280" opacity="0.8"/>
                            <rect x="160" y="46" width="15" height="19" fill="#f59e0b" opacity="0.8"/>
                            <text x="10" y="12" font-size="8" fill="var(--text-secondary)">告警记录</text>
                        </svg>
                    `;
                
                default:
                    return `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); font-size: 12px;">
                            图表预览
                        </div>
                    `;
            }
        }
        
        // 跳转到导出数据页面
        function navigateToExportPage() {
            // 获取当前组件
            const component = currentComponent || 'overall';

            // 组件名称到export-data.html的component参数映射
            const componentParamMap = {
                'overall': 'overall',
                'ems': 'ems',
                'pcs': 'inverter',
                'bms': 'bms',
                'battery': 'battery',
                'meter': 'meter',
                'thermal': 'thermal',
                'fire': 'fire'
            };

            const componentParam = componentParamMap[component] || 'overall';

            // 跳转到导出数据页面
            window.location.href = `export-data.html?component=${componentParam}`;
        }

        // 导出储能柜数据
        function handleExportCabinetData() {
            try {
                // 获取当前组件和时间范围
                const component = currentComponent || 'overall';
                const componentNames = {
                    'overall': '整机',
                    'ems': 'EMS',
                    'pcs': 'PCS',
                    'bms': 'BMS',
                    'battery': '电池',
                    'meter': '电表',
                    'thermal': '温控',
                    'fire': '消防'
                };
                const componentName = componentNames[component] || component;

                // 获取当前选中的时间范围
                const activeTimeBtn = document.querySelector('.time-range-btn.active');
                const timeRange = activeTimeBtn ? activeTimeBtn.textContent : '24小时';

                // 获取储能柜ID和名称
                const urlParams = new URLSearchParams(window.location.search);
                const cabinetId = urlParams.get('cabinetId') || '1';
                const cabinetName = `储能柜${cabinetId}`;

                // 生成模拟数据
                const now = new Date();
                const data = [];
                const dataPoints = 100; // 生成100条数据

                for (let i = 0; i < dataPoints; i++) {
                    const timestamp = new Date(now.getTime() - (dataPoints - i) * 60000); // 每分钟一条数据
                    data.push({
                        '时间': formatDateTime(timestamp),
                        'SOC (%)': (Math.random() * 20 + 75).toFixed(1),
                        '电压 (V)': (Math.random() * 10 + 385).toFixed(1),
                        '电流 (A)': (Math.random() * 50 - 25).toFixed(1),
                        '功率 (kW)': (Math.random() * 100 - 50).toFixed(1),
                        '温度 (℃)': (Math.random() * 5 + 25).toFixed(1),
                        '状态': Math.random() > 0.5 ? '充电' : '放电'
                    });
                }

                // 生成CSV内容
                const headers = Object.keys(data[0]);
                let csvContent = '\ufeff' + headers.join(',') + '\n'; // 添加BOM以支持中文

                data.forEach(row => {
                    const values = headers.map(header => {
                        const value = row[header];
                        // 如果包含逗号或引号，需要用引号包裹
                        if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                            return '"' + value.replace(/"/g, '""') + '"';
                        }
                        return value;
                    });
                    csvContent += values.join(',') + '\n';
                });

                // 创建下载链接
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const filename = `${cabinetName}_${componentName}_${timeRange}_${formatDateForFilename(now)}.csv`;

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // 显示成功提示
                showToast('数据导出成功！', 'success');

            } catch (error) {
                console.error('导出数据失败:', error);
                showToast('数据导出失败，请重试', 'error');
            }
        }

        // 格式化日期时间用于显示
        function formatDateTime(date) {
            return date.getFullYear() + '-' +
                   String(date.getMonth() + 1).padStart(2, '0') + '-' +
                   String(date.getDate()).padStart(2, '0') + ' ' +
                   String(date.getHours()).padStart(2, '0') + ':' +
                   String(date.getMinutes()).padStart(2, '0') + ':' +
                   String(date.getSeconds()).padStart(2, '0');
        }

        // 格式化日期用于文件名
        function formatDateForFilename(date) {
            return date.getFullYear() +
                   String(date.getMonth() + 1).padStart(2, '0') +
                   String(date.getDate()).padStart(2, '0') + '_' +
                   String(date.getHours()).padStart(2, '0') +
                   String(date.getMinutes()).padStart(2, '0') +
                   String(date.getSeconds()).padStart(2, '0');
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            // 检查是否已有toast容器
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
                document.body.appendChild(toastContainer);
            }

            const toast = document.createElement('div');
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            toast.style.cssText = `
                background: var(--bg-secondary);
                color: var(--text-primary);
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
                margin-bottom: 10px;
                display: flex;
                align-items: center;
                gap: 10px;
                border-left: 4px solid ${colors[type]};
                animation: slideIn 0.3s ease;
            `;

            toast.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]}; font-size: 18px;"></i>
                <span>${message}</span>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 打开字段设置
        function openFieldSettings() {
            try {
                console.log('开始打开字段设置, 当前组件:', currentComponent);
                
                const modal = document.getElementById('fieldSettingsModal');
                const content = document.getElementById('fieldSettingsContent');
                const modalTitle = document.getElementById('modalTitle');
                
                if (!modal || !content || !modalTitle) {
                    console.error('字段设置模态框元素未找到');
                    return;
                }
                
                const currentTabElement = document.querySelector('.data-tab.active');
                const currentTabKey = currentTabElement.getAttribute('data-translate');
                const dataType = currentTabKey === 'cabinetDataTabRealtime' ? 'realtime' : 'history';

                console.log('当前标签页键:', currentTabKey, '数据类型:', dataType);

                // 设置模态框标题
                const currentTabText = getTranslation(currentTabKey);
                const titleText = `${currentTabText} - ${getComponentName(currentComponent)}`;
                modalTitle.textContent = titleText;
            
                // 获取当前组件的字段配置
                const categories = fieldConfigs[currentComponent]?.[dataType];
                if (!categories) {
                    console.error('未找到字段配置:', currentComponent, dataType);
                    alert(`未找到${getComponentName(currentComponent)}的字段配置`);
                    return;
                }
                
                const savedSettings = userFieldSettings[currentComponent]?.[dataType] || {};
                
                // 生成字段列表HTML
                let html = `
                    <div style="margin-bottom: 16px;">
                        <p style="font-size: 14px; color: var(--text-secondary);">${getTranslation('cabinetFieldSettingsDesc')}</p>
                    </div>
                `;
                
                // 按分类显示字段
                categories.forEach((category, index) => {
                    // 使用categoryKey获取翻译
                    const categoryText = category.categoryKey ? getTranslation(category.categoryKey) : '';
                    const isChartCategory = category.categoryKey && category.categoryKey.includes('CategoryChart');

                    html += `
                    <div style="margin-bottom: 20px; ${index > 0 ? 'margin-top: 24px;' : ''}">
                        <h5 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color);">
                            ${categoryText}
                        </h5>
                        <div style="display: grid; gap: 10px;">
                `;

                category.fields.forEach(field => {
                    const checked = savedSettings[field.id] !== undefined ? savedSettings[field.id] : field.checked;
                    // 支持新旧两种方式：nameKey（新）或 name（旧）
                    const fieldName = field.nameKey ? getTranslation(field.nameKey) : field.name;

                    // 如果是图表分类，显示为图表预览
                    if (isChartCategory) {
                        html += `
                            <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer; padding: 8px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; background: var(--bg-secondary);">
                                <input type="checkbox" id="field_${field.id}" value="${field.id}" ${checked ? 'checked' : ''}
                                       style="width: 16px; height: 16px; cursor: pointer; margin-top: 4px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 500; margin-bottom: 8px;">${fieldName}</div>
                                    <div style="width: 100%; height: 80px; background: var(--bg-primary); border-radius: 4px; position: relative; overflow: hidden;">
                                        ${getChartPreview(field.id)}
                                    </div>
                                </div>
                            </label>
                        `;
                    } else {
                        // 其他分类保持原有样式
                        html += `
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 0;">
                                <input type="checkbox" id="field_${field.id}" value="${field.id}" ${checked ? 'checked' : ''}
                                       style="width: 16px; height: 16px; cursor: pointer;">
                                <span style="font-size: 14px;">${fieldName}</span>
                            </label>
                        `;
                    }
                    });

                    html += `
                            </div>
                        </div>
                    `;
                });
                content.innerHTML = html;
                
                // 显示模态框
                modal.style.display = 'flex';
                
                console.log('字段设置模态框已显示');
            } catch (error) {
                console.error('打开字段设置时出错:', error);
                alert('打开设置时出错: ' + error.message);
            }
        }
        
        // 关闭字段设置
        function closeFieldSettings() {
            document.getElementById('fieldSettingsModal').style.display = 'none';
        }

        // 打开升级模态框
        function openUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        // 关闭升级模态框
        function closeUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // 拨打电话
        function callSupport() {
            // 尝试拨打电话（移动端有效）
            window.location.href = 'tel:18576677649';
        }

        // 保存字段设置
        function saveFieldSettings() {
            const currentTabElement = document.querySelector('.data-tab.active');
            const currentTabKey = currentTabElement.getAttribute('data-translate');
            const dataType = currentTabKey === 'cabinetDataTabRealtime' ? 'realtime' : 'history';
            const categories = fieldConfigs[currentComponent][dataType];
            
            // 初始化设置对象
            if (!userFieldSettings[currentComponent]) {
                userFieldSettings[currentComponent] = {};
            }
            if (!userFieldSettings[currentComponent][dataType]) {
                userFieldSettings[currentComponent][dataType] = {};
            }
            
            // 保存每个字段的状态
            categories.forEach(category => {
                category.fields.forEach(field => {
                    const checkbox = document.getElementById(`field_${field.id}`);
                    if (checkbox) {
                        userFieldSettings[currentComponent][dataType][field.id] = checkbox.checked;
                    }
                });
            });
            
            // 保存到localStorage
            localStorage.setItem('fieldSettings', JSON.stringify(userFieldSettings));
            
            // 关闭模态框
            closeFieldSettings();
            
            // 刷新当前视图
            if (dataType === 'realtime') {
                updateComponentData(currentComponent);
            } else {
                initHistoryCharts();
            }
        }
        
        // 重置为默认设置
        function resetFieldSettings() {
            const currentTabElement = document.querySelector('.data-tab.active');
            const currentTabKey = currentTabElement.getAttribute('data-translate');
            const dataType = currentTabKey === 'cabinetDataTabRealtime' ? 'realtime' : 'history';
            const categories = fieldConfigs[currentComponent][dataType];

            // 恢复默认选中状态
            categories.forEach(category => {
                category.fields.forEach(field => {
                    const checkbox = document.getElementById(`field_${field.id}`);
                    if (checkbox) {
                        checkbox.checked = field.checked;
                    }
                });
            });

            // 清除localStorage中的用户设置
            if (userFieldSettings[currentComponent] && userFieldSettings[currentComponent][dataType]) {
                delete userFieldSettings[currentComponent][dataType];
                localStorage.setItem('fieldSettings', JSON.stringify(userFieldSettings));
            }

            // 关闭模态框
            closeFieldSettings();

            // 刷新当前视图
            if (dataType === 'realtime') {
                updateComponentData(currentComponent);
            } else {
                initHistoryCharts();
            }
        }
        
        // 获取组件名称
        function getComponentName(component) {
            const keyMap = {
                overall: 'cabinetTabOverall',
                ems: 'cabinetTabEMS',
                pcs: 'cabinetTabPCS',
                bms: 'cabinetTabBMS',
                meter: 'cabinetTabMeter',
                thermal: 'cabinetTabThermal',
                fire: 'cabinetTabFire'
            };
            const key = keyMap[component];
            return key ? getTranslation(key) : component;
        }
        
        // 检查字段是否应该显示
        function shouldShowField(component, dataType, fieldId) {
            const settings = userFieldSettings[component]?.[dataType];
            if (settings && settings[fieldId] !== undefined) {
                return settings[fieldId];
            }
            // 如果没有自定义设置，使用默认值
            const categories = fieldConfigs[component][dataType];
            for (let category of categories) {
                const field = category.fields.find(f => f.id === fieldId);
                if (field) {
                    return field.checked;
                }
            }
            return true;
        }

        // 生成PCS专用HTML - 三相数据合并显示
        function generatePCSHTML() {
            // 生成单个PCS的HTML
            function generateSinglePCSHTML(pcsId) {
                // 模拟数据生成
                const baseVoltage = 385 + Math.random() * 5;
                const baseCurrent = 90 + Math.random() * 20;
                const basePower = 55 + Math.random() * 10;
                const dcVoltage = 750 + Math.random() * 30;
                const dcCurrent = 180 + Math.random() * 40;

                return `
                    <!-- PCS 系统状态 -->
                    <div class="metrics-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">PCS 系统状态</h3>
                            ${pcsId === 1 ? `
                                <div style="display: flex; gap: 8px;">
                                    <button class="upgrade-btn" onclick="openUpgradeModal()" title="升级设备" style="padding: 4px 12px; font-size: 12px;">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>升级</span>
                                        <span class="upgrade-badge">定制</span>
                                    </button>
                                    <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                        <i class="fas fa-cog"></i>
                                        <span>字段设置</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">通讯状态</div>
                                <div class="metric-value">
                                    <span style="display: inline-flex; align-items: center; padding: 4px 12px; background: #10b98120; color: #10b981; border-radius: 6px; font-size: 14px; font-weight: 500;">
                                        <i class="fas fa-check-circle" style="margin-right: 6px;"></i>在线
                                    </span>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">运行状态</div>
                                <div class="metric-value">
                                    <span style="display: inline-flex; align-items: center; padding: 4px 12px; background: #3b82f620; color: #3b82f6; border-radius: 6px; font-size: 14px; font-weight: 500;">
                                        <i class="fas fa-bolt" style="margin-right: 6px;"></i>运行中
                                    </span>
                                </div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">内部温度</div>
                                <div class="metric-value">${(45 + Math.random() * 20).toFixed(1)} <span class="metric-unit">°C</span></div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">温度正常</div>
                            </div>
                        </div>
                    </div>

                    <!-- PCS 直流侧参数 -->
                    <div class="metrics-section">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">PCS 直流侧参数</h3>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">直流电压</div>
                                <div class="metric-value">${dcVoltage.toFixed(1)} <span class="metric-unit">V</span></div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">电压稳定</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">直流电流</div>
                                <div class="metric-value">${dcCurrent.toFixed(1)} <span class="metric-unit">A</span></div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">电流正常</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">直流功率</div>
                                <div class="metric-value">${(dcVoltage * dcCurrent / 1000).toFixed(1)} <span class="metric-unit">kW</span></div>
                                <div style="font-size: 12px; color: #10b981; margin-top: 4px;">功率稳定</div>
                            </div>
                        </div>
                    </div>

                    <!-- PCS交流侧参数 -->
                    <div class="metrics-section">
                        <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">PCS交流侧参数</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <!-- 总功率卡片 -->
                            <div class="metric-card" style="padding: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; font-weight: 500;">总功率</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">总有功功率</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(basePower * 3).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kW</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">总无功功率</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(Math.random() * 20 - 10).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVar</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 14px; color: var(--text-secondary);">总视在功率</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(basePower * 3 * 1.02).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVA</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 线电压卡片 -->
                            <div class="metric-card" style="padding: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; font-weight: 500;">线电压</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">AB线电压</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(baseVoltage * 1.732).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">V</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">BC线电压</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(baseVoltage * 1.732 + Math.random() * 5 - 2.5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">V</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 14px; color: var(--text-secondary);">CA线电压</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(baseVoltage * 1.732 + Math.random() * 5 - 2.5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">V</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PCS 电网侧参数 -->
                    <div class="metrics-section">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <!-- 电压卡片 -->
                            <div class="metric-card" style="padding: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; font-weight: 500;">三相电压</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">A相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${baseVoltage.toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">V</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">B相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(baseVoltage + Math.random() * 3 - 1.5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">V</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 14px; color: var(--text-secondary);">C相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(baseVoltage + Math.random() * 3 - 1.5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">V</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 电流卡片 -->
                            <div class="metric-card" style="padding: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; font-weight: 500;">三相电流</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">A相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${baseCurrent.toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">A</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">B相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(baseCurrent + Math.random() * 10 - 5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">A</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 14px; color: var(--text-secondary);">C相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(baseCurrent + Math.random() * 10 - 5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">A</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 功率卡片 -->
                            <div class="metric-card" style="padding: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; font-weight: 500;">三相有功功率</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">A相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${basePower.toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kW</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">B相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(basePower + Math.random() * 5 - 2.5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kW</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 14px; color: var(--text-secondary);">C相</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(basePower + Math.random() * 5 - 2.5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kW</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PCS 电网侧扩展参数 -->
                    <div class="metrics-section" style="margin-top: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                            <!-- 三相无功功率卡片 -->
                            <div class="metric-card" style="padding: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; font-weight: 500;">三相无功功率</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">A相无功</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(Math.random() * 10 - 5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVar</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">B相无功</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(Math.random() * 10 - 5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVar</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 14px; color: var(--text-secondary);">C相无功</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(Math.random() * 10 - 5).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVar</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 三相视在功率卡片 -->
                            <div class="metric-card" style="padding: 20px;">
                                <div style="text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; font-weight: 500;">三相视在功率</div>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">A相视在功率</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(basePower * 1.02).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVA</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                        <span style="font-size: 14px; color: var(--text-secondary);">B相视在功率</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(basePower * 1.02 + Math.random() * 2 - 1).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVA</span></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                        <span style="font-size: 14px; color: var(--text-secondary);">C相视在功率</span>
                                        <span style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${(basePower * 1.02 + Math.random() * 2 - 1).toFixed(1)} <span style="font-size: 14px; font-weight: 400; color: var(--text-secondary);">kVA</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            let html = '';

            // 只生成PCS的数据
            html += generateSinglePCSHTML(1);

            return html;
        }
        
        // 生成BMS专用HTML
        function generateBMSHTML() {
            let html = '';

            // 系统状态 section
            let systemStatusFields = '';
            if (shouldShowField('bms', 'realtime', 'communicationStatus')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">通讯状态</div>' +
                    '<div class="metric-value">' +
                        '<span style="display: inline-flex; align-items: center; padding: 4px 12px; background: #10b98120; color: #10b981; border-radius: 6px; font-size: 14px; font-weight: 500;">' +
                            '<i class="fas fa-check-circle" style="margin-right: 6px;"></i>在线' +
                        '</span>' +
                    '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'runningStatus')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">运行状态</div>' +
                    '<div class="metric-value">' +
                        '<span style="display: inline-flex; align-items: center; padding: 4px 12px; background: #3b82f620; color: #3b82f6; border-radius: 6px; font-size: 14px; font-weight: 500;">' +
                            '<i class="fas fa-bolt" style="margin-right: 6px;"></i>放电中' +
                        '</span>' +
                    '</div>' +
                    '<div style="font-size: 12px; color: #3b82f6; margin-top: 4px;">功率 141.6kW</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'totalVoltage')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">总压</div>' +
                    '<div class="metric-value">766.0 <span class="metric-unit">V</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;">电压正常</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'insulationResistancePos')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">绝缘电阻(正)</div>' +
                    '<div class="metric-value">852 <span class="metric-unit">kΩ</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;">绝缘良好</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'insulationResistanceNeg')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">绝缘电阻(负)</div>' +
                    '<div class="metric-value">847 <span class="metric-unit">kΩ</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;">绝缘良好</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'availableChargeCapacity')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">可充电量</div>' +
                    '<div class="metric-value">12.5 <span class="metric-unit">kWh</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'availableDischargeCapacity')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">可放电量</div>' +
                    '<div class="metric-value">487.5 <span class="metric-unit">kWh</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'maxChargeCurrentAllowed')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">允许最大充电电流</div>' +
                    '<div class="metric-value">200 <span class="metric-unit">A</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'maxDischargeCurrentAllowed')) {
                systemStatusFields += '<div class="metric-card">' +
                    '<div class="metric-label">允许最大放电电流</div>' +
                    '<div class="metric-value">200 <span class="metric-unit">A</span></div>' +
                '</div>';
            }

            if (systemStatusFields) {
                html += '<div class="metrics-section">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
                        '<h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">系统状态</h3>' +
                        '<div style="display: flex; gap: 8px;">' +
                            '<button class="upgrade-btn" onclick="openUpgradeModal()" title="升级设备" style="padding: 4px 12px; font-size: 12px;">' +
                                '<i class="fas fa-arrow-up"></i>' +
                                '<span>升级</span>' +
                                '<span class="upgrade-badge">定制</span>' +
                            '</button>' +
                            '<button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">' +
                                '<i class="fas fa-cog"></i>' +
                                '<span data-translate="cabinetBtnSettings">' + getTranslation('cabinetBtnSettings') + '</span>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="metrics-grid">' + systemStatusFields + '</div>' +
                '</div>';
            }

            // 核心指标 section
            let coreMetricsFields = '';
            if (shouldShowField('bms', 'realtime', 'totalCurrent')) {
                coreMetricsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="coreMetricsTotalCurrent">' + getTranslation('coreMetricsTotalCurrent') + '</div>' +
                    '<div class="metric-value">173.0 <span class="metric-unit">A</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;" data-translate="coreMetricsCurrentStable">' + getTranslation('coreMetricsCurrentStable') + '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'power')) {
                coreMetricsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="coreMetricsPower">' + getTranslation('coreMetricsPower') + '</div>' +
                    '<div class="metric-value">141.6 <span class="metric-unit">kW</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;" data-translate="coreMetricsPowerStable">' + getTranslation('coreMetricsPowerStable') + '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'soc')) {
                coreMetricsFields += '<div class="metric-card">' +
                    '<div class="metric-label">SOC</div>' +
                    '<div class="metric-value">100.0 <span class="metric-unit">%</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'soh')) {
                coreMetricsFields += '<div class="metric-card">' +
                    '<div class="metric-label">SOH</div>' +
                    '<div class="metric-value">98.1 <span class="metric-unit">%</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;" data-translate="cabinetSOHGood">' + getTranslation('cabinetSOHGood') + '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'packCount')) {
                coreMetricsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="coreMetricsPackCount">' + getTranslation('coreMetricsPackCount') + '</div>' +
                    '<div class="metric-value">4 <span class="metric-unit" data-translate="unitPiece">' + getTranslation('unitPiece') + '</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'cycles')) {
                coreMetricsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="coreMetricsCycleCount">' + getTranslation('coreMetricsCycleCount') + '</div>' +
                    '<div class="metric-value">2786 <span class="metric-unit" data-translate="unitTimes">' + getTranslation('unitTimes') + '</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;" data-translate="coreMetricsLifeNormal">' + getTranslation('coreMetricsLifeNormal') + '</div>' +
                '</div>';
            }

            if (coreMetricsFields) {
                html += '<div class="metrics-section">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
                        '<h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);" data-translate="coreMetricsTitle">' + getTranslation('coreMetricsTitle') + '</h3>' +
                    '</div>' +
                    '<div class="metrics-grid">' + coreMetricsFields + '</div>' +
                '</div>';
            }

            // 运行统计 section
            let runStatsFields = '';
            if (shouldShowField('bms', 'realtime', 'todayCharge')) {
                runStatsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="runStatsDailyCharge">' + getTranslation('runStatsDailyCharge') + '</div>' +
                    '<div class="metric-value">335.9 <span class="metric-unit">kWh</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'todayDischarge')) {
                runStatsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="runStatsDailyDischarge">' + getTranslation('runStatsDailyDischarge') + '</div>' +
                    '<div class="metric-value">261.9 <span class="metric-unit">kWh</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'totalCharge')) {
                runStatsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="runStatsTotalCharge">' + getTranslation('runStatsTotalCharge') + '</div>' +
                    '<div class="metric-value">1262 <span class="metric-unit">MWh</span></div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'totalDischarge')) {
                runStatsFields += '<div class="metric-card">' +
                    '<div class="metric-label" data-translate="runStatsTotalDischarge">' + getTranslation('runStatsTotalDischarge') + '</div>' +
                    '<div class="metric-value">1197 <span class="metric-unit">MWh</span></div>' +
                '</div>';
            }

            if (runStatsFields) {
                html += '<div class="metrics-section">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
                        '<h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);" data-translate="runStatsTitle">' + getTranslation('runStatsTitle') + '</h3>' +
                    '</div>' +
                    '<div class="metrics-grid">' + runStatsFields + '</div>' +
                '</div>';
            }

            // 电压温度极值 section
            let extremeFields = '';
            if (shouldShowField('bms', 'realtime', 'maxCellVoltage')) {
                extremeFields += '<div class="metric-card" onclick="openPackDetailsModal(2, 87)" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\'">' +
                    '<div class="metric-label">最高单体电压</div>' +
                    '<div class="metric-value">3.652 <span class="metric-unit">V</span></div>' +
                    '<div style="font-size: 12px; color: #3b82f6; margin-top: 4px; display: flex; align-items: center; gap: 4px;">' +
                        '<i class="fas fa-mouse-pointer" style="font-size: 10px;"></i>' +
                        '<span>位置: Pack2-Cell087</span>' +
                    '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'minCellVoltage')) {
                extremeFields += '<div class="metric-card" onclick="openPackDetailsModal(3, 42)" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\'">' +
                    '<div class="metric-label">最低单体电压</div>' +
                    '<div class="metric-value">3.601 <span class="metric-unit">V</span></div>' +
                    '<div style="font-size: 12px; color: #3b82f6; margin-top: 4px; display: flex; align-items: center; gap: 4px;">' +
                        '<i class="fas fa-mouse-pointer" style="font-size: 10px;"></i>' +
                        '<span>位置: Pack3-Cell042</span>' +
                    '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'avgCellVoltage')) {
                extremeFields += '<div class="metric-card">' +
                    '<div class="metric-label">平均单体电压</div>' +
                    '<div class="metric-value">3.628 <span class="metric-unit">V</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;">压差: 51mV</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'maxCellTemp')) {
                extremeFields += '<div class="metric-card" onclick="openPackDetailsModal(1, 156, \'temp\')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\'">' +
                    '<div class="metric-label">最高单体温度</div>' +
                    '<div class="metric-value">32.8 <span class="metric-unit">°C</span></div>' +
                    '<div style="font-size: 12px; color: #3b82f6; margin-top: 4px; display: flex; align-items: center; gap: 4px;">' +
                        '<i class="fas fa-mouse-pointer" style="font-size: 10px;"></i>' +
                        '<span>位置: Pack1-Cell156</span>' +
                    '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'minCellTemp')) {
                extremeFields += '<div class="metric-card" onclick="openPackDetailsModal(4, 28, \'temp\')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\'">' +
                    '<div class="metric-label">最低单体温度</div>' +
                    '<div class="metric-value">28.5 <span class="metric-unit">°C</span></div>' +
                    '<div style="font-size: 12px; color: #3b82f6; margin-top: 4px; display: flex; align-items: center; gap: 4px;">' +
                        '<i class="fas fa-mouse-pointer" style="font-size: 10px;"></i>' +
                        '<span>位置: Pack4-Cell028</span>' +
                    '</div>' +
                '</div>';
            }
            if (shouldShowField('bms', 'realtime', 'avgCellTemp')) {
                extremeFields += '<div class="metric-card">' +
                    '<div class="metric-label">平均单体温度</div>' +
                    '<div class="metric-value">30.7 <span class="metric-unit">°C</span></div>' +
                    '<div style="font-size: 12px; color: #10b981; margin-top: 4px;">温差: 4.3°C</div>' +
                '</div>';
            }

            if (extremeFields) {
                html += '<div class="metrics-section">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
                        '<h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">电压温度极值</h3>' +
                    '</div>' +
                    '<div class="metrics-grid">' + extremeFields + '</div>' +
                '</div>';
            }

            // Pack电池簇信息 section (使用独立的生成函数，但检查是否应该显示任何Pack字段)
            let shouldShowPack = shouldShowField('bms', 'realtime', 'packStatus') ||
                                shouldShowField('bms', 'realtime', 'packVoltage') ||
                                shouldShowField('bms', 'realtime', 'packCurrent') ||
                                shouldShowField('bms', 'realtime', 'packSOC') ||
                                shouldShowField('bms', 'realtime', 'packSOH') ||
                                shouldShowField('bms', 'realtime', 'packTemp');

            if (shouldShowPack) {
                html += '<div class="metrics-section">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
                        '<h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);" data-translate="packBatteryTitle">' + getTranslation('packBatteryTitle') + '</h3>' +
                        '<span style="font-size: 13px; color: #666;">点击Pack查看单体详情</span>' +
                    '</div>' +
                    '<div class="metrics-grid">' + generatePackCardsHTML() + '</div>' +
                '</div>';
            }

            return html;
        }

        // 生成Pack卡片HTML（保持原样式，添加点击事件，支持字段可见性控制）
        function generatePackCardsHTML() {
            const packsData = [
                { id: 1, status: '正常', voltage: 192.1, current: 43.1, soc: 88.1, soh: 97.2, temp: 32.0 },
                { id: 2, status: '正常', voltage: 190.6, current: 44.5, soc: 87.0, soh: 97.9, temp: 31.3 },
                { id: 3, status: '正常', voltage: 190.1, current: 46.0, soc: 91.5, soh: 98.3, temp: 30.5 },
                { id: 4, status: '正常', voltage: 193.2, current: 39.9, soc: 92.6, soh: 96.7, temp: 29.0 }
            ];

            let html = '';

            packsData.forEach(pack => {
                // 为每个Pack构建字段HTML
                let packFieldsHtml = '';

                if (shouldShowField('bms', 'realtime', 'packVoltage')) {
                    packFieldsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">' +
                        '<span style="font-size: 14px; color: var(--text-secondary);">电压</span>' +
                        '<span class="metric-value">' + pack.voltage + ' <span class="metric-unit">V</span></span>' +
                    '</div>';
                }

                if (shouldShowField('bms', 'realtime', 'packCurrent')) {
                    packFieldsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">' +
                        '<span style="font-size: 14px; color: var(--text-secondary);">电流</span>' +
                        '<span class="metric-value">' + pack.current + ' <span class="metric-unit">A</span></span>' +
                    '</div>';
                }

                if (shouldShowField('bms', 'realtime', 'packSOC')) {
                    packFieldsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">' +
                        '<span style="font-size: 14px; color: var(--text-secondary);">SOC</span>' +
                        '<span class="metric-value">' + pack.soc + ' <span class="metric-unit">%</span></span>' +
                    '</div>';
                }

                if (shouldShowField('bms', 'realtime', 'packSOH')) {
                    packFieldsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">' +
                        '<span style="font-size: 14px; color: var(--text-secondary);">SOH</span>' +
                        '<span class="metric-value">' + pack.soh + ' <span class="metric-unit">%</span></span>' +
                    '</div>';
                }

                if (shouldShowField('bms', 'realtime', 'packTemp')) {
                    packFieldsHtml += '<div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">' +
                        '<span style="font-size: 14px; color: var(--text-secondary);">温度</span>' +
                        '<span class="metric-value">' + pack.temp + ' <span class="metric-unit">°C</span></span>' +
                    '</div>';
                }

                // 只有当Pack状态字段可见，或者有其他字段可见时，才显示整个Pack卡片
                let showPackStatus = shouldShowField('bms', 'realtime', 'packStatus');

                if (showPackStatus || packFieldsHtml) {
                    html += '<div class="metric-card" onclick="openPackDetailsModal(' + pack.id + ')" style="cursor: pointer; transition: all 0.2s;" onmouseover="this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" onmouseout="this.style.transform=\'translateY(0)\'; this.style.boxShadow=\'none\'">' +
                        '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid var(--border-color);">' +
                            '<div style="display: flex; align-items: center; gap: 8px;">' +
                                '<span style="font-size: 18px; font-weight: 700; color: var(--text-primary); margin: 0;">Pack' + pack.id + '</span>' +
                                '<i class="fas fa-chevron-right" style="font-size: 12px; color: #3b82f6; opacity: 0.6;"></i>' +
                            '</div>';

                    // Pack状态字段可见时才显示
                    if (showPackStatus) {
                        html += '<span style="padding: 3px 10px; background: #10b98120; color: #10b981; border-radius: 4px; font-size: 13px; font-weight: 500;">' + pack.status + '</span>';
                    }

                    html += '</div>' +
                        '<div>' + packFieldsHtml + '</div>' +
                    '</div>';
                }
            });

            return html;
        }

        // 为特定Pack生成单体电压
        function generatePackCellVoltages(packId, highlightCell) {
            const cellsPerPack = 60;
            const baseVoltage = 3.628;
            let html = '';

            for (let cell = 1; cell <= cellsPerPack; cell++) {
                const voltage = (baseVoltage + (Math.random() - 0.5) * 0.05).toFixed(3);
                const cellNum = String(cell).padStart(3, '0');

                let statusColor = '#10b981';
                let statusBg = '#10b98110';
                if (voltage < 3.610) {
                    statusColor = '#f59e0b';
                    statusBg = '#f59e0b10';
                } else if (voltage > 3.645) {
                    statusColor = '#ef4444';
                    statusBg = '#ef444410';
                }

                // 如果是高亮单体，使用特殊样式
                let isHighlight = highlightCell && cell === highlightCell;
                let highlightStyle = '';
                if (isHighlight) {
                    highlightStyle = 'box-shadow: 0 0 0 3px #3b82f6; transform: scale(1.05); border: 2px solid #3b82f6 !important; background: #dbeafe !important;';
                }

                html += '<div id="cell-' + cell + '" style="padding: 8px; background: ' + statusBg + '; border: 1px solid ' + statusColor + '20; border-radius: 6px; text-align: center; transition: all 0.3s; ' + highlightStyle + '">' +
                            '<div style="font-size: 10px; color: #64748b; margin-bottom: 2px;">' + cellNum + '</div>' +
                            '<div style="font-size: 13px; font-weight: 600; color: ' + statusColor + ';">' + voltage + 'V</div>' +
                        '</div>';
            }

            return html;
        }

        // 为特定Pack生成单体温度
        function generatePackCellTemperatures(packId, highlightCell) {
            const tempPointsPerPack = 20;
            const baseTemp = 30.7;
            let html = '';

            for (let temp = 1; temp <= tempPointsPerPack; temp++) {
                const temperature = (baseTemp + (Math.random() - 0.5) * 4).toFixed(1);
                const tempNum = String(temp).padStart(2, '0');

                let statusColor = '#10b981';
                let statusBg = '#10b98110';
                if (temperature < 29.0) {
                    statusColor = '#3b82f6';
                    statusBg = '#3b82f610';
                } else if (temperature > 32.0) {
                    statusColor = '#f59e0b';
                    statusBg = '#f59e0b10';
                }
                if (temperature > 35.0) {
                    statusColor = '#ef4444';
                    statusBg = '#ef444410';
                }

                // 如果是高亮温度点，使用特殊样式
                let isHighlight = highlightCell && temp === highlightCell;
                let highlightStyle = '';
                if (isHighlight) {
                    highlightStyle = 'box-shadow: 0 0 0 3px #3b82f6; transform: scale(1.05); border: 2px solid #3b82f6 !important; background: #dbeafe !important;';
                }

                html += '<div id="temp-' + temp + '" style="padding: 8px; background: ' + statusBg + '; border: 1px solid ' + statusColor + '20; border-radius: 6px; text-align: center; transition: all 0.3s; ' + highlightStyle + '">' +
                            '<div style="font-size: 10px; color: #64748b; margin-bottom: 2px;">T' + tempNum + '</div>' +
                            '<div style="font-size: 13px; font-weight: 600; color: ' + statusColor + ';">' + temperature + '°C</div>' +
                        '</div>';
            }

            return html;
        }

        // 打开Pack详情弹窗
        function openPackDetailsModal(packId, highlightCell, type) {
            const modal = document.getElementById('packDetailsModal');
            const modalTitle = document.getElementById('packDetailsModalTitle');
            const modalContent = document.getElementById('packDetailsModalContent');

            modalTitle.textContent = 'Pack' + packId + ' 单体详情';

            // 生成弹窗内容
            let content = '<div style="display: flex; flex-direction: column; gap: 24px;">';

            // 单体电压
            content += '<div id="voltageSection">' +
                '<h5 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: var(--text-primary); padding-bottom: 12px; border-bottom: 2px solid var(--border-color);">单体电压 (60节)</h5>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; max-height: 400px; overflow-y: auto;">' +
                    generatePackCellVoltages(packId, type !== 'temp' ? highlightCell : null) +
                '</div>' +
            '</div>';

            // 单体温度
            content += '<div id="temperatureSection">' +
                '<h5 style="margin: 0 0 16px 0; font-size: 15px; font-weight: 600; color: var(--text-primary); padding-bottom: 12px; border-bottom: 2px solid var(--border-color);">单体温度 (20点)</h5>' +
                '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;">' +
                    generatePackCellTemperatures(packId, type === 'temp' ? highlightCell : null) +
                '</div>' +
            '</div>';

            content += '</div>';

            modalContent.innerHTML = content;
            modal.style.display = 'flex';

            // 如果有高亮单体，滚动到对应位置
            if (highlightCell) {
                setTimeout(function() {
                    const targetSection = type === 'temp' ? 'temperatureSection' : 'voltageSection';
                    const section = document.getElementById(targetSection);
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        }

        // 关闭Pack详情弹窗
        function closePackDetailsModal() {
            document.getElementById('packDetailsModal').style.display = 'none';
        }

        // 生成单体电压列表HTML
        function generateCellVoltageHTML() {
            const packs = 4; // 4个Pack
            const cellsPerPack = 60; // 每个Pack 60节电芯
            const baseVoltage = 3.628; // 基准电压
            let html = '';

            for (let pack = 1; pack <= packs; pack++) {
                html += `
                    <div style="margin-bottom: 24px;">
                        <div style="background: #f8fafc; padding: 12px 16px; border-radius: 8px 8px 0 0; border-bottom: 2px solid #e5e7eb;">
                            <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #1e293b;">Pack${pack} - 单体电压 (60节)</h4>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; padding: 16px; background: var(--bg-secondary); border-radius: 0 0 8px 8px;">
                `;

                for (let cell = 1; cell <= cellsPerPack; cell++) {
                    // 生成随机电压，范围 3.601V ~ 3.652V
                    const voltage = (baseVoltage + (Math.random() - 0.5) * 0.05).toFixed(3);
                    const cellNum = String(cell).padStart(3, '0');

                    // 根据电压判断状态颜色
                    let statusColor = '#10b981'; // 绿色正常
                    let statusBg = '#10b98110';
                    if (voltage < 3.610) {
                        statusColor = '#f59e0b'; // 橙色偏低
                        statusBg = '#f59e0b10';
                    } else if (voltage > 3.645) {
                        statusColor = '#ef4444'; // 红色偏高
                        statusBg = '#ef444410';
                    }

                    html += `
                        <div style="padding: 10px; background: ${statusBg}; border: 1px solid ${statusColor}20; border-radius: 6px; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">Cell${cellNum}</div>
                            <div style="font-size: 16px; font-weight: 600; color: ${statusColor};">${voltage}V</div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // 生成单体温度列表HTML
        function generateCellTemperatureHTML() {
            const packs = 4; // 4个Pack
            const tempPointsPerPack = 20; // 每个Pack 20个温度点
            const baseTemp = 30.7; // 基准温度
            let html = '';

            for (let pack = 1; pack <= packs; pack++) {
                html += `
                    <div style="margin-bottom: 24px;">
                        <div style="background: #f8fafc; padding: 12px 16px; border-radius: 8px 8px 0 0; border-bottom: 2px solid #e5e7eb;">
                            <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #1e293b;">Pack${pack} - 单体温度 (20点)</h4>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; padding: 16px; background: var(--bg-secondary); border-radius: 0 0 8px 8px;">
                `;

                for (let temp = 1; temp <= tempPointsPerPack; temp++) {
                    // 生成随机温度，范围 28.5°C ~ 32.8°C
                    const temperature = (baseTemp + (Math.random() - 0.5) * 4).toFixed(1);
                    const tempNum = String(temp).padStart(3, '0');

                    // 根据温度判断状态颜色
                    let statusColor = '#10b981'; // 绿色正常
                    let statusBg = '#10b98110';
                    if (temperature < 29.0) {
                        statusColor = '#3b82f6'; // 蓝色偏低
                        statusBg = '#3b82f610';
                    } else if (temperature > 32.0) {
                        statusColor = '#f59e0b'; // 橙色偏高
                        statusBg = '#f59e0b10';
                    }
                    if (temperature > 35.0) {
                        statusColor = '#ef4444'; // 红色过高
                        statusBg = '#ef444410';
                    }

                    html += `
                        <div style="padding: 10px; background: ${statusBg}; border: 1px solid ${statusColor}20; border-radius: 6px; text-align: center;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">T${tempNum}</div>
                            <div style="font-size: 16px; font-weight: 600; color: ${statusColor};">${temperature}°C</div>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // 生成电表HTML的专用函数
        function generateMeterHTML() {
            let html = `
                <!-- 功率参数 -->
                <div class="metrics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="section-title" data-translate="meterPowerParamsTitle">${getTranslation('meterPowerParamsTitle')}</div>
                        <div style="display: flex; gap: 8px;">
                            <button class="upgrade-btn" onclick="openUpgradeModal()" title="升级设备" style="padding: 4px 12px; font-size: 12px;">
                                <i class="fas fa-arrow-up"></i>
                                <span>升级</span>
                                <span class="upgrade-badge">定制</span>
                            </button>
                            <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                <i class="fas fa-cog"></i>
                                <span data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                            </button>
                        </div>
                    </div>
                    <div class="metrics-grid">
            `;

            // 总有功功率
            if (shouldShowField('meter', 'realtime', 'totalActivePower')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label" data-translate="meterTotalActivePower">${getTranslation('meterTotalActivePower')}</div>
                        <div class="metric-value">
                            <span id="meter-total-active-power">184.4</span>
                            <span class="metric-unit">kW</span>
                        </div>
                    </div>
                `;
            }
            
            // 总无功功率
            if (shouldShowField('meter', 'realtime', 'totalReactivePower')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label" data-translate="meterTotalReactivePower">${getTranslation('meterTotalReactivePower')}</div>
                        <div class="metric-value">
                            <span id="meter-total-reactive-power">31.9</span>
                            <span class="metric-unit">kVar</span>
                        </div>
                    </div>
                `;
            }
            
            // 总视在功率
            if (shouldShowField('meter', 'realtime', 'totalApparentPower')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label" data-translate="meterTotalApparentPower">${getTranslation('meterTotalApparentPower')}</div>
                        <div class="metric-value">
                            <span id="meter-total-apparent-power">255.4</span>
                            <span class="metric-unit">kVA</span>
                        </div>
                    </div>
                `;
            }
            
            // 频率
            if (shouldShowField('meter', 'realtime', 'frequency')) {
                html += `
                    <div class="metric-card">
                        <div class="metric-label" data-translate="meterFrequency">${getTranslation('meterFrequency')}</div>
                        <div class="metric-value">
                            <span id="meter-frequency">50.0</span>
                            <span class="metric-unit">Hz</span>
                        </div>
                        <div class="metric-status good" data-translate="meterFrequencyStable">${getTranslation('meterFrequencyStable')}</div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // 检查是否需要显示电压电流部分
            const showVoltage = shouldShowField('meter', 'realtime', 'phaseAVoltage') || 
                               shouldShowField('meter', 'realtime', 'phaseBVoltage') || 
                               shouldShowField('meter', 'realtime', 'phaseCVoltage');
            const showCurrent = shouldShowField('meter', 'realtime', 'phaseACurrent') || 
                               shouldShowField('meter', 'realtime', 'phaseBCurrent') || 
                               shouldShowField('meter', 'realtime', 'phaseCCurrent');
            
            if (showVoltage || showCurrent) {
                html += `
                    <!-- 电压电流 -->
                    <div class="metrics-section" style="margin-top: 20px;">
                        <div class="section-title" data-translate="meterVoltageCurrentTitle">${getTranslation('meterVoltageCurrentTitle')}</div>
                        <div class="metrics-grid">
                `;
                
                // 电表电压
                if (showVoltage) {
                    html += `
                        <!-- 电表电压 - 三相合并 -->
                        <div class="metric-card">
                            <div class="metric-label" data-translate="meterVoltageLabel">${getTranslation('meterVoltageLabel')}</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);" data-translate="phaseA">${getTranslation('phaseA')}</span>
                                    <span class="metric-value">385.0 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);" data-translate="phaseB">${getTranslation('phaseB')}</span>
                                    <span class="metric-value">388.7 <span class="metric-unit">V</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);" data-translate="phaseC">${getTranslation('phaseC')}</span>
                                    <span class="metric-value">380.0 <span class="metric-unit">V</span></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 电表电流
                if (showCurrent) {
                    html += `
                        <!-- 电表电流 - 三相合并 -->
                        <div class="metric-card">
                            <div class="metric-label" data-translate="meterCurrentLabel">${getTranslation('meterCurrentLabel')}</div>
                            <div style="margin-top: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);" data-translate="phaseA">${getTranslation('phaseA')}</span>
                                    <span class="metric-value">163.7 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                                    <span style="font-size: 14px; color: var(--text-secondary);" data-translate="phaseB">${getTranslation('phaseB')}</span>
                                    <span class="metric-value">174.2 <span class="metric-unit">A</span></span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                    <span style="font-size: 14px; color: var(--text-secondary);" data-translate="phaseC">${getTranslation('phaseC')}</span>
                                    <span class="metric-value">163.0 <span class="metric-unit">A</span></span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // 第三个卡片位置预留（如果需要的话）
                if ((showVoltage && showCurrent) || (!showVoltage && !showCurrent)) {
                    html += `
                        <!-- 第三个卡片位置预留 -->
                        <div class="metric-card" style="visibility: hidden;">
                            <!-- 占位符，保持网格布局 -->
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // 检查是否需要显示电能统计部分
            const showEnergy = shouldShowField('meter', 'realtime', 'dailyActiveEnergy') || 
                              shouldShowField('meter', 'realtime', 'totalActiveEnergy');
            
            if (showEnergy) {
                html += `
                    <!-- 电能统计 -->
                    <div class="metrics-section" style="margin-top: 20px;">
                        <div class="section-title" data-translate="meterEnergyStatsTitle">${getTranslation('meterEnergyStatsTitle')}</div>
                        <div class="metrics-grid">
                `;
                
                // 日有功电量
                if (shouldShowField('meter', 'realtime', 'dailyActiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label" data-translate="meterDailyActiveEnergy">${getTranslation('meterDailyActiveEnergy')}</div>
                            <div class="metric-value">
                                <span id="meter-daily-active-energy">1529.2</span>
                                <span class="metric-unit">kWh</span>
                            </div>
                        </div>
                    `;
                }
                
                // 日无功电量 (如果有配置的话)
                if (shouldShowField('meter', 'realtime', 'dailyReactiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label" data-translate="meterDailyReactiveEnergy">${getTranslation('meterDailyReactiveEnergy')}</div>
                            <div class="metric-value">
                                <span id="meter-daily-reactive-energy">211.5</span>
                                <span class="metric-unit">kVarh</span>
                            </div>
                        </div>
                    `;
                }
                
                // 累计有功电量
                if (shouldShowField('meter', 'realtime', 'totalActiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label" data-translate="meterTotalActiveEnergy">${getTranslation('meterTotalActiveEnergy')}</div>
                            <div class="metric-value">
                                <span id="meter-total-active-energy">43</span>
                                <span class="metric-unit">MWh</span>
                            </div>
                        </div>
                    `;
                }
                
                // 累计无功电量 (如果有配置的话)
                if (shouldShowField('meter', 'realtime', 'totalReactiveEnergy')) {
                    html += `
                        <div class="metric-card">
                            <div class="metric-label" data-translate="meterTotalReactiveEnergy">${getTranslation('meterTotalReactiveEnergy')}</div>
                            <div class="metric-value">
                                <span id="meter-total-reactive-energy">7.7</span>
                                <span class="metric-unit">MVarh</span>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // 生成液冷机组HTML
        function generateCoolingHTML() {
            let html = '';

            // 系统状态
            html += `
                <div class="metrics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);">系统状态</h3>
                        <div style="display: flex; gap: 8px;">
                            <button class="upgrade-btn" onclick="openUpgradeModal()" title="升级设备" style="padding: 4px 12px; font-size: 12px;">
                                <i class="fas fa-arrow-up"></i>
                                <span>升级</span>
                                <span class="upgrade-badge">定制</span>
                            </button>
                            <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                <i class="fas fa-cog"></i>
                                <span>字段设置</span>
                            </button>
                        </div>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">通讯状态</div>
                            <div class="metric-value" style="color: #10b981;">正常</div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">在线</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">运行状态</div>
                            <div class="metric-value" style="color: #10b981;">运行中</div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">制冷模式</div>
                        </div>
                    </div>
                </div>
            `;

            // 温度参数
            const outletTemp = (18 + Math.random() * 2).toFixed(1);
            const inletTemp = (22 + Math.random() * 2).toFixed(1);

            html += `
                <div class="metrics-section">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">温度参数</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">出水温度</div>
                            <div class="metric-value">${outletTemp} <span class="metric-unit">°C</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">进水温度</div>
                            <div class="metric-value">${inletTemp} <span class="metric-unit">°C</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">温差</div>
                            <div class="metric-value">${(parseFloat(inletTemp) - parseFloat(outletTemp)).toFixed(1)} <span class="metric-unit">°C</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                        </div>
                    </div>
                </div>
            `;

            // 压力与流量参数
            const outletPressure = (2.5 + Math.random() * 0.5).toFixed(2);
            const inletPressure = (2.2 + Math.random() * 0.3).toFixed(2);
            const pumpSpeed = (1200 + Math.random() * 300).toFixed(0);

            html += `
                <div class="metrics-section">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 20px; color: var(--text-primary);">压力与流量</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">出水压力</div>
                            <div class="metric-value">${outletPressure} <span class="metric-unit">bar</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">进水压力</div>
                            <div class="metric-value">${inletPressure} <span class="metric-unit">bar</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">水泵转速</div>
                            <div class="metric-value">${pumpSpeed} <span class="metric-unit">RPM</span></div>
                            <div style="font-size: 12px; color: #10b981; margin-top: 4px;">正常</div>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        // 生成动态HTML的通用函数
        // category中文到translationKey的映射
        function getCategoryTranslationKey(categoryName) {
            const categoryMap = {
                '策略调度参数': 'cabinetStrategyParams',
                '核心运行参数': 'cabinetCoreParams',
                '运行统计': 'cabinetRunStats',
                '其他参数': 'cabinetOtherParams',
                'CPU状态': 'emsCpuStatus',
                '内存状态': 'emsMemoryStatus',
                '磁盘状态': 'emsDiskStatus',
                '开发板温度': 'emsBoardTemp',
                '4G网络状态': 'ems4GStatus',
                'WiFi状态': 'emsWifiStatus',
                '系统信息': 'emsSystemInfo',
                'PCS电网侧参数': 'pcsGridParams',
                'PCS温度': 'pcsTemp',
                '电池组管理参数': 'bmsBatteryParams',
                '单体电芯监控': 'bmsCellMonitor',
                '安全保护参数': 'bmsSafetyParams',
                '电能计量参数': 'meterEnergyParams',
                '三相电压': 'meterThreePhaseVoltage',
                '三相电流': 'meterThreePhaseCurrent',
                '电能统计': 'meterEnergyStats',
                '运行状态': 'thermalRunStatus',
                '核心监控参数': 'thermalCoreMonitor',
                '火灾探测': 'fireDetection',
                '消防联动': 'fireControl'
            };
            return categoryMap[categoryName] || '';
        }

        function generateComponentHTML(componentName) {
            // PCS组件特殊处理：三相数据合并显示
            if (componentName === 'pcs') {
                return generatePCSHTML();
            }

            // BMS组件特殊处理
            if (componentName === 'bms') {
                return generateBMSHTML();
            }

            const categories = fieldConfigs[componentName]?.realtime;
            if (!categories) return '';

            let html = '';

            categories.forEach((category, categoryIndex) => {
                // 检查该分类是否有任何字段需要显示
                const visibleFields = category.fields.filter(field => shouldShowField(componentName, 'realtime', field.id));
                if (visibleFields.length === 0) return;

                // 使用categoryKey获取翻译
                const categoryKey = category.categoryKey;
                const categoryText = categoryKey ? getTranslation(categoryKey) : '';

                // 为系统信息分类添加特殊类名
                const sectionClass = categoryKey === 'emsCategorySystemInfo' ? 'metrics-section system-info' : 'metrics-section';

                html += `
                    <div class="${sectionClass}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="font-size: 16px; font-weight: 600; margin: 0; color: var(--text-primary);" data-translate="${categoryKey}">${categoryText}</h3>
                            ${categoryIndex === 0 ? `
                                <div style="display: flex; gap: 8px;">
                                    <button class="upgrade-btn" onclick="openUpgradeModal()" title="升级设备" style="padding: 4px 12px; font-size: 12px;">
                                        <i class="fas fa-arrow-up"></i>
                                        <span>升级</span>
                                        <span class="upgrade-badge">定制</span>
                                    </button>
                                    <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                                        <i class="fas fa-cog"></i>
                                        <span id="cabinetBtnSettings" data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        <div class="metrics-grid">
                `;

                // 为每个字段生成HTML
                visibleFields.forEach(field => {
                    html += getFieldHTML(componentName, field.id);
                });

                html += `
                        </div>
                    </div>
                `;
            });

            // 防护：如果所有字段都被隐藏，显示提示信息而不是空白
            if (!html || html.trim() === '') {
                const componentNames = {
                    overall: '整机',
                    ems: 'EMS',
                    pcs: 'PCS',
                    bms: 'BMS',
                    meter: '电表',
                    thermal: '温度',
                    fire: '消防'
                };
                const displayName = componentNames[componentName] || componentName;

                return `
                    <div class="metrics-section">
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; text-align: center;">
                            <i class="fas fa-eye-slash" style="font-size: 48px; color: #cbd5e1; margin-bottom: 20px;"></i>
                            <h3 style="font-size: 18px; color: #64748b; margin-bottom: 12px;">
                                ${displayName}组件的所有字段都已隐藏
                            </h3>
                            <p style="font-size: 14px; color: #94a3b8; margin-bottom: 24px;">
                                您可以通过字段设置重新显示需要的字段
                            </p>
                            <button class="settings-btn" onclick="openFieldSettings()" style="padding: 10px 24px; font-size: 14px;">
                                <i class="fas fa-cog"></i>
                                <span>打开字段设置</span>
                            </button>
                        </div>
                    </div>
                `;
            }

            return html;
        }

        // 根据组件和字段ID获取字段HTML
        function getFieldHTML(component, fieldId) {
            const fieldData = getFieldData(component, fieldId);
            if (!fieldData) return '';

            return `
                <div class="metric-card">
                    <div class="metric-label" data-translate="${fieldData.translationKey || ''}">${fieldData.label}</div>
                    <div class="metric-value">
                        ${fieldData.value}
                        ${fieldData.unit ? `<span class="metric-unit">${fieldData.unit}</span>` : ''}
                    </div>
                    ${fieldData.status ? `<div style="font-size: 12px; color: ${fieldData.statusColor || '#666'}; margin-top: 4px;"${fieldData.statusTranslationKey ? ` data-translate="${fieldData.statusTranslationKey}"` : ''}>${fieldData.status}</div>` : ''}
                </div>
            `;
        }

        // 生成组件历史数据HTML的通用函数
        function generateHistoryHTML(componentName) {
            // EMS组件特殊处理：显示开发中信息
            if (componentName === 'ems') {
                return `
                    <div style="display: flex; justify-content: center; align-items: center; height: 300px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
                        <div style="text-align: center; color: var(--text-secondary);">
                            <i class="fas fa-code" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                            <div style="font-size: 18px; margin-bottom: 8px;" data-translate="devInProgress">${getTranslation('devInProgress')}</div>
                            <div style="font-size: 14px; opacity: 0.7;" data-translate="devHistoryDataMsg">${getTranslation('devHistoryDataMsg')}</div>
                        </div>
                    </div>
                `;
            }
            
            // BMS组件特殊处理：显示三个图表
            if (componentName === 'bms') {
                return `
                    <!-- 设置按钮 -->
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 8px;">
                        <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                            <i class="fas fa-cog"></i>
                            <span id="cabinetBtnSettings" data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                        </button>
                    </div>

                    <!-- 电池SOC趋势 -->
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title" data-translate="packBatterySOCTrend">${getTranslation('packBatterySOCTrend')}</div>
                            <input type="date"
                                   id="bms-soc-date"
                                   value="2025-08-11"
                                   onchange="changeBMSChartDate('bms-soc', this.value)"
                                   style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="bms-soc-chart"></canvas>
                        </div>
                    </div>

                    <!-- 电池电压历史 -->
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title" data-translate="cabinetChartTitleBatteryVoltageHistory">${getTranslation('cabinetChartTitleBatteryVoltageHistory')}</div>
                            <input type="date"
                                   id="bms-voltage-date"
                                   value="2025-08-11"
                                   onchange="changeBMSChartDate('bms-voltage', this.value)"
                                   style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="bms-voltage-chart"></canvas>
                        </div>
                    </div>

                    <!-- 温度分布分析 -->
                    <div class="chart-container">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div class="chart-title" data-translate="cabinetChartTitleTempDistribution">${getTranslation('cabinetChartTitleTempDistribution')}</div>
                            <input type="date"
                                   id="bms-temp-date"
                                   value="2025-08-11"
                                   onchange="changeBMSChartDate('bms-temp', this.value)"
                                   style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">
                        </div>
                        <div class="chart-wrapper">
                            <canvas id="bms-temp-chart"></canvas>
                        </div>
                    </div>
                `;
            }
            
            const categories = fieldConfigs[componentName]?.history;
            if (!categories) return '';

            let html = `
                <!-- 设置按钮 -->
                <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; gap: 8px;">
                    <button class="settings-btn" onclick="openFieldSettings()" title="字段设置" data-translate-title="btnFieldSettings" style="margin-bottom: 0; padding: 4px 12px; font-size: 12px;">
                        <i class="fas fa-cog"></i>
                        <span id="cabinetBtnSettings" data-translate="cabinetBtnSettings">${getTranslation('cabinetBtnSettings')}</span>
                    </button>
                </div>
            `;
            
            categories.forEach((category, categoryIndex) => {
                // 检查该分类是否有任何字段需要显示
                const visibleFields = category.fields.filter(field => shouldShowField(componentName, 'history', field.id));
                if (visibleFields.length === 0) return;

                // 图表分类的处理 - 使用categoryKey判断
                const isChartCategory = category.categoryKey && category.categoryKey.includes('CategoryChart');
                if (isChartCategory) {
                    visibleFields.forEach(field => {
                        html += getHistoryFieldHTML(componentName, field.id);
                    });
                }
            });
            
            return html;
        }

        // 根据组件和字段ID获取历史数据字段HTML
        function getHistoryFieldHTML(component, fieldId) {
            const fieldData = getHistoryFieldData(component, fieldId);
            if (!fieldData) return '';
            
            return `
                <div class="chart-container">
                    <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div class="chart-title">${fieldData.title}</div>
                        ${fieldData.controls || ''}
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="${fieldData.canvasId}"></canvas>
                    </div>
                </div>
            `;
        }

        // 获取历史数据字段配置
        function getHistoryFieldData(component, fieldId) {
            const historyFieldDataMap = {
                'ems': {
                    'strategyHistory': { title: getTranslation('chartEmsStrategyHistory'), canvasId: 'emsStrategyChart' },
                    'responseTime': { title: getTranslation('chartEmsResponseTime'), canvasId: 'emsResponseChart' }
                },
                'pcs': {
                    'powerConversion': {
                        title: getTranslation('chartPcsPowerConversion'),
                        canvasId: 'pcsPowerChart',
                        controls: `<input type="date"
                                          id="pcs-power-date"
                                          value="2025-08-11"
                                          onchange="changePCSChartDate('pcs-power', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'voltageCurrent': {
                        title: getTranslation('chartPcsVoltageCurrent'),
                        canvasId: 'pcsVoltageChart',
                        controls: `<input type="date"
                                          id="pcs-voltage-date"
                                          value="2025-08-11"
                                          onchange="changePCSChartDate('pcs-voltage', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'efficiency': {
                        title: getTranslation('chartPcsEfficiency'),
                        canvasId: 'pcsEfficiencyChart',
                        controls: `<input type="date"
                                          id="pcs-efficiency-date"
                                          value="2025-08-11"
                                          onchange="changePCSChartDate('pcs-efficiency', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                },
                'meter': {
                    'powerTrendAnalysis': {
                        title: getTranslation('chartMeterPowerTrend'),
                        canvasId: 'meter-power-trend-chart',
                        controls: `<input type="date"
                                          id="meter-power-trend-date"
                                          value="2025-08-11"
                                          onchange="changeMeterChartDate('meter-power-trend', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'energyConsumptionStats': {
                        title: getTranslation('chartMeterEnergyConsumption'),
                        canvasId: 'meter-energy-stats-chart',
                        controls: `<input type="date"
                                          id="meter-energy-stats-date"
                                          value="2025-08-11"
                                          onchange="changeMeterChartDate('meter-energy-stats', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'voltageQualityMonitoring': {
                        title: getTranslation('chartMeterVoltageQuality'),
                        canvasId: 'meter-voltage-quality-chart',
                        controls: `<input type="date"
                                          id="meter-voltage-quality-date"
                                          value="2025-08-11"
                                          onchange="changeMeterChartDate('meter-voltage-quality', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'harmonicAnalysis': {
                        title: getTranslation('chartMeterHarmonics'),
                        canvasId: 'meter-harmonic-chart',
                        controls: `<input type="date"
                                          id="meter-harmonic-date"
                                          value="2025-08-11"
                                          onchange="changeMeterChartDate('meter-harmonic', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                },
                'bms': {
                    'voltageHistory': { title: getTranslation('chartBmsVoltageHistory'), canvasId: 'bmsVoltageChart' },
                    'socBalance': { title: getTranslation('chartBmsSocBalance'), canvasId: 'bmsBalanceChart' },
                    'tempDistribution': { title: getTranslation('chartBmsTempDistribution'), canvasId: 'bmsTempChart' }
                },
                'thermal': {
                    'tempDistribution': {
                        title: getTranslation('chartThermalTempHistory'),
                        canvasId: 'thermalTempChart',
                        controls: `<input type="date"
                                          id="thermal-temp-date"
                                          value="2025-08-11"
                                          onchange="changeThermalChartDate('thermal-temp', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'coolingSystem': {
                        title: getTranslation('chartThermalCoolingSystem'),
                        canvasId: 'thermalCoolingChart',
                        controls: `<input type="date"
                                          id="thermal-cooling-date"
                                          value="2025-08-11"
                                          onchange="changeThermalChartDate('thermal-cooling', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'heatMap': {
                        title: getTranslation('chartThermalFanSpeed'),
                        canvasId: 'thermalHeatMapChart',
                        controls: `<input type="date"
                                          id="thermal-heatmap-date"
                                          value="2025-08-11"
                                          onchange="changeThermalChartDate('thermal-heatmap', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                },
                'cooling': {
                    'tempHistory': {
                        title: '温度历史',
                        canvasId: 'coolingTempChart',
                        controls: `<input type="date"
                                          id="cooling-temp-date"
                                          value="2025-08-11"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'pressureHistory': {
                        title: '压力历史',
                        canvasId: 'coolingPressureChart',
                        controls: `<input type="date"
                                          id="cooling-pressure-date"
                                          value="2025-08-11"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'pumpSpeedHistory': {
                        title: '水泵转速历史',
                        canvasId: 'coolingPumpChart',
                        controls: `<input type="date"
                                          id="cooling-pump-date"
                                          value="2025-08-11"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                },
                'fire': {
                    'systemStatus': {
                        title: getTranslation('chartFireSystemStatus'),
                        canvasId: 'fireSystemChart',
                        controls: `<input type="date"
                                          id="fire-system-date"
                                          value="2025-08-11"
                                          onchange="changeFireChartDate('fire-system', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'gasConcentration': {
                        title: getTranslation('chartFireGasConcentration'),
                        canvasId: 'fireGasChart',
                        controls: `<input type="date"
                                          id="fire-gas-date"
                                          value="2025-08-11"
                                          onchange="changeFireChartDate('fire-gas', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    },
                    'alarmHistory': {
                        title: getTranslation('chartFireAlarmRecords'),
                        canvasId: 'fireAlarmChart',
                        controls: `<input type="date"
                                          id="fire-alarm-date"
                                          value="2025-08-11"
                                          onchange="changeFireChartDate('fire-alarm', this.value)"
                                          style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 14px;">`
                    }
                }
            };
            
            return historyFieldDataMap[component]?.[fieldId];
        }

        // 获取字段数据的函数
        function getFieldData(component, fieldId) {
            const fieldDataMap = {
                'overall': {
                    // 策略调度参数
                    'currentStrategy': { label: getTranslation('cabinetCurrentStrategy'), value: `<span style="font-size: 16px; color: #2563eb;">${getTranslation('cabinetStrategyPeakValley')}</span>`, status: getTranslation('cabinetStrategyAutoRunning'), statusTranslationKey: 'cabinetStrategyAutoRunning', statusColor: '#666' },
                    'dispatchCommand': { label: getTranslation('cabinetScheduleCmd'), value: `<span style="font-size: 16px; color: #10b981;">${getTranslation('cabinetCmdCharge')}</span>`, status: `${getTranslation('cabinetTargetPower')}125kW`, statusColor: '#10b981' },
                    'targetSOC': { label: getTranslation('cabinetTargetSOC'), value: '<span id="overall-target-soc">91.0</span>', unit: '%', status: '', statusColor: '#666' },
                    'maxPower': { label: getTranslation('cabinetMaxPower'), value: '<span id="overall-max-power">284.0</span>', unit: 'kW', status: '', statusColor: '#666' },

                    // 核心运行参数
                    'soc': { label: 'SOC', value: '<span id="overall-soc">73.2</span>', unit: '%', status: '', statusColor: '#666' },
                    'soh': { label: getTranslation('cabinetChartLegendSOH'), value: '<span id="overall-soh">100.0</span>', unit: '%', status: getTranslation('cabinetSOHGood'), statusTranslationKey: 'cabinetSOHGood', statusColor: '#10b981' },
                    'temperature': { label: getTranslation('cabinetLabelTemp'), value: '<span id="overall-temperature">24.1</span>', unit: '°C', status: getTranslation('cabinetStatusTempNormal'), statusTranslationKey: 'cabinetStatusTempNormal', statusColor: '#10b981' },
                    'power': { label: getTranslation('cabinetLabelPower'), value: '<span id="overall-power">-119.3</span>', unit: 'kW', status: getTranslation('cabinetStatusCharging'), statusTranslationKey: 'cabinetStatusCharging', statusColor: '#10b981' },
                    'current': { label: getTranslation('cabinetLabelBattCurrent'), value: '<span id="overall-current">179.7</span>', unit: 'A', status: getTranslation('cabinetStatusCurrentNormal'), statusTranslationKey: 'cabinetStatusCurrentNormal', statusColor: '#10b981' },
                    'voltage': { label: getTranslation('cabinetLabelBattVoltage'), value: '<span id="overall-voltage">740.4</span>', unit: 'V', status: getTranslation('cabinetStatusVoltageStable'), statusTranslationKey: 'cabinetStatusVoltageStable', statusColor: '#10b981' },
                    
                    // 运行统计
                    'todayCharge': { label: getTranslation('cabinetLabelTodayCharge'), value: '<span id="overall-today-charge">720.9</span>', unit: 'kWh', status: '', statusColor: '#666' },
                    'todayDischarge': { label: getTranslation('cabinetLabelTodayDischarge'), value: '<span id="overall-today-discharge">515.9</span>', unit: 'kWh', status: '', statusColor: '#666' },
                    'totalCharge': { label: getTranslation('cabinetTotalCharge'), value: '<span id="overall-total-charge">1808</span>', unit: 'MWh', status: '', statusColor: '#666' },
                    'totalDischarge': { label: getTranslation('cabinetTotalDischarge'), value: '<span id="overall-total-discharge">946</span>', unit: 'MWh', status: '', statusColor: '#666' },

                    // 其他参数
                    'cycles': { label: getTranslation('cabinetCycleCount'), value: '<span id="overall-cycles">3769</span>', unit: getTranslation('times'), status: getTranslation('cabinetLifeNormal'), statusTranslationKey: 'cabinetLifeNormal', statusColor: '#10b981' }
                },
                'ems': {
                    'cpuUsage': { label: getTranslation('emsCpuUsage'), value: '<span id="cpu-usage">35.3</span>', unit: '%', status: getTranslation('statusCpuStatus'), statusTranslationKey: 'statusCpuStatus' },
                    'cpuTemp': { label: getTranslation('emsCpuTemp'), value: '<span id="cpu-temp">45.0</span>', unit: '°C', status: getTranslation('statusTempNormal'), statusTranslationKey: 'statusTempNormal', statusColor: '#10b981' },
                    'memoryUsage': { label: getTranslation('emsMemoryUsage'), value: '<span id="memory-usage">66.5</span>', unit: '%', status: '' },
                    'diskUsage': { label: getTranslation('emsDiskUsage'), value: '<span id="disk-usage">36.8</span>', unit: '%', status: '' },
                    'boardTemp': { label: getTranslation('emsBoardTemp'), value: '<span id="board-temp">36.7</span>', unit: '°C', status: getTranslation('statusTempNormal'), statusTranslationKey: 'statusTempNormal', statusColor: '#10b981' },
                    'signal4G': { label: getTranslation('emsSignal4G'), value: '<span id="signal-4g">-63</span>', unit: 'dBm', status: getTranslation('statusSignalGood'), statusTranslationKey: 'statusSignalGood', statusColor: '#10b981' },
                    'simStatus': { label: getTranslation('emsSimStatus'), value: `<span style="color: #10b981;" data-translate="valueInserted">${getTranslation('valueInserted')}</span>`, status: '' },
                    'networkInterface': { label: getTranslation('emsNetworkInterface'), value: `<span style="color: #10b981;" data-translate="valueOn">${getTranslation('valueOn')}</span>`, status: '' },
                    'wifiSignal': { label: getTranslation('emsWifiSignal'), value: '<span id="wifi-signal">-78</span>', unit: 'dBm', status: getTranslation('statusSignalGood'), statusTranslationKey: 'statusSignalGood', statusColor: '#10b981' },
                    'wifiInterface': { label: getTranslation('emsWifiInterface'), value: `<span style="color: #666;" data-translate="valueOff">${getTranslation('valueOff')}</span>`, status: '' },
                    'uptime': { label: getTranslation('emsUptime'), value: `<span id="system-uptime">15<span data-translate="unitDay">${getTranslation('unitDay')}</span> 8<span data-translate="unitHour">${getTranslation('unitHour')}</span> 32<span data-translate="unitMinute">${getTranslation('unitMinute')}</span></span>`, unit: '', status: '' },
                    'systemTime': { label: getTranslation('emsSystemTime'), value: '<span id="system-time">2025-07-11 09:42</span>', unit: '', status: '' },
                    'hardwareTime': { label: getTranslation('emsHardwareTime'), value: '<span id="hardware-time">2025-07-11 09:42</span>', unit: '', status: '' }
                },
                'pcs': {
                    // PCS电网侧电压
                    'gridVoltageA': { label: getTranslation('pcsGridVoltageA'), value: '<span id="pcs-grid-voltage-a">385.5</span>', unit: 'V', status: '' },
                    'gridVoltageB': { label: getTranslation('pcsGridVoltageB'), value: '<span id="pcs-grid-voltage-b">386.2</span>', unit: 'V', status: '' },
                    'gridVoltageC': { label: getTranslation('pcsGridVoltageC'), value: '<span id="pcs-grid-voltage-c">384.3</span>', unit: 'V', status: '' },
                    // PCS电网侧电流
                    'gridCurrentA': { label: getTranslation('pcsGridCurrentA'), value: '<span id="pcs-grid-current-a">96.5</span>', unit: 'A', status: '' },
                    'gridCurrentB': { label: getTranslation('pcsGridCurrentB'), value: '<span id="pcs-grid-current-b">89.9</span>', unit: 'A', status: '' },
                    'gridCurrentC': { label: getTranslation('pcsGridCurrentC'), value: '<span id="pcs-grid-current-c">85.2</span>', unit: 'A', status: '' },
                    // PCS电网侧功率
                    'gridPowerA': { label: getTranslation('pcsGridPowerA'), value: '<span id="pcs-grid-power-a">58.5</span>', unit: 'kW', status: '' },
                    'gridPowerB': { label: getTranslation('pcsGridPowerB'), value: '<span id="pcs-grid-power-b">55.7</span>', unit: 'kW', status: '' },
                    'gridPowerC': { label: getTranslation('pcsGridPowerC'), value: '<span id="pcs-grid-power-c">58.8</span>', unit: 'kW', status: '' },
                    // PCS温度
                    'pcsTemp': { label: getTranslation('pcsTemp'), value: '<span id="pcs-temp">57.3</span>', unit: '°C', status: getTranslation('statusTempNormal'), statusTranslationKey: 'statusTempNormal', statusColor: '#10b981' }
                },
                'bms': {
                    'totalVoltage': { label: getTranslation('bmsTotalVoltage'), value: `<span id="bms-total-voltage">${(720 + Math.random() * 60).toFixed(1)}</span>`, unit: 'V', status: getTranslation('statusVoltageNormal'), statusTranslationKey: 'statusVoltageNormal', statusColor: '#10b981' },
                    'totalCurrent': { label: getTranslation('bmsTotalCurrent'), value: `<span id="bms-total-current">${(Math.random() > 0.5 ? '+' : '-')}${(120 + Math.random() * 80).toFixed(1)}</span>`, unit: 'A', status: getTranslation('statusCurrentCharging'), statusTranslationKey: 'statusCurrentCharging', statusColor: '#10b981' },
                    'remainingCapacity': { label: getTranslation('bmsRemainingCapacity'), value: `<span id="bms-remaining-capacity">${(450 + Math.random() * 100).toFixed(1)}</span>`, unit: 'Ah', status: getTranslation('statusCapacityAvailable'), statusTranslationKey: 'statusCapacityAvailable' },
                    'cycles': { label: getTranslation('bmsCycles'), value: `<span id="bms-cycles">${Math.floor(2800 + Math.random() * 500)}</span>`, unit: getTranslation('unitTimes'), status: getTranslation('statusCycleLifeGood'), statusTranslationKey: 'statusCycleLifeGood' },
                    'internalResistance': { label: getTranslation('bmsInternalResistance'), value: `<span id="bms-internal-resistance">${(45 + Math.random() * 15).toFixed(1)}</span>`, unit: 'mΩ', status: getTranslation('statusImpedanceNormal'), statusTranslationKey: 'statusImpedanceNormal', statusColor: '#10b981' },
                    'insulation': { label: getTranslation('bmsInsulation'), value: `<span id="bms-insulation">${(850 + Math.random() * 300).toFixed(0)}</span>`, unit: 'kΩ', status: getTranslation('statusInsulationGood'), statusTranslationKey: 'statusInsulationGood', statusColor: '#10b981' },
                    'maxCellVoltage': { label: getTranslation('bmsMaxCellVoltage'), value: `<span id="bms-max-cell-voltage">${(3.35 + Math.random() * 0.02).toFixed(3)}</span>`, unit: 'V', status: `${getTranslation('statusCellNumber')}: ${Math.floor(Math.random() * 280 + 1)}` },
                    'minCellVoltage': { label: getTranslation('bmsMinCellVoltage'), value: `<span id="bms-min-cell-voltage">${(3.32 + Math.random() * 0.02).toFixed(3)}</span>`, unit: 'V', status: `${getTranslation('statusCellNumber')}: ${Math.floor(Math.random() * 280 + 1)}` },
                    'voltageDiff': { label: getTranslation('bmsVoltageDiff'), value: `<span id="bms-voltage-diff">${(5 + Math.random() * 15).toFixed(1)}</span>`, unit: 'mV', status: getTranslation('statusVoltageDiffGood'), statusTranslationKey: 'statusVoltageDiffGood', statusColor: '#10b981' },
                    'consistency': { label: getTranslation('bmsConsistency'), value: `<span id="bms-consistency">${(96.5 + Math.random() * 2.5).toFixed(1)}</span>`, unit: '%', status: getTranslation('statusConsistencyExcellent'), statusTranslationKey: 'statusConsistencyExcellent', statusColor: '#10b981' },
                    'abnormalCells': { label: getTranslation('bmsAbnormalCells'), value: '<span id="bms-abnormal-cells">0</span>', unit: getTranslation('unitPiece'), status: getTranslation('statusAllNormal'), statusTranslationKey: 'statusAllNormal', statusColor: '#10b981' },
                    'balanceStatus': { label: getTranslation('bmsBalanceStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="${Math.random() > 0.7 ? 'valueBalancing' : 'valueNotBalancing'}">${Math.random() > 0.7 ? getTranslation('valueBalancing') : getTranslation('valueNotBalancing')}</span>`, status: getTranslation('statusActiveBalanceStrategy'), statusTranslationKey: 'statusActiveBalanceStrategy' },
                    'totalCells': { label: getTranslation('bmsTotalCells'), value: '<span>280</span>', unit: getTranslation('unitPiece'), status: getTranslation('statusCellConfiguration'), statusTranslationKey: 'statusCellConfiguration' },
                    'samplingAccuracy': { label: getTranslation('bmsSamplingAccuracy'), value: `<span id="bms-sampling-accuracy">${(99.5 + Math.random() * 0.4).toFixed(2)}</span>`, unit: '%', status: getTranslation('statusHighPrecisionSampling'), statusTranslationKey: 'statusHighPrecisionSampling', statusColor: '#10b981' },
                    'overvoltageProtection': { label: getTranslation('bmsOvervoltageProtection'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="statusNormal">${getTranslation('statusNormal')}</span>`, status: `${getTranslation('statusThresholdPrefix')}3.65V` },
                    'undervoltageProtection': { label: getTranslation('bmsUndervoltageProtection'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="statusNormal">${getTranslation('statusNormal')}</span>`, status: `${getTranslation('statusThresholdPrefix')}2.8V` },
                    'overcurrentProtection': { label: getTranslation('bmsOvercurrentProtection'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="statusNormal">${getTranslation('statusNormal')}</span>`, status: `${getTranslation('statusThresholdPrefix')}300A` },
                    'overtemperatureProtection': { label: getTranslation('bmsOvertemperatureProtection'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="statusNormal">${getTranslation('statusNormal')}</span>`, status: `${getTranslation('statusThresholdPrefix')}60°C` },
                    'shortcircuitProtection': { label: getTranslation('bmsShortcircuitProtection'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="statusNormal">${getTranslation('statusNormal')}</span>`, status: getTranslation('statusNotTriggered'), statusTranslationKey: 'statusNotTriggered', statusColor: '#10b981' },
                    'communicationStatus': { label: getTranslation('bmsCommunicationStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueOnline">${getTranslation('valueOnline')}</span>`, status: getTranslation('statusCanCommNormal'), statusTranslationKey: 'statusCanCommNormal', statusColor: '#10b981' },
                    'faultCode': { label: getTranslation('bmsFaultCode'), value: '<span id="bms-fault-code">0x0000</span>', unit: '', status: getTranslation('statusNoFault'), statusTranslationKey: 'statusNoFault', statusColor: '#10b981' },
                    'hardwareVersion': { label: getTranslation('bmsHardwareVersion'), value: '<span>V2.1.3</span>', unit: '', status: `${getTranslation('statusSoftwareVersion')}V1.8.5` }
                },
                'thermal': {
                    // 运行状态
                    'cabinetTemp': { label: getTranslation('thermalCabinetTemp'), value: '<span id="cabinetTemp">30.9</span>', unit: '°C', status: getTranslation('statusTempNormal'), statusTranslationKey: 'statusTempNormal', statusColor: '#10b981' },
                    'runningMode': { label: getTranslation('thermalRunningMode'), value: `<span style="font-size: 16px; color: #2563eb;" data-translate="valueCooling">${getTranslation('valueCooling')}</span>`, status: '', statusColor: '#2563eb' },
                    'humidity': { label: getTranslation('cabinetChartLegendHumidity'), value: '<span id="humidity">51.4</span>', unit: '%', status: getTranslation('statusHumidityNormal'), statusTranslationKey: 'statusHumidityNormal', statusColor: '#10b981' },

                    // 核心监控参数
                    'battMaxTemp': { label: getTranslation('cabinetChartLegendBatteryMaxTemp'), value: '<span id="battMaxTemp">39.9</span>', unit: '℃', status: getTranslation('statusTempNormal'), statusTranslationKey: 'statusTempNormal', statusColor: '#10b981' },
                    'battMinTemp': { label: getTranslation('cabinetChartLegendBatteryMinTemp'), value: '<span id="battMinTemp">25.5</span>', unit: '℃', status: getTranslation('statusTempNormal'), statusTranslationKey: 'statusTempNormal', statusColor: '#10b981' },
                    'battAvgTemp': { label: getTranslation('cabinetChartLegendBatteryAvgTemp'), value: '<span id="battAvgTemp">32.8</span>', unit: '℃', status: getTranslation('statusAvgTempNormal'), statusTranslationKey: 'statusAvgTempNormal', statusColor: '#10b981' },
                    'battTempDiff': { label: getTranslation('thermalBattTempDiff'), value: '<span id="battTempDiff">6.0</span>', unit: '℃', status: getTranslation('statusTempDiffNormal'), statusTranslationKey: 'statusTempDiffNormal', statusColor: '#10b981' },
                    'inletTemp': { label: getTranslation('cabinetChartLegendInletTemp'), value: '<span id="inletTemp">31.4</span>', unit: '℃', status: getTranslation('statusInletTempNormal'), statusTranslationKey: 'statusInletTempNormal', statusColor: '#10b981' },
                    'outletTemp': { label: getTranslation('cabinetChartLegendOutletTemp'), value: '<span id="outletTemp">26.2</span>', unit: '℃', status: getTranslation('statusOutletTempNormal'), statusTranslationKey: 'statusOutletTempNormal', statusColor: '#10b981' },
                    'coolantTemp': { label: getTranslation('thermalCoolantTemp'), value: '<span id="coolantTemp">24.2</span>', unit: '℃', status: getTranslation('statusCoolantTempNormal'), statusTranslationKey: 'statusCoolantTempNormal', statusColor: '#10b981' },
                    // 系统运行参数
                    'mainFanSpeed': { label: getTranslation('cabinetChartLegendMainFanSpeed'), value: '<span id="mainFanSpeed">1241</span>', unit: 'rpm', status: '', statusColor: '#10b981' },
                    'auxFanSpeed': { label: getTranslation('thermalAuxFanSpeed'), value: '<span id="auxFanSpeed">1115</span>', unit: 'rpm', status: '', statusColor: '#10b981' },
                    'coolantFlow': { label: getTranslation('thermalCoolantFlow'), value: '<span id="coolantFlow">12.7</span>', unit: 'L/min', status: '', statusColor: '#10b981' },
                    'compressorPower': { label: getTranslation('thermalCompressorPower'), value: '<span id="compressorPower">3.5</span>', unit: 'kW', status: '', statusColor: '#10b981' },
                    'thermalPower': { label: getTranslation('thermalPower'), value: '<span id="thermalPower">5.8</span>', unit: 'kW', status: '', statusColor: '#10b981' },
                    'tempRiseRate': { label: getTranslation('thermalTempRiseRate'), value: '<span id="tempRiseRate">0.78</span>', unit: '°C/min', status: '', statusColor: '#10b981' },
                    'coolingEff': { label: getTranslation('thermalCoolingEff'), value: '<span id="coolingEff">85.9</span>', unit: '%', status: '', statusColor: '#10b981' },
                    'copValue': { label: getTranslation('thermalCopValue'), value: '<span id="copValue">3.7</span>', unit: '', status: '', statusColor: '#10b981' },
                    'thermalManagementStatus': { label: getTranslation('thermalManagementStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueCoolingMode">${getTranslation('valueCoolingMode')}</span>`, status: '', statusColor: '#10b981' },
                    'coolingMode': { label: getTranslation('thermalCoolingMode'), value: `<span style="font-size: 16px; color: #2563eb;" data-translate="valueForcedCooling">${getTranslation('valueForcedCooling')}</span>`, status: '', statusColor: '#2563eb' },
                    'thermalRuntime': { label: getTranslation('thermalRuntime'), value: '<span id="thermalRuntime">7.2</span>', unit: getTranslation('unitHour'), status: '', statusColor: '#666' },
                    'maintenanceStatus': { label: getTranslation('thermalMaintenanceStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="statusNormal">${getTranslation('statusNormal')}</span>`, status: '', statusColor: '#10b981' },
                    'thermalCycles': { label: getTranslation('thermalCycles'), value: '<span id="thermalCycles">15</span>', unit: getTranslation('unitTimes'), status: '', statusColor: '#666' },
                    'filterStatus': { label: getTranslation('thermalFilterStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueGood">${getTranslation('valueGood')}</span>`, status: '', statusColor: '#10b981' },
                    'alarmStatus': { label: getTranslation('thermalAlarmStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueNoAlarm">${getTranslation('valueNoAlarm')}</span>`, status: '', statusColor: '#10b981' }
                },
                'fire': {
                    'smokeDetector': { label: getTranslation('fireSmokeDetector'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueDetectorNormal">${getTranslation('valueDetectorNormal')}</span>`, status: '', statusColor: '#10b981' },
                    'fireAlarmStatus': { label: getTranslation('fireAlarmStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueFireAlarmNormal">${getTranslation('valueFireAlarmNormal')}</span>`, status: '', statusColor: '#10b981' },
                    'extinguisherStatus': { label: getTranslation('fireExtinguisherStatus'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueExtinguisherReady">${getTranslation('valueExtinguisherReady')}</span>`, status: '', statusColor: '#10b981' },
                    'emergencyShutdown': { label: getTranslation('fireEmergencyShutdown'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="statusNotTriggered">${getTranslation('statusNotTriggered')}</span>`, status: '', statusColor: '#10b981' },
                    'alarmDevice': { label: getTranslation('fireAlarmDevice'), value: `<span style="font-size: 16px; color: #10b981;" data-translate="valueAlarmNormal">${getTranslation('valueAlarmNormal')}</span>`, status: '', statusColor: '#10b981' }
                },
                'meter': {
                    'totalActivePower': { label: getTranslation('meterTotalActivePower'), value: '<span id="meter-total-active-power">184.4</span>', unit: 'kW', status: getTranslation('statusNormal'), statusTranslationKey: 'statusNormal', statusColor: '#10b981' },
                    'totalReactivePower': { label: getTranslation('meterTotalReactivePower'), value: '<span id="meter-total-reactive-power">31.9</span>', unit: 'kVar', status: getTranslation('statusNormal'), statusTranslationKey: 'statusNormal', statusColor: '#10b981' },
                    'totalApparentPower': { label: getTranslation('meterTotalApparentPower'), value: '<span id="meter-total-apparent-power">255.4</span>', unit: 'kVA', status: getTranslation('statusNormal'), statusTranslationKey: 'statusNormal', statusColor: '#10b981' },
                    'frequency': { label: getTranslation('meterFrequency'), value: '<span id="meter-frequency">50.0</span>', unit: 'Hz', status: getTranslation('statusFrequencyStable'), statusTranslationKey: 'statusFrequencyStable', statusColor: '#10b981' },
                    'meterVoltage': { label: getTranslation('meterVoltage'), value: 'A相:385.0V B相:388.7V C相:380.0V', unit: '', status: getTranslation('statusNormal'), statusTranslationKey: 'statusNormal', statusColor: '#10b981' },
                    'meterCurrent': { label: getTranslation('meterCurrent'), value: 'A相:163.7A B相:174.2A C相:163.0A', unit: '', status: getTranslation('statusNormal'), statusTranslationKey: 'statusNormal', statusColor: '#10b981' },
                    'dailyActiveEnergy': { label: getTranslation('meterDailyActiveEnergy'), value: '<span id="meter-daily-active-energy">1529.2</span>', unit: 'kWh', status: '', statusColor: '#666' },
                    'dailyReactiveEnergy': { label: getTranslation('meterDailyReactiveEnergy'), value: '<span id="meter-daily-reactive-energy">211.5</span>', unit: 'kVarh', status: '', statusColor: '#666' },
                    'totalActiveEnergy': { label: getTranslation('meterTotalActiveEnergy'), value: '<span id="meter-total-active-energy">43</span>', unit: 'MWh', status: '', statusColor: '#666' },
                    'totalReactiveEnergy': { label: getTranslation('meterTotalReactiveEnergy'), value: '<span id="meter-total-reactive-energy">7.7</span>', unit: 'MVarh', status: '', statusColor: '#666' }
                }
            };

            const fieldData = fieldDataMap[component]?.[fieldId];
            if (!fieldData) return null;

            // 自动添加translationKey（基于组件名和字段ID）
            // 例如: overall-currentStrategy -> cabinetCurrentStrategy
            // 例如: ems-cpuUsage -> emsCpuUsage
            const translationKey = component === 'overall' ? `cabinet${fieldId.charAt(0).toUpperCase()}${fieldId.slice(1)}` : `${component}${fieldId.charAt(0).toUpperCase()}${fieldId.slice(1)}`;

            return {
                ...fieldData,
                translationKey: translationKey,
                statusTranslationKey: fieldData.status ? `${translationKey}Status` : ''
            };
        }
        
        // 切换控制模式
        function changeMode(mode) {
            // 检查是否在编辑模式下
            if (!isControlEditMode) {
                // 恢复原来的选中状态
                const currentMode = document.getElementById('autoControl').style.display !== 'none' ? 'auto' : 'manual';
                const radios = document.querySelectorAll('input[name="mode"]');
                radios.forEach(radio => {
                    radio.checked = radio.value === currentMode;
                });
                return; // 非编辑模式下不允许操作
            }
            
            if (mode === 'manual') {
                document.getElementById('manualControl').style.display = 'block';
                document.getElementById('autoControl').style.display = 'none';
            } else {
                document.getElementById('manualControl').style.display = 'none';
                document.getElementById('autoControl').style.display = 'block';
            }
        }
        
        // 停止手动模式
        function stopManualMode() {
            // 显示按钮，隐藏状态
            const manualButtons = document.getElementById('manualButtons');
            const manualStatus = document.getElementById('manualStatus');
            
            manualButtons.style.display = 'block';
            manualStatus.style.display = 'none';
            
            // 重置手动模式状态
            
            // 重置所有按钮样式
            document.querySelectorAll('.manual-mode-btn').forEach(btn => {
                btn.style.background = 'var(--bg-primary)';
                btn.style.borderColor = 'var(--border-color)';
                btn.style.color = 'var(--text-primary)';
            });
            
            currentManualMode = null;
            
            // 显示停止成功提示
            showToast('手动模式已停止', '#ef4444');
        }
        
        // 选择手动模式操作
        let currentManualMode = null;
        function selectManualMode(mode) {
            // 检查是否在编辑模式下
            if (!isControlEditMode) {
                return; // 非编辑模式下不允许操作
            }
            
            currentManualMode = mode;
            
            // 重置所有按钮样式
            document.querySelectorAll('.manual-mode-btn').forEach(btn => {
                btn.style.background = 'var(--bg-primary)';
                btn.style.borderColor = 'var(--border-color)';
                btn.style.color = 'var(--text-primary)';
            });
            
            // 设置选中的按钮样式
            const selectedBtn = document.querySelector(`[data-mode="${mode}"]`);
            if (selectedBtn) {
                // 根据不同模式设置不同的颜色
                if (mode === 'charge') {
                    selectedBtn.style.background = '#dbeafe';
                    selectedBtn.style.borderColor = '#3b82f6';
                    selectedBtn.style.color = '#1e40af';
                } else if (mode === 'discharge') {
                    selectedBtn.style.background = '#fef3c7';
                    selectedBtn.style.borderColor = '#f59e0b';
                    selectedBtn.style.color = '#d97706';
                }
            }
        }
        
        
        // 初始化时间轴
        function initTimeline() {
            const container = document.getElementById('timelineContainer');
            if (!container) return;
            
            // 初始化时间段数据: 0=平价, 1=峰值, 2=谷值
            const timeSlots = new Array(24).fill(0);
            // 设置默认峰值时段 10-14点
            for (let i = 10; i <= 14; i++) {
                timeSlots[i] = 1;
            }
            // 设置默认谷值时段 23点和0-6点
            timeSlots[23] = 2;
            for (let i = 0; i <= 6; i++) {
                timeSlots[i] = 2;
            }
            
            // 创建时间块
            container.innerHTML = '';
            for (let i = 0; i < 24; i++) {
                const block = document.createElement('div');
                block.style.cssText = `
                    flex: 1;
                    height: 100%;
                    border-right: 1px solid #e5e7eb;
                    cursor: pointer;
                    transition: background 0.2s;
                    position: relative;
                `;
                block.dataset.hour = i;
                updateTimeBlock(block, timeSlots[i]);
                
                // 添加点击事件
                block.addEventListener('click', function() {
                    // 只有在编辑模式下才能点击
                    if (!isControlEditMode) return;
                    
                    // 循环切换: 平价->峰值->谷值->平价
                    const currentType = parseInt(this.dataset.type || 0);
                    const newType = (currentType + 1) % 3;
                    
                    // 更新数据
                    timeSlots[i] = newType;
                    updateTimeBlock(this, newType);
                });
                
                // 添加悬停效果
                block.addEventListener('mouseenter', function() {
                    this.style.opacity = '0.8';
                });
                block.addEventListener('mouseleave', function() {
                    this.style.opacity = '1';
                });
                
                container.appendChild(block);
            }
            
            // 存储时间轴数据
            window.timeSlots = timeSlots;
        }
        
        // 更新时间块显示
        function updateTimeBlock(block, type) {
            const colors = ['#e5e7eb', '#ef4444', '#3b82f6']; // 平价, 峰值, 谷值
            block.style.background = colors[type];
            block.dataset.type = type;
            
            // 添加提示文字
            const tooltips = [
                getTranslation('cabinetControlFlatPeriod'),
                getTranslation('cabinetControlPeakPeriod'),
                getTranslation('cabinetControlValleyPeriod')
            ];
            block.title = `${block.dataset.hour}:00-${parseInt(block.dataset.hour) + 1}:00 (${tooltips[type]})`;
        }
        
        // 切换控制面板编辑模式
        let isControlEditMode = false;
        function toggleControlEdit() {
            isControlEditMode = !isControlEditMode;
            const editBtn = document.getElementById('editControlBtn');
            const controlPanel = document.getElementById('controlPanel');
            const controlButtons = document.getElementById('controlButtons');
            
            if (isControlEditMode) {
                // 隐藏编辑按钮
                editBtn.style.display = 'none';
                
                // 显示底部按钮
                controlButtons.style.display = 'block';
                
                // 启用所有控件
                controlPanel.querySelectorAll('input, select, button').forEach(element => {
                    // 排除编辑按钮本身、标签页切换按钮和底部按钮
                    if (element.id !== 'editControlBtn' && 
                        !element.classList.contains('data-tab') && 
                        element.parentElement?.id !== 'controlButtons') {
                        element.disabled = false;
                        element.style.opacity = '1';
                        element.style.cursor = 'auto';
                    }
                });
                
                // 启用时间轴点击
                if (window.timelineContainer) {
                    window.timelineContainer.style.pointerEvents = 'auto';
                }
            } else {
                // 显示编辑按钮
                editBtn.style.display = 'flex';
                editBtn.style.background = '#3562E3';
                editBtn.innerHTML = '<i class="fas fa-edit" style="font-size: 14px;"></i>编辑';
                
                // 隐藏底部按钮
                controlButtons.style.display = 'none';
                
                // 禁用所有控件
                controlPanel.querySelectorAll('input, select, button').forEach(element => {
                    // 排除编辑按钮本身、标签页切换按钮和底部按钮
                    if (element.id !== 'editControlBtn' && 
                        !element.classList.contains('data-tab') && 
                        element.parentElement?.id !== 'controlButtons') {
                        element.disabled = true;
                        element.style.opacity = '0.6';
                        element.style.cursor = 'not-allowed';
                    }
                });
                
                // 禁用时间轴点击
                if (window.timelineContainer) {
                    window.timelineContainer.style.pointerEvents = 'none';
                }
            }
        }
        
        // 取消控制编辑
        function cancelControlEdit() {
            if (isControlEditMode) {
                // 重置手动模式选择状态
                currentManualMode = null;
                // 重置手动模式按钮样式
                document.querySelectorAll('.manual-mode-btn').forEach(btn => {
                    btn.style.background = 'var(--bg-primary)';
                    btn.style.borderColor = 'var(--border-color)';
                    btn.style.color = 'var(--text-primary)';
                });
                
                toggleControlEdit(); // 这会自动切换isControlEditMode的状态
            }
        }
        
        // 液冷控制 - 手动模式切换
        function updateCoolantSubMode() {
            const mode = document.getElementById('coolantWorkMode').value;
            const subModeContainer = document.getElementById('coolantSubModeContainer');
            const runDataContainer = document.getElementById('coolantRunDataContainer');
            const runDataText = document.getElementById('coolantRunData');

            // 只有制冷模式才显示工况选择
            if (mode === 'cooling') {
                subModeContainer.style.display = 'block';
                runDataContainer.style.display = 'block';
                // 默认显示半工况数据
                runDataText.textContent = '开启制冷模式，出水温度设置为25℃，水泵转速50%';
            } else if (mode === 'heating') {
                subModeContainer.style.display = 'none';
                runDataContainer.style.display = 'block';
                runDataText.textContent = '开启制热模式，出水温度设置为25℃';
            } else {
                subModeContainer.style.display = 'none';
                runDataContainer.style.display = 'none';
            }
        }

        // 液冷控制 - 更新工况运行数据
        function updateCoolantRunData() {
            const subMode = document.getElementById('coolantSubMode').value;
            const runDataText = document.getElementById('coolantRunData');

            if (subMode === 'half') {
                runDataText.textContent = '开启制冷模式，出水温度设置为25℃，水泵转速50%';
            } else if (subMode === 'full') {
                runDataText.textContent = '开启制冷模式，出水温度设置为25℃，水泵转速100%';
            }
        }

        // 保存控制设置
        function saveControlSettings() {
            if (isControlEditMode) {
                // 收集所有设置数据（这里可以添加实际的保存逻辑）
                const settings = {
                    mode: document.querySelector('input[name="mode"]:checked').value,
                    manualMode: currentManualMode,
                    // 可以继续添加其他设置项的收集
                };

                console.log('保存的设置:', settings);

                // 如果是手动模式且有选择，应用手动模式运行状态
                if (settings.mode === 'manual' && currentManualMode) {
                    applyManualModeSettings(currentManualMode);
                }

                toggleControlEdit(); // 退出编辑模式
                showToast('控制设置已成功保存！');
            }
        }
        
        // 应用手动模式设置，显示运行状态
        function applyManualModeSettings(mode) {
            const manualStatus = document.getElementById('manualStatus');
            const statusContent = document.getElementById('statusContent');
            const manualButtons = document.getElementById('manualButtons');
            
            // 隐藏按钮区域，显示状态
            manualButtons.style.display = 'none';
            manualStatus.style.display = 'block';
            
            if (mode === 'charge') {
                statusContent.innerHTML = `
                    <i class="fas fa-battery-three-quarters" style="color: #3b82f6; font-size: 20px;"></i>
                    <div style="text-align: left;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">充电中</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">充电功率: 250kW</div>
                    </div>
                    <button onclick="stopManualMode()" style="padding: 8px 16px; background: #ef4444; color: white; 
                            border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; 
                            margin-left: auto;">
                        <i class="fas fa-stop" style="margin-right: 6px;"></i>停止
                    </button>
                `;
            } else if (mode === 'discharge') {
                statusContent.innerHTML = `
                    <i class="fas fa-bolt" style="color: #f59e0b; font-size: 20px;"></i>
                    <div style="text-align: left;">
                        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">放电中</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">放电功率: 250kW</div>
                    </div>
                    <button onclick="stopManualMode()" style="padding: 8px 16px; background: #ef4444; color: white; 
                            border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; 
                            margin-left: auto;">
                        <i class="fas fa-stop" style="margin-right: 6px;"></i>停止
                    </button>
                `;
            }
        }
        
        // 重置控制设置
        function resetControlSettings() {
            // 重置时间轴为默认值
            if (window.timeSlots) {
                // 重置为默认值
                for (let i = 0; i < 24; i++) {
                    if ((i >= 10 && i <= 14)) {
                        window.timeSlots[i] = 1; // 峰值
                    } else if (i === 23 || (i >= 0 && i <= 6)) {
                        window.timeSlots[i] = 2; // 谷值
                    } else {
                        window.timeSlots[i] = 0; // 平价
                    }
                }
                // 重新渲染时间轴
                initTimeline();
            }
            
            // 重置所有输入框为默认值
            document.getElementById('controlPanel').querySelectorAll('input[type="number"]').forEach(input => {
                // 根据不同输入框设置默认值
                if (input.value) {
                    const currentValue = input.value;
                    input.value = input.defaultValue || currentValue;
                }
            });
            
            // 重置所有下拉框为第一个选项
            document.getElementById('controlPanel').querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            showToast('设置已重置！', '#ef4444');
        }
        
        // 显示提示消息
        function showToast(message, color = '#10b981') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color};
                color: white;
                padding: 12px 24px;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                z-index: 2000;
                font-size: 14px;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 等待 translations 对象加载完成
            function initPage() {
                // 检查 translations 对象是否存在
                if (typeof translations === 'undefined') {
                    console.warn('翻译对象未加载，等待 100ms 后重试...');
                    setTimeout(initPage, 100);
                    return;
                }

                // init3DScene(); // 3D模型已删除
                startRealtimeUpdates();

                // 初始化显示整机数据
                updateComponentData('overall');

                // 初始化页面翻译
                if (typeof translatePage === 'function') {
                    translatePage();
                }

                // 更新储能柜名称
                updateCabinetName();
            }

            // 启动初始化
            initPage();
        });

        // 监听语言切换事件
        window.addEventListener('languageChanged', function() {
            // 重新翻译页面
            if (typeof translatePage === 'function') {
                translatePage();
            }

            // 重新更新储能柜名称
            updateCabinetName();
        });
        
        // 页面卸载时清理
        window.addEventListener('beforeunload', function() {
            stopRealtimeUpdates();
        });
    </script>

    <!-- 统一导航栏组件 -->
    <script src="navbar.js"></script>
</body>
</html>