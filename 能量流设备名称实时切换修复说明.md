# 能量流设备名称实时切换修复说明

## 修复概述

修复能量流编辑页面在切换语言时，画布上已放置设备的名称和设置面板内容能够实时更新的问题。

## 问题描述

### 之前的问题

在英文环境下，能量流编辑页面存在以下问题：

1. **画布设备名称显示中文** ❌
   - 放置在画布上的设备（市电、光伏、储能柜）显示中文名称
   - 即使切换到英文环境，设备名称仍然是中文

2. **语言切换不生效** ❌
   - 用户切换语言后，已放置的设备名称不会更新
   - 设置面板打开时，内容也不会实时更新

### 根本原因

1. **设备属性固化问题：**
   - 设备添加到画布时，使用扩展运算符 `...draggedDeviceData` 复制所有属性
   - `label` 属性通过 getter 函数获取，此时获取到的是中文字符串
   - 这个中文字符串被固化到 `device.label` 中
   - 后续渲染直接使用 `device.label`，导致无法响应语言切换

2. **语言切换事件处理不完整：**
   - 之前的 `languageChanged` 事件监听器只更新了页面标题和语言属性
   - 没有触发设备重新渲染
   - 没有更新打开的设置面板

## 修复方案

### 方案一：动态获取设备标签（已实施）

修改渲染逻辑，优先使用 `labelKey` 动态获取翻译，而不是直接使用固化的 `label`。

### 方案二：响应语言切换事件（本次修复）

在语言切换时，重新渲染画布设备和更新设置面板。

## 修复内容

### 1. 之前已完成的修复（前置工作）

#### 1.1 修改设备渲染逻辑 (energy-flow.html 第 2231-2233 行)

**修改前：**
```javascript
<img src="${device.icon}" alt="${device.label}" />
<div class="flow-device-label">${device.label}</div>
```

**修改后：**
```javascript
<img src="${device.icon}" alt="${device.labelKey ? getDeviceLabel(device.labelKey) : device.label}" />
<div class="flow-device-label">${device.labelKey ? getDeviceLabel(device.labelKey) : device.label}</div>
```

**说明：**
- 优先检查 `labelKey` 是否存在
- 如果存在，调用 `getDeviceLabel()` 动态获取当前语言的翻译
- 如果不存在，回退使用固化的 `label` 属性

#### 1.2 修改设置面板标题 (energy-flow.html 第 1434-1435 行)

**修改前：**
```javascript
titleEl.textContent = `${device.label} - ${t('energyFlowDeviceSettings')}`;
```

**修改后：**
```javascript
const deviceLabel = device.labelKey ? getDeviceLabel(device.labelKey) : device.label;
titleEl.textContent = `${deviceLabel} - ${t('energyFlowDeviceSettings')}`;
```

#### 1.3 修改设备名称输入框 (energy-flow.html 第 1459 行)

**修改前：**
```javascript
<input type="text" value="${device.label}"
```

**修改后：**
```javascript
<input type="text" value="${device.labelKey ? getDeviceLabel(device.labelKey) : device.label}"
```

### 2. 本次新增修复

#### 2.1 增强语言切换事件监听器 (energy-flow.html 第 3944-3955 行)

**文件：** `energy-flow.html`

**修改前：**
```javascript
// 监听语言切换事件
window.addEventListener('languageChanged', function() {
    document.title = getTranslation('energyFlowPageTitle') || 'Energy Flow Settings';
    document.documentElement.lang = (localStorage.getItem('language') || 'en') === 'zh' ? 'zh-CN' : 'en-US';
});
```

**修改后：**
```javascript
// 监听语言切换事件
window.addEventListener('languageChanged', function() {
    document.title = getTranslation('energyFlowPageTitle') || 'Energy Flow Settings';
    document.documentElement.lang = (localStorage.getItem('language') || 'en') === 'zh' ? 'zh-CN' : 'en-US';

    // 重新渲染已放置的设备,更新设备名称显示
    renderPlacedDevices();

    // 如果设置面板打开,也需要更新设置面板的内容
    if (selectedDevice) {
        showDeviceSettings(selectedDevice);
    }
});
```

**说明：**
1. **重新渲染设备：** 调用 `renderPlacedDevices()` 更新画布上所有设备的显示
2. **更新设置面板：** 如果有设备正在编辑，重新显示设置面板以更新翻译文本

## 工作原理

### 完整的语言切换流程

```
用户点击语言切换器
    ↓
触发 languageChanged 事件
    ↓
事件监听器执行：
    1. 更新页面标题 (document.title)
    2. 更新 HTML lang 属性
    3. 调用 renderPlacedDevices() ← 新增
    4. 如果有设备选中，调用 showDeviceSettings() ← 新增
    ↓
renderPlacedDevices() 执行：
    遍历 placedDevices 数组
    对每个设备：
        检查 device.labelKey 是否存在
            存在 → 调用 getDeviceLabel(labelKey) 获取当前语言翻译
            不存在 → 使用 device.label
    ↓
设备名称显示更新为当前语言
```

### 动态标签获取机制

```javascript
// getDeviceLabel 函数逻辑
function getDeviceLabel(labelKey) {
    return t(labelKey);  // t() 函数根据当前语言返回对应翻译
}

// labelKey 对应的翻译键：
'energyFlowDeviceNameGrid'    → '市电' (中文) / 'Grid' (英文)
'energyFlowDeviceNameSolar'   → '光伏' (中文) / 'Solar' (英文)
'energyFlowDeviceNamePCS'     → '储能柜' (中文) / 'PCS' (英文)
'energyFlowDeviceNameLoad'    → '负载' (中文) / 'Load' (英文)
```

## 效果对比

### 修改前

**中文环境：**
- 设备名称：市电、光伏、储能柜 ✅
- 切换到英文：设备名称仍显示 市电、光伏、储能柜 ❌
- 设置面板：标题和输入框显示中文 ❌

**英文环境（首次加载）：**
- 设备名称：市电、光伏、储能柜 ❌（应显示英文）
- 设置面板：部分文本显示中文 ❌

### 修改后

**中文环境：**
- 设备名称：市电、光伏、储能柜 ✅
- 切换到英文：设备名称立即更新为 Grid、Solar、PCS ✅
- 设置面板：标题和所有文本立即更新为英文 ✅

**英文环境（首次加载）：**
- 设备名称：Grid、Solar、PCS、Load ✅
- 设置面板：所有文本显示英文 ✅
- 切换到中文：设备名称立即更新为中文 ✅

## 关键技术点

### 1. labelKey vs label

- **labelKey:** 翻译键，存储如 `'energyFlowDeviceNameGrid'` 的字符串
- **label:** 固化的显示文本，创建设备时获取的值
- **优先级:** 优先使用 `labelKey` 动态获取，确保响应语言切换

### 2. 事件驱动更新

利用 `languageChanged` 自定义事件实现：
- 解耦语言切换逻辑和 UI 更新逻辑
- 各个页面独立监听和响应
- 支持多处同时更新

### 3. 条件渲染

```javascript
device.labelKey ? getDeviceLabel(device.labelKey) : device.label
```

- 使用三元运算符实现优雅的回退机制
- 兼容旧数据（没有 `labelKey` 的设备）
- 确保任何情况下都有可显示的文本

### 4. 设置面板同步

```javascript
if (selectedDevice) {
    showDeviceSettings(selectedDevice);
}
```

- 检查是否有设备正在编辑
- 重新打开设置面板，自动应用新语言
- 保持用户当前的操作状态

## 测试建议

### 1. 首次加载测试

**中文环境：**
1. 清除 localStorage 中的语言设置
2. 设置语言为中文
3. 打开能量流编辑页面
4. 拖拽设备到画布
5. ✅ 验证设备名称显示中文：市电、光伏、储能柜

**英文环境：**
1. 清除 localStorage 中的语言设置
2. 设置语言为英文（或依赖默认值 'en'）
3. 打开能量流编辑页面
4. 拖拽设备到画布
5. ✅ 验证设备名称显示英文：Grid、Solar、PCS

### 2. 语言切换测试（画布设备）

1. 在中文环境下，拖拽多个设备到画布
2. ✅ 验证设备名称显示中文
3. 点击语言切换器，切换到英文
4. ✅ 验证画布上所有设备名称立即更新为英文
5. 再次切换回中文
6. ✅ 验证设备名称立即恢复为中文

### 3. 设置面板测试

1. 在中文环境下，放置一个设备
2. 点击设备，打开设置面板
3. ✅ 验证面板标题显示：`市电 - 设备设置`
4. ✅ 验证所有标签和输入框显示中文
5. **不关闭面板**，切换到英文
6. ✅ 验证面板标题立即更新为：`Grid - Device Settings`
7. ✅ 验证所有标签和输入框立即更新为英文
8. ✅ 验证设备名称输入框的值也更新为 `Grid`

### 4. 多设备混合测试

1. 放置以下设备：
   - 市电 (Grid)
   - 光伏 (Solar)
   - 储能柜 (PCS)
   - 负载 (Load)
2. 在中文环境下验证所有名称正确
3. 切换到英文
4. ✅ 验证所有 4 个设备的名称同时更新
5. 点击任意设备打开设置面板
6. ✅ 验证设置面板使用英文显示
7. 不关闭面板，切换回中文
8. ✅ 验证面板和设备名称都恢复为中文

### 5. 持久化测试

1. 在英文环境下创建能量流配置
2. 保存配置
3. 刷新页面
4. 加载配置
5. ✅ 验证设备名称仍然正确显示英文
6. 切换到中文
7. ✅ 验证设备名称更新为中文

### 6. 边界情况测试

**测试空画布：**
1. 不放置任何设备
2. 切换语言
3. ✅ 验证不会报错

**测试旧数据：**
1. 模拟没有 `labelKey` 的旧设备数据
2. ✅ 验证回退到 `label` 属性，正常显示
3. ✅ 验证不会因为缺少 `labelKey` 而报错

**测试快速切换：**
1. 快速连续切换语言（中→英→中→英）
2. ✅ 验证每次切换都能正确更新
3. ✅ 验证不会出现渲染错乱

## 涉及文件清单

| 文件 | 修改内容 | 行号 |
|------|---------|------|
| `energy-flow.html` | 修改设备图标 alt 文本为动态获取 | 2231 |
| `energy-flow.html` | 修改设备标签为动态获取 | 2233 |
| `energy-flow.html` | 修改设置面板标题为动态获取 | 1434-1435 |
| `energy-flow.html` | 修改设备名称输入框值为动态获取 | 1459 |
| `energy-flow.html` | 增强语言切换事件监听器 | 3944-3955 |

## 相关翻译键

以下翻译键在 `common.js` 中已定义：

### 中文翻译 (common.js 第 3783-3793 行)

```javascript
energyFlowDeviceNameGrid: '市电',
energyFlowDeviceNameSolar: '光伏',
energyFlowDeviceNamePCS: '储能柜',
energyFlowDeviceNameLoad: '负载',
energyFlowDeviceNameGenerator: '柴发',
energyFlowDeviceSettings: '设备设置',
energyFlowRatedPower: '额定功率 (KW)',
energyFlowVoltageLevel: '电压等级',
energyFlowCapacity: '容量 (KWh)',
energyFlowLoadType: '负载类型',
energyFlowLoadTypeConstant: '恒定负载',
```

### 英文翻译 (common.js 第 7532-7541 行)

```javascript
energyFlowDeviceNameGrid: 'Grid',
energyFlowDeviceNameSolar: 'Solar',
energyFlowDeviceNamePCS: 'PCS',
energyFlowDeviceNameLoad: 'Load',
energyFlowDeviceNameGenerator: 'Generator',
energyFlowDeviceSettings: 'Device Settings',
energyFlowRatedPower: 'Rated Power (KW)',
energyFlowVoltageLevel: 'Voltage Level',
energyFlowCapacity: 'Capacity (KWh)',
energyFlowLoadType: 'Load Type',
energyFlowLoadTypeConstant: 'Constant Load',
```

## 最佳实践

### 1. 优先使用翻译键

**好的做法：** ✅
```javascript
${device.labelKey ? getDeviceLabel(device.labelKey) : device.label}
```

**不好的做法：** ❌
```javascript
${device.label}  // 直接使用固化的值
```

### 2. 提供回退机制

**好的做法：** ✅
```javascript
device.labelKey ? getDeviceLabel(device.labelKey) : device.label
```

**说明：** 使用三元运算符确保总是有可显示的值

### 3. 完整的语言切换处理

**好的做法：** ✅
```javascript
window.addEventListener('languageChanged', function() {
    // 1. 更新页面元数据
    document.title = getTranslation('pageTitleKey');
    document.documentElement.lang = getCurrentLang();

    // 2. 重新渲染动态内容
    renderPlacedDevices();

    // 3. 更新打开的面板
    if (selectedDevice) {
        showDeviceSettings(selectedDevice);
    }
});
```

**不完整的做法：** ❌
```javascript
window.addEventListener('languageChanged', function() {
    document.title = getTranslation('pageTitleKey');
    // 遗漏了重新渲染和更新面板
});
```

### 4. 事件驱动架构

- 使用自定义事件 `languageChanged` 解耦代码
- 各个组件独立监听和响应
- 便于维护和扩展

## 注意事项

⚠️ **重要提醒：**

### 1. 性能考虑

- `renderPlacedDevices()` 会重新渲染所有设备
- 对于大量设备的场景，考虑使用虚拟 DOM 或增量更新
- 当前实现适用于中小规模设备数量（< 50 个）

### 2. 数据兼容性

- 新代码向后兼容没有 `labelKey` 的旧设备数据
- 使用三元运算符提供回退机制
- 不会因为缺少 `labelKey` 而导致显示错误

### 3. 设置面板状态

- 重新打开设置面板会重置滚动位置
- 如果用户正在输入，语言切换可能导致输入焦点丢失
- 建议在用户不操作时切换语言，或在切换后恢复焦点

### 4. 翻译键管理

- 确保 `common.js` 中所有翻译键都已定义
- 保持中英文翻译键名称一致
- 使用有意义的命名规范（如 `energyFlowDeviceNameXxx`）

### 5. 事件监听器清理

- 当前实现在页面生命周期内持续监听
- 如果页面需要动态卸载，考虑添加事件监听器清理逻辑

## 扩展建议

### 1. 添加过渡动画

为语言切换添加平滑过渡效果：

```javascript
window.addEventListener('languageChanged', function() {
    // 添加淡出动画
    canvas.style.opacity = '0';

    setTimeout(() => {
        renderPlacedDevices();

        // 添加淡入动画
        canvas.style.opacity = '1';
    }, 200);
});
```

### 2. 保存焦点状态

在语言切换时保存和恢复输入框焦点：

```javascript
let activeElement = document.activeElement;
renderPlacedDevices();
if (activeElement) {
    activeElement.focus();
}
```

### 3. 优化大量设备场景

使用增量更新而非全量重新渲染：

```javascript
function updateDeviceLabels() {
    document.querySelectorAll('.flow-device-label').forEach((label, index) => {
        const device = placedDevices[index];
        if (device && device.labelKey) {
            label.textContent = getDeviceLabel(device.labelKey);
        }
    });
}
```

## 问题排查

### 设备名称没有更新？

**检查清单：**
1. ✅ 确认 `labelKey` 属性已正确设置
2. ✅ 确认 `getDeviceLabel()` 函数存在且工作正常
3. ✅ 确认 `renderPlacedDevices()` 在语言切换时被调用
4. ✅ 打开浏览器控制台检查是否有 JavaScript 错误

### 设置面板没有更新？

**检查清单：**
1. ✅ 确认 `selectedDevice` 变量正确维护
2. ✅ 确认 `showDeviceSettings()` 在语言切换时被调用
3. ✅ 确认设置面板的所有标签都使用 `t()` 函数

### 翻译显示为键名？

**原因：** 翻译键在 `common.js` 中未定义

**解决方案：**
1. 检查 `common.js` 中是否有对应的翻译键
2. 确认翻译键名称拼写正确
3. 确认中文和英文翻译都已定义

## 日期

修复日期: 2026-01-14

## 相关文档

- [浏览器标签页标题国际化修复说明.md](./浏览器标签页标题国际化修复说明.md)
- [登录页面默认语言设置修复说明.md](./登录页面默认语言设置修复说明.md)
- [首页默认语言设置修复说明.md](./首页默认语言设置修复说明.md)
- [能量流编辑页面国际化修复说明.md](./能量流编辑页面国际化修复说明.md)
