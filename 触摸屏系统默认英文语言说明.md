# 触摸屏系统默认英文语言说明

## 修复日期
2026-01-15

## 需求说明

触摸屏系统应该**默认显示英文**，用户需要手动切换到中文后才显示中文界面。

### 预期行为
1. **首次访问** → 显示英文界面
2. **用户点击语言切换** → 切换到中文
3. **关闭浏览器后再次打开** → 保持中文（记住用户选择）
4. **清除缓存后访问** → 恢复为英文（默认语言）

## 当前配置

### 默认语言设置

在 [touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js) 的第1264行：

```javascript
function getTouchscreenLang() {
    return localStorage.getItem('touchscreen_language') || 'en';  // ✅ 默认英文
}
```

**确认**：默认语言已设置为英文 `'en'`

## 为什么页面还显示中文？

如果您看到页面显示中文，可能是因为以下原因之一：

### 原因1: localStorage 中保存了中文设置

浏览器的 localStorage 中可能已经保存了之前的语言设置：

```javascript
localStorage.getItem('touchscreen_language')  // 可能返回 'zh'
```

**解决方法**：清除 localStorage 或浏览器缓存

### 原因2: 之前打开的页面未刷新

如果页面在修改代码之前就已经打开，修改不会立即生效。

**解决方法**：刷新页面（F5 或 Ctrl+R）

### 原因3: 浏览器缓存了旧的 JS 文件

浏览器可能缓存了旧版本的 `touchscreen-i18n.js` 文件。

**解决方法**：强制刷新（Ctrl+Shift+R 或 Ctrl+F5）

## 如何测试默认语言

### 测试步骤1: 清除 localStorage

**方法A：使用浏览器开发者工具**
1. 按 F12 打开开发者工具
2. 进入 "Application" 或 "应用" 标签页
3. 左侧找到 "Local Storage"
4. 选择当前网站
5. 找到 `touchscreen_language` 键
6. 右键删除，或点击 "Clear All"

**方法B：使用控制台命令**
1. 按 F12 打开开发者工具
2. 进入 "Console" 或 "控制台" 标签页
3. 输入并执行：
```javascript
localStorage.removeItem('touchscreen_language');
location.reload();
```

**方法C：清除浏览器所有数据**
1. 浏览器设置 → 清除浏览数据
2. 选择 "Cookie 和其他网站数据"
3. 点击 "清除数据"

### 测试步骤2: 刷新页面

清除 localStorage 后，刷新页面：
- 按 F5 或 Ctrl+R（普通刷新）
- 或按 Ctrl+Shift+R（强制刷新，清除缓存）

### 测试步骤3: 验证显示

**预期结果**：
- ✅ Logo: "Energy Storage System"
- ✅ 导航菜单: "Home, Data, History, Control, Alarm, Log, Settings"
- ✅ 所有文本: 英文

## 验证代码是否生效

### 方法1: 检查 localStorage

在浏览器控制台输入：

```javascript
localStorage.getItem('touchscreen_language')
```

**预期结果**：
- 首次访问（清除缓存后）：`null`
- 切换到中文后：`"zh"`
- 切换到英文后：`"en"`

### 方法2: 检查当前语言

在浏览器控制台输入：

```javascript
getTouchscreenLang()
```

**预期结果**：
- 首次访问（清除缓存后）：`"en"`
- 切换到中文后：`"zh"`

### 方法3: 检查 HTML lang 属性

在浏览器控制台输入：

```javascript
document.documentElement.lang
```

**预期结果**：
- 英文环境：`"en"`
- 中文环境：`"zh-CN"`

## 完整测试流程

### 测试1: 默认英文验证

```
1. 清除 localStorage
   localStorage.removeItem('touchscreen_language');

2. 刷新页面
   location.reload();

3. 检查语言
   getTouchscreenLang()  // 应返回 "en"

4. 验证显示
   页面应显示英文 ✅
```

### 测试2: 切换到中文

```
1. 点击语言切换按钮
2. 选择 "中文" 或 "🇨🇳"
3. 验证显示
   页面应显示中文 ✅

4. 检查存储
   localStorage.getItem('touchscreen_language')  // 应返回 "zh"
```

### 测试3: 刷新后保持中文

```
1. （中文状态下）刷新页面
   location.reload();

2. 验证显示
   页面应继续显示中文 ✅

3. 检查语言
   getTouchscreenLang()  // 应返回 "zh"
```

### 测试4: 切换回英文

```
1. 点击语言切换按钮
2. 选择 "English" 或 "🇺🇸"
3. 验证显示
   页面应显示英文 ✅

4. 检查存储
   localStorage.getItem('touchscreen_language')  // 应返回 "en"
```

### 测试5: 清除缓存后恢复默认

```
1. 清除 localStorage
   localStorage.clear();

2. 刷新页面
   location.reload();

3. 验证显示
   页面应显示英文（默认语言）✅
```

## 国际化工作原理

### 默认语言逻辑

```javascript
function getTouchscreenLang() {
    // 1. 优先使用用户设置
    const saved = localStorage.getItem('touchscreen_language');
    if (saved) {
        return saved;  // 'zh' 或 'en'
    }

    // 2. 如果没有保存，返回默认值
    return 'en';  // ✅ 默认英文
}
```

### 页面加载流程

```javascript
// 1. 页面加载完成
document.addEventListener('DOMContentLoaded', function() {
    // 2. 获取当前语言
    const currentLang = getTouchscreenLang();
    // 首次访问：currentLang = 'en'

    // 3. 判断是否需要翻译
    if (currentLang === 'zh') {
        // 只有中文时才翻译
        applyTouchscreenTranslations();
    }
    // 英文环境：不翻译，保持 HTML 默认文本（英文）
});
```

### 语言切换流程

```javascript
// 1. 用户点击语言切换按钮
function changeLanguage(lang) {
    // 2. 保存到 localStorage
    localStorage.setItem('touchscreen_language', lang);

    // 3. 应用翻译
    applyTouchscreenTranslations();

    // 4. 触发事件通知其他组件
    window.dispatchEvent(new CustomEvent('languageChanged', {
        detail: { lang }
    }));
}
```

## 常见问题解答

### Q1: 为什么清除缓存后还是显示中文？

**可能原因**：
- localStorage 未清除干净
- 浏览器缓存了旧的 JS 文件

**解决方法**：
1. 使用隐私/无痕模式打开页面
2. 或使用 Ctrl+Shift+Delete 完全清除浏览数据

### Q2: 为什么切换语言后没反应？

**可能原因**：
- JavaScript 文件未加载
- 翻译键缺失
- 控制台有报错

**解决方法**：
1. 按 F12 打开开发者工具
2. 查看 Console 是否有错误
3. 检查 Network 标签页，确认 touchscreen-i18n.js 已加载

### Q3: 如何修改默认语言？

**修改位置**：[touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js:1264)

```javascript
// 默认英文
function getTouchscreenLang() {
    return localStorage.getItem('touchscreen_language') || 'en';
}

// 改为默认中文
function getTouchscreenLang() {
    return localStorage.getItem('touchscreen_language') || 'zh';
}
```

### Q4: 能否根据浏览器语言自动判断？

**可以**，修改为：

```javascript
function getTouchscreenLang() {
    const saved = localStorage.getItem('touchscreen_language');
    if (saved) return saved;

    // 根据浏览器语言自动判断
    const browserLang = navigator.language || navigator.userLanguage;
    return browserLang.startsWith('zh') ? 'zh' : 'en';
}
```

## 测试清单

请按照以下清单逐项测试：

- [ ] 清除 localStorage
- [ ] 刷新页面（Ctrl+Shift+R 强制刷新）
- [ ] 验证首页显示英文
- [ ] 点击各个菜单，验证都是英文
- [ ] 点击语言切换按钮，切换到中文
- [ ] 验证页面显示中文
- [ ] 刷新页面，验证保持中文
- [ ] 切换回英文
- [ ] 验证页面显示英文
- [ ] 清除 localStorage
- [ ] 刷新页面，验证恢复为英文（默认）

## 相关文件

- [touchscreen/touchscreen-i18n.js](touchscreen/touchscreen-i18n.js:1264) - 默认语言配置
- [touchscreen/home.html](touchscreen/home.html) - 首页
- [touchscreen/login.html](touchscreen/login.html) - 登录页

## 技术细节

### localStorage 优先级

```
用户设置（localStorage）> 默认值（代码中定义）
```

### 为什么需要清除 localStorage？

因为之前可能已经保存了语言设置：

```javascript
// 之前的操作可能保存了中文
localStorage.setItem('touchscreen_language', 'zh');

// 现在获取语言
getTouchscreenLang()  // 返回 'zh'（用户设置）
// 不会使用默认值 'en'
```

### 如何强制使用默认语言（仅测试用）

**临时禁用 localStorage**：

```javascript
// 方法1：清除特定键
localStorage.removeItem('touchscreen_language');

// 方法2：清除所有键
localStorage.clear();

// 方法3：临时修改函数（仅测试）
function getTouchscreenLang() {
    return 'en';  // 强制返回英文
}
```

## 总结

### 当前配置
- ✅ 默认语言：英文 `'en'`
- ✅ 配置位置：touchscreen-i18n.js 第1264行
- ✅ 配置正确

### 如何验证生效
1. **清除 localStorage**（重要！）
2. **强制刷新页面**（Ctrl+Shift+R）
3. **验证显示英文**

### 为什么可能看到中文
- localStorage 中保存了之前的中文设置
- 浏览器缓存了旧的 JS 文件
- 页面未刷新

### 解决方法
```javascript
// 在浏览器控制台执行
localStorage.removeItem('touchscreen_language');
location.reload(true);  // 强制刷新
```

执行后，页面应该显示英文界面。✅
