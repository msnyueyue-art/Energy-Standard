# 能量流编辑页面国际化修复说明

## 修复概述

修复能量流编辑页面 (`energy-flow.html`) 的国际化问题，确保在英文环境下设备设置面板的所有文本都正确显示为英文。

## 问题描述

在英文环境下打开能量流编辑页面，点击设备进入设备设置面板时：
- **设备名称输入框:** 显示中文设备名（如 "市电"、"光伏"、"储能柜"） ❌
- **设置项标签:** 显示中文（如 "额定功率"、"电压等级"、"容量"） ❌
- **下拉选项:** 显示中文（如 "恒定负载"、"可调负载"） ❌
- **页面标题:** 显示中文 "能量流设置" ❌

## 问题原因

1. **设备类型判断错误:** 代码中使用硬编码的中文字符串（如 `'市电'`, `'光伏'`, `'储能柜'`）来判断设备类型，但实际设备的 `type` 属性是英文（如 `'grid'`, `'solar'`, `'pcs'`）

2. **硬编码的中文标签:** 设置面板HTML中包含硬编码的中文文本，没有使用国际化函数

3. **负载类型值使用中文:** 负载类型的 option value 使用中文字符串

4. **页面初始语言设置:** HTML lang 属性和 title 标签使用中文

## 修复方案

1. 修正设备类型判断，使用英文类型标识符
2. 使用 `t()` 翻译函数替换所有硬编码文本
3. 修改负载类型值为英文标识符
4. 更新页面初始语言设置
5. 添加缺失的翻译键

## 修复内容

### 1. 修正设备类型判断

**文件:** `energy-flow.html`

#### showDeviceSettings 函数 (第 1538 行)

**修改前:**
```javascript
if (device.type === '市电' || device.type === '柴发' || device.type === '光伏') {
    // ...
} else if (device.type === '储能柜') {
    // ...
} else if (device.type === '负载') {
    // ...
}
```

**修改后:**
```javascript
if (device.type === 'grid' || device.type === 'generator' || device.type === 'solar') {
    // ...
} else if (device.type === 'pcs') {
    // ...
} else if (device.type === 'load') {
    // ...
}
```

#### saveDeviceSettings 函数 (第 1621 行)

同样的修改，确保保存设备设置时使用正确的设备类型判断。

### 2. 国际化设置面板标签

**文件:** `energy-flow.html` (第 1540-1582 行)

#### 电源设备设置

**修改前:**
```javascript
settingsHTML += `
    <div class="settings-item">
        <label class="settings-item-label">额定功率 (KW)</label>
        <input type="number" class="settings-item-input" id="devicePower" value="${device.power || 500}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">电压等级</label>
        <select class="settings-item-select" id="deviceVoltage">
            <option value="380V">380V</option>
            <option value="220V">220V</option>
            <option value="10KV">10KV</option>
        </select>
    </div>
`;
```

**修改后:**
```javascript
settingsHTML += `
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowRatedPower')}</label>
        <input type="number" class="settings-item-input" id="devicePower" value="${device.power || 500}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowVoltageLevel')}</label>
        <select class="settings-item-select" id="deviceVoltage">
            <option value="380V">380V</option>
            <option value="220V">220V</option>
            <option value="10KV">10KV</option>
        </select>
    </div>
`;
```

#### 储能设备设置

**修改前:**
```javascript
settingsHTML += `
    <div class="settings-item">
        <label class="settings-item-label">容量 (KWh)</label>
        <input type="number" class="settings-item-input" id="deviceCapacity" value="${device.capacity || 1000}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">充电功率 (KW)</label>
        <input type="number" class="settings-item-input" id="deviceChargePower" value="${device.chargePower || 500}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">放电功率 (KW)</label>
        <input type="number" class="settings-item-input" id="deviceDischargePower" value="${device.dischargePower || 500}" />
    </div>
`;
```

**修改后:**
```javascript
settingsHTML += `
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowCapacity')}</label>
        <input type="number" class="settings-item-input" id="deviceCapacity" value="${device.capacity || 1000}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowChargePower')}</label>
        <input type="number" class="settings-item-input" id="deviceChargePower" value="${device.chargePower || 500}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowDischargePower')}</label>
        <input type="number" class="settings-item-input" id="deviceDischargePower" value="${device.dischargePower || 500}" />
    </div>
`;
```

#### 负载设备设置

**修改前:**
```javascript
settingsHTML += `
    <div class="settings-item">
        <label class="settings-item-label">负载功率 (KW)</label>
        <input type="number" class="settings-item-input" id="deviceLoadPower" value="${device.loadPower || 300}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">负载类型</label>
        <select class="settings-item-select" id="deviceLoadType">
            <option value="恒定负载" ${device.loadType === '恒定负载' ? 'selected' : ''}>恒定负载</option>
            <option value="可调负载" ${device.loadType === '可调负载' ? 'selected' : ''}>可调负载</option>
            <option value="优先级负载" ${device.loadType === '优先级负载' ? 'selected' : ''}>优先级负载</option>
        </select>
    </div>
`;
```

**修改后:**
```javascript
settingsHTML += `
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowLoadPower')}</label>
        <input type="number" class="settings-item-input" id="deviceLoadPower" value="${device.loadPower || 300}" />
    </div>
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowLoadType')}</label>
        <select class="settings-item-select" id="deviceLoadType">
            <option value="constant" ${device.loadType === 'constant' ? 'selected' : ''}>${t('energyFlowLoadTypeConstant')}</option>
            <option value="adjustable" ${device.loadType === 'adjustable' ? 'selected' : ''}>${t('energyFlowLoadTypeAdjustable')}</option>
            <option value="priority" ${device.loadType === 'priority' ? 'selected' : ''}>${t('energyFlowLoadTypePriority')}</option>
        </select>
    </div>
`;
```

**重要变更:**
- option value 从中文改为英文标识符（`'constant'`, `'adjustable'`, `'priority'`）
- option 显示文本使用翻译函数

### 3. 添加翻译键到 common.js

**文件:** `common.js`

#### 中文翻译 (第 3783-3793 行)

```javascript
energyFlowRatedPower: '额定功率 (KW)',
energyFlowVoltageLevel: '电压等级',
energyFlowCapacity: '容量 (KWh)',
energyFlowChargePower: '充电功率 (KW)',
energyFlowDischargePower: '放电功率 (KW)',
energyFlowLoadPower: '负载功率 (KW)',
energyFlowLoadType: '负载类型',
energyFlowLoadTypeConstant: '恒定负载',
energyFlowLoadTypeAdjustable: '可调负载',
energyFlowLoadTypePriority: '优先级负载',
energyFlowDisplayParams: '显示参数 (多选)',
```

#### 英文翻译 (第 7532-7541 行)

```javascript
energyFlowRatedPower: 'Rated Power (KW)',
energyFlowVoltageLevel: 'Voltage Level',
energyFlowCapacity: 'Capacity (KWh)',
energyFlowChargePower: 'Charge Power (KW)',
energyFlowDischargePower: 'Discharge Power (KW)',
energyFlowLoadPower: 'Load Power (KW)',
energyFlowLoadType: 'Load Type',
energyFlowLoadTypeConstant: 'Constant Load',
energyFlowLoadTypeAdjustable: 'Adjustable Load',
energyFlowLoadTypePriority: 'Priority Load',
```

### 4. 更新页面初始语言设置

**文件:** `energy-flow.html`

#### HTML 标签 (第 1-6 行)

**修改前:**
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle" data-translate="energyFlowPageTitle">能量流设置</title>
```

**修改后:**
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle" data-translate="energyFlowPageTitle">Energy Flow Settings</title>
```

#### 添加语言切换监听 (第 3938-3946 行)

```javascript
// 更新页面标题
document.title = getTranslation('energyFlowPageTitle') || 'Energy Flow Settings';
document.documentElement.lang = (localStorage.getItem('language') || 'en') === 'zh' ? 'zh-CN' : 'en-US';

// 监听语言切换事件
window.addEventListener('languageChanged', function() {
    document.title = getTranslation('energyFlowPageTitle') || 'Energy Flow Settings';
    document.documentElement.lang = (localStorage.getItem('language') || 'en') === 'zh' ? 'zh-CN' : 'en-US';
});
```

## 设备类型对照表

| 中文（旧） | 英文类型 | 设备名称中文 | 设备名称英文 |
|-----------|---------|------------|-------------|
| '市电' | 'grid' | 市电 | Grid |
| '柴发' | 'generator' | 柴发 | Generator |
| '光伏' | 'solar' | 光伏 | Solar |
| '储能柜' | 'pcs' | 储能柜 | PCS |
| '负载' | 'load' | 负载 | Load |

## 负载类型对照表

| 中文（旧） | 英文标识符（新） | 中文显示 | 英文显示 |
|-----------|----------------|---------|----------|
| '恒定负载' | 'constant' | 恒定负载 | Constant Load |
| '可调负载' | 'adjustable' | 可调负载 | Adjustable Load |
| '优先级负载' | 'priority' | 优先级负载 | Priority Load |

## 效果对比

### 修改前（英文环境）

**设备设置面板标题:**
- 市电 - 设备设置 ❌

**设置项:**
- 额定功率 (KW) ❌
- 电压等级 ❌
- 容量 (KWh) ❌
- 充电功率 (KW) ❌
- 放电功率 (KW) ❌
- 负载功率 (KW) ❌
- 负载类型 ❌

**负载类型选项:**
- 恒定负载 ❌
- 可调负载 ❌
- 优先级负载 ❌

### 修改后（英文环境）

**设备设置面板标题:**
- Grid - Device Settings ✅

**设置项:**
- Rated Power (KW) ✅
- Voltage Level ✅
- Capacity (KWh) ✅
- Charge Power (KW) ✅
- Discharge Power (KW) ✅
- Load Power (KW) ✅
- Load Type ✅

**负载类型选项:**
- Constant Load ✅
- Adjustable Load ✅
- Priority Load ✅

## 测试建议

### 1. 英文环境测试

1. 切换到英文语言
2. 打开能量流编辑页面
3. ✅ 验证页面标题显示 "Energy Flow Settings"
4. 点击画布上的任意设备（市电、光伏、储能柜、负载）
5. ✅ 验证设备设置面板标题显示英文设备名 + "Device Settings"
6. ✅ 验证 "Device Name" 输入框显示英文设备名
7. ✅ 验证所有设置项标签显示英文
8. ✅ 验证负载类型下拉选项显示英文

### 2. 中文环境测试

1. 切换到中文语言
2. 打开能量流编辑页面
3. ✅ 验证页面标题显示 "能量流设置"
4. 点击任意设备
5. ✅ 验证设备设置面板显示中文
6. ✅ 验证所有设置项标签显示中文
7. ✅ 验证负载类型下拉选项显示中文

### 3. 语言切换测试

1. 在页面停留，不刷新
2. 切换语言（中文 ↔ 英文）
3. ✅ 验证页面标题立即更新
4. 点击设备打开设置面板
5. ✅ 验证设置面板使用新语言显示

### 4. 数据保存测试

1. 在英文环境下修改负载类型为 "Adjustable Load"
2. 保存配置
3. 刷新页面
4. ✅ 验证负载类型仍然是 "Adjustable Load"（值为 'adjustable'）
5. 切换到中文
6. ✅ 验证显示为 "可调负载"（值仍为 'adjustable'）

## 数据兼容性

**向后兼容:**
- 旧数据如果使用中文的负载类型值（如 `'恒定负载'`），需要手动迁移
- 建议添加数据迁移逻辑：
  ```javascript
  // 负载类型值迁移
  const loadTypeMap = {
      '恒定负载': 'constant',
      '可调负载': 'adjustable',
      '优先级负载': 'priority'
  };
  if (loadTypeMap[device.loadType]) {
      device.loadType = loadTypeMap[device.loadType];
  }
  ```

## 涉及文件清单

| 文件 | 修改内容 | 行号 |
|------|---------|------|
| `energy-flow.html` | 修正设备类型判断（showDeviceSettings） | 1538 |
| `energy-flow.html` | 国际化设备设置标签 | 1540-1582 |
| `energy-flow.html` | 修正设备类型判断（saveDeviceSettings） | 1621 |
| `energy-flow.html` | 更新 HTML lang 属性为 'en' | 2 |
| `energy-flow.html` | 更新页面标题为英文 | 6 |
| `energy-flow.html` | 添加语言切换监听 | 3938-3946 |
| `common.js` | 添加中文翻译键 | 3783-3793 |
| `common.js` | 添加英文翻译键 | 7532-7541 |

## 翻译键清单

| 翻译键 | 中文 | 英文 |
|--------|------|------|
| `energyFlowPageTitle` | 能量流设置 | Energy Flow Settings |
| `energyFlowDeviceSettings` | 设备设置 | Device Settings |
| `energyFlowDeviceName` | 设备名称 | Device Name |
| `energyFlowDisplayParams` | 显示参数 (多选) | Display Parameters (Multi-select) |
| `energyFlowRatedPower` | 额定功率 (KW) | Rated Power (KW) |
| `energyFlowVoltageLevel` | 电压等级 | Voltage Level |
| `energyFlowCapacity` | 容量 (KWh) | Capacity (KWh) |
| `energyFlowChargePower` | 充电功率 (KW) | Charge Power (KW) |
| `energyFlowDischargePower` | 放电功率 (KW) | Discharge Power (KW) |
| `energyFlowLoadPower` | 负载功率 (KW) | Load Power (KW) |
| `energyFlowLoadType` | 负载类型 | Load Type |
| `energyFlowLoadTypeConstant` | 恒定负载 | Constant Load |
| `energyFlowLoadTypeAdjustable` | 可调负载 | Adjustable Load |
| `energyFlowLoadTypePriority` | 优先级负载 | Priority Load |
| `energyFlowDeviceGrid` | 市电 | Grid |
| `energyFlowDeviceGenerator` | 柴发 | Generator |
| `energyFlowDeviceSolar` | 光伏 | Solar |
| `energyFlowDevicePCS` | 储能柜 | PCS |
| `energyFlowDeviceLoad` | 负载 | Load |

## 最佳实践

1. **避免硬编码:** 所有用户可见的文本都应使用翻译函数
2. **使用英文标识符:** 数据值（如设备类型、负载类型）应使用英文，显示使用翻译
3. **保持一致性:** 相同概念在整个应用中使用相同的翻译键
4. **提供回退:** 翻译函数调用应提供默认值作为回退

## 注意事项

⚠️ **重要提醒:**

1. **设备类型判断:** 确保所有判断设备类型的代码都使用英文标识符（`'grid'`, `'solar'`, `'pcs'`, `'load'`）

2. **负载类型值变更:** 负载类型的 value 从中文改为英文，可能影响已保存的配置数据

3. **向后兼容:** 旧数据中包含中文负载类型值的需要迁移

4. **ID判断兼容:** 代码中某些 `includes()` 判断保留了中文字符串（如 `includes('市电')`）是为了向后兼容旧数据，不应删除

## 日期

修复日期: 2026-01-14
