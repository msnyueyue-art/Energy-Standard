# 能量流设备名称输入框只读修复说明

## 修复概述

将能量流编辑页面设备设置面板中的"Device Name"输入框改为只读状态，确保设备名称根据当前语言自动显示，不会被用户手动编辑破坏。

## 问题描述

### 截图反馈的问题

用户截图显示，在英文环境下：
- **设备名称标题：** 显示 "市电" ❌（应该显示 "Grid"）
- **Device Name 输入框：** 显示 "市电" ❌（应该显示 "Grid"）
- **侧边栏设备图标：** 显示 "光伏"、"储能柜" ❌（应该显示 "Solar"、"PCS"）

### 根本原因

虽然之前已经实现了动态翻译机制（使用 `labelKey` 获取翻译），但是：

1. **输入框允许编辑** ⚠️
   - 设备名称输入框是可编辑的（有 `oninput` 事件）
   - 用户可以手动修改设备名称
   - 一旦用户修改，会直接覆盖 `device.label` 属性
   - 破坏了基于 `labelKey` 的翻译机制

2. **设计冲突** ⚠️
   - 需求1：设备名称应根据语言自动切换（Grid ↔ 市电）
   - 需求2：允许用户自定义设备名称
   - 这两个需求是互相冲突的

### 设计决策

根据用户需求"英文环境下默认显示Grid，中文环境下默认显示市电"，应该：

✅ **采用方案：设备名称自动翻译，不允许用户编辑**

理由：
- 系统预定义了设备类型（市电/Grid、光伏/Solar、储能柜/PCS、负载/Load）
- 这些是标准的能源系统术语，不应该随意修改
- 保持设备名称的一致性和专业性
- 支持完整的国际化体验

## 修复方案

将设备名称输入框改为**只读（readonly）**状态，同时：
- 保留输入框的外观（便于用户看到当前设备名称）
- 禁止用户编辑（保护翻译机制）
- 添加视觉提示（灰色背景，默认光标）

## 修复内容

### 修改设备名称输入框属性

**文件：** `energy-flow.html` (第 1457-1462 行)

**修改前：**
```javascript
let settingsHTML = `
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowDeviceName')}</label>
        <input type="text" class="settings-item-input" id="deviceName" value="${device.labelKey ? getDeviceLabel(device.labelKey) : device.label}"
               oninput="updateDeviceProperty('${deviceId}', 'label', this.value)" />
    </div>
```

**修改后：**
```javascript
let settingsHTML = `
    <div class="settings-item">
        <label class="settings-item-label">${t('energyFlowDeviceName')}</label>
        <input type="text" class="settings-item-input" id="deviceName" value="${device.labelKey ? getDeviceLabel(device.labelKey) : device.label}"
               readonly style="background-color: #f5f5f5; cursor: default;" />
    </div>
```

**关键变更：**

1. **添加 `readonly` 属性**
   - 使输入框变为只读
   - 用户无法编辑内容
   - 可以选中和复制文本，但不能修改

2. **移除 `oninput` 事件**
   - 删除了 `oninput="updateDeviceProperty('${deviceId}', 'label', this.value)"`
   - 不再响应用户输入

3. **添加内联样式**
   - `background-color: #f5f5f5;` - 浅灰色背景，视觉上表明不可编辑
   - `cursor: default;` - 鼠标悬停时显示默认光标（而不是输入光标）

## 效果对比

### 修改前

**中文环境：**
- 设备名称输入框显示：`市电` ✅
- 用户可以编辑：✅（但不应该允许）
- 手动修改后：破坏翻译机制 ❌

**英文环境：**
- 设备名称输入框显示：`Grid` ✅（如果翻译正确的话）
- 用户可以编辑：✅（但不应该允许）
- 切换语言：如果用户修改过，无法自动切换 ❌

**问题：**
- 用户可以手动修改设备名称，破坏国际化机制 ❌
- 一旦修改，语言切换将失效 ❌

### 修改后

**中文环境：**
- 设备名称输入框显示：`市电` ✅
- 输入框状态：只读（灰色背景）✅
- 用户无法编辑：✅
- 语言切换正常：✅

**英文环境：**
- 设备名称输入框显示：`Grid` ✅
- 输入框状态：只读（灰色背景）✅
- 用户无法编辑：✅
- 切换到中文：立即显示 `市电` ✅

**优势：**
- 设备名称完全由系统控制，保证国际化正确性 ✅
- 用户无法破坏翻译机制 ✅
- 视觉上清晰表明字段不可编辑 ✅
- 语言切换时自动更新 ✅

## 技术细节

### readonly vs disabled 的区别

| 属性 | readonly | disabled |
|------|----------|----------|
| 外观 | 正常输入框外观 | 灰色且模糊 |
| 可选中文本 | ✅ 可以 | ❌ 不可以 |
| 可复制文本 | ✅ 可以 | ❌ 不可以 |
| 提交表单时 | ✅ 包含在表单数据中 | ❌ 不包含 |
| Tab键导航 | ✅ 可以获得焦点 | ❌ 跳过 |
| 用户体验 | 更好 | 较差 |

**选择 `readonly` 的原因：**
- 用户可以选中和复制设备名称（可能需要）
- 外观更友好，不会让用户觉得功能"坏了"
- Tab 键可以正常导航到该字段
- 更符合"显示信息但不允许修改"的语义

### 内联样式说明

```css
background-color: #f5f5f5;  /* 浅灰色背景 */
cursor: default;             /* 默认光标（不是输入光标） */
```

**为什么使用内联样式：**
1. **局部化修改** - 只影响这一个输入框
2. **优先级最高** - 确保样式生效
3. **即时生效** - 不需要修改外部 CSS 文件
4. **易于维护** - 样式和 HTML 结构在一起

**替代方案（如果需要）：**
可以在 CSS 中添加专门的类：
```css
.settings-item-input-readonly {
    background-color: #f5f5f5;
    cursor: default;
}
```

然后在 HTML 中使用：
```html
<input type="text" class="settings-item-input settings-item-input-readonly" readonly />
```

## 与其他修复的协同

此修复与之前的修复配合工作：

### 1. 动态标签渲染（之前已完成）

**energy-flow.html 第 2233 行：**
```javascript
<div class="flow-device-label">${device.labelKey ? getDeviceLabel(device.labelKey) : device.label}</div>
```

### 2. 设置面板标题（之前已完成）

**energy-flow.html 第 1434-1435 行：**
```javascript
const deviceLabel = device.labelKey ? getDeviceLabel(device.labelKey) : device.label;
titleEl.textContent = `${deviceLabel} - ${t('energyFlowDeviceSettings')}`;
```

### 3. 语言切换事件（之前已完成）

**energy-flow.html 第 3944-3955 行：**
```javascript
window.addEventListener('languageChanged', function() {
    // 更新页面标题
    document.title = getTranslation('energyFlowPageTitle') || 'Energy Flow Settings';
    document.documentElement.lang = (localStorage.getItem('language') || 'en') === 'zh' ? 'zh-CN' : 'en-US';

    // 重新渲染已放置的设备
    renderPlacedDevices();

    // 更新设置面板（如果打开）
    if (selectedDevice) {
        showDeviceSettings(selectedDevice);
    }
});
```

### 4. 本次修复（设备名称只读）

确保用户无法破坏上述翻译机制。

## 完整的国际化流程

```
用户打开页面（英文环境）
    ↓
拖拽设备到画布
    ↓
设备使用 labelKey='energyFlowDeviceNameGrid'
    ↓
画布显示: getDeviceLabel('energyFlowDeviceNameGrid') → "Grid"
    ↓
点击设备打开设置面板
    ↓
面板标题: "Grid - Device Settings"
设备名称输入框: "Grid" (只读，灰色背景)
    ↓
用户切换到中文
    ↓
触发 languageChanged 事件
    ↓
重新渲染设备: renderPlacedDevices()
重新打开设置面板: showDeviceSettings()
    ↓
画布显示: "市电"
面板标题: "市电 - 设备设置"
设备名称输入框: "市电" (只读)
    ↓
✅ 整个流程中，设备名称完全由翻译系统控制
✅ 用户无法破坏国际化机制
```

## 测试建议

### 1. 基本显示测试

**中文环境：**
1. 打开能量流编辑页面
2. 拖拽"市电"设备到画布
3. 点击设备打开设置面板
4. ✅ 验证"设备名称"输入框显示"市电"
5. ✅ 验证输入框有灰色背景
6. ✅ 验证输入框无法编辑

**英文环境：**
1. 切换到英文
2. 拖拽"Grid"设备到画布
3. 点击设备打开设置面板
4. ✅ 验证"Device Name"输入框显示"Grid"
5. ✅ 验证输入框有灰色背景
6. ✅ 验证输入框无法编辑

### 2. 语言切换测试

1. 在中文环境下放置"市电"设备
2. 打开设置面板
3. ✅ 验证显示"市电 - 设备设置"
4. ✅ 验证输入框显示"市电"
5. 不关闭面板，切换到英文
6. ✅ 验证面板标题立即更新为"Grid - Device Settings"
7. ✅ 验证输入框立即更新为"Grid"
8. 切换回中文
9. ✅ 验证所有内容恢复为中文

### 3. 只读状态测试

1. 打开设备设置面板
2. 点击"设备名称"输入框
3. ✅ 验证鼠标光标为默认形状（不是输入光标）
4. 尝试输入文字
5. ✅ 验证无法输入
6. 尝试删除文字
7. ✅ 验证无法删除
8. 尝试复制文字（Ctrl+C）
9. ✅ 验证可以复制

### 4. 多设备测试

1. 放置多种设备：
   - 市电 (Grid)
   - 光伏 (Solar)
   - 储能柜 (PCS)
   - 负载 (Load)
2. 逐个点击并查看设置面板
3. ✅ 验证每个设备的名称输入框都是只读的
4. ✅ 验证每个设备名称根据当前语言正确显示
5. 切换语言
6. ✅ 验证所有设备名称同时更新

### 5. 视觉一致性测试

1. 对比只读输入框和其他可编辑输入框
2. ✅ 验证只读输入框有明显的视觉区分（灰色背景）
3. ✅ 验证不影响其他输入框的正常使用
4. ✅ 验证整体界面和谐统一

## 涉及文件

| 文件 | 修改内容 | 行号 |
|------|---------|------|
| `energy-flow.html` | 设备名称输入框改为只读 | 1460-1461 |

## 用户体验改进

### 改进点 1：防止误操作
- **之前：** 用户可能不小心修改设备名称，导致翻译失效
- **现在：** 输入框只读，避免误操作

### 改进点 2：清晰的视觉反馈
- **之前：** 输入框看起来可编辑，但编辑后会破坏国际化
- **现在：** 灰色背景明确表示"此字段不可编辑"

### 改进点 3：保持一致性
- **之前：** 用户修改后，画布显示和输入框可能不一致
- **现在：** 设备名称完全由系统控制，保证一致性

### 改进点 4：简化用户心智模型
- **之前：** 用户需要理解"修改名称会影响翻译"
- **现在：** 设备名称自动管理，用户无需关心

## 未来扩展建议

### 如果需要支持自定义设备名称

如果将来需要允许用户自定义设备名称，可以考虑以下方案：

**方案 A：添加"自定义名称"字段**
```html
<div class="settings-item">
    <label class="settings-item-label">设备类型</label>
    <input type="text" readonly value="Grid" />
</div>
<div class="settings-item">
    <label class="settings-item-label">自定义名称（可选）</label>
    <input type="text" value="" placeholder="如：1号市电" />
</div>
```

**方案 B：使用别名机制**
```javascript
device = {
    type: 'grid',
    labelKey: 'energyFlowDeviceNameGrid',  // 系统名称
    customLabel: '',  // 用户自定义别名（可选）
    displayName: function() {
        return this.customLabel || getDeviceLabel(this.labelKey);
    }
}
```

**方案 C：添加"重命名"按钮**
- 默认使用系统翻译
- 提供"重命名"按钮开启编辑模式
- 编辑后使用自定义名称，但保留"恢复默认"选项

## 注意事项

⚠️ **重要提醒：**

### 1. 不影响其他输入框
- 只有设备名称输入框是只读的
- 其他设置项（如额定功率、电压等级）仍然可以编辑
- 确保不要误将其他字段也设为只读

### 2. 保持数据结构不变
- 设备对象仍然有 `label` 和 `labelKey` 属性
- 只是不允许用户通过 UI 修改 `label`
- 向后兼容旧数据

### 3. 复制功能保留
- 用户仍然可以选中和复制设备名称
- 这对于用户记录或报告可能有用

### 4. 无障碍访问
- `readonly` 输入框仍可被屏幕阅读器读取
- Tab 键导航仍然有效
- 优于 `disabled` 属性的可访问性

## 相关文档

- [能量流设备名称实时切换修复说明.md](./能量流设备名称实时切换修复说明.md)
- [能量流编辑页面国际化修复说明.md](./能量流编辑页面国际化修复说明.md)

## 日期

修复日期: 2026-01-14
