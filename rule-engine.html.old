<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>规则引擎 - 储能柜管理系统</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* 页面布局 */
        .main-content {
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 20px;
        }

        /* 页面标题 */
        .page-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        /* Tab导航样式移动到新增样式中 */
        .tabs-container {
            margin-bottom: 24px;
        }
        
        .tab-content {
            padding: 0;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        /* 规则模版样式 */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .template-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="dark"] .template-card {
            background: #1e293b;
            border-color: #334155;
        }
        
        .template-card:hover {
            border-color: #3562E3;
            box-shadow: 0 4px 12px rgba(53, 98, 227, 0.15);
            transform: translateY(-2px);
        }
        
        .template-card.selected {
            border-color: #3562E3;
            background: #eff6ff;
        }
        
        [data-theme="dark"] .template-card.selected {
            background: #1e3a8a;
        }
        
        .template-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .template-info {
            flex: 1;
        }
        
        .template-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .template-actions-group {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 12px;
        }
        
        .template-icon-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            font-size: 16px;
        }
        
        .template-icon-btn:hover {
            transform: scale(1.1);
        }
        
        .template-icon-btn.copy {
            color: #3562E3;
        }
        
        .template-icon-btn.copy:hover {
            color: #2c51c9;
        }
        
        .template-icon-btn.delete {
            color: #dc2626;
        }
        
        .template-icon-btn.delete:hover {
            color: #b91c1c;
        }
        
        [data-theme="dark"] .template-icon-btn.copy {
            color: #60a5fa;
        }
        
        [data-theme="dark"] .template-icon-btn.copy:hover {
            color: #3b82f6;
        }
        
        [data-theme="dark"] .template-icon-btn.delete {
            color: #ef4444;
        }
        
        [data-theme="dark"] .template-icon-btn.delete:hover {
            color: #dc2626;
        }
        
        .template-icon-btn[disabled] {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .template-description {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 16px;
        }
        
        .template-features {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .template-feature {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .template-feature i {
            color: #10b981;
            width: 16px;
        }
        
        .template-actions {
            display: flex;
            gap: 12px;
        }
        
        /* 新增优化样式 */
        .template-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-badge.inactive {
            background: #fee2e2;
            color: #991b1b;
        }
        
        [data-theme="dark"] .status-badge.active {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }
        
        [data-theme="dark"] .status-badge.inactive {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }
        
        .template-remark {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        /* 移除旧的template-btn样式 */
        
        /* 模版元信息样式 */
        .template-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 4px;
        }
        
        .template-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .template-meta-item i {
            opacity: 0.7;
        }
        
        /* 统计数据样式 */
        .template-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        
        [data-theme="dark"] .template-stats {
            background: #0f172a;
        }
        
        /* 优化卡片动画 */
        .template-card {
            position: relative;
            overflow: hidden;
        }
        
        .template-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #3562E3 0%, #60a5fa 100%);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .template-card:hover::before {
            transform: translateX(0);
        }
        
        /* 开关组件样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 24px;
        }
        
        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        
        .switch input:checked + .switch-slider {
            background-color: #3562E3;
        }
        
        .switch input:checked + .switch-slider:before {
            transform: translateX(20px);
        }
        
        [data-theme="dark"] .switch-slider {
            background-color: #4b5563;
        }
        
        [data-theme="dark"] .switch input:checked + .switch-slider {
            background-color: #3562E3;
        }
        
        /* Tab样式优化 */
        .tabs-wrapper {
            background: white;
            border-radius: 12px;
            padding: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            display: inline-flex;
            gap: 4px;
            margin-bottom: 24px;
        }
        
        [data-theme="dark"] .tabs-wrapper {
            background: #1e293b;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .tab-button {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tab-button:hover {
            background: rgba(53, 98, 227, 0.08);
            color: #3562E3;
        }
        
        .tab-button.active {
            background: #3562E3;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(53, 98, 227, 0.25);
        }
        
        .tab-button.active:hover {
            background: #2c51c9;
        }
        
        /* 规则引擎容器 */
        .rule-engine-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 260px);
        }

        /* 规则列表面板 */
        .rule-list-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        [data-theme="dark"] .rule-list-panel {
            background: #1e293b;
        }

        .rule-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .rule-list-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* 规则搜索 */
        .rule-search {
            margin-bottom: 16px;
        }

        .rule-search input {
            width: 100%;
            height: 36px;
            padding: 0 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: var(--text-primary);
        }

        [data-theme="dark"] .rule-search input {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        /* 规则列表 */
        .rule-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rule-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        [data-theme="dark"] .rule-item {
            background: #0f172a;
            border-color: #334155;
        }

        .rule-item:hover {
            border-color: #3562E3;
            background: #f8fafc;
        }

        [data-theme="dark"] .rule-item:hover {
            background: #1e293b;
        }

        .rule-item.active {
            border-color: #3562E3;
            background: #eff6ff;
        }

        [data-theme="dark"] .rule-item.active {
            background: #1e3a8a;
        }

        .rule-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .rule-item-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .rule-item-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.active {
            background: #10b981;
        }

        .status-dot.inactive {
            background: #ef4444;
        }

        .rule-item-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* 规则编辑器面板 */
        .rule-editor-panel {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        [data-theme="dark"] .rule-editor-panel {
            background: #1e293b;
        }

        .rule-editor-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        [data-theme="dark"] .rule-editor-header {
            border-bottom-color: #334155;
        }

        .rule-editor-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .rule-editor-actions {
            display: flex;
            gap: 12px;
        }

        /* 规则编辑器内容 */
        .rule-editor-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* 规则流程图 */
        .rule-flow-diagram {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        [data-theme="dark"] .rule-flow-diagram {
            background: #0f172a;
            border-color: #334155;
        }

        /* 规则节点 */
        .flow-node {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            position: relative;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .flow-node {
            background: #1e293b;
            border-color: #334155;
        }

        .flow-node-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .flow-node-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .flow-node-icon.trigger {
            background: #dbeafe;
            color: #3b82f6;
        }

        .flow-node-icon.condition {
            background: #fef3c7;
            color: #f59e0b;
        }

        .flow-node-icon.action {
            background: #d1fae5;
            color: #10b981;
        }

        [data-theme="dark"] .flow-node-icon.trigger {
            background: #1e3a8a;
        }

        [data-theme="dark"] .flow-node-icon.condition {
            background: #78350f;
        }

        [data-theme="dark"] .flow-node-icon.action {
            background: #064e3b;
        }

        .flow-node-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .flow-node-content {
            font-size: 13px;
            color: var(--text-secondary);
            background: #f8fafc;
            border-radius: 6px;
            padding: 12px;
        }

        [data-theme="dark"] .flow-node-content {
            background: #0f172a;
        }

        /* 连接线 */
        .flow-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: -10px 0;
            position: relative;
            z-index: 1;
        }

        .flow-connector-line {
            width: 2px;
            height: 40px;
            background: var(--border-color);
        }

        .flow-connector-arrow {
            position: absolute;
            bottom: -8px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid var(--border-color);
        }

        /* 规则属性 */
        .rule-properties {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        [data-theme="dark"] .rule-properties {
            background: #0f172a;
            border-color: #334155;
        }

        .property-group {
            margin-bottom: 20px;
        }

        .property-group-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .property-row {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .property-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .property-value {
            display: flex;
            gap: 8px;
        }

        /* 按钮样式 - 与系统保持一致 */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 40px;
            padding: 0 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
            outline: none;
        }

        .btn-primary {
            background: #3562E3;
            color: white;
        }

        .btn-primary:hover {
            background: #2c51c9;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(53, 98, 227, 0.25);
        }

        .btn-secondary {
            background: white;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: #f3f4f6;
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        [data-theme="dark"] .btn-secondary {
            background: #334155;
            color: #e2e8f0;
            border-color: #475569;
        }
        
        [data-theme="dark"] .btn-secondary:hover {
            background: #475569;
            border-color: var(--primary-color);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        /* 模版卡片内的按钮特殊样式 */
        .template-actions .btn {
            flex: 1;
            height: 36px;
            font-size: 13px;
        }
        
        .template-actions .btn-secondary {
            background: white;
            border: 1px solid #e5e7eb;
            color: var(--text-primary);
        }
        
        .template-actions .btn-secondary:hover {
            background: #f9fafb;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        [data-theme="dark"] .template-actions .btn-secondary {
            background: #334155;
            border-color: #475569;
            color: #e2e8f0;
        }
        
        [data-theme="dark"] .template-actions .btn-secondary:hover {
            background: #475569;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* 通知方式样式 */
        .notification-methods {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .notification-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            white-space: nowrap;
        }
        
        .notification-list {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .notification-item {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            font-size: 12px;
            color: var(--text-primary);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            white-space: nowrap;
        }
        
        [data-theme="dark"] .notification-badge {
            background: #0f172a;
            border-color: #374151;
            color: #9ca3af;
        }
        
        [data-theme="dark"] .notification-badge.active {
            background: rgba(53, 98, 227, 0.1);
            border-color: #60a5fa;
            color: #60a5fa;
        }

        /* 输入框样式 */
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s;
        }

        [data-theme="dark"] .form-input,
        [data-theme="dark"] .form-select,
        [data-theme="dark"] .form-textarea {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        /* 开关组件 */
        .switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: 0.3s;
            border-radius: 24px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .switch input:checked + .switch-slider {
            background-color: #3562E3;
        }

        .switch input:checked + .switch-slider:before {
            transform: translateX(20px);
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.8;
        }

        /* ========== 规则应用表格样式（优化版） ========== */
        .rules-table {
            width: 100%;
            border-collapse: collapse;
        }

        .rules-table thead {
            background: transparent;
        }

        .rules-table th {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 2px solid var(--border-color);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
            white-space: nowrap;
        }

        [data-theme="dark"] .rules-table th {
            border-bottom-color: #334155;
        }

        .rules-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 14px;
            color: var(--text-primary);
        }

        [data-theme="dark"] .rules-table td {
            border-bottom-color: #334155;
        }

        .rules-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .rules-table tbody tr:hover {
            background: #f9fafb;
        }

        [data-theme="dark"] .rules-table tbody tr:hover {
            background: #0f172a;
        }

        .rules-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* 规则名称列样式 */
        .rule-name-cell {
            font-weight: 500;
            color: var(--text-primary);
        }

        .rule-description-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* 适用对象列样式 */
        .rule-target-cell {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* 执行位置badge */
        .location-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .location-badge.gateway {
            background: #dbeafe;
            color: #1e40af;
        }

        .location-badge.cloud {
            background: #f3e8ff;
            color: #6b21a8;
        }

        [data-theme="dark"] .location-badge.gateway {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        [data-theme="dark"] .location-badge.cloud {
            background: rgba(168, 85, 247, 0.2);
            color: #d8b4fe;
        }

        /* 告警类型标签 */
        .alarm-type-tag {
            color: var(--text-primary);
            font-size: 13px;
        }

        /* 告警等级badge */
        .alarm-level-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .alarm-level-badge.critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .alarm-level-badge.important {
            background: #fef3c7;
            color: #92400e;
        }

        .alarm-level-badge.general {
            background: #dbeafe;
            color: #1e40af;
        }

        [data-theme="dark"] .alarm-level-badge.critical {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        [data-theme="dark"] .alarm-level-badge.important {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        [data-theme="dark"] .alarm-level-badge.general {
            background: rgba(59, 130, 246, 0.2);
            color: #93c5fd;
        }

        /* 状态badge */
        .rule-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }

        .rule-status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .rule-status-badge.inactive {
            background: #f3f4f6;
            color: #6b7280;
        }

        .rule-status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        [data-theme="dark"] .rule-status-badge.active {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
        }

        [data-theme="dark"] .rule-status-badge.inactive {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        [data-theme="dark"] .rule-status-badge.pending {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
        }

        .rule-status-badge i {
            font-size: 8px;
        }

        /* 操作按钮组 */
        .rule-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            align-items: center;
        }

        .rule-action-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .rule-action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        [data-theme="dark"] .rule-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
        }

        .rule-action-btn i {
            font-size: 16px;
        }

        .rule-action-btn.edit:hover {
            color: #3562E3;
        }

        .rule-action-btn.delete:hover {
            color: #ef4444;
        }

        /* ========== 规则工具栏样式 ========== */
        .rules-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
            flex-wrap: wrap;
        }

        .rules-toolbar-left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .rules-toolbar-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* 搜索框样式 */
        .rule-search-wrapper {
            position: relative;
            width: 300px;
        }

        .rule-search-input {
            width: 100%;
            height: 40px;
            padding: 0 40px 0 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        [data-theme="dark"] .rule-search-input {
            background: #0f172a;
            border-color: #334155;
            color: #e2e8f0;
        }

        .rule-search-input:focus {
            outline: none;
            border-color: #3562E3;
            box-shadow: 0 0 0 3px rgba(53, 98, 227, 0.1);
        }

        .rule-search-input::placeholder {
            color: var(--text-secondary);
        }

        .rule-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* 响应式设计 */
        @media (max-width: 1024px) {
            .rule-engine-container {
                grid-template-columns: 1fr;
                height: auto;
            }

            .rule-list-panel {
                height: 300px;
            }

            .rule-search-wrapper {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .rules-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .rules-toolbar-right {
                justify-content: space-between;
            }

            .rule-search-wrapper {
                width: 100%;
            }
        }

        /* ========== 表格单元格样式 ========== */
        .no-data-cell {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .no-data-icon {
            font-size: 48px;
            display: block;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .rule-name-cell {
            padding: 16px;
        }

        .rule-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .rule-description {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .rule-target-cell {
            padding: 16px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .alarm-type-cell {
            padding: 16px;
        }

        .alarm-type-tag {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .rule-time-cell {
            padding: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .rule-actions-cell {
            padding: 16px;
            text-align: center;
        }

        .rule-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        .badge-dot {
            font-size: 6px;
        }

        /* 播放/暂停按钮特殊样式 */
        .rule-action-btn.play {
            background: #d1fae5;
            color: #065f46;
        }

        .rule-action-btn.play:hover {
            background: #a7f3d0;
        }

        .rule-action-btn.pause {
            background: #fef3c7;
            color: #78350f;
        }

        .rule-action-btn.pause:hover {
            background: #fde68a;
        }

        /* ========== 模态框样式 ========== */
        .rule-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
        }

        .rule-modal-overlay[style*="display: flex"] {
            display: flex !important;
        }

        .rule-modal-container {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 900px;
            max-height: 95vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            margin: auto;
        }

        [data-theme="dark"] .rule-modal-container {
            background: #1e293b;
        }

        .rule-modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #3562E3 0%, #4f7aeb 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rule-modal-title {
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .rule-modal-subtitle {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .rule-modal-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .rule-modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .rule-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .rule-section {
            margin-bottom: 32px;
        }

        .rule-section-header {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="dark"] .rule-section-header {
            color: #f1f5f9;
        }

        .rule-section-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: #dbeafe;
            color: #3b82f6;
            border-radius: 6px;
            font-size: 14px;
        }

        [data-theme="dark"] .rule-section-number {
            background: #1e3a8a;
            color: #93c5fd;
        }

        .rule-form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .rule-form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .rule-form-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .rule-form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #475569;
            font-weight: 500;
        }

        [data-theme="dark"] .rule-form-label {
            color: #cbd5e1;
        }

        .rule-form-required {
            color: #ef4444;
        }

        .rule-info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }

        [data-theme="dark"] .rule-info-box {
            background: #1e3a8a;
            border-color: #1e40af;
        }

        .rule-info-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rule-info-text {
            font-size: 13px;
            color: #1e40af;
        }

        [data-theme="dark"] .rule-info-text {
            color: #93c5fd;
        }

        .rule-tree-selector {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 12px;
        }

        [data-theme="dark"] .rule-tree-selector {
            background: #0f172a;
        }

        .rule-tree-node {
            margin-bottom: 8px;
        }

        .rule-tree-label {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .rule-tree-label:hover {
            background: #f8fafc;
        }

        [data-theme="dark"] .rule-tree-label:hover {
            background: #1e293b;
        }

        .rule-tree-children {
            margin-left: 24px;
        }

        .rule-dynamic-config {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            display: none;
        }

        [data-theme="dark"] .rule-dynamic-config {
            background: #0f172a;
        }

        .rule-radio-group {
            display: flex;
            gap: 24px;
            height: 40px;
            align-items: center;
        }

        .rule-radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .rule-modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #f8fafc;
        }

        [data-theme="dark"] .rule-modal-footer {
            background: #0f172a;
        }

        .rule-warning-box {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 8px;
            padding: 12px;
        }

        [data-theme="dark"] .rule-warning-box {
            background: #78350f;
            border-color: #92400e;
        }

        .rule-warning-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rule-warning-text {
            font-size: 13px;
            color: #78350f;
        }

        [data-theme="dark"] .rule-warning-text {
            color: #fde68a;
        }

        .rule-notification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .rule-notification-card {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .rule-notification-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .rule-notification-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        [data-theme="dark"] .rule-notification-card:hover,
        [data-theme="dark"] .rule-notification-card.selected {
            border-color: #3b82f6;
            background: #1e3a8a;
        }

        .rule-notification-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .rule-notification-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
    </style>
</head>
<body data-page="rule-engine">
    <!-- 导航栏容器由 navbar.js 自动填充 -->

    <!-- 主内容区域 -->
    <main class="main-content" id="mainContent">
        <div class="page-header">
            <h1 class="page-title">规则引擎</h1>
        </div>

        <!-- Tab导航容器 -->
        <div class="tabs-container">
            <div class="tabs-wrapper">
                <button class="tab-button active" onclick="switchTab('template')">
                    <i class="fas fa-cube"></i>
                    规则模版
                </button>
                <button class="tab-button" onclick="switchTab('application')">
                    <i class="fas fa-cogs"></i>
                    规则应用
                </button>
            </div>
            
            <div class="tab-content">
                <!-- 规则模版面板 -->
                <div id="template-panel" class="tab-panel active">
                    <div class="rules-toolbar">
                        <div class="rules-toolbar-left">
                            <button class="btn btn-primary" onclick="createNewTemplate()">
                                <i class="fas fa-plus"></i>
                                <span data-translate="templateNew">新建告警规则</span>
                            </button>
                        </div>
                        <div class="rules-toolbar-right">
                            <!-- 预留搜索或过滤功能 -->
                        </div>
                    </div>
                    <!-- 规则模版列表表格 -->
                    <div class="content-card">
                        <table class="rules-table">
                            <thead>
                                <tr>
                                    <th data-translate="templateColName">模版名称</th>
                                    <th data-translate="templateColChannels">通知方式</th>
                                    <th data-translate="templateColStatus">状态</th>
                                    <th data-translate="templateColTime">时间</th>
                                    <th style="text-align: center;" data-translate="templateColActions">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 电池高温告警 -->
                                <tr>
                                    <td class="rule-name-cell">
                                        <div class="rule-name">电池高温告警</div>
                                        <div class="rule-description">温度超过55°C时触发告警</div>
                                    </td>
                                    <td class="rule-target-cell">
                                        <span class="notification-item">短信</span>
                                        <span class="notification-item">邮箱</span>
                                        <span class="notification-item">APP推送</span>
                                    </td>
                                    <td>
                                        <span class="rule-status-badge active">
                                            <i class="fas fa-circle badge-dot"></i>
                                            启用
                                        </span>
                                    </td>
                                    <td class="rule-time-cell">2024-11-28 09:15:30</td>
                                    <td class="rule-actions-cell">
                                        <div class="rule-actions">
                                            <button class="rule-action-btn edit" onclick="viewTemplateDetails('temperature', event)" title="详情">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button class="rule-action-btn play" onclick="applyTemplate('temperature', event)" title="应用">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="rule-action-btn edit" onclick="copyTemplate('temperature', event)" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- 电池SOC低告警 -->
                                <tr>
                                    <td class="rule-name-cell">
                                        <div class="rule-name">电池SOC低告警</div>
                                        <div class="rule-description">SOC低于20%时触发告警</div>
                                    </td>
                                    <td class="rule-target-cell">
                                        <span class="notification-item">短信</span>
                                        <span class="notification-item">站内信</span>
                                    </td>
                                    <td>
                                        <span class="rule-status-badge active">
                                            <i class="fas fa-circle badge-dot"></i>
                                            启用
                                        </span>
                                    </td>
                                    <td class="rule-time-cell">2024-11-26 14:20:15</td>
                                    <td class="rule-actions-cell">
                                        <div class="rule-actions">
                                            <button class="rule-action-btn edit" onclick="viewTemplateDetails('battery', event)" title="详情">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button class="rule-action-btn play" onclick="applyTemplate('battery', event)" title="应用">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="rule-action-btn edit" onclick="copyTemplate('battery', event)" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="rule-action-btn delete" onclick="confirmDeleteTemplate('battery', event)" title="删除">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- 逆变器过载告警 -->
                                <tr>
                                    <td class="rule-name-cell">
                                        <div class="rule-name">逆变器过载告警</div>
                                        <div class="rule-description">功率超过额定功率110%</div>
                                    </td>
                                    <td class="rule-target-cell">
                                        <span class="notification-item">短信</span>
                                        <span class="notification-item">邮箱</span>
                                    </td>
                                    <td>
                                        <span class="rule-status-badge active">
                                            <i class="fas fa-circle badge-dot"></i>
                                            启用
                                        </span>
                                    </td>
                                    <td class="rule-time-cell">2024-11-25 10:35:42</td>
                                    <td class="rule-actions-cell">
                                        <div class="rule-actions">
                                            <button class="rule-action-btn edit" onclick="viewTemplateDetails('pricing', event)" title="详情">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button class="rule-action-btn play" onclick="applyTemplate('pricing', event)" title="应用">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="rule-action-btn edit" onclick="copyTemplate('pricing', event)" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="rule-action-btn delete" onclick="confirmDeleteTemplate('pricing', event)" title="删除">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- 单体电压异常 -->
                                <tr>
                                    <td class="rule-name-cell">
                                        <div class="rule-name">单体电压异常</div>
                                        <div class="rule-description">单体电压差超过0.3V</div>
                                    </td>
                                    <td class="rule-target-cell">
                                        <span class="notification-item">邮箱</span>
                                        <span class="notification-item">站内信</span>
                                    </td>
                                    <td>
                                        <span class="rule-status-badge inactive">
                                            <i class="fas fa-circle badge-dot"></i>
                                            禁用
                                        </span>
                                    </td>
                                    <td class="rule-time-cell">2024-11-20 16:48:20</td>
                                    <td class="rule-actions-cell">
                                        <div class="rule-actions">
                                            <button class="rule-action-btn edit" onclick="viewTemplateDetails('safety', event)" title="详情">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button class="rule-action-btn play" onclick="applyTemplate('safety', event)" title="应用">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="rule-action-btn edit" onclick="copyTemplate('safety', event)" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="rule-action-btn delete" onclick="confirmDeleteTemplate('safety', event)" title="删除">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- 充电电流过大告警 -->
                                <tr>
                                    <td class="rule-name-cell">
                                        <div class="rule-name">充电电流过大告警</div>
                                        <div class="rule-description">充电电流超过200A</div>
                                    </td>
                                    <td class="rule-target-cell">
                                        <span class="notification-item">短信</span>
                                        <span class="notification-item">APP推送</span>
                                    </td>
                                    <td>
                                        <span class="rule-status-badge active">
                                            <i class="fas fa-circle badge-dot"></i>
                                            启用
                                        </span>
                                    </td>
                                    <td class="rule-time-cell">2024-11-18 11:22:55</td>
                                    <td class="rule-actions-cell">
                                        <div class="rule-actions">
                                            <button class="rule-action-btn edit" onclick="viewTemplateDetails('linkage', event)" title="详情">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button class="rule-action-btn play" onclick="applyTemplate('linkage', event)" title="应用">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="rule-action-btn edit" onclick="copyTemplate('linkage', event)" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="rule-action-btn delete" onclick="confirmDeleteTemplate('linkage', event)" title="删除">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- 设备通信故障 -->
                                <tr>
                                    <td class="rule-name-cell">
                                        <div class="rule-name">设备通信故障</div>
                                        <div class="rule-description">设备离线超过5分钟</div>
                                    </td>
                                    <td class="rule-target-cell">
                                        <span class="notification-item">短信</span>
                                        <span class="notification-item">邮箱</span>
                                        <span class="notification-item">站内信</span>
                                    </td>
                                    <td>
                                        <span class="rule-status-badge active">
                                            <i class="fas fa-circle badge-dot"></i>
                                            启用
                                        </span>
                                    </td>
                                    <td class="rule-time-cell">2024-11-15 08:50:10</td>
                                    <td class="rule-actions-cell">
                                        <div class="rule-actions">
                                            <button class="rule-action-btn edit" onclick="viewTemplateDetails('energy', event)" title="详情">
                                                <i class="fas fa-info-circle"></i>
                                            </button>
                                            <button class="rule-action-btn play" onclick="applyTemplate('energy', event)" title="应用">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="rule-action-btn edit" onclick="copyTemplate('energy', event)" title="复制">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button class="rule-action-btn delete" onclick="confirmDeleteTemplate('energy', event)" title="删除">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 规则应用面板 -->
                <div id="application-panel" class="tab-panel">
                    <!-- 工具栏 -->
                    <div class="rules-toolbar">
                        <div class="rules-toolbar-left">
                            <button class="btn btn-primary" onclick="openRuleModal()">
                                <i class="fas fa-plus"></i>
                                <span data-translate="ruleNewRule">新建规则</span>
                            </button>
                        </div>
                        <div class="rules-toolbar-right">
                            <div class="rule-search-wrapper">
                                <input
                                    type="text"
                                    class="rule-search-input"
                                    placeholder="搜索规则..."
                                    data-translate-placeholder="ruleSearchPlaceholder"
                                    onkeyup="searchApplicationRules(this.value)"
                                />
                                <i class="fas fa-search rule-search-icon"></i>
                            </div>
                            <button class="btn btn-secondary" onclick="refreshApplicationRuleList()">
                                <i class="fas fa-sync-alt"></i>
                                <span data-translate="ruleRefresh">刷新</span>
                            </button>
                        </div>
                    </div>

                    <!-- 规则列表表格 -->
                    <div class="content-card">
                        <table class="rules-table">
                            <thead>
                                <tr>
                                    <th data-translate="ruleColName">规则名称</th>
                                    <th data-translate="ruleColTarget">适用对象</th>
                                    <th data-translate="ruleColLocation">执行位置</th>
                                    <th data-translate="ruleColAlarmType">告警类型</th>
                                    <th data-translate="ruleColAlarmLevel">告警等级</th>
                                    <th data-translate="ruleColCreateTime">创建时间</th>
                                    <th data-translate="ruleColStatus">状态</th>
                                    <th style="text-align: center;" data-translate="ruleColActions">操作</th>
                                </tr>
                            </thead>
                            <tbody id="applicationRulesTableBody">
                                <!-- 动态内容将在这里生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 移动端遮罩 -->
    <div id="mobileOverlay" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 998;" onclick="closeMobileSidebar()"></div>

    <!-- 模版应用向导模态框 -->
    <div id="templateWizardModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
            <!-- 向导头部 -->
            <div style="padding: 24px; border-bottom: 1px solid var(--border-color); background: linear-gradient(135deg, #3562E3 0%, #4f7aeb 100%); color: white;">
                <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600;">应用规则模版</h2>
                <p style="margin: 0; opacity: 0.9; font-size: 14px;" id="wizardTemplateTitle">标准模版</p>
            </div>

            <!-- 步骤指示器 -->
            <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; position: relative;">
                    <div class="wizard-step active" data-step="1" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-indicator" style="width: 40px; height: 40px; border-radius: 50%; background: #3562E3; color: white; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: 8px;">1</div>
                        <div style="font-size: 13px; color: #1e293b; font-weight: 500;">选择对象</div>
                    </div>
                    <div class="wizard-step" data-step="2" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-indicator" style="width: 40px; height: 40px; border-radius: 50%; background: #cbd5e1; color: #64748b; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: 8px;">2</div>
                        <div style="font-size: 13px; color: #64748b;">配置参数</div>
                    </div>
                    <div class="wizard-step" data-step="3" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-indicator" style="width: 40px; height: 40px; border-radius: 50%; background: #cbd5e1; color: #64748b; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: 8px;">3</div>
                        <div style="font-size: 13px; color: #64748b;">通知设置</div>
                    </div>
                    <div class="wizard-step" data-step="4" style="flex: 1; text-align: center; position: relative; z-index: 1;">
                        <div class="step-indicator" style="width: 40px; height: 40px; border-radius: 50%; background: #cbd5e1; color: #64748b; display: inline-flex; align-items: center; justify-content: center; font-weight: 600; margin-bottom: 8px;">4</div>
                        <div style="font-size: 13px; color: #64748b;">预览确认</div>
                    </div>
                    <!-- 连接线 -->
                    <div style="position: absolute; top: 20px; left: 10%; right: 10%; height: 2px; background: #e2e8f0; z-index: 0;"></div>
                    <div id="wizardProgressLine" style="position: absolute; top: 20px; left: 10%; width: 0%; height: 2px; background: #3562E3; z-index: 0; transition: width 0.3s ease;"></div>
                </div>
            </div>

            <!-- 向导内容区域 -->
            <div style="flex: 1; overflow-y: auto; padding: 24px;">
                <!-- 步骤1: 选择对象 -->
                <div id="wizardStep1" class="wizard-content" style="display: block;">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1e293b;">选择要应用此规则的设备或站点</h3>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">应用范围</label>
                        <select class="form-select" id="wizardScope" onchange="updateScopeOptions(this.value)">
                            <option value="site">按站点</option>
                            <option value="device">按设备</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">选择站点</label>
                        <div id="wizardSiteList" style="border: 1px solid var(--border-color); border-radius: 8px; max-height: 300px; overflow-y: auto;">
                            <label style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                <input type="checkbox" value="site1" style="margin-right: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #1e293b;">上海浦东站点</div>
                                    <div style="font-size: 13px; color: #64748b;">设备数量: 8 | 储能容量: 500kWh</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                <input type="checkbox" value="site2" style="margin-right: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #1e293b;">北京朝阳站点</div>
                                    <div style="font-size: 13px; color: #64748b;">设备数量: 6 | 储能容量: 400kWh</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                <input type="checkbox" value="site3" style="margin-right: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #1e293b;">深圳南山站点</div>
                                    <div style="font-size: 13px; color: #64748b;">设备数量: 10 | 储能容量: 600kWh</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 步骤2: 配置参数 -->
                <div id="wizardStep2" class="wizard-content" style="display: none;">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1e293b;">配置规则触发参数</h3>
                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                            <span style="font-weight: 500; color: #1e40af;">触发条件说明</span>
                        </div>
                        <p style="margin: 0; font-size: 13px; color: #1e40af; line-height: 1.6;">当监测参数超过设定阈值且持续时间达到要求时,规则将自动触发执行。</p>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">监测参数</label>
                            <select class="form-select" id="wizardParameter">
                                <option value="temperature">温度</option>
                                <option value="soc">SOC</option>
                                <option value="voltage">电压</option>
                                <option value="current">电流</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">触发条件</label>
                            <select class="form-select" id="wizardCondition">
                                <option value="gt">大于 (&gt;)</option>
                                <option value="lt">小于 (&lt;)</option>
                                <option value="gte">大于等于 (&gt;=)</option>
                                <option value="lte">小于等于 (&lt;=)</option>
                                <option value="eq">等于 (=)</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">阈值</label>
                            <input type="number" class="form-input" id="wizardThreshold" value="55" placeholder="请输入阈值">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">持续时间(分钟)</label>
                            <input type="number" class="form-input" id="wizardDuration" value="5" placeholder="持续时间">
                        </div>
                    </div>
                    <div style="margin-top: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">执行动作</label>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <label style="display: flex; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" checked style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 500; color: #1e293b;">发送告警通知</div>
                                    <div style="font-size: 12px; color: #64748b;">通过配置的通知渠道发送告警信息</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" checked style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 500; color: #1e293b;">降低充放电功率</div>
                                    <div style="font-size: 12px; color: #64748b;">自动将功率降低到安全范围</div>
                                </div>
                            </label>
                            <label style="display: flex; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" style="margin-right: 12px;">
                                <div>
                                    <div style="font-weight: 500; color: #1e293b;">记录日志</div>
                                    <div style="font-size: 12px; color: #64748b;">将触发事件记录到系统日志</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 步骤3: 通知设置 -->
                <div id="wizardStep3" class="wizard-content" style="display: none;">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1e293b;">配置告警通知方式</h3>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-desktop" style="color: #3b82f6; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 500; color: #1e293b; margin-bottom: 4px;">系统通知</div>
                                        <div style="font-size: 13px; color: #64748b;">在系统内弹窗显示告警信息</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" checked id="wizardNotifySystem">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; background: #fef3c7; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-envelope" style="color: #f59e0b; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 500; color: #1e293b; margin-bottom: 4px;">邮件通知</div>
                                        <div style="font-size: 13px; color: #64748b;">发送邮件到指定邮箱</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" checked id="wizardNotifyEmail" onchange="toggleEmailConfig(this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            <div id="emailConfigSection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">接收邮箱</label>
                                <input type="email" class="form-input" placeholder="admin@example.com" value="admin@example.com">
                            </div>
                        </div>

                        <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; background: #d1fae5; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-comment-dots" style="color: #10b981; font-size: 18px;"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 500; color: #1e293b; margin-bottom: 4px;">短信通知</div>
                                        <div style="font-size: 13px; color: #64748b;">发送短信到手机号</div>
                                    </div>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" id="wizardNotifySMS" onchange="toggleSMSConfig(this.checked)">
                                    <span class="switch-slider"></span>
                                </label>
                            </div>
                            <div id="smsConfigSection" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color); display: none;">
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;">接收手机号</label>
                                <input type="tel" class="form-input" placeholder="13800138000">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 步骤4: 预览确认 -->
                <div id="wizardStep4" class="wizard-content" style="display: none;">
                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #1e293b;">规则配置预览</h3>
                    <div style="background: #f8fafc; border: 1px solid var(--border-color); border-radius: 12px; padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">应用范围</h4>
                            <div id="wizardPreviewScope" style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="padding: 6px 12px; background: #eff6ff; color: #1e40af; border-radius: 6px; font-size: 13px;">上海浦东站点</span>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">触发条件</h4>
                            <div style="background: white; border-radius: 8px; padding: 16px;">
                                <p style="margin: 0; color: #1e293b; line-height: 1.6;" id="wizardPreviewCondition">
                                    当 <strong>温度 &gt; 55°C</strong> 并且持续时间 <strong>&gt; 5分钟</strong> 时触发
                                </p>
                            </div>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">执行动作</h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;" id="wizardPreviewActions">
                                <div style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 8px;">
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                    <span style="color: #1e293b; font-size: 14px;">发送告警通知</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px; padding: 10px; background: white; border-radius: 8px;">
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                    <span style="color: #1e293b; font-size: 14px;">降低充放电功率</span>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px;">通知方式</h4>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;" id="wizardPreviewNotify">
                                <span style="padding: 6px 12px; background: #dbeafe; color: #1e40af; border-radius: 6px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-desktop"></i> 系统通知
                                </span>
                                <span style="padding: 6px 12px; background: #fef3c7; color: #92400e; border-radius: 6px; font-size: 13px; display: inline-flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-envelope"></i> 邮件通知
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 测试规则按钮 -->
                    <div style="margin-top: 20px; background: #fef3c7; border: 1px solid #fde047; border-radius: 12px; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                            <i class="fas fa-flask" style="color: #f59e0b; font-size: 20px;"></i>
                            <div>
                                <div style="font-weight: 500; color: #92400e; margin-bottom: 4px;">测试规则</div>
                                <div style="font-size: 13px; color: #92400e;">在真实应用前测试规则是否按预期工作</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" onclick="testRule()" style="width: 100%;">
                            <i class="fas fa-vial"></i>
                            运行测试
                        </button>
                    </div>
                </div>
            </div>

            <!-- 向导底部按钮 -->
            <div style="padding: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; background: #f8fafc;">
                <button class="btn btn-secondary" onclick="closeWizard()">
                    <i class="fas fa-times"></i>
                    取消
                </button>
                <div style="display: flex; gap: 12px;">
                    <button id="wizardPrevBtn" class="btn btn-secondary" onclick="wizardPrevStep()" style="display: none;">
                        <i class="fas fa-arrow-left"></i>
                        上一步
                    </button>
                    <button id="wizardNextBtn" class="btn btn-primary" onclick="wizardNextStep()">
                        下一步
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button id="wizardFinishBtn" class="btn btn-success" onclick="finishWizard()" style="display: none;">
                        <i class="fas fa-check"></i>
                        完成应用
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建/编辑规则模态框 -->
    <div id="ruleModal" class="rule-modal-overlay">
        <div class="rule-modal-container">
            <!-- 模态框头部 -->
            <div class="rule-modal-header">
                <div>
                    <h2 class="rule-modal-title" id="ruleModalTitle" data-translate="ruleNewRule">新建规则</h2>
                    <p class="rule-modal-subtitle" data-translate="ruleModalSubtitle">配置告警规则的触发条件和通知方式</p>
                </div>
                <button onclick="closeRuleModal()" class="rule-modal-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 模态框内容区域 -->
            <div class="rule-modal-body">
                <!-- 1. 基础信息 -->
                <div class="rule-section" style="margin-bottom: 32px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #dbeafe; color: #3b82f6; border-radius: 6px; font-size: 14px;">1</span>
                        <span data-translate="ruleBasicInfo">基础信息</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;"><span data-translate="ruleRuleName">规则名称</span> <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="ruleName" class="form-input" placeholder="请输入规则名称" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleDescription">规则描述</label>
                            <textarea id="ruleDescription" class="form-input" placeholder="请输入规则描述（选填）" style="width: 100%; min-height: 80px; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 2. 告警对象 -->
                <div class="rule-section" style="margin-bottom: 32px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #dbeafe; color: #3b82f6; border-radius: 6px; font-size: 14px;">2</span>
                        <span data-translate="ruleAlarmObject">告警对象</span>
                    </h3>
                    <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                            <span style="font-size: 13px; color: #1e40af;" data-translate="ruleObjectTip">选择此规则适用的区域、设备或测点，支持多选</span>
                        </div>
                    </div>
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; max-height: 300px; overflow-y: auto; background: white;">
                        <!-- 树状选择器 -->
                        <div id="objectTreeSelector" style="padding: 12px;">
                            <div class="tree-node" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                    <input type="checkbox" class="object-checkbox" data-type="area" data-id="area1" style="margin-right: 8px;">
                                    <i class="fas fa-building" style="color: #3b82f6; margin-right: 8px;"></i>
                                    <span style="font-weight: 500; color: #1e293b;">上海浦东站点</span>
                                </label>
                                <div class="tree-children" style="margin-left: 24px;">
                                    <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                        <input type="checkbox" class="object-checkbox" data-type="device" data-id="device1" style="margin-right: 8px;">
                                        <i class="fas fa-hdd" style="color: #10b981; margin-right: 8px;"></i>
                                        <span style="font-size: 14px; color: #475569;">储能柜 #01</span>
                                    </label>
                                    <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                        <input type="checkbox" class="object-checkbox" data-type="device" data-id="device2" style="margin-right: 8px;">
                                        <i class="fas fa-hdd" style="color: #10b981; margin-right: 8px;"></i>
                                        <span style="font-size: 14px; color: #475569;">储能柜 #02</span>
                                    </label>
                                </div>
                            </div>
                            <div class="tree-node" style="margin-bottom: 8px;">
                                <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                    <input type="checkbox" class="object-checkbox" data-type="area" data-id="area2" style="margin-right: 8px;">
                                    <i class="fas fa-building" style="color: #3b82f6; margin-right: 8px;"></i>
                                    <span style="font-weight: 500; color: #1e293b;">北京朝阳站点</span>
                                </label>
                                <div class="tree-children" style="margin-left: 24px;">
                                    <label style="display: flex; align-items: center; padding: 8px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='white'">
                                        <input type="checkbox" class="object-checkbox" data-type="device" data-id="device3" style="margin-right: 8px;">
                                        <i class="fas fa-hdd" style="color: #10b981; margin-right: 8px;"></i>
                                        <span style="font-size: 14px; color: #475569;">储能柜 #03</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. 触发逻辑 -->
                <div class="rule-section" style="margin-bottom: 32px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #dbeafe; color: #3b82f6; border-radius: 6px; font-size: 14px;">3</span>
                        <span data-translate="ruleTriggerLogic">触发逻辑</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;"><span data-translate="ruleAlarmType">告警类型</span> <span style="color: #ef4444;">*</span></label>
                            <select id="alarmType" class="form-select" onchange="updateDynamicConfig(this.value)" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                                <option value="">请选择告警类型</option>
                                <option value="value_limit" data-translate-option="ruleValueLimit">数值限制</option>
                                <option value="status_change" data-translate-option="ruleStatusChange">状态变化</option>
                                <option value="comm_interrupt" data-translate-option="ruleCommInterrupt">通信中断</option>
                                <option value="logic_combo" data-translate-option="ruleLogicCombo">逻辑组合</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;"><span data-translate="ruleExecLocation">执行位置</span> <span style="color: #ef4444;">*</span></label>
                            <div style="display: flex; gap: 24px; height: 40px; align-items: center;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="execLocation" value="gateway" style="margin-right: 8px;">
                                    <span data-translate="ruleGateway">网关</span>
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="execLocation" value="cloud" checked style="margin-right: 8px;">
                                    <span data-translate="ruleCloud">云端</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 动态配置区域 -->
                    <div id="dynamicConfigArea" style="background: #f8fafc; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; display: none;">
                        <!-- 数值限制配置 -->
                        <div id="valueLimitConfig" class="dynamic-config" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleParameter">监测参数</label>
                                    <select class="form-select" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                                        <option value="temperature">温度</option>
                                        <option value="voltage">电压</option>
                                        <option value="current">电流</option>
                                        <option value="soc">SOC</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleCondition">触发条件</label>
                                    <select class="form-select" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                                        <option value="gt">大于 (&gt;)</option>
                                        <option value="lt">小于 (&lt;)</option>
                                        <option value="gte">大于等于 (&gt;=)</option>
                                        <option value="lte">小于等于 (&lt;=)</option>
                                        <option value="eq">等于 (=)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleThreshold">阈值</label>
                                    <input type="number" class="form-input" placeholder="请输入阈值" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                                </div>
                            </div>
                        </div>

                        <!-- 状态变化配置 -->
                        <div id="statusChangeConfig" class="dynamic-config" style="display: none;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleFromStatus">原始状态</label>
                                    <select class="form-select" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                                        <option value="online">在线</option>
                                        <option value="offline">离线</option>
                                        <option value="fault">故障</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleToStatus">目标状态</label>
                                    <select class="form-select" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                                        <option value="online">在线</option>
                                        <option value="offline">离线</option>
                                        <option value="fault">故障</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- 通信中断配置 -->
                        <div id="commInterruptConfig" class="dynamic-config" style="display: none;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleTimeoutDuration">超时时长（分钟）</label>
                                <input type="number" class="form-input" placeholder="请输入超时时长" value="5" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                            </div>
                        </div>

                        <!-- 逻辑组合配置 -->
                        <div id="logicComboConfig" class="dynamic-config" style="display: none;">
                            <div style="background: #fef3c7; border: 1px solid #fde68a; border-radius: 8px; padding: 12px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
                                    <span style="font-size: 13px; color: #78350f;" data-translate="ruleLogicComboTip">逻辑组合功能正在开发中，敬请期待</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. 级别与通知 -->
                <div class="rule-section" style="margin-bottom: 32px;">
                    <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0 0 16px 0; display: flex; align-items: center; gap: 8px;">
                        <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #dbeafe; color: #3b82f6; border-radius: 6px; font-size: 14px;">4</span>
                        <span data-translate="ruleLevelNotification">级别与通知</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;"><span data-translate="ruleAlarmLevel">告警等级</span> <span style="color: #ef4444;">*</span></label>
                            <div style="display: flex; gap: 16px;">
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectAlarmLevel(this, 'critical')">
                                    <input type="radio" name="alarmLevel" value="critical" style="display: none;">
                                    <div style="text-align: center;">
                                        <i class="fas fa-exclamation-circle" style="font-size: 24px; color: #ef4444; display: block; margin-bottom: 8px;"></i>
                                        <span style="font-weight: 500;" data-translate="levelCritical">严重</span>
                                    </div>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectAlarmLevel(this, 'important')">
                                    <input type="radio" name="alarmLevel" value="important" style="display: none;">
                                    <div style="text-align: center;">
                                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #f59e0b; display: block; margin-bottom: 8px;"></i>
                                        <span style="font-weight: 500;" data-translate="levelImportant">重要</span>
                                    </div>
                                </label>
                                <label style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; transition: all 0.2s;" onclick="selectAlarmLevel(this, 'general')">
                                    <input type="radio" name="alarmLevel" value="general" style="display: none;">
                                    <div style="text-align: center;">
                                        <i class="fas fa-info-circle" style="font-size: 24px; color: #3b82f6; display: block; margin-bottom: 8px;"></i>
                                        <span style="font-weight: 500;" data-translate="levelGeneral">一般</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;"><span data-translate="ruleNotificationChannels">通知渠道</span> <span style="color: #ef4444;">*</span></label>
                            <div style="display: flex; gap: 16px;">
                                <label style="display: flex; align-items: center; padding: 12px 20px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" class="notification-channel" value="sms" style="margin-right: 8px;">
                                    <i class="fas fa-sms" style="margin-right: 8px; color: #3b82f6;"></i>
                                    <span data-translate="notifChannelSms">短信</span>
                                </label>
                                <label style="display: flex; align-items: center; padding: 12px 20px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" class="notification-channel" value="email" style="margin-right: 8px;">
                                    <i class="fas fa-envelope" style="margin-right: 8px; color: #10b981;"></i>
                                    <span data-translate="notifChannelEmail">邮箱</span>
                                </label>
                                <label style="display: flex; align-items: center; padding: 12px 20px; border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer;">
                                    <input type="checkbox" class="notification-channel" value="app" style="margin-right: 8px;">
                                    <i class="fas fa-mobile-alt" style="margin-right: 8px; color: #f59e0b;"></i>
                                    <span>App</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 14px; color: #475569; font-weight: 500;" data-translate="ruleSilencePeriod">静默周期（分钟）</label>
                            <input type="number" id="silencePeriod" class="form-input" placeholder="0表示不启用静默，留空默认30分钟" style="width: 100%; height: 40px; padding: 0 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
                            <p style="margin: 8px 0 0 0; font-size: 13px; color: var(--text-secondary);" data-translate="ruleSilenceTip">静默期间相同告警不会重复通知</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 模态框底部按钮 -->
            <div class="rule-modal-footer">
                <button class="btn btn-secondary" onclick="closeRuleModal()">
                    <i class="fas fa-times"></i>
                    <span data-translate="btnCancel">取消</span>
                </button>
                <button class="btn btn-primary" onclick="saveRule()">
                    <i class="fas fa-check"></i>
                    <span data-translate="btnSave">保存</span>
                </button>
            </div>
        </div>
    </div>

    <script src="navbar.js"></script>
    <script src="common.js"></script>
    <script src="notification-fix.js"></script>
    <script>
        // Toggle submenu
        function toggleSubmenu(element) {
            element.classList.toggle('expanded');
            const submenu = element.nextElementSibling;
            if (submenu && submenu.classList.contains('submenu')) {
                submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        // 检查登录状态
        checkAuth();
        
        // 设置当前页面菜单项
        setActiveMenuItem('rule-engine');

        // 规则数据
        let rulesData = [
            {
                id: 'rule001',
                name: '电池过温自动降功率',
                description: '当电池温度超过阈值时自动降低充放电功率',
                status: 'active',
                type: 'safety',
                trigger: {
                    type: 'parameter',
                    condition: '电池温度 > 55°C'
                },
                conditions: [
                    {
                        type: 'time',
                        value: '持续时间 > 5分钟'
                    },
                    {
                        type: 'status',
                        value: '系统状态 = 运行中'
                    }
                ],
                actions: [
                    {
                        type: 'control',
                        value: '降低充放电功率至50%'
                    },
                    {
                        type: 'notification',
                        value: '发送告警通知'
                    }
                ]
            },
            {
                id: 'rule002',
                name: 'SOC低自动充电',
                description: '当SOC低于设定值时自动启动充电',
                status: 'active',
                type: 'optimization',
                trigger: {
                    type: 'parameter',
                    condition: 'SOC < 20%'
                },
                conditions: [
                    {
                        type: 'time',
                        value: '时间段: 23:00-06:00'
                    },
                    {
                        type: 'price',
                        value: '电价 < 0.5元/kWh'
                    }
                ],
                actions: [
                    {
                        type: 'control',
                        value: '启动充电模式'
                    },
                    {
                        type: 'parameter',
                        value: '设置充电功率100kW'
                    }
                ]
            },
            {
                id: 'rule003',
                name: '通信中断重连',
                description: 'BMS通信中断时自动重连',
                status: 'active',
                type: 'maintenance',
                trigger: {
                    type: 'event',
                    condition: 'BMS通信中断'
                },
                conditions: [
                    {
                        type: 'count',
                        value: '重试次数 < 3'
                    }
                ],
                actions: [
                    {
                        type: 'system',
                        value: '重启通信模块'
                    },
                    {
                        type: 'wait',
                        value: '等待30秒'
                    },
                    {
                        type: 'system',
                        value: '重新建立连接'
                    }
                ]
            },
            {
                id: 'rule004',
                name: '峰谷电价优化',
                description: '根据峰谷电价自动调整充放电策略',
                status: 'inactive',
                type: 'optimization',
                trigger: {
                    type: 'schedule',
                    condition: '每日00:00执行'
                },
                conditions: [],
                actions: [
                    {
                        type: 'analysis',
                        value: '分析次日电价曲线'
                    },
                    {
                        type: 'planning',
                        value: '生成充放电计划'
                    },
                    {
                        type: 'execution',
                        value: '执行优化策略'
                    }
                ]
            },
            {
                id: 'rule005',
                name: '消防联动',
                description: '检测到火灾告警时的应急处理',
                status: 'active',
                type: 'safety',
                trigger: {
                    type: 'alarm',
                    condition: '火灾告警触发'
                },
                conditions: [],
                actions: [
                    {
                        type: 'emergency',
                        value: '立即切断主电源'
                    },
                    {
                        type: 'system',
                        value: '启动消防系统'
                    },
                    {
                        type: 'notification',
                        value: '发送紧急通知'
                    },
                    {
                        type: 'log',
                        value: '记录事件日志'
                    }
                ]
            }
        ];

        let currentRule = null;

        // 初始化页面
        function initializePage() {
            renderRuleList();
        }

        // Tab切换功能
        function switchTab(tabName) {
            // 更新按钮状态
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // 更新内容显示
            const panels = document.querySelectorAll('.tab-panel');
            panels.forEach(panel => panel.classList.remove('active'));

            if (tabName === 'template') {
                buttons[0].classList.add('active');
                document.getElementById('template-panel').classList.add('active');
            } else if (tabName === 'application') {
                buttons[1].classList.add('active');
                document.getElementById('application-panel').classList.add('active');
                // 渲染应用规则表格
                renderApplicationRulesTable();
            }
        }

        // 删除模版确认
        function confirmDeleteTemplate(templateType, event) {
            event.stopPropagation();
            const templateName = getTemplateName(templateType);
            
            // 创建自定义确认对话框
            const confirmDialog = document.createElement('div');
            confirmDialog.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease;
            `;
            
            const dialogContent = document.createElement('div');
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            dialogContent.style.cssText = `
                background: ${isDark ? '#1e293b' : 'white'};
                border-radius: 12px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                animation: slideUp 0.3s ease;
            `;
            
            dialogContent.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 16px;">
                    <div style="width: 48px; height: 48px; background: ${isDark ? 'rgba(239, 68, 68, 0.2)' : '#fee2e2'}; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 16px;">
                        <i class="fas fa-exclamation-triangle" style="color: ${isDark ? '#ef4444' : '#dc2626'}; font-size: 24px;"></i>
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: ${isDark ? '#f3f4f6' : '#111827'};">删除确认</h3>
                        <p style="margin: 4px 0 0 0; font-size: 14px; color: ${isDark ? '#9ca3af' : '#6b7280'};">此操作不可恢复</p>
                    </div>
                </div>
                <p style="margin-bottom: 24px; color: ${isDark ? '#d1d5db' : '#374151'}; line-height: 1.5;">
                    确定要删除规则模版 "<strong style="color: ${isDark ? '#f3f4f6' : '#111827'};">${templateName}</strong>" 吗？删除后，基于此模版创建的规则不会受到影响。
                </p>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="this.closest('[style*=\"z-index: 10000\"]').remove()" class="btn btn-secondary" style="height: 36px; padding: 0 20px; background: ${isDark ? '#334155' : 'white'}; border: 1px solid ${isDark ? '#475569' : '#e5e7eb'}; color: ${isDark ? '#e2e8f0' : '#6b7280'};">
                        取消
                    </button>
                    <button onclick="deleteTemplate('${templateType}', event)" class="btn btn-danger" style="height: 36px; padding: 0 20px; background: #ef4444; color: white; border: none;">
                        确认删除
                    </button>
                </div>
            `;
            
            confirmDialog.appendChild(dialogContent);
            document.body.appendChild(confirmDialog);
        }
        
        // 删除模版
        function deleteTemplate(templateType, event) {
            // 先关闭确认对话框
            const dialog = document.querySelector('[style*="z-index: 10000"]');
            if (dialog) {
                dialog.remove();
            }
            
            // 查找并删除对应的模版卡片
            const allCards = document.querySelectorAll('.template-card');
            let deleted = false;
            
            allCards.forEach(card => {
                // 检查卡片中是否包含对应的删除按钮
                const deleteBtn = card.querySelector('.template-icon-btn.delete');
                if (deleteBtn && deleteBtn.getAttribute('onclick') && 
                    deleteBtn.getAttribute('onclick').includes(`confirmDeleteTemplate('${templateType}'`)) {
                    card.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        card.remove();
                    }, 300);
                    deleted = true;
                }
            });
            
            if (deleted) {
                showNotification(`${getTemplateName(templateType)} 已成功删除`, 'success');
            }
        }

        // 查看模版详情
        function viewTemplateDetails(templateType, event) {
            event.stopPropagation();
            // 跳转到模版详情页面
            window.location.href = `template-details.html?type=${templateType}`;
        }

        // 应用模版 - 打开配置向导
        function applyTemplate(templateType, event) {
            event.stopPropagation();

            // 设置向导标题
            document.getElementById('wizardTemplateTitle').textContent = getTemplateName(templateType);

            // 显示向导模态框
            const modal = document.getElementById('templateWizardModal');
            modal.style.display = 'flex';

            // 重置向导到第一步
            currentWizardStep = 1;
            updateWizardStep();

            // 保存当前模版类型
            currentTemplateType = templateType;
        }

        // 向导状态变量
        let currentWizardStep = 1;
        let currentTemplateType = null;

        // 关闭向导
        function closeWizard() {
            document.getElementById('templateWizardModal').style.display = 'none';
        }

        // 下一步
        function wizardNextStep() {
            if (currentWizardStep < 4) {
                currentWizardStep++;
                updateWizardStep();
            }
        }

        // 上一步
        function wizardPrevStep() {
            if (currentWizardStep > 1) {
                currentWizardStep--;
                updateWizardStep();
            }
        }

        // 更新向导步骤显示
        function updateWizardStep() {
            // 隐藏所有内容
            document.querySelectorAll('.wizard-content').forEach(content => {
                content.style.display = 'none';
            });

            // 显示当前步骤
            document.getElementById('wizardStep' + currentWizardStep).style.display = 'block';

            // 更新步骤指示器
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNum = index + 1;
                const stepIndicator = step.querySelector('.step-indicator');
                const stepText = step.querySelector('div:last-child');

                if (stepNum < currentWizardStep) {
                    // 已完成的步骤
                    stepIndicator.style.background = '#10b981';
                    stepIndicator.style.color = 'white';
                    stepIndicator.innerHTML = '<i class="fas fa-check"></i>';
                    stepText.style.color = '#10b981';
                } else if (stepNum === currentWizardStep) {
                    // 当前步骤
                    stepIndicator.style.background = '#3562E3';
                    stepIndicator.style.color = 'white';
                    stepIndicator.textContent = stepNum;
                    stepText.style.color = '#1e293b';
                    stepText.style.fontWeight = '500';
                } else {
                    // 未完成的步骤
                    stepIndicator.style.background = '#cbd5e1';
                    stepIndicator.style.color = '#64748b';
                    stepIndicator.textContent = stepNum;
                    stepText.style.color = '#64748b';
                    stepText.style.fontWeight = 'normal';
                }
            });

            // 更新进度线
            const progress = ((currentWizardStep - 1) / 3) * 100;
            document.getElementById('wizardProgressLine').style.width = progress + '%';

            // 更新按钮显示
            document.getElementById('wizardPrevBtn').style.display = currentWizardStep > 1 ? 'block' : 'none';
            document.getElementById('wizardNextBtn').style.display = currentWizardStep < 4 ? 'block' : 'none';
            document.getElementById('wizardFinishBtn').style.display = currentWizardStep === 4 ? 'block' : 'none';
        }

        // 切换邮件配置显示
        function toggleEmailConfig(checked) {
            document.getElementById('emailConfigSection').style.display = checked ? 'block' : 'none';
        }

        // 切换短信配置显示
        function toggleSMSConfig(checked) {
            document.getElementById('smsConfigSection').style.display = checked ? 'block' : 'none';
        }

        // 更新范围选项
        function updateScopeOptions(scope) {
            // TODO: 根据选择的范围(站点/设备)更新列表
            showNotification('切换到' + (scope === 'site' ? '站点模式' : '设备模式'), 'info');
        }

        // 测试规则
        function testRule() {
            showNotification('正在运行规则测试...', 'info');

            // 模拟测试过程
            setTimeout(() => {
                const testResults = `
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 12px; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); z-index: 10001; min-width: 400px;">
                        <h3 style="margin: 0 0 16px 0; color: #1e293b; display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-check-circle" style="color: #10b981; font-size: 24px;"></i>
                            测试通过
                        </h3>
                        <div style="background: #f8fafc; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 12px;">测试结果:</div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-check" style="color: #10b981;"></i>
                                    <span style="color: #1e293b; font-size: 13px;">触发条件验证通过</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-check" style="color: #10b981;"></i>
                                    <span style="color: #1e293b; font-size: 13px;">通知渠道配置正确</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-check" style="color: #10b981;"></i>
                                    <span style="color: #1e293b; font-size: 13px;">执行动作可正常触发</span>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="this.closest('[style*=\\"z-index: 10001\\"]').remove()" style="width: 100%;">
                            确定
                        </button>
                    </div>
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000;" onclick="this.nextElementSibling.remove(); this.remove();"></div>
                `;
                document.body.insertAdjacentHTML('beforeend', testResults);
            }, 1500);
        }

        // 完成向导
        function finishWizard() {
            // 创建基于模版的规则
            createRuleFromTemplate(currentTemplateType);

            // 关闭向导
            closeWizard();

            // 切换到规则应用tab
            switchTab('application');

            showNotification('规则应用成功!', 'success');
        }

        // 获取模版名称
        function getTemplateName(templateType) {
            const names = {
                'temperature': '标准模版',
                'battery': '自定义模版 1',
                'pricing': '自定义模版 2',
                'safety': '自定义模版 3',
                'linkage': '自定义模版 4',
                'energy': '自定义模版 5'
            };
            return names[templateType] || '未知模版';
        }

        // 搜索模版
        function searchTemplates(keyword) {
            const cards = document.querySelectorAll('.template-card');
            cards.forEach(card => {
                const name = card.querySelector('.template-name').textContent.toLowerCase();
                const remark = card.querySelector('.template-remark').textContent.toLowerCase();
                const searchTerm = keyword.toLowerCase();
                
                if (name.includes(searchTerm) || remark.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // 按类型筛选
        function filterTemplates(type) {
            const cards = document.querySelectorAll('.template-card');
            cards.forEach(card => {
                if (type === 'all') {
                    card.style.display = 'block';
                } else {
                    const category = card.querySelector('.template-meta-item').textContent;
                    if (type === 'safety' && category.includes('安全防护')) {
                        card.style.display = 'block';
                    } else if (type === 'optimization' && category.includes('优化控制')) {
                        card.style.display = 'block';
                    } else if (type === 'maintenance' && category.includes('运维管理')) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        }

        // 按状态筛选
        function filterByStatus(status) {
            const cards = document.querySelectorAll('.template-card');
            cards.forEach(card => {
                const badge = card.querySelector('.status-badge');
                const isActive = badge.classList.contains('active');
                
                if (status === 'all') {
                    card.style.display = 'block';
                } else if (status === 'active' && isActive) {
                    card.style.display = 'block';
                } else if (status === 'inactive' && !isActive) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // 创建新模版
        function createNewTemplate() {
            showNotification('打开新建模版对话框', 'info');
            // 这里可以打开一个模态框来创建新模版
        }

        // 切换模版状态
        function toggleTemplateStatus(templateType, isChecked) {
            const card = event.target.closest('.template-card');
            const statusText = card.querySelector('.status-text');
            
            if (isChecked) {
                statusText.textContent = '启用';
                statusText.style.color = '#10b981';
            } else {
                statusText.textContent = '禁用';
                statusText.style.color = '#dc2626';
            }
            
            showNotification(`${getTemplateName(templateType)} 已${isChecked ? '启用' : '禁用'}`, 'success');
        }

        // 复制模版
        function copyTemplate(templateType, event) {
            event.stopPropagation();
            console.log('复制模版被点击:', templateType);
            
            // 获取当前模版卡片数量
            const templateCards = document.querySelectorAll('.template-card');
            console.log('找到模版卡片数量:', templateCards.length);
            const customCount = templateCards.length - 1; // 减去标准模版
            const newNumber = customCount + 1;
            console.log('新模版编号:', newNumber);
            
            // 创建新的模版ID
            const newTemplateType = 'custom_' + Date.now();
            
            // 获取原模版的状态
            const originalCard = event.target.closest('.template-card');
            const isEnabled = originalCard.querySelector('.switch input').checked;
            
            // 创建新的模版卡片
            const newCard = document.createElement('div');
            newCard.className = 'template-card';
            newCard.setAttribute('onclick', `selectTemplate('${newTemplateType}')`);
            
            newCard.innerHTML = `
                <div class="template-actions-group">
                    <button class="template-icon-btn copy" onclick="copyTemplate('${newTemplateType}', event)" title="复制模版">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="template-icon-btn delete" onclick="confirmDeleteTemplate('${newTemplateType}', event)" title="删除模版">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="template-header">
                    <div class="template-info">
                        <h3 class="template-title">自定义模版复制${newNumber}</h3>
                    </div>
                </div>
                <div class="notification-methods">
                    <div class="notification-label">通知方式：</div>
                    <div class="notification-list">
                        <span class="notification-item">消息弹窗</span>
                        <span class="notification-item">邮箱</span>
                    </div>
                </div>
                <div class="template-status" style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 14px; color: var(--text-secondary);">状态：</span>
                    <label class="switch">
                        <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="toggleTemplateStatus('${newTemplateType}', this.checked)">
                        <span class="switch-slider"></span>
                    </label>
                    <span class="status-text" style="font-size: 14px; color: ${isEnabled ? '#10b981' : '#dc2626'};">${isEnabled ? '启用' : '禁用'}</span>
                </div>
                <div class="template-time" style="margin-bottom: 24px; font-size: 13px; color: var(--text-secondary);">
                    修改时间：${new Date().toLocaleString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false}).replace(/\//g, '-')}
                </div>
                <div class="template-actions">
                    <button class="btn btn-secondary" onclick="viewTemplateDetails('${newTemplateType}', event)">
                        详情
                    </button>
                    <button class="btn btn-primary" onclick="applyTemplate('${newTemplateType}', event)">
                        应用
                    </button>
                </div>
            `;
            
            // 添加到模版列表末尾
            const templateGrid = document.querySelector('.template-grid');
            console.log('模版网格容器:', templateGrid);
            if (templateGrid) {
                templateGrid.appendChild(newCard);
                console.log('新模版已添加到DOM');
                
                // 添加淡入动画
                newCard.style.animation = 'fadeIn 0.5s ease';
                
                showNotification(`成功复制为"自定义模版复制${newNumber}"`, 'success');
            } else {
                console.error('未找到.template-grid容器');
            }
        }

        // 新建模版
        function createNewTemplate() {
            window.location.href = 'template-create.html';
        }

        // 基于模版创建规则
        function createRuleFromTemplate(templateType) {
            const templates = {
                'temperature': {
                    name: '温度异常保护规则',
                    description: '基于温度异常监控模版创建的规则',
                    type: 'safety',
                    trigger: { type: 'parameter', condition: '温度 > 45°C' },
                    conditions: [{ type: 'time', value: '持续时间 > 3分钟' }],
                    actions: [
                        { type: 'control', value: '降低充放电功率至70%' },
                        { type: 'notification', value: '发送温度告警通知' }
                    ]
                },
                'battery': {
                    name: '电池健康保护规则',
                    description: '基于电池健康管理模版创建的规则',
                    type: 'optimization',
                    trigger: { type: 'parameter', condition: 'SOH < 80%' },
                    conditions: [],
                    actions: [
                        { type: 'control', value: '限制充电功率' },
                        { type: 'notification', value: '发送电池健康告警' }
                    ]
                },
                'pricing': {
                    name: '峰谷电价优化规则',
                    description: '基于峰谷电价策略模版创建的规则',
                    type: 'optimization',
                    trigger: { type: 'schedule', condition: '每日执行' },
                    conditions: [],
                    actions: [
                        { type: 'analysis', value: '分析电价时段' },
                        { type: 'control', value: '调整充放电策略' }
                    ]
                }
            };

            const template = templates[templateType] || templates['temperature'];
            const newRule = {
                id: 'rule' + Date.now(),
                status: 'inactive',
                ...template
            };
            
            rulesData.unshift(newRule);
            currentRule = newRule;
            renderRuleList();
            renderRuleEditor();
            showNotification(`已基于${getTemplateName(templateType)}模版创建新规则`, 'success');
        }

        // 渲染规则列表
        function renderRuleList() {
            const ruleList = document.getElementById('ruleList');

            // 如果元素不存在，直接返回（模板面板已改为静态表格）
            if (!ruleList) return;

            ruleList.innerHTML = rulesData.map(rule => `
                <div class="rule-item ${currentRule && currentRule.id === rule.id ? 'active' : ''}" 
                     onclick="selectRule('${rule.id}')">
                    <div class="rule-item-header">
                        <span class="rule-item-name">${rule.name}</span>
                        <div class="rule-item-status">
                            <span class="status-dot ${rule.status}"></span>
                            <span>${rule.status === 'active' ? '启用' : '停用'}</span>
                        </div>
                    </div>
                    <div class="rule-item-desc">${rule.description}</div>
                </div>
            `).join('');
        }

        // 选择规则
        function selectRule(ruleId) {
            currentRule = rulesData.find(r => r.id === ruleId);
            renderRuleList();
            renderRuleEditor();
        }

        // 渲染规则编辑器
        function renderRuleEditor() {
            if (!currentRule) return;

            const editorContent = document.getElementById('ruleEditorContent');
            
            editorContent.innerHTML = `
                <div class="rule-editor-header">
                    <h2 class="rule-editor-title">${currentRule.name}</h2>
                    <div class="rule-editor-actions">
                        <button class="btn ${currentRule.status === 'active' ? 'btn-danger' : 'btn-success'}" 
                                onclick="toggleRuleStatus('${currentRule.id}')">
                            <i class="fas ${currentRule.status === 'active' ? 'fa-pause' : 'fa-play'}"></i>
                            ${currentRule.status === 'active' ? '停用' : '启用'}
                        </button>
                        <button class="btn" onclick="saveRule()">
                            <i class="fas fa-save"></i>
                            保存
                        </button>
                        <button class="btn btn-danger" onclick="deleteRule('${currentRule.id}')">
                            <i class="fas fa-trash"></i>
                            删除
                        </button>
                    </div>
                </div>
                <div class="rule-editor-content">
                    <!-- 规则流程图 -->
                    <div class="rule-flow-diagram">
                        <!-- 触发器 -->
                        <div class="flow-node">
                            <div class="flow-node-header">
                                <div class="flow-node-icon trigger">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="flow-node-title">触发器</div>
                            </div>
                            <div class="flow-node-content">
                                ${currentRule.trigger.condition}
                            </div>
                        </div>
                        
                        ${currentRule.conditions.length > 0 ? `
                            <div class="flow-connector">
                                <div class="flow-connector-line"></div>
                                <div class="flow-connector-arrow"></div>
                            </div>
                            
                            <!-- 条件 -->
                            <div class="flow-node">
                                <div class="flow-node-header">
                                    <div class="flow-node-icon condition">
                                        <i class="fas fa-filter"></i>
                                    </div>
                                    <div class="flow-node-title">条件判断</div>
                                </div>
                                <div class="flow-node-content">
                                    ${currentRule.conditions.map(c => c.value).join(' 且 ')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="flow-connector">
                            <div class="flow-connector-line"></div>
                            <div class="flow-connector-arrow"></div>
                        </div>
                        
                        <!-- 动作 -->
                        <div class="flow-node">
                            <div class="flow-node-header">
                                <div class="flow-node-icon action">
                                    <i class="fas fa-play"></i>
                                </div>
                                <div class="flow-node-title">执行动作</div>
                            </div>
                            <div class="flow-node-content">
                                ${currentRule.actions.map((a, i) => `${i + 1}. ${a.value}`).join('<br>')}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 规则属性 -->
                    <div class="rule-properties">
                        <div class="property-group">
                            <h4 class="property-group-title">基本信息</h4>
                            <div class="property-row">
                                <label class="property-label">规则名称</label>
                                <div class="property-value">
                                    <input type="text" class="form-input" value="${currentRule.name}" 
                                           onchange="updateRuleName(this.value)">
                                </div>
                            </div>
                            <div class="property-row">
                                <label class="property-label">规则描述</label>
                                <div class="property-value">
                                    <textarea class="form-textarea" rows="2" 
                                              onchange="updateRuleDescription(this.value)">${currentRule.description}</textarea>
                                </div>
                            </div>
                            <div class="property-row">
                                <label class="property-label">规则类型</label>
                                <div class="property-value">
                                    <select class="form-select" onchange="updateRuleType(this.value)">
                                        <option value="safety" ${currentRule.type === 'safety' ? 'selected' : ''}>安全保护</option>
                                        <option value="optimization" ${currentRule.type === 'optimization' ? 'selected' : ''}>优化控制</option>
                                        <option value="maintenance" ${currentRule.type === 'maintenance' ? 'selected' : ''}>运维管理</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="property-group">
                            <h4 class="property-group-title">执行设置</h4>
                            <div class="property-row">
                                <label class="property-label">优先级</label>
                                <div class="property-value">
                                    <select class="form-select">
                                        <option value="high">高</option>
                                        <option value="medium" selected>中</option>
                                        <option value="low">低</option>
                                    </select>
                                </div>
                            </div>
                            <div class="property-row">
                                <label class="property-label">执行间隔</label>
                                <div class="property-value">
                                    <input type="number" class="form-input" value="60" style="width: 100px;">
                                    <span style="color: var(--text-secondary); font-size: 13px;">秒</span>
                                </div>
                            </div>
                            <div class="property-row">
                                <label class="property-label">失败重试</label>
                                <div class="property-value">
                                    <label class="switch">
                                        <input type="checkbox" checked>
                                        <span class="switch-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 创建新规则
        function createNewRule() {
            const newRule = {
                id: 'rule' + Date.now(),
                name: '新规则',
                description: '请输入规则描述',
                status: 'inactive',
                type: 'optimization',
                trigger: {
                    type: 'parameter',
                    condition: '请设置触发条件'
                },
                conditions: [],
                actions: [
                    {
                        type: 'control',
                        value: '请设置执行动作'
                    }
                ]
            };
            
            rulesData.unshift(newRule);
            currentRule = newRule;
            renderRuleList();
            renderRuleEditor();
            showNotification('新规则创建成功', 'success');
        }

        // 切换规则状态
        function toggleRuleStatus(ruleId) {
            const rule = rulesData.find(r => r.id === ruleId);
            if (rule) {
                rule.status = rule.status === 'active' ? 'inactive' : 'active';
                renderRuleList();
                renderRuleEditor();
                showNotification(`规则已${rule.status === 'active' ? '启用' : '停用'}`, 'success');
            }
        }

        // 保存规则
        function saveRule() {
            // 这里应该有实际的保存逻辑
            showNotification('规则保存成功', 'success');
        }

        // 删除规则
        function deleteRule(ruleId) {
            if (confirm('确定要删除这个规则吗？')) {
                rulesData = rulesData.filter(r => r.id !== ruleId);
                currentRule = null;
                renderRuleList();
                document.getElementById('ruleEditorContent').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-code-branch empty-state-icon"></i>
                        <div class="empty-state-text">选择或创建规则</div>
                        <div class="empty-state-subtext">从左侧列表选择规则进行编辑，或创建新规则</div>
                    </div>
                `;
                showNotification('规则删除成功', 'success');
            }
        }

        // 搜索规则
        function searchRules(keyword) {
            const filteredRules = keyword 
                ? rulesData.filter(r => 
                    r.name.includes(keyword) || 
                    r.description.includes(keyword)
                  )
                : rulesData;
            
            const ruleList = document.getElementById('ruleList');
            ruleList.innerHTML = filteredRules.map(rule => `
                <div class="rule-item ${currentRule && currentRule.id === rule.id ? 'active' : ''}" 
                     onclick="selectRule('${rule.id}')">
                    <div class="rule-item-header">
                        <span class="rule-item-name">${rule.name}</span>
                        <div class="rule-item-status">
                            <span class="status-dot ${rule.status}"></span>
                            <span>${rule.status === 'active' ? '启用' : '停用'}</span>
                        </div>
                    </div>
                    <div class="rule-item-desc">${rule.description}</div>
                </div>
            `).join('');
        }

        // 刷新规则列表
        function refreshRuleList() {
            // 这里应该有实际的刷新逻辑
            renderRuleList();
            showNotification('规则列表已刷新', 'success');
        }

        // 更新规则名称
        function updateRuleName(value) {
            if (currentRule) {
                currentRule.name = value;
                renderRuleList();
            }
        }

        // 更新规则描述
        function updateRuleDescription(value) {
            if (currentRule) {
                currentRule.description = value;
                renderRuleList();
            }
        }

        // 更新规则类型
        function updateRuleType(value) {
            if (currentRule) {
                currentRule.type = value;
            }
        }

        // ========== 规则应用相关功能 ==========

        // 应用规则数据（用于规则应用标签页）
        let applicationRules = [
            {
                id: 'app_rule001',
                name: '电池温度预警',
                targetObject: '上海浦东站点 / 储能柜 #01',
                execLocation: 'cloud',
                alarmType: 'value_limit',
                alarmLevel: 'critical',
                createTime: '2024-01-15 10:30:00',
                status: 'active',
                config: {
                    parameter: 'temperature',
                    condition: 'gt',
                    threshold: 55
                },
                notificationChannels: ['sms', 'email'],
                silencePeriod: 30
            },
            {
                id: 'app_rule002',
                name: 'SOC低告警',
                targetObject: '北京朝阳站点',
                execLocation: 'gateway',
                alarmType: 'value_limit',
                alarmLevel: 'important',
                createTime: '2024-01-16 14:20:00',
                status: 'pending', // 待下发状态
                config: {
                    parameter: 'soc',
                    condition: 'lt',
                    threshold: 20
                },
                notificationChannels: ['email'],
                silencePeriod: 60
            },
            {
                id: 'app_rule003',
                name: '设备通信中断',
                targetObject: '全部站点',
                execLocation: 'cloud',
                alarmType: 'comm_interrupt',
                alarmLevel: 'critical',
                createTime: '2024-01-17 09:15:00',
                status: 'active',
                config: {
                    timeout: 5
                },
                notificationChannels: ['sms', 'email', 'app'],
                silencePeriod: 0
            },
            {
                id: 'app_rule004',
                name: '设备离线预警',
                targetObject: '深圳南山站点 / 储能柜 #05',
                execLocation: 'gateway',
                alarmType: 'status_change',
                alarmLevel: 'general',
                createTime: '2024-01-18 16:45:00',
                status: 'inactive',
                config: {
                    fromStatus: 'online',
                    toStatus: 'offline'
                },
                notificationChannels: ['email'],
                silencePeriod: 30
            }
        ];

        // 打开规则模态框
        function openRuleModal(ruleId = null) {
            const modal = document.getElementById('ruleModal');
            const title = document.getElementById('ruleModalTitle');

            if (ruleId) {
                // 编辑模式
                title.textContent = getTranslation('ruleEditRule') || '编辑规则';
                const rule = applicationRules.find(r => r.id === ruleId);
                if (rule) {
                    loadRuleData(rule);
                }
            } else {
                // 新建模式
                title.textContent = getTranslation('ruleNewRule') || '新建规则';
                resetRuleForm();
            }

            modal.style.display = 'flex';
            // 应用翻译
            if (typeof setLanguage === 'function') {
                setLanguage(currentLang);
            }
        }

        // 关闭规则模态框
        function closeRuleModal() {
            document.getElementById('ruleModal').style.display = 'none';
            resetRuleForm();
        }

        // 重置规则表单
        function resetRuleForm() {
            document.getElementById('ruleName').value = '';
            document.getElementById('ruleDescription').value = '';
            document.getElementById('alarmType').value = '';
            document.getElementById('silencePeriod').value = '';

            // 重置复选框
            document.querySelectorAll('.object-checkbox').forEach(cb => cb.checked = false);
            document.querySelectorAll('.notification-channel').forEach(cb => cb.checked = false);

            // 重置单选按钮
            document.querySelectorAll('input[name="execLocation"]').forEach(radio => {
                radio.checked = radio.value === 'cloud';
            });
            document.querySelectorAll('input[name="alarmLevel"]').forEach(radio => {
                radio.checked = false;
                radio.parentElement.style.borderColor = 'var(--border-color)';
                radio.parentElement.style.background = 'white';
            });

            // 隐藏动态配置区
            document.getElementById('dynamicConfigArea').style.display = 'none';
        }

        // 加载规则数据到表单（编辑模式）
        function loadRuleData(rule) {
            document.getElementById('ruleName').value = rule.name;
            document.getElementById('ruleDescription').value = rule.description || '';
            document.getElementById('alarmType').value = rule.alarmType;
            document.getElementById('silencePeriod').value = rule.silencePeriod;

            // 设置执行位置
            document.querySelectorAll('input[name="execLocation"]').forEach(radio => {
                radio.checked = radio.value === rule.execLocation;
            });

            // 设置告警等级
            if (rule.alarmLevel) {
                const levelInput = document.querySelector(`input[name="alarmLevel"][value="${rule.alarmLevel}"]`);
                if (levelInput) {
                    selectAlarmLevel(levelInput.parentElement, rule.alarmLevel);
                }
            }

            // 设置通知渠道
            rule.notificationChannels.forEach(channel => {
                const checkbox = document.querySelector(`.notification-channel[value="${channel}"]`);
                if (checkbox) checkbox.checked = true;
            });

            // 更新动态配置
            updateDynamicConfig(rule.alarmType);
        }

        // 更新动态配置区域（根据告警类型切换）
        function updateDynamicConfig(alarmType) {
            const dynamicArea = document.getElementById('dynamicConfigArea');
            const configs = document.querySelectorAll('.dynamic-config');

            // 隐藏所有配置
            configs.forEach(config => config.style.display = 'none');

            if (alarmType) {
                dynamicArea.style.display = 'block';

                // 显示对应的配置
                const configMap = {
                    'value_limit': 'valueLimitConfig',
                    'status_change': 'statusChangeConfig',
                    'comm_interrupt': 'commInterruptConfig',
                    'logic_combo': 'logicComboConfig'
                };

                const targetConfig = document.getElementById(configMap[alarmType]);
                if (targetConfig) {
                    targetConfig.style.display = 'block';
                }
            } else {
                dynamicArea.style.display = 'none';
            }
        }

        // 选择告警等级
        function selectAlarmLevel(element, level) {
            // 重置所有级别选项
            document.querySelectorAll('input[name="alarmLevel"]').forEach(radio => {
                radio.checked = false;
                radio.parentElement.style.borderColor = 'var(--border-color)';
                radio.parentElement.style.background = 'white';
            });

            // 设置选中的级别
            const input = element.querySelector('input[name="alarmLevel"]');
            if (input) {
                input.checked = true;

                // 根据级别设置边框颜色
                const colors = {
                    'critical': '#ef4444',
                    'important': '#f59e0b',
                    'general': '#3b82f6'
                };

                element.style.borderColor = colors[level] || 'var(--border-color)';
                element.style.background = level ? '#f8fafc' : 'white';
            }
        }

        // 保存规则（从模态框）
        function saveRule() {
            // 获取表单数据
            const ruleName = document.getElementById('ruleName').value.trim();
            const ruleDescription = document.getElementById('ruleDescription').value.trim();
            const alarmType = document.getElementById('alarmType').value;
            const silencePeriod = document.getElementById('silencePeriod').value || 30;

            // 验证必填项
            if (!ruleName) {
                showNotification(getTranslation('ruleNameRequired') || '请输入规则名称', 'error');
                return;
            }

            if (!alarmType) {
                showNotification(getTranslation('ruleAlarmTypeRequired') || '请选择告警类型', 'error');
                return;
            }

            // 获取告警对象
            const selectedObjects = Array.from(document.querySelectorAll('.object-checkbox:checked'))
                .map(cb => ({
                    type: cb.dataset.type,
                    id: cb.dataset.id,
                    name: cb.parentElement.textContent.trim()
                }));

            if (selectedObjects.length === 0) {
                showNotification(getTranslation('ruleObjectRequired') || '请选择告警对象', 'error');
                return;
            }

            // 获取执行位置
            const execLocation = document.querySelector('input[name="execLocation"]:checked')?.value || 'cloud';

            // 获取告警等级
            const alarmLevel = document.querySelector('input[name="alarmLevel"]:checked')?.value;
            if (!alarmLevel) {
                showNotification(getTranslation('ruleAlarmLevelRequired') || '请选择告警等级', 'error');
                return;
            }

            // 获取通知渠道
            const notificationChannels = Array.from(document.querySelectorAll('.notification-channel:checked'))
                .map(cb => cb.value);

            if (notificationChannels.length === 0) {
                showNotification(getTranslation('ruleChannelRequired') || '请至少选择一个通知渠道', 'error');
                return;
            }

            // 创建新规则对象
            const newRule = {
                id: 'app_rule' + Date.now(),
                name: ruleName,
                description: ruleDescription,
                targetObject: selectedObjects.map(o => o.name).join(' / '),
                execLocation: execLocation,
                alarmType: alarmType,
                alarmLevel: alarmLevel,
                createTime: new Date().toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                status: execLocation === 'gateway' ? 'pending' : 'active',
                notificationChannels: notificationChannels,
                silencePeriod: parseInt(silencePeriod),
                config: {} // 这里应该根据alarmType收集具体配置
            };

            // 添加到规则列表
            applicationRules.unshift(newRule);

            // 刷新表格
            renderApplicationRulesTable();

            // 关闭模态框
            closeRuleModal();

            // 显示成功消息
            showNotification(getTranslation('ruleSaveSuccess') || '规则保存成功', 'success');
        }

        // 渲染规则应用表格
        function renderApplicationRulesTable() {
            const tbody = document.getElementById('applicationRulesTableBody');

            if (!tbody) {
                console.error('表格body元素未找到');
                return;
            }

            if (applicationRules.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="no-data-cell">
                            <i class="fas fa-inbox no-data-icon"></i>
                            <span data-translate="ruleNoData">暂无规则数据，点击"新建规则"开始创建</span>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = applicationRules.map(rule => {
                // 告警类型映射
                const alarmTypeMap = {
                    'value_limit': getTranslation('ruleValueLimit') || '数值限制',
                    'status_change': getTranslation('ruleStatusChange') || '状态变化',
                    'comm_interrupt': getTranslation('ruleCommInterrupt') || '通信中断',
                    'logic_combo': getTranslation('ruleLogicCombo') || '逻辑组合'
                };

                // 告警等级映射
                const levelMap = {
                    'critical': getTranslation('levelCritical') || '严重',
                    'important': getTranslation('levelImportant') || '重要',
                    'general': getTranslation('levelGeneral') || '一般'
                };

                // 状态映射
                const statusMap = {
                    'active': getTranslation('statusActive') || '运行中',
                    'inactive': getTranslation('statusInactive') || '已停用',
                    'pending': getTranslation('statusPending') || '待下发'
                };

                // 执行位置映射
                const locationMap = {
                    'gateway': getTranslation('ruleGateway') || '网关',
                    'cloud': getTranslation('ruleCloud') || '云端'
                };

                return `
                    <tr>
                        <td class="rule-name-cell">
                            <div class="rule-name">${rule.name}</div>
                            ${rule.description ? `<div class="rule-description">${rule.description}</div>` : ''}
                        </td>
                        <td class="rule-target-cell">${rule.targetObject}</td>
                        <td>
                            <span class="location-badge ${rule.execLocation}">
                                <i class="fas ${rule.execLocation === 'gateway' ? 'fa-server' : 'fa-cloud'}"></i>
                                ${locationMap[rule.execLocation]}
                            </span>
                        </td>
                        <td class="alarm-type-cell">
                            <span class="alarm-type-tag">${alarmTypeMap[rule.alarmType] || rule.alarmType}</span>
                        </td>
                        <td>
                            <span class="alarm-level-badge ${rule.alarmLevel}">
                                <i class="fas fa-circle badge-dot"></i>
                                ${levelMap[rule.alarmLevel] || rule.alarmLevel}
                            </span>
                        </td>
                        <td class="rule-time-cell">${rule.createTime}</td>
                        <td>
                            <span class="rule-status-badge ${rule.status}">
                                <i class="fas fa-circle badge-dot"></i>
                                ${statusMap[rule.status] || rule.status}
                            </span>
                        </td>
                        <td class="rule-actions-cell">
                            <div class="rule-actions">
                                <button class="rule-action-btn edit" onclick="editApplicationRule('${rule.id}')" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="rule-action-btn ${rule.status === 'active' ? 'pause' : 'play'}" onclick="toggleApplicationRuleStatus('${rule.id}')" title="${rule.status === 'active' ? '停用' : '启用'}">
                                    <i class="fas ${rule.status === 'active' ? 'fa-pause' : 'fa-play'}"></i>
                                </button>
                                <button class="rule-action-btn delete" onclick="deleteApplicationRule('${rule.id}')" title="删除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // 应用翻译
            if (typeof setLanguage === 'function') {
                setLanguage(currentLang);
            }
        }

        // 编辑应用规则
        function editApplicationRule(ruleId) {
            openRuleModal(ruleId);
        }

        // 切换应用规则状态
        function toggleApplicationRuleStatus(ruleId) {
            const rule = applicationRules.find(r => r.id === ruleId);
            if (rule) {
                if (rule.status === 'active') {
                    rule.status = 'inactive';
                } else if (rule.status === 'inactive') {
                    rule.status = rule.execLocation === 'gateway' ? 'pending' : 'active';
                } else if (rule.status === 'pending') {
                    rule.status = 'active';
                }
                renderApplicationRulesTable();
                showNotification(
                    rule.status === 'active' ? (getTranslation('ruleActivated') || '规则已启用') :
                    rule.status === 'inactive' ? (getTranslation('ruleDeactivated') || '规则已停用') :
                    (getTranslation('rulePending') || '规则待下发'),
                    'success'
                );
            }
        }

        // 删除应用规则
        function deleteApplicationRule(ruleId) {
            if (confirm(getTranslation('ruleDeleteConfirm') || '确定要删除这条规则吗？')) {
                applicationRules = applicationRules.filter(r => r.id !== ruleId);
                renderApplicationRulesTable();
                showNotification(getTranslation('ruleDeleteSuccess') || '规则删除成功', 'success');
            }
        }

        // 搜索应用规则
        function searchApplicationRules(keyword) {
            if (!keyword) {
                renderApplicationRulesTable();
                return;
            }

            const filteredRules = applicationRules.filter(rule =>
                rule.name.includes(keyword) ||
                (rule.description && rule.description.includes(keyword)) ||
                rule.targetObject.includes(keyword)
            );

            const tbody = document.getElementById('applicationRulesTableBody');
            if (filteredRules.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-search" style="font-size: 48px; display: block; margin-bottom: 16px; opacity: 0.5;"></i>
                            <span data-translate="ruleNoSearchResult">未找到匹配的规则</span>
                        </td>
                    </tr>
                `;
                return;
            }

            // 临时替换规则列表进行渲染
            const originalRules = applicationRules;
            applicationRules = filteredRules;
            renderApplicationRulesTable();
            applicationRules = originalRules;
        }

        // 刷新应用规则列表
        function refreshApplicationRuleList() {
            renderApplicationRulesTable();
            showNotification(getTranslation('ruleRefreshSuccess') || '规则列表已刷新', 'success');
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                info: '#3b82f6',
                warning: '#f59e0b'
            };
            
            notification.innerHTML = `
                <i class="fas ${icons[type]}" style="color: ${colors[type]}; font-size: 20px;"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // 添加动画样式
        const animationStyle = document.createElement('style');
        animationStyle.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(animationStyle);

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });
    </script>
</body>
</html>