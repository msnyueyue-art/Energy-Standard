# 收益货币符号国际化功能说明

## 📋 功能概述

实现了收益金额根据语言环境自动切换货币符号的功能：

- **中文环境**：显示人民币符号 `¥`
- **英文环境**：显示美元符号 `$`

## 🔧 实现方案

### 1. 核心函数（common.js）

#### `getCurrencySymbol()`
根据当前语言返回对应的货币符号。

```javascript
function getCurrencySymbol() {
    return currentLang === 'zh' ? '¥' : '$';
}
```

#### `formatRevenue(amount)`
格式化收益金额，自动添加货币符号。

```javascript
function formatRevenue(amount) {
    const symbol = getCurrencySymbol();
    const numberStr = typeof amount === 'string'
        ? amount.replace(/[^\d,]/g, '')
        : amount.toString();
    return `${symbol}${numberStr}`;
}
```

#### `updateRevenueCurrency()`
更新页面中所有带 `data-revenue` 属性的元素。

```javascript
function updateRevenueCurrency() {
    const symbol = getCurrencySymbol();
    document.querySelectorAll('[data-revenue]').forEach(element => {
        const amount = element.getAttribute('data-revenue');
        element.textContent = formatRevenue(amount);
    });
}
```

#### `updateTableHeaderCurrency()`
更新表格表头中的货币单位（专为 data-analysis.html 设计）。

```javascript
function updateTableHeaderCurrency() {
    const currencyUnit = currentLang === 'zh' ? '(元)' : `(${getCurrencySymbol()})`;

    const revenueHeaders = [
        'dataAnalysisTableHeaderChargeCost',
        'dataAnalysisTableHeaderSellProfit',
        'dataAnalysisTableHeaderNetProfit',
        'dataAnalysisTableHeaderSelfSaving',
        'dataAnalysisTableHeaderTotalRevenue'
    ];

    revenueHeaders.forEach(key => {
        const elements = document.querySelectorAll(`[data-translate="${key}"]`);
        elements.forEach(element => {
            const baseText = translations[currentLang][key];
            if (baseText) {
                element.textContent = `${baseText}${currencyUnit}`;
            }
        });
    });
}
```

### 2. HTML 结构修改（dashboard.html）

为所有收益显示元素添加 `data-revenue` 属性：

```html
<!-- 示例：今日收益 -->
<div style="font-size: 20px; font-weight: 700; color: #ea580c;"
     data-revenue="1,580">¥1,580</div>
```

### 3. 自动触发机制

#### 页面加载时初始化
```javascript
window.addEventListener('DOMContentLoaded', function() {
    if (typeof updateRevenueCurrency === 'function') {
        updateRevenueCurrency();
    }
});
```

#### 语言切换时自动更新
在 `selectLanguage()` 函数中自动调用：

```javascript
function selectLanguage(lang) {
    currentLang = lang;
    setLanguage(currentLang);
    localStorage.setItem('language', currentLang);

    // 更新货币符号显示
    if (typeof updateRevenueCurrency === 'function') {
        updateRevenueCurrency();
    }

    // ... 其他代码
}
```

## 📍 修改的文件位置

### common.js
- **货币处理函数** (第 7021-7072 行)：
  - `getCurrencySymbol()`: 获取当前语言对应的货币符号
  - `formatRevenue()`: 格式化收益金额
  - `updateRevenueCurrency()`: 更新所有收益元素
  - `updateTableHeaderCurrency()`: 更新表格表头货币单位
- **翻译文本修改**：
  - 第 3041-3045 行：移除中文表头的 `(元)` 硬编码
  - 第 6419-6423 行：移除英文表头的 `(¥)` 硬编码
- **setLanguage 函数** (第 7180-7183 行)：
  - 添加调用 `updateTableHeaderCurrency()`
- **selectLanguage 函数** (第 6993-6996 行)：
  - 添加调用 `updateRevenueCurrency()`

### dashboard.html
- **HTML 结构修改**：
  - 第 1147 行：昨日收益
  - 第 1176 行：今日收益
  - 第 1205 行：本月收益
  - 第 1234 行：累计收益
  - 第 1472-1484 行：能量图下方的收益指标

- **脚本修改**：
  - 第 1993-1996 行：使用 `formatRevenue()` 格式化收益数据
  - 第 2010-2014 行：动态更新时添加 `data-revenue` 属性
  - 第 2019-2022 行：页面加载时初始化货币显示
  - 第 2152 行：能量流图信息窗口的收益显示
  - 第 2247 行：图表 tooltip 中使用 `getCurrencySymbol()`
  - 第 3569 行：地图弹窗中的收益显示使用 `formatRevenue()`
  - 第 3841-3859 行：语言切换事件监听器，更新地图标记和图表

### devices.html
- **HTML 结构修改**：
  - 第 2425 行：昨日收益
  - 第 2430 行：今日收益
  - 第 2437 行：本月收益
  - 第 2442 行：累计收益

- **脚本修改**：
  - 第 7840-7843 行：页面加载时初始化货币显示

### data-analysis.html
- **HTML 结构修改**：
  - 第 1026-1030 行：表格汇总行（5个收益字段）
  - 第 1050 行：总利润卡片
  - 第 1061 行：卖电利润卡片
  - 第 1072 行：自用节省卡片

- **脚本修改**：
  - 第 1132-1140 行：页面加载时初始化货币显示和表头
  - 第 1147-1166 行：语言切换事件监听器，更新货币符号、表头和图表
  - 第 1402-1406 行：日报表格行使用 `formatRevenue()`
  - 第 1461-1465 行：月报表格行使用 `formatRevenue()`
  - 第 1518-1522 行：年报表格行使用 `formatRevenue()`
  - 第 1541-1554 行：更新汇总数据时使用 `formatRevenue()`
  - 第 1586-1610 行：收益卡片更新逻辑修复（使用 data-revenue）
  - 第 1657-1659 行：表格数据提取修复（从 data-revenue 读取）
  - 第 1678-1683 行：趋势图 tooltip 使用动态货币符号
  - 第 1707-1710 行：Y 轴标签使用动态货币符号
  - 第 1742-1743 行：收益结构图数据读取修复
  - 第 1748-1750 行：饼图 tooltip 使用动态货币符号
  - 第 1770-1772 行：饼图标签使用动态货币符号

## 🎯 使用方法

### 前端开发者

1. **静态收益显示**：添加 `data-revenue` 属性
   ```html
   <div data-revenue="1,580">¥1,580</div>
   ```

2. **动态收益显示**：使用 `formatRevenue()` 函数
   ```javascript
   element.textContent = formatRevenue(revenueAmount);
   element.setAttribute('data-revenue', revenueAmount);
   ```

3. **手动触发更新**：
   ```javascript
   updateRevenueCurrency();
   ```

## ✅ 测试方法

### 基础测试
1. 打开 `测试收益货币切换.html` 文件
2. 点击 "🇨🇳 中文" 按钮 - 应显示 `¥` 符号
3. 点击 "🇺🇸 English" 按钮 - 应显示 `$` 符号
4. 确认所有收益数值的货币符号都已正确切换

### 完整功能测试（dashboard.html）
1. **数据视图测试**：
   - 打开 dashboard.html
   - 切换语言，检查运行概览卡片中的收益显示
   - 检查能量图下方的收益指标（昨日、今日、当月、累计）

2. **图表 Tooltip 测试**：
   - 将鼠标悬停在收益趋势图的数据点上
   - 切换语言，再次悬停查看 tooltip
   - 确认 tooltip 中的货币符号已更新

3. **地图视图测试**：
   - 点击 "Map View" 切换到地图视图
   - 点击任意站点标记，查看弹窗中的 Revenue 字段
   - 切换语言（中文 ↔ English）
   - 再次点击站点标记，确认货币符号已更新

### 设备页面测试（devices.html）
1. **Profit Statistics 卡片**：
   - 打开 devices.html
   - 查看右侧 Profit Statistics（收益统计）卡片
   - 切换语言，确认 4 个收益指标的货币符号已更新
   - 验证显示：Yesterday/Today/This Month/Total

### 数据分析页面测试（data-analysis.html）
1. **收益统计卡片**：
   - 打开 data-analysis.html
   - 查看左侧 Revenue Statistics 卡片
   - 切换语言，确认 Total Profit/Selling Profit/Self-use Saving 的货币符号已更新

2. **数据表格测试**：
   - 切换到 Table 视图
   - 查看表格中的 5 列收益数据
   - 切换语言，确认所有表格数据和汇总行的货币符号已更新
   - 测试不同时间维度（日报/月报/年报）

## 🚀 扩展功能

### 支持更多货币

可以轻松扩展支持更多货币符号：

```javascript
function getCurrencySymbol() {
    const currencyMap = {
        'zh': '¥',    // 人民币
        'en': '$',    // 美元
        'eu': '€',    // 欧元
        'jp': '¥',    // 日元
        'uk': '£'     // 英镑
    };
    return currencyMap[currentLang] || '$';
}
```

### 添加货币转换

如果需要实际的货币转换，可以添加汇率转换功能：

```javascript
function convertCurrency(amount, fromCurrency, toCurrency) {
    const rates = {
        'CNY_USD': 0.14,
        'USD_CNY': 7.2
        // ... 更多汇率
    };
    // 转换逻辑
}
```

## 🔍 注意事项

1. **保持数据一致性**：`data-revenue` 属性中只存储数字，不包含货币符号
2. **性能优化**：语言切换时只更新可见元素
3. **向后兼容**：如果 common.js 未加载，不会报错
4. **本地存储**：语言偏好保存在 localStorage 中

## 📝 代码质量

- ✅ **KISS原则**：简洁的函数设计，单一职责
- ✅ **DRY原则**：统一的货币格式化逻辑，避免重复
- ✅ **容错性**：包含函数存在性检查，防止错误
- ✅ **可维护性**：清晰的函数命名和注释

## 🎨 界面效果

### 中文环境
```
昨日收益
¥1,467
```

### 英文环境
```
Yesterday Revenue
$1,467
```

---

**作者**: Claude Code
**日期**: 2026-01-13
**版本**: 1.0.0
