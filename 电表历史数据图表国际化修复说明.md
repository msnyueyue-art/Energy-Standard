# 电表历史数据图表国际化修复说明

## 问题描述
在触摸屏数据页面 (touchscreen/data.html) 的电表(Meter)历史数据图表中,以下文本在英文环境下仍显示中文:

### 问题1: 功率趋势分析图
- X轴时间标签: "0时、1时、2时...23时"
- Y轴标签: "功率 (kW/kVar/kVA)"

### 问题2: 电量消耗统计图
- X轴时间标签: "0时、1时、2时...23时"
- Y轴标签: "电量 (kWh/kVarh)"

### 问题3: 电压质量监测图
- X轴时间标签: "0时、1时、2时...23时"
- Y轴标签: "电压 (V)"

### 问题4: 谐波分析图
- X轴谐波次数标签: "基波、2次、3次...21次"
- Y轴标签/图例: "谐波含量 (%)"

## 问题位置

### 文件: `touchscreen/data.html`

**功率趋势分析图 (第6359-6393行)**
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}时`),  // 硬编码中文
options: getChartOptions('功率 (kW/kVar/kVA)', 0, 300)  // 硬编码中文
```

**电量消耗统计图 (第6396-6418行)**
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}时`),  // 硬编码中文
options: getChartOptions('电量 (kWh/kVarh)', 0, 80)  // 硬编码中文
```

**电压质量监测图 (第6421-6452行)**
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}时`),  // 硬编码中文
options: getChartOptions('电压 (V)', 370, 400)  // 硬编码中文
```

**谐波分析图 (第6455-6541行)**
```javascript
labels: ['基波', '2次', '3次', '4次', ...],  // 硬编码中文
datasets: [{
    label: '谐波含量 (%)',  // 硬编码中文
    ...
}]
options: getChartOptions('谐波含量 (%)', 0, 3)  // 硬编码中文 Y轴标签
```

## 修复方案

### 1. 添加翻译键到 translateLabel 函数

在 `data.html` 的 `translateLabel()` 函数的翻译映射表中添加以下键值对:

**时间单位翻译 (第4295-4296行):**
```javascript
// 时间单位
'时': ':00',
```

**谐波相关翻译 (第4303-4325行):**
```javascript
// 谐波次数
'基波': 'Fundamental',
'2次': '2nd',
'3次': '3rd',
'4次': '4th',
'5次': '5th',
'6次': '6th',
'7次': '7th',
'8次': '8th',
'9次': '9th',
'10次': '10th',
'11次': '11th',
'12次': '12th',
'13次': '13th',
'14次': '14th',
'15次': '15th',
'16次': '16th',
'17次': '17th',
'18次': '18th',
'19次': '19th',
'20次': '20th',
'21次': '21st',
'谐波含量': 'Harmonic Content',
```

### 2. 修复图表代码

**修改1: 功率趋势分析图 (第6359-6393行)**

修改前:
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}时`),
...
options: getChartOptions('功率 (kW/kVar/kVA)', 0, 300)
```

修改后:
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}${translateLabel('时')}`),
...
options: getChartOptions(translateLabel('功率') + ' (kW/kVar/kVA)', 0, 300)
```

**修改2: 电量消耗统计图 (第6396-6418行)**

修改前:
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}时`),
...
options: getChartOptions('电量 (kWh/kVarh)', 0, 80)
```

修改后:
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}${translateLabel('时')}`),
...
options: getChartOptions(translateLabel('电量') + ' (kWh/kVarh)', 0, 80)
```

**修改3: 电压质量监测图 (第6421-6452行)**

修改前:
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}时`),
...
options: getChartOptions('电压 (V)', 370, 400)
```

修改后:
```javascript
labels: Array.from({length: 24}, (_, i) => `${i}${translateLabel('时')}`),
...
options: getChartOptions(translateLabel('电压') + ' (V)', 370, 400)
```

**修改4: 谐波分析图 (第6455-6541行)**

修改前:
```javascript
labels: ['基波', '2次', '3次', '4次', '5次', '6次', '7次', '8次', '9次', '10次', '11次', '12次', '13次', '14次', '15次', '16次', '17次', '18次', '19次', '20次', '21次'],
datasets: [{
    label: '谐波含量 (%)',
    ...
}]
...
options: getChartOptions('谐波含量 (%)', 0, 3)
```

修改后:
```javascript
labels: [translateLabel('基波'), translateLabel('2次'), translateLabel('3次'), translateLabel('4次'), translateLabel('5次'), translateLabel('6次'), translateLabel('7次'), translateLabel('8次'), translateLabel('9次'), translateLabel('10次'), translateLabel('11次'), translateLabel('12次'), translateLabel('13次'), translateLabel('14次'), translateLabel('15次'), translateLabel('16次'), translateLabel('17次'), translateLabel('18次'), translateLabel('19次'), translateLabel('20次'), translateLabel('21次')],
datasets: [{
    label: translateLabel('谐波含量') + ' (%)',
    ...
}]
...
options: getChartOptions(translateLabel('谐波含量') + ' (%)', 0, 3)
```

## 修复内容总结

### 新增翻译键
| 中文 | 英文 | 翻译键 | 用途 |
|------|------|--------|------|
| 时 | :00 | '时' | 时间标签后缀 |
| 基波 | Fundamental | '基波' | 谐波图X轴标签 |
| 2次 | 2nd | '2次' | 谐波图X轴标签 |
| 3次 | 3rd | '3次' | 谐波图X轴标签 |
| 4次~21次 | 4th~21st | '4次'~'21次' | 谐波图X轴标签 |
| 谐波含量 | Harmonic Content | '谐波含量' | 谐波图图例标签 |

### 修复的图表元素

**4个图表全部修复:**
1. ✅ **功率趋势分析图**
   - X轴: `${i}时` → `${i}${translateLabel('时')}`
   - Y轴: `'功率 (kW/kVar/kVA)'` → `translateLabel('功率') + ' (kW/kVar/kVA)'`

2. ✅ **电量消耗统计图**
   - X轴: `${i}时` → `${i}${translateLabel('时')}`
   - Y轴: `'电量 (kWh/kVarh)'` → `translateLabel('电量') + ' (kWh/kVarh)'`

3. ✅ **电压质量监测图**
   - X轴: `${i}时` → `${i}${translateLabel('时')}`
   - Y轴: `'电压 (V)'` → `translateLabel('电压') + ' (V)'`

4. ✅ **谐波分析图**
   - X轴: `['基波', '2次', ...]` → `[translateLabel('基波'), translateLabel('2次'), ...]`
   - 图例: `'谐波含量 (%)'` → `translateLabel('谐波含量') + ' (%)'`
   - Y轴: `'谐波含量 (%)'` → `translateLabel('谐波含量') + ' (%)'`

## 修复效果

### 英文环境下

**功率趋势分析图 (Power Trend Analysis):**
- X轴时间标签: 0:00, 1:00, 2:00, ..., 23:00
- Y轴标签: "Power (kW/kVar/kVA)"

**电量消耗统计图 (Energy Consumption Statistics):**
- X轴时间标签: 0:00, 1:00, 2:00, ..., 23:00
- Y轴标签: "Energy (kWh/kVarh)"

**电压质量监测图 (Voltage Quality Monitoring):**
- X轴时间标签: 0:00, 1:00, 2:00, ..., 23:00
- Y轴标签: "Voltage (V)"

**谐波分析图 (Harmonic Analysis):**
- X轴谐波次数: Fundamental, 2nd, 3rd, 4th, 5th, 6th, 7th, 8th, 9th, 10th, 11th, 12th, 13th, 14th, 15th, 16th, 17th, 18th, 19th, 20th, 21st
- Y轴标签/图例: "Harmonic Content (%)"

### 中文环境下

**功率趋势分析图:**
- X轴时间标签: 0时, 1时, 2时, ..., 23时
- Y轴标签: "功率 (kW/kVar/kVA)"

**电量消耗统计图:**
- X轴时间标签: 0时, 1时, 2时, ..., 23时
- Y轴标签: "电量 (kWh/kVarh)"

**电压质量监测图:**
- X轴时间标签: 0时, 1时, 2时, ..., 23时
- Y轴标签: "电压 (V)"

**谐波分析图:**
- X轴谐波次数: 基波, 2次, 3次, 4次, 5次, 6次, 7次, 8次, 9次, 10次, 11次, 12次, 13次, 14次, 15次, 16次, 17次, 18次, 19次, 20次, 21次
- Y轴标签/图例: "谐波含量 (%)"

### 语言切换
- ✅ 切换语言后,页面刷新时图表会使用对应语言显示
- ✅ 不影响图表的任何功能和交互
- ✅ 不影响其他页面的布局和内容

## 测试方法

### 英文环境测试
1. 打开触摸屏显示页面: `touchscreen/touchscreen-display.html`
2. 确保当前语言为英文(右上角语言按钮)
3. 点击顶部导航的 "Data" 菜单
4. 点击左侧设备列表中的 "Meter"
5. 点击顶部的 "Historical Data" 标签
6. 验证4个图表:

   **Power Trend Analysis (功率趋势分析):**
   - X轴: 0:00, 1:00, 2:00, ..., 23:00
   - Y轴: "Power (kW/kVar/kVA)"
   - 图例: "Active Power", "Reactive Power", "Apparent Power"

   **Energy Consumption Statistics (电量消耗统计):**
   - X轴: 0:00, 1:00, 2:00, ..., 23:00
   - Y轴: "Energy (kWh/kVarh)"
   - 图例: "Active Energy", "Reactive Energy"

   **Voltage Quality Monitoring (电压质量监测):**
   - X轴: 0:00, 1:00, 2:00, ..., 23:00
   - Y轴: "Voltage (V)"
   - 图例: "Phase A Voltage", "Phase B Voltage", "Phase C Voltage"

   **Harmonic Analysis (谐波分析):**
   - X轴: Fundamental, 2nd, 3rd, 4th, ..., 21st
   - Y轴/图例: "Harmonic Content (%)"

### 中文环境测试
1. 点击右上角的语言切换按钮,切换到中文
2. 导航至 电表 → 历史数据
3. 验证4个图表:

   **功率趋势分析:**
   - X轴: 0时, 1时, 2时, ..., 23时
   - Y轴: "功率 (kW/kVar/kVA)"
   - 图例: "有功功率", "无功功率", "视在功率"

   **电量消耗统计:**
   - X轴: 0时, 1时, 2时, ..., 23时
   - Y轴: "电量 (kWh/kVarh)"
   - 图例: "有功电量", "无功电量"

   **电压质量监测:**
   - X轴: 0时, 1时, 2时, ..., 23时
   - Y轴: "电压 (V)"
   - 图例: "A相电压", "B相电压", "C相电压"

   **谐波分析:**
   - X轴: 基波, 2次, 3次, 4次, ..., 21次
   - Y轴/图例: "谐波含量 (%)"

### 语言切换测试
1. 在电表历史数据页面停留
2. 点击右上角的语言切换按钮
3. 等待页面刷新
4. 观察所有4个图表是否正确显示对应语言

## 技术说明

### 时间标签翻译策略
中文使用"时"作为后缀 (0时, 1时, ...)，英文使用":00"格式 (0:00, 1:00, ...)。通过 `${i}${translateLabel('时')}` 实现动态拼接。

### 谐波次数翻译
采用英文序数词规范:
- 1st (first), 2nd (second), 3rd (third)
- 4th, 5th, 6th, ..., 20th (规则序数词)
- 21st (特殊序数词)

基波译为 "Fundamental" (基础波/基本波)。

### 单位保留
单位部分 "(kW/kVar/kVA)", "(kWh/kVarh)", "(V)", "(%)" 保留英文,符合国际电气工程标准。

### 图例标签
图例标签如 "有功功率"、"无功功率" 等已通过 `translateLabel()` 翻译,这些翻译在之前已添加到翻译表中。

## 相关文件
- `touchscreen/data.html` - 数据页面主文件
- `touchscreen/touchscreen-i18n.js` - 触摸屏国际化配置
- `touchscreen/touchscreen-display.html` - 触摸屏显示入口

## 注意事项
1. ✅ **已验证兼容性**: 修复不影响其他图表和组件
2. ✅ **性能无影响**: translateLabel() 函数调用开销极小
3. ✅ **维护性良好**: 所有翻译集中在 labelTranslations 对象中
4. ✅ **标准符合性**: 电气单位和术语翻译符合国际标准
5. ⚠️ **图表刷新**: 语言切换后需要刷新页面才能看到图表语言更新(这是现有设计)

## 修复日期
2026-01-15
