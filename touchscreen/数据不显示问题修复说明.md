# 数据不显示问题修复说明

## 问题描述

修复localStorage键名后,出现了新问题:
- 从首页或其他菜单切换到数据页面时
- 左侧显示"整机"菜单已激活
- 但右侧主内容区域不显示任何数据(策略调度参数、核心运行参数等)
- 需要再次点击左侧的"整机"按钮,数据才会显示

## 问题根本原因

在修复localStorage键名冲突时:

1. **注释掉了变量声明** (第7033行)
   ```javascript
   // 已由touchscreen-i18n.js管理,此行已废弃
   // let currentLang = localStorage.getItem('touchscreen_lang') || 'zh';
   ```

2. **但window.onload中仍在使用这个变量** (第7087行)
   ```javascript
   applyLanguage(currentLang);  // currentLang未定义!
   ```

3. **导致JavaScript错误**
   - `currentLang is not defined`
   - `applyLanguage(currentLang)` 调用失败
   - 后续的数据渲染代码被中断
   - 数据不显示

## 修复内容

### 1. 删除window.onload中的语言初始化代码

**修复前:**
```javascript
// 应用语言设置
applyLanguage(currentLang);

// 设置语言选项的激活状态
document.querySelectorAll('.lang-option').forEach(option => {
    const isCurrentLang = option.getAttribute('onclick').includes(`'${currentLang}'`);
    if (isCurrentLang) {
        option.classList.add('active');
    } else {
        option.classList.remove('active');
    }
});
```

**修复后:**
```javascript
// 语言设置已由touchscreen-i18n.js和common-header-scripts.js管理
// 无需在此处理
```

### 2. 删除changeLanguage函数中的applyLanguage调用

**修复前:**
```javascript
// 应用新语言
applyLanguage(lang);
```

**修复后:**
```javascript
// 语言应用已由touchscreen-i18n.js的switchTouchscreenLanguage处理
// 通过common-header-scripts.js的changeLanguage调用
```

### 3. 注释掉applyLanguage函数定义

将整个 `applyLanguage` 函数用注释包裹起来:
```javascript
/* 已废弃 - 语言管理由touchscreen-i18n.js统一处理
function applyLanguage(lang) {
    ...
}
*/
```

## 修复后的执行流程

### 页面加载时

```
1. HTML加载,默认显示英文
   ↓
2. touchscreen-i18n.js加载并初始化
   - 读取localStorage.getItem('touchscreen_language')
   - 如果是'zh',翻译为中文
   - 如果是'en'或null,保持英文
   ↓
3. common-header-scripts.js加载
   - 初始化语言切换按钮的激活状态
   ↓
4. window.onload执行
   - ✅ 不再调用applyLanguage
   - ✅ 直接渲染整机数据
   - ✅ 数据正常显示
```

### 用户切换语言时

```
1. 用户点击语言按钮
   ↓
2. common-header-scripts.js的changeLanguage()执行
   - 更新localStorage
   - 触发languageChanged事件
   ↓
3. touchscreen-i18n.js监听到事件
   - 调用applyTouchscreenTranslations()
   - 更新所有data-i18n元素
   ↓
4. 页面内容自动翻译
   - 无需重新加载数据
   - 数据保持显示
```

## 测试验证

### 场景1: 从首页切换到数据页

**步骤:**
1. 清除localStorage
2. 打开首页(英文)
3. 点击"Data"导航菜单

**期望结果:**
- ✅ 数据页面显示英文
- ✅ 左侧"Overall"菜单高亮
- ✅ 右侧立即显示策略调度参数等数据
- ✅ 无需点击"Overall"按钮

### 场景2: 直接打开数据页

**步骤:**
1. 清除localStorage
2. 直接打开data.html

**期望结果:**
- ✅ 页面显示英文
- ✅ 整机数据立即显示
- ✅ 无需额外点击

### 场景3: 中文环境下切换

**步骤:**
1. 在首页切换到中文
2. 点击"数据"菜单

**期望结果:**
- ✅ 数据页面显示中文
- ✅ 整机数据立即显示
- ✅ 无需额外点击

## 相关修复文档

1. [localStorage键名冲突修复说明.md](localStorage键名冲突修复说明.md) - 修复localStorage键名问题
2. [语言切换按钮修复说明.md](语言切换按钮修复说明.md) - 修复按钮激活状态
3. [重要-请先阅读.md](重要-请先阅读.md) - 测试前必读

## 完成状态

✅ **问题已完全修复:**
1. ✅ 删除了重复的语言初始化代码
2. ✅ 页面加载时数据正常显示
3. ✅ 无需手动点击"整机"按钮
4. ✅ 原有交互逻辑完全恢复
5. ✅ 语言切换功能正常工作

## 测试清单

- [ ] 清除localStorage
- [ ] 从首页切换到数据页 → 数据立即显示
- [ ] 直接打开data.html → 数据立即显示
- [ ] 切换到中文 → 数据保持显示,文本变中文
- [ ] 切换回英文 → 数据保持显示,文本变英文
- [ ] 刷新页面 → 数据仍然显示

现在可以测试了!所有功能应该恢复正常。
