# 电价设置动态内容国际化补充修复

## 修复时间
2026-01-13

## 问题描述
设置页面的静态内容国际化已完成,但电价设置板块中的动态生成内容仍显示中文:
1. ❌ "默认峰谷电价" 标题
2. ❌ "元/kWh" 单位
3. ❌ 时段标签: "峰时"、"平时"、"谷时"
4. ❌ 模板名称: "江苏省工业峰谷电价"、"上海市工商业电价" 等
5. ❌ "当前时段配置"、"添加时段"、"恢复默认"、"保存方案"
6. ❌ "选择电价模板"、"关闭" 按钮

## 问题原因
这些内容是通过JavaScript动态生成的,在代码中硬编码了中文字符串,未使用国际化翻译函数。

## 修复方案

### 1. 新增翻译键

在 [touchscreen-i18n.js](touchscreen-i18n.js) 中添加:

**中文翻译**:
```javascript
zh: {
    // 电价设置 - 补充
    currentPeriodConfig: '当前时段配置',
    addPeriod: '添加时段',
    resetToDefault: '恢复默认',
    savePlan: '保存方案',
    selectPriceTemplate: '选择电价模板',
    defaultPeakValley: '默认峰谷电价',
    priceUnit: '元/kWh',
    jiangsuIndustrial: '江苏省工业峰谷电价',
    shanghaiCommercial: '上海市工商业电价',
    zhejiangIndustrial: '浙江省工业峰谷电价',
    guangdongIndustrial: '广东省工业峰谷电价',
    priceRangeError: '电价必须在0-10元/kWh之间',
}
```

**英文翻译**:
```javascript
en: {
    // Electricity price settings - supplement
    currentPeriodConfig: 'Current Period Configuration',
    addPeriod: 'Add Period',
    resetToDefault: 'Reset to Default',
    savePlan: 'Save Plan',
    selectPriceTemplate: 'Select Price Template',
    defaultPeakValley: 'Default Peak-Valley Pricing',
    priceUnit: '/kWh',
    jiangsuIndustrial: 'Jiangsu Industrial Peak-Valley Pricing',
    shanghaiCommercial: 'Shanghai Commercial Pricing',
    zhejiangIndustrial: 'Zhejiang Industrial Peak-Valley Pricing',
    guangdongIndustrial: 'Guangdong Industrial Peak-Valley Pricing',
    priceRangeError: 'Price must be between 0-10/kWh',
}
```

### 2. 修改HTML静态文本

**A. 时段配置标题和按钮**
```html
<!-- 修改前 -->
<span>当前时段配置</span>
<button class="btn-small" onclick="addPeriod()">
    <i class="fas fa-plus"></i>
    添加时段
</button>

<!-- 修改后 -->
<span data-i18n="currentPeriodConfig">Current Period Configuration</span>
<button class="btn-small" onclick="addPeriod()">
    <i class="fas fa-plus"></i>
    <span data-i18n="addPeriod">Add Period</span>
</button>
```

**B. 操作按钮**
```html
<!-- 修改前 -->
<button class="btn" onclick="resetToDefault()">
    <i class="fas fa-undo"></i>
    恢复默认
</button>
<button class="btn primary" onclick="savePriceConfig()">
    <i class="fas fa-save"></i>
    保存方案
</button>

<!-- 修改后 -->
<button class="btn" onclick="resetToDefault()">
    <i class="fas fa-undo"></i>
    <span data-i18n="resetToDefault">Reset to Default</span>
</button>
<button class="btn primary" onclick="savePriceConfig()">
    <i class="fas fa-save"></i>
    <span data-i18n="savePlan">Save Plan</span>
</button>
```

**C. 模板选择器**
```html
<!-- 修改前 -->
<div class="group-title">
    <i class="fas fa-clipboard-list"></i>
    选择电价模板
    <button class="btn" onclick="closeTemplateSelector()">
        <i class="fas fa-times"></i>
        关闭
    </button>
</div>

<!-- 修改后 -->
<div class="group-title">
    <i class="fas fa-clipboard-list"></i>
    <span data-i18n="selectPriceTemplate">Select Price Template</span>
    <button class="btn" onclick="closeTemplateSelector()">
        <i class="fas fa-times"></i>
        <span data-i18n="closeBtn">Close</span>
    </button>
</div>
```

### 3. 修改JavaScript动态内容

**A. 创建时段标签获取函数**
```javascript
// 获取时段类型的本地化标签
function getPeriodLabel(type) {
    const labels = {
        peak: t('peakTime'),
        flat: t('normalTime'),
        valley: t('valleyTime')
    };
    return labels[type] || type;
}
```

**B. 修改数据结构,使用类型而非硬编码标签**
```javascript
// 修改前
let currentPriceScheme = {
    name: '默认峰谷电价',
    periods: [
        { type: 'valley', start: 0, end: 6, price: 0.32, label: '谷时' },
        // ...
    ]
};

// 修改后
let currentPriceScheme = {
    name: t('defaultPeakValley'),
    periods: [
        { type: 'valley', start: 0, end: 6, price: 0.32, label: 'valley' },
        // ... 存储类型标识,显示时动态翻译
    ]
};
```

**C. 创建模板数据获取函数**
```javascript
// 获取电价模板数据(国际化)
function getPriceTemplates() {
    return [
        {
            name: t('jiangsuIndustrial'),
            description: `${t('peakTime')}0.85  ${t('normalTime')}0.56  ${t('valleyTime')}0.32${t('priceUnit')}`,
            periods: [
                { type: 'valley', start: 0, end: 8, price: 0.32, label: 'valley' },
                // ...
            ]
        },
        // ... 其他模板
    ];
}
```

**D. 更新价格显示**
```javascript
// 修改前
document.querySelector('.peak-tag .tag-value').textContent = `${peakPrice}元/kWh`;

// 修改后
document.querySelector('.peak-tag .tag-value').textContent = `${peakPrice}${t('priceUnit')}`;
```

**E. 更新时间轴渲染**
```javascript
// 修改前
block.textContent = period.label;

// 修改后
block.textContent = getPeriodLabel(period.type);
```

**F. 更新时段列表渲染**
```javascript
// 修改前
type.textContent = period.label;

// 修改后
type.textContent = getPeriodLabel(period.type);
```

**G. 更新模板列表渲染**
```javascript
// 修改前
priceTemplates.forEach((template, index) => {

// 修改后
getPriceTemplates().forEach((template, index) => {
```

**H. 更新应用模板函数**
```javascript
// 修改前
const template = priceTemplates[templateIndex];

// 修改后
const template = getPriceTemplates()[templateIndex];
```

**I. 更新验证错误消息**
```javascript
// 修改前
showNotification('电价必须在0-10元/kWh之间', 'error');

// 修改后
showNotification(t('priceRangeError'), 'error');
```

**J. 添加语言切换时的更新**
```javascript
// 监听语言切换事件
window.addEventListener('languageChanged', function(e) {
    // ... 现有代码

    // 更新电价设置的动态内容
    currentPriceScheme.name = t('defaultPeakValley');
    updatePriceDisplay();
    renderTimeline();
    renderPeriodList();
});
```

## 技术要点

### 1. 分离数据和展示
- **数据层**: 存储类型标识 (`'peak'`, `'flat'`, `'valley'`)
- **展示层**: 使用 `getPeriodLabel(type)` 动态获取翻译文本

### 2. 动态数据函数
所有包含文本的数据应该通过函数返回,而不是定义为常量:
```javascript
// ❌ 错误: 硬编码常量
const templates = [{ name: '江苏省工业峰谷电价' }];

// ✅ 正确: 函数返回
function getTemplates() {
    return [{ name: t('jiangsuIndustrial') }];
}
```

### 3. 语言切换时更新
当语言切换时,需要重新渲染所有动态内容:
- `updatePriceDisplay()` - 更新价格摘要
- `renderTimeline()` - 重新渲染时间轴
- `renderPeriodList()` - 重新渲染时段列表

## 修复效果

### 英文环境 ✅
- 方案名称: "Default Peak-Valley Pricing"
- 价格单位: "/kWh"
- 时段标签: "Peak", "Normal", "Valley"
- 模板名称: "Jiangsu Industrial Peak-Valley Pricing" 等
- 按钮文本: "Current Period Configuration", "Add Period", "Reset to Default", "Save Plan"

### 中文环境 ✅
- 方案名称: "默认峰谷电价"
- 价格单位: "元/kWh"
- 时段标签: "峰时", "平时", "谷时"
- 模板名称: "江苏省工业峰谷电价" 等
- 按钮文本: "当前时段配置", "添加时段", "恢复默认", "保存方案"

### 语言切换 ✅
- ✅ EN → CN: 所有动态内容立即更新为中文
- ✅ CN → EN: 所有动态内容立即更新为英文
- ✅ 刷新后语言保持不变

## 测试清单

### 基础显示测试
- [x] 英文环境下,电价方案名称显示英文
- [x] 英文环境下,价格单位显示 "/kWh"
- [x] 英文环境下,时间轴色块标签显示英文
- [x] 英文环境下,时段列表标签显示英文
- [x] 英文环境下,模板名称显示英文
- [x] 中文环境下,所有内容显示中文

### 交互测试
- [x] 点击时间轴色块切换类型,标签正确翻译
- [x] 打开模板选择器,模板名称正确翻译
- [x] 应用模板后,时段标签正确翻译
- [x] 恢复默认后,方案名称正确翻译

### 语言切换测试
- [x] EN→CN切换后,时间轴立即更新为中文
- [x] EN→CN切换后,时段列表立即更新为中文
- [x] EN→CN切换后,价格单位立即更新
- [x] CN→EN切换后,所有动态内容立即更新为英文
- [x] 切换语言后刷新页面,语言保持一致

## 相关文件

- [touchscreen/settings.html](touchscreen/settings.html) - 主要修改文件
  - 第2192-2199行: 新增 `getPeriodLabel()` 函数
  - 第2201-2213行: 修改 `currentPriceScheme` 数据结构
  - 第2216-2266行: 新增 `getPriceTemplates()` 函数
  - 第2332-2336行: 更新价格显示使用 `t('priceUnit')`
  - 第2456行: 时间轴渲染使用 `getPeriodLabel()`
  - 第2503行: 时段列表渲染使用 `getPeriodLabel()`
  - 第2381行: 模板列表渲染使用 `getPriceTemplates()`
  - 第2426行: 应用模板使用 `getPriceTemplates()`
  - 第2538行: placeholder使用 `t('priceUnit')`
  - 第2576-2585行: 恢复默认使用 `t()` 函数
  - 第2623行: 错误消息使用 `t('priceRangeError')`
  - 第2664-2668行: 语言切换事件中更新动态内容

- [touchscreen/touchscreen-i18n.js](touchscreen-i18n.js) - 翻译文件
  - 第475-486行: 中文翻译键
  - 第1053-1064行: 英文翻译键

## 注意事项

1. **数据持久化**: 保存到localStorage时使用类型标识,不要保存翻译后的文本
2. **初始化时机**: 确保在DOM加载完成且翻译函数可用时初始化
3. **缓存问题**: 如果修改后看不到效果,请使用 Ctrl+F5 强制刷新

## 修复人员
Claude AI Assistant
