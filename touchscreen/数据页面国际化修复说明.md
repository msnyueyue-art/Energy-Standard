# 数据页面国际化修复说明

## 修复时间
2026-01-12

## 修复内容

### 1. 国际化翻译键添加 ✓

在 `touchscreen-i18n.js` 中添加了设备名称和状态的翻译:

**中文翻译:**
```javascript
// 设备名称
deviceEMS: 'EMS',
devicePCS: 'PCS',
deviceBMS: 'BMS',
deviceMeter: '电表',
deviceTemp: '温度',
deviceFire: '消防',
deviceOverall: '整机',

// 设备状态
deviceStatusNormal: '正常',
deviceStatusError: '异常',
deviceStatusOffline: '离线',
deviceStatusWarning: '告警',
```

**英文翻译:**
```javascript
// 设备名称
deviceEMS: 'EMS',
devicePCS: 'PCS',
deviceBMS: 'BMS',
deviceMeter: 'Meter',
deviceTemp: 'Temp',
deviceFire: 'Fire Protection',
deviceOverall: 'Overall',

// 设备状态
deviceStatusNormal: 'Normal',
deviceStatusError: 'Error',
deviceStatusOffline: 'Offline',
deviceStatusWarning: 'Warning',
```

### 2. 数据页面默认显示英文 ✓

修改了 `data.html`:
- HTML lang 属性从 `zh` 改为 `en`
- 页面标题改为英文: `Data Monitoring - Energy Storage System`
- 所有设备名称和状态标签默认显示英文,并添加 `data-i18n` 属性

**修改的元素示例:**
```html
<!-- 设备名称 -->
<span data-i18n="deviceOverall">Overall</span>
<span data-i18n="deviceEMS">EMS</span>
<span data-i18n="devicePCS">PCS</span>
<span data-i18n="deviceBMS">BMS</span>
<span data-i18n="deviceMeter">Meter</span>
<span data-i18n="deviceTemp">Temp</span>
<span data-i18n="deviceFire">Fire Protection</span>

<!-- 设备状态 -->
<span class="component-status status-normal" id="ems-status" data-i18n="deviceStatusNormal">Normal</span>
<span class="component-status status-error" id="bms-status" data-i18n="deviceStatusError">Error</span>
<span class="component-status status-offline" id="fire-status" data-i18n="deviceStatusOffline">Offline</span>
<span class="component-status status-warning" id="temp-status" data-i18n="deviceStatusWarning">Warning</span>
```

### 3. 左侧菜单栏英文字体自适应 ✓

在 `data.html` 中添加了响应式CSS样式:

```css
/* 英文环境下的自适应样式 */
html[lang="en"] .component-item span:first-child {
    font-size: clamp(12px, 1.1vw, 16px);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* 导航菜单英文字体大小调整 */
html[lang="en"] .nav-item {
    font-size: clamp(12px, 1vw, 16px);
    padding: 12px 20px;
}

/* Fire Protection特别处理 - 较长的英文 */
html[lang="en"] .component-item span[data-i18n="deviceFire"] {
    font-size: clamp(10px, 0.95vw, 14px);
}
```

**特点:**
- 使用 `clamp()` 函数实现流畅的字体缩放
- 针对较长的英文文本(如"Fire Protection")特别优化
- 保持文本在单元格内不换行,超出部分显示省略号

### 4. 设备状态标签英文自适应 ✓

```css
/* 设备状态标签自适应 */
html[lang="en"] .component-status {
    font-size: clamp(10px, 0.9vw, 14px);
    padding: 2px 8px;
    white-space: nowrap;
}

/* 组件列表整体调整 */
.component-list {
    gap: 8px;
}

.component-item {
    padding: 12px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
}

.component-item span:first-child {
    flex: 0 1 auto;
    min-width: 0;
}

.component-status {
    flex-shrink: 0;
    margin-left: auto;
}
```

**特点:**
- 状态标签使用 flexbox 布局,自动对齐到右侧
- 英文状态文本自动调整字体大小以适应标签容器
- 标签不会因为文本过长而变形

### 5. 修复设备状态在英文环境下显示中文的问题 ✓

通过以下方式修复:
1. HTML中的状态标签默认显示英文
2. 添加 `data-i18n` 属性绑定翻译键
3. 当语言为中文时,通过 `applyTouchscreenTranslations()` 自动翻译

### 6. 语言切换时保持当前页面并刷新内容 ✓

在所有页面(data.html, home.html, history.html, control.html, alarm.html, logs.html, settings.html)中添加了:

```javascript
// 监听语言切换事件
window.addEventListener('languageChanged', function(e) {
    console.log('页面接收到语言切换事件:', e.detail.lang);

    // 更新HTML lang属性
    document.documentElement.lang = e.detail.lang === 'zh' ? 'zh-CN' : 'en';

    // 重新应用翻译到所有元素
    if (typeof applyTouchscreenTranslations === 'function') {
        applyTouchscreenTranslations();
    }
});

// 页面加载时初始化语言
document.addEventListener('DOMContentLoaded', function() {
    const currentLang = getTouchscreenLang();
    console.log('当前页面语言:', currentLang);

    // 设置HTML lang属性
    document.documentElement.lang = currentLang === 'zh' ? 'zh-CN' : 'en';

    // HTML默认是英文,只有当前语言是中文时才需要翻译
    if (currentLang === 'zh' && typeof applyTouchscreenTranslations === 'function') {
        applyTouchscreenTranslations();
    }
});
```

**工作原理:**
1. 用户点击语言切换按钮
2. `common-header-scripts.js` 中的 `changeLanguage()` 函数更新语言设置
3. 触发 `languageChanged` 自定义事件
4. 所有页面监听该事件并自动重新翻译内容
5. 页面保持在当前位置,无需刷新或跳转

## 使用的脚本

修复过程中创建的辅助脚本:
1. `add-device-translations.js` - 添加设备翻译到i18n文件
2. `fix-data-page-i18n.js` - 修复data.html的国际化标记
3. `add-responsive-styles.js` - 添加响应式CSS样式
4. `add-page-i18n-init.js` - 添加页面国际化初始化代码
5. `add-i18n-to-all-pages.js` - 为所有页面添加国际化支持

## 测试步骤

1. **测试默认语言显示**
   - 清除浏览器缓存和LocalStorage
   - 打开数据页面
   - 确认页面默认显示英文

2. **测试语言切换**
   - 点击右上角语言切换按钮
   - 选择"中文"
   - 确认所有文本切换为中文,包括:
     - 顶部导航菜单
     - 左侧设备列表
     - 设备状态标签

3. **测试跨页面语言保持**
   - 在数据页面切换到中文
   - 点击导航栏切换到其他页面(首页、历史、控制等)
   - 确认新页面也显示中文
   - 切换回英文,再访问其他页面
   - 确认所有页面都显示英文

4. **测试文本自适应**
   - 在英文环境下查看数据页面
   - 确认左侧设备名称和状态标签字体大小合适
   - 特别检查"Fire Protection"是否正常显示,不会溢出容器

5. **测试响应式布局**
   - 调整浏览器窗口大小
   - 确认字体大小平滑缩放
   - 确认文本不会溢出或重叠

## 注意事项

1. **缓存问题**: 修改后需要清除浏览器缓存和LocalStorage才能看到效果
2. **依赖文件**: 所有页面都需要引入 `touchscreen-i18n.js`
3. **默认语言**: 系统默认语言已改为英文(en),首次访问会显示英文
4. **CSS作用域**: 响应式样式只在 `html[lang="en"]` 时生效,不会影响中文显示

## 相关文件

- `touchscreen-i18n.js` - 国际化翻译文件
- `common-header-scripts.js` - 语言切换逻辑
- `data.html` - 数据页面
- `home.html` - 首页
- `history.html` - 历史页面
- `control.html` - 控制页面
- `alarm.html` - 告警页面
- `logs.html` - 日志页面
- `settings.html` - 设置页面

## 完成状态

✅ 所有要求已完成:
1. ✅ 数据页面默认显示英文
2. ✅ 左侧菜单栏英文字体自适应
3. ✅ 设备状态标签英文自适应
4. ✅ 修复英文环境下设备状态显示中文的问题
5. ✅ 语言切换时保持当前页面并刷新内容
6. ✅ 所有页面都支持语言切换
