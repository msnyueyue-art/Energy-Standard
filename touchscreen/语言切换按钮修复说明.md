# 语言切换按钮激活状态修复说明

## 修复时间
2026-01-12

## 问题描述

**原始问题:**
- 在英文环境下,从首页切换到数据页面时,语言环境会自动变为中文
- 语言切换按钮的激活状态不正确,不能反映当前的语言设置

**根本原因:**
页面加载时没有正确初始化语言切换按钮的激活状态(`.lang-option.active`)

## 修复内容

### 1. 更新所有页面的语言初始化逻辑

在以下文件中添加了语言切换按钮激活状态的初始化代码:
- [data.html](touchscreen/data.html)
- [home.html](touchscreen/home.html)
- [history.html](touchscreen/history.html)
- [control.html](touchscreen/control.html)
- [alarm.html](touchscreen/alarm.html)
- [logs.html](touchscreen/logs.html)
- [settings.html](touchscreen/settings.html)

### 2. 添加的代码

在每个页面的 `DOMContentLoaded` 事件中添加:

```javascript
// 更新语言切换器的激活状态
document.querySelectorAll('.lang-option').forEach(option => {
    const optionLang = option.getAttribute('onclick').includes("'zh'") ? 'zh' : 'en';
    if (optionLang === currentLang) {
        option.classList.add('active');
    } else {
        option.classList.remove('active');
    }
});
```

### 3. 工作原理

1. **页面加载时**:
   - 从 `localStorage` 读取保存的语言设置
   - 如果没有保存的设置,默认为 `'en'` (英文)
   - 遍历所有语言选项 (`.lang-option`)
   - 根据当前语言设置,给对应的选项添加 `.active` 类

2. **语言切换时**:
   - `changeLanguage()` 函数更新 `localStorage`
   - 触发 `languageChanged` 事件
   - 所有页面监听该事件并重新翻译内容
   - 按钮激活状态通过 `changeLanguage()` 函数内部的逻辑更新

3. **跨页面导航**:
   - 每个页面加载时都会读取 `localStorage` 中的语言设置
   - 自动设置正确的语言环境
   - 自动激活对应的语言选项按钮

## 修复效果

### ✅ 修复前的问题

- ❌ 首次访问数据页面(英文环境),语言切换按钮可能不显示激活状态
- ❌ 从英文环境的首页切换到数据页面,可能自动变为中文
- ❌ 语言切换按钮不能正确反映当前语言状态

### ✅ 修复后的效果

- ✅ 首次访问任何页面,默认显示英文,语言切换按钮正确显示"English"为激活状态
- ✅ 从英文环境的首页切换到数据页面,保持英文环境
- ✅ 从中文环境的首页切换到数据页面,保持中文环境
- ✅ 语言切换按钮始终正确显示当前语言的激活状态
- ✅ 刷新页面后,语言设置和按钮状态都保持不变

## 测试验证

### 场景 1: 默认英文环境
1. 清除浏览器缓存和 LocalStorage
2. 打开数据页面
3. **期望**: 页面显示英文,点击语言按钮,看到"English"选项高亮

### 场景 2: 中文环境跨页面
1. 在数据页面切换到中文
2. 点击导航菜单访问其他页面
3. **期望**: 所有页面都显示中文,语言按钮都显示"中文"高亮

### 场景 3: 英文环境跨页面
1. 在数据页面切换回英文
2. 点击导航菜单访问其他页面(包括首页)
3. **期望**: 所有页面都显示英文,语言按钮都显示"English"高亮
4. 从首页切换回数据页面
5. **期望**: 数据页面保持英文显示

### 场景 4: 刷新页面
1. 在中文环境下刷新页面
2. **期望**: 页面仍显示中文,语言按钮仍显示"中文"高亮
3. 切换到英文后刷新页面
4. **期望**: 页面仍显示英文,语言按钮仍显示"English"高亮

## 技术细节

### LocalStorage 存储

```javascript
// 键名
'touchscreen_language'

// 可能的值
'zh' // 中文
'en' // 英文(默认)
```

### CSS 激活状态样式

```css
.lang-option.active {
    background: #e5f3ff;  /* 浅蓝色背景 */
    color: #2563eb;       /* 蓝色文字 */
}
```

### 函数调用链

```
页面加载
  ↓
getTouchscreenLang() - 读取语言设置
  ↓
设置 HTML lang 属性
  ↓
应用翻译(如果需要)
  ↓
更新语言切换按钮激活状态 ← 新增的修复
```

## 相关文件

- [touchscreen-i18n.js](touchscreen/touchscreen-i18n.js) - 国际化翻译和工具函数
- [common-header-scripts.js](touchscreen/common-header-scripts.js) - 语言切换逻辑
- [快速测试指南.md](touchscreen/快速测试指南.md) - 完整的测试步骤

## 注意事项

1. **缓存问题**: 修改后需清除浏览器缓存才能看到效果
2. **默认语言**: 系统默认语言为英文(`'en'`),首次访问显示英文
3. **语言保持**: 语言设置保存在 `localStorage` 中,在所有页面间共享
4. **按钮状态**: 语言切换按钮的激活状态现在会自动同步当前语言设置

## 完成状态

✅ **所有要求已完成:**
1. ✅ 从首页切换到数据页面时,保持英文环境
2. ✅ 语言切换按钮正确显示激活状态
3. ✅ 所有页面的语言环境保持一致
4. ✅ 刷新页面后语言设置不丢失
5. ✅ 按钮激活状态始终反映当前语言
