# 🎯 能量流图 - 连线自定义拐弯功能使用说明

## 📖 功能概述

您现在可以**完全自由地调整连线路径**，通过拖拽控制点来创建复杂的连线拐弯效果。

---

## 🚀 快速开始

### 步骤 1: 打开能量流视图

1. 打开 `devices.html` 页面
2. 点击顶部的 **"能量流"** 按钮
3. 看到左侧设备列表和中间的画布

### 步骤 2: 创建设备和连线

1. **拖拽设备到画布**
   - 从左侧列表拖拽设备（如"市电"、"柴发1"等）
   - 放到画布中间任意位置

2. **创建连线**
   - 点击第一个设备，会显示4个连接点（上下左右）
   - 点击其中一个连接点并按住鼠标
   - 拖拽到另一个设备的连接点
   - 松开鼠标，连线创建完成

### 步骤 3: 自定义连线路径 ⭐ 核心功能

#### 方法一：点击连线

1. **鼠标悬停** → 连线会高亮变亮（#00e5ff 颜色，4px 粗细）
2. **点击连线** → 连线变为橙色（#ffaa00），自动显示控制点
3. **拖拽橙色圆点** → 路径实时跟随鼠标移动
4. **点击绿色➕按钮** → 在连线中点添加更多控制点（最多5个）

#### 方法二：右键菜单

1. 右键点击连线
2. 选择菜单项：
   - **🔄 重置路径** - 删除所有控制点，恢复自动智能路径
   - **➕ 添加控制点** - 进入编辑模式
   - **🗑️ 删除连线** - 删除整条连线

---

## 🎨 视觉效果说明

| 状态 | 颜色 | 粗细 | 说明 |
|------|------|------|------|
| 默认 | 蓝色 #00d9ff | 3px | 正常状态 |
| **悬停** | **亮蓝 #00e5ff** | **4px** | **鼠标靠近时** |
| **选中** | **橙色 #ffaa00** | **4px** | **编辑模式** |
| 控制点 | 橙色圆 8px | - | 可拖拽调整位置 |
| 添加按钮 | 绿色圆 6px | - | 点击添加控制点 |

---

## 💡 常见问题

### Q1: 为什么看不到控制点？

**A:** 您需要先**点击连线**才能显示控制点。请确保：
- ✅ 已经创建了连线（两个设备之间有蓝色线）
- ✅ 鼠标悬停时连线会高亮变亮（说明可以点击）
- ✅ 点击连线的**中间位置**（点击区域已扩大到 20px 宽，很容易点到）

### Q2: 鼠标悬停连线不高亮怎么办？

**A:** 请尝试：
1. 刷新页面（Ctrl+F5 或 Cmd+Shift+R）
2. 点击工具栏左上角的**蓝色问号按钮 ？** 查看帮助
3. 检查浏览器控制台是否有 JavaScript 错误

### Q3: 如何取消选中连线？

**A:** 点击画布的**空白处**即可取消选中，连线会恢复蓝色，控制点隐藏。

### Q4: 可以添加多少个控制点？

**A:** 最多可以添加 **5个控制点**，这样可以创建复杂的路径，同时避免过度复杂。

### Q5: 如何恢复默认的智能路径？

**A:** 右键点击连线 → 选择 **"🔄 重置路径"**，所有控制点会被删除，连线恢复自动计算的智能拐弯路径。

---

## 🔧 高级技巧

### 1. 精确控制拐弯角度
- 使用多个控制点创建精确的路径
- 每个控制点可以独立拖拽调整

### 2. 避免连线交叉
- 通过调整控制点位置，让连线绕过其他设备
- 创建清晰的能量流向图

### 3. 保存配置
- 点击工具栏的 **"保存配置"** 按钮
- 自定义的控制点位置会被保存到 LocalStorage
- 下次加载时会恢复所有自定义路径

---

## 🎯 操作流程图

```
1. 创建连线
   ↓
2. 鼠标悬停 → 连线高亮
   ↓
3. 点击连线 → 变橙色，显示控制点🟠
   ↓
4. 拖拽控制点 → 路径实时更新
   ↓
5. 点击绿色+按钮 → 添加更多控制点
   ↓
6. 右键菜单 → 重置/删除
   ↓
7. 点击空白处 → 完成编辑
```

---

## ⌨️ 快捷操作

| 操作 | 效果 |
|------|------|
| 鼠标悬停连线 | 连线高亮提示 |
| 点击连线 | 进入编辑模式，显示控制点 |
| 拖拽橙色圆点 | 实时调整路径 |
| 点击绿色+按钮 | 添加新控制点 |
| 右键连线 | 显示操作菜单 |
| 点击空白处 | 退出编辑模式 |
| Esc 键 | （待实现）快速退出编辑 |

---

## 🐛 调试模式

打开浏览器控制台（F12），可以使用以下命令调试：

```javascript
// 查看所有连线
console.log(window.deviceConnections);

// 查看当前选中的连线索引
console.log(window.selectedConnection);

// 手动选中第一条连线
window.selectConnection(0);

// 查看所有放置的设备
console.log(window.placedDevices);

// 手动重绘连线
window.drawAllConnections();
```

---

## 📝 示例操作

### 创建一个 Z 字形连线

1. 创建"市电"到"PCS1"的连线
2. 点击连线，显示控制点
3. 点击绿色+按钮，添加第二个控制点
4. 拖拽第一个控制点到左侧
5. 拖拽第二个控制点到右侧
6. 形成 Z 字形路径

### 创建绕行连线（避开障碍物）

1. 创建连线
2. 点击连线选中
3. 添加多个控制点（2-3个）
4. 逐个拖拽控制点，让连线绕过中间的设备
5. 创建清晰的能量流向路径

---

## 🎉 更新日志

### v1.0.0 (当前版本)
- ✅ 支持连线点击选中
- ✅ 可拖拽的橙色控制点
- ✅ 绿色添加按钮
- ✅ 右键菜单（重置/删除）
- ✅ 路径实时更新
- ✅ 20px 宽的点击区域
- ✅ 鼠标悬停高亮效果
- ✅ 帮助按钮和使用指南

### 计划功能
- ⏳ Esc 键快速退出编辑
- ⏳ Ctrl+Z 撤销操作
- ⏳ 连线样式选择（直线/曲线/折线）
- ⏳ 控制点吸附网格
- ⏳ 批量编辑多条连线

---

## 💬 反馈与支持

如果遇到问题或有功能建议，请：

1. 点击工具栏的 **蓝色问号按钮 ？** 查看帮助
2. 检查浏览器控制台的错误信息
3. 尝试刷新页面重新操作

---

**祝您使用愉快！🎨✨**
