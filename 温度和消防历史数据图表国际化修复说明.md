# 温度和消防历史数据图表国际化修复说明

## 问题描述
在触摸屏数据页面 (touchscreen/data.html) 的温度(Temp)和消防(Fire Protection)历史数据图表中,以下文本在英文环境下仍显示中文:

### 温度(Temp)图表问题

#### 问题1: 温度分布历史图
- Y轴标签: "温度 (°C)"
- X轴标签: "时间"

#### 问题2: 冷却系统运行图
- 左Y轴标签: "温度 (°C)"
- 右Y轴标签: "湿度 (%RH)"

#### 问题3: 温度热力图
- 左Y轴标签: "转速 (RPM)"
- 右Y轴标签: "功耗 (kW)"

### 消防(Fire Protection)图表问题

#### 问题4: 气体浓度监测图
- Y轴标签: "浓度 (ppm)"

#### 问题5: 告警记录分析图
- Y轴标签: "告警次数"
- Tooltip中: "次" 字

## 问题位置

### 文件: `touchscreen/data.html`

**温度分布历史图 (第6957-7051行)**
```javascript
scales: {
    y: {
        title: {
            text: '温度 (°C)',  // 硬编码中文
        }
    },
    x: {
        title: {
            text: '时间',  // 硬编码中文
        }
    }
}
```

**冷却系统运行图 (第7054-7149行)**
```javascript
scales: {
    y: {
        title: {
            text: '温度 (°C)',  // 硬编码中文
        }
    },
    y1: {
        title: {
            text: '湿度 (%RH)',  // 硬编码中文
        }
    }
}
```

**温度热力图 (第7152-7238行)**
```javascript
scales: {
    y: {
        title: {
            text: '转速 (RPM)',  // 硬编码中文
        }
    },
    y1: {
        title: {
            text: '功耗 (kW)',  // 硬编码中文
        }
    }
}
```

**气体浓度监测图 (第7273-7332行)**
```javascript
scales: {
    y: {
        title: {
            text: '浓度 (ppm)',  // 硬编码中文
        }
    }
}
```

**告警记录分析图 (第7335-7413行)**
```javascript
tooltip: {
    callbacks: {
        label: function(context) {
            label += context.parsed.y + ' 次';  // 硬编码中文
        }
    }
},
scales: {
    y: {
        title: {
            text: '告警次数',  // 硬编码中文
        }
    }
}
```

## 修复方案

### 1. 添加翻译键到 translateLabel 函数

在 `data.html` 的 `translateLabel()` 函数的翻译映射表中添加以下键值对(第4295-4304行):

```javascript
// 时间单位
'时': ':00',
'时间': 'Time',

// 温度湿度相关
'湿度': 'Humidity',
'转速': 'Speed',
'功耗': 'Power Consumption',
'浓度': 'Concentration',
'告警次数': 'Alarm Count',
```

### 2. 修复图表代码

**修改1: 温度分布历史图 (第7020-7048行)**

修改前:
```javascript
scales: {
    y: {
        title: {
            text: '温度 (°C)',
        }
    },
    x: {
        title: {
            text: '时间',
        }
    }
}
```

修改后:
```javascript
scales: {
    y: {
        title: {
            text: translateLabel('温度') + ' (°C)',
        }
    },
    x: {
        title: {
            text: translateLabel('时间'),
        }
    }
}
```

**修改2: 冷却系统运行图 (第7103-7138行)**

修改前:
```javascript
scales: {
    y: {
        title: {
            text: '温度 (°C)',
        }
    },
    y1: {
        title: {
            text: '湿度 (%RH)',
        }
    }
}
```

修改后:
```javascript
scales: {
    y: {
        title: {
            text: translateLabel('温度') + ' (°C)',
        }
    },
    y1: {
        title: {
            text: translateLabel('湿度') + ' (%RH)',
        }
    }
}
```

**修改3: 温度热力图 (第7194-7227行)**

修改前:
```javascript
scales: {
    y: {
        title: {
            text: '转速 (RPM)',
        }
    },
    y1: {
        title: {
            text: '功耗 (kW)',
        }
    }
}
```

修改后:
```javascript
scales: {
    y: {
        title: {
            text: translateLabel('转速') + ' (RPM)',
        }
    },
    y1: {
        title: {
            text: translateLabel('功耗') + ' (kW)',
        }
    }
}
```

**修改4: 气体浓度监测图 (第7307-7314行)**

修改前:
```javascript
scales: {
    y: {
        title: {
            text: '浓度 (ppm)',
        }
    }
}
```

修改后:
```javascript
scales: {
    y: {
        title: {
            text: translateLabel('浓度') + ' (ppm)',
        }
    }
}
```

**修改5: 告警记录分析图 (第7372-7402行)**

修改前:
```javascript
tooltip: {
    callbacks: {
        label: function(context) {
            let label = context.dataset.label || '';
            if (label) {
                label += ': ';
            }
            label += context.parsed.y + ' 次';
            return label;
        }
    }
},
scales: {
    y: {
        title: {
            text: '告警次数',
        }
    }
}
```

修改后:
```javascript
tooltip: {
    callbacks: {
        label: function(context) {
            let label = context.dataset.label || '';
            if (label) {
                label += ': ';
            }
            label += context.parsed.y + ' ' + translateLabel('次');
            return label;
        }
    }
},
scales: {
    y: {
        title: {
            text: translateLabel('告警次数'),
        }
    }
}
```

## 修复内容总结

### 新增翻译键
| 中文 | 英文 | 翻译键 | 用途 |
|------|------|--------|------|
| 时间 | Time | '时间' | X轴标签 |
| 湿度 | Humidity | '湿度' | Y轴标签 |
| 转速 | Speed | '转速' | Y轴标签 |
| 功耗 | Power Consumption | '功耗' | Y轴标签 |
| 浓度 | Concentration | '浓度' | Y轴标签 |
| 告警次数 | Alarm Count | '告警次数' | Y轴标签 |

注: "温度"翻译已存在于翻译表中

### 修复的5个图表

1. ✅ **温度分布历史图 (Temperature Distribution History)**
   - Y轴: 温度 → Temperature
   - X轴: 时间 → Time

2. ✅ **冷却系统运行图 (Cooling System Operation)**
   - 左Y轴: 温度 → Temperature
   - 右Y轴: 湿度 → Humidity

3. ✅ **温度热力图 (Temperature Heat Map)**
   - 左Y轴: 转速 → Speed
   - 右Y轴: 功耗 → Power Consumption

4. ✅ **气体浓度监测图 (Gas Concentration Monitoring)**
   - Y轴: 浓度 → Concentration

5. ✅ **告警记录分析图 (Alarm Record Analysis)**
   - Y轴: 告警次数 → Alarm Count
   - Tooltip: 次 → times (已存在翻译)

## 修复效果

### 英文环境下

**温度图表:**
- 温度分布历史: Y轴 "Temperature (°C)", X轴 "Time"
- 冷却系统运行: 左Y轴 "Temperature (°C)", 右Y轴 "Humidity (%RH)"
- 温度热力图: 左Y轴 "Speed (RPM)", 右Y轴 "Power Consumption (kW)"

**消防图表:**
- 气体浓度监测: Y轴 "Concentration (ppm)"
- 告警记录分析: Y轴 "Alarm Count", Tooltip "1 times", "2 times"

### 中文环境下

**温度图表:**
- 温度分布历史: Y轴 "温度 (°C)", X轴 "时间"
- 冷却系统运行: 左Y轴 "温度 (°C)", 右Y轴 "湿度 (%RH)"
- 温度热力图: 左Y轴 "转速 (RPM)", 右Y轴 "功耗 (kW)"

**消防图表:**
- 气体浓度监测: Y轴 "浓度 (ppm)"
- 告警记录分析: Y轴 "告警次数", Tooltip "1 次", "2 次"

### 语言切换
- ✅ 切换语言后,页面刷新时图表会使用对应语言显示
- ✅ 不影响图表的任何功能和交互
- ✅ 不影响其他页面的布局和内容

## 测试方法

### 英文环境完整测试

1. **打开触摸屏系统**
   - 访问: `touchscreen/touchscreen-display.html`
   - 确认右上角语言为英文

2. **测试温度图表**
   - 点击左侧 Temp
   - 点击 Historical Data 标签
   - 验证3个图表:
     - Temperature Distribution History: Y轴 "Temperature (°C)", X轴 "Time"
     - Cooling System Operation: 左Y轴 "Temperature (°C)", 右Y轴 "Humidity (%RH)"
     - Temperature Heat Map: 左Y轴 "Speed (RPM)", 右Y轴 "Power Consumption (kW)"

3. **测试消防图表**
   - 点击左侧 Fire Prote... (Fire Protection)
   - 点击 Historical Data 标签
   - 验证2个图表:
     - Gas Concentration Monitoring: Y轴 "Concentration (ppm)"
     - Alarm Record Analysis: Y轴 "Alarm Count", 悬停查看Tooltip显示 "... times"

### 中文环境测试
1. 切换到中文
2. 重复上述所有测试
3. 验证所有标签正确显示中文

### 语言切换测试
1. 在温度或消防历史数据页面停留
2. 来回切换中英文
3. 观察页面刷新后图表标签是否正确

## 技术说明

### Y轴标签翻译策略
所有Y轴标签遵循格式: `translateLabel('标签文字') + ' (单位)'`
- 中文部分使用翻译函数
- 单位部分保留国际标准符号(°C, %RH, RPM, kW, ppm)

### X轴标签
温度分布历史图的X轴标签"时间"也需要翻译,其他图表X轴直接使用时间数值(0:00, 1:00等),无需翻译。

### Tooltip翻译
告警记录分析图的tooltip使用回调函数动态生成文本,需要在函数内部调用 `translateLabel('次')` 获取翻译。

### 单位标准化
- 温度: °C (摄氏度)
- 湿度: %RH (相对湿度百分比)
- 转速: RPM (转/分钟)
- 功耗: kW (千瓦)
- 浓度: ppm (百万分之一)

## 相关文件
- `touchscreen/data.html` - 数据页面主文件
- `touchscreen/touchscreen-i18n.js` - 触摸屏国际化配置
- `touchscreen/touchscreen-display.html` - 触摸屏显示入口

## 注意事项
1. ✅ **已验证兼容性**: 修复不影响其他图表和组件
2. ✅ **性能无影响**: translateLabel() 函数调用开销极小
3. ✅ **维护性良好**: 所有翻译集中在 labelTranslations 对象中
4. ✅ **标准符合性**: 单位符号遵循国际标准
5. ⚠️ **图表刷新**: 语言切换后需要刷新页面才能看到图表语言更新(这是现有设计)

## 修复日期
2026-01-15
