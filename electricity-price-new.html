<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate="elecPricePageTitle">电价设置</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        .container {
            padding: 24px;
            /* max-width: 1600px; */
            width: 100%;
            margin: 0 auto;
        }

        /* 页面标题 */
        .page-header {
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 8px 0;
        }

        .page-description {
            font-size: 14px;
            color: #64748b;
            margin: 0;
        }

        /* Tab导航 */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: -2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: #3b82f6;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 数据表格区域 */
        .card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: visible;
            margin-bottom: 24px;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .card-actions {
            display: flex;
            gap: 12px;
        }

        /* 按钮样式 */
        .btn {
            height: 36px;
            padding: 0 16px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            width: auto;
            flex-shrink: 0;
            min-width: fit-content;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-text {
            background: transparent;
            color: #3b82f6;
            padding: 0 8px;
            height: auto;
        }

        .btn-text:hover {
            color: #2563eb;
            background: rgba(59, 130, 246, 0.1);
        }

        .btn-danger {
            background: #ef4444;
            color: #ffffff;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #22c55e;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-sm {
            height: 32px;
            padding: 0 12px;
            font-size: 13px;
            gap: 6px;
        }

        /* 模版网格 */
        .template-grid {
            padding: 20px;
        }

        /* 表格 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: #f8fafc;
        }

        .data-table th {
            padding: 14px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        .data-table td {
            padding: 16px 20px;
            font-size: 14px;
            color: #1e293b;
        }

        /* 标签 */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-primary {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .badge-warning {
            background: rgba(234, 179, 8, 0.15);
            color: #eab308;
        }

        .badge-gray {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
        }

        .badge-purple {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* 操作按钮组 */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }

        /* 站点卡片 */
        .site-list {
            padding: 20px;
        }

        /* 站点表格特殊样式 */
        .data-table .check-icon {
            color: #10b981;
            font-size: 16px;
            margin-right: 6px;
        }

        .data-table .uncheck-icon {
            color: #cbd5e1;
            font-size: 16px;
            margin-right: 6px;
        }

        .data-table .template-cell {
            display: flex;
            align-items: center;
        }

        .data-table td:nth-child(2),
        .data-table td:nth-child(6),
        .data-table th:nth-child(2),
        .data-table th:nth-child(6) {
            text-align: center;
        }

        /* 文字截断样式 */
        .text-truncate {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: help;
        }

        /* 配置标签页样式 */
        .config-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .config-tab {
            flex: 1;
            padding: 14px 20px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .config-tab:hover {
            color: #3b82f6;
            background: #f8fafc;
        }

        .config-tab.active {
            color: #3b82f6;
            font-weight: 600;
        }

        .config-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #3b82f6;
        }

        .config-tab-content {
            display: none;
        }

        .config-tab-content.active {
            display: block;
        }

        .site-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .site-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }

        .site-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .site-name {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .site-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .info-label {
            font-size: 12px;
            color: #64748b;
        }

        .info-value {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        /* 模态框 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .modal-close:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* 表单 */
        .form-section {
            margin-bottom: 32px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }



        .form-label {
            font-size: 13px;
            font-weight: 500;
            color: #64748b;
        }

        .form-label.required::after {
            content: '*';
            color: #ef4444;
            margin-left: 4px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            height: 36px;
            padding: 0 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            color: #1e293b;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-textarea {
            height: auto;
            min-height: 80px;
            padding: 10px 12px;
            resize: vertical;
        }

        .form-input:hover,
        .form-select:hover,
        .form-textarea:hover {
            border-color: #3b82f6;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 时段配置按钮 */
        .add-period-btn {
            width: 100%;
            height: 40px;
            border: 1px dashed #e2e8f0;
            background: transparent;
            color: #3b82f6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .add-period-btn:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        /* 时段配置卡片 */
        .period-config {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .period-config:hover {
            border-color: #cbd5e1;
        }

        .period-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .period-name {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .period-tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
        }

        .period-tag.super-peak {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .period-tag.peak {
            background: rgba(234, 179, 8, 0.15);
            color: #eab308;
        }

        .period-tag.flat {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .period-tag.valley {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .period-time {
            font-size: 13px;
            color: #64748b;
            font-weight: 500;
        }

        .period-fields {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .period-remove {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .period-remove:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* 时段类型组 */
        .period-type-group {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .period-type-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }

        .period-type-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            font-weight: 600;
        }

        .period-type-actions {
            display: flex;
            gap: 8px;
        }

        .time-slot-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .time-slot-item:last-child {
            margin-bottom: 0;
        }

        .time-slot-fields {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .time-slot-remove {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .time-slot-remove:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 48px;
            color: #cbd5e1;
            margin-bottom: 16px;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            margin: 0 0 8px 0;
        }

        .empty-state-description {
            font-size: 14px;
            color: #94a3b8;
            margin: 0;
        }

        /* 模式选择卡片 */
        .mode-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }

        .mode-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .mode-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 8px 0;
        }

        .mode-desc {
            font-size: 13px;
            color: #64748b;
            margin: 0;
            line-height: 1.5;
        }

        /* 预设模版卡片 */
        .preset-template-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-template-card:hover {
            border-color: #3b82f6;
            background: white;
        }

        .preset-template-card.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .preset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .preset-name {
            font-size: 15px;
            font-weight: 600;
            color: #1e293b;
        }

        .preset-desc {
            font-size: 13px;
            color: #64748b;
            margin-bottom: 12px;
        }

        .preset-periods {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .preset-period-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        /* 下拉按钮 */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            height: 36px;
            padding: 0 16px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
        }

        .dropdown-btn:hover {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .dropdown-btn i.fa-chevron-down {
            margin-left: 4px;
            font-size: 12px;
            transition: transform 0.2s;
        }

        .dropdown.active .dropdown-btn i.fa-chevron-down {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            min-width: 200px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
            z-index: 1000;
            overflow: hidden;
        }

        .dropdown.active .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f1f5f9;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #f8fafc;
        }

        .dropdown-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            font-size: 16px;
        }

        .dropdown-item-text {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
        }

        /* Toast提示 */
        .toast {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 0.75rem 1.125rem;
            border-radius: 0.375rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.625rem;
            font-size: 0.875rem;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body data-page="electricity-price-new">
    <!-- 导航栏容器 -->
    <div id="navbar-container"></div>

    <!-- 主内容区 -->
    <main class="main-content">
        <div class="container">
            <!-- Tab导航 -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('consumption-templates')">
                    <i class="fas fa-download"></i>
                    <span data-translate="elecPriceTabConsumption">购电模板</span>
                </button>
                <button class="tab-btn" onclick="switchTab('feedin-templates')">
                    <i class="fas fa-upload"></i>
                    <span data-translate="elecPriceTabFeedin">上网模板</span>
                </button>
                <button class="tab-btn" onclick="switchTab('sites')">
                    <i class="fas fa-building"></i>
                    <span data-translate="elecPriceTabSiteConfig">电站配置</span>
                </button>
            </div>

            <!-- Tab 1: 购电模版 -->
            <div class="tab-content active" id="consumption-templates-tab">
                <div class="card">
                    <div class="card-header">
                        <div class="dropdown" id="createDropdownConsumption">
                            <button class="dropdown-btn" onclick="toggleCreateDropdown('consumption')">
                                <i class="fas fa-plus"></i>
                                <span data-translate="elecPriceBtnNewRule">新建规则</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="selectCreateMode('preset', 'consumption')">
                                    <div class="dropdown-item-icon">
                                        <i class="fas fa-cube"></i>
                                    </div>
                                    <div class="dropdown-item-text" data-translate="elecPriceCreateModeTemplate">从模版创建</div>
                                </div>
                                <div class="dropdown-item" onclick="selectCreateMode('custom', 'consumption')">
                                    <div class="dropdown-item-icon">
                                        <i class="fas fa-pencil-alt"></i>
                                    </div>
                                    <div class="dropdown-item-text" data-translate="elecPriceCreateModeCustom">自定义创建</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-translate="elecPriceTableHeaderName">模版名称</th>
                                <th data-translate="elecPriceTableHeaderType">电价类型</th>
                                <th data-translate="elecPriceTableHeaderDesc">描述</th>
                                <th data-translate="elecPriceTableHeaderAppliedSites">已应用站点</th>
                                <th data-translate="elecPriceTableHeaderCreateTime">创建时间</th>
                                <th data-translate="elecPriceTableHeaderActions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="consumptionTemplatesTableBody">
                            <!-- 数据将由JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: 上网模版 -->
            <div class="tab-content" id="feedin-templates-tab">
                <div class="card">
                    <div class="card-header">
                        <div class="dropdown" id="createDropdownFeedin">
                            <button class="dropdown-btn" onclick="toggleCreateDropdown('feed-in')">
                                <i class="fas fa-plus"></i>
                                <span data-translate="elecPriceBtnNewRule">新建规则</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" onclick="selectCreateMode('preset', 'feed-in')">
                                    <div class="dropdown-item-icon">
                                        <i class="fas fa-cube"></i>
                                    </div>
                                    <div class="dropdown-item-text" data-translate="elecPriceCreateModeTemplate">从模版创建</div>
                                </div>
                                <div class="dropdown-item" onclick="selectCreateMode('custom', 'feed-in')">
                                    <div class="dropdown-item-icon">
                                        <i class="fas fa-pencil-alt"></i>
                                    </div>
                                    <div class="dropdown-item-text" data-translate="elecPriceCreateModeCustom">自定义创建</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-translate="elecPriceTableHeaderName">模版名称</th>
                                <th data-translate="elecPriceTableHeaderType">电价类型</th>
                                <th data-translate="elecPriceTableHeaderDesc">描述</th>
                                <th data-translate="elecPriceTableHeaderAppliedSites">已应用站点</th>
                                <th data-translate="elecPriceTableHeaderCreateTime">创建时间</th>
                                <th data-translate="elecPriceTableHeaderActions">操作</th>
                            </tr>
                        </thead>
                        <tbody id="feedinTemplatesTableBody">
                            <!-- 数据将由JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: 电站配置 -->
            <div class="tab-content" id="sites-tab">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title" data-translate="elecPriceSiteConfigTitle">电站电价配置</h2>
                    </div>
                    <div class="site-list" id="siteList">
                        <!-- 电站列表由JS渲染 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 创建方式选择模态框 -->
    <div class="modal" id="createModeModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" data-translate="elecPriceModalTitleNewTemplate">新建电价模版</h3>
                <button class="modal-close" onclick="closeCreateModeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px 0;">
                    <div class="mode-card" onclick="openPresetTemplateModal()">
                        <div class="mode-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <h4 class="mode-title" data-translate="elecPriceCreateModeTemplate">从模版创建</h4>
                        <p class="mode-desc" data-translate="elecPriceCreateModeTemplateDesc">选择预设的电价模版，快速创建常用配置</p>
                    </div>
                    <div class="mode-card" onclick="openCustomTemplateModal()">
                        <div class="mode-icon">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <h4 class="mode-title" data-translate="elecPriceCreateModeCustom">自定义创建</h4>
                        <p class="mode-desc" data-translate="elecPriceCreateModeCustomDesc">完全自定义配置，灵活设置时段和策略</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 预设模版选择模态框 -->
    <div class="modal" id="presetTemplateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 class="modal-title" id="presetModalTitle" data-translate="elecPriceModalTitleSelectPreset">选择预设模版</h3>
                    <p style="margin: 8px 0 0 0; font-size: 13px; color: #64748b;" data-translate="elecPriceModalDescSelectPreset">选择一个预设电价模版作为起点</p>
                </div>
                <button class="modal-close" onclick="closePresetTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="presetTemplatesContainer" style="display: grid; gap: 12px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePresetTemplateModal()" data-translate="elecPriceBtnCancel">取消</button>
                <button class="btn btn-primary" id="applyPresetBtn" onclick="applyPresetTemplate()" style="display: none;">
                    <i class="fas fa-check"></i>
                    <span data-translate="elecPriceBtnUseTemplate">使用此模版</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 自定义模版编辑模态框 -->
    <div class="modal" id="customTemplateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="customModalTitle" data-translate="elecPriceModalTitleCustomCreate">自定义创建模版</h3>
                <button class="modal-close" onclick="closeCustomTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="templateForm">
                    <div class="form-section">
                        <h4 class="form-section-title" data-translate="elecPriceFormSectionBasicInfo">基本信息</h4>

                        <!-- 模版用途（隐藏字段，由Tab自动确定） -->
                        <input type="hidden" id="templatePurpose" required>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label required" data-translate="elecPriceFormLabelTemplateName">模版名称</label>
                                <input type="text" class="form-input" id="templateName" data-translate-placeholder="elecPriceFormPlaceholderTemplateName" placeholder="如：夏季居民阶梯电价" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label required" data-translate="elecPriceFormLabelTemplateType">策略类型</label>
                                <select class="form-select" id="templateType" required onchange="onTypeChange()" disabled>
                                    <option value="" data-translate="elecPriceFormPlaceholderSelectPurpose">请先选择模版用途</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 时段配置区域 -->
                    <div id="periodsSection" style="display: none;">
                        <div class="form-section">
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <!-- 策略类型选择 -->
                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 14px; color: #374151; font-weight: 500; margin-bottom: 12px; display: block;" data-translate="elecPriceFormLabelStrategyType">策略类型</label>
                                    <div style="display: flex; gap: 16px; align-items: center;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="periodStrategyMode" value="fixed" checked onchange="switchPeriodStrategyMode('fixed')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeFixed">固定</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeFixedDesc" title="全年使用同一套时段配置"></i>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="periodStrategyMode" value="monthly" onchange="switchPeriodStrategyMode('monthly')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeMonthly">逐月</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeMonthlyDesc" title="每个月使用不同的时段配置"></i>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="periodStrategyMode" value="seasonal" onchange="switchPeriodStrategyMode('seasonal')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeSeasonal">分季节</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeSeasonalDesc" title="按季节使用不同的时段配置"></i>
                                        </label>
                                    </div>
                                </div>

                                <!-- 季节配置区域（仅在分季节模式下显示） -->
                                <div id="periodSeasonConfigArea" style="display: none; margin-bottom: 16px;">
                                    <div id="periodSeasonConfigList"></div>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addPeriodSeasonInline()">
                                        <i class="fas fa-plus"></i> <span data-translate="elecPriceBtnAddSeason">添加季节</span>
                                    </button>
                                </div>

                                <!-- 月份标签页（仅在逐月模式下显示） -->
                                <div id="periodMonthlyTabs" style="display: none; margin-bottom: 16px;">
                                    <div style="display: flex; gap: 4px; flex-wrap: wrap; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                                        <button type="button" class="period-month-tab active" data-month="1" onclick="switchPeriodMonth(1)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #3b82f6; border-bottom: 2px solid #3b82f6; margin-bottom: -10px;" data-translate="elecPriceMonthJan">一月</button>
                                        <button type="button" class="period-month-tab" data-month="2" onclick="switchPeriodMonth(2)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthFeb">二月</button>
                                        <button type="button" class="period-month-tab" data-month="3" onclick="switchPeriodMonth(3)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthMar">三月</button>
                                        <button type="button" class="period-month-tab" data-month="4" onclick="switchPeriodMonth(4)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthApr">四月</button>
                                        <button type="button" class="period-month-tab" data-month="5" onclick="switchPeriodMonth(5)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthMay">五月</button>
                                        <button type="button" class="period-month-tab" data-month="6" onclick="switchPeriodMonth(6)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthJun">六月</button>
                                        <button type="button" class="period-month-tab" data-month="7" onclick="switchPeriodMonth(7)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthJul">七月</button>
                                        <button type="button" class="period-month-tab" data-month="8" onclick="switchPeriodMonth(8)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthAug">八月</button>
                                        <button type="button" class="period-month-tab" data-month="9" onclick="switchPeriodMonth(9)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthSep">九月</button>
                                        <button type="button" class="period-month-tab" data-month="10" onclick="switchPeriodMonth(10)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthOct">十月</button>
                                        <button type="button" class="period-month-tab" data-month="11" onclick="switchPeriodMonth(11)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthNov">十一月</button>
                                        <button type="button" class="period-month-tab" data-month="12" onclick="switchPeriodMonth(12)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthDec">十二月</button>
                                    </div>
                                </div>

                                <!-- 季节标签页（仅在分季节模式下显示） -->
                                <div id="periodSeasonTabs" style="display: none; margin-bottom: 16px;">
                                    <div style="display: flex; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; overflow-x: auto;">
                                        <div id="periodSeasonTabsList" style="display: flex; gap: 8px;"></div>
                                    </div>
                                </div>
                            </div>

                            <div style="margin-top: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                    <p style="font-size: 13px; color: #64748b; margin: 0;" data-translate="elecPricePeriodInstruction">选择时段类型，然后为该类型添加一个或多个时间段</p>
                                    <button type="button" class="btn btn-sm" style="background: #f8fafc; color: #475569; border: 1px solid #e2e8f0;" onclick="openPeriodTypeManager()">
                                        <i class="fas fa-cog"></i> <span data-translate="elecPriceBtnManagePeriodTypes">管理时段类型</span>
                                    </button>
                                </div>

                                <!-- 时段类型选择按钮（动态生成） -->
                                <div id="periodTypeButtonsContainer" style="display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap;">
                                    <!-- 按钮将由 renderPeriodTypeButtons() 函数动态生成 -->
                                </div>

                                <!-- 时段类型组容器 -->
                                <div id="periodsContainer"></div>

                                <!-- 24小时时段覆盖情况 -->
                                <div id="timelineVisualization" style="margin-top: 20px; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h4 style="font-size: 13px; font-weight: 600; color: #374151; margin: 0;" data-translate="elecPeriodCoverageTitle">24小时时段覆盖情况</h4>
                                        <div id="coverageStats" style="font-size: 12px; color: #64748b;">
                                            <!-- 覆盖率统计 -->
                                        </div>
                                    </div>

                                    <!-- 时间轴 -->
                                    <div style="position: relative; height: 20px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div id="timelineBar" style="position: relative; width: 100%; height: 100%;">
                                            <!-- 时间段色块由JavaScript动态生成 -->
                                        </div>
                                    </div>

                                    <!-- 时间刻度 -->
                                    <div style="display: flex; justify-content: space-between; margin-top: 6px; padding: 0 2px;">
                                        <span style="font-size: 10px; color: #9ca3af;">0:00</span>
                                        <span style="font-size: 10px; color: #9ca3af;">6:00</span>
                                        <span style="font-size: 10px; color: #9ca3af;">12:00</span>
                                        <span style="font-size: 10px; color: #9ca3af;">18:00</span>
                                        <span style="font-size: 10px; color: #9ca3af;">24:00</span>
                                    </div>

                                    <!-- 提示信息 -->
                                    <div id="timelineWarnings" style="margin-top: 10px;">
                                        <!-- 警告信息由JavaScript动态生成 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 阶梯配置区域 -->
                    <div id="tiersSection" style="display: none;">
                        <div class="form-section">
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <!-- 时段配置模式选择 -->
                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 14px; color: #374151; font-weight: 500; margin-bottom: 12px; display: block;" data-translate="elecPriceFormSectionTierConfig">时段配置</label>
                                    <div style="display: flex; gap: 16px; align-items: center;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="tierPeriodMode" value="fixed" checked onchange="switchPeriodMode('fixed')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeFixed">固定</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeFixedDesc" title="全年使用同一套阶梯标准"></i>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="tierPeriodMode" value="monthly" onchange="switchPeriodMode('monthly')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeMonthly">逐月</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeMonthlyDesc" title="每个月使用不同的阶梯标准"></i>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="tierPeriodMode" value="seasonal" onchange="switchPeriodMode('seasonal')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeSeasonal">分季节</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeSeasonalDesc" title="按季节使用不同的阶梯标准"></i>
                                        </label>
                                    </div>
                                </div>

                                <!-- 季节配置区域（仅在分季节模式下显示） -->
                                <div id="seasonConfigArea" style="display: none; margin-bottom: 16px;">
                                    <div id="seasonConfigList"></div>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addSeasonInline()">
                                        <i class="fas fa-plus"></i> <span data-translate="elecPriceBtnAddSeason">添加季节</span>
                                    </button>
                                </div>

                                <!-- 月份标签页（仅在逐月模式下显示） -->
                                <div id="monthlyTabs" style="display: none; margin-bottom: 16px;">
                                    <div style="display: flex; gap: 4px; flex-wrap: wrap; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                                        <button type="button" class="month-tab active" data-month="1" onclick="switchMonth(1)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #3b82f6; border-bottom: 2px solid #3b82f6; margin-bottom: -10px;" data-translate="elecPriceMonthJan">一月</button>
                                        <button type="button" class="month-tab" data-month="2" onclick="switchMonth(2)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthFeb">二月</button>
                                        <button type="button" class="month-tab" data-month="3" onclick="switchMonth(3)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthMar">三月</button>
                                        <button type="button" class="month-tab" data-month="4" onclick="switchMonth(4)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthApr">四月</button>
                                        <button type="button" class="month-tab" data-month="5" onclick="switchMonth(5)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthMay">五月</button>
                                        <button type="button" class="month-tab" data-month="6" onclick="switchMonth(6)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthJun">六月</button>
                                        <button type="button" class="month-tab" data-month="7" onclick="switchMonth(7)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthJul">七月</button>
                                        <button type="button" class="month-tab" data-month="8" onclick="switchMonth(8)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthAug">八月</button>
                                        <button type="button" class="month-tab" data-month="9" onclick="switchMonth(9)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthSep">九月</button>
                                        <button type="button" class="month-tab" data-month="10" onclick="switchMonth(10)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthOct">十月</button>
                                        <button type="button" class="month-tab" data-month="11" onclick="switchMonth(11)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthNov">十一月</button>
                                        <button type="button" class="month-tab" data-month="12" onclick="switchMonth(12)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthDec">十二月</button>
                                    </div>
                                </div>

                                <!-- 季节标签页（仅在分季节模式下显示） -->
                                <div id="seasonTabs" style="display: none; margin-bottom: 16px;">
                                    <div style="display: flex; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; overflow-x: auto;">
                                        <div id="seasonTabsList" style="display: flex; gap: 8px;"></div>
                                    </div>
                                </div>

                                <!-- 阶梯容器 - 横向排列 -->
                                <div id="tiersContainer" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;"></div>

                                <!-- 阶梯预览卡片 -->
                                <div id="tierVisualization" style="margin-bottom: 16px; padding: 16px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                        <h4 style="font-size: 13px; font-weight: 600; color: #374151; margin: 0;" data-translate="elecPriceTierPreview">阶梯配置预览</h4>
                                        <div id="tierStats" style="font-size: 12px; color: #64748b;">
                                            <!-- 统计信息 -->
                                        </div>
                                    </div>

                                    <!-- 阶梯条形图 -->
                                    <div style="position: relative; height: 20px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 4px; overflow: hidden;">
                                        <div id="tierBar" style="position: relative; width: 100%; height: 100%; display: flex;">
                                            <!-- 阶梯色块由JavaScript动态生成 -->
                                        </div>
                                    </div>

                                    <!-- 提示信息 -->
                                    <div id="tierWarnings" style="margin-top: 10px;">
                                        <!-- 提示信息由JavaScript动态生成 -->
                                    </div>
                                </div>

                                <div style="display: flex; gap: 8px;">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addTier()">
                                        <i class="fas fa-plus"></i> <span data-translate="elecPriceBtnAddTier">新建阶梯</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 固定电价配置区域 -->
                    <div id="fixedPriceSection" style="display: none;">
                        <div class="form-section">
                            <div style="background: #f8fafc; padding: 16px; border-radius: 8px;">
                                <!-- 策略类型选择 -->
                                <div style="margin-bottom: 16px;">
                                    <label style="font-size: 14px; color: #374151; font-weight: 500; margin-bottom: 12px; display: block;" data-translate="elecPriceFormLabelStrategyType">策略类型</label>
                                    <div style="display: flex; gap: 16px; align-items: center;">
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="fixedPriceStrategyMode" value="fixed" checked onchange="switchFixedPriceStrategyMode('fixed')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeFixed">固定</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeFixedDesc" title="全年使用同一电价"></i>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="fixedPriceStrategyMode" value="monthly" onchange="switchFixedPriceStrategyMode('monthly')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeMonthly">逐月</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeMonthlyDesc" title="每个月使用不同的电价"></i>
                                        </label>
                                        <label style="display: flex; align-items: center; cursor: pointer;">
                                            <input type="radio" name="fixedPriceStrategyMode" value="seasonal" onchange="switchFixedPriceStrategyMode('seasonal')" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                                            <span style="font-size: 14px; color: #374151;" data-translate="elecPriceModeSeasonal">分季节</span>
                                            <i class="fas fa-info-circle" style="color: #9ca3af; margin-left: 4px; font-size: 12px;" data-translate-title="elecPriceModeSeasonalDesc" title="按季节使用不同的电价"></i>
                                        </label>
                                    </div>
                                </div>

                                <!-- 季节配置区域（仅在分季节模式下显示） -->
                                <div id="fixedPriceSeasonConfigArea" style="display: none; margin-bottom: 16px;">
                                    <div id="fixedPriceSeasonConfigList"></div>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="addFixedPriceSeasonInline()">
                                        <i class="fas fa-plus"></i> <span data-translate="elecPriceBtnAddSeason">添加季节</span>
                                    </button>
                                </div>

                                <!-- 月份标签页（仅在逐月模式下显示） -->
                                <div id="fixedPriceMonthlyTabs" style="display: none; margin-bottom: 16px;">
                                    <div style="display: flex; gap: 4px; flex-wrap: wrap; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px;">
                                        <button type="button" class="fixed-price-month-tab active" data-month="1" onclick="switchFixedPriceMonth(1)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #3b82f6; border-bottom: 2px solid #3b82f6; margin-bottom: -10px;" data-translate="elecPriceMonthJan">一月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="2" onclick="switchFixedPriceMonth(2)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthFeb">二月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="3" onclick="switchFixedPriceMonth(3)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthMar">三月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="4" onclick="switchFixedPriceMonth(4)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthApr">四月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="5" onclick="switchFixedPriceMonth(5)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthMay">五月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="6" onclick="switchFixedPriceMonth(6)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthJun">六月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="7" onclick="switchFixedPriceMonth(7)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthJul">七月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="8" onclick="switchFixedPriceMonth(8)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthAug">八月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="9" onclick="switchFixedPriceMonth(9)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthSep">九月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="10" onclick="switchFixedPriceMonth(10)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthOct">十月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="11" onclick="switchFixedPriceMonth(11)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthNov">十一月</button>
                                        <button type="button" class="fixed-price-month-tab" data-month="12" onclick="switchFixedPriceMonth(12)" style="padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;" data-translate="elecPriceMonthDec">十二月</button>
                                    </div>
                                </div>

                                <!-- 季节标签页（仅在分季节模式下显示） -->
                                <div id="fixedPriceSeasonTabs" style="display: none; margin-bottom: 16px;">
                                    <div style="display: flex; gap: 8px; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; overflow-x: auto;">
                                        <div id="fixedPriceSeasonTabsList" style="display: flex; gap: 8px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 模版说明区域 - 放在最底部 -->
                    <div class="form-section">
                        <h4 class="form-section-title" data-translate="elecPriceFormSectionTemplateDesc">模版说明</h4>
                        <div class="form-group">
                            <textarea class="form-textarea" id="templateDesc" data-translate-placeholder="elecPriceFormPlaceholderTemplateDesc" placeholder="描述此模版的适用场景（可选）" style="min-height: 100px;"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCustomTemplateModal()" data-translate="elecPriceBtnCancel">取消</button>
                <button class="btn btn-primary" onclick="saveTemplate()">
                    <i class="fas fa-save"></i>
                    <span data-translate="elecPriceBtnSaveTemplate">保存模版</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 电站配置模态框 -->
    <div class="modal" id="siteConfigModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title" id="siteConfigTitle" data-translate="elecPriceModalTitleSiteConfig">配置电站电价</h3>
                <button class="modal-close" onclick="closeSiteConfigModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- 生效时间 -->
                <div class="form-group" style="margin-bottom: 24px;">
                    <label class="form-label required" data-translate="elecPriceFormLabelEffectiveTime">生效时间</label>
                    <input type="datetime-local" class="form-input" id="effectiveTime" required>
                </div>

                <!-- 标签页导航 -->
                <div class="config-tabs">
                    <button class="config-tab active" onclick="switchConfigTab('consumption')">
                        <i class="fas fa-download" style="color: #eb2f96;"></i>
                        <span data-translate="elecPriceConfigTabConsumption">购电配置</span>
                    </button>
                    <button class="config-tab" onclick="switchConfigTab('feedin')">
                        <i class="fas fa-upload" style="color: #1890ff;"></i>
                        <span data-translate="elecPriceConfigTabFeedin">上网配置</span>
                    </button>
                </div>

                <!-- 购电配置内容 -->
                <div id="consumptionTabContent" class="config-tab-content active">
                    <div class="form-group">
                        <label class="form-label required" data-translate="elecPriceFormLabelConsumptionTemplate">选择购电模版</label>
                        <select class="form-select" id="consumptionTemplate" onchange="onConsumptionTemplateSelect()">
                            <option value="" data-translate="elecPriceFormPlaceholderSelectConsumption">请选择购电模版</option>
                        </select>
                    </div>

                    <div id="consumptionPriceSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label required" data-translate="elecPriceFormLabelConsumptionPrice">购电价格配置</label>
                            <div id="consumptionPriceContainer"></div>
                        </div>
                    </div>
                </div>

                <!-- 上网配置内容 -->
                <div id="feedinTabContent" class="config-tab-content">
                    <div class="form-group">
                        <label class="form-label required" data-translate="elecPriceFormLabelFeedinTemplate">选择上网模版</label>
                        <select class="form-select" id="feedinTemplate" onchange="onFeedinTemplateSelect()">
                            <option value="" data-translate="elecPriceFormPlaceholderSelectFeedin">请选择上网模版</option>
                        </select>
                    </div>

                    <div id="feedinPriceSection" style="display: none;">
                        <div class="form-group">
                            <label class="form-label required" data-translate="elecPriceFormLabelFeedinPrice">上网价格配置</label>
                            <div id="feedinPriceContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSiteConfigModal()" data-translate="elecPriceBtnCancel">取消</button>
                <button class="btn btn-success" onclick="saveSiteConfig()">
                    <i class="fas fa-check"></i>
                    <span data-translate="elecPriceBtnConfirmConfig">确认配置</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 时段类型管理模态框 -->
    <div class="modal" id="periodTypeManagerModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" data-translate="elecPriceModalTitlePeriodTypeManage">时段类型管理</h3>
                <button class="modal-close" onclick="closePeriodTypeManager()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- 时段类型表格 -->
                <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
                    <!-- 表头 -->
                    <div style="display: grid; grid-template-columns: 80px 150px 1fr 80px; background: #f8fafc; padding: 12px 16px; border-bottom: 1px solid #e2e8f0;">
                        <div style="font-size: 14px; font-weight: 600; color: #374151;" data-translate="elecPricePeriodTypeOrder">序号</div>
                        <div style="font-size: 14px; font-weight: 600; color: #374151;" data-translate="elecPricePeriodTypeColor">颜色</div>
                        <div style="font-size: 14px; font-weight: 600; color: #374151;" data-translate="elecPricePeriodTypeName">名称</div>
                        <div style="font-size: 14px; font-weight: 600; color: #374151;" data-translate="elecPricePeriodTypeAction">操作</div>
                    </div>

                    <!-- 表格内容 -->
                    <div id="periodTypeManagerTableBody">
                        <!-- 行由JavaScript动态渲染 -->
                    </div>
                </div>

                <!-- 添加按钮 -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button type="button" class="btn" style="background: #3b82f6; color: white; border: none; padding: 10px 24px; font-size: 14px;" onclick="addNewPeriodTypeRow()">
                        <i class="fas fa-plus"></i> <span data-translate="elecPriceBtnAddPeriodType">增加时段类型</span>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closePeriodTypeManager()">
                    <span data-translate="elecPriceBtnConfirm">确认</span>
                </button>
            </div>
        </div>
    </div>


    <!-- 引入公共脚本 -->
    <script src="navbar.js"></script>
    <script src="common.js"></script>
    <script src="i18n.js"></script>

    <script>
        // ==================== 数据模型 ====================

        // 获取类型名称的翻译
        function getTypeNameTranslation(type) {
            // 如果getTranslation函数不存在，返回中文默认值
            if (typeof getTranslation !== 'function') {
                const defaultNames = {
                    'peak-valley': '峰谷平尖',
                    'tou': '分时电价',
                    'tiered': '阶梯电价',
                    'fixed': '固定电价'
                };
                return defaultNames[type] || '未知类型';
            }

            const typeKeyMap = {
                'peak-valley': 'elecPriceTypePeakValley',
                'tou': 'elecPriceTypeTOU',
                'tiered': 'elecPriceTypeTiered',
                'fixed': 'elecPriceTypeFixed'
            };
            return getTranslation(typeKeyMap[type] || 'elecPriceTypeFixed');
        }

        // 模板名称和描述的翻译映射
        const templateI18n = {
            // 阶梯电价模板
            '阶梯电价-固定': {
                en: 'Tiered Pricing - Fixed',
                zh: '阶梯电价-固定'
            },
            '阶梯电价-逐月': {
                en: 'Tiered Pricing - Monthly',
                zh: '阶梯电价-逐月'
            },
            '阶梯电价-分季节': {
                en: 'Tiered Pricing - Seasonal',
                zh: '阶梯电价-分季节'
            },
            // 分时电价模板
            '分时电价-固定': {
                en: 'Time-of-Use - Fixed',
                zh: '分时电价-固定'
            },
            '分时电价-逐月': {
                en: 'Time-of-Use - Monthly',
                zh: '分时电价-逐月'
            },
            '分时电价-分季节': {
                en: 'Time-of-Use - Seasonal',
                zh: '分时电价-分季节'
            },
            // 固定电价模板
            '固定电价-固定': {
                en: 'Fixed Price - Fixed',
                zh: '固定电价-固定'
            },
            '固定电价-逐月': {
                en: 'Fixed Price - Monthly',
                zh: '固定电价-逐月'
            },
            '固定电价-分季节': {
                en: 'Fixed Price - Seasonal',
                zh: '固定电价-分季节'
            },
            // 描述文本
            '全年使用同一套阶梯标准': {
                en: 'Use the same tier standard all year round',
                zh: '全年使用同一套阶梯标准'
            },
            '每个月使用不同的阶梯标准': {
                en: 'Different tier standards for each month',
                zh: '每个月使用不同的阶梯标准'
            },
            '按季节使用不同的阶梯标准': {
                en: 'Different tier standards by season',
                zh: '按季节使用不同的阶梯标准'
            },
            '全年使用同一套峰谷时段': {
                en: 'Use the same peak-valley periods all year round',
                zh: '全年使用同一套峰谷时段'
            },
            '每个月使用不同的峰谷时段': {
                en: 'Different peak-valley periods for each month',
                zh: '每个月使用不同的峰谷时段'
            },
            '按季节使用不同的峰谷时段': {
                en: 'Different peak-valley periods by season',
                zh: '按季节使用不同的峰谷时段'
            },
            '全年单一电价': {
                en: 'Single price all year round',
                zh: '全年单一电价'
            },
            '每月不同的固定电价': {
                en: 'Different fixed price for each month',
                zh: '每月不同的固定电价'
            },
            '按季节不同的固定电价': {
                en: 'Different fixed price by season',
                zh: '按季节不同的固定电价'
            },
            // 上网模板
            '阶梯上网-固定': {
                en: 'Tiered Feed-in - Fixed',
                zh: '阶梯上网-固定'
            },
            '阶梯上网-逐月': {
                en: 'Tiered Feed-in - Monthly',
                zh: '阶梯上网-逐月'
            },
            '阶梯上网-分季节': {
                en: 'Tiered Feed-in - Seasonal',
                zh: '阶梯上网-分季节'
            },
            '分时上网-固定': {
                en: 'Time-of-Use Feed-in - Fixed',
                zh: '分时上网-固定'
            },
            '分时上网-逐月': {
                en: 'Time-of-Use Feed-in - Monthly',
                zh: '分时上网-逐月'
            },
            '分时上网-分季节': {
                en: 'Time-of-Use Feed-in - Seasonal',
                zh: '分时上网-分季节'
            },
            '固定上网-固定': {
                en: 'Fixed Feed-in - Fixed',
                zh: '固定上网-固定'
            },
            '固定上网-逐月': {
                en: 'Fixed Feed-in - Monthly',
                zh: '固定上网-逐月'
            },
            '固定上网-分季节': {
                en: 'Fixed Feed-in - Seasonal',
                zh: '固定上网-分季节'
            },
            // 预设模板
            '江苏峰谷平尖电价': {
                en: 'Jiangsu Peak-Valley-Flat-Sharp Pricing',
                zh: '江苏峰谷平尖电价'
            },
            '适用于江苏地区工商业用电，包含尖峰平谷四个时段': {
                en: 'For commercial and industrial use in Jiangsu, includes four periods: sharp peak, peak, flat, and valley',
                zh: '适用于江苏地区工商业用电，包含尖峰平谷四个时段'
            },
            '广东分时电价': {
                en: 'Guangdong Time-of-Use Pricing',
                zh: '广东分时电价'
            },
            '适用于广东地区商业用电，分峰谷两个时段': {
                en: 'For commercial use in Guangdong, divided into peak and valley periods',
                zh: '适用于广东地区商业用电，分峰谷两个时段'
            },
            '浙江峰谷电价': {
                en: 'Zhejiang Peak-Valley Pricing',
                zh: '浙江峰谷电价'
            },
            '适用于浙江地区工商业用电': {
                en: 'For commercial and industrial use in Zhejiang',
                zh: '适用于浙江地区工商业用电'
            },
            '北京峰谷电价': {
                en: 'Beijing Peak-Valley Pricing',
                zh: '北京峰谷电价'
            },
            '适用于北京地区工商业用电': {
                en: 'For commercial and industrial use in Beijing',
                zh: '适用于北京地区工商业用电'
            },
            '固定电价模版': {
                en: 'Fixed Price Template',
                zh: '固定电价模版'
            },
            '适用于居民用电或不分时段的场景': {
                en: 'For residential use or scenarios without time periods',
                zh: '适用于居民用电或不分时段的场景'
            },
            '无时段划分': {
                en: 'No time periods',
                zh: '无时段划分'
            },
            // 时段标签
            '尖峰': {
                en: 'Sharp Peak',
                zh: '尖峰'
            },
            '尖时段': {
                en: 'Sharp Peak Period',
                zh: '尖时段'
            },
            '峰时段': {
                en: 'Peak Period',
                zh: '峰时段'
            },
            '高峰': {
                en: 'Peak',
                zh: '高峰'
            },
            '平时段': {
                en: 'Flat Period',
                zh: '平时段'
            },
            '平段': {
                en: 'Flat',
                zh: '平段'
            },
            '谷时段': {
                en: 'Valley Period',
                zh: '谷时段'
            },
            '低谷': {
                en: 'Valley',
                zh: '低谷'
            },
            // 类型名称
            '阶梯电价': {
                en: 'Tiered Pricing',
                zh: '阶梯电价'
            },
            '分时电价': {
                en: 'Time-of-Use',
                zh: '分时电价'
            },
            '峰谷平尖': {
                en: 'Peak-Valley-Flat-Sharp',
                zh: '峰谷平尖'
            },
            '固定电价': {
                en: 'Fixed Price',
                zh: '固定电价'
            },
            // 季节名称
            '夏季': {
                en: 'Summer',
                zh: '夏季'
            },
            '冬季': {
                en: 'Winter',
                zh: '冬季'
            },
            '春秋季': {
                en: 'Spring and Autumn',
                zh: '春秋季'
            }
        };

        // 获取翻译文本
        function getTemplateI18nText(text) {
            if (!text) return text;

            // 如果没有翻译映射或当前语言是中文，返回原文
            if (!templateI18n[text] || !currentLang || currentLang === 'zh') {
                return text;
            }

            // 返回对应语言的翻译，如果没有则返回原文
            return templateI18n[text][currentLang] || text;
        }

        // 电价模版数据 - 仅在中文环境下显示
        let templates = [];

        // 中文环境的模拟模板数据
        const mockTemplatesZh = [
            // ==================== 购电模版（9个）====================

            // 1. 阶梯电价 - 固定模式
            {
                id: 1,
                name: '阶梯电价-固定',
                type: 'tiered',
                typeName: '阶梯电价',
                description: '全年使用同一套阶梯标准',
                purpose: 'consumption',
                tiers: {
                    mode: 'fixed',
                    data: [
                        { start: 0, end: 200, limit: 200 },
                        { start: 201, end: 400, limit: 400 },
                        { start: 401, end: null, limit: null }
                    ]
                },
                createTime: '2024-01-10 08:45'
            },

            // 2. 阶梯电价 - 逐月模式
            {
                id: 2,
                name: '阶梯电价-逐月',
                type: 'tiered',
                typeName: '阶梯电价',
                description: '每个月使用不同的阶梯标准',
                purpose: 'consumption',
                tiers: {
                    mode: 'monthly',
                    data: {
                        1: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        2: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        3: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        4: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        5: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        6: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        7: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        8: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        9: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        10: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        11: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        12: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }]
                    }
                },
                createTime: '2024-01-10 09:00'
            },

            // 3. 阶梯电价 - 分季节模式
            {
                id: 3,
                name: '阶梯电价-分季节',
                type: 'tiered',
                typeName: '阶梯电价',
                description: '按季节使用不同的阶梯标准',
                purpose: 'consumption',
                tiers: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: '夏季',
                            months: [6, 7, 8],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: '冬季',
                            months: [12, 1, 2],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: '春秋季',
                            months: [3, 4, 5, 9, 10, 11],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-10 09:15'
            },

            // 4. 分时电价 - 固定模式
            {
                id: 4,
                name: '分时电价-固定',
                type: 'tou',
                typeName: '分时电价',
                description: '全年使用同一套峰谷时段',
                purpose: 'consumption',
                periods: {
                    mode: 'fixed',
                    data: [
                        { type: 'peak', name: '尖峰', start: '10:00', end: '12:00' },
                        { type: 'peak', name: '高峰', start: '18:00', end: '21:00' },
                        { type: 'flat', name: '平段', start: '08:00', end: '10:00' },
                        { type: 'flat', name: '平段', start: '12:00', end: '18:00' },
                        { type: 'valley', name: '低谷', start: '21:00', end: '08:00' }
                    ]
                },
                createTime: '2024-01-20 14:20'
            },

            // 5. 分时电价 - 逐月模式
            {
                id: 5,
                name: '分时电价-逐月',
                type: 'tou',
                typeName: '分时电价',
                description: '每个月使用不同的峰谷时段',
                purpose: 'consumption',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        2: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        3: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        4: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        5: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        6: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        7: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        8: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        9: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        10: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        11: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        12: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ]
                    }
                },
                createTime: '2024-01-20 14:30'
            },

            // 6. 分时电价 - 分季节模式
            {
                id: 6,
                name: '分时电价-分季节',
                type: 'tou',
                typeName: '分时电价',
                description: '按季节使用不同的峰谷时段',
                purpose: 'consumption',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: '夏季',
                            months: [6, 7, 8],
                            periods: [
                                { type: 'peak', name: '尖峰', start: '14:00', end: '17:00' },
                                { type: 'peak', name: '高峰', start: '10:00', end: '14:00' },
                                { type: 'peak', name: '高峰', start: '19:00', end: '22:00' },
                                { type: 'flat', name: '平段', start: '08:00', end: '10:00' },
                                { type: 'flat', name: '平段', start: '17:00', end: '19:00' },
                                { type: 'valley', name: '低谷', start: '22:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: '冬季',
                            months: [12, 1, 2],
                            periods: [
                                { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                                { type: 'peak', name: '高峰', start: '18:00', end: '23:00' },
                                { type: 'flat', name: '平段', start: '11:00', end: '18:00' },
                                { type: 'valley', name: '低谷', start: '23:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: '春秋季',
                            months: [3, 4, 5, 9, 10, 11],
                            periods: [
                                { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                                { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                                { type: 'flat', name: '平段', start: '11:00', end: '18:00' },
                                { type: 'valley', name: '低谷', start: '22:00', end: '08:00' }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-20 14:45'
            },

            // 7. 固定电价 - 固定模式
            {
                id: 7,
                name: '固定电价-固定',
                type: 'fixed',
                typeName: '固定电价',
                description: '全年单一电价',
                purpose: 'consumption',
                periods: {
                    mode: 'fixed'
                },
                createTime: '2024-02-01 09:15'
            },

            // 8. 固定电价 - 逐月模式
            {
                id: 8,
                name: '固定电价-逐月',
                type: 'fixed',
                typeName: '固定电价',
                description: '每月不同的固定电价',
                purpose: 'consumption',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [], 2: [], 3: [], 4: [], 5: [], 6: [],
                        7: [], 8: [], 9: [], 10: [], 11: [], 12: []
                    }
                },
                createTime: '2024-02-01 09:20'
            },

            // 9. 固定电价 - 分季节模式
            {
                id: 9,
                name: '固定电价-分季节',
                type: 'fixed',
                typeName: '固定电价',
                description: '按季节不同的固定电价',
                purpose: 'consumption',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        { id: 'season-1', name: '夏季', months: [6, 7, 8] },
                        { id: 'season-2', name: '冬季', months: [12, 1, 2] },
                        { id: 'season-3', name: '春秋季', months: [3, 4, 5, 9, 10, 11] }
                    ]
                },
                createTime: '2024-02-01 09:25'
            },

            // ==================== 上网模版（9个）====================

            // 10. 阶梯上网 - 固定模式
            {
                id: 10,
                name: '阶梯上网-固定',
                type: 'tiered',
                typeName: '阶梯电价',
                description: '全年使用同一套阶梯标准',
                purpose: 'feed-in',
                tiers: {
                    mode: 'fixed',
                    data: [
                        { start: 0, end: 200, limit: 200 },
                        { start: 201, end: 400, limit: 400 },
                        { start: 401, end: null, limit: null }
                    ]
                },
                createTime: '2024-01-10 10:00'
            },

            // 11. 阶梯上网 - 逐月模式
            {
                id: 11,
                name: '阶梯上网-逐月',
                type: 'tiered',
                typeName: '阶梯电价',
                description: '每个月使用不同的阶梯标准',
                purpose: 'feed-in',
                tiers: {
                    mode: 'monthly',
                    data: {
                        1: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        2: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        3: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        4: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        5: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        6: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        7: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        8: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        9: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        10: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        11: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        12: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }]
                    }
                },
                createTime: '2024-01-10 10:15'
            },

            // 12. 阶梯上网 - 分季节模式
            {
                id: 12,
                name: '阶梯上网-分季节',
                type: 'tiered',
                typeName: '阶梯电价',
                description: '按季节使用不同的阶梯标准',
                purpose: 'feed-in',
                tiers: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: '夏季',
                            months: [6, 7, 8],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: '冬季',
                            months: [12, 1, 2],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: '春秋季',
                            months: [3, 4, 5, 9, 10, 11],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-10 10:30'
            },

            // 13. 分时上网 - 固定模式
            {
                id: 13,
                name: '分时上网-固定',
                type: 'tou',
                typeName: '分时电价',
                description: '全年使用同一套峰谷时段',
                purpose: 'feed-in',
                periods: {
                    mode: 'fixed',
                    data: [
                        { type: 'peak', name: '尖峰', start: '10:00', end: '12:00' },
                        { type: 'peak', name: '高峰', start: '18:00', end: '21:00' },
                        { type: 'flat', name: '平段', start: '08:00', end: '10:00' },
                        { type: 'flat', name: '平段', start: '12:00', end: '18:00' },
                        { type: 'valley', name: '低谷', start: '21:00', end: '08:00' }
                    ]
                },
                createTime: '2024-01-20 15:00'
            },

            // 14. 分时上网 - 逐月模式
            {
                id: 14,
                name: '分时上网-逐月',
                type: 'tou',
                typeName: '分时电价',
                description: '每个月使用不同的峰谷时段',
                purpose: 'feed-in',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        2: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        3: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        4: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        5: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        6: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        7: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        8: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        9: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        10: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        11: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ],
                        12: [
                            { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                            { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                            { type: 'valley', name: '低谷', start: '22:00', end: '08:00' },
                            { type: 'flat', name: '平段', start: '11:00', end: '18:00' }
                        ]
                    }
                },
                createTime: '2024-01-20 15:15'
            },

            // 15. 分时上网 - 分季节模式
            {
                id: 15,
                name: '分时上网-分季节',
                type: 'tou',
                typeName: '分时电价',
                description: '按季节使用不同的峰谷时段',
                purpose: 'feed-in',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: '夏季',
                            months: [6, 7, 8],
                            periods: [
                                { type: 'peak', name: '尖峰', start: '14:00', end: '17:00' },
                                { type: 'peak', name: '高峰', start: '10:00', end: '14:00' },
                                { type: 'peak', name: '高峰', start: '19:00', end: '22:00' },
                                { type: 'flat', name: '平段', start: '08:00', end: '10:00' },
                                { type: 'flat', name: '平段', start: '17:00', end: '19:00' },
                                { type: 'valley', name: '低谷', start: '22:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: '冬季',
                            months: [12, 1, 2],
                            periods: [
                                { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                                { type: 'peak', name: '高峰', start: '18:00', end: '23:00' },
                                { type: 'flat', name: '平段', start: '11:00', end: '18:00' },
                                { type: 'valley', name: '低谷', start: '23:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: '春秋季',
                            months: [3, 4, 5, 9, 10, 11],
                            periods: [
                                { type: 'peak', name: '高峰', start: '08:00', end: '11:00' },
                                { type: 'peak', name: '高峰', start: '18:00', end: '22:00' },
                                { type: 'flat', name: '平段', start: '11:00', end: '18:00' },
                                { type: 'valley', name: '低谷', start: '22:00', end: '08:00' }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-20 15:30'
            },

            // 16. 固定上网 - 固定模式
            {
                id: 16,
                name: '固定上网-固定',
                type: 'fixed',
                typeName: '固定电价',
                description: '全年单一电价',
                purpose: 'feed-in',
                periods: {
                    mode: 'fixed'
                },
                createTime: '2024-02-01 10:00'
            },

            // 17. 固定上网 - 逐月模式
            {
                id: 17,
                name: '固定上网-逐月',
                type: 'fixed',
                typeName: '固定电价',
                description: '每月不同的固定电价',
                purpose: 'feed-in',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [], 2: [], 3: [], 4: [], 5: [], 6: [],
                        7: [], 8: [], 9: [], 10: [], 11: [], 12: []
                    }
                },
                createTime: '2024-02-01 10:05'
            },

            // 18. 固定上网 - 分季节模式
            {
                id: 18,
                name: '固定上网-分季节',
                type: 'fixed',
                typeName: '固定电价',
                description: '按季节不同的固定电价',
                purpose: 'feed-in',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        { id: 'season-1', name: '夏季', months: [6, 7, 8] },
                        { id: 'season-2', name: '冬季', months: [12, 1, 2] },
                        { id: 'season-3', name: '春秋季', months: [3, 4, 5, 9, 10, 11] }
                    ]
                },
                createTime: '2024-02-01 10:10'
            }
        ];

        // 英文环境的模拟模板数据
        const mockTemplatesEn = [
            // ==================== Purchase Templates (9 templates) ====================

            // 1. Tiered Pricing - Fixed
            {
                id: 1,
                name: 'Tiered Pricing - Fixed',
                type: 'tiered',
                typeName: 'Tiered Pricing',
                description: 'Use the same tier standard throughout the year',
                purpose: 'consumption',
                tiers: {
                    mode: 'fixed',
                    data: [
                        { start: 0, end: 200, limit: 200 },
                        { start: 201, end: 400, limit: 400 },
                        { start: 401, end: null, limit: null }
                    ]
                },
                createTime: '2024-01-10 08:45'
            },

            // 2. Tiered Pricing - Monthly
            {
                id: 2,
                name: 'Tiered Pricing - Monthly',
                type: 'tiered',
                typeName: 'Tiered Pricing',
                description: 'Use different tier standards for each month',
                purpose: 'consumption',
                tiers: {
                    mode: 'monthly',
                    data: {
                        1: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        2: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        3: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        4: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        5: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        6: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        7: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        8: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        9: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        10: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        11: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        12: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }]
                    }
                },
                createTime: '2024-01-10 09:00'
            },

            // 3. Tiered Pricing - Seasonal
            {
                id: 3,
                name: 'Tiered Pricing - Seasonal',
                type: 'tiered',
                typeName: 'Tiered Pricing',
                description: 'Use different tier standards by season',
                purpose: 'consumption',
                tiers: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: 'Summer',
                            months: [6, 7, 8],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: 'Winter',
                            months: [12, 1, 2],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: 'Spring and Autumn',
                            months: [3, 4, 5, 9, 10, 11],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-10 09:15'
            },

            // 4. Time-of-Use - Fixed
            {
                id: 4,
                name: 'Time-of-Use - Fixed',
                type: 'tou',
                typeName: 'Time-of-Use',
                description: 'Use the same peak-valley periods throughout the year',
                purpose: 'consumption',
                periods: {
                    mode: 'fixed',
                    data: [
                        { type: 'peak', name: 'Sharp Peak', start: '10:00', end: '12:00' },
                        { type: 'peak', name: 'Peak', start: '18:00', end: '21:00' },
                        { type: 'flat', name: 'Flat', start: '08:00', end: '10:00' },
                        { type: 'flat', name: 'Flat', start: '12:00', end: '18:00' },
                        { type: 'valley', name: 'Valley', start: '21:00', end: '08:00' }
                    ]
                },
                createTime: '2024-01-20 14:20'
            },

            // 5. Time-of-Use - Monthly
            {
                id: 5,
                name: 'Time-of-Use - Monthly',
                type: 'tou',
                typeName: 'Time-of-Use',
                description: 'Use different peak-valley periods for each month',
                purpose: 'consumption',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        2: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        3: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        4: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        5: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        6: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        7: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        8: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        9: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        10: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        11: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        12: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ]
                    }
                },
                createTime: '2024-01-20 14:30'
            },

            // 6. Time-of-Use - Seasonal
            {
                id: 6,
                name: 'Time-of-Use - Seasonal',
                type: 'tou',
                typeName: 'Time-of-Use',
                description: 'Use different peak-valley periods by season',
                purpose: 'consumption',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: 'Summer',
                            months: [6, 7, 8],
                            periods: [
                                { type: 'peak', name: 'Peak', start: '10:00', end: '12:00' },
                                { type: 'peak', name: 'Peak', start: '18:00', end: '21:00' },
                                { type: 'flat', name: 'Flat', start: '08:00', end: '10:00' },
                                { type: 'flat', name: 'Flat', start: '12:00', end: '18:00' },
                                { type: 'valley', name: 'Valley', start: '21:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: 'Winter',
                            months: [12, 1, 2],
                            periods: [
                                { type: 'peak', name: 'Peak', start: '10:00', end: '12:00' },
                                { type: 'peak', name: 'Peak', start: '18:00', end: '21:00' },
                                { type: 'flat', name: 'Flat', start: '08:00', end: '10:00' },
                                { type: 'flat', name: 'Flat', start: '12:00', end: '18:00' },
                                { type: 'valley', name: 'Valley', start: '21:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: 'Spring and Autumn',
                            months: [3, 4, 5, 9, 10, 11],
                            periods: [
                                { type: 'peak', name: 'Peak', start: '09:00', end: '12:00' },
                                { type: 'peak', name: 'Peak', start: '17:00', end: '20:00' },
                                { type: 'flat', name: 'Flat', start: '08:00', end: '09:00' },
                                { type: 'flat', name: 'Flat', start: '12:00', end: '17:00' },
                                { type: 'valley', name: 'Valley', start: '20:00', end: '08:00' }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-20 14:45'
            },

            // 7. Fixed Price - Fixed
            {
                id: 7,
                name: 'Fixed Price - Fixed',
                type: 'fixed',
                typeName: 'Fixed Price',
                description: 'Single price for the whole year',
                purpose: 'consumption',
                periods: {
                    mode: 'fixed'
                },
                createTime: '2024-01-30 11:00'
            },

            // 8. Fixed Price - Monthly
            {
                id: 8,
                name: 'Fixed Price - Monthly',
                type: 'fixed',
                typeName: 'Fixed Price',
                description: 'Different fixed price for each month',
                purpose: 'consumption',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [], 2: [], 3: [], 4: [], 5: [], 6: [],
                        7: [], 8: [], 9: [], 10: [], 11: [], 12: []
                    }
                },
                createTime: '2024-01-30 11:05'
            },

            // 9. Fixed Price - Seasonal
            {
                id: 9,
                name: 'Fixed Price - Seasonal',
                type: 'fixed',
                typeName: 'Fixed Price',
                description: 'Different fixed price by season',
                purpose: 'consumption',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        { id: 'season-1', name: 'Summer', months: [6, 7, 8] },
                        { id: 'season-2', name: 'Winter', months: [12, 1, 2] },
                        { id: 'season-3', name: 'Spring and Autumn', months: [3, 4, 5, 9, 10, 11] }
                    ]
                },
                createTime: '2024-01-30 11:10'
            },

            // ==================== Feed-in Templates (9 templates) ====================

            // 10. Tiered Feed-in - Fixed
            {
                id: 10,
                name: 'Tiered Feed-in - Fixed',
                type: 'tiered',
                typeName: 'Tiered Pricing',
                description: 'Use the same tier standard throughout the year',
                purpose: 'feed-in',
                tiers: {
                    mode: 'fixed',
                    data: [
                        { start: 0, end: 200, limit: 200 },
                        { start: 201, end: 400, limit: 400 },
                        { start: 401, end: null, limit: null }
                    ]
                },
                createTime: '2024-01-10 10:00'
            },

            // 11. Tiered Feed-in - Monthly
            {
                id: 11,
                name: 'Tiered Feed-in - Monthly',
                type: 'tiered',
                typeName: 'Tiered Pricing',
                description: 'Use different tier standards for each month',
                purpose: 'feed-in',
                tiers: {
                    mode: 'monthly',
                    data: {
                        1: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        2: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        3: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        4: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        5: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        6: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        7: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        8: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        9: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        10: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        11: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }],
                        12: [{ start: 0, end: 200, limit: 200 }, { start: 201, end: 400, limit: 400 }, { start: 401, end: null, limit: null }]
                    }
                },
                createTime: '2024-01-10 10:15'
            },

            // 12. Tiered Feed-in - Seasonal
            {
                id: 12,
                name: 'Tiered Feed-in - Seasonal',
                type: 'tiered',
                typeName: 'Tiered Pricing',
                description: 'Use different tier standards by season',
                purpose: 'feed-in',
                tiers: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: 'Summer',
                            months: [6, 7, 8],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: 'Winter',
                            months: [12, 1, 2],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: 'Spring and Autumn',
                            months: [3, 4, 5, 9, 10, 11],
                            tiers: [
                                { start: 0, end: 200, limit: 200 },
                                { start: 201, end: 400, limit: 400 },
                                { start: 401, end: null, limit: null }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-10 10:30'
            },

            // 13. Time-of-Use Feed-in - Fixed
            {
                id: 13,
                name: 'Time-of-Use Feed-in - Fixed',
                type: 'tou',
                typeName: 'Time-of-Use',
                description: 'Use the same peak-valley periods throughout the year',
                purpose: 'feed-in',
                periods: {
                    mode: 'fixed',
                    data: [
                        { type: 'peak', name: 'Sharp Peak', start: '10:00', end: '12:00' },
                        { type: 'peak', name: 'Peak', start: '18:00', end: '21:00' },
                        { type: 'flat', name: 'Flat', start: '08:00', end: '10:00' },
                        { type: 'flat', name: 'Flat', start: '12:00', end: '18:00' },
                        { type: 'valley', name: 'Valley', start: '21:00', end: '08:00' }
                    ]
                },
                createTime: '2024-01-20 15:00'
            },

            // 14. Time-of-Use Feed-in - Monthly
            {
                id: 14,
                name: 'Time-of-Use Feed-in - Monthly',
                type: 'tou',
                typeName: 'Time-of-Use',
                description: 'Use different peak-valley periods for each month',
                purpose: 'feed-in',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        2: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        3: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        4: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        5: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        6: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        7: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        8: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        9: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        10: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        11: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ],
                        12: [
                            { type: 'peak', name: 'Peak', start: '08:00', end: '11:00' },
                            { type: 'peak', name: 'Peak', start: '18:00', end: '22:00' },
                            { type: 'valley', name: 'Valley', start: '22:00', end: '08:00' },
                            { type: 'flat', name: 'Flat', start: '11:00', end: '18:00' }
                        ]
                    }
                },
                createTime: '2024-01-20 15:15'
            },

            // 15. Time-of-Use Feed-in - Seasonal
            {
                id: 15,
                name: 'Time-of-Use Feed-in - Seasonal',
                type: 'tou',
                typeName: 'Time-of-Use',
                description: 'Use different peak-valley periods by season',
                purpose: 'feed-in',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        {
                            id: 'season-1',
                            name: 'Summer',
                            months: [6, 7, 8],
                            periods: [
                                { type: 'peak', name: 'Peak', start: '10:00', end: '12:00' },
                                { type: 'peak', name: 'Peak', start: '18:00', end: '21:00' },
                                { type: 'flat', name: 'Flat', start: '08:00', end: '10:00' },
                                { type: 'flat', name: 'Flat', start: '12:00', end: '18:00' },
                                { type: 'valley', name: 'Valley', start: '21:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-2',
                            name: 'Winter',
                            months: [12, 1, 2],
                            periods: [
                                { type: 'peak', name: 'Peak', start: '10:00', end: '12:00' },
                                { type: 'peak', name: 'Peak', start: '18:00', end: '21:00' },
                                { type: 'flat', name: 'Flat', start: '08:00', end: '10:00' },
                                { type: 'flat', name: 'Flat', start: '12:00', end: '18:00' },
                                { type: 'valley', name: 'Valley', start: '21:00', end: '08:00' }
                            ]
                        },
                        {
                            id: 'season-3',
                            name: 'Spring and Autumn',
                            months: [3, 4, 5, 9, 10, 11],
                            periods: [
                                { type: 'peak', name: 'Peak', start: '09:00', end: '12:00' },
                                { type: 'peak', name: 'Peak', start: '17:00', end: '20:00' },
                                { type: 'flat', name: 'Flat', start: '08:00', end: '09:00' },
                                { type: 'flat', name: 'Flat', start: '12:00', end: '17:00' },
                                { type: 'valley', name: 'Valley', start: '20:00', end: '08:00' }
                            ]
                        }
                    ]
                },
                createTime: '2024-01-20 15:30'
            },

            // 16. Fixed Feed-in - Fixed
            {
                id: 16,
                name: 'Fixed Feed-in - Fixed',
                type: 'fixed',
                typeName: 'Fixed Price',
                description: 'Single price for the whole year',
                purpose: 'feed-in',
                periods: {
                    mode: 'fixed'
                },
                createTime: '2024-02-01 10:00'
            },

            // 17. Fixed Feed-in - Monthly
            {
                id: 17,
                name: 'Fixed Feed-in - Monthly',
                type: 'fixed',
                typeName: 'Fixed Price',
                description: 'Different fixed price for each month',
                purpose: 'feed-in',
                periods: {
                    mode: 'monthly',
                    data: {
                        1: [], 2: [], 3: [], 4: [], 5: [], 6: [],
                        7: [], 8: [], 9: [], 10: [], 11: [], 12: []
                    }
                },
                createTime: '2024-02-01 10:05'
            },

            // 18. Fixed Feed-in - Seasonal
            {
                id: 18,
                name: 'Fixed Feed-in - Seasonal',
                type: 'fixed',
                typeName: 'Fixed Price',
                description: 'Different fixed price by season',
                purpose: 'feed-in',
                periods: {
                    mode: 'seasonal',
                    seasons: [
                        { id: 'season-1', name: 'Summer', months: [6, 7, 8] },
                        { id: 'season-2', name: 'Winter', months: [12, 1, 2] },
                        { id: 'season-3', name: 'Spring and Autumn', months: [3, 4, 5, 9, 10, 11] }
                    ]
                },
                createTime: '2024-02-01 10:10'
            }
        ];

        // 根据语言环境初始化数据
        if (currentLang === 'zh') {
            templates = mockTemplatesZh;
        } else {
            templates = mockTemplatesEn;
        }

        // 电站数据
        let sites = [
            {
                id: 'site1',
                name: '科技园区站',
                nameEn: 'Technology Park Station',
                location: '江苏南京',
                capacity: '2.5MWh',
                deviceCount: 8
            },
            {
                id: 'site2',
                name: '工业园区站',
                nameEn: 'Industrial Park Station',
                location: '广东深圳',
                capacity: '3.75MWh',
                deviceCount: 12
            },
            {
                id: 'site3',
                name: '商业中心站',
                nameEn: 'Business Center Station',
                location: '浙江杭州',
                capacity: '3.1MWh',
                deviceCount: 10
            },
            {
                id: 'site4',
                name: '物流园区站',
                nameEn: 'Logistics Park Station',
                location: '上海浦东',
                capacity: '4.7MWh',
                deviceCount: 15
            }
        ];

        // 电站配置（包含模版引用和具体价格）
        let siteConfigs = [];

        let currentSiteId = null;
        let periodCounter = 0;
        let selectedPresetTemplate = null;

        // 预设电价模版
        const presetTemplates = [
            {
                id: 'preset-jiangsu',
                name: '江苏峰谷平尖电价',
                type: 'peak-valley',
                typeName: '峰谷平尖',
                description: '适用于江苏地区工商业用电，包含尖峰平谷四个时段',
                periods: [
                    { type: 'super-peak', name: '尖时段', start: '19:00', end: '21:00' },
                    { type: 'peak', name: '峰时段', start: '08:00', end: '11:00' },
                    { type: 'peak', name: '峰时段', start: '14:00', end: '19:00' },
                    { type: 'flat', name: '平时段', start: '11:00', end: '14:00' },
                    { type: 'flat', name: '平时段', start: '21:00', end: '23:00' },
                    { type: 'valley', name: '谷时段', start: '23:00', end: '08:00' }
                ]
            },
            {
                id: 'preset-guangdong',
                name: '广东分时电价',
                type: 'tou',
                typeName: '分时电价',
                description: '适用于广东地区商业用电，分峰谷两个时段',
                periods: [
                    { type: 'peak', name: '高峰', start: '08:00', end: '22:00' },
                    { type: 'valley', name: '低谷', start: '22:00', end: '08:00' }
                ]
            },
            {
                id: 'preset-zhejiang',
                name: '浙江峰谷电价',
                type: 'peak-valley',
                typeName: '峰谷平尖',
                description: '适用于浙江地区工商业用电',
                periods: [
                    { type: 'super-peak', name: '尖时段', start: '10:00', end: '12:00' },
                    { type: 'super-peak', name: '尖时段', start: '19:00', end: '21:00' },
                    { type: 'peak', name: '峰时段', start: '08:00', end: '10:00' },
                    { type: 'peak', name: '峰时段', start: '14:00', end: '19:00' },
                    { type: 'flat', name: '平时段', start: '12:00', end: '14:00' },
                    { type: 'flat', name: '平时段', start: '21:00', end: '22:00' },
                    { type: 'valley', name: '谷时段', start: '22:00', end: '08:00' }
                ]
            },
            {
                id: 'preset-beijing',
                name: '北京峰谷电价',
                type: 'peak-valley',
                typeName: '峰谷平尖',
                description: '适用于北京地区工商业用电',
                periods: [
                    { type: 'peak', name: '峰时段', start: '10:00', end: '15:00' },
                    { type: 'peak', name: '峰时段', start: '18:00', end: '21:00' },
                    { type: 'flat', name: '平时段', start: '07:00', end: '10:00' },
                    { type: 'flat', name: '平时段', start: '15:00', end: '18:00' },
                    { type: 'flat', name: '平时段', start: '21:00', end: '23:00' },
                    { type: 'valley', name: '谷时段', start: '23:00', end: '07:00' }
                ]
            },
            {
                id: 'preset-fixed',
                name: '固定电价模版',
                type: 'fixed',
                typeName: '固定电价',
                description: '适用于居民用电或不分时段的场景',
                periods: []
            }
        ];

        // ==================== 模态框管理 ====================

        // 打开创建方式选择模态框
        function openCreateModeModal() {
            document.getElementById('createModeModal').classList.add('active');
        }

        // 关闭创建方式选择模态框
        function closeCreateModeModal() {
            document.getElementById('createModeModal').classList.remove('active');
        }

        // 打开预设模版选择模态框
        function openPresetTemplateModal(purpose) {
            console.log('openPresetTemplateModal called with purpose:', purpose);

            try {
                // 先直接打开弹框，确保基本功能正常
                const modal = document.getElementById('presetTemplateModal');
                if (!modal) {
                    console.error('presetTemplateModal element not found');
                    return;
                }

                // 关闭创建模式弹框
                try {
                    closeCreateModeModal();
                } catch (e) {
                    console.warn('closeCreateModeModal failed:', e);
                }

                // 设置标题
                try {
                    const purposeText = purpose === 'feed-in' ?
                        (typeof getTranslation === 'function' ? getTranslation('elecPricePurposeFeedin') : '上网') :
                        (typeof getTranslation === 'function' ? getTranslation('elecPricePurposeConsumption') : '购电');
                    const titleText = typeof getTranslation === 'function' ? getTranslation('elecPriceModalTitleSelectPreset') : '选择预设模版';

                    const titleElement = document.getElementById('presetModalTitle');
                    if (titleElement) {
                        titleElement.textContent = `${titleText}（${purposeText}）`;
                    }
                } catch (e) {
                    console.warn('Title setting failed:', e);
                }

                // 渲染模版列表
                try {
                    selectedPresetTemplate = null;
                    renderPresetTemplates();

                    const applyBtn = document.getElementById('applyPresetBtn');
                    if (applyBtn) {
                        applyBtn.style.display = 'none';
                    }
                } catch (e) {
                    console.warn('renderPresetTemplates failed:', e);
                }

                // 选择用途
                try {
                    selectPurpose(purpose);
                } catch (e) {
                    console.warn('selectPurpose failed:', e);
                }

                // 最后打开弹框
                modal.classList.add('active');
                console.log('Preset modal opened successfully');

            } catch (error) {
                console.error('Error in openPresetTemplateModal:', error);
                // 即使出错也尝试打开弹框
                const modal = document.getElementById('presetTemplateModal');
                if (modal) {
                    modal.classList.add('active');
                }
            }
        }

        // 关闭预设模版选择模态框
        function closePresetTemplateModal() {
            document.getElementById('presetTemplateModal').classList.remove('active');
            selectedPresetTemplate = null;
        }

        // 打开自定义创建模态框
        function openCustomTemplateModal(purpose) {
            console.log('openCustomTemplateModal called with purpose:', purpose);

            try {
                // 先直接打开弹框，确保基本功能正常
                const modal = document.getElementById('customTemplateModal');
                if (!modal) {
                    console.error('customTemplateModal element not found');
                    return;
                }

                // 关闭创建模式弹框
                try {
                    closeCreateModeModal();
                } catch (e) {
                    console.warn('closeCreateModeModal failed:', e);
                }

                // 设置标题
                try {
                    const purposeText = purpose === 'feed-in' ?
                        (typeof getTranslation === 'function' ? getTranslation('elecPricePurposeFeedin') : '上网') :
                        (typeof getTranslation === 'function' ? getTranslation('elecPricePurposeConsumption') : '购电');
                    const titleText = typeof getTranslation === 'function' ? getTranslation('elecPriceModalTitleCustomCreate') : '自定义创建模版';

                    const titleElement = document.getElementById('customModalTitle');
                    if (titleElement) {
                        titleElement.textContent = `${titleText}（${purposeText}）`;
                    }
                } catch (e) {
                    console.warn('Title setting failed:', e);
                }

                // 重置表单
                try {
                    const templateForm = document.getElementById('templateForm');
                    if (templateForm) {
                        templateForm.reset();
                    }

                    // 清除原始键属性
                    document.getElementById('templateName').removeAttribute('data-original-key');
                    document.getElementById('templateDesc').removeAttribute('data-original-key');

                    const periodsSection = document.getElementById('periodsSection');
                    if (periodsSection) {
                        periodsSection.style.display = 'none';
                    }

                    const periodsContainer = document.getElementById('periodsContainer');
                    if (periodsContainer) {
                        periodsContainer.innerHTML = '';
                    }

                    editingTemplateId = null;
                } catch (e) {
                    console.warn('Form reset failed:', e);
                }

                // 选择用途
                try {
                    selectPurpose(purpose);
                } catch (e) {
                    console.warn('selectPurpose failed:', e);
                }

                // 重置数据
                try {
                    currentPeriodMode = 'fixed';
                    fixedTiers = [];
                    monthlyTiers = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                    seasonConfigs = [
                        {
                            id: 'season-1',
                            name: '夏季',
                            months: [5, 6, 7, 8, 9, 10],
                            tiers: []
                        },
                        {
                            id: 'season-2',
                            name: '非夏季',
                            months: [11, 12, 1, 2, 3, 4],
                            tiers: []
                        }
                    ];
                    currentSeasonId = null;
                    seasonCounter = 2;
                } catch (e) {
                    console.warn('Data reset failed:', e);
                }

                // 重置UI状态
                try {
                    document.querySelectorAll('.tier-mode-btn').forEach(btn => {
                        if (btn.getAttribute('data-mode') === 'simple') {
                            btn.classList.add('active');
                            btn.style.background = '#3b82f6';
                            btn.style.color = 'white';
                            btn.style.borderColor = '#3b82f6';
                        } else {
                            btn.classList.remove('active');
                            btn.style.background = 'white';
                            btn.style.color = '#374151';
                            btn.style.borderColor = '#e2e8f0';
                        }
                    });

                    const seasonTabs = document.getElementById('seasonTabs');
                    if (seasonTabs) {
                        seasonTabs.style.display = 'none';
                    }
                } catch (e) {
                    console.warn('UI reset failed:', e);
                }

                // 最后打开弹框
                modal.classList.add('active');
                console.log('Custom modal opened successfully');

            } catch (error) {
                console.error('Error in openCustomTemplateModal:', error);
                // 即使出错也尝试打开弹框
                const modal = document.getElementById('customTemplateModal');
                if (modal) {
                    modal.classList.add('active');
                }
            }
        }

        // 关闭自定义创建模态框
        function closeCustomTemplateModal() {
            document.getElementById('customTemplateModal').classList.remove('active');
            editingTemplateId = null;
        }

        // ==================== 下拉菜单管理 ====================

        // 切换下拉菜单的显示状态
        function toggleCreateDropdown(purpose) {
            const dropdownId = purpose === 'consumption' ? 'createDropdownConsumption' : 'createDropdownFeedin';
            const dropdown = document.getElementById(dropdownId);

            // 关闭其他dropdown
            document.querySelectorAll('.dropdown').forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('active');
                }
            });

            dropdown.classList.toggle('active');
        }

        // 选择创建模式并打开相应的模态框
        function selectCreateMode(mode, purpose) {
            console.log('selectCreateMode called:', mode, purpose);

            // 关闭下拉菜单
            closeDropdown();

            // 根据选择的模式打开相应的模态框
            if (mode === 'preset') {
                console.log('Opening preset modal for:', purpose);
                openPresetTemplateModal(purpose);
            } else if (mode === 'custom') {
                console.log('Opening custom modal for:', purpose);
                openCustomTemplateModal(purpose);
            }
        }

        // 关闭下拉菜单
        function closeDropdown() {
            document.querySelectorAll('.dropdown').forEach(dropdown => {
                dropdown.classList.remove('active');
            });
        }

        // 点击页面其他地方时关闭下拉菜单
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('createDropdown');
            if (dropdown && !dropdown.contains(event.target)) {
                closeDropdown();
            }
        });

        // 渲染预设模版列表
        function renderPresetTemplates() {
            console.log('renderPresetTemplates called');
            const container = document.getElementById('presetTemplatesContainer');

            if (!container) {
                console.error('presetTemplatesContainer not found');
                return;
            }

            try {
                container.innerHTML = presetTemplates.map(preset => {
                const periodTags = preset.periods.length > 0
                    ? `<div class="preset-periods">
                        ${preset.periods.map(p => {
                            let badgeClass = '';
                            if (p.type === 'super-peak') badgeClass = 'badge-danger';
                            else if (p.type === 'peak') badgeClass = 'badge-warning';
                            else if (p.type === 'flat') badgeClass = 'badge-primary';
                            else if (p.type === 'valley') badgeClass = 'badge-success';

                            return `<span class="badge ${badgeClass} preset-period-tag">${getTemplateI18nText(p.name)}</span>`;
                        }).join('')}
                       </div>`
                    : `<div class="preset-periods"><span class="badge badge-gray preset-period-tag">${getTemplateI18nText('无时段划分')}</span></div>`;

                const translatedName = getTemplateI18nText(preset.name);
                const translatedDesc = getTemplateI18nText(preset.description);

                return `
                    <div class="preset-template-card ${selectedPresetTemplate === preset.id ? 'selected' : ''}"
                         onclick="selectPresetTemplate('${preset.id}')">
                        <div class="preset-header">
                            <div class="preset-name">${translatedName}</div>
                            <span class="badge badge-primary">${getTypeNameTranslation(preset.type)}</span>
                        </div>
                        <div class="preset-desc">${translatedDesc}</div>
                        ${periodTags}
                    </div>
                `;
                }).join('');
            } catch (error) {
                console.error('Error in renderPresetTemplates:', error);
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">加载模版失败，请刷新页面重试</div>';
            }
        }

        // 选择预设模版
        function selectPresetTemplate(presetId) {
            selectedPresetTemplate = presetId;
            renderPresetTemplates();
            document.getElementById('applyPresetBtn').style.display = 'inline-flex';
        }

        // 应用预设模版
        function applyPresetTemplate() {
            if (!selectedPresetTemplate) {
                showToast('请选择一个预设模版', 'error');
                return;
            }

            const preset = presetTemplates.find(p => p.id === selectedPresetTemplate);
            if (!preset) {
                showToast('未找到选中的模版', 'error');
                return;
            }

            // 获取当前选择的用途
            const purpose = document.getElementById('templatePurpose').value;
            if (!purpose) {
                showToast('无法确定模版用途', 'error');
                return;
            }

            // 创建新模版
            const typeNames = {
                'peak-valley': '峰谷平尖',
                'tou': '分时电价',
                'tiered': '阶梯电价',
                'fixed': '固定电价'
            };

            const purposeNames = {
                'consumption': '用电电价',
                'feed-in': '上网电价'
            };

            const newTemplate = {
                id: Date.now(),
                name: preset.name,
                type: preset.type,
                typeName: typeNames[preset.type],
                purpose: purpose,  // 添加用途字段
                purposeName: purposeNames[purpose],  // 添加用途名称
                description: preset.description,
                periods: JSON.parse(JSON.stringify(preset.periods)), // 深拷贝
                createTime: new Date().toLocaleString('zh-CN', { hour12: false })
            };

            templates.unshift(newTemplate);
            renderTemplates();
            closePresetTemplateModal();
            showToast('模版创建成功', 'success');
        }

        // ==================== 初始化 ====================

        document.addEventListener('DOMContentLoaded', function() {
            renderTemplates();
            renderSites();

            // 监听语言切换事件,重新加载数据
            window.addEventListener('languageChanged', function(event) {
                // 根据新语言重新加载数据
                const newLang = localStorage.getItem('language') || 'zh';
                if (newLang === 'zh') {
                    templates = mockTemplatesZh;
                } else {
                    templates = mockTemplatesEn;
                }
                renderTemplates();
                renderSites();
            });
        });

        // ==================== Tab切换 ====================

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
        }

        // ==================== 模版管理 ====================

        function renderTemplates() {
            renderConsumptionTemplates();
            renderFeedinTemplates();
        }

        function renderConsumptionTemplates() {
            const tbody = document.getElementById('consumptionTemplatesTableBody');

            // 过滤出购电模版
            const consumptionTemplates = templates.filter(t => {
                const purpose = t.purpose || 'consumption';
                return purpose === 'consumption';
            });

            if (consumptionTemplates.length === 0) {
                const emptyTitle = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceEmptyPurchaseTitle') : '暂无购电模版';
                const emptyDesc = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceEmptyPurchaseDesc') : '点击"新建规则"创建您的第一个购电电价策略模版';

                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                                <h3 class="empty-state-title">${emptyTitle}</h3>
                                <p class="empty-state-description">${emptyDesc}</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = consumptionTemplates.map(template => {
                const appliedSites = siteConfigs.filter(c => c.templateId === template.id);
                const lang = localStorage.getItem('language') || 'zh';
                const noDescText = lang === 'zh' ? '暂无描述' : 'No description';
                const description = template.description || noDescText;
                const translatedName = getTemplateI18nText(template.name);
                const translatedDesc = template.description ? getTemplateI18nText(template.description) : noDescText;

                return `
                    <tr>
                        <td><strong>${translatedName}</strong></td>
                        <td><span class="badge badge-primary">${getTypeNameTranslation(template.type)}</span></td>
                        <td>
                            <div class="text-truncate" title="${translatedDesc}">
                                ${translatedDesc}
                            </div>
                        </td>
                        <td>${appliedSites.length} ${getTranslation ? getTranslation('elecPriceSiteUnit') : '个站点'}</td>
                        <td>${template.createTime}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-text" onclick="viewTemplate(${template.id})">
                                    <i class="fas fa-eye"></i> ${getTranslation ? getTranslation('elecPriceBtnView') : '查看'}
                                </button>
                                <button class="btn btn-text" onclick="editTemplate(${template.id})">
                                    <i class="fas fa-edit"></i> ${getTranslation ? getTranslation('elecPriceBtnEdit') : '编辑'}
                                </button>
                                <button class="btn btn-text btn-danger" onclick="deleteTemplate(${template.id})">
                                    <i class="fas fa-trash"></i> ${getTranslation ? getTranslation('elecPriceBtnDelete') : '删除'}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderFeedinTemplates() {
            const tbody = document.getElementById('feedinTemplatesTableBody');

            // 过滤出上网模版
            const feedinTemplates = templates.filter(t => {
                const purpose = t.purpose || 'consumption';
                return purpose === 'feed-in';
            });

            if (feedinTemplates.length === 0) {
                const emptyTitle = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceEmptyFeedinTitle') : '暂无上网模版';
                const emptyDesc = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceEmptyFeedinDesc') : '点击"新建规则"创建您的第一个上网电价策略模版';

                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon"><i class="fas fa-inbox"></i></div>
                                <h3 class="empty-state-title">${emptyTitle}</h3>
                                <p class="empty-state-description">${emptyDesc}</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = feedinTemplates.map(template => {
                const appliedSites = siteConfigs.filter(c => c.templateId === template.id);
                const lang = localStorage.getItem('language') || 'zh';
                const noDescText = lang === 'zh' ? '暂无描述' : 'No description';
                const description = template.description || noDescText;
                const translatedName = getTemplateI18nText(template.name);
                const translatedDesc = template.description ? getTemplateI18nText(template.description) : noDescText;

                return `
                    <tr>
                        <td><strong>${translatedName}</strong></td>
                        <td><span class="badge badge-primary">${getTypeNameTranslation(template.type)}</span></td>
                        <td>
                            <div class="text-truncate" title="${translatedDesc}">
                                ${translatedDesc}
                            </div>
                        </td>
                        <td>${appliedSites.length} ${getTranslation ? getTranslation('elecPriceSiteUnit') : '个站点'}</td>
                        <td>${template.createTime}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-text" onclick="viewTemplate(${template.id})">
                                    <i class="fas fa-eye"></i> ${getTranslation ? getTranslation('elecPriceBtnView') : '查看'}
                                </button>
                                <button class="btn btn-text" onclick="editTemplate(${template.id})">
                                    <i class="fas fa-edit"></i> ${getTranslation ? getTranslation('elecPriceBtnEdit') : '编辑'}
                                </button>
                                <button class="btn btn-text" style="color: #ef4444;" onclick="deleteTemplate(${template.id})">
                                    <i class="fas fa-trash"></i> ${getTranslation ? getTranslation('elecPriceBtnDelete') : '删除'}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 选择模版用途（由Tab自动确定，不需要用户手动选择）
        function selectPurpose(purpose) {
            // 设置隐藏字段
            document.getElementById('templatePurpose').value = purpose;

            // 启用策略类型选择并更新选项
            const typeSelect = document.getElementById('templateType');
            typeSelect.disabled = false;
            typeSelect.innerHTML = '';

            // 根据用途设置不同的策略类型选项
            if (purpose === 'consumption') {
                // 用电电价：支持所有类型
                typeSelect.innerHTML = `
                    <option value="" data-translate="elecPriceFormPlaceholderSelectType">请选择策略类型</option>
                    <option value="tou" data-translate="elecPriceTypeTOUFull">分时电价（峰谷平尖）</option>
                    <option value="tiered" data-translate="elecPriceTypeTieredFull">阶梯电价（按用电量）</option>
                    <option value="fixed" data-translate="elecPriceTypeFixed">固定电价</option>
                `;
            } else if (purpose === 'feed-in') {
                // 上网电价：主要是固定价格，也可能有分时
                typeSelect.innerHTML = `
                    <option value="" data-translate="elecPriceFormPlaceholderSelectType">请选择策略类型</option>
                    <option value="fixed" data-translate="elecPriceTypeFixed">固定电价</option>
                    <option value="tou" data-translate="elecPriceTypeTOUSolar">分时电价（光伏时段）</option>
                `;
            }

            // 应用翻译到新生成的选项
            if (typeof setLanguage === 'function' && typeof currentLang !== 'undefined') {
                setLanguage(currentLang);
            }

            // 清空之前的配置
            onTypeChange();
        }

        function onTypeChange() {
            const type = document.getElementById('templateType').value;
            const periodsSection = document.getElementById('periodsSection');
            const periodsContainer = document.getElementById('periodsContainer');
            const tiersSection = document.getElementById('tiersSection');
            const tiersContainer = document.getElementById('tiersContainer');
            const fixedPriceSection = document.getElementById('fixedPriceSection');

            // 清空之前的配置
            periodsContainer.innerHTML = '';
            tiersContainer.innerHTML = '';
            periodCounter = 0;

            // 隐藏所有配置区域
            periodsSection.style.display = 'none';
            tiersSection.style.display = 'none';
            fixedPriceSection.style.display = 'none';

            if (type) {
                switch(type) {
                    case 'tou':
                        // 分时电价：显示时段配置
                        periodsSection.style.display = 'block';

                        // 重置时段策略模式为固定
                        currentPeriodStrategyMode = 'fixed';
                        fixedPeriods = [];
                        monthlyPeriods = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                        periodSeasonConfigs = [
                            { id: 'period-season-1', name: '夏季', months: [6, 7, 8, 9], periods: [] }
                        ];
                        periodSeasonCounter = 1;
                        currentPeriodSeasonId = 'period-season-1';

                        // 设置固定模式为选中状态
                        document.querySelectorAll('input[name="periodStrategyMode"]').forEach(radio => {
                            radio.checked = radio.value === 'fixed';
                        });

                        // 渲染时段类型选择按钮
                        renderPeriodTypeButtons();
                        break;
                    case 'tiered':
                        // 阶梯电价：显示阶梯配置,使用resetTiers添加带默认值的三个阶梯
                        tiersSection.style.display = 'block';
                        resetTiers(false); // 不显示提示消息
                        break;
                    case 'fixed':
                        // 固定电价：显示固定电价配置区域
                        fixedPriceSection.style.display = 'block';

                        // 重置固定电价策略模式为固定
                        currentFixedPriceStrategyMode = 'fixed';
                        fixedPriceSeasonConfigs = [
                            { id: 'fixed-price-season-1', name: '夏季', months: [6, 7, 8, 9] }
                        ];
                        fixedPriceSeasonCounter = 1;
                        currentFixedPriceSeasonId = 'fixed-price-season-1';

                        // 设置固定模式为选中状态
                        document.querySelectorAll('input[name="fixedPriceStrategyMode"]').forEach(radio => {
                            radio.checked = radio.value === 'fixed';
                        });
                        break;
                }
            }
        }

        // 时段类型的动态配置（支持用户自定义）
        let periodTypeConfigs = [
            { id: 'super-peak', name: '尖时段', color: '#ef4444', bgColor: 'rgba(239, 68, 68, 0.15)' },
            { id: 'peak', name: '峰时段', color: '#eab308', bgColor: 'rgba(234, 179, 8, 0.15)' },
            { id: 'flat', name: '平时段', color: '#3b82f6', bgColor: 'rgba(59, 130, 246, 0.15)' },
            { id: 'valley', name: '谷时段', color: '#22c55e', bgColor: 'rgba(34, 197, 94, 0.15)' }
        ];

        let periodTypeCounter = 4; // 用于生成新时段类型的ID

        // ==================== 时段策略模式管理 ====================

        let currentPeriodStrategyMode = 'fixed';  // 'fixed' | 'monthly' | 'seasonal'
        let currentPeriodMonth = 1;               // 当前选中的月份（逐月模式）
        let currentPeriodSeasonId = null;         // 当前选中的季节ID（分季节模式）

        // 时段配置数据存储
        let fixedPeriods = [];  // 固定模式的时段数据
        let monthlyPeriods = {  // 逐月模式的时段数据
            1: [], 2: [], 3: [], 4: [], 5: [], 6: [],
            7: [], 8: [], 9: [], 10: [], 11: [], 12: []
        };
        let periodSeasonConfigs = [  // 分季节模式的季节配置
            { id: 'season-1', name: '夏季', months: [6, 7, 8, 9], periods: [] }
        ];

        let periodSeasonCounter = 1; // 用于生成新季节ID

        // 切换时段策略模式
        function switchPeriodStrategyMode(mode) {
            // 保存当前时段配置
            saveCurrentPeriods();

            currentPeriodStrategyMode = mode;

            // 隐藏所有区域
            document.getElementById('periodSeasonConfigArea').style.display = 'none';
            document.getElementById('periodMonthlyTabs').style.display = 'none';
            document.getElementById('periodSeasonTabs').style.display = 'none';

            if (mode === 'fixed') {
                // 固定模式：加载单份时段配置
                loadFixedPeriods();
            } else if (mode === 'monthly') {
                // 逐月模式：显示月份标签页
                document.getElementById('periodMonthlyTabs').style.display = 'block';
                currentPeriodMonth = 1;
                switchPeriodMonth(1);
            } else if (mode === 'seasonal') {
                // 分季节模式：显示季节配置区域和季节标签页
                document.getElementById('periodSeasonConfigArea').style.display = 'block';
                document.getElementById('periodSeasonTabs').style.display = 'block';
                renderPeriodSeasonConfigList();
                renderPeriodSeasonTabs();
                if (periodSeasonConfigs.length > 0) {
                    currentPeriodSeasonId = periodSeasonConfigs[0].id;
                    loadPeriodSeasonData(currentPeriodSeasonId);
                }
            }
        }

        // 切换时段月份
        function switchPeriodMonth(month) {
            // 保存当前月份的时段配置
            saveCurrentPeriods();

            currentPeriodMonth = month;

            // 更新月份标签样式
            document.querySelectorAll('.period-month-tab').forEach(tab => {
                const tabMonth = parseInt(tab.getAttribute('data-month'));
                if (tabMonth === month) {
                    tab.classList.add('active');
                    tab.style.color = '#3b82f6';
                    tab.style.borderBottom = '2px solid #3b82f6';
                    tab.style.marginBottom = '-10px';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = '#6b7280';
                    tab.style.borderBottom = 'none';
                    tab.style.marginBottom = '0';
                }
            });

            // 加载该月份的时段配置
            loadMonthlyPeriods(month);
        }

        // 保存当前时段配置
        function saveCurrentPeriods() {
            const container = document.getElementById('periodsContainer');
            const periodGroups = Array.from(container.children);

            const periods = [];
            periodGroups.forEach(group => {
                const type = group.getAttribute('data-period-type');
                const periodItems = group.querySelectorAll('.period-item');

                periodItems.forEach(item => {
                    const name = item.querySelector('.period-item-name').textContent;
                    const startInput = item.querySelector('input[placeholder*="开始时间"]');
                    const endInput = item.querySelector('input[placeholder*="结束时间"]');
                    const priceInput = item.querySelector('input[placeholder*="电价"]');

                    if (startInput && endInput && priceInput) {
                        periods.push({
                            type: type,
                            name: name,
                            start: startInput.value,
                            end: endInput.value,
                            price: priceInput.value
                        });
                    }
                });
            });

            if (currentPeriodStrategyMode === 'fixed') {
                fixedPeriods = periods;
            } else if (currentPeriodStrategyMode === 'monthly') {
                monthlyPeriods[currentPeriodMonth] = periods;
            } else if (currentPeriodStrategyMode === 'seasonal') {
                const season = periodSeasonConfigs.find(s => s.id === currentPeriodSeasonId);
                if (season) {
                    season.periods = periods;
                }
            }
        }

        // 加载固定模式时段配置
        function loadFixedPeriods() {
            const container = document.getElementById('periodsContainer');
            container.innerHTML = '';

            fixedPeriods.forEach(period => {
                addPeriodType(period.type);
                const group = container.querySelector(`[data-period-type="${period.type}"]`);
                if (group) {
                    const addBtn = group.querySelector('.add-period-btn');
                    if (addBtn) {
                        addBtn.click();
                        const lastItem = group.querySelector('.period-item:last-child');
                        if (lastItem) {
                            lastItem.querySelector('input[placeholder*="开始时间"]').value = period.start;
                            lastItem.querySelector('input[placeholder*="结束时间"]').value = period.end;
                            lastItem.querySelector('input[placeholder*="电价"]').value = period.price;
                        }
                    }
                }
            });

            // 更新时间轴可视化
            setTimeout(() => updateTimelineVisualization(), 100);
        }

        // 加载逐月模式时段配置
        function loadMonthlyPeriods(month) {
            const container = document.getElementById('periodsContainer');
            container.innerHTML = '';

            const periods = monthlyPeriods[month] || [];
            periods.forEach(period => {
                addPeriodType(period.type);
                const group = container.querySelector(`[data-period-type="${period.type}"]`);
                if (group) {
                    const addBtn = group.querySelector('.add-period-btn');
                    if (addBtn) {
                        addBtn.click();
                        const lastItem = group.querySelector('.period-item:last-child');
                        if (lastItem) {
                            lastItem.querySelector('input[placeholder*="开始时间"]').value = period.start;
                            lastItem.querySelector('input[placeholder*="结束时间"]').value = period.end;
                            lastItem.querySelector('input[placeholder*="电价"]').value = period.price;
                        }
                    }
                }
            });

            // 更新时间轴可视化
            setTimeout(() => updateTimelineVisualization(), 100);
        }

        // 加载季节时段配置
        function loadPeriodSeasonData(seasonId) {
            const season = periodSeasonConfigs.find(s => s.id === seasonId);
            if (!season) return;

            const container = document.getElementById('periodsContainer');
            container.innerHTML = '';

            const periods = season.periods || [];
            periods.forEach(period => {
                addPeriodType(period.type);
                const group = container.querySelector(`[data-period-type="${period.type}"]`);
                if (group) {
                    const addBtn = group.querySelector('.add-period-btn');
                    if (addBtn) {
                        addBtn.click();
                        const lastItem = group.querySelector('.period-item:last-child');
                        if (lastItem) {
                            lastItem.querySelector('input[placeholder*="开始时间"]').value = period.start;
                            lastItem.querySelector('input[placeholder*="结束时间"]').value = period.end;
                            lastItem.querySelector('input[placeholder*="电价"]').value = period.price;
                        }
                    }
                }
            });

            // 更新时间轴可视化
            setTimeout(() => updateTimelineVisualization(), 100);
        }

        // 渲染时段季节配置列表
        function renderPeriodSeasonConfigList() {
            const container = document.getElementById('periodSeasonConfigList');
            container.innerHTML = '';

            // 获取翻译文本
            const seasonNamePlaceholder = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonNamePlaceholder') : '季节名称';
            const deleteText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonDelete') : '删除';

            periodSeasonConfigs.forEach((season, index) => {
                const seasonDiv = document.createElement('div');
                seasonDiv.style.cssText = 'margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 12px;';

                // 可用月份（未被其他季节使用的）
                const usedMonths = periodSeasonConfigs
                    .filter(s => s.id !== season.id)
                    .flatMap(s => s.months);
                const availableMonths = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
                    .filter(m => !usedMonths.includes(m));

                const allMonths = [...new Set([...availableMonths, ...season.months])].sort((a, b) => a - b);

                // 生成月份标签HTML
                const monthLabelsHTML = allMonths.map(m => {
                    const monthKey = `elecPriceMonth${m}`;
                    const monthText = typeof getTranslation === 'function' ?
                        getTranslation(monthKey) : `${m}月`;

                    return `
                        <label style="display: inline-flex; align-items: center; padding: 4px 8px; background: ${season.months.includes(m) ? '#eff6ff' : '#f8fafc'}; border: 1px solid ${season.months.includes(m) ? '#3b82f6' : '#e2e8f0'}; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" ${season.months.includes(m) ? 'checked' : ''}
                                ${!availableMonths.includes(m) && !season.months.includes(m) ? 'disabled' : ''}
                                onchange="togglePeriodSeasonMonth('${season.id}', ${m}, this.checked)"
                                style="margin-right: 4px; cursor: pointer;">
                            <span style="color: ${season.months.includes(m) ? '#3b82f6' : '#6b7280'};">${monthText}</span>
                        </label>
                    `;
                }).join('');

                seasonDiv.innerHTML = `
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <input type="text" value="${getTemplateI18nText(season.name)}"
                            onchange="updatePeriodSeasonName('${season.id}', this.value)"
                            placeholder="${seasonNamePlaceholder}"
                            style="flex: 1; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px;">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removePeriodSeason('${season.id}')" style="min-width: 60px;">
                            <i class="fas fa-trash"></i> ${deleteText}
                        </button>
                    </div>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        ${monthLabelsHTML}
                    </div>
                `;

                container.appendChild(seasonDiv);
            });
        }

        // 渲染时段季节标签页
        function renderPeriodSeasonTabs() {
            const container = document.getElementById('periodSeasonTabsList');
            container.innerHTML = '';

            periodSeasonConfigs.forEach((season, index) => {
                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'period-season-tab';
                tab.setAttribute('data-season-id', season.id);
                tab.textContent = getTemplateI18nText(season.name);
                tab.onclick = () => switchPeriodSeason(season.id);

                if (season.id === currentPeriodSeasonId) {
                    tab.classList.add('active');
                    tab.style.cssText = 'padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #3b82f6; border-bottom: 2px solid #3b82f6; margin-bottom: -10px;';
                } else {
                    tab.style.cssText = 'padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;';
                }

                container.appendChild(tab);
            });
        }

        // 切换时段季节
        function switchPeriodSeason(seasonId) {
            // 保存当前季节的时段配置
            saveCurrentPeriods();

            currentPeriodSeasonId = seasonId;

            // 更新季节标签样式
            document.querySelectorAll('.period-season-tab').forEach(tab => {
                const tabSeasonId = tab.getAttribute('data-season-id');
                if (tabSeasonId === seasonId) {
                    tab.classList.add('active');
                    tab.style.color = '#3b82f6';
                    tab.style.borderBottom = '2px solid #3b82f6';
                    tab.style.marginBottom = '-10px';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = '#6b7280';
                    tab.style.borderBottom = 'none';
                    tab.style.marginBottom = '0';
                }
            });

            // 加载该季节的时段配置
            loadPeriodSeasonData(seasonId);
        }

        // 添加时段季节
        function addPeriodSeasonInline() {
            periodSeasonCounter++;

            const seasonNameTemplate = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonDefault') : '季节{n}';
            const seasonName = seasonNameTemplate.replace('{n}', periodSeasonCounter);

            const newSeason = {
                id: `period-season-${periodSeasonCounter}`,
                name: seasonName,
                months: [],
                periods: []
            };

            periodSeasonConfigs.push(newSeason);
            renderPeriodSeasonConfigList();
            renderPeriodSeasonTabs();

            // 自动切换到新季节
            currentPeriodSeasonId = newSeason.id;
            switchPeriodSeason(newSeason.id);
        }

        // 更新时段季节名称
        function updatePeriodSeasonName(seasonId, newName) {
            const season = periodSeasonConfigs.find(s => s.id === seasonId);
            if (season) {
                season.name = newName;
                renderPeriodSeasonTabs();
            }
        }

        // 删除时段季节
        function removePeriodSeason(seasonId) {
            if (periodSeasonConfigs.length <= 1) {
                showToast('至少保留一个季节', 'error');
                return;
            }

            periodSeasonConfigs = periodSeasonConfigs.filter(s => s.id !== seasonId);

            if (currentPeriodSeasonId === seasonId) {
                currentPeriodSeasonId = periodSeasonConfigs[0].id;
            }

            renderPeriodSeasonConfigList();
            renderPeriodSeasonTabs();
            loadPeriodSeasonData(currentPeriodSeasonId);
        }

        // 切换时段季节月份
        function togglePeriodSeasonMonth(seasonId, month, checked) {
            const season = periodSeasonConfigs.find(s => s.id === seasonId);
            if (!season) return;

            if (checked) {
                if (!season.months.includes(month)) {
                    season.months.push(month);
                    season.months.sort((a, b) => a - b);
                }
            } else {
                season.months = season.months.filter(m => m !== month);
            }

            renderPeriodSeasonConfigList();
        }

        // ==================== 时段策略模式管理结束 ====================

        // ==================== 固定电价策略模式管理 ====================

        let currentFixedPriceStrategyMode = 'fixed';  // 'fixed' | 'monthly' | 'seasonal'
        let currentFixedPriceMonth = 1;               // 当前选中的月份（逐月模式）
        let currentFixedPriceSeasonId = null;         // 当前选中的季节ID（分季节模式）

        // 固定电价策略配置存储（只保存策略模式选择，不保存具体电价值）
        let fixedPriceSeasonConfigs = [  // 分季节模式的季节配置
            { id: 'fixed-price-season-1', name: '夏季', months: [6, 7, 8, 9] }
        ];

        let fixedPriceSeasonCounter = 1; // 用于生成新季节ID

        // 切换固定电价策略模式
        function switchFixedPriceStrategyMode(mode) {
            // 保存当前电价配置
            saveCurrentFixedPrice();

            currentFixedPriceStrategyMode = mode;

            // 隐藏所有区域
            document.getElementById('fixedPriceSeasonConfigArea').style.display = 'none';
            document.getElementById('fixedPriceMonthlyTabs').style.display = 'none';
            document.getElementById('fixedPriceSeasonTabs').style.display = 'none';

            if (mode === 'fixed') {
                // 固定模式：加载单一电价
                loadFixedPriceValue();
            } else if (mode === 'monthly') {
                // 逐月模式：显示月份标签页
                document.getElementById('fixedPriceMonthlyTabs').style.display = 'block';
                currentFixedPriceMonth = 1;
                switchFixedPriceMonth(1);
            } else if (mode === 'seasonal') {
                // 分季节模式：显示季节配置区域和季节标签页
                document.getElementById('fixedPriceSeasonConfigArea').style.display = 'block';
                document.getElementById('fixedPriceSeasonTabs').style.display = 'block';
                renderFixedPriceSeasonConfigList();
                renderFixedPriceSeasonTabs();
                if (fixedPriceSeasonConfigs.length > 0) {
                    currentFixedPriceSeasonId = fixedPriceSeasonConfigs[0].id;
                    loadFixedPriceSeasonData(currentFixedPriceSeasonId);
                }
            }
        }

        // 切换固定电价月份
        function switchFixedPriceMonth(month) {
            // 保存当前月份的电价配置
            saveCurrentFixedPrice();

            currentFixedPriceMonth = month;

            // 更新月份标签样式
            document.querySelectorAll('.fixed-price-month-tab').forEach(tab => {
                const tabMonth = parseInt(tab.getAttribute('data-month'));
                if (tabMonth === month) {
                    tab.classList.add('active');
                    tab.style.color = '#3b82f6';
                    tab.style.borderBottom = '2px solid #3b82f6';
                    tab.style.marginBottom = '-10px';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = '#6b7280';
                    tab.style.borderBottom = 'none';
                    tab.style.marginBottom = '0';
                }
            });

            // 加载该月份的电价配置
            loadMonthlyPriceValue(month);
        }

        // 保存当前固定电价配置（固定电价只保存策略模式，不保存具体电价值）
        function saveCurrentFixedPrice() {
            // 固定电价区域不再需要保存电价值，此函数保留为空以兼容现有调用
        }

        // 加载固定模式电价（固定电价只保存策略模式，不保存具体电价值）
        function loadFixedPriceValue() {
            // 固定电价区域不再需要加载电价值，此函数保留为空以兼容现有调用
        }

        // 加载逐月模式电价（固定电价只保存策略模式，不保存具体电价值）
        function loadMonthlyPriceValue(month) {
            // 固定电价区域不再需要加载电价值，此函数保留为空以兼容现有调用
        }

        // 加载季节电价数据（固定电价只保存策略模式，不保存具体电价值）
        function loadFixedPriceSeasonData(seasonId) {
            // 固定电价区域不再需要加载电价值，此函数保留为空以兼容现有调用
        }

        // 渲染固定电价季节配置列表
        function renderFixedPriceSeasonConfigList() {
            const container = document.getElementById('fixedPriceSeasonConfigList');
            container.innerHTML = '';

            // 获取翻译文本
            const seasonNamePlaceholder = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonNamePlaceholder') : '季节名称';
            const deleteText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonDelete') : '删除';

            fixedPriceSeasonConfigs.forEach((season, index) => {
                const seasonDiv = document.createElement('div');
                seasonDiv.style.cssText = 'margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 12px;';

                // 可用月份（未被其他季节使用的）
                const usedMonths = fixedPriceSeasonConfigs
                    .filter(s => s.id !== season.id)
                    .flatMap(s => s.months);
                const availableMonths = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
                    .filter(m => !usedMonths.includes(m));

                const allMonths = [...new Set([...availableMonths, ...season.months])].sort((a, b) => a - b);

                // 生成月份标签HTML
                const monthLabelsHTML = allMonths.map(m => {
                    const monthKey = `elecPriceMonth${m}`;
                    const monthText = typeof getTranslation === 'function' ?
                        getTranslation(monthKey) : `${m}月`;

                    return `
                        <label style="display: inline-flex; align-items: center; padding: 4px 8px; background: ${season.months.includes(m) ? '#eff6ff' : '#f8fafc'}; border: 1px solid ${season.months.includes(m) ? '#3b82f6' : '#e2e8f0'}; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" ${season.months.includes(m) ? 'checked' : ''}
                                ${!availableMonths.includes(m) && !season.months.includes(m) ? 'disabled' : ''}
                                onchange="toggleFixedPriceSeasonMonth('${season.id}', ${m}, this.checked)"
                                style="margin-right: 4px; cursor: pointer;">
                            <span style="color: ${season.months.includes(m) ? '#3b82f6' : '#6b7280'};">${monthText}</span>
                        </label>
                    `;
                }).join('');

                seasonDiv.innerHTML = `
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <input type="text" value="${getTemplateI18nText(season.name)}"
                            onchange="updateFixedPriceSeasonName('${season.id}', this.value)"
                            placeholder="${seasonNamePlaceholder}"
                            style="flex: 1; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px;">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeFixedPriceSeason('${season.id}')" style="min-width: 60px;">
                            <i class="fas fa-trash"></i> ${deleteText}
                        </button>
                    </div>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        ${monthLabelsHTML}
                    </div>
                `;

                container.appendChild(seasonDiv);
            });
        }

        // 渲染固定电价季节标签页
        function renderFixedPriceSeasonTabs() {
            const container = document.getElementById('fixedPriceSeasonTabsList');
            container.innerHTML = '';

            fixedPriceSeasonConfigs.forEach((season, index) => {
                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'fixed-price-season-tab';
                tab.setAttribute('data-season-id', season.id);
                tab.textContent = getTemplateI18nText(season.name);
                tab.onclick = () => switchFixedPriceSeason(season.id);

                if (season.id === currentFixedPriceSeasonId) {
                    tab.classList.add('active');
                    tab.style.cssText = 'padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #3b82f6; border-bottom: 2px solid #3b82f6; margin-bottom: -10px;';
                } else {
                    tab.style.cssText = 'padding: 6px 12px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; color: #6b7280;';
                }

                container.appendChild(tab);
            });
        }

        // 切换固定电价季节
        function switchFixedPriceSeason(seasonId) {
            // 保存当前季节的电价配置
            saveCurrentFixedPrice();

            currentFixedPriceSeasonId = seasonId;

            // 更新季节标签样式
            document.querySelectorAll('.fixed-price-season-tab').forEach(tab => {
                const tabSeasonId = tab.getAttribute('data-season-id');
                if (tabSeasonId === seasonId) {
                    tab.classList.add('active');
                    tab.style.color = '#3b82f6';
                    tab.style.borderBottom = '2px solid #3b82f6';
                    tab.style.marginBottom = '-10px';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = '#6b7280';
                    tab.style.borderBottom = 'none';
                    tab.style.marginBottom = '0';
                }
            });

            // 加载该季节的电价配置
            loadFixedPriceSeasonData(seasonId);
        }

        // 添加固定电价季节
        function addFixedPriceSeasonInline() {
            fixedPriceSeasonCounter++;

            const seasonNameTemplate = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonDefault') : '季节{n}';
            const seasonName = seasonNameTemplate.replace('{n}', fixedPriceSeasonCounter);

            const newSeason = {
                id: `fixed-price-season-${fixedPriceSeasonCounter}`,
                name: seasonName,
                months: []
            };

            fixedPriceSeasonConfigs.push(newSeason);
            renderFixedPriceSeasonConfigList();
            renderFixedPriceSeasonTabs();

            // 自动切换到新季节
            currentFixedPriceSeasonId = newSeason.id;
            switchFixedPriceSeason(newSeason.id);
        }

        // 更新固定电价季节名称
        function updateFixedPriceSeasonName(seasonId, newName) {
            const season = fixedPriceSeasonConfigs.find(s => s.id === seasonId);
            if (season) {
                season.name = newName;
                renderFixedPriceSeasonTabs();
            }
        }

        // 删除固定电价季节
        function removeFixedPriceSeason(seasonId) {
            if (fixedPriceSeasonConfigs.length <= 1) {
                showToast('至少保留一个季节', 'error');
                return;
            }

            fixedPriceSeasonConfigs = fixedPriceSeasonConfigs.filter(s => s.id !== seasonId);

            if (currentFixedPriceSeasonId === seasonId) {
                currentFixedPriceSeasonId = fixedPriceSeasonConfigs[0].id;
            }

            renderFixedPriceSeasonConfigList();
            renderFixedPriceSeasonTabs();
            loadFixedPriceSeasonData(currentFixedPriceSeasonId);
        }

        // 切换固定电价季节月份
        function toggleFixedPriceSeasonMonth(seasonId, month, checked) {
            const season = fixedPriceSeasonConfigs.find(s => s.id === seasonId);
            if (!season) return;

            if (checked) {
                if (!season.months.includes(month)) {
                    season.months.push(month);
                    season.months.sort((a, b) => a - b);
                }
            } else {
                season.months = season.months.filter(m => m !== month);
            }

            renderFixedPriceSeasonConfigList();
        }

        // ==================== 固定电价策略模式管理结束 ====================

        // 添加时段类型组
        function addPeriodType(typeId) {
            const container = document.getElementById('periodsContainer');

            // 检查是否已存在该类型
            if (container.querySelector(`[data-period-type="${typeId}"]`)) {
                showToast('该时段类型已存在', 'error');
                return;
            }

            // 从配置数组中查找时段类型
            const config = periodTypeConfigs.find(c => c.id === typeId);
            if (!config) {
                showToast('时段类型配置不存在', 'error');
                return;
            }

            periodCounter++;
            const groupId = `period-group-${periodCounter}`;

            const groupDiv = document.createElement('div');
            groupDiv.className = 'period-type-group';
            groupDiv.id = groupId;
            groupDiv.setAttribute('data-period-type', typeId);

            const multiPeriodText = typeof getTranslation === 'function' ?
                getTranslation('elecPricePeriodMultiple') : '可添加多个时间段';
            const addPeriodText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceBtnAddPeriod') : '添加时间段';

            groupDiv.innerHTML = `
                <div class="period-type-header">
                    <div class="period-type-title">
                        <span class="period-tag" style="background: ${config.bgColor}; color: ${config.color}; border-color: ${config.color}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;">${getTemplateI18nText(config.name)}</span>
                        <span style="font-size: 13px; color: #64748b;">${multiPeriodText}</span>
                    </div>
                    <div class="period-type-actions">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="addTimeSlot('${groupId}', '${typeId}')">
                            <i class="fas fa-plus"></i> ${addPeriodText}
                        </button>
                        <button type="button" class="btn btn-sm" style="background: transparent; color: #ef4444;" onclick="removePeriodType('${groupId}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="time-slots-container" data-type="${typeId}">
                    <!-- 时间段列表 -->
                </div>
            `;

            container.appendChild(groupDiv);

            // 自动添加第一个时间段
            addTimeSlot(groupId, typeId);

            // 更新时间轴可视化
            updateTimelineVisualization();
        }

        // 在指定类型组中添加时间段
        function addTimeSlot(groupId, type) {
            const group = document.getElementById(groupId);
            const slotsContainer = group.querySelector('.time-slots-container');

            periodCounter++;
            const slotId = `time-slot-${periodCounter}`;

            const slotDiv = document.createElement('div');
            slotDiv.className = 'time-slot-item';
            slotDiv.id = slotId;

            const startTimeText = typeof getTranslation === 'function' ?
                getTranslation('elecPricePeriodStartTime') : '开始时间';
            const endTimeText = typeof getTranslation === 'function' ?
                getTranslation('elecPricePeriodEndTime') : '结束时间';

            slotDiv.innerHTML = `
                <div class="time-slot-fields">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">${startTimeText}</label>
                        <input type="time" class="form-input time-input-start" value="00:00" required onchange="updateTimelineVisualization()">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">${endTimeText}</label>
                        <input type="time" class="form-input time-input-end" value="23:59" required onchange="updateTimelineVisualization()">
                    </div>
                </div>
                <button type="button" class="time-slot-remove" onclick="removeTimeSlot('${slotId}', '${groupId}')">
                    <i class="fas fa-times"></i>
                </button>
            `;

            slotsContainer.appendChild(slotDiv);

            // 更新时间轴可视化
            updateTimelineVisualization();
        }

        // 删除时间段
        function removeTimeSlot(slotId, groupId) {
            const slot = document.getElementById(slotId);
            const group = document.getElementById(groupId);
            const slotsContainer = group.querySelector('.time-slots-container');

            // 如果是最后一个时间段，不允许删除
            if (slotsContainer.children.length <= 1) {
                showToast('至少需要保留一个时间段', 'error');
                return;
            }

            slot.remove();

            // 更新时间轴可视化
            updateTimelineVisualization();
        }

        // 删除整个时段类型组
        function removePeriodType(groupId) {
            const confirmText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceConfirmDeletePeriodType') : '确定要删除该时段类型及其所有时间段吗？';

            if (confirm(confirmText)) {
                document.getElementById(groupId).remove();

                // 更新时间轴可视化
                updateTimelineVisualization();
            }
        }

        // ==================== 时段类型管理 ====================

        // 打开时段类型管理模态框
        function openPeriodTypeManager() {
            renderPeriodTypeManagerTable();
            document.getElementById('periodTypeManagerModal').classList.add('active');
        }

        // 关闭时段类型管理模态框
        function closePeriodTypeManager() {
            document.getElementById('periodTypeManagerModal').classList.remove('active');
            // 重新渲染添加时段按钮
            renderPeriodTypeButtons();
        }

        // 渲染时段类型管理表格
        function renderPeriodTypeManagerTable() {
            const tbody = document.getElementById('periodTypeManagerTableBody');
            tbody.innerHTML = '';

            // 获取翻译文本
            const emptyText = typeof getTranslation === 'function' ?
                getTranslation('elecPricePeriodTypesEmpty') : '暂无时段类型，请点击下方按钮添加';
            const namePlaceholder = typeof getTranslation === 'function' ?
                getTranslation('elecPricePeriodTypePlaceholder') : '请输入名称';
            const deleteTitle = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonDelete') : '删除';

            if (periodTypeConfigs.length === 0) {
                tbody.innerHTML = `<div style="text-align: center; color: #9ca3af; padding: 40px; grid-column: 1 / -1;">${emptyText}</div>`;
                return;
            }

            periodTypeConfigs.forEach((config, index) => {
                const rowDiv = document.createElement('div');
                rowDiv.style.cssText = 'display: grid; grid-template-columns: 80px 150px 1fr 80px; padding: 16px; border-bottom: 1px solid #e2e8f0; align-items: center;';
                rowDiv.setAttribute('data-config-id', config.id);

                // 计算背景色（带透明度的颜色）
                const hexToRgba = (hex, alpha = 0.15) => {
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                };

                rowDiv.innerHTML = `
                    <div style="font-size: 14px; color: #374151; font-weight: 500;">${index + 1}</div>
                    <div style="position: relative;">
                        <div style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer;" onclick="toggleColorPicker('${config.id}')">
                            <div style="width: 24px; height: 24px; border-radius: 4px; background: ${config.color}; border: 1px solid #e2e8f0;"></div>
                            <i class="fas fa-chevron-down" style="font-size: 12px; color: #9ca3af;"></i>
                        </div>
                        <input type="color" id="color-picker-${config.id}" value="${config.color}" onchange="updatePeriodTypeColor('${config.id}', this.value)" style="position: absolute; opacity: 0; pointer-events: none;">
                    </div>
                    <div>
                        <input type="text" value="${getTemplateI18nText(config.name)}" onchange="updatePeriodTypeName('${config.id}', this.value)" placeholder="${namePlaceholder}" style="width: 100%; padding: 8px 12px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div style="text-align: center;">
                        <button type="button" class="btn btn-sm" style="background: transparent; color: #ef4444; border: none; padding: 6px 12px;" onclick="deletePeriodTypeFromTable('${config.id}')" title="${deleteTitle}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;

                tbody.appendChild(rowDiv);
            });
        }

        // 切换颜色选择器
        function toggleColorPicker(configId) {
            const colorInput = document.getElementById(`color-picker-${configId}`);
            if (colorInput) {
                colorInput.click();
            }
        }

        // 更新时段类型名称
        function updatePeriodTypeName(configId, newName) {
            const config = periodTypeConfigs.find(c => c.id === configId);
            if (!config) return;

            const trimmedName = newName.trim();
            if (!trimmedName) {
                showToast('名称不能为空', 'error');
                renderPeriodTypeManagerTable();
                return;
            }

            // 检查名称是否与其他类型重复
            const duplicate = periodTypeConfigs.find(c => c.id !== configId && c.name === trimmedName);
            if (duplicate) {
                showToast('该名称已存在', 'error');
                renderPeriodTypeManagerTable();
                return;
            }

            config.name = trimmedName;
        }

        // 更新时段类型颜色
        function updatePeriodTypeColor(configId, newColor) {
            const config = periodTypeConfigs.find(c => c.id === configId);
            if (!config) return;

            // 计算背景色
            const hexToRgba = (hex, alpha = 0.15) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            };

            config.color = newColor;
            config.bgColor = hexToRgba(newColor);

            renderPeriodTypeManagerTable();
        }

        // 添加新的时段类型行
        function addNewPeriodTypeRow() {
            // 生成新ID
            periodTypeCounter++;
            const newId = `custom-period-${periodTypeCounter}`;

            // 默认颜色
            const defaultColor = '#3b82f6';
            const hexToRgba = (hex, alpha = 0.15) => {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            };

            // 添加新配置
            periodTypeConfigs.push({
                id: newId,
                name: '',
                color: defaultColor,
                bgColor: hexToRgba(defaultColor)
            });

            // 重新渲染表格
            renderPeriodTypeManagerTable();

            // 聚焦到新添加的名称输入框
            setTimeout(() => {
                const newRow = document.querySelector(`[data-config-id="${newId}"]`);
                if (newRow) {
                    const nameInput = newRow.querySelector('input[type="text"]');
                    if (nameInput) {
                        nameInput.focus();
                    }
                }
            }, 100);
        }

        // 从表格中删除时段类型
        function deletePeriodTypeFromTable(configId) {
            // 检查该时段类型是否已被使用
            const container = document.getElementById('periodsContainer');
            if (container && container.querySelector(`[data-period-type="${configId}"]`)) {
                const inUseText = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceConfirmDeletePeriodTypeInUse') : '该时段类型正在使用中，无法删除';
                showToast(inUseText, 'error');
                return;
            }

            const config = periodTypeConfigs.find(c => c.id === configId);
            if (!config) return;

            // 如果名称为空，直接删除
            if (!config.name.trim()) {
                periodTypeConfigs = periodTypeConfigs.filter(c => c.id !== configId);
                renderPeriodTypeManagerTable();
                return;
            }

            const confirmText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceConfirmDeletePeriodType') : '确定要删除该时段类型及其所有时间段吗？';
            const successText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceToastDeleteSuccess') : '删除成功';

            if (confirm(confirmText.replace('该时段类型及其所有时间段', `"${config.name}"`))) {
                periodTypeConfigs = periodTypeConfigs.filter(c => c.id !== configId);
                renderPeriodTypeManagerTable();
                showToast(successText, 'success');
            }
        }

        // 动态渲染添加时段按钮
        function renderPeriodTypeButtons() {
            const container = document.getElementById('periodTypeButtonsContainer');
            container.innerHTML = '';

            if (periodTypeConfigs.length === 0) {
                const emptyMsg = typeof getTranslation === 'function' ?
                    getTranslation('elecPricePeriodTypesEmpty') :
                    '暂无可用的时段类型，请先在管理中添加';
                container.innerHTML = `<p style="color: #9ca3af; font-size: 13px;">${emptyMsg}</p>`;
                return;
            }

            const addText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceBtnAdd') : '添加';

            periodTypeConfigs.forEach(config => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'btn btn-sm';
                button.style.cssText = `background: ${config.bgColor}; color: ${config.color}; border: 1px solid ${config.color}30;`;
                button.onclick = () => addPeriodType(config.id);

                // 使用翻译函数获取时段名称
                const periodName = getTemplateI18nText(config.name);
                button.innerHTML = `<i class="fas fa-plus"></i> ${addText}${periodName}`;
                container.appendChild(button);
            });
        }

        // ==================== 24小时时间轴可视化 ====================

        // 更新时间轴可视化
        function updateTimelineVisualization() {
            const timelineBar = document.getElementById('timelineBar');
            const coverageStats = document.getElementById('coverageStats');
            const timelineWarnings = document.getElementById('timelineWarnings');

            if (!timelineBar) return;

            // 收集所有时段数据
            const periods = collectAllPeriods();

            // 清空现有内容
            timelineBar.innerHTML = '';
            timelineWarnings.innerHTML = '';

            if (periods.length === 0) {
                const notConfiguredText = typeof getTranslation === 'function' ?
                    getTranslation('elecPricePeriodNotConfigured') : '未配置';
                const addAtLeastOneText = typeof getTranslation === 'function' ?
                    getTranslation('elecPricePeriodAddAtLeastOne') : '请至少添加一个时段';

                coverageStats.innerHTML = `<span style="color: #ef4444;">${notConfiguredText}</span>`;
                timelineWarnings.innerHTML = `<div style="padding: 6px 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; color: #dc2626; font-size: 12px;"><i class="fas fa-exclamation-circle"></i> ${addAtLeastOneText}</div>`;
                return;
            }

            // 将时间转换为分钟并排序
            const timeRanges = periods.map(p => {
                const start = timeToMinutes(p.start);
                let end = timeToMinutes(p.end);

                // 处理跨天情况（如23:00-01:00）
                if (end <= start && end !== 0) {
                    end = 1440; // 24:00
                }
                if (end === 0) {
                    end = 1440; // 00:00 视为 24:00
                }

                return { ...p, startMin: start, endMin: end };
            }).sort((a, b) => a.startMin - b.startMin);

            // 检测覆盖情况
            const coverage = calculateCoverage(timeRanges);
            const overlaps = detectOverlaps(timeRanges);
            const gaps = detectGaps(timeRanges);

            // 渲染时间轴色块（使用时段类型的颜色）
            timeRanges.forEach(range => {
                const typeConfig = periodTypeConfigs.find(c => c.id === range.type);
                if (!typeConfig) return;

                const startPercent = (range.startMin / 1440) * 100;
                const widthPercent = ((range.endMin - range.startMin) / 1440) * 100;

                const block = document.createElement('div');
                block.style.cssText = `
                    position: absolute;
                    left: ${startPercent}%;
                    width: ${widthPercent}%;
                    height: 100%;
                    background: ${typeConfig.color};
                    border-right: 1px solid #ffffff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #ffffff;
                    font-size: 9px;
                    font-weight: 500;
                    overflow: hidden;
                    transition: opacity 0.2s;
                `;

                // 只在宽度足够时显示文字
                if (widthPercent > 5) {
                    block.textContent = getTemplateI18nText(typeConfig.name);
                }

                block.title = `${range.start} - ${range.end} (${getTemplateI18nText(typeConfig.name)})`;

                // 添加悬停效果
                block.onmouseenter = () => { block.style.opacity = '0.8'; };
                block.onmouseleave = () => { block.style.opacity = '1'; };

                timelineBar.appendChild(block);
            });

            // 渲染统计信息
            const coveragePercent = ((coverage / 1440) * 100).toFixed(1);
            const coverageHours = (coverage / 60).toFixed(1);

            const coveredTemplate = typeof getTranslation === 'function' ?
                getTranslation('elecPeriodCoverageCovered') : '已覆盖 {hours}h ({percent}%)';
            const coveredText = coveredTemplate.replace('{hours}', coverageHours).replace('{percent}', coveragePercent);

            coverageStats.innerHTML = `
                <span style="color: ${coverage === 1440 ? '#22c55e' : '#f59e0b'};">
                    ${coveredText}
                </span>
            `;

            // 渲染警告信息
            const warnings = [];

            if (coverage < 1440) {
                const uncoveredHours = ((1440 - coverage) / 60).toFixed(1);
                const uncoveredTemplate = typeof getTranslation === 'function' ?
                    getTranslation('elecPeriodCoverageRemaining') : '还有 {hours}h 未覆盖';
                const uncoveredText = uncoveredTemplate.replace('{hours}', uncoveredHours);
                warnings.push(`<i class="fas fa-exclamation-triangle"></i> ${uncoveredText}`);
            }

            if (overlaps.length > 0) {
                const overlapsTemplate = typeof getTranslation === 'function' ?
                    getTranslation('elecPeriodCoverageOverlaps') : '{count} 处重叠';
                const overlapsText = overlapsTemplate.replace('{count}', overlaps.length);
                warnings.push(`<i class="fas fa-exclamation-circle"></i> ${overlapsText}`);
            }

            if (gaps.length > 0) {
                const gapsTemplate = typeof getTranslation === 'function' ?
                    getTranslation('elecPeriodCoverageGaps') : '{count} 处间隙';
                const gapsText = gapsTemplate.replace('{count}', gaps.length);
                warnings.push(`<i class="fas fa-info-circle"></i> ${gapsText}`);
            }

            if (warnings.length > 0) {
                timelineWarnings.innerHTML = `
                    <div style="padding: 6px 10px; background: #fffbeb; border: 1px solid #fde68a; border-radius: 4px; color: #d97706; font-size: 12px;">
                        ${warnings.join(' &nbsp;·&nbsp; ')}
                    </div>
                `;
            } else if (coverage === 1440) {
                timelineWarnings.innerHTML = `
                    <div style="padding: 6px 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; color: #16a34a; font-size: 12px;">
                        <i class="fas fa-check-circle"></i> 时段配置完整
                    </div>
                `;
            }
        }

        // 收集当前所有时段配置
        function collectAllPeriods() {
            const periods = [];
            const container = document.getElementById('periodsContainer');
            if (!container) return periods;

            // 遍历所有时段类型组
            container.querySelectorAll('.period-type-group').forEach(group => {
                const type = group.getAttribute('data-period-type');
                const slotsContainer = group.querySelector('.time-slots-container');

                if (slotsContainer) {
                    slotsContainer.querySelectorAll('.time-slot-item').forEach(slot => {
                        const startInput = slot.querySelector('.time-input-start');
                        const endInput = slot.querySelector('.time-input-end');

                        if (startInput && endInput && startInput.value && endInput.value) {
                            periods.push({
                                type: type,
                                start: startInput.value,
                                end: endInput.value
                            });
                        }
                    });
                }
            });

            return periods;
        }

        // 将时间字符串转换为分钟数
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // 计算总覆盖时长（分钟）
        function calculateCoverage(ranges) {
            if (ranges.length === 0) return 0;

            // 合并重叠的时间段
            const merged = [];
            let current = { ...ranges[0] };

            for (let i = 1; i < ranges.length; i++) {
                const next = ranges[i];

                if (next.startMin <= current.endMin) {
                    // 有重叠，合并
                    current.endMin = Math.max(current.endMin, next.endMin);
                } else {
                    // 无重叠，保存当前段，开始新段
                    merged.push(current);
                    current = { ...next };
                }
            }
            merged.push(current);

            // 计算总覆盖时长
            return merged.reduce((total, range) => total + (range.endMin - range.startMin), 0);
        }

        // 检测重叠
        function detectOverlaps(ranges) {
            const overlaps = [];
            for (let i = 0; i < ranges.length; i++) {
                for (let j = i + 1; j < ranges.length; j++) {
                    const a = ranges[i];
                    const b = ranges[j];

                    if (a.startMin < b.endMin && b.startMin < a.endMin) {
                        overlaps.push({ a, b });
                    }
                }
            }
            return overlaps;
        }

        // 检测间隙
        function detectGaps(ranges) {
            const gaps = [];
            for (let i = 0; i < ranges.length - 1; i++) {
                const current = ranges[i];
                const next = ranges[i + 1];

                if (current.endMin < next.startMin) {
                    gaps.push({
                        start: current.endMin,
                        end: next.startMin
                    });
                }
            }

            // 检查开头和结尾的间隙
            if (ranges[0].startMin > 0) {
                gaps.unshift({ start: 0, end: ranges[0].startMin });
            }
            const lastRange = ranges[ranges.length - 1];
            if (lastRange.endMin < 1440) {
                gaps.push({ start: lastRange.endMin, end: 1440 });
            }

            return gaps;
        }

        // ==================== 阶梯管理函数 ====================

        let tierCounter = 0;
        let currentPeriodMode = 'fixed';  // 'fixed' | 'monthly' | 'seasonal'
        let currentMonth = 1;             // 当前选中的月份（逐月模式）
        let currentSeasonId = null;       // 当前选中的季节ID（分季节模式）

        // 存储不同模式的阶梯配置
        let fixedTiers = [];              // 固定模式：单份阶梯

        let monthlyTiers = {              // 逐月模式：12份阶梯
            1: [], 2: [], 3: [], 4: [], 5: [], 6: [],
            7: [], 8: [], 9: [], 10: [], 11: [], 12: []
        };

        // 季节配置数组（分季节模式）
        let seasonConfigs = [
            {
                id: 'season-1',
                name: '夏季',
                months: [5, 6, 7, 8, 9, 10],
                tiers: []
            },
            {
                id: 'season-2',
                name: '非夏季',
                months: [11, 12, 1, 2, 3, 4],
                tiers: []
            }
        ];

        let seasonCounter = 2; // 用于生成新季节ID

        // ==================== 时段配置模式切换 ====================

        // 切换时段配置模式
        function switchPeriodMode(mode) {
            // 保存当前配置
            saveCurrentTiers();

            currentPeriodMode = mode;

            // 隐藏所有区域
            document.getElementById('seasonConfigArea').style.display = 'none';
            document.getElementById('monthlyTabs').style.display = 'none';
            document.getElementById('seasonTabs').style.display = 'none';

            if (mode === 'fixed') {
                // 固定模式：加载单份阶梯
                loadFixedTiers();
            } else if (mode === 'monthly') {
                // 逐月模式：显示月份标签页
                document.getElementById('monthlyTabs').style.display = 'block';
                currentMonth = 1;
                switchMonth(1);
            } else if (mode === 'seasonal') {
                // 分季节模式：显示季节配置区域和季节标签页
                document.getElementById('seasonConfigArea').style.display = 'block';
                document.getElementById('seasonTabs').style.display = 'block';
                renderSeasonConfigList();
                renderSeasonTabs();
                if (seasonConfigs.length > 0) {
                    currentSeasonId = seasonConfigs[0].id;
                    loadSeasonTiers(currentSeasonId);
                }
            }
        }

        // 切换月份
        function switchMonth(month) {
            // 保存当前月份的配置
            saveCurrentTiers();

            currentMonth = month;

            // 更新月份标签样式
            document.querySelectorAll('.month-tab').forEach(tab => {
                const tabMonth = parseInt(tab.getAttribute('data-month'));
                if (tabMonth === month) {
                    tab.classList.add('active');
                    tab.style.color = '#3b82f6';
                    tab.style.borderBottom = '2px solid #3b82f6';
                    tab.style.marginBottom = '-10px';
                } else {
                    tab.classList.remove('active');
                    tab.style.color = '#6b7280';
                    tab.style.borderBottom = 'none';
                    tab.style.marginBottom = '0';
                }
            });

            // 加载该月份的阶梯配置
            loadMonthlyTiers(month);
        }

        // 渲染季节配置列表（内联方式，使用复选框）
        function renderSeasonConfigList() {
            const container = document.getElementById('seasonConfigList');
            container.innerHTML = '';

            // 获取翻译文本
            const seasonNamePlaceholder = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonNamePlaceholder') : '季节名称';
            const deleteText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonDelete') : '删除';

            seasonConfigs.forEach((season, index) => {
                const seasonDiv = document.createElement('div');
                seasonDiv.style.cssText = 'margin-bottom: 12px; border-bottom: 1px solid #e2e8f0; padding-bottom: 12px;';

                // 可用月份（未被其他季节使用的）
                const usedMonths = seasonConfigs
                    .filter(s => s.id !== season.id)
                    .flatMap(s => s.months);
                const availableMonths = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]
                    .filter(m => !usedMonths.includes(m));

                const allMonths = [...new Set([...availableMonths, ...season.months])].sort((a, b) => a - b);

                // 生成月份标签HTML
                const monthLabelsHTML = allMonths.map(m => {
                    const monthKey = `elecPriceMonth${m}`;
                    const monthText = typeof getTranslation === 'function' ?
                        getTranslation(monthKey) : `${m}月`;

                    return `
                        <label style="display: inline-flex; align-items: center; padding: 4px 8px; background: ${season.months.includes(m) ? '#eff6ff' : '#f8fafc'}; border: 1px solid ${season.months.includes(m) ? '#3b82f6' : '#e2e8f0'}; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" ${season.months.includes(m) ? 'checked' : ''}
                                ${!availableMonths.includes(m) && !season.months.includes(m) ? 'disabled' : ''}
                                onchange="toggleSeasonMonth('${season.id}', ${m}, this.checked)"
                                style="margin-right: 4px; cursor: pointer;">
                            <span style="color: ${season.months.includes(m) ? '#3b82f6' : '#6b7280'};">${monthText}</span>
                        </label>
                    `;
                }).join('');

                seasonDiv.innerHTML = `
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <input type="text" value="${getTemplateI18nText(season.name)}"
                            onchange="updateSeasonNameInline('${season.id}', this.value)"
                            placeholder="${seasonNamePlaceholder}"
                            style="flex: 1; padding: 6px 10px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 13px;">
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeSeasonInline('${season.id}')" style="min-width: 60px;">
                            <i class="fas fa-trash"></i> ${deleteText}
                        </button>
                    </div>
                    <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                        ${monthLabelsHTML}
                    </div>
                `;

                container.appendChild(seasonDiv);
            });
        }

        // 更新季节名称
        function updateSeasonNameInline(seasonId, newName) {
            const season = seasonConfigs.find(s => s.id === seasonId);
            if (season) {
                season.name = newName;
                renderSeasonTabs(); // 更新标签页显示
            }
        }

        // 切换季节月份（复选框方式）
        function toggleSeasonMonth(seasonId, month, checked) {
            const season = seasonConfigs.find(s => s.id === seasonId);
            if (!season) return;

            if (checked) {
                if (!season.months.includes(month)) {
                    season.months.push(month);
                    season.months.sort((a, b) => a - b);
                }
            } else {
                season.months = season.months.filter(m => m !== month);
            }

            renderSeasonConfigList();
            renderSeasonTabs();
        }

        // 添加新季节（内联方式）
        function addSeasonInline() {
            seasonCounter++;

            const seasonNameTemplate = typeof getTranslation === 'function' ?
                getTranslation('elecPriceSeasonDefault') : '季节{n}';
            const seasonName = seasonNameTemplate.replace('{n}', seasonCounter);

            const newSeason = {
                id: `season-${seasonCounter}`,
                name: seasonName,
                months: [],
                tiers: []
            };
            seasonConfigs.push(newSeason);
            renderSeasonConfigList();
            renderSeasonTabs();
        }

        // 删除季节（内联方式）
        function removeSeasonInline(seasonId) {
            if (seasonConfigs.length <= 1) {
                showToast('至少保留一个季节', 'error');
                return;
            }

            seasonConfigs = seasonConfigs.filter(s => s.id !== seasonId);

            if (currentSeasonId === seasonId) {
                currentSeasonId = seasonConfigs[0].id;
            }

            renderSeasonConfigList();
            renderSeasonTabs();
            loadSeasonTiers(currentSeasonId);
        }

        // 渲染季节标签页
        function renderSeasonTabs() {
            const container = document.getElementById('seasonTabsList');
            container.innerHTML = '';

            seasonConfigs.forEach((season, index) => {
                const monthsText = formatMonthsRange(season.months);
                const isActive = season.id === currentSeasonId;

                const tab = document.createElement('button');
                tab.type = 'button';
                tab.className = 'season-tab' + (isActive ? ' active' : '');
                tab.setAttribute('data-season-id', season.id);
                tab.onclick = () => switchSeason(season.id);
                tab.style.cssText = `padding: 6px 16px; font-size: 13px; border: none; background: none; cursor: pointer; transition: all 0.2s; white-space: nowrap; ${isActive ? 'color: #3b82f6; border-bottom: 2px solid #3b82f6; margin-bottom: -10px;' : 'color: #6b7280;'}`;
                tab.innerHTML = `${getTemplateI18nText(season.name)} (${monthsText})`;

                container.appendChild(tab);
            });
        }

        // 格式化单个月份显示
        function formatMonth(month) {
            const lang = localStorage.getItem('language') || 'zh';
            return lang === 'zh' ? `${month}月` : `${month}`;
        }

        // 格式化月份列表显示 (用于简单列表,如 "6月、7月、8月" 或 "6, 7, 8")
        function formatMonthsList(months) {
            if (!months || months.length === 0) return '';
            const lang = localStorage.getItem('language') || 'zh';
            const separator = lang === 'zh' ? '、' : ', ';
            return months.map(m => formatMonth(m)).join(separator);
        }

        // 格式化月份范围显示 (用于连续范围,如 "6-8月" 或 "6-8")
        function formatMonthsRange(months) {
            if (!months || months.length === 0) return '';
            const sorted = [...months].sort((a, b) => a - b);
            const lang = localStorage.getItem('language') || 'zh';

            // 检查是否连续
            let ranges = [];
            let start = sorted[0];
            let end = sorted[0];

            for (let i = 1; i < sorted.length; i++) {
                if (sorted[i] === end + 1 || (end === 12 && sorted[i] === 1)) {
                    end = sorted[i];
                } else {
                    if (lang === 'zh') {
                        ranges.push(start === end ? `${start}月` : `${start}-${end}月`);
                    } else {
                        ranges.push(start === end ? `${start}` : `${start}-${end}`);
                    }
                    start = sorted[i];
                    end = sorted[i];
                }
            }
            if (lang === 'zh') {
                ranges.push(start === end ? `${start}月` : `${start}-${end}月`);
            } else {
                ranges.push(start === end ? `${start}` : `${start}-${end}`);
            }

            return ranges.join(', ');
        }

        // 切换季节标签
        function switchSeason(seasonId) {
            // 保存当前季节的配置
            saveCurrentTiers();

            currentSeasonId = seasonId;

            // 更新标签样式
            renderSeasonTabs();

            // 加载该季节的阶梯配置
            loadSeasonTiers(seasonId);
        }

        // 保存当前显示的阶梯配置到数据中
        function saveCurrentTiers() {
            const container = document.getElementById('tiersContainer');
            const tiers = [];

            Array.from(container.children).forEach(tierDiv => {
                const startInput = tierDiv.querySelector('.tier-start');
                const endInput = tierDiv.querySelector('.tier-end');

                if (startInput && endInput) {
                    tiers.push({
                        start: parseFloat(startInput.value) || 0,
                        end: endInput.value ? parseFloat(endInput.value) : null
                    });
                }
            });

            if (currentPeriodMode === 'fixed') {
                fixedTiers = tiers;
            } else if (currentPeriodMode === 'monthly') {
                monthlyTiers[currentMonth] = tiers;
            } else if (currentPeriodMode === 'seasonal') {
                const season = seasonConfigs.find(s => s.id === currentSeasonId);
                if (season) {
                    season.tiers = tiers;
                }
            }
        }

        // 加载固定阶梯配置
        function loadFixedTiers() {
            const container = document.getElementById('tiersContainer');
            container.innerHTML = '';
            tierCounter = 0;

            if (fixedTiers.length === 0) {
                // 默认配置
                addTierWithValue(200);
                addTierWithValue(400);
                addTierWithValue(null);
            } else {
                fixedTiers.forEach(tier => {
                    addTierWithValue(tier.end);
                });
            }
        }

        // 加载逐月阶梯配置
        function loadMonthlyTiers(month) {
            const container = document.getElementById('tiersContainer');
            container.innerHTML = '';
            tierCounter = 0;

            const tiers = monthlyTiers[month] || [];

            if (tiers.length === 0) {
                // 默认配置
                addTierWithValue(200);
                addTierWithValue(400);
                addTierWithValue(null);
            } else {
                tiers.forEach(tier => {
                    addTierWithValue(tier.end);
                });
            }
        }


        // 从数据中加载指定季节的阶梯配置
        function loadSeasonTiers(seasonId) {
            const container = document.getElementById('tiersContainer');
            container.innerHTML = '';
            tierCounter = 0;

            const season = seasonConfigs.find(s => s.id === seasonId);
            if (!season) return;

            if (season.tiers.length === 0) {
                // 根据季节名称使用不同默认值
                if (season.name.includes('夏')) {
                    // 夏季默认：0-260, 261-600, 601以上
                    addTierWithValue(260);
                    addTierWithValue(600);
                    addTierWithValue(null);
                } else {
                    // 其他季节默认：0-200, 201-400, 401以上
                    addTierWithValue(200);
                    addTierWithValue(400);
                    addTierWithValue(null);
                }
            } else {
                season.tiers.forEach(tier => {
                    addTierWithValue(tier.end);
                });
            }
        }

        // ==================== 阶梯管理函数（续） ====================

        // 添加阶梯（带指定值）
        function addTierWithValue(limitValue) {
            const container = document.getElementById('tiersContainer');

            tierCounter++;
            const tierId = `tier-item-${tierCounter}`;
            const tierNumber = container.children.length + 1;

            const tierDiv = document.createElement('div');
            tierDiv.id = tierId;
            tierDiv.className = 'form-group';
            tierDiv.style.cssText = 'margin: 0; padding: 16px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);';

            // 获取翻译文本
            const tierTitleTemplate = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTierTitle') : '第{n}阶梯';
            const tierTitle = tierTitleTemplate.replace('{n}', tierNumber);

            const tierDeleteTitle = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTierDeleteTitle') : '删除此阶梯';

            const tierUpperLimit = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTierUpperLimit') : '上限值（度/月）';

            const tierPlaceholder = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTierPlaceholder') : '请输入上限值';

            tierDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label class="form-label" style="margin: 0; font-size: 15px; font-weight: 600; color: #1f2937;">${tierTitle}</label>
                    <button type="button" onclick="removeTier('${tierId}')" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 6px; border-radius: 4px; font-size: 16px; transition: all 0.2s; line-height: 1;" onmouseover="this.style.background='rgba(239,68,68,0.1)'" onmouseout="this.style.background='none'" title="${tierDeleteTitle}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; font-size: 12px; color: #6b7280; margin-bottom: 6px;">
                        <i class="fas fa-arrow-up" style="margin-right: 4px;"></i>${tierUpperLimit}
                    </label>
                    <input type="number" class="form-input tier-limit" step="1" min="0" value="${limitValue !== null ? limitValue : ''}" placeholder="${tierPlaceholder}" style="width: 100%; height: 40px; text-align: center; font-size: 16px; font-weight: 500; border: 2px solid #e2e8f0; border-radius: 6px; transition: all 0.2s;" onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)'" onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none'">
                </div>
                <input type="hidden" class="tier-start">
                <input type="hidden" class="tier-end">
                <div style="padding-top: 4px;">
                    <small style="color: #6b7280; font-size: 13px; display: block;" class="tier-range-text"></small>
                </div>
            `;

            container.appendChild(tierDiv);

            // 添加输入监听，当值改变时更新所有阶梯的区间
            const limitInput = tierDiv.querySelector('.tier-limit');
            limitInput.addEventListener('input', updateAllTierRanges);

            // 初始化显示
            updateAllTierRanges();
        }

        // 更新所有阶梯的区间显示
        function updateAllTierRanges() {
            const container = document.getElementById('tiersContainer');
            const tiers = Array.from(container.children);

            tiers.forEach((tierDiv, index) => {
                const limitInput = tierDiv.querySelector('.tier-limit');
                const rangeText = tierDiv.querySelector('.tier-range-text');
                const startHidden = tierDiv.querySelector('.tier-start');
                const endHidden = tierDiv.querySelector('.tier-end');

                let start, end;

                if (index === 0) {
                    // 第一个阶梯从 0 开始
                    start = 0;
                    end = limitInput.value ? parseInt(limitInput.value) : null;
                } else {
                    // 后续阶梯从前一个阶梯的结束值 + 1 开始
                    const prevTier = tiers[index - 1];
                    const prevLimit = prevTier.querySelector('.tier-limit');
                    const prevEnd = prevLimit.value ? parseInt(prevLimit.value) : null;

                    start = prevEnd !== null ? prevEnd + 1 : null;
                    end = limitInput.value ? parseInt(limitInput.value) : null;
                }

                // 更新隐藏字段
                startHidden.value = start !== null ? start : '';
                endHidden.value = end !== null ? end : '';

                // 更新显示文本
                if (end !== null) {
                    const rangeTemplate = typeof getTranslation === 'function' ?
                        getTranslation('elecPriceTierRange') : '{from}-{to}度/月';
                    rangeText.textContent = rangeTemplate.replace('{from}', start).replace('{to}', end);
                } else {
                    const rangeAboveTemplate = typeof getTranslation === 'function' ?
                        getTranslation('elecPriceTierRangeAbove') : '{from}度以上/月';
                    rangeText.textContent = start !== null ? rangeAboveTemplate.replace('{from}', start) : '请设置上一阶梯';
                }
            });

            // 更新阶梯预览
            updateTierVisualization();
        }

        // 更新阶梯预览可视化
        function updateTierVisualization() {
            const tierBar = document.getElementById('tierBar');
            const tierStats = document.getElementById('tierStats');
            const tierWarnings = document.getElementById('tierWarnings');

            if (!tierBar) return;

            const container = document.getElementById('tiersContainer');
            const tiers = Array.from(container.children);

            tierBar.innerHTML = '';
            tierWarnings.innerHTML = '';

            if (tiers.length === 0) {
                const notConfigured = typeof getTranslation === 'function' ?
                    getTranslation('elecPricePeriodNotConfigured') : '未配置';
                const addAtLeastOneTier = typeof getTranslation === 'function' ?
                    getTranslation('elecPricePeriodAddAtLeastOne').replace('时段', '阶梯') : '请至少添加一个阶梯';

                tierStats.innerHTML = `<span style="color: #ef4444;">${notConfigured}</span>`;
                tierWarnings.innerHTML = `<div style="padding: 6px 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 4px; color: #dc2626; font-size: 12px;"><i class="fas fa-exclamation-circle"></i> ${addAtLeastOneTier}</div>`;
                return;
            }

            // 收集阶梯数据
            const tierData = tiers.map((tierDiv, index) => {
                const limitInput = tierDiv.querySelector('.tier-limit');
                const startHidden = tierDiv.querySelector('.tier-start');
                const endHidden = tierDiv.querySelector('.tier-end');

                return {
                    index: index,
                    start: startHidden.value ? parseInt(startHidden.value) : null,
                    end: endHidden.value ? parseInt(endHidden.value) : null,
                    limit: limitInput.value ? parseInt(limitInput.value) : null
                };
            });

            // 检查是否有未设置的值
            const hasIncomplete = tierData.some(t => t.limit === null);

            // 定义阶梯颜色（从蓝到橙的渐变）
            const tierColors = [
                '#3b82f6', // 蓝色 - 第一阶梯
                '#8b5cf6', // 紫色 - 第二阶梯
                '#f59e0b', // 橙色 - 第三阶梯
                '#ef4444', // 红色 - 第四阶梯
                '#ec4899', // 粉色 - 第五阶梯
                '#14b8a6'  // 青色 - 更多阶梯
            ];

            // 找到最大值用于计算比例
            const maxValue = tierData[tierData.length - 1].end || 1000;
            const hasUnlimited = tierData[tierData.length - 1].end === null;

            // 渲染阶梯块
            tierData.forEach((tier, index) => {
                if (tier.start === null) return;

                const color = tierColors[index % tierColors.length];
                let width;

                if (tier.end === null) {
                    // 最后一个阶梯（无上限）- 占剩余空间的30%或至少15%
                    const usedPercent = tierData.slice(0, -1).reduce((sum, t) => {
                        if (t.end === null) return sum;
                        return sum + ((t.end - t.start) / maxValue * 70);
                    }, 0);
                    width = Math.max(30, 100 - usedPercent);
                } else {
                    // 有上限的阶梯 - 按比例分配70%的空间
                    width = ((tier.end - tier.start) / maxValue * 70);
                }

                const block = document.createElement('div');
                block.style.cssText = `
                    flex: 0 0 ${width}%;
                    height: 100%;
                    background: ${color};
                    border-right: 1px solid #ffffff;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #ffffff;
                    font-size: 9px;
                    font-weight: 500;
                    overflow: hidden;
                    transition: opacity 0.2s;
                    position: relative;
                `;

                // 显示阶梯编号
                if (width > 8) {
                    block.textContent = `T${index + 1}`;
                }

                // 提示信息
                const tierTitleTemplate = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceTierTitle') : '第{n}阶梯';
                let tooltipText = tierTitleTemplate.replace('{n}', index + 1) + ': ';

                if (tier.end === null) {
                    const rangeAboveTemplate = typeof getTranslation === 'function' ?
                        getTranslation('elecPriceTierRangeAbove') : '{from}度以上/月';
                    tooltipText += rangeAboveTemplate.replace('{from}', tier.start).replace('/月', '');
                } else {
                    const rangeTemplate = typeof getTranslation === 'function' ?
                        getTranslation('elecPriceTierRange') : '{from}-{to}度/月';
                    tooltipText += rangeTemplate.replace('{from}', tier.start).replace('{to}', tier.end).replace('/月', '');
                }
                block.title = tooltipText;

                // 悬停效果
                block.onmouseenter = () => { block.style.opacity = '0.8'; };
                block.onmouseleave = () => { block.style.opacity = '1'; };

                tierBar.appendChild(block);
            });

            // 显示统计信息
            const tierTotalTemplate = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTierTotal') : '共{count}个阶梯';
            const tierTotalText = tierTotalTemplate.replace('{count}', tiers.length);
            tierStats.innerHTML = `<span style="color: #3b82f6;">${tierTotalText}</span>`;

            // 显示警告信息
            if (hasIncomplete) {
                const fillAllLimitsText = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceTierFillAllLimits') : '请先填写所有阶梯上限值';

                tierWarnings.innerHTML = `
                    <div style="padding: 6px 10px; background: #fffbeb; border: 1px solid #fde68a; border-radius: 4px; color: #d97706; font-size: 12px;">
                        <i class="fas fa-exclamation-triangle"></i> ${fillAllLimitsText.replace('先填写', '完善')}
                    </div>
                `;
            } else {
                tierWarnings.innerHTML = `
                    <div style="padding: 6px 10px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 4px; color: #16a34a; font-size: 12px;">
                        <i class="fas fa-check-circle"></i> 阶梯配置完整
                    </div>
                `;
            }
        }

        // 添加用电量阶梯（根据当前模式使用不同的默认值）
        function addTier() {
            const container = document.getElementById('tiersContainer');
            const tierNumber = container.children.length + 1;

            // 根据当前模式和阶梯数量确定默认值
            let defaultLimit = null;

            if (currentPeriodMode === 'seasonal' && currentSeasonId) {
                // 分季节模式：根据季节名称推断默认值
                const season = seasonConfigs.find(s => s.id === currentSeasonId);
                if (season && season.name.includes('夏')) {
                    // 夏季
                    if (tierNumber === 1) defaultLimit = 260;
                    else if (tierNumber === 2) defaultLimit = 600;
                } else {
                    // 其他季节
                    if (tierNumber === 1) defaultLimit = 200;
                    else if (tierNumber === 2) defaultLimit = 400;
                }
            } else {
                // 全年通用模式
                if (tierNumber === 1) defaultLimit = 200;
                else if (tierNumber === 2) defaultLimit = 400;
            }

            addTierWithValue(defaultLimit);
        }

        // 删除阶梯
        function removeTier(tierId) {
            const container = document.getElementById('tiersContainer');

            // 至少保留一个阶梯
            if (container.children.length <= 1) {
                showToast('至少需要保留一个阶梯', 'error');
                return;
            }

            document.getElementById(tierId).remove();

            // 重新编号阶梯
            Array.from(container.children).forEach((tier, index) => {
                const label = tier.querySelector('label');
                if (label) {
                    label.textContent = `第${index + 1}阶梯`;
                }
            });

            // 恢复网格布局
            if (container.children.length <= 3) {
                container.style.gridTemplateColumns = 'repeat(3, 1fr)';
            }

            // 重新计算所有阶梯的区间
            updateAllTierRanges();
        }



        // 重置为默认三个阶梯
        function resetTiers(showMessage = true) {
            const container = document.getElementById('tiersContainer');
            container.innerHTML = '';
            tierCounter = 0;

            // 添加默认的三个阶梯（已内置默认范围和提示）
            addTier(); // 第一阶梯：0-200度/月
            addTier(); // 第二阶梯：201-400度/月
            addTier(); // 第三阶梯：400度以上/月

            if (showMessage) {
                showToast('已重置为默认三阶梯', 'success');
            }
        }

        function saveTemplate() {
            const nameInput = document.getElementById('templateName');
            const descInput = document.getElementById('templateDesc');

            // 如果是预设模板,使用原始键;否则使用输入的文本
            const name = nameInput.getAttribute('data-original-key') || nameInput.value;
            const desc = descInput.getAttribute('data-original-key') || descInput.value;

            const type = document.getElementById('templateType').value;
            const purpose = document.getElementById('templatePurpose').value;

            if (!name || !type || !purpose) {
                showToast('请填写完整信息', 'error');
                return;
            }

            const typeNames = {
                'peak-valley': '峰谷平尖',
                'tou': '分时电价',
                'tiered': '阶梯电价',
                'fixed': '固定电价'
            };

            const purposeNames = {
                'consumption': '用电电价',
                'feed-in': '上网电价'
            };

            let periods = [];
            let tiers = [];

            // 根据类型提取不同的数据
            if (type === 'tiered') {
                // 保存当前显示的阶梯配置
                saveCurrentTiers();

                // 阶梯电价：根据模式提取数据
                if (currentPeriodMode === 'fixed') {
                    // 固定模式：全年使用同一套阶梯
                    tiers = {
                        mode: 'fixed',
                        data: fixedTiers
                    };

                    if (!fixedTiers || fixedTiers.length === 0) {
                        showToast('请至少添加一个阶梯', 'error');
                        return;
                    }
                } else if (currentPeriodMode === 'monthly') {
                    // 逐月模式：12个月分别设置阶梯
                    tiers = {
                        mode: 'monthly',
                        data: monthlyTiers
                    };

                    // 验证每个月都有阶梯配置
                    for (let month = 1; month <= 12; month++) {
                        if (!monthlyTiers[month] || monthlyTiers[month].length === 0) {
                            const monthNames = ['', '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                            showToast(`请为${monthNames[month]}设置至少一个阶梯`, 'error');
                            return;
                        }
                    }
                } else if (currentPeriodMode === 'seasonal') {
                    // 分季节模式：保存季节配置和每个季节的阶梯
                    tiers = {
                        mode: 'seasonal',
                        seasons: seasonConfigs.map(season => ({
                            id: season.id,
                            name: season.name,
                            months: season.months,
                            tiers: season.tiers
                        }))
                    };

                    // 验证每个季节都有阶梯配置
                    for (const season of tiers.seasons) {
                        if (!season.tiers || season.tiers.length === 0) {
                            showToast(`请为"${season.name}"设置至少一个阶梯`, 'error');
                            return;
                        }
                    }
                }
            } else if (type !== 'fixed') {
                // 分时电价/峰谷电价：保存当前时段配置并根据策略模式提取数据
                saveCurrentPeriods();

                if (currentPeriodStrategyMode === 'fixed') {
                    // 固定模式：全年使用同一套时段配置
                    periods = {
                        mode: 'fixed',
                        data: fixedPeriods
                    };

                    if (!fixedPeriods || fixedPeriods.length === 0) {
                        showToast('请至少添加一个时段', 'error');
                        return;
                    }
                } else if (currentPeriodStrategyMode === 'monthly') {
                    // 逐月模式：12个月分别设置时段
                    periods = {
                        mode: 'monthly',
                        data: monthlyPeriods
                    };

                    // 验证每个月都有时段配置
                    for (let month = 1; month <= 12; month++) {
                        if (!monthlyPeriods[month] || monthlyPeriods[month].length === 0) {
                            const monthNames = ['', '一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                            showToast(`请为${monthNames[month]}设置至少一个时段`, 'error');
                            return;
                        }
                    }
                } else if (currentPeriodStrategyMode === 'seasonal') {
                    // 分季节模式：保存季节配置和每个季节的时段
                    periods = {
                        mode: 'seasonal',
                        seasons: periodSeasonConfigs.map(season => ({
                            id: season.id,
                            name: season.name,
                            months: season.months,
                            periods: season.periods
                        }))
                    };

                    // 验证每个季节都有时段配置
                    for (const season of periods.seasons) {
                        if (!season.periods || season.periods.length === 0) {
                            showToast(`请为"${season.name}"设置至少一个时段`, 'error');
                            return;
                        }
                    }
                }
            } else if (type === 'fixed') {
                // 固定电价：只保存策略模式选择，不保存具体电价值
                if (currentFixedPriceStrategyMode === 'fixed') {
                    // 固定模式：全年使用同一策略
                    periods = {
                        mode: 'fixed'
                    };
                } else if (currentFixedPriceStrategyMode === 'monthly') {
                    // 逐月模式：12个月分别策略
                    periods = {
                        mode: 'monthly'
                    };
                } else if (currentFixedPriceStrategyMode === 'seasonal') {
                    // 分季节模式：只保存季节配置和月份分配
                    periods = {
                        mode: 'seasonal',
                        seasons: fixedPriceSeasonConfigs.map(season => ({
                            id: season.id,
                            name: season.name,
                            months: season.months
                        }))
                    };

                    // 验证季节配置的完整性
                    if (fixedPriceSeasonConfigs.length === 0) {
                        showToast('请至少添加一个季节', 'error');
                        return;
                    }

                    for (const season of fixedPriceSeasonConfigs) {
                        if (!season.months || season.months.length === 0) {
                            showToast(`请为"${season.name}"选择至少一个月份`, 'error');
                            return;
                        }
                    }
                }
            }

            if (editingTemplateId) {
                // 编辑模式
                const index = templates.findIndex(t => t.id === editingTemplateId);
                if (index >= 0) {
                    const updatedTemplate = {
                        ...templates[index],
                        name,
                        type,
                        typeName: typeNames[type],
                        purpose,
                        purposeName: purposeNames[purpose],
                        description: desc
                    };

                    // 根据类型保存不同的数据
                    if (type === 'tiered') {
                        updatedTemplate.tiers = tiers;
                        updatedTemplate.periods = []; // 清空periods
                    } else if (type === 'fixed') {
                        updatedTemplate.periods = periods;
                        updatedTemplate.tiers = []; // 清空tiers
                    } else {
                        // 分时电价：同时保存periods和时段类型配置
                        updatedTemplate.periods = periods;
                        updatedTemplate.tiers = []; // 清空tiers
                        updatedTemplate.periodTypeConfigs = periodTypeConfigs; // 保存时段类型配置
                    }

                    templates[index] = updatedTemplate;
                    showToast('模版更新成功', 'success');
                }
                editingTemplateId = null;
            } else {
                // 新建模式
                const template = {
                    id: Date.now(),
                    name,
                    type,
                    typeName: typeNames[type],
                    purpose,
                    purposeName: purposeNames[purpose],
                    description: desc,
                    createTime: new Date().toLocaleString('zh-CN', { hour12: false })
                };

                // 根据类型保存不同的数据
                if (type === 'tiered') {
                    template.tiers = tiers;
                    template.periods = [];
                } else if (type === 'fixed') {
                    template.periods = periods;
                    template.tiers = [];
                } else {
                    // 分时电价：同时保存periods和时段类型配置
                    template.periods = periods;
                    template.tiers = [];
                    template.periodTypeConfigs = periodTypeConfigs; // 保存时段类型配置
                }

                templates.unshift(template);
                showToast('模版创建成功', 'success');
            }

            renderTemplates();
            closeCustomTemplateModal();
        }

        let editingTemplateId = null;

        function editTemplate(id) {
            editingTemplateId = id;
            const template = templates.find(t => t.id === id);
            if (!template) return;

            // 使用翻译后的标题
            const editTitleText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceModalTitleEditTemplate') : '编辑电价模版';
            document.getElementById('customModalTitle').textContent = editTitleText;

            // 判断是否为预设模板(有国际化翻译的模板)
            const isPresetTemplate = templateI18n[template.name] !== undefined;

            if (isPresetTemplate) {
                // 预设模板:显示翻译后的文本,但保存时使用原始键
                document.getElementById('templateName').value = getTemplateI18nText(template.name);
                document.getElementById('templateDesc').value = getTemplateI18nText(template.description) || '';

                // 存储原始键,用于保存时恢复
                document.getElementById('templateName').setAttribute('data-original-key', template.name);
                document.getElementById('templateDesc').setAttribute('data-original-key', template.description || '');
            } else {
                // 用户自定义模板:直接显示原始文本
                document.getElementById('templateName').value = template.name;
                document.getElementById('templateDesc').value = template.description || '';

                // 清除原始键属性
                document.getElementById('templateName').removeAttribute('data-original-key');
                document.getElementById('templateDesc').removeAttribute('data-original-key');
            }

            // 加载模版用途并更新UI
            if (template.purpose) {
                selectPurpose(template.purpose);
                // 设置类型
                document.getElementById('templateType').value = template.type;
            } else {
                // 兼容旧数据：没有purpose字段，默认设置为用电电价
                selectPurpose('consumption');
                document.getElementById('templateType').value = template.type;
            }

            const periodsSection = document.getElementById('periodsSection');
            const periodsContainer = document.getElementById('periodsContainer');
            const tiersSection = document.getElementById('tiersSection');
            const tiersContainer = document.getElementById('tiersContainer');

            // 清空所有配置
            periodsContainer.innerHTML = '';
            tiersContainer.innerHTML = '';
            periodsSection.style.display = 'none';
            tiersSection.style.display = 'none';

            // 根据类型加载不同的数据
            if (template.type === 'tiered' && template.tiers) {
                // 阶梯电价：加载阶梯数据
                tiersSection.style.display = 'block';

                const mode = template.tiers.mode;

                if (mode === 'fixed') {
                    // 固定模式
                    currentPeriodMode = 'fixed';
                    fixedTiers = template.tiers.data || [];
                    monthlyTiers = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                    seasonConfigs = [
                        { id: 'season-1', name: '夏季', months: [5,6,7,8,9,10], tiers: [] },
                        { id: 'season-2', name: '非夏季', months: [11,12,1,2,3,4], tiers: [] }
                    ];

                    // 设置单选按钮为 fixed
                    document.querySelector('input[name="tierPeriodMode"][value="fixed"]').checked = true;
                    switchPeriodMode('fixed');

                } else if (mode === 'monthly') {
                    // 逐月模式
                    currentPeriodMode = 'monthly';
                    monthlyTiers = template.tiers.data || { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                    fixedTiers = [];
                    seasonConfigs = [
                        { id: 'season-1', name: '夏季', months: [5,6,7,8,9,10], tiers: [] },
                        { id: 'season-2', name: '非夏季', months: [11,12,1,2,3,4], tiers: [] }
                    ];

                    // 设置单选按钮为 monthly
                    document.querySelector('input[name="tierPeriodMode"][value="monthly"]').checked = true;
                    currentMonth = 1;
                    switchPeriodMode('monthly');

                } else if (mode === 'seasonal') {
                    // 分季节模式
                    currentPeriodMode = 'seasonal';

                    // 加载季节配置
                    if (template.tiers.seasons) {
                        seasonConfigs = template.tiers.seasons.map(s => ({
                            ...s,
                            tiers: s.tiers || []
                        }));
                    } else {
                        // 旧格式兼容
                        seasonConfigs = [
                            {
                                id: 'season-1',
                                name: '夏季',
                                months: [5, 6, 7, 8, 9, 10],
                                tiers: template.tiers.summer || []
                            },
                            {
                                id: 'season-2',
                                name: '非夏季',
                                months: [11, 12, 1, 2, 3, 4],
                                tiers: template.tiers['non-summer'] || []
                            }
                        ];
                    }

                    fixedTiers = [];
                    monthlyTiers = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };

                    // 设置单选按钮为 seasonal
                    document.querySelector('input[name="tierPeriodMode"][value="seasonal"]').checked = true;
                    switchPeriodMode('seasonal');

                } else if (Array.isArray(template.tiers)) {
                    // 兼容旧版本：无 mode 字段，默认为固定模式
                    currentPeriodMode = 'fixed';
                    fixedTiers = template.tiers;
                    monthlyTiers = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                    seasonConfigs = [
                        { id: 'season-1', name: '夏季', months: [5,6,7,8,9,10], tiers: [] },
                        { id: 'season-2', name: '非夏季', months: [11,12,1,2,3,4], tiers: [] }
                    ];

                    // 设置单选按钮为 fixed
                    document.querySelector('input[name="tierPeriodMode"][value="fixed"]').checked = true;
                    switchPeriodMode('fixed');
                }
            } else if (template.type !== 'fixed' && template.periods) {
                // 分时电价/峰谷电价：加载时段数据
                periodsSection.style.display = 'block';

                // 加载时段类型配置
                if (template.periodTypeConfigs && Array.isArray(template.periodTypeConfigs)) {
                    periodTypeConfigs = template.periodTypeConfigs;
                    // 更新计数器，确保新添加的ID不会冲突
                    const maxId = Math.max(...periodTypeConfigs.map(c => {
                        const match = c.id.match(/\d+$/);
                        return match ? parseInt(match[0]) : 0;
                    }), 4);
                    periodTypeCounter = maxId;
                } else {
                    // 如果没有保存的配置，使用默认配置
                    periodTypeConfigs = [
                        { id: 'super-peak', name: '尖时段', color: '#ef4444', bgColor: 'rgba(239, 68, 68, 0.15)' },
                        { id: 'peak', name: '峰时段', color: '#eab308', bgColor: 'rgba(234, 179, 8, 0.15)' },
                        { id: 'flat', name: '平时段', color: '#3b82f6', bgColor: 'rgba(59, 130, 246, 0.15)' },
                        { id: 'valley', name: '谷时段', color: '#22c55e', bgColor: 'rgba(34, 197, 94, 0.15)' }
                    ];
                    periodTypeCounter = 4;
                }

                // 渲染时段类型按钮
                renderPeriodTypeButtons();

                // 检查是否有策略模式信息
                if (template.periods.mode) {
                    const mode = template.periods.mode;

                    if (mode === 'fixed') {
                        // 固定模式
                        currentPeriodStrategyMode = 'fixed';
                        fixedPeriods = template.periods.data || [];
                        monthlyPeriods = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                        periodSeasonConfigs = [
                            { id: 'period-season-1', name: '夏季', months: [6, 7, 8, 9], periods: [] }
                        ];

                        // 设置单选按钮为 fixed
                        document.querySelector('input[name="periodStrategyMode"][value="fixed"]').checked = true;
                        switchPeriodStrategyMode('fixed');

                    } else if (mode === 'monthly') {
                        // 逐月模式
                        currentPeriodStrategyMode = 'monthly';
                        monthlyPeriods = template.periods.data || { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                        fixedPeriods = [];
                        periodSeasonConfigs = [
                            { id: 'period-season-1', name: '夏季', months: [6, 7, 8, 9], periods: [] }
                        ];

                        // 设置单选按钮为 monthly
                        document.querySelector('input[name="periodStrategyMode"][value="monthly"]').checked = true;
                        currentPeriodMonth = 1;
                        switchPeriodStrategyMode('monthly');

                    } else if (mode === 'seasonal') {
                        // 分季节模式
                        currentPeriodStrategyMode = 'seasonal';

                        // 加载季节配置
                        if (template.periods.seasons) {
                            periodSeasonConfigs = template.periods.seasons.map(s => ({
                                ...s,
                                periods: s.periods || []
                            }));
                        } else {
                            periodSeasonConfigs = [
                                { id: 'period-season-1', name: '夏季', months: [6, 7, 8, 9], periods: [] }
                            ];
                        }

                        fixedPeriods = [];
                        monthlyPeriods = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };

                        // 设置单选按钮为 seasonal
                        document.querySelector('input[name="periodStrategyMode"][value="seasonal"]').checked = true;
                        switchPeriodStrategyMode('seasonal');
                    }
                } else if (Array.isArray(template.periods) && template.periods.length > 0) {
                    // 兼容旧版本：无 mode 字段，默认为固定模式
                    currentPeriodStrategyMode = 'fixed';

                    // 将旧格式数据转换为新格式
                    fixedPeriods = template.periods.map(p => ({
                        type: p.type,
                        name: p.name,
                        start: p.start,
                        end: p.end,
                        price: p.price || ''
                    }));

                    monthlyPeriods = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: [], 10: [], 11: [], 12: [] };
                    periodSeasonConfigs = [
                        { id: 'period-season-1', name: '夏季', months: [6, 7, 8, 9], periods: [] }
                    ];

                    // 设置单选按钮为 fixed
                    document.querySelector('input[name="periodStrategyMode"][value="fixed"]').checked = true;
                    switchPeriodStrategyMode('fixed');
                }
            } else if (template.type === 'fixed' && template.periods) {
                // 固定电价：加载电价数据
                fixedPriceSection.style.display = 'block';

                // 检查是否有策略模式信息
                if (template.periods.mode) {
                    const mode = template.periods.mode;

                    if (mode === 'fixed') {
                        // 固定模式：只加载策略模式选择
                        currentFixedPriceStrategyMode = 'fixed';
                        fixedPriceSeasonConfigs = [
                            { id: 'fixed-price-season-1', name: '夏季', months: [6, 7, 8, 9] }
                        ];

                        // 设置单选按钮为 fixed
                        document.querySelector('input[name="fixedPriceStrategyMode"][value="fixed"]').checked = true;
                        switchFixedPriceStrategyMode('fixed');

                    } else if (mode === 'monthly') {
                        // 逐月模式：只加载策略模式选择
                        currentFixedPriceStrategyMode = 'monthly';
                        fixedPriceSeasonConfigs = [
                            { id: 'fixed-price-season-1', name: '夏季', months: [6, 7, 8, 9] }
                        ];

                        // 设置单选按钮为 monthly
                        document.querySelector('input[name="fixedPriceStrategyMode"][value="monthly"]').checked = true;
                        currentFixedPriceMonth = 1;
                        switchFixedPriceStrategyMode('monthly');

                    } else if (mode === 'seasonal') {
                        // 分季节模式：只加载季节配置（名称和月份），不加载电价值
                        currentFixedPriceStrategyMode = 'seasonal';

                        // 加载季节配置
                        if (template.periods.seasons) {
                            fixedPriceSeasonConfigs = template.periods.seasons.map(s => ({
                                id: s.id,
                                name: s.name,
                                months: s.months
                            }));
                        } else {
                            fixedPriceSeasonConfigs = [
                                { id: 'fixed-price-season-1', name: '夏季', months: [6, 7, 8, 9] }
                            ];
                        }

                        // 设置单选按钮为 seasonal
                        document.querySelector('input[name="fixedPriceStrategyMode"][value="seasonal"]').checked = true;
                        switchFixedPriceStrategyMode('seasonal');
                    }
                } else if (typeof template.periods === 'number' || typeof template.periods === 'string') {
                    // 兼容旧版本：如果是旧格式，默认设置为固定模式
                    currentFixedPriceStrategyMode = 'fixed';
                    fixedPriceSeasonConfigs = [
                        { id: 'fixed-price-season-1', name: '夏季', months: [6, 7, 8, 9] }
                    ];

                    // 设置单选按钮为 fixed
                    document.querySelector('input[name="fixedPriceStrategyMode"][value="fixed"]').checked = true;
                    switchFixedPriceStrategyMode('fixed');
                }
            }

            document.getElementById('customTemplateModal').classList.add('active');
        }

        function viewTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;

            // 获取翻译文本
            const lang = localStorage.getItem('language') || 'zh';
            const feedinText = lang === 'zh' ? '上网电价' : 'Feed-in Price';
            const consumptionText = lang === 'zh' ? '用电电价' : 'Consumption Price';
            const noDescText = lang === 'zh' ? '暂无说明' : 'No description';
            const tierText = lang === 'zh' ? '阶梯' : 'Tier';
            const priceText = lang === 'zh' ? '电价' : 'Price';
            const currencyUnit = lang === 'zh' ? '元/kWh' : 'CNY/kWh';

            // 翻译策略类型名称 - 使用 getTemplateI18nText 统一处理
            const translatedTypeName = getTemplateI18nText(template.typeName);

            // 获取翻译文本
            const modalTitleText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceModalTitleViewTemplate') : '模版详情';
            const labelNameText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormLabelTemplateName') : '模版名称';
            const labelPurposeText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormLabelTemplatePurpose') : '模版用途';
            const labelTypeText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormLabelTemplateType') : '策略类型';
            const labelDescText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormLabelTemplateDesc') : '模版说明';
            const labelTierConfigText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormSectionTierConfig') : '阶梯配置';
            const labelPeriodConfigText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormSectionPeriodConfig') : '时段配置';
            const labelCreateTimeText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTableHeaderCreateTime') : '创建时间';
            const btnCloseText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceBtnClose') : '关闭';
            const btnEditText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceBtnEditTemplate') : '编辑模版';

            const modalContent = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">${modalTitleText}</h3>
                        <button class="modal-close" onclick="closeViewTemplateModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">${labelNameText}</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem; font-weight: 600;">
                                ${getTemplateI18nText(template.name)}
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${labelPurposeText}</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem;">
                                <span style="display: inline-flex; align-items: center; gap: 6px;">
                                    ${template.purpose === 'feed-in' ?
                                        `<i class="fas fa-upload" style="color: #1890ff;"></i><span style="color: #1890ff;">${feedinText}</span>` :
                                        `<i class="fas fa-download" style="color: #eb2f96;"></i><span style="color: #eb2f96;">${consumptionText}</span>`}
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${labelTypeText}</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem;">
                                <span class="template-type">${translatedTypeName}</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">${labelDescText}</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem;">
                                ${template.description ? getTemplateI18nText(template.description) : noDescText}
                            </div>
                        </div>
                        ${template.type === 'tiered' && template.tiers && template.tiers.length > 0 ? `
                            <div class="form-group">
                                <label class="form-label">${labelTierConfigText}</label>
                                ${template.tiers.map((tier, index) => `
                                    <div class="period-config">
                                        <div class="period-config-header">
                                            <span class="period-name">
                                                <span class="badge badge-primary">${tierText} ${index + 1}</span>
                                            </span>
                                            <span class="period-time">${tier.start}${tier.end !== null ? ' - ' + tier.end : '+'} kWh</span>
                                        </div>
                                        <div style="padding: 0.5rem 0.75rem; background: ${template.purpose === 'feed-in' ? '#e6f4ff' : '#fff0f6'}; border-radius: 0.375rem; margin-top: 0.5rem; border: 1px solid ${template.purpose === 'feed-in' ? '#91d5ff' : '#ffadd2'};">
                                            <div style="font-size: 0.75rem; color: ${template.purpose === 'feed-in' ? '#1890ff' : '#eb2f96'}; margin-bottom: 2px;">
                                                <i class="fas fa-${template.purpose === 'feed-in' ? 'upload' : 'download'}"></i> ${priceText}
                                            </div>
                                            <div style="font-size: 0.875rem; font-weight: 600; color: ${template.purpose === 'feed-in' ? '#1890ff' : '#eb2f96'};">
                                                ${tier.price || 0} ${currencyUnit}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${template.periods && template.periods.length > 0 ? `
                            <div class="form-group">
                                <label class="form-label">${labelPeriodConfigText}</label>
                                ${template.periods.map(p => `
                                    <div class="period-config">
                                        <div class="period-config-header">
                                            <span class="period-name">
                                                <span class="period-tag ${p.type}">${getTemplateI18nText(p.name)}</span>
                                            </span>
                                            <span class="period-time">${p.start} - ${p.end}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="form-group">
                            <label class="form-label">${labelCreateTimeText}</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem; color: var(--gray-600);">
                                <i class="fas fa-clock"></i> ${template.createTime}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeViewTemplateModal()">${btnCloseText}</button>
                        <button class="btn btn-primary" onclick="closeViewTemplateModal(); editTemplate(${template.id})">
                            <i class="fas fa-edit"></i> ${btnEditText}
                        </button>
                    </div>
                </div>
            `;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'viewTemplateModal';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }

        function closeViewTemplateModal() {
            const modal = document.getElementById('viewTemplateModal');
            if (modal) modal.remove();
        }

        function deleteTemplate(id) {
            const confirmTitle = typeof getTranslation === 'function' ?
                getTranslation('elecPriceConfirmDeleteTitle') : '确认删除';
            const confirmText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceConfirmDeleteTemplate') : '确定要删除此模版吗？';
            const confirmBtn = typeof getTranslation === 'function' ?
                getTranslation('elecPriceBtnConfirm') : '确定';
            const cancelBtn = typeof getTranslation === 'function' ?
                getTranslation('elecPriceBtnCancel') : '取消';

            showConfirmDialog(confirmTitle, confirmText, confirmBtn, cancelBtn, () => {
                const successText = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceToastDeleteSuccess') : '删除成功';
                templates = templates.filter(t => t.id !== id);
                renderTemplates();
                showToast(successText, 'success');
            });
        }

        // 显示自定义确认对话框
        function showConfirmDialog(title, message, confirmText, cancelText, onConfirm) {
            // 移除已存在的确认对话框
            const existingDialog = document.getElementById('customConfirmDialog');
            if (existingDialog) existingDialog.remove();

            // 创建对话框
            const dialog = document.createElement('div');
            dialog.id = 'customConfirmDialog';
            dialog.className = 'modal';
            dialog.style.display = 'flex';
            dialog.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3 class="modal-title">${title}</h3>
                        <button class="modal-close" onclick="closeConfirmDialog()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 24px;">
                        <p style="color: #374151; font-size: 14px; line-height: 1.6; margin: 0;">
                            ${message}
                        </p>
                    </div>
                    <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px;">
                        <button class="btn btn-secondary" onclick="closeConfirmDialog()">${cancelText}</button>
                        <button class="btn btn-primary" onclick="confirmDialogAction()">${confirmText}</button>
                    </div>
                </div>
            `;

            document.body.appendChild(dialog);

            // 保存确认回调
            window._confirmDialogCallback = onConfirm;

            // 点击背景关闭
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    closeConfirmDialog();
                }
            });
        }

        // 关闭确认对话框
        function closeConfirmDialog() {
            const dialog = document.getElementById('customConfirmDialog');
            if (dialog) dialog.remove();
            window._confirmDialogCallback = null;
        }

        // 执行确认操作
        function confirmDialogAction() {
            if (window._confirmDialogCallback) {
                window._confirmDialogCallback();
            }
            closeConfirmDialog();
        }

        // ==================== 电站配置 ====================

        function renderSites() {
            const list = document.getElementById('siteList');

            // 获取翻译文本
            const unitText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceUnitDeviceCount') : '台';
            const notConfiguredText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceStatusNotConfigured') : '未配置';
            const configBtnText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceBtnConfig') : '配置';
            const siteNameHeader = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTableHeaderSiteName') : '站点名称';
            const deviceCountHeader = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTableHeaderDeviceCount') : '设备数量';
            const consumptionHeader = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTableHeaderConsumptionTemplate') : '购电模版';
            const feedinHeader = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTableHeaderFeedinTemplate') : '上网模版';
            const effectiveTimeHeader = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTableHeaderEffectiveTime') : '生效时间';
            const actionsHeader = typeof getTranslation === 'function' ?
                getTranslation('elecPriceTableHeaderActions') : '操作';

            if (sites.length === 0) {
                const emptyText = typeof getTranslation === 'function' ?
                    getTranslation('elecPriceEmptyStateSites') : '暂无电站';

                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fas fa-building"></i></div>
                        <h3 class="empty-state-title">${emptyText}</h3>
                    </div>
                `;
                return;
            }

            const tableRows = sites.map(site => {
                const config = siteConfigs.find(c => c.siteId === site.id);
                const consumptionTemplate = config && config.consumptionTemplateId
                    ? templates.find(t => t.id === config.consumptionTemplateId)
                    : null;
                const feedinTemplate = config && config.feedinTemplateId
                    ? templates.find(t => t.id === config.feedinTemplateId)
                    : null;

                // 获取站点名称(根据当前语言)
                const siteName = (typeof currentLang !== 'undefined' && currentLang === 'en' && site.nameEn)
                    ? site.nameEn
                    : site.name;

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-building" style="color: #3b82f6; margin-right: 8px;"></i>
                                ${siteName}
                            </div>
                        </td>
                        <td>
                            <span style="font-weight: 500;">${site.deviceCount}</span> ${unitText}
                        </td>
                        <td>
                            <div class="template-cell">
                                ${consumptionTemplate
                                    ? `
                                        <i class="fas fa-check-circle check-icon"></i>
                                        <span style="color: #10b981; font-weight: 500;">${consumptionTemplate.name}</span>
                                    `
                                    : `
                                        <i class="far fa-circle uncheck-icon"></i>
                                        <span style="color: #94a3b8;">${notConfiguredText}</span>
                                    `
                                }
                            </div>
                        </td>
                        <td>
                            <div class="template-cell">
                                ${feedinTemplate
                                    ? `
                                        <i class="fas fa-check-circle check-icon"></i>
                                        <span style="color: #10b981; font-weight: 500;">${feedinTemplate.name}</span>
                                    `
                                    : `
                                        <i class="far fa-circle uncheck-icon"></i>
                                        <span style="color: #94a3b8;">${notConfiguredText}</span>
                                    `
                                }
                            </div>
                        </td>
                        <td>
                            ${config
                                ? `<span style="color: #475569;"><i class="fas fa-calendar-check" style="color: #3b82f6; margin-right: 6px;"></i>${config.effectiveTime}</span>`
                                : `<span style="color: #cbd5e1;">-</span>`
                            }
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                ${config && (consumptionTemplate || feedinTemplate)
                                    ? `
                                        <button class="btn btn-sm btn-secondary" onclick="viewSiteConfig('${site.id}')" title="查看配置详情">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="configureSite('${site.id}')" title="编辑配置">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    `
                                    : `
                                        <button class="btn btn-sm btn-success" onclick="configureSite('${site.id}')">
                                            <i class="fas fa-cog"></i> ${configBtnText}
                                        </button>
                                    `
                                }
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            list.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><i class="fas fa-building" style="margin-right: 6px;"></i>${siteNameHeader}</th>
                            <th><i class="fas fa-server" style="margin-right: 6px;"></i>${deviceCountHeader}</th>
                            <th><i class="fas fa-download" style="margin-right: 6px;"></i>${consumptionHeader}</th>
                            <th><i class="fas fa-upload" style="margin-right: 6px;"></i>${feedinHeader}</th>
                            <th><i class="fas fa-clock" style="margin-right: 6px;"></i>${effectiveTimeHeader}</th>
                            <th><i class="fas fa-tools" style="margin-right: 6px;"></i>${actionsHeader}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
        }

        function configureSite(siteId) {
            currentSiteId = siteId;
            const site = sites.find(s => s.id === siteId);
            const config = siteConfigs.find(c => c.siteId === siteId);

            const siteConfigTitleText = typeof getTranslation === 'function' ?
                getTranslation('elecPriceModalTitleSiteConfig') : '配置电站电价';
            // 获取站点名称(根据当前语言)
            const siteName = (typeof currentLang !== 'undefined' && currentLang === 'en' && site.nameEn)
                ? site.nameEn
                : site.name;
            document.getElementById('siteConfigTitle').textContent = `${siteConfigTitleText} - ${siteName}`;

            // 填充购电模版选择器
            const consumptionSelect = document.getElementById('consumptionTemplate');
            const consumptionPlaceholder = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormPlaceholderSelectConsumption') : '请选择购电模版';
            consumptionSelect.innerHTML = `<option value="">${consumptionPlaceholder}</option>` +
                templates.filter(t => t.purpose === 'consumption')
                    .map(t => {
                        const translatedName = getTemplateI18nText(t.name);
                        const translatedTypeName = getTemplateI18nText(t.typeName);
                        return `<option value="${t.id}">${translatedName} (${translatedTypeName})</option>`;
                    }).join('');

            // 填充上网模版选择器
            const feedinSelect = document.getElementById('feedinTemplate');
            const feedinPlaceholder = typeof getTranslation === 'function' ?
                getTranslation('elecPriceFormPlaceholderSelectFeedin') : '请选择上网模版';
            feedinSelect.innerHTML = `<option value="">${feedinPlaceholder}</option>` +
                templates.filter(t => t.purpose === 'feed-in')
                    .map(t => {
                        const translatedName = getTemplateI18nText(t.name);
                        const translatedTypeName = getTemplateI18nText(t.typeName);
                        return `<option value="${t.id}">${translatedName} (${translatedTypeName})</option>`;
                    }).join('');

            // 设置默认生效时间
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('effectiveTime').value = config
                ? config.effectiveTime
                : now.toISOString().slice(0, 16);

            // 如果有现有配置，加载它
            if (config) {
                if (config.consumptionTemplateId) {
                    consumptionSelect.value = config.consumptionTemplateId;
                    onConsumptionTemplateSelect();
                    // 加载价格数据
                    loadConsumptionPrices(config.consumptionPrices);
                }
                if (config.feedinTemplateId) {
                    feedinSelect.value = config.feedinTemplateId;
                    onFeedinTemplateSelect();
                    // 加载价格数据
                    loadFeedinPrices(config.feedinPrices);
                }
            } else {
                document.getElementById('consumptionPriceSection').style.display = 'none';
                document.getElementById('feedinPriceSection').style.display = 'none';
            }

            document.getElementById('siteConfigModal').classList.add('active');
        }

        // 生成价格配置HTML的辅助函数
        // 生成价格配置HTML的辅助函数 - 国际化修复版
function generatePriceHTML(template) {
    if (template.type === 'fixed') {
        const fixedPriceLabel = typeof getTranslation === 'function' ? getTranslation('elecPriceFixedPriceLabel') : '固定电价';
        const priceUnit = typeof getTranslation === 'function' ? getTranslation('cabinetChartAxisElectricityPrice') : '电价 (元/kWh)';
        return `
            <div class="price-item" style="background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">${fixedPriceLabel}</div>
                <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                    <div>
                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">${priceUnit}</label>
                        <input type="number" class="form-input price-input" step="0.01" min="0" placeholder="0.00" data-type="fixed" required>
                    </div>
                </div>
            </div>
        `;
    } else if (template.type === 'tiered') {
        // 阶梯电价
        const priceUnit = typeof getTranslation === 'function' ? getTranslation('cabinetChartAxisElectricityPrice') : '电价 (元/kWh)';

        if (template.tiers.mode === 'fixed') {
            // 固定模式：一套阶梯
            return template.tiers.data.map((tier, index) => {
                const tierTitle = typeof getTranslation === 'function'
                    ? getTranslation('elecPriceTierTitle').replace('{n}', index + 1)
                    : `第${index + 1}阶梯`;
                const tierRange = tier.end !== null
                    ? `${tier.start}-${tier.end}${typeof getTranslation === 'function' ? getTranslation('elecPriceUnitDegree') || '度' : '度'}`
                    : (typeof getTranslation === 'function' ? getTranslation('elecPriceTierRangeAbove').replace('{from}', tier.start) : `${tier.start}度以上/月`);
                return `
                <div class="price-item" style="background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                    <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        ${tierTitle} (${tierRange})
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">${priceUnit}</label>
                        <input type="number" class="form-input price-input" step="0.01" min="0" placeholder="0.00" data-mode="fixed" data-tier="${index}" required>
                    </div>
                </div>
            `;
            }).join('');
        } else if (template.tiers.mode === 'seasonal') {
            // 分季节模式：每个季节有自己的阶梯 - Tab导航
            const containerId = `seasonal-container-${Date.now()}`;
            const tabsHtml = template.tiers.seasons.map((season, idx) => `
                <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="season-${season.id}" onclick="switchPriceTab('${containerId}', 'season-${season.id}')">
                    ${getTemplateI18nText(season.name)}
                </button>
            `).join('');

            const contentsHtml = template.tiers.seasons.map((season, idx) => {
                const seasonName = getTemplateI18nText(season.name);
                const monthUnit = typeof getTranslation === 'function' ? getTranslation('elecPriceUnitMonth') || '月' : '月';
                const monthsText = season.months.map(m => m + monthUnit).join('、');

                return `
                <div id="season-${season.id}" class="config-tab-content ${idx === 0 ? 'active' : ''}">
                    <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #3b82f6;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #1e40af; margin: 0 0 12px 0;">
                            ${seasonName} (${monthsText})
                        </h5>
                        ${season.tiers.map((tier, index) => {
                            const tierTitle = typeof getTranslation === 'function'
                                ? getTranslation('elecPriceTierTitle').replace('{n}', index + 1)
                                : `第${index + 1}阶梯`;
                            const tierRange = tier.end !== null
                                ? `${tier.start}-${tier.end}${typeof getTranslation === 'function' ? getTranslation('elecPriceUnitDegree') || '度' : '度'}`
                                : (typeof getTranslation === 'function' ? getTranslation('elecPriceTierRangeAbove').replace('{from}', tier.start) : `${tier.start}度以上/月`);
                            return `
                            <div class="price-item" style="background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                                <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    ${tierTitle} (${tierRange})
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">${priceUnit}</label>
                                    <input type="number" class="form-input price-input" step="0.01" min="0" placeholder="0.00" data-mode="seasonal" data-season="${season.id}" data-tier="${index}" required>
                                </div>
                            </div>
                        `;
                        }).join('')}
                    </div>
                </div>
            `;
            }).join('');

            return `
                <div id="${containerId}">
                    <div class="config-tabs" style="margin-bottom: 16px;">
                        ${tabsHtml}
                    </div>
                    ${contentsHtml}
                </div>
            `;
        } else if (template.tiers.mode === 'monthly') {
            // 逐月模式：每个月有自己的阶梯 - Tab导航
            const months = typeof getTranslation === 'function' ? [
                getTranslation('elecPriceMonthJan'), getTranslation('elecPriceMonthFeb'), getTranslation('elecPriceMonthMar'),
                getTranslation('elecPriceMonthApr'), getTranslation('elecPriceMonthMay'), getTranslation('elecPriceMonthJun'),
                getTranslation('elecPriceMonthJul'), getTranslation('elecPriceMonthAug'), getTranslation('elecPriceMonthSep'),
                getTranslation('elecPriceMonthOct'), getTranslation('elecPriceMonthNov'), getTranslation('elecPriceMonthDec')
            ] : ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const containerId = `monthly-container-${Date.now()}`;

            const tabsHtml = months.map((monthName, idx) => `
                <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="month-${idx + 1}" onclick="switchPriceTab('${containerId}', 'month-${idx + 1}')">
                    ${monthName}
                </button>
            `).join('');

            const contentsHtml = months.map((monthName, monthIndex) => {
                const month = monthIndex + 1;
                const monthTiers = template.tiers.data[month] || [];
                return `
                    <div id="month-${month}" class="config-tab-content ${monthIndex === 0 ? 'active' : ''}">
                        <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #f59e0b;">
                            <h5 style="font-size: 14px; font-weight: 600; color: #92400e; margin: 0 0 12px 0;">
                                ${monthName}
                            </h5>
                            ${monthTiers.map((tier, index) => {
                                const tierTitle = typeof getTranslation === 'function'
                                    ? getTranslation('elecPriceTierTitle').replace('{n}', index + 1)
                                    : `第${index + 1}阶梯`;
                                const tierRange = tier.end !== null
                                    ? `${tier.start}-${tier.end}${typeof getTranslation === 'function' ? getTranslation('elecPriceUnitDegree') || '度' : '度'}`
                                    : (typeof getTranslation === 'function' ? getTranslation('elecPriceTierRangeAbove').replace('{from}', tier.start) : `${tier.start}度以上/月`);
                                return `
                                <div class="price-item" style="background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        ${tierTitle} (${tierRange})
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">${priceUnit}</label>
                                        <input type="number" class="form-input price-input" step="0.01" min="0" placeholder="0.00" data-mode="monthly" data-month="${month}" data-tier="${index}" required>
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div id="${containerId}">
                    <div class="config-tabs" style="margin-bottom: 16px;">
                        ${tabsHtml}
                    </div>
                    ${contentsHtml}
                </div>
            `;
        }
    } else {
        // 分时电价
        const priceUnit = typeof getTranslation === 'function' ? getTranslation('cabinetChartAxisElectricityPrice') : '电价 (元/kWh)';

        if (template.periods.mode === 'fixed') {
            // 固定模式：一套时段
            return template.periods.data.map(p => `
                <div class="price-item" style="background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                    <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                        ${getTemplateI18nText(p.name)} (${p.start} - ${p.end})
                    </div>
                    <div>
                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">${priceUnit}</label>
                        <input type="number" class="form-input price-input" step="0.01" min="0" placeholder="0.00" data-mode="fixed" data-period="${p.type}" required>
                    </div>
                </div>
            `).join('');
        } else if (template.periods.mode === 'seasonal') {
            // 分季节模式：每个季节有自己的时段 - Tab导航
            const containerId = `seasonal-tou-container-${Date.now()}`;
            const tabsHtml = template.periods.seasons.map((season, idx) => `
                <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="tou-season-${season.id}" onclick="switchPriceTab('${containerId}', 'tou-season-${season.id}')">
                    ${getTemplateI18nText(season.name)}
                </button>
            `).join('');

            const contentsHtml = template.periods.seasons.map((season, idx) => {
                const seasonName = getTemplateI18nText(season.name);
                const monthUnit = typeof getTranslation === 'function' ? getTranslation('elecPriceUnitMonth') || '月' : '月';
                const monthsText = season.months.map(m => m + monthUnit).join('、');

                return `
                <div id="tou-season-${season.id}" class="config-tab-content ${idx === 0 ? 'active' : ''}">
                    <div style="background: #f0f9ff; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #3b82f6;">
                        <h5 style="font-size: 14px; font-weight: 600; color: #1e40af; margin: 0 0 12px 0;">
                            ${seasonName} (${monthsText})
                        </h5>
                        ${season.periods.map(p => `
                            <div class="price-item" style="background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                                <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                    ${getTemplateI18nText(p.name)} (${p.start} - ${p.end})
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">${priceUnit}</label>
                                    <input type="number" class="form-input price-input" step="0.01" min="0" placeholder="0.00" data-mode="seasonal" data-season="${season.id}" data-period="${p.type}" required>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            }).join('');

            return `
                <div id="${containerId}">
                    <div class="config-tabs" style="margin-bottom: 16px;">
                        ${tabsHtml}
                    </div>
                    ${contentsHtml}
                </div>
            `;
        } else if (template.periods.mode === 'monthly') {
            // 逐月模式：每个月有自己的时段 - Tab导航
            const months = typeof getTranslation === 'function' ? [
                getTranslation('elecPriceMonthJan'), getTranslation('elecPriceMonthFeb'), getTranslation('elecPriceMonthMar'),
                getTranslation('elecPriceMonthApr'), getTranslation('elecPriceMonthMay'), getTranslation('elecPriceMonthJun'),
                getTranslation('elecPriceMonthJul'), getTranslation('elecPriceMonthAug'), getTranslation('elecPriceMonthSep'),
                getTranslation('elecPriceMonthOct'), getTranslation('elecPriceMonthNov'), getTranslation('elecPriceMonthDec')
            ] : ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
            const containerId = `monthly-tou-container-${Date.now()}`;

            const tabsHtml = months.map((monthName, idx) => `
                <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="tou-month-${idx + 1}" onclick="switchPriceTab('${containerId}', 'tou-month-${idx + 1}')">
                    ${monthName}
                </button>
            `).join('');

            const contentsHtml = months.map((monthName, monthIndex) => {
                const month = monthIndex + 1;
                const monthPeriods = template.periods.data[month] || [];
                return `
                    <div id="tou-month-${month}" class="config-tab-content ${monthIndex === 0 ? 'active' : ''}">
                        <div style="background: #fef3c7; padding: 16px; border-radius: 8px; margin-bottom: 16px; border: 2px solid #f59e0b;">
                            <h5 style="font-size: 14px; font-weight: 600; color: #92400e; margin: 0 0 12px 0;">
                                ${monthName}
                            </h5>
                            ${monthPeriods.map(p => `
                                <div class="price-item" style="background: white; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                        ${getTemplateI18nText(p.name)} (${p.start} - ${p.end})
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">${priceUnit}</label>
                                        <input type="number" class="form-input price-input" step="0.01" min="0" placeholder="0.00" data-mode="monthly" data-month="${month}" data-period="${p.type}" required>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div id="${containerId}">
                    <div class="config-tabs" style="margin-bottom: 16px;">
                        ${tabsHtml}
                    </div>
                    ${contentsHtml}
                </div>
            `;
        }
    }
    return '';
}


        
        function onConsumptionTemplateSelect() {
            const templateId = parseInt(document.getElementById('consumptionTemplate').value);
            const section = document.getElementById('consumptionPriceSection');
            const container = document.getElementById('consumptionPriceContainer');

            if (!templateId) {
                section.style.display = 'none';
                return;
            }

            const template = templates.find(t => t.id === templateId);
            section.style.display = 'block';
            container.innerHTML = generatePriceHTML(template);
        }

        function onFeedinTemplateSelect() {
            const templateId = parseInt(document.getElementById('feedinTemplate').value);
            const section = document.getElementById('feedinPriceSection');
            const container = document.getElementById('feedinPriceContainer');

            if (!templateId) {
                section.style.display = 'none';
                return;
            }

            const template = templates.find(t => t.id === templateId);
            section.style.display = 'block';
            container.innerHTML = generatePriceHTML(template);
        }

        function loadConsumptionPrices(prices) {
            if (!prices || prices.length === 0) return;
            const container = document.getElementById('consumptionPriceContainer');
            const inputs = container.querySelectorAll('.price-input');
            prices.forEach(price => {
                const input = Array.from(inputs).find(inp => {
                    // 固定电价
                    if (price.type === 'fixed') return inp.dataset.type === 'fixed';

                    // 阶梯电价
                    if (price.tier !== undefined) {
                        if (price.mode === 'seasonal') {
                            return inp.dataset.mode === 'seasonal' &&
                                   inp.dataset.season === price.season &&
                                   inp.dataset.tier === String(price.tier);
                        } else if (price.mode === 'monthly') {
                            return inp.dataset.mode === 'monthly' &&
                                   inp.dataset.month === String(price.month) &&
                                   inp.dataset.tier === String(price.tier);
                        } else {
                            return inp.dataset.mode === 'fixed' && inp.dataset.tier === String(price.tier);
                        }
                    }

                    // 分时电价
                    if (price.periodType) {
                        if (price.mode === 'seasonal') {
                            return inp.dataset.mode === 'seasonal' &&
                                   inp.dataset.season === price.season &&
                                   inp.dataset.period === price.periodType;
                        } else if (price.mode === 'monthly') {
                            return inp.dataset.mode === 'monthly' &&
                                   inp.dataset.month === String(price.month) &&
                                   inp.dataset.period === price.periodType;
                        } else {
                            return inp.dataset.mode === 'fixed' && inp.dataset.period === price.periodType;
                        }
                    }

                    return false;
                });
                if (input) input.value = price.price;
            });
        }

        function loadFeedinPrices(prices) {
            if (!prices || prices.length === 0) return;
            const container = document.getElementById('feedinPriceContainer');
            const inputs = container.querySelectorAll('.price-input');
            prices.forEach(price => {
                const input = Array.from(inputs).find(inp => {
                    // 固定电价
                    if (price.type === 'fixed') return inp.dataset.type === 'fixed';

                    // 阶梯电价
                    if (price.tier !== undefined) {
                        if (price.mode === 'seasonal') {
                            return inp.dataset.mode === 'seasonal' &&
                                   inp.dataset.season === price.season &&
                                   inp.dataset.tier === String(price.tier);
                        } else if (price.mode === 'monthly') {
                            return inp.dataset.mode === 'monthly' &&
                                   inp.dataset.month === String(price.month) &&
                                   inp.dataset.tier === String(price.tier);
                        } else {
                            return inp.dataset.mode === 'fixed' && inp.dataset.tier === String(price.tier);
                        }
                    }

                    // 分时电价
                    if (price.periodType) {
                        if (price.mode === 'seasonal') {
                            return inp.dataset.mode === 'seasonal' &&
                                   inp.dataset.season === price.season &&
                                   inp.dataset.period === price.periodType;
                        } else if (price.mode === 'monthly') {
                            return inp.dataset.mode === 'monthly' &&
                                   inp.dataset.month === String(price.month) &&
                                   inp.dataset.period === price.periodType;
                        } else {
                            return inp.dataset.mode === 'fixed' && inp.dataset.period === price.periodType;
                        }
                    }

                    return false;
                });
                if (input) input.value = price.price;
            });
        }

        function saveSiteConfig() {
            const consumptionTemplateId = parseInt(document.getElementById('consumptionTemplate').value) || null;
            const feedinTemplateId = parseInt(document.getElementById('feedinTemplate').value) || null;
            const effectiveTime = document.getElementById('effectiveTime').value;

            if (!consumptionTemplateId && !feedinTemplateId) {
                showToast('请至少选择一个电价模版', 'error');
                return;
            }

            if (!effectiveTime) {
                showToast('请设置生效时间', 'error');
                return;
            }

            // 收集购电价格
            let consumptionPrices = [];
            if (consumptionTemplateId) {
                const template = templates.find(t => t.id === consumptionTemplateId);
                const container = document.getElementById('consumptionPriceContainer');
                const inputs = container.querySelectorAll('.price-input');

                if (template.type === 'fixed') {
                    const price = parseFloat(inputs[0].value);
                    if (isNaN(price)) {
                        showToast('请填写购电价格', 'error');
                        return;
                    }
                    consumptionPrices.push({ type: 'fixed', price });
                } else if (template.type === 'tiered') {
                    inputs.forEach(input => {
                        const price = parseFloat(input.value);
                        if (isNaN(price)) {
                            showToast('请填写完整的购电阶梯价格', 'error');
                            return;
                        }

                        const priceData = { tier: parseInt(input.dataset.tier), price };

                        if (input.dataset.mode === 'seasonal') {
                            priceData.mode = 'seasonal';
                            priceData.season = input.dataset.season;
                        } else if (input.dataset.mode === 'monthly') {
                            priceData.mode = 'monthly';
                            priceData.month = parseInt(input.dataset.month);
                        } else {
                            priceData.mode = 'fixed';
                        }

                        consumptionPrices.push(priceData);
                    });
                } else {
                    inputs.forEach(input => {
                        const price = parseFloat(input.value);
                        if (isNaN(price)) {
                            showToast('请填写完整的购电时段价格', 'error');
                            return;
                        }

                        const priceData = { periodType: input.dataset.period, price };

                        if (input.dataset.mode === 'seasonal') {
                            priceData.mode = 'seasonal';
                            priceData.season = input.dataset.season;
                        } else if (input.dataset.mode === 'monthly') {
                            priceData.mode = 'monthly';
                            priceData.month = parseInt(input.dataset.month);
                        } else {
                            priceData.mode = 'fixed';
                        }

                        consumptionPrices.push(priceData);
                    });
                }
            }

            // 收集上网价格
            let feedinPrices = [];
            if (feedinTemplateId) {
                const template = templates.find(t => t.id === feedinTemplateId);
                const container = document.getElementById('feedinPriceContainer');
                const inputs = container.querySelectorAll('.price-input');

                if (template.type === 'fixed') {
                    const price = parseFloat(inputs[0].value);
                    if (isNaN(price)) {
                        showToast('请填写上网价格', 'error');
                        return;
                    }
                    feedinPrices.push({ type: 'fixed', price });
                } else if (template.type === 'tiered') {
                    // 阶梯电价 - 支持固定/季节/月度模式
                    inputs.forEach(input => {
                        const price = parseFloat(input.value);
                        if (isNaN(price)) {
                            showToast('请填写完整的上网阶梯价格', 'error');
                            return;
                        }

                        const priceData = {
                            tier: parseInt(input.dataset.tier),
                            price
                        };

                        // 根据模式添加额外信息
                        if (input.dataset.mode === 'seasonal') {
                            priceData.mode = 'seasonal';
                            priceData.season = input.dataset.season;
                        } else if (input.dataset.mode === 'monthly') {
                            priceData.mode = 'monthly';
                            priceData.month = parseInt(input.dataset.month);
                        } else {
                            priceData.mode = 'fixed';
                        }

                        feedinPrices.push(priceData);
                    });
                } else {
                    // 分时电价 - 支持固定/季节/月度模式
                    inputs.forEach(input => {
                        const price = parseFloat(input.value);
                        if (isNaN(price)) {
                            showToast('请填写完整的上网时段价格', 'error');
                            return;
                        }

                        const priceData = {
                            periodType: input.dataset.period,
                            price
                        };

                        // 根据模式添加额外信息
                        if (input.dataset.mode === 'seasonal') {
                            priceData.mode = 'seasonal';
                            priceData.season = input.dataset.season;
                        } else if (input.dataset.mode === 'monthly') {
                            priceData.mode = 'monthly';
                            priceData.month = parseInt(input.dataset.month);
                        } else {
                            priceData.mode = 'fixed';
                        }

                        feedinPrices.push(priceData);
                    });
                }
            }

            // 保存配置
            const configIndex = siteConfigs.findIndex(c => c.siteId === currentSiteId);
            const newConfig = {
                siteId: currentSiteId,
                consumptionTemplateId,
                feedinTemplateId,
                consumptionPrices,
                feedinPrices,
                effectiveTime,
                createTime: new Date().toLocaleString('zh-CN', { hour12: false })
            };

            if (configIndex >= 0) {
                siteConfigs[configIndex] = newConfig;
            } else {
                siteConfigs.push(newConfig);
            }

            renderSites();
            closeSiteConfigModal();
            showToast('配置保存成功', 'success');
        }

        function viewSiteConfig(siteId) {
            const site = sites.find(s => s.id === siteId);
            const config = siteConfigs.find(c => c.siteId === siteId);

            if (!config) {
                showToast('未找到配置信息', 'error');
                return;
            }

            const consumptionTemplate = config.consumptionTemplateId
                ? templates.find(t => t.id === config.consumptionTemplateId)
                : null;
            const feedinTemplate = config.feedinTemplateId
                ? templates.find(t => t.id === config.feedinTemplateId)
                : null;

            // 生成购电价格展示HTML
            const generateConsumptionPricesHTML = () => {
                if (!consumptionTemplate) return '<div style="color: var(--gray-600);">未配置购电模版</div>';

                if (consumptionTemplate.type === 'fixed') {
                    const priceData = config.consumptionPrices.find(p => p.type === 'fixed');
                    return `
                        <div class="period-config">
                            <div class="period-name">固定电价</div>
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                <span style="color: var(--danger-color); font-size: 1.25rem; font-weight: 600;">
                                    ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                </span>
                            </div>
                        </div>
                    `;
                } else if (consumptionTemplate.type === 'tiered') {
                    // 阶梯电价
                    const mode = consumptionTemplate.tiers.mode;
                    if (mode === 'fixed') {
                        return consumptionTemplate.tiers.data.map((tier, index) => {
                            const priceData = config.consumptionPrices.find(p => p.mode === 'fixed' && p.tier === index);
                            return `
                                <div class="period-config" style="margin-bottom: 0.75rem;">
                                    <div class="period-name">第${index + 1}阶梯 (${tier.end !== null ? `${tier.start}-${tier.end}度` : `${tier.start}度以上`})</div>
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <span style="color: var(--danger-color); font-weight: 600;">
                                            ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else if (mode === 'seasonal') {
                        const containerId = `view-seasonal-tier-${Date.now()}`;
                        const tabsHtml = consumptionTemplate.tiers.seasons.map((season, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-season-${season.id}" onclick="switchPriceTab('${containerId}', 'view-season-${season.id}')">
                                ${season.name}
                            </button>
                        `).join('');

                        const contentsHtml = consumptionTemplate.tiers.seasons.map((season, idx) => `
                            <div id="view-season-${season.id}" class="config-tab-content ${idx === 0 ? 'active' : ''}">
                                <div style="background: #f0f9ff; padding: 16px; border: 2px solid #3b82f6; border-radius: 8px; margin-bottom: 16px;">
                                    <h5 style="margin: 0 0 12px 0; color: #1e40af;">
                                        <i class="fas fa-calendar-alt"></i> ${season.name}
                                        <span style="font-size: 0.875rem; color: #64748b;">(${formatMonthsList(season.months)})</span>
                                    </h5>
                                    ${season.tiers.map((tier, index) => {
                                        const priceData = config.consumptionPrices.find(p => p.mode === 'seasonal' && p.season === season.id && p.tier === index);
                                        return `
                                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                <span style="color: #475569;">第${index + 1}阶梯 (${tier.end !== null ? `${tier.start}-${tier.end}度` : `${tier.start}度以上`})</span>
                                                <span style="float: right; color: var(--danger-color); font-weight: 600;">
                                                    ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    } else if (mode === 'monthly') {
                        const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                        const containerId = `view-monthly-tier-${Date.now()}`;

                        const tabsHtml = months.map((monthName, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-month-tier-${idx + 1}" onclick="switchPriceTab('${containerId}', 'view-month-tier-${idx + 1}')">
                                ${monthName}
                            </button>
                        `).join('');

                        const contentsHtml = months.map((monthName, monthIndex) => {
                            const month = monthIndex + 1;
                            const monthTiers = consumptionTemplate.tiers.data[month] || [];
                            return `
                                <div id="view-month-tier-${month}" class="config-tab-content ${monthIndex === 0 ? 'active' : ''}">
                                    <div style="background: #fef3c7; padding: 16px; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 16px;">
                                        <h5 style="margin: 0 0 12px 0; color: #92400e;">
                                            <i class="fas fa-calendar"></i> ${monthName}
                                        </h5>
                                        ${monthTiers.map((tier, index) => {
                                            const priceData = config.consumptionPrices.find(p => p.mode === 'monthly' && p.month === month && p.tier === index);
                                            return `
                                                <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                    <span style="color: #475569;">第${index + 1}阶梯 (${tier.end !== null ? `${tier.start}-${tier.end}度` : `${tier.start}度以上`})</span>
                                                    <span style="float: right; color: var(--danger-color); font-weight: 600;">
                                                        ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                    </span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    }
                } else {
                    // 分时电价
                    const mode = consumptionTemplate.periods.mode;
                    if (mode === 'fixed') {
                        return consumptionTemplate.periods.data.map(period => {
                            const priceData = config.consumptionPrices.find(p => p.mode === 'fixed' && p.periodType === period.type);
                            return `
                                <div class="period-config" style="margin-bottom: 0.75rem;">
                                    <div class="period-config-header">
                                        <span class="period-name">
                                            <span class="period-tag ${period.type}">${period.name}</span>
                                        </span>
                                        <span class="period-time">${period.start} - ${period.end}</span>
                                    </div>
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <span style="color: var(--danger-color); font-weight: 600;">
                                            ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else if (mode === 'seasonal') {
                        const containerId = `view-seasonal-tou-${Date.now()}`;
                        const tabsHtml = consumptionTemplate.periods.seasons.map((season, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-tou-season-${season.id}" onclick="switchPriceTab('${containerId}', 'view-tou-season-${season.id}')">
                                ${season.name}
                            </button>
                        `).join('');

                        const contentsHtml = consumptionTemplate.periods.seasons.map((season, idx) => `
                            <div id="view-tou-season-${season.id}" class="config-tab-content ${idx === 0 ? 'active' : ''}">
                                <div style="background: #f0f9ff; padding: 16px; border: 2px solid #3b82f6; border-radius: 8px; margin-bottom: 16px;">
                                    <h5 style="margin: 0 0 12px 0; color: #1e40af;">
                                        <i class="fas fa-calendar-alt"></i> ${season.name}
                                        <span style="font-size: 0.875rem; color: #64748b;">(${formatMonthsList(season.months)})</span>
                                    </h5>
                                    ${season.periods.map(period => {
                                        const priceData = config.consumptionPrices.find(p => p.mode === 'seasonal' && p.season === season.id && p.periodType === period.type);
                                        return `
                                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                <span class="period-tag ${period.type}">${period.name}</span>
                                                <span style="color: #64748b; font-size: 0.875rem; margin-left: 8px;">${period.start} - ${period.end}</span>
                                                <span style="float: right; color: var(--danger-color); font-weight: 600;">
                                                    ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    } else if (mode === 'monthly') {
                        const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                        const containerId = `view-monthly-tou-${Date.now()}`;

                        const tabsHtml = months.map((monthName, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-tou-month-${idx + 1}" onclick="switchPriceTab('${containerId}', 'view-tou-month-${idx + 1}')">
                                ${monthName}
                            </button>
                        `).join('');

                        const contentsHtml = months.map((monthName, monthIndex) => {
                            const month = monthIndex + 1;
                            const monthPeriods = consumptionTemplate.periods.data[month] || [];
                            return `
                                <div id="view-tou-month-${month}" class="config-tab-content ${monthIndex === 0 ? 'active' : ''}">
                                    <div style="background: #fef3c7; padding: 16px; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 16px;">
                                        <h5 style="margin: 0 0 12px 0; color: #92400e;">
                                            <i class="fas fa-calendar"></i> ${monthName}
                                        </h5>
                                        ${monthPeriods.map(period => {
                                            const priceData = config.consumptionPrices.find(p => p.mode === 'monthly' && p.month === month && p.periodType === period.type);
                                            return `
                                                <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                    <span class="period-tag ${period.type}">${period.name}</span>
                                                    <span style="color: #64748b; font-size: 0.875rem; margin-left: 8px;">${period.start} - ${period.end}</span>
                                                    <span style="float: right; color: var(--danger-color); font-weight: 600;">
                                                        ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                    </span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    }
                }
            };

            // 生成上网价格展示HTML (逻辑与购电类似，但使用feedinPrices和蓝色主题)
            const generateFeedinPricesHTML = () => {
                if (!feedinTemplate) return '<div style="color: var(--gray-600);">未配置上网模版</div>';

                if (feedinTemplate.type === 'fixed') {
                    const priceData = config.feedinPrices.find(p => p.type === 'fixed');
                    return `
                        <div class="period-config">
                            <div class="period-name">固定电价</div>
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                <span style="color: var(--primary-color); font-size: 1.25rem; font-weight: 600;">
                                    ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                </span>
                            </div>
                        </div>
                    `;
                } else if (feedinTemplate.type === 'tiered') {
                    const mode = feedinTemplate.tiers.mode;
                    if (mode === 'fixed') {
                        return feedinTemplate.tiers.data.map((tier, index) => {
                            const priceData = config.feedinPrices.find(p => p.mode === 'fixed' && p.tier === index);
                            return `
                                <div class="period-config" style="margin-bottom: 0.75rem;">
                                    <div class="period-name">第${index + 1}阶梯 (${tier.end !== null ? `${tier.start}-${tier.end}度` : `${tier.start}度以上`})</div>
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <span style="color: var(--primary-color); font-weight: 600;">
                                            ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else if (mode === 'seasonal') {
                        const containerId = `view-feedin-seasonal-tier-${Date.now()}`;
                        const tabsHtml = feedinTemplate.tiers.seasons.map((season, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-feedin-season-${season.id}" onclick="switchPriceTab('${containerId}', 'view-feedin-season-${season.id}')">
                                ${season.name}
                            </button>
                        `).join('');

                        const contentsHtml = feedinTemplate.tiers.seasons.map((season, idx) => `
                            <div id="view-feedin-season-${season.id}" class="config-tab-content ${idx === 0 ? 'active' : ''}">
                                <div style="background: #f0f9ff; padding: 16px; border: 2px solid #3b82f6; border-radius: 8px; margin-bottom: 16px;">
                                    <h5 style="margin: 0 0 12px 0; color: #1e40af;">
                                        <i class="fas fa-calendar-alt"></i> ${season.name}
                                        <span style="font-size: 0.875rem; color: #64748b;">(${formatMonthsList(season.months)})</span>
                                    </h5>
                                    ${season.tiers.map((tier, index) => {
                                        const priceData = config.feedinPrices.find(p => p.mode === 'seasonal' && p.season === season.id && p.tier === index);
                                        return `
                                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                <span style="color: #475569;">第${index + 1}阶梯 (${tier.end !== null ? `${tier.start}-${tier.end}度` : `${tier.start}度以上`})</span>
                                                <span style="float: right; color: var(--primary-color); font-weight: 600;">
                                                    ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    } else if (mode === 'monthly') {
                        const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                        const containerId = `view-feedin-monthly-tier-${Date.now()}`;

                        const tabsHtml = months.map((monthName, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-feedin-month-tier-${idx + 1}" onclick="switchPriceTab('${containerId}', 'view-feedin-month-tier-${idx + 1}')">
                                ${monthName}
                            </button>
                        `).join('');

                        const contentsHtml = months.map((monthName, monthIndex) => {
                            const month = monthIndex + 1;
                            const monthTiers = feedinTemplate.tiers.data[month] || [];
                            return `
                                <div id="view-feedin-month-tier-${month}" class="config-tab-content ${monthIndex === 0 ? 'active' : ''}">
                                    <div style="background: #fef3c7; padding: 16px; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 16px;">
                                        <h5 style="margin: 0 0 12px 0; color: #92400e;">
                                            <i class="fas fa-calendar"></i> ${monthName}
                                        </h5>
                                        ${monthTiers.map((tier, index) => {
                                            const priceData = config.feedinPrices.find(p => p.mode === 'monthly' && p.month === month && p.tier === index);
                                            return `
                                                <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                    <span style="color: #475569;">第${index + 1}阶梯 (${tier.end !== null ? `${tier.start}-${tier.end}度` : `${tier.start}度以上`})</span>
                                                    <span style="float: right; color: var(--primary-color); font-weight: 600;">
                                                        ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                    </span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    }
                } else {
                    // 分时电价
                    const mode = feedinTemplate.periods.mode;
                    if (mode === 'fixed') {
                        return feedinTemplate.periods.data.map(period => {
                            const priceData = config.feedinPrices.find(p => p.mode === 'fixed' && p.periodType === period.type);
                            return `
                                <div class="period-config" style="margin-bottom: 0.75rem;">
                                    <div class="period-config-header">
                                        <span class="period-name">
                                            <span class="period-tag ${period.type}">${period.name}</span>
                                        </span>
                                        <span class="period-time">${period.start} - ${period.end}</span>
                                    </div>
                                    <div style="margin-top: 0.5rem; padding: 0.75rem; background: white; border-radius: 6px;">
                                        <span style="color: var(--primary-color); font-weight: 600;">
                                            ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                        </span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else if (mode === 'seasonal') {
                        const containerId = `view-feedin-seasonal-tou-${Date.now()}`;
                        const tabsHtml = feedinTemplate.periods.seasons.map((season, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-feedin-tou-season-${season.id}" onclick="switchPriceTab('${containerId}', 'view-feedin-tou-season-${season.id}')">
                                ${season.name}
                            </button>
                        `).join('');

                        const contentsHtml = feedinTemplate.periods.seasons.map((season, idx) => `
                            <div id="view-feedin-tou-season-${season.id}" class="config-tab-content ${idx === 0 ? 'active' : ''}">
                                <div style="background: #f0f9ff; padding: 16px; border: 2px solid #3b82f6; border-radius: 8px; margin-bottom: 16px;">
                                    <h5 style="margin: 0 0 12px 0; color: #1e40af;">
                                        <i class="fas fa-calendar-alt"></i> ${season.name}
                                        <span style="font-size: 0.875rem; color: #64748b;">(${formatMonthsList(season.months)})</span>
                                    </h5>
                                    ${season.periods.map(period => {
                                        const priceData = config.feedinPrices.find(p => p.mode === 'seasonal' && p.season === season.id && p.periodType === period.type);
                                        return `
                                            <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                <span class="period-tag ${period.type}">${period.name}</span>
                                                <span style="color: #64748b; font-size: 0.875rem; margin-left: 8px;">${period.start} - ${period.end}</span>
                                                <span style="float: right; color: var(--primary-color); font-weight: 600;">
                                                    ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                </span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    } else if (mode === 'monthly') {
                        const months = ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'];
                        const containerId = `view-feedin-monthly-tou-${Date.now()}`;

                        const tabsHtml = months.map((monthName, idx) => `
                            <button class="config-tab ${idx === 0 ? 'active' : ''}" data-tab="view-feedin-tou-month-${idx + 1}" onclick="switchPriceTab('${containerId}', 'view-feedin-tou-month-${idx + 1}')">
                                ${monthName}
                            </button>
                        `).join('');

                        const contentsHtml = months.map((monthName, monthIndex) => {
                            const month = monthIndex + 1;
                            const monthPeriods = feedinTemplate.periods.data[month] || [];
                            return `
                                <div id="view-feedin-tou-month-${month}" class="config-tab-content ${monthIndex === 0 ? 'active' : ''}">
                                    <div style="background: #fef3c7; padding: 16px; border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 16px;">
                                        <h5 style="margin: 0 0 12px 0; color: #92400e;">
                                            <i class="fas fa-calendar"></i> ${monthName}
                                        </h5>
                                        ${monthPeriods.map(period => {
                                            const priceData = config.feedinPrices.find(p => p.mode === 'monthly' && p.month === month && p.periodType === period.type);
                                            return `
                                                <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                    <span class="period-tag ${period.type}">${period.name}</span>
                                                    <span style="color: #64748b; font-size: 0.875rem; margin-left: 8px;">${period.start} - ${period.end}</span>
                                                    <span style="float: right; color: var(--primary-color); font-weight: 600;">
                                                        ${priceData ? priceData.price.toFixed(4) : '0.0000'} 元/kWh
                                                    </span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('');

                        return `
                            <div id="${containerId}">
                                <div class="config-tabs" style="margin-bottom: 16px;">
                                    ${tabsHtml}
                                </div>
                                ${contentsHtml}
                            </div>
                        `;
                    }
                }
            };

            const modalContent = `
                <div class="modal-content" style="max-width: 1200px;">
                    <div class="modal-header">
                        <h3 class="modal-title">电站电价配置详情</h3>
                        <button class="modal-close" onclick="closeViewSiteConfigModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- 电站信息 -->
                        <div class="form-group">
                            <label class="form-label">电站名称</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem; font-weight: 600;">
                                <i class="fas fa-building" style="color: var(--primary-color);"></i> ${site.name}
                            </div>
                        </div>

                        <!-- 生效时间 -->
                        <div class="form-group">
                            <label class="form-label">生效时间</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem; color: var(--gray-600);">
                                <i class="fas fa-calendar-check"></i> ${config.effectiveTime}
                            </div>
                        </div>

                        <!-- 购电配置 -->
                        <div style="background: #fef1f1; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 2px solid #eb2f96;">
                            <h4 style="margin: 0 0 16px 0; color: #eb2f96;">
                                <i class="fas fa-download"></i> 购电配置
                            </h4>
                            ${consumptionTemplate ? `
                                <div style="margin-bottom: 16px; padding: 10px; background: white; border-radius: 6px;">
                                    <strong>${consumptionTemplate.name}</strong>
                                    <span class="template-type" style="margin-left: 0.5rem;">${consumptionTemplate.typeName}</span>
                                </div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${generateConsumptionPricesHTML()}
                                </div>
                            ` : '<div style="color: var(--gray-600);">未配置购电模版</div>'}
                        </div>

                        <!-- 上网配置 -->
                        <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; border: 2px solid #1890ff;">
                            <h4 style="margin: 0 0 16px 0; color: #1890ff;">
                                <i class="fas fa-upload"></i> 上网配置
                            </h4>
                            ${feedinTemplate ? `
                                <div style="margin-bottom: 16px; padding: 10px; background: white; border-radius: 6px;">
                                    <strong>${feedinTemplate.name}</strong>
                                    <span class="template-type" style="margin-left: 0.5rem;">${feedinTemplate.typeName}</span>
                                </div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${generateFeedinPricesHTML()}
                                </div>
                            ` : '<div style="color: var(--gray-600);">未配置上网模版</div>'}
                        </div>

                        <!-- 配置时间 -->
                        <div class="form-group">
                            <label class="form-label">配置时间</label>
                            <div style="padding: 0.625rem 0.875rem; background: var(--gray-50); border-radius: 0.5rem; color: var(--gray-600);">
                                <i class="fas fa-clock"></i> ${config.createTime}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeViewSiteConfigModal()">关闭</button>
                        <button class="btn btn-primary" onclick="closeViewSiteConfigModal(); configureSite('${siteId}')">
                            <i class="fas fa-edit"></i> 修改配置
                        </button>
                    </div>
                </div>
            `;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'viewSiteConfigModal';
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
        }

        function closeViewSiteConfigModal() {
            const modal = document.getElementById('viewSiteConfigModal');
            if (modal) modal.remove();
        }

        function closeSiteConfigModal() {
            document.getElementById('siteConfigModal').classList.remove('active');
            currentSiteId = null;
        }

        // 切换配置标签页
        function switchConfigTab(tabName) {
            // 移除所有标签页的active状态
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.config-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // 激活选中的标签页
            if (tabName === 'consumption') {
                document.querySelector('.config-tab:first-child').classList.add('active');
                document.getElementById('consumptionTabContent').classList.add('active');
            } else if (tabName === 'feedin') {
                document.querySelector('.config-tab:last-child').classList.add('active');
                document.getElementById('feedinTabContent').classList.add('active');
            }
        }

        // 切换月份/季节标签页
        function switchPriceTab(containerId, tabId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // 移除所有标签页的active状态
            container.querySelectorAll('.config-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            container.querySelectorAll('.config-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // 激活选中的标签页
            const selectedTab = container.querySelector(`[data-tab="${tabId}"]`);
            const selectedContent = container.querySelector(`#${tabId}`);

            if (selectedTab) selectedTab.classList.add('active');
            if (selectedContent) selectedContent.classList.add('active');
        }

        // ==================== 工具函数 ====================

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
    </script>
</body>
</html>
