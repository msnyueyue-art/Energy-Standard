# 上网模板不显示问题修复说明

## 问题描述

在【上网模板】标签下,点击【从模板创建】按钮,选择预设模板并保存后,新建的模板**不显示在上网模板列表中**。

## 问题现象

1. ✅ 点击"新建规则" → "从模板创建"
2. ✅ 选择一个预设模板(如"浙江峰谷电价")
3. ✅ 点击"应用模板"
4. ✅ 显示"模版创建成功"
5. ❌ **上网模板列表中看不到新创建的模板**
6. ❌ **但在购电模板列表中可能会看到该模板**

## 根本原因

在 `applyPresetTemplate` 函数(第3003-3051行)中,创建新模板时**缺少 purpose 字段**:

### 错误代码 (修复前)

```javascript
function applyPresetTemplate() {
    const preset = presetTemplates.find(p => p.id === selectedPresetTemplate);

    const newTemplate = {
        id: Date.now(),
        name: preset.name,
        type: preset.type,
        typeName: typeNames[preset.type],
        description: preset.description,
        periods: JSON.parse(JSON.stringify(preset.periods)),
        createTime: new Date().toLocaleString('zh-CN', { hour12: false })
        // ❌ 缺少 purpose 字段!
    };

    templates.unshift(newTemplate);
}
```

### 为什么会导致不显示?

模板列表渲染时,使用 `purpose` 字段来过滤和分类模板:

```javascript
// renderFeedinTemplates 函数 (第3146-3149行)
const feedinTemplates = templates.filter(t => {
    const purpose = t.purpose || 'consumption';  // 默认值是 'consumption'
    return purpose === 'feed-in';
});
```

**关键问题:**
- 如果模板没有 `purpose` 字段,默认值是 `'consumption'`
- 因此,即使在"上网模板"标签下创建的模板,也会被识别为"购电模板"
- 结果:上网模板列表中看不到,购电模板列表中能看到

## 解决方案

在 `applyPresetTemplate` 函数中添加 purpose 字段的逻辑:

### 修复代码 (第3003-3051行)

```javascript
function applyPresetTemplate() {
    if (!selectedPresetTemplate) {
        showToast('请选择一个预设模版', 'error');
        return;
    }

    const preset = presetTemplates.find(p => p.id === selectedPresetTemplate);
    if (!preset) {
        showToast('未找到选中的模版', 'error');
        return;
    }

    // ✅ 获取当前选择的用途
    const purpose = document.getElementById('templatePurpose').value;
    if (!purpose) {
        showToast('无法确定模版用途', 'error');
        return;
    }

    // 创建新模版
    const typeNames = {
        'peak-valley': '峰谷平尖',
        'tou': '分时电价',
        'tiered': '阶梯电价',
        'fixed': '固定电价'
    };

    const purposeNames = {
        'consumption': '用电电价',
        'feed-in': '上网电价'
    };

    const newTemplate = {
        id: Date.now(),
        name: preset.name,
        type: preset.type,
        typeName: typeNames[preset.type],
        purpose: purpose,  // ✅ 添加用途字段
        purposeName: purposeNames[purpose],  // ✅ 添加用途名称
        description: preset.description,
        periods: JSON.parse(JSON.stringify(preset.periods)),
        createTime: new Date().toLocaleString('zh-CN', { hour12: false })
    };

    templates.unshift(newTemplate);
    renderTemplates();
    closePresetTemplateModal();
    showToast('模版创建成功', 'success');
}
```

## 技术细节

### 1. purpose 字段的来源

当用户点击"新建规则"时,会根据当前所在的标签页传递 purpose 参数:

```javascript
// 购电模板标签
<button onclick="openCreateModeModal('consumption')">新建规则</button>

// 上网模板标签
<button onclick="openCreateModeModal('feed-in')">新建规则</button>
```

然后在 `openPresetTemplateModal` 函数中:

```javascript
function openPresetTemplateModal(purpose) {
    // 设置隐藏字段的值
    selectPurpose(purpose);  // 这会设置 templatePurpose 字段
}

function selectPurpose(purpose) {
    document.getElementById('templatePurpose').value = purpose;
}
```

### 2. 模板分类逻辑

```javascript
// 购电模板过滤 (第3080-3083行)
const consumptionTemplates = templates.filter(t => {
    const purpose = t.purpose || 'consumption';  // 默认为购电
    return purpose === 'consumption';
});

// 上网模板过滤 (第3146-3149行)
const feedinTemplates = templates.filter(t => {
    const purpose = t.purpose || 'consumption';  // 默认为购电
    return purpose === 'feed-in';
});
```

## 数据流程图

```
┌──────────────────────────────────────────────────────────────┐
│ 1. 用户在"上网模板"标签下点击"新建规则"                      │
├──────────────────────────────────────────────────────────────┤
│ onclick="openCreateModeModal('feed-in')"                      │
└────────────────────┬─────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────┐
│ 2. 选择"从模板创建"                                          │
├──────────────────────────────────────────────────────────────┤
│ onclick="openPresetTemplateModal('feed-in')"                  │
└────────────────────┬─────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────┐
│ 3. openPresetTemplateModal 函数执行                          │
├──────────────────────────────────────────────────────────────┤
│ selectPurpose('feed-in');                                     │
│   ↓                                                           │
│ document.getElementById('templatePurpose').value = 'feed-in'; │
└────────────────────┬─────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────┐
│ 4. 用户选择预设模板并点击"应用模板"                          │
├──────────────────────────────────────────────────────────────┤
│ onclick="applyPresetTemplate()"                               │
└────────────────────┬─────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────┐
│ 5. applyPresetTemplate 函数执行 (修复后)                     │
├──────────────────────────────────────────────────────────────┤
│ const purpose = document.getElementById('templatePurpose').value; │
│ // purpose = 'feed-in' ✅                                     │
│                                                               │
│ const newTemplate = {                                         │
│   ...preset,                                                  │
│   purpose: 'feed-in',        // ✅ 正确设置                  │
│   purposeName: '上网电价'    // ✅ 正确设置                  │
│ };                                                            │
└────────────────────┬─────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────┐
│ 6. renderTemplates 函数执行                                  │
├──────────────────────────────────────────────────────────────┤
│ renderFeedinTemplates();                                      │
│   ↓                                                           │
│ const feedinTemplates = templates.filter(t => {               │
│   const purpose = t.purpose || 'consumption';                 │
│   return purpose === 'feed-in';  // ✅ 匹配成功!            │
│ });                                                           │
└────────────────────┬─────────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────────┐
│ 7. 上网模板列表正确显示新创建的模板 ✅                       │
└──────────────────────────────────────────────────────────────┘
```

## 修复前后对比

### 修复前 ❌

| 操作 | 结果 |
|------|------|
| 在"上网模板"标签创建模板 | ❌ 不显示在上网模板列表 |
| | ✅ 显示在购电模板列表(错误) |
| 在"购电模板"标签创建模板 | ✅ 显示在购电模板列表 |
| | ❌ 不显示在上网模板列表 |

**数据示例:**
```javascript
{
  id: 1736757600000,
  name: "浙江峰谷电价",
  type: "peak-valley",
  typeName: "峰谷平尖",
  // ❌ 缺少 purpose 字段
  description: "适用于浙江地区工商业用电",
  periods: [...],
  createTime: "2026/1/13 16:00:00"
}
```

### 修复后 ✅

| 操作 | 结果 |
|------|------|
| 在"上网模板"标签创建模板 | ✅ 正确显示在上网模板列表 |
| | ❌ 不显示在购电模板列表 |
| 在"购电模板"标签创建模板 | ✅ 正确显示在购电模板列表 |
| | ❌ 不显示在上网模板列表 |

**数据示例:**
```javascript
{
  id: 1736757600000,
  name: "浙江峰谷电价",
  type: "peak-valley",
  typeName: "峰谷平尖",
  purpose: "feed-in",         // ✅ 正确设置
  purposeName: "上网电价",    // ✅ 正确设置
  description: "适用于浙江地区工商业用电",
  periods: [...],
  createTime: "2026/1/13 16:00:00"
}
```

## 测试验证

### 测试步骤

1. **测试上网模板创建**:
   - 切换到"上网模板"标签
   - 点击"新建规则" → "从模板创建"
   - 选择任意预设模板(如"浙江峰谷电价")
   - 点击"应用模板"
   - ✅ 验证:模板出现在上网模板列表中
   - ✅ 验证:模板不出现在购电模板列表中

2. **测试购电模板创建**:
   - 切换到"购电模板"标签
   - 点击"新建规则" → "从模板创建"
   - 选择任意预设模板
   - 点击"应用模板"
   - ✅ 验证:模板出现在购电模板列表中
   - ✅ 验证:模板不出现在上网模板列表中

3. **测试自定义创建**:
   - 在"上网模板"标签,点击"新建规则" → "自定义创建"
   - 填写表单并保存
   - ✅ 验证:模板正确出现在上网模板列表中

### 预期结果

所有新创建的模板应该:
- ✅ 出现在正确的标签页列表中
- ✅ 包含完整的 purpose 和 purposeName 字段
- ✅ 可以正常编辑、查看、删除

## 相关代码位置

- **修复位置**: [electricity-price-new.html:3003-3051](electricity-price-new.html:3003-3051)
- **渲染逻辑**:
  - 购电模板: [electricity-price-new.html:3076-3140](electricity-price-new.html:3076-3140)
  - 上网模板: [electricity-price-new.html:3142-3206](electricity-price-new.html:3142-3206)
- **用途设置**: [electricity-price-new.html:2690-2755](electricity-price-new.html:2690-2755)

## 总结

这是一个典型的**数据不完整导致的过滤失效问题**:

1. **问题根源**: 创建模板时遗漏了关键字段 `purpose`
2. **影响范围**: 所有通过"从模板创建"方式创建的模板
3. **修复方式**: 从隐藏字段读取 purpose 值并添加到新模板对象中
4. **修复效果**: 模板能够正确分类和显示

修复后,用户可以正常在上网模板和购电模板两个标签下分别管理各自的模板! 🎉
