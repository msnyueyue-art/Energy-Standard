# 消息策略删除确认对话框国际化修复说明

## 修复概述

将消息策略管理页面 (`rule-engine.html`) 的删除确认对话框从浏览器原生 `confirm()` 对话框替换为自定义模态框,解决了英文环境下对话框标题仍显示中文的问题。

## 问题描述

在英文环境下,点击删除按钮时,浏览器原生的 `confirm()` 对话框会显示:
- **标题:** `此网页显示` (浏览器默认,无法自定义) ❌
- **内容:** `Are you sure you want to delete this rule?` (已国际化) ✅
- **按钮:** `确定` / `取消` (浏览器默认,无法自定义) ❌

## 修复内容

### 1. 添加模态框 CSS 样式

**文件:** `rule-engine.html` (第 1291-1442 行)

由于原页面缺少模态框的 CSS 样式,需要添加完整的模态框样式系统,包括:

- **基础模态框样式** (`.modal`, `.modal-content`)
- **模态框动画** (`@keyframes modalFadeIn`)
- **模态框头部** (`.modal-header`, `.modal-title`, `.modal-close`)
- **模态框主体** (`.modal-body`)
- **模态框底部** (`.modal-footer`)
- **按钮样式** (`.btn-primary`, `.btn-secondary`)
- **暗色主题适配** (`[data-theme="dark"]`)

**关键样式:**
```css
.modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}
```

### 2. 修正翻译键内容

**文件:** `common.js`

#### 中文翻译 (第 2598 行)
**修改前:**
```javascript
ruleDeleteConfirmTitle: '此网页显示',  // 错误!
```

**修改后:**
```javascript
ruleDeleteConfirmTitle: '确认删除',    // 正确!
```

#### 英文翻译 (第 6325 行)
**修改前:**
```javascript
ruleDeleteConfirmTitle: 'This page says',  // 错误!
```

**修改后:**
```javascript
ruleDeleteConfirmTitle: 'Confirm Delete',  // 正确!
```

### 3. 创建自定义确认对话框函数

**文件:** `rule-engine.html` (第 2984-3041 行,由于添加了 CSS 样式,行号有偏移)

新增了三个函数:

#### a) `showConfirmDialog()` - 显示确认对话框
```javascript
function showConfirmDialog(title, message, confirmText, cancelText, onConfirm) {
    // 创建完全可控的自定义模态框
    // 支持国际化的标题、内容、按钮
    // 使用回调函数处理确认操作
}
```

#### b) `closeConfirmDialog()` - 关闭确认对话框
```javascript
function closeConfirmDialog() {
    // 移除对话框并清理回调
}
```

#### c) `confirmDialogAction()` - 执行确认操作
```javascript
function confirmDialogAction() {
    // 执行回调并关闭对话框
}
```

### 4. 修改 deleteRule 函数

**文件:** `rule-engine.html` (第 2961-2982 行,由于添加了 CSS 样式,行号有偏移)

**修改前:**
```javascript
function deleteRule(ruleId) {
    const rule = allRules.find(r => r.id === ruleId);
    if (!rule) return;

    if (rule.deployedDevices && rule.deployedDevices.length > 0) {
        showNotification(getTranslation('ruleDeleteRemoveDevicesFirst'), 'error');
        return;
    }

    if (confirm(getTranslation('ruleDeleteConfirmMessage'))) {  // 使用浏览器原生对话框
        allRules = allRules.filter(r => r.id !== ruleId);
        filteredRules = filteredRules.filter(r => r.id !== ruleId);
        renderRulesTable();
        showNotification(getTranslation('ruleDeleteSuccess'), 'success');
    }
}
```

**修改后:**
```javascript
function deleteRule(ruleId) {
    const rule = allRules.find(r => r.id === ruleId);
    if (!rule) return;

    if (rule.deployedDevices && rule.deployedDevices.length > 0) {
        showNotification(getTranslation('ruleDeleteRemoveDevicesFirst'), 'error');
        return;
    }

    const confirmTitle = getTranslation('ruleDeleteConfirmTitle') || '确认删除';
    const confirmMessage = getTranslation('ruleDeleteConfirmMessage') || '确定要删除这条规则吗?';
    const confirmBtn = getTranslation('btnConfirm') || '确定';
    const cancelBtn = getTranslation('btnCancelAlt') || '取消';

    showConfirmDialog(confirmTitle, confirmMessage, confirmBtn, cancelBtn, () => {
        allRules = allRules.filter(r => r.id !== ruleId);
        filteredRules = filteredRules.filter(r => r.id !== ruleId);
        renderRulesTable();
        showNotification(getTranslation('ruleDeleteSuccess'), 'success');
    });
}
```

## 效果对比

### 修改前 (浏览器原生对话框)

**中文环境:**
- 标题: `此网页显示` ❌
- 内容: `确定要删除这条规则吗?` ✅
- 按钮: `确定` / `取消` ✅

**英文环境:**
- 标题: `此网页显示` ❌ (无法自定义)
- 内容: `Are you sure you want to delete this rule?` ✅
- 按钮: `确定` / `取消` ❌ (无法自定义)

### 修改后 (自定义模态框)

**中文环境:**
- 标题: `确认删除` ✅
- 内容: `确定要删除这条规则吗?` ✅
- 按钮: `确定` / `取消` ✅

**英文环境:**
- 标题: `Confirm Delete` ✅
- 内容: `Are you sure you want to delete this rule?` ✅
- 按钮: `Confirm` / `Cancel` ✅

## 翻译键列表

| 翻译键 | 中文 | 英文 | 用途 |
|--------|------|------|------|
| `ruleDeleteConfirmTitle` | 确认删除 | Confirm Delete | 对话框标题 |
| `ruleDeleteConfirmMessage` | 确定要删除这条规则吗? | Are you sure you want to delete this rule? | 确认消息 |
| `btnConfirm` | 确定 | Confirm | 确认按钮 |
| `btnCancelAlt` | 取消 | Cancel | 取消按钮 |
| `ruleDeleteSuccess` | 规则已删除 | Rule deleted successfully | 删除成功提示 |
| `ruleDeleteRemoveDevicesFirst` | 请先移除设备后再删除规则 | Please remove devices before deleting the rule | 错误提示 |

## 技术特点

1. **完全可控:** 对话框所有元素都可自定义
2. **样式统一:** 使用页面现有模态框样式
3. **交互友好:**
   - 点击背景关闭
   - 支持关闭按钮
   - 回调机制灵活
4. **国际化完整:** 所有文本都支持多语言
5. **可扩展:** 可用于其他确认场景

## 对话框 HTML 结构

```html
<div class="modal" id="customConfirmDialog">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">确认删除 / Confirm Delete</h3>
            <button class="modal-close">×</button>
        </div>
        <div class="modal-body">
            <p>确定要删除这条规则吗? / Are you sure you want to delete this rule?</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary">取消 / Cancel</button>
            <button class="btn btn-primary">确定 / Confirm</button>
        </div>
    </div>
</div>
```

## 测试建议

1. **中文环境测试:**
   - 点击任一规则的删除按钮
   - 验证对话框标题显示"确认删除"
   - 验证按钮显示"确定"和"取消"
   - 点击"确定"验证规则删除成功
   - 点击"取消"验证对话框关闭

2. **英文环境测试:**
   - 切换到英文
   - 点击任一规则的 Delete 按钮
   - 验证对话框标题显示"Confirm Delete"
   - 验证按钮显示"Confirm"和"Cancel"
   - 测试各按钮功能

3. **特殊场景测试:**
   - 尝试删除已下发设备的规则
   - 验证显示错误提示"请先移除设备后再删除规则"
   - 确保对话框不弹出

4. **交互测试:**
   - 点击对话框背景验证可关闭
   - 点击右上角关闭按钮验证可关闭
   - 多次打开关闭验证无内存泄漏

## 相关文件

- **主文件:** `rule-engine.html`
- **翻译文件:** `common.js`
- **修改函数:**
  - `deleteRule()`
  - `showConfirmDialog()`
  - `closeConfirmDialog()`
  - `confirmDialogAction()`

## 与电价设置页面的一致性

此修复与 `electricity-price-new.html` 页面的删除确认对话框保持了一致的实现方式:
- 相同的函数名称
- 相同的 HTML 结构
- 相同的交互逻辑
- 相同的样式风格

这确保了整个应用的用户体验统一性。

## 日期

修复日期: 2026-01-14
